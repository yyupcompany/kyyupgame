# ç™»å½•æµç¨‹å®Œæ•´åˆ†ææ€»ç»“

## ğŸ¯ æ ¸å¿ƒæµç¨‹ (18ä¸ªæ­¥éª¤)

### å‰ç«¯é˜¶æ®µ (æ­¥éª¤ 1-5)
1. ğŸ‘¤ ç”¨æˆ·è®¿é—® `k.yyup.cc`
2. ğŸ¨ æµè§ˆå™¨åŠ è½½å‰ç«¯åº”ç”¨ (Vue 3)
3. ğŸ“± ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
4. ğŸ–±ï¸ ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®
5. ğŸ“¤ å‰ç«¯å‘èµ· `POST /api/auth/login` è¯·æ±‚

### åç«¯ç§Ÿæˆ·è¯†åˆ«é˜¶æ®µ (æ­¥éª¤ 6)
6. ğŸ›¡ï¸ **tenantResolverMiddleware** æ‰§è¡Œ
   - è·å– Host å¤´: `k.yyup.cc`
   - æå–ç§Ÿæˆ·ä»£ç : `k` (æ­£åˆ™åŒ¹é…)
   - éªŒè¯ç§Ÿæˆ·å­˜åœ¨
   - å»ºç«‹æ•°æ®åº“è¿æ¥: `tenant_k`
   - è®¾ç½® `req.tenant` å’Œ `req.tenantDb`

### ç»Ÿä¸€è®¤è¯é˜¶æ®µ (æ­¥éª¤ 7-9)
7. ğŸ“ åç«¯è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
   - URL: `http://rent.yyup.cc:4001/api/auth/login`
   - è¯·æ±‚ä½“: `{phone, password}`
8. âœ”ï¸ è®¤è¯ä¸­å¿ƒéªŒè¯ç”¨æˆ·å‡­æ®
   - æŸ¥è¯¢ `admin_tenant_management` æ•°æ®åº“
   - éªŒè¯æ‰‹æœºå·å’Œå¯†ç 
9. âœ… è¿”å›è®¤è¯ç»“æœ
   - `globalUser` (ID, phone, realName, email)
   - `token` (JWT)

### ç”¨æˆ·åŒæ­¥é˜¶æ®µ (æ­¥éª¤ 10-13)
10. ğŸ” åœ¨ç§Ÿæˆ·æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
    - SQL: `SELECT * FROM users WHERE global_user_id = ?`
11. â• è‡ªåŠ¨åˆ›å»ºç§Ÿæˆ·ç”¨æˆ· (å¦‚æœä¸å­˜åœ¨)
    - æ’å…¥ç”¨æˆ·è®°å½•åˆ° `tenant_k.users`
    - è®¾ç½® `auth_source = 'unified'`
12. ğŸ‘¤ è·å–ç”¨æˆ·è§’è‰²å’Œæƒé™
    - æŸ¥è¯¢ `user_roles` å’Œ `roles` è¡¨
13. ğŸ“‹ è¿”å›è§’è‰²ä¿¡æ¯

### å“åº”æ„å»ºé˜¶æ®µ (æ­¥éª¤ 14-15)
14. ğŸ« æ„å»ºç”¨æˆ·å¯¹è±¡
    - åŒ…å«: id, username, role, email, phone
    - åŒ…å«ç§Ÿæˆ·ä¿¡æ¯: tenantCode, tenantDatabaseName
15. ğŸ“¤ è¿”å›ç™»å½•å“åº”
    - `token`: JWT token
    - `user`: ç”¨æˆ·å¯¹è±¡
    - `tenantInfo`: ç§Ÿæˆ·ä¿¡æ¯

### å‰ç«¯å¤„ç†é˜¶æ®µ (æ­¥éª¤ 16-18)
16. ğŸ’¾ å‰ç«¯ä¿å­˜æ•°æ®
    - localStorage.setItem('kindergarten_token', token)
    - localStorage.setItem('kindergarten_user_info', user)
17. ğŸ  è·³è½¬åˆ°é¦–é¡µ
    - router.push('/dashboard')
18. âœ… ç™»å½•æˆåŠŸ
    - æ˜¾ç¤ºé¦–é¡µå†…å®¹

---

## ğŸ”‘ å…³é”®ä¿¡æ¯

### åŸŸåæ˜ å°„
| ç³»ç»Ÿ | åŸŸå | ç«¯å£ | ç”¨é€” |
|------|------|------|------|
| å‰ç«¯ | k.yyup.cc | 5174 | ç”¨æˆ·ç•Œé¢ |
| åç«¯ | k.yyup.cc | 3000 | ä¸šåŠ¡é€»è¾‘ |
| è®¤è¯ä¸­å¿ƒ | rent.yyup.cc | 4001 | ç”¨æˆ·è®¤è¯ |

### æ•°æ®åº“
| æ•°æ®åº“ | ç”¨é€” | è¡¨ |
|--------|------|-----|
| admin_tenant_management | ç»Ÿä¸€è®¤è¯ | users, roles |
| tenant_k | ç§Ÿæˆ·ä¸šåŠ¡ | users, user_roles, roles |

### ç¯å¢ƒå˜é‡
```env
UNIFIED_AUTH_CENTER_URL=http://rent.yyup.cc
UNIFIED_AUTH_CENTER_API_URL=http://localhost:4001
TENANT_DOMAIN=k.yyup.cc
DB_NAME=kargerdensales
```

---

## ğŸ”„ æ•°æ®æµè½¬

```
ç”¨æˆ·è¾“å…¥ (phone, password)
    â†“
å‰ç«¯ HTTP è¯·æ±‚
    â†“
åç«¯ç§Ÿæˆ·è¯†åˆ« (æå–ç§Ÿæˆ·ä»£ç : k)
    â†“
åç«¯æ•°æ®åº“è¿æ¥ (tenant_k)
    â†“
è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (rent.yyup.cc:4001)
    â†“
è·å– globalUser + token
    â†“
åœ¨ç§Ÿæˆ·æ•°æ®åº“æŸ¥è¯¢/åˆ›å»ºç”¨æˆ·
    â†“
æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™
    â†“
æ„å»ºç”¨æˆ·å¯¹è±¡
    â†“
è¿”å›ç™»å½•å“åº”
    â†“
å‰ç«¯ä¿å­˜ token
    â†“
å‰ç«¯è·³è½¬åˆ°é¦–é¡µ
    â†“
âœ… ç™»å½•æˆåŠŸ
```

---

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

1. **åŸŸåéš”ç¦»**
   - ä¸åŒç§Ÿæˆ·ä¸åŒåŸŸå
   - è‡ªåŠ¨è¯†åˆ«ç§Ÿæˆ·ä»£ç 

2. **æ•°æ®åº“éš”ç¦»**
   - æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“
   - å…±äº«è¿æ¥æ± ä½†é€šè¿‡å®Œæ•´è¡¨åéš”ç¦»

3. **è®¤è¯éš”ç¦»**
   - ç»Ÿä¸€è®¤è¯ä¸­å¿ƒç­¾å‘ token
   - åç«¯éªŒè¯ token æœ‰æ•ˆæ€§

4. **ç”¨æˆ·éš”ç¦»**
   - ç”¨æˆ·ä¸ç§Ÿæˆ·ç»‘å®š
   - global_user_id å…³è”

5. **æƒé™éš”ç¦»**
   - ç§Ÿæˆ·çº§åˆ«çš„è§’è‰²æƒé™
   - ç”¨æˆ·è§’è‰²å…³è”è¡¨

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµè§ˆå™¨ (k.yyup.cc)                                  â”‚
â”‚ â”œâ”€ å‰ç«¯åº”ç”¨ (Vue 3 + Vite)                          â”‚
â”‚ â””â”€ ç™»å½•é¡µé¢ (Login/index.vue)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP POST /api/auth/login
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æœåŠ¡ (k.yyup.cc:3000)                           â”‚
â”‚ â”œâ”€ ç§Ÿæˆ·è¯†åˆ«ä¸­é—´ä»¶                                   â”‚
â”‚ â”‚  â””â”€ æå–ç§Ÿæˆ·ä»£ç : k                               â”‚
â”‚ â”‚  â””â”€ å»ºç«‹è¿æ¥: tenant_k                            â”‚
â”‚ â”œâ”€ è®¤è¯ä¸­é—´ä»¶                                       â”‚
â”‚ â”‚  â””â”€ è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ                              â”‚
â”‚ â”‚  â””â”€ ç”¨æˆ·åŒæ­¥                                      â”‚
â”‚ â”‚  â””â”€ æƒé™æŸ¥è¯¢                                      â”‚
â”‚ â””â”€ ä¸šåŠ¡é€»è¾‘                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP POST /api/auth/login
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (rent.yyup.cc:4001)                    â”‚
â”‚ â”œâ”€ ç”¨æˆ·éªŒè¯                                         â”‚
â”‚ â”œâ”€ Token ç­¾å‘                                       â”‚
â”‚ â””â”€ è¿”å› globalUser                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ è¿”å› globalUser + token
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§Ÿæˆ·æ•°æ®åº“ (tenant_k)                               â”‚
â”‚ â”œâ”€ æŸ¥è¯¢ç”¨æˆ·                                         â”‚
â”‚ â”œâ”€ åˆ›å»ºç”¨æˆ· (å¦‚æœä¸å­˜åœ¨)                            â”‚
â”‚ â””â”€ æŸ¥è¯¢è§’è‰²å’Œæƒé™                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒè¯æ¸…å•

- [x] åŸŸåæ­£ç¡®: k.yyup.cc
- [x] ç§Ÿæˆ·ä»£ç æå–: k (æ­£åˆ™åŒ¹é…)
- [x] æ•°æ®åº“è¿æ¥: tenant_k (å…±äº«è¿æ¥æ± )
- [x] ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ: rent.yyup.cc:4001
- [x] ç”¨æˆ·åŒæ­¥: è‡ªåŠ¨åˆ›å»º (å¦‚æœä¸å­˜åœ¨)
- [x] Token è¿”å›: å‰ç«¯ä¿å­˜åˆ° localStorage
- [x] æƒé™æŸ¥è¯¢: å®Œæ•´çš„è§’è‰²æƒé™æŸ¥è¯¢
- [x] é¡µé¢è·³è½¬: /dashboard
- [x] å®‰å…¨éš”ç¦»: åŸŸåã€æ•°æ®åº“ã€è®¤è¯ã€ç”¨æˆ·ã€æƒé™

---

## ğŸ“ å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `k.yyup.com/client/src/pages/Login/index.vue` | å‰ç«¯ç™»å½•é¡µé¢ |
| `k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts` | ç§Ÿæˆ·è¯†åˆ« |
| `k.yyup.com/server/src/middlewares/auth.middleware.ts` | è®¤è¯å¤„ç† |
| `k.yyup.com/server/src/controllers/auth.controller.ts` | è®¤è¯æ§åˆ¶å™¨ |
| `k.yyup.com/server/.env` | ç¯å¢ƒé…ç½® |

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **å…±äº«è¿æ¥æ± **: æ‰€æœ‰ç§Ÿæˆ·å…±äº«ä¸€ä¸ªè¿æ¥æ±  (30ä¸ªè¿æ¥)
2. **ç¼“å­˜æœºåˆ¶**: ç§Ÿæˆ·ä¿¡æ¯ç¼“å­˜
3. **å¼‚æ­¥å¤„ç†**: å¼‚æ­¥æŸ¥è¯¢å’Œåˆ›å»ºç”¨æˆ·
4. **è¶…æ—¶æ§åˆ¶**: ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè¯·æ±‚è¶…æ—¶ 10ç§’

---

## ğŸ” æ•…éšœæ’æŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|
| æ— æ³•è¯†åˆ«ç§Ÿæˆ· | åŸŸåä¸åŒ¹é… | æ£€æŸ¥åŸŸåæ˜¯å¦ä¸º k.yyup.cc |
| è®¤è¯å¤±è´¥ | æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯ | æ£€æŸ¥ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ |
| ç”¨æˆ·ä¸å­˜åœ¨ | ç”¨æˆ·æœªåˆ›å»º | æ£€æŸ¥è‡ªåŠ¨åˆ›å»ºé€»è¾‘ |
| æƒé™æŸ¥è¯¢å¤±è´¥ | è§’è‰²æœªé…ç½® | æ£€æŸ¥ user_roles è¡¨ |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | è¿æ¥æ± è€—å°½ | æ£€æŸ¥è¿æ¥æ± é…ç½® |

---

## ğŸ“ æ€»ç»“

ç”¨æˆ·ç™»å½•æµç¨‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¤šç³»ç»Ÿåä½œè¿‡ç¨‹ï¼š
1. å‰ç«¯æ”¶é›†ç”¨æˆ·è¾“å…¥
2. åç«¯è¯†åˆ«ç§Ÿæˆ·å¹¶å»ºç«‹è¿æ¥
3. ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯ç”¨æˆ·
4. ç§Ÿæˆ·æ•°æ®åº“åŒæ­¥ç”¨æˆ·ä¿¡æ¯
5. è¿”å›ç™»å½•å“åº”
6. å‰ç«¯ä¿å­˜å¹¶è·³è½¬

æ•´ä¸ªè¿‡ç¨‹é€šè¿‡åŸŸåéš”ç¦»ã€æ•°æ®åº“éš”ç¦»ã€è®¤è¯éš”ç¦»ç­‰å¤šå±‚å®‰å…¨æœºåˆ¶ï¼Œç¡®ä¿äº†å¤šç§Ÿæˆ·ç³»ç»Ÿçš„æ•°æ®å®‰å…¨å’Œéš”ç¦»ã€‚

