# 认证统一修复执行指南

**版本**: 1.0  
**状态**: 📋 待执行  
**预计时间**: 4小时

---

## 📋 执行步骤

### 第一步：删除重复的认证中间件（5分钟）

```bash
# 删除模拟中间件
rm unified-tenant-system/server/src/middlewares/auth.ts

# 验证删除
ls -la unified-tenant-system/server/src/middlewares/auth*
# 应该只看到 auth.middleware.ts
```

**检查点**:
- [ ] auth.ts 已删除
- [ ] 没有其他地方导入 auth.ts

---

### 第二步：清理 auth.middleware.ts（30分钟）

**文件**: `unified-tenant-system/server/src/middlewares/auth.middleware.ts`

**操作**:
1. 删除第23-69行的注释代码（开发环境绕过）
2. 确保 verifyToken 查询 `global_users` 表而不是 `users` 表
3. 统一错误响应格式

**检查点**:
- [ ] 删除了注释代码
- [ ] 查询 global_users 表
- [ ] 错误响应包含 error 字段

---

### 第三步：统一 auth.controller.ts（30分钟）

**文件**: `unified-tenant-system/server/src/controllers/auth.controller.ts`

**操作**:
1. 确保 login 方法查询 `global_users` 表
2. 统一响应格式为 { success, message, data, error }
3. 统一错误处理

**检查点**:
- [ ] 查询 global_users 表
- [ ] 响应格式统一
- [ ] 错误处理一致

---

### 第四步：补充租户系统 login（30分钟）

**文件**: `k.yyup.com/server/src/controllers/auth.controller.ts`

**操作**:
1. 添加 login 方法实现
2. 调用 authenticateWithUnifiedAuth 中间件
3. 返回统一格式响应

**代码示例**:
```typescript
export const login = async (req, res, next) => {
  try {
    await authenticateWithUnifiedAuth(req, res, next);
  } catch (error) {
    next(error);
  }
};
```

**检查点**:
- [ ] login 方法已实现
- [ ] 调用中间件
- [ ] 返回统一格式

---

### 第五步：统一错误处理（1小时）

**操作**:
1. 所有认证失败返回 401 + error 字段
2. 所有权限不足返回 403 + error 字段
3. 所有服务器错误返回 500 + error 字段

**检查点**:
- [ ] 所有错误响应包含 error 字段
- [ ] HTTP状态码正确
- [ ] 错误信息清晰

---

### 第六步：统一日志记录（30分钟）

**操作**:
1. 所有认证日志使用 `[认证]` 前缀
2. 记录关键信息：phone, globalUserId, tenantCode
3. 记录成功和失败

**示例**:
```typescript
console.log('[认证] 登录成功', { phone, globalUserId: user.id });
console.log('[认证] 登录失败', { phone, reason: '密码错误' });
```

**检查点**:
- [ ] 日志前缀统一
- [ ] 记录关键信息
- [ ] 易于追踪

---

### 第七步：编写集成测试（1小时）

**操作**:
1. 测试登录流程
2. 测试Token验证
3. 测试错误处理

**检查点**:
- [ ] 登录测试通过
- [ ] Token验证测试通过
- [ ] 错误处理测试通过

---

## ✅ 验收标准

- [ ] 只有一个认证中间件
- [ ] 所有认证API查询 global_users 表
- [ ] 所有响应格式统一
- [ ] 所有错误处理一致
- [ ] 所有日志记录统一
- [ ] 所有测试通过

---

## 📚 参考文档

1. `后端统一认证不统一问题分析.md`
2. `统一认证规范-修复方案.md`
3. `统一认证标准实现.md`
4. `认证问题快速参考.md`

---

**开始日期**: [待定]  
**完成日期**: [待定]  
**负责人**: [待定]

