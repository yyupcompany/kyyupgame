# 统一认证规范 - 修复方案

**制定日期**: 2025-11-28  
**优先级**: 🔴 高 - 需要立即执行

---

## 一、统一认证规范

### 1.1 认证流程标准化

```
┌─────────────────────────────────────────────────────┐
│  所有认证请求都遵循以下流程                          │
└─────────────────────────────────────────────────────┘

1. 请求进入 → 路由
2. 路由 → 控制器方法
3. 控制器 → 调用认证服务
4. 认证服务 → 数据库查询 + 密码验证
5. 认证服务 → 生成Token
6. 控制器 → 返回统一格式响应
```

### 1.2 认证中间件标准化

```
所有需要认证的路由：
1. 使用 verifyToken 中间件
2. verifyToken 验证JWT Token
3. verifyToken 从Token提取用户信息
4. verifyToken 将用户信息注入 req.user
5. 后续控制器使用 req.user
```

### 1.3 响应格式标准化

```typescript
// 登录成功
{
  success: true,
  message: '登录成功',
  data: {
    token: 'jwt_token',
    refreshToken: 'refresh_token',
    user: {
      id: 'user_id',
      phone: 'phone_number',
      realName: 'real_name',
      role: 'role_code',
      tenants: [...] // 仅统一租户系统返回
    }
  }
}

// 登录失败
{
  success: false,
  message: '错误信息',
  error: 'ERROR_CODE'
}
```

### 1.4 数据库查询标准化

```
统一租户系统:
- 登录: 查询 global_users 表
- Token验证: 查询 global_users 表
- 租户关联: 查询 global_user_tenant_relations 表

幼儿园租户系统:
- 登录: 调用统一租户系统API
- Token验证: 调用统一租户系统API验证
- 本地用户: 查询本地 users 表（双写）
```

---

## 二、修复方案

### 2.1 统一租户系统修复

#### 步骤1：删除重复的认证中间件
- ❌ 删除 `auth.ts` 文件
- ✅ 保留 `auth.middleware.ts` 作为唯一的认证中间件

#### 步骤2：清理 auth.middleware.ts
- 删除所有注释掉的开发环境绕过代码
- 统一使用真实JWT验证
- 统一查询 `global_users` 表

#### 步骤3：统一 auth.controller.ts
- login 方法查询 `global_users` 表
- 生成JWT Token
- 返回统一格式响应

### 2.2 幼儿园租户系统修复

#### 步骤1：补充 auth.controller.ts
- 添加 login 方法
- 调用 authenticateWithUnifiedAuth 中间件
- 返回统一格式响应

#### 步骤2：优化 auth.middleware.ts
- 清理代码
- 统一错误处理
- 统一日志记录

---

## 三、实施计划

| 优先级 | 任务 | 文件 | 预计工作量 |
|--------|------|------|----------|
| 🔴 高 | 删除重复中间件 | auth.ts | 5分钟 |
| 🔴 高 | 清理auth.middleware.ts | auth.middleware.ts | 30分钟 |
| 🔴 高 | 统一响应格式 | auth.controller.ts | 1小时 |
| 🟡 中 | 补充租户系统login | auth.controller.ts | 30分钟 |
| 🟡 中 | 统一错误处理 | 两个系统 | 1小时 |
| 🟢 低 | 统一日志记录 | 两个系统 | 1小时 |

**总计**: 约4小时

---

**下一步**: 开始执行修复方案

