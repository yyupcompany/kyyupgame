# ç»Ÿä¸€è®¤è¯æ ‡å‡†å®ç°

**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: ğŸ“‹ å‚è€ƒå®ç°

---

## ä¸€ã€ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»Ÿæ ‡å‡†å®ç°

### 1.1 è®¤è¯ä¸­é—´ä»¶ï¼ˆå”¯ä¸€å®ç°ï¼‰

**æ–‡ä»¶**: `unified-tenant-system/server/src/middlewares/auth.middleware.ts`

```typescript
import jwt from 'jsonwebtoken';
import { sequelize } from '../init';
import { JWT_SECRET } from '../config/jwt.config';

/**
 * ç»Ÿä¸€çš„TokenéªŒè¯ä¸­é—´ä»¶
 * æ‰€æœ‰éœ€è¦è®¤è¯çš„è·¯ç”±éƒ½ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶
 */
export const verifyToken = async (req, res, next) => {
  try {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        success: false,
        message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ',
        error: 'MISSING_TOKEN'
      });
    }

    const token = authHeader.substring(7);
    
    // éªŒè¯JWT Token
    const decoded = jwt.verify(token, JWT_SECRET) as any;
    
    // ä» global_users è¡¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    const [users] = await sequelize.query(`
      SELECT id, phone, real_name, email, status
      FROM global_users
      WHERE id = ? AND status = 'active'
      LIMIT 1
    `, { replacements: [decoded.userId] });
    
    if (!users || users.length === 0) {
      return res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨',
        error: 'USER_NOT_FOUND'
      });
    }
    
    // å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥è¯·æ±‚å¯¹è±¡
    req.user = users[0];
    next();
    
  } catch (error) {
    return res.status(401).json({
      success: false,
      message: 'TokenéªŒè¯å¤±è´¥',
      error: 'INVALID_TOKEN'
    });
  }
};
```

### 1.2 ç™»å½•æ§åˆ¶å™¨

**æ–‡ä»¶**: `unified-tenant-system/server/src/controllers/auth.controller.ts`

```typescript
export const login = async (req, res, next) => {
  try {
    const { phone, password } = req.body;
    
    // å‚æ•°éªŒè¯
    if (!phone || !password) {
      return res.status(400).json({
        success: false,
        message: 'æ‰‹æœºå·å’Œå¯†ç ä¸èƒ½ä¸ºç©º',
        error: 'MISSING_CREDENTIALS'
      });
    }
    
    // æŸ¥è¯¢ global_users è¡¨
    const [users] = await sequelize.query(`
      SELECT id, phone, password_hash, real_name, email, status
      FROM global_users
      WHERE phone = ?
      LIMIT 1
    `, { replacements: [phone] });
    
    if (!users || users.length === 0) {
      return res.status(401).json({
        success: false,
        message: 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯',
        error: 'INVALID_CREDENTIALS'
      });
    }
    
    const user = users[0];
    
    // éªŒè¯å¯†ç 
    const isValid = await bcrypt.compare(password, user.password_hash);
    if (!isValid) {
      return res.status(401).json({
        success: false,
        message: 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯',
        error: 'INVALID_CREDENTIALS'
      });
    }
    
    // ç”ŸæˆToken
    const token = generateToken({ userId: user.id });
    
    // è¿”å›ç»Ÿä¸€æ ¼å¼å“åº”
    return res.json({
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      data: {
        token,
        user: {
          id: user.id,
          phone: user.phone,
          realName: user.real_name,
          email: user.email
        }
      }
    });
    
  } catch (error) {
    next(error);
  }
};
```

---

## äºŒã€å¹¼å„¿å›­ç§Ÿæˆ·ç³»ç»Ÿæ ‡å‡†å®ç°

### 2.1 ç™»å½•æ§åˆ¶å™¨

**æ–‡ä»¶**: `k.yyup.com/server/src/controllers/auth.controller.ts`

```typescript
export const login = async (req, res, next) => {
  try {
    // è°ƒç”¨ä¸­é—´ä»¶å¤„ç†è®¤è¯
    await authenticateWithUnifiedAuth(req, res, () => {
      // ä¸­é—´ä»¶å·²å¤„ç†å“åº”
    });
  } catch (error) {
    next(error);
  }
};
```

### 2.2 è®¤è¯ä¸­é—´ä»¶

**æ–‡ä»¶**: `k.yyup.com/server/src/middlewares/auth.middleware.ts`

```typescript
export const authenticateWithUnifiedAuth = async (req, res, next) => {
  try {
    const { phone, password } = req.body;
    
    // è°ƒç”¨ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»ŸAPI
    const authResult = await adminIntegrationService.authenticateUser(
      phone,
      password
    );
    
    if (!authResult.success) {
      return res.status(401).json({
        success: false,
        message: authResult.message || 'è®¤è¯å¤±è´¥',
        error: 'AUTH_FAILED'
      });
    }
    
    // è¿”å›ç»Ÿä¸€æ ¼å¼å“åº”
    return res.json({
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      data: authResult.data
    });
    
  } catch (error) {
    return res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯',
      error: 'SERVER_ERROR'
    });
  }
};
```

---

## ä¸‰ã€ç»Ÿä¸€è§„èŒƒ

### 3.1 å“åº”æ ¼å¼

```typescript
// æˆåŠŸå“åº”
{
  success: true,
  message: 'æ“ä½œæˆåŠŸ',
  data: { ... }
}

// å¤±è´¥å“åº”
{
  success: false,
  message: 'é”™è¯¯ä¿¡æ¯',
  error: 'ERROR_CODE'
}
```

### 3.2 HTTPçŠ¶æ€ç 

- 200: æˆåŠŸ
- 400: è¯·æ±‚å‚æ•°é”™è¯¯
- 401: è®¤è¯å¤±è´¥
- 403: æƒé™ä¸è¶³
- 500: æœåŠ¡å™¨é”™è¯¯

### 3.3 æ—¥å¿—è®°å½•

```typescript
console.log('[è®¤è¯] ç™»å½•æˆåŠŸ', { phone, globalUserId: user.id });
console.log('[è®¤è¯] ç™»å½•å¤±è´¥', { phone, reason: 'å¯†ç é”™è¯¯' });
```

---

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§è¿™ä¸ªæ ‡å‡†å®ç°ä¿®å¤æ‰€æœ‰è®¤è¯ç›¸å…³ä»£ç 

