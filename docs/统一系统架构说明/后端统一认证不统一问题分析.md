# åç«¯ç»Ÿä¸€è®¤è¯ä¸ç»Ÿä¸€é—®é¢˜åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-11-28  
**é—®é¢˜ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ - å½±å“æ•´ä¸ªè®¤è¯ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§

---

## ä¸€ã€é—®é¢˜æ¦‚è§ˆ

ç»è¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°åç«¯ç»Ÿä¸€è®¤è¯å­˜åœ¨**ä¸¥é‡çš„ä¸ç»Ÿä¸€é—®é¢˜**ï¼Œä¸»è¦è¡¨ç°ä¸ºï¼š

1. **ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»Ÿå†…éƒ¨ä¸ç»Ÿä¸€** - æœ‰å¤šä¸ªè®¤è¯å®ç°æ–¹å¼
2. **ä¸¤ä¸ªç³»ç»Ÿçš„è®¤è¯æµç¨‹å®Œå…¨ä¸åŒ** - æ— æ³•å½¢æˆç»Ÿä¸€è§„èŒƒ
3. **ä»£ç æ··ä¹±** - å¤§é‡æ³¨é‡Šæ‰çš„ä»£ç ã€æ¨¡æ‹Ÿå®ç°ã€é‡å¤é€»è¾‘

---

## äºŒã€å…·ä½“é—®é¢˜

### 2.1 ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»Ÿçš„æ··ä¹±

#### é—®é¢˜1ï¼šä¸¤ä¸ªä¸åŒçš„è®¤è¯ä¸­é—´ä»¶

**æ–‡ä»¶1**: `unified-tenant-system/server/src/middlewares/auth.ts`
```typescript
// âŒ ç®€å•çš„æ¨¡æ‹Ÿä¸­é—´ä»¶ - åªæ£€æŸ¥tokenå­˜åœ¨
export const verifyToken = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  if (!token) return res.status(401).json(...);
  
  // ç›´æ¥è¿”å›ç¡¬ç¼–ç ç”¨æˆ·ä¿¡æ¯
  req.user = {
    id: 1,
    username: 'admin',
    role: 'admin'
  };
  next();
};
```

**æ–‡ä»¶2**: `unified-tenant-system/server/src/middlewares/auth.middleware.ts`
```typescript
// âœ… å¤æ‚çš„çœŸå®ä¸­é—´ä»¶ - JWTéªŒè¯ + æ•°æ®åº“æŸ¥è¯¢
export const verifyToken = async (req, res, next) => {
  // æœ‰çœŸå®JWTéªŒè¯
  const decoded = jwt.verify(token, JWT_SECRET);
  // æŸ¥è¯¢æ•°æ®åº“
  const userRows = await sequelizeInstance.query(...);
  // ä½†æœ‰å¤§é‡æ³¨é‡Šæ‰çš„å¼€å‘ç¯å¢ƒç»•è¿‡ä»£ç 
};
```

**é—®é¢˜**: åŒä¸€ä¸ªåŠŸèƒ½æœ‰ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„å®ç°ï¼

#### é—®é¢˜2ï¼šlogin æ§åˆ¶å™¨å’Œ verifyToken ä¸­é—´ä»¶æŸ¥è¯¢ä¸åŒçš„è¡¨

**auth.controller.ts ä¸­çš„ login**:
```typescript
// æŸ¥è¯¢ global_users è¡¨
const query = 'SELECT ... FROM global_users WHERE phone = :phone';
```

**auth.middleware.ts ä¸­çš„ verifyToken**:
```typescript
// æŸ¥è¯¢ users è¡¨
const result = await sequelizeInstance.query(`
  SELECT u.id, u.username, u.email, u.real_name, u.phone, u.status
  FROM users u
  WHERE u.id = ? ...
`);
```

**é—®é¢˜**: ç™»å½•æŸ¥è¯¢ `global_users`ï¼ŒéªŒè¯TokenæŸ¥è¯¢ `users` - æ•°æ®æºä¸ä¸€è‡´ï¼

### 2.2 å¹¼å„¿å›­ç§Ÿæˆ·ç³»ç»Ÿçš„é—®é¢˜

**auth.controller.ts**:
```typescript
// âŒ login æ–¹æ³•æ˜¯ç©ºçš„
export const login = async (req, res, next) => {
  // ä»€ä¹ˆéƒ½ä¸åš
};
```

**auth.middleware.ts**:
```typescript
// âœ… å®é™…è®¤è¯åœ¨ä¸­é—´ä»¶ä¸­
export const authenticateWithUnifiedAuth = async (req, res, next) => {
  // è°ƒç”¨ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»ŸAPI
  const authResult = await adminIntegrationService.authenticateUser(phone, password);
  // åŒå†™åˆ°æœ¬åœ°æ•°æ®åº“
  // ...
};
```

**é—®é¢˜**: è®¤è¯é€»è¾‘åœ¨ä¸­é—´ä»¶ä¸­ï¼Œä¸åœ¨æ§åˆ¶å™¨ä¸­ - è¿åMVCæ¨¡å¼ï¼

### 2.3 é”™è¯¯å¤„ç†ä¸ä¸€è‡´

**ç»Ÿä¸€ç§Ÿæˆ·ç³»ç»Ÿ**:
```typescript
res.status(401).json({
  success: false,
  error: 'INVALID_CREDENTIALS',
  message: 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯'
});
```

**å¹¼å„¿å›­ç§Ÿæˆ·ç³»ç»Ÿ**:
```typescript
res.status(401).json({
  success: false,
  message: authResult.message || 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯'
});
```

**é—®é¢˜**: é”™è¯¯å“åº”æ ¼å¼ä¸ä¸€è‡´ï¼

---

## ä¸‰ã€å½±å“èŒƒå›´

- âŒ æ— æ³•ç»Ÿä¸€çš„è®¤è¯è§„èŒƒ
- âŒ ç»´æŠ¤å›°éš¾ - ä¿®æ”¹ä¸€ä¸ªåœ°æ–¹éœ€è¦æ”¹å¤šä¸ªåœ°æ–¹
- âŒ å®¹æ˜“å‡ºbug - ä¸åŒçš„å®ç°æ–¹å¼å®¹æ˜“é—æ¼
- âŒ æ–°å¼€å‘è€…å›°æƒ‘ - ä¸çŸ¥é“åº”è¯¥ç”¨å“ªä¸ªå®ç°

---

## å››ã€éœ€è¦ä¿®å¤çš„æ–‡ä»¶

1. `unified-tenant-system/server/src/middlewares/auth.ts` - åˆ é™¤æˆ–ç»Ÿä¸€
2. `unified-tenant-system/server/src/middlewares/auth.middleware.ts` - æ¸…ç†æ³¨é‡Šä»£ç 
3. `unified-tenant-system/server/src/controllers/auth.controller.ts` - ç»Ÿä¸€å®ç°
4. `k.yyup.com/server/src/controllers/auth.controller.ts` - è¡¥å……loginå®ç°
5. `k.yyup.com/server/src/middlewares/auth.middleware.ts` - æ¸…ç†å’Œä¼˜åŒ–

---

**ä¸‹ä¸€æ­¥**: åˆ¶å®šç»Ÿä¸€çš„è®¤è¯è§„èŒƒå’Œä¿®å¤æ–¹æ¡ˆ

