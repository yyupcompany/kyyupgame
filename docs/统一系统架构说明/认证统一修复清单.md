# 认证统一修复清单

**状态**: 📋 待执行  
**优先级**: 🔴 高

---

## 修复项目清单

### 第一阶段：统一租户系统清理

- [ ] **任务1**: 删除 `unified-tenant-system/server/src/middlewares/auth.ts`
  - 原因: 这是一个模拟中间件，与 auth.middleware.ts 重复
  - 影响: 无 - 没有地方使用这个文件

- [ ] **任务2**: 清理 `unified-tenant-system/server/src/middlewares/auth.middleware.ts`
  - 删除所有注释掉的开发环境绕过代码（第23-69行）
  - 统一使用真实JWT验证
  - 统一查询 `global_users` 表而不是 `users` 表
  - 统一错误处理格式

- [ ] **任务3**: 统一 `unified-tenant-system/server/src/controllers/auth.controller.ts`
  - 确保 login 方法查询 `global_users` 表
  - 统一响应格式（包含 success, message, data, error）
  - 统一错误处理

### 第二阶段：幼儿园租户系统优化

- [ ] **任务4**: 补充 `k.yyup.com/server/src/controllers/auth.controller.ts`
  - 添加 login 方法实现
  - 调用 authenticateWithUnifiedAuth 中间件
  - 返回统一格式响应

- [ ] **任务5**: 优化 `k.yyup.com/server/src/middlewares/auth.middleware.ts`
  - 统一错误处理格式
  - 统一日志记录
  - 清理冗余代码

### 第三阶段：统一规范

- [ ] **任务6**: 统一响应格式
  - 所有认证相关API返回统一格式
  - 错误响应包含 error 字段

- [ ] **任务7**: 统一日志记录
  - 使用统一的日志前缀 `[认证]`
  - 记录关键信息：phone, globalUserId, tenantCode

- [ ] **任务8**: 编写认证集成测试
  - 测试登录流程
  - 测试Token验证
  - 测试错误处理

---

## 关键检查点

### 检查1：中间件一致性
- [ ] 只有一个 verifyToken 中间件
- [ ] 所有需要认证的路由都使用这个中间件
- [ ] 中间件返回统一的用户信息结构

### 检查2：数据库查询一致性
- [ ] 统一租户系统只查询 global_users 表
- [ ] 幼儿园租户系统调用统一租户系统API
- [ ] 没有重复的查询逻辑

### 检查3：响应格式一致性
- [ ] 所有成功响应包含 success: true
- [ ] 所有失败响应包含 error 字段
- [ ] 所有响应包含 message 字段

### 检查4：错误处理一致性
- [ ] 所有认证失败返回 401 状态码
- [ ] 所有权限不足返回 403 状态码
- [ ] 所有服务器错误返回 500 状态码

---

## 预期效果

✅ 认证流程统一  
✅ 代码可维护性提高  
✅ 新开发者容易理解  
✅ 减少bug  
✅ 便于后续扩展

---

**开始日期**: [待定]  
**完成日期**: [待定]  
**负责人**: [待定]

