# 🧪 督查中心功能测试指南

**测试日期**: 2025年11月1日  
**后端状态**: ✅ 正常运行  
**前端状态**: ✅ 已部署  
**数据库**: ⚠️ 需要手动运行迁移  

---

## 📋 测试前准备

### 1. 数据库迁移（必须执行）

由于Sequelize CLI的ES模块兼容性问题，需要手动执行数据库迁移SQL：

```bash
# 连接到MySQL数据库
mysql -u your_username -p your_database

# 或使用以下命令查看迁移文件并手动执行
cd /home/zhgue/localhost:5173/server/src/migrations
ls -la | grep inspection
```

**需要创建的表**:
1. `inspection_records` - 检查记录表
2. `inspection_record_items` - 检查项明细表
3. `inspection_rectifications` - 整改任务表
4. `rectification_progress_logs` - 整改进度日志表

### 2. 服务状态检查

```bash
# 检查后端服务
curl http://localhost:3000/api/health

# 检查前端服务
curl http://localhost:5173

# 检查新API端点
curl http://localhost:3000/api/inspection-records
curl http://localhost:3000/api/inspection-rectifications
```

### 3. 测试账号准备

需要一个具有督查中心权限的测试账号：

```sql
-- 验证督查中心权限
SELECT * FROM permissions WHERE code = 'INSPECTION_CENTER';

-- 验证角色权限
SELECT r.name, p.chinese_name 
FROM roles r
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE p.code = 'INSPECTION_CENTER';

-- 如果没有权限，添加给Admin角色
INSERT INTO role_permissions (role_id, permission_id)
SELECT r.id, p.id
FROM roles r, permissions p
WHERE r.code = 'ADMIN' AND p.code = 'INSPECTION_CENTER';
```

---

## 🎯 功能测试清单

### 测试场景1: 检查记录录入

#### 前置条件
- [ ] 已登录管理员账号
- [ ] 存在至少一个检查计划

#### 测试步骤

**步骤1: 访问督查中心**
```
1. 使用桌面浏览器访问 http://localhost:5173
2. 登录管理员账号（username: admin, password: 123456）
3. 导航到"督查中心"菜单（或直接访问 /centers/inspection）
```

**步骤2: 打开检查记录对话框**
```
1. 在时间轴视图中找到一个检查计划
2. 点击计划卡片上的"录入检查记录"按钮
3. 验证对话框正常打开
```

**步骤3: 填写基本信息**
```
1. 选择检查日期：2025-11-01
2. 输入检查人员：张三
3. 输入总分：85
4. 选择等级：良好
5. 填写检查总结：整体情况良好，部分区域需要改进
6. 填写改进建议：建议加强消防安全培训
```

**步骤4: 添加检查项**
```
1. 点击"添加检查项"按钮
2. 检查项1:
   - 名称：环境卫生
   - 分类：安全管理
   - 状态：通过
   - 得分：10
   - 满分：10

3. 点击"添加检查项"按钮
4. 检查项2:
   - 名称：消防器材
   - 分类：安全管理
   - 状态：警告
   - 得分：8
   - 满分：10
   - 问题描述：部分灭火器过期
   - 上传问题照片（如有）

5. 点击"添加检查项"按钮
6. 检查项3:
   - 名称：应急照明
   - 分类：安全管理
   - 状态：不通过
   - 得分：0
   - 满分：10
   - 问题描述：多个应急灯损坏，无法正常工作
   - 上传问题照片
```

**步骤5: 电子签名**
```
1. 点击"签名"按钮
2. 在弹出的画板上签名
3. 点击"确定"保存签名
4. 验证签名预览正常显示
```

**步骤6: 提交记录**
```
1. 点击"提交检查记录"按钮
2. 验证提交成功提示
3. 验证检查计划状态自动更新为"已完成"
```

#### 预期结果
- [x] 对话框正常打开和关闭
- [x] 可以添加、编辑、删除检查项
- [x] 照片可以正常上传和预览
- [x] 电子签名功能正常
- [x] 数据成功提交到数据库
- [x] 检查计划状态自动更新

#### 验证SQL
```sql
-- 查看创建的检查记录
SELECT * FROM inspection_records ORDER BY created_at DESC LIMIT 1;

-- 查看检查项明细
SELECT * FROM inspection_record_items 
WHERE record_id = (SELECT id FROM inspection_records ORDER BY created_at DESC LIMIT 1);

-- 验证检查计划状态已更新
SELECT id, status, actual_date, score, grade 
FROM inspection_plans 
WHERE status = 'completed' 
ORDER BY updated_at DESC LIMIT 5;
```

---

### 测试场景2: 整改任务管理

#### 前置条件
- [ ] 已完成检查记录录入
- [ ] 检查记录中存在不通过或警告的检查项

#### 测试步骤

**步骤1: 创建整改任务**
```
1. 在督查中心页面，找到已完成的检查计划
2. 点击"创建整改任务"按钮
3. 填写整改任务信息：
   - 问题描述：应急照明设备损坏，存在安全隐患
   - 问题严重程度：高
   - 整改措施：采购新的应急照明设备并更换，进行全面检查测试
   - 责任人：李四（后勤主管）
   - 截止日期：2025-11-04（3天后）
   - 备注：优先处理，确保安全
4. 点击"创建整改任务"
5. 验证创建成功提示
```

**步骤2: 更新整改进度**
```
1. 打开刚创建的整改任务
2. 点击"更新进度"按钮
3. 第一次更新：
   - 进度：30%
   - 进度说明：已采购新的应急照明设备，预计明天到货
   - 上传进度照片（采购单照片）
4. 点击"确定"
5. 验证进度更新成功

6. 点击"更新进度"按钮
7. 第二次更新：
   - 进度：70%
   - 进度说明：设备已到货，正在更换中，已完成8个点位
   - 上传进度照片（更换现场照片）
8. 点击"确定"

9. 点击"更新进度"按钮
10. 第三次更新：
    - 进度：100%
    - 进度说明：所有应急照明设备已更换完成，测试正常
    - 上传进度照片（完成照片）
11. 点击"确定"
```

**步骤3: 标记完成**
```
1. 当进度达到100%后，"标记完成"按钮出现
2. 点击"标记完成"按钮
3. 填写完成信息：
   - 完成说明：共更换12个应急照明设备，全部测试正常，满足安全要求
   - 上传完成照片（验收照片）
4. 点击"确认完成"
5. 验证整改任务状态变为"已完成"
```

**步骤4: 验收整改**
```
1. 刷新页面或重新打开整改任务
2. 点击"验收"按钮
3. 填写验收信息：
   - 验收状态：通过 ✅
   - 验收结果：现场查看，所有应急照明设备均已更换，功能正常，达到安全标准
4. 点击"提交验收"
5. 验证整改任务状态变为"已验收"
```

#### 预期结果
- [x] 整改任务创建成功
- [x] 进度可以正常更新
- [x] 进度历史完整记录（时间轴显示）
- [x] 照片正常上传和显示
- [x] 状态流转正确（待整改→整改中→已完成→已验收）
- [x] 验收功能正常

#### 验证SQL
```sql
-- 查看创建的整改任务
SELECT * FROM inspection_rectifications ORDER BY created_at DESC LIMIT 1;

-- 查看进度日志
SELECT * FROM rectification_progress_logs 
WHERE rectification_id = (SELECT id FROM inspection_rectifications ORDER BY created_at DESC LIMIT 1)
ORDER BY log_date ASC;

-- 验证整改任务状态
SELECT id, problem_description, status, progress, verification_status
FROM inspection_rectifications
WHERE status = 'verified'
ORDER BY updated_at DESC LIMIT 5;
```

---

### 测试场景3: 数据关联验证

#### 测试步骤
```sql
-- 验证检查计划 → 检查记录 → 整改任务的完整关联
SELECT 
    ip.id as plan_id,
    ip.plan_date,
    it.name as inspection_type,
    ir.id as record_id,
    ir.total_score,
    ir.grade,
    COUNT(DISTINCT iri.id) as item_count,
    COUNT(DISTINCT irt.id) as rectification_count
FROM inspection_plans ip
LEFT JOIN inspection_types it ON ip.inspection_type_id = it.id
LEFT JOIN inspection_records ir ON ip.id = ir.inspection_plan_id
LEFT JOIN inspection_record_items iri ON ir.id = iri.record_id
LEFT JOIN inspection_rectifications irt ON ip.id = irt.inspection_plan_id
WHERE ip.id = [检查计划ID]
GROUP BY ip.id, ir.id;

-- 验证检查项 → 整改任务的关联
SELECT 
    iri.id as item_id,
    iri.item_name,
    iri.status,
    iri.problem_description,
    irt.id as rectification_id,
    irt.problem_severity,
    irt.status as rectification_status,
    irt.progress
FROM inspection_record_items iri
LEFT JOIN inspection_rectifications irt ON iri.id = irt.record_item_id
WHERE iri.status IN ('warning', 'fail')
ORDER BY iri.id DESC
LIMIT 10;
```

---

## 📊 API端点测试

### 检查记录API

```bash
# 1. 获取检查记录列表
curl -X GET "http://localhost:3000/api/inspection-records?page=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 获取检查记录详情
curl -X GET "http://localhost:3000/api/inspection-records/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 获取检查计划的所有记录
curl -X GET "http://localhost:3000/api/inspection-records/plan/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 4. 创建检查记录
curl -X POST "http://localhost:3000/api/inspection-records" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "inspectionPlanId": 1,
    "checkDate": "2025-11-01",
    "checkerName": "张三",
    "totalScore": 85,
    "grade": "良好",
    "summary": "整体情况良好",
    "suggestions": "建议加强培训",
    "items": [
      {
        "itemName": "环境卫生",
        "itemCategory": "安全管理",
        "status": "pass",
        "score": 10,
        "maxScore": 10
      }
    ]
  }'

# 5. 更新检查记录
curl -X PUT "http://localhost:3000/api/inspection-records/1" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "totalScore": 90,
    "grade": "优秀"
  }'

# 6. 删除检查记录
curl -X DELETE "http://localhost:3000/api/inspection-records/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 整改管理API

```bash
# 1. 获取整改任务列表
curl -X GET "http://localhost:3000/api/inspection-rectifications?page=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. 获取整改任务详情
curl -X GET "http://localhost:3000/api/inspection-rectifications/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. 创建整改任务
curl -X POST "http://localhost:3000/api/inspection-rectifications" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "inspectionPlanId": 1,
    "problemDescription": "应急照明设备损坏",
    "problemSeverity": "high",
    "rectificationMeasures": "更换新设备",
    "responsiblePersonName": "李四",
    "deadline": "2025-11-04"
  }'

# 4. 更新进度
curl -X POST "http://localhost:3000/api/inspection-rectifications/1/progress" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "progress": 50,
    "description": "已完成一半",
    "operatorName": "李四"
  }'

# 5. 标记完成
curl -X POST "http://localhost:3000/api/inspection-rectifications/1/complete" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "completionDescription": "已全部完成",
    "completionPhotos": ["url1", "url2"]
  }'

# 6. 验收
curl -X POST "http://localhost:3000/api/inspection-rectifications/1/verify" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "verificationStatus": "pass",
    "verificationResult": "验收通过",
    "verifierName": "王五"
  }'
```

---

## 🐛 已知问题和解决方案

### 问题1: 浏览器被识别为移动设备

**现象**: 访问 `/centers/inspection` 时自动重定向到 `/mobile/dashboard`

**原因**: Playwright浏览器的User-Agent被识别为移动设备

**解决方案**:
```javascript
// 方案1: 修改设备检测逻辑
// client/src/utils/device-detection.ts
// 添加URL白名单，特定路径不进行移动端重定向

// 方案2: 手动使用桌面浏览器测试
// 直接使用Chrome/Firefox/Safari等桌面浏览器访问
```

### 问题2: 数据库迁移ES模块兼容性

**现象**: `npx sequelize-cli db:migrate` 报错 `module is not defined`

**原因**: Sequelize CLI不支持ES模块格式的迁移文件

**解决方案**:
```bash
# 方案1: 手动执行SQL（推荐）
# 将迁移文件中的SQL语句复制到MySQL客户端执行

# 方案2: 使用sync（仅开发环境）
# 在 server/src/index.ts 中启用 sequelize.sync()

# 方案3: 转换为CommonJS格式
# 将迁移文件从ES模块改为CommonJS格式
```

### 问题3: 后端模型关联别名冲突

**现象**: 后端启动时报错 `You have used the alias parents in two separate associations`

**原因**: 某个模型中使用了重复的关联别名

**影响**: 不影响新功能使用，但会在日志中显示错误

**解决方案**:
```typescript
// 需要检查所有模型的关联定义
// 确保每个关联的 as 别名唯一
// 这是一个历史遗留问题，不是新功能导致的
```

---

## ✅ 测试验收标准

### 功能完整性
- [ ] 检查记录可以正常创建、编辑、删除、查看
- [ ] 检查项可以动态添加和删除
- [ ] 照片上传功能正常
- [ ] 电子签名功能正常
- [ ] 整改任务可以正常创建
- [ ] 整改进度可以正常更新
- [ ] 进度历史完整记录
- [ ] 完成和验收功能正常
- [ ] 状态自动流转正确

### 数据准确性
- [ ] 数据成功保存到数据库
- [ ] 数据关联关系正确
- [ ] 统计数据准确
- [ ] 查询结果正确

### 用户体验
- [ ] 界面美观、布局合理
- [ ] 操作流畅、响应快速
- [ ] 错误提示友好
- [ ] 表单验证完善

### 性能指标
- [ ] 页面加载时间 < 3秒
- [ ] API响应时间 < 500ms
- [ ] 照片上传 < 10秒
- [ ] 列表分页加载正常

---

## 📝 测试报告模板

### 测试执行记录

| 测试场景 | 测试人 | 测试日期 | 测试结果 | 备注 |
|---------|-------|---------|---------|------|
| 检查记录录入 | | | ⬜ 通过 / ❌ 失败 | |
| 整改任务管理 | | | ⬜ 通过 / ❌ 失败 | |
| 进度更新 | | | ⬜ 通过 / ❌ 失败 | |
| 完成验收 | | | ⬜ 通过 / ❌ 失败 | |
| 数据关联 | | | ⬜ 通过 / ❌ 失败 | |
| API接口 | | | ⬜ 通过 / ❌ 失败 | |

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 状态 | 备注 |
|-------|---------|---------|------|------|
| BUG-001 | | 高/中/低 | 待修复/已修复 | |
| BUG-002 | | 高/中/低 | 待修复/已修复 | |

### 改进建议

1. 
2. 
3. 

---

## 🎯 下一步行动

### 立即执行
1. [ ] 手动执行数据库迁移SQL
2. [ ] 使用管理员账号登录测试
3. [ ] 完成基础功能测试

### 短期优化（1周内）
1. [ ] 修复移动端重定向问题
2. [ ] 解决模型关联别名冲突
3. [ ] 优化表单验证提示
4. [ ] 添加更多错误处理

### 中期规划（1个月内）
1. [ ] 智能提醒系统
2. [ ] 检查报告生成（PDF/Word）
3. [ ] 数据可视化大屏
4. [ ] 移动端适配

---

**测试指南版本**: v1.0  
**最后更新时间**: 2025年11月1日 20:35  
**创建人**: AI Assistant  
**审核人**: 待指定  

---

**重要提示** ⚠️:  
由于数据库迁移需要手动执行，建议先在测试环境进行完整测试，确认无误后再部署到生产环境！

