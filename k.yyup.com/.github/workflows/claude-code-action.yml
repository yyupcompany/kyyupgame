name: Claude Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]

permissions:
  # å®Œæ•´çš„å†™å…¥æƒé™
  issues: write
  contents: write
  pull-requests: write
  actions: write
  checks: write
  repository-projects: write
  statuses: write
  deployments: write

jobs:
  claude-response:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PAT_TOKENè·å¾—æ›´å¤šæƒé™
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          if ! command -v unzip &> /dev/null; then
            echo "Installing unzip..."
            sudo apt-get update && sudo apt-get install -y unzip
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Claude Code Action (Enhanced)
        uses: anthropics/claude-code-action@beta
        id: claude-action
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          trigger_phrase: "@claude"
          allowed_tools: "*"
          settings: |
            {
              "permissions": {
                "allow": ["*"],
                "deny": []
              },
              "auto_approve_all": true,
              "bash_permissions": {
                "allow": ["*"],
                "auto_approve": true
              }
            }
          custom_instructions: |
            ## ğŸ—£ï¸ é‡è¦ï¼šè¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰äº¤æµ
            - æ‰€æœ‰å›å¤ã€æŠ¥å‘Šã€è¯´æ˜éƒ½ä½¿ç”¨ä¸­æ–‡
            - åˆ›å»ºPRæ—¶ä½¿ç”¨ä¸­æ–‡æ ‡é¢˜å’Œæè¿°
            - æäº¤ä¿¡æ¯ä½¿ç”¨ä¸­æ–‡æè¿°
            - ä¸ç”¨æˆ·çš„æ‰€æœ‰äº’åŠ¨éƒ½ç”¨ä¸­æ–‡è¿›è¡Œ
            
            ä½ æ‹¥æœ‰æ­¤ä»“åº“çš„å®Œæ•´å†™å…¥æƒé™ï¼Œå¯ä»¥ï¼š
            - åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤æ–‡ä»¶
            - åˆ›å»ºåˆ†æ”¯å’ŒPull Request
            - è¿è¡Œæµ‹è¯•å’Œæ„å»º
            - æäº¤å’Œæ¨é€æ›´æ”¹
            - ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„å·¥å…·å’Œå‘½ä»¤
            
            ## ğŸš€ é‡è¦å·¥ä½œæµç¨‹è¦æ±‚
            
            1. **åˆ†æ”¯ç®¡ç†**: å¯¹äºé‡å¤§ä¿®æ”¹ï¼Œåˆ›å»ºåŠŸèƒ½åˆ†æ”¯è€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹mainåˆ†æ”¯
            2. **Pull Request**: å®Œæˆå·¥ä½œååˆ›å»ºPull Requestè¿›è¡Œä»£ç å®¡æŸ¥
            3. **è¯¦ç»†è¯´æ˜**: åœ¨PRä¸­åŒ…å«è¯¦ç»†çš„æ›´æ”¹è¯´æ˜å’Œæµ‹è¯•éªŒè¯
            4. **ä¸­æ–‡äº¤æµ**: æ‰€æœ‰å›å¤å’Œè¯´æ˜éƒ½ä½¿ç”¨ä¸­æ–‡
            
            å§‹ç»ˆåˆ›å»ºæœ‰æ„ä¹‰çš„ä¸­æ–‡æäº¤ä¿¡æ¯å’ŒPRæè¿°ã€‚
