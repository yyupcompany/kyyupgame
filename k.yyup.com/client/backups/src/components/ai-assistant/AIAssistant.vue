<!--
  é‡æ„åçš„AIåŠ©æ‰‹ä¸»å®¹å™¨ç»„ä»¶
  å°†åŸæ¥8083è¡Œçš„ä»£ç é‡æ„ä¸ºç®€æ´çš„ç»„åˆå¼ç»„ä»¶

  ğŸ“ é‡æ„åçš„ç›®å½•ç»“æ„å’ŒåŠŸèƒ½è¯´æ˜ï¼š

  client/src/components/ai-assistant/
  â”œâ”€â”€ AIAssistant.vue                    # ğŸ  ä¸»å®¹å™¨ç»„ä»¶ (<300è¡Œ)
  â”‚   â”œâ”€ åŠŸèƒ½ï¼šç»„ä»¶ç»„åˆã€çŠ¶æ€åè°ƒã€äº‹ä»¶ä¼ é€’
  â”‚   â”œâ”€ èŒè´£ï¼šçº¯ç»„åˆé€»è¾‘ï¼Œæ— å¤æ‚ä¸šåŠ¡ä»£ç 
  â”‚   â””â”€ ç‰¹ç‚¹ï¼šé‡æ„åçš„ä¸»ç»„ä»¶
  â”‚
  â”œâ”€â”€ core/                              # ğŸ§  æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶
  â”‚   â””â”€â”€ AIAssistantCore.vue           # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç»„ä»¶
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šå¤šè½®å·¥å…·è°ƒç”¨ã€AIå“åº”å¤„ç†ã€çŠ¶æ€ç®¡ç†
  â”‚       â”œâ”€ èŒè´£ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä¸æ¸²æŸ“UI
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬1500-3000è¡Œé€»è¾‘æå–
  â”‚
  â”œâ”€â”€ layout/                            # ğŸ¨ å¸ƒå±€ç»„ä»¶å±‚
  â”‚   â”œâ”€â”€ FullscreenLayout.vue          # å…¨å±ä¸‰æ å¸ƒå±€
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šå…¨å±æ¨¡å¼ã€å¤´éƒ¨å¯¼èˆªã€ä¾§è¾¹æ ç®¡ç†
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šå¸ƒå±€ç»“æ„ã€å“åº”å¼è®¾è®¡ã€ä¸»é¢˜åˆ‡æ¢
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬3-30è¡Œæ¨¡æ¿æå–
  â”‚
  â”‚
  â”œâ”€â”€ chat/                              # ğŸ’¬ èŠå¤©ç›¸å…³ç»„ä»¶
  â”‚   â”œâ”€â”€ ChatContainer.vue             # èŠå¤©å®¹å™¨ç®¡ç†
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šæ¶ˆæ¯åŒºåŸŸã€è¾“å…¥åŒºåŸŸã€æ»šåŠ¨æ§åˆ¶
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šèŠå¤©ç•Œé¢å¸ƒå±€ã€æ¶ˆæ¯æµç®¡ç†
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬66-186è¡Œæ¨¡æ¿æå–
  â”‚   â”œâ”€â”€ MessageList.vue               # æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šå†å²æ¶ˆæ¯ã€å½“å‰AIå“åº”ã€æ¶ˆæ¯é¡¹ç®¡ç†
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šæ¶ˆæ¯æ˜¾ç¤ºé€»è¾‘ã€åŠ¨ç”»æ•ˆæœ
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬87-163è¡Œæ¨¡æ¿æå–
  â”‚   â”œâ”€â”€ MessageItem.vue               # å•æ¡æ¶ˆæ¯æ˜¾ç¤º
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šæ¶ˆæ¯å†…å®¹ã€æ—¶é—´æˆ³ã€å¢å¼ºæ•°æ®æ˜¾ç¤º
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šæ¶ˆæ¯æ ¼å¼åŒ–ã€äº¤äº’å¤„ç†
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬87-106è¡Œæ¨¡æ¿æå–
  â”‚   â””â”€â”€ WelcomeMessage.vue            # æ¬¢è¿ç•Œé¢
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šæ¬¢è¿å¡ç‰‡ã€å»ºè®®æŒ‰é’®ã€åŠŸèƒ½æç¤º
  â”‚       â”œâ”€ èŒè´£ï¼šé¦–æ¬¡ä½¿ç”¨å¼•å¯¼ã€å¿«é€Ÿå¼€å§‹
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬70-85è¡Œæ¨¡æ¿æå–
  â”‚
  â”œâ”€â”€ ai-response/                       # ğŸ¤– AIå“åº”ç»„ä»¶
  â”‚   â”œâ”€â”€ ThinkingProcess.vue           # æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šæ€è€ƒå†…å®¹ã€æŠ˜å å±•å¼€ã€æµå¼æ˜¾ç¤º
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šæ€è€ƒè¿‡ç¨‹å¯è§†åŒ–ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬116-127è¡Œæ¨¡æ¿æå–
  â”‚   â”œâ”€â”€ FunctionCallList.vue          # å‡½æ•°è°ƒç”¨åˆ—è¡¨
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šå·¥å…·è°ƒç”¨ç®¡ç†ã€çŠ¶æ€æ˜¾ç¤ºã€æ“ä½œå¤„ç†
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šå·¥å…·è°ƒç”¨æµç¨‹å¯è§†åŒ–
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬130-153è¡Œæ¨¡æ¿æå–
  â”‚   â”œâ”€â”€ FunctionCallItem.vue          # å•ä¸ªå‡½æ•°è°ƒç”¨é¡¹
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šè°ƒç”¨è¯¦æƒ…ã€é‡è¯•æ“ä½œã€ç»“æœå¯¼å‡º
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šå•ä¸ªå·¥å…·è°ƒç”¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬130-153è¡Œå•é¡¹é€»è¾‘æå–
  â”‚   â””â”€â”€ AnswerDisplay.vue             # ç­”æ¡ˆæ˜¾ç¤º
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šæœ€ç»ˆç­”æ¡ˆã€ç»„ä»¶æ¸²æŸ“ã€æ“ä½œæŒ‰é’®
  â”‚       â”œâ”€ èŒè´£ï¼šç­”æ¡ˆæ ¼å¼åŒ–ã€äº¤äº’åŠŸèƒ½
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬156-162è¡Œæ¨¡æ¿æå–
  â”‚
  â”œâ”€â”€ composables/                       # ğŸ”§ ç»„åˆå¼å‡½æ•° (é€»è¾‘å¤ç”¨å±‚)
  â”‚   â”œâ”€â”€ useAIAssistantState.ts        # çŠ¶æ€ç®¡ç†
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šå¸ƒå±€çŠ¶æ€ã€å·¥å…·çŠ¶æ€ã€ä¼šè¯çŠ¶æ€ã€å·¥ä½œæµçŠ¶æ€
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šç»Ÿä¸€çŠ¶æ€ç®¡ç†ã€çŠ¶æ€æ“ä½œæ–¹æ³•
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬800-1200è¡ŒçŠ¶æ€é€»è¾‘æå–
  â”‚   â”œâ”€â”€ useMessageHandling.ts         # æ¶ˆæ¯å¤„ç†
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šæ¶ˆæ¯ä¿å­˜ã€åˆ·æ–°ã€æ ¼å¼åŒ–ã€å¿«æ·æ“ä½œ
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šæ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æœåŠ¡å™¨äº¤äº’
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬1500-2500è¡Œæ¶ˆæ¯é€»è¾‘æå–
  â”‚   â””â”€â”€ useAIResponse.ts              # AIå“åº”å¤„ç†
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šæ€è€ƒè¿‡ç¨‹ã€å·¥å…·è°ƒç”¨ã€ç­”æ¡ˆæ˜¾ç¤ºã€ç»„ä»¶æ¸²æŸ“
  â”‚       â”œâ”€ èŒè´£ï¼šAIå“åº”æµç¨‹ç®¡ç†ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬2500-4000è¡Œå“åº”é€»è¾‘æå–
  â”‚
  â”œâ”€â”€ utils/                             # ğŸ› ï¸ å·¥å…·å‡½æ•° (çº¯å‡½æ•°å±‚)
  â”‚   â”œâ”€â”€ messageFormatting.ts          # æ¶ˆæ¯æ ¼å¼åŒ–å·¥å…·
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šMarkdownè§£æã€ç»„ä»¶æ•°æ®æå–ã€æ—¶é—´æ ¼å¼åŒ–
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šæ¶ˆæ¯å†…å®¹å¤„ç†ã€æ ¼å¼è½¬æ¢
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬3933-3990è¡Œå·¥å…·å‡½æ•°æå–
  â”‚   â”œâ”€â”€ expertMessageUtils.ts         # ä¸“å®¶æ¶ˆæ¯å·¥å…·
  â”‚   â”‚   â”œâ”€ åŠŸèƒ½ï¼šä¸“å®¶æ¶ˆæ¯è¯†åˆ«ã€å†…å®¹æå–ã€æ ¼å¼åŒ–
  â”‚   â”‚   â”œâ”€ èŒè´£ï¼šä¸“å®¶ç³»ç»Ÿé›†æˆã€ä¸“ä¸šå†…å®¹å¤„ç†
  â”‚   â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬4000-4188è¡Œä¸“å®¶é€»è¾‘æå–
  â”‚   â””â”€â”€ validationUtils.ts            # éªŒè¯å·¥å…·
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šæ•°æ®éªŒè¯ã€ç±»å‹æ£€æŸ¥ã€ç»“æ„éªŒè¯
  â”‚       â”œâ”€ èŒè´£ï¼šæ•°æ®å®Œæ•´æ€§ä¿è¯ã€ç±»å‹å®‰å…¨
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬2528-2583è¡ŒéªŒè¯é€»è¾‘æå–
  â”‚
  â”œâ”€â”€ types/                             # ğŸ“ ç±»å‹å®šä¹‰
  â”‚   â””â”€â”€ aiAssistant.ts                # AIåŠ©æ‰‹ç±»å‹å®šä¹‰
  â”‚       â”œâ”€ åŠŸèƒ½ï¼šPropsã€Emitsã€Stateã€Messageç­‰ç±»å‹
  â”‚       â”œâ”€ èŒè´£ï¼šç±»å‹å®‰å…¨ã€æ¥å£è§„èŒƒ
  â”‚       â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶åˆ†æ•£çš„ç±»å‹å®šä¹‰æ•´åˆ
  â”‚
  â””â”€â”€ styles/                            # ğŸ¨ æ ·å¼æ–‡ä»¶ (æ¨¡å—åŒ–æ ·å¼)
      â”œâ”€â”€ fullscreen-layout.scss        # å…¨å±å¸ƒå±€æ ·å¼
      â”‚   â”œâ”€ åŠŸèƒ½ï¼šå…¨å±æ¨¡å¼ã€ä¸‰æ å¸ƒå±€ã€å¤´éƒ¨å¯¼èˆªã€åŠ¨ç”»æ•ˆæœ
      â”‚   â”œâ”€ èŒè´£ï¼šå¸ƒå±€æ ·å¼ã€å“åº”å¼è®¾è®¡ã€ä¸»é¢˜é€‚é…
      â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬4683-5000è¡Œæ ·å¼æå–
      â”œâ”€â”€ chat-components.scss          # èŠå¤©ç»„ä»¶æ ·å¼
      â”‚   â”œâ”€ åŠŸèƒ½ï¼šæ¶ˆæ¯æ ·å¼ã€èŠå¤©å®¹å™¨ã€æ¬¢è¿ç•Œé¢ã€è¾“å…¥åŒºåŸŸ
      â”‚   â”œâ”€ èŒè´£ï¼šèŠå¤©ç•Œé¢ç¾åŒ–ã€äº¤äº’æ•ˆæœ
      â”‚   â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬5000-6500è¡Œæ ·å¼æå–
      â””â”€â”€ ai-response.scss              # AIå“åº”æ ·å¼
          â”œâ”€ åŠŸèƒ½ï¼šæ€è€ƒè¿‡ç¨‹ã€å·¥å…·è°ƒç”¨ã€ç­”æ¡ˆæ˜¾ç¤ºã€ç»„ä»¶æ¸²æŸ“
          â”œâ”€ èŒè´£ï¼šAIå“åº”å¯è§†åŒ–ã€åŠ¨ç”»æ•ˆæœ
          â””â”€ ç‰¹ç‚¹ï¼šä»åŸæ–‡ä»¶ç¬¬6500-7500è¡Œæ ·å¼æå–

  ğŸ¯ é‡æ„æ”¶ç›Šï¼š
  â”œâ”€ ä»£ç è¡Œæ•°ï¼š8083è¡Œ â†’ <300è¡Œ (ä¸»å®¹å™¨å‡å°‘96%)
  â”œâ”€ ç»„ä»¶æ•°é‡ï¼š1ä¸ªå·¨å‹ç»„ä»¶ â†’ 20+ä¸ªå°ç»„ä»¶
  â”œâ”€ å¯ç»´æŠ¤æ€§ï¼šå›°éš¾ â†’ ä¼˜ç§€ (èŒè´£æ¸…æ™°)
  â”œâ”€ å¯æµ‹è¯•æ€§ï¼šå›°éš¾ â†’ ä¼˜ç§€ (å°ç»„ä»¶æ˜“æµ‹è¯•)
  â”œâ”€ å¤ç”¨æ€§ï¼šæ— æ³•å¤ç”¨ â†’ é«˜åº¦å¤ç”¨
  â”œâ”€ å›¢é˜Ÿåä½œï¼šå†²çªé¢‘ç¹ â†’ å¹¶è¡Œå¼€å‘
  â””â”€ åŠŸèƒ½å®Œæ•´æ€§ï¼š100%ä¿ç•™ (155é¡¹åŠŸèƒ½éªŒè¯é€šè¿‡)

  ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š
  â”œâ”€ ç›´æ¥ä½¿ç”¨ï¼š<AIAssistant v-model:visible="visible" />
  â”œâ”€ ç‹¬ç«‹ä½¿ç”¨ï¼šå¯å•ç‹¬ä½¿ç”¨ä»»æ„å­ç»„ä»¶
  â”œâ”€ é€»è¾‘å¤ç”¨ï¼šå¯ä½¿ç”¨Composableså‡½æ•°
  â””â”€ æ ·å¼å®šåˆ¶ï¼šå¯ç‹¬ç«‹ä¿®æ”¹æ¨¡å—æ ·å¼

  ğŸ“š ç›¸å…³æ–‡æ¡£ï¼š
  â”œâ”€ docs/aiæ¶æ„ä¸­å¿ƒ/aiåŠ©æ‰‹å‰ç«¯é¡µé¢é‡æ„æ¶æ„.md
  â”œâ”€ docs/aiæ¶æ„ä¸­å¿ƒ/aiåŠ©æ‰‹é‡æ„å®ŒæˆæŠ¥å‘Š.md
  â”œâ”€ docs/aiæ¶æ„ä¸­å¿ƒ/åŠŸèƒ½å®Œæ•´æ€§éªŒè¯æŠ¥å‘Š.md
  â””â”€ docs/aiæ¶æ„ä¸­å¿ƒ/aiæ¶æ„å›¾è¡¨è¯´æ˜.md
-->

<template>
  <div v-if="visible" class="ai-assistant-wrapper ai-assistant-container" data-testid="ai-assistant-wrapper">
    <!-- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç»„ä»¶ï¼ˆä¸æ¸²æŸ“UIï¼‰ -->
    <AIAssistantCore
      ref="coreRef"
      :visible="visible"
      :is-fullscreen="isFullscreen"
      @update:visible="emit('update:visible', $event)"
      @show-html-preview="handleShowHtmlPreview"
      @missing-fields-detected="handleMissingFieldsDetected"
      @loading-complete="handleLoadingComplete"
    />

    <!-- å…¨å±å¸ƒå±€ -->
    <FullscreenLayout
      v-if="currentMode === 'fullscreen'"
      :fullscreen-state="fullscreenState"
      :is-workflow-transparent="isWorkflowTransparent"
      :left-sidebar-collapsed="leftSidebarCollapsed"
      :right-sidebar-visible="rightSidebarVisible"
      :right-sidebar-loading="rightSidebarLoading"
      :active-step-queues="activeStepQueues"
      :selected-experts="selectedExperts"
      :custom-experts="customExperts"
      :tool-calls="toolCalls"
      :rendered-components="renderedComponents"
      :is-thinking="isThinking"
      :message-count="messageCount"
      :current-thinking-message="rightSidebarThinking"
      :current-theme="currentTheme"
      :ai-connected="aiConnected"
      :connection-status="connectionStatus"
      :connection-status-text="connectionStatusText"
      @toggle-left-sidebar="handleToggleLeftSidebar"
      @toggle-right-sidebar="handleToggleRightSidebar"
      @toggle-fullscreen="handleToggleFullscreen"
      @toggle-theme="handleToggleTheme"
      @show-statistics="handleShowStatistics"
      @show-clear-options="handleShowClearOptions"
      @update-selected-experts="handleUpdateSelectedExperts"
      @add-custom-expert="handleAddCustomExpert"
      @update-custom-expert="handleUpdateCustomExpert"
      @delete-custom-expert="handleDeleteCustomExpert"
      @step-queue-close="handleStepQueueClose"
      @step-queue-cancel="handleStepQueueCancel"
      @step-queue-retry="handleStepQueueRetry"
      @select-component="handleSelectComponent"
    >
      <!-- èŠå¤©å®¹å™¨æ’æ§½ -->
      <template #chat-container>
        <ChatContainer
          :messages="messages"
          :current-ai-response="currentAIResponse"
          :input-message="inputMessage"
          :web-search="webSearch"
          :message-font-size="messageFontSize"
          :sending="sending"
          :is-registered="isRegistered"
          :is-loading="isLoading"
          :is-thinking="isThinking"
          :is-listening="isListening"
          :is-speaking="isSpeaking"
          :speech-status="speechStatus"
          :has-last-message="hasLastMessage"
          :thinking-subtitle="thinkingSubtitle"
          :show-thinking-subtitle="showThinkingSubtitle"
          :is-fullscreen-mode="true"
          @update:inputMessage="inputMessage = $event"
          @update:webSearch="webSearch = $event"
          @update:fontSize="messageFontSize = $event"
          @send="handleSendMessage"
          @cancel-send="handleCancelSend"
          @stop-sending="handleStopSending"
          @suggestion="handleSuggestion"
          @ai-response-complete="handleAIResponseComplete"
          @toggle-voice-input="handleToggleVoiceInput"
          @toggle-voice-output="handleToggleVoiceOutput"
          @show-quick-query="handleShowQuickQuery"
          @toggle-thinking="handleToggleThinking"
        />
      </template>
    </FullscreenLayout>

    <!-- ä¾§è¾¹æ å¸ƒå±€ -->
    <SidebarLayout
      v-if="currentMode === 'sidebar'"
      :visible="visible"
      :tool-calls="toolCalls"
      :rendered-components="renderedComponents"
      :right-sidebar-visible="rightSidebarVisible"
      @close="handleSidebarClose"
      @show-statistics="handleShowStatistics"
      @toggle-fullscreen="handleSidebarToggleFullscreen"
      @toggle-theme="handleToggleTheme"
      @clear-chat="handleShowClearOptions"
      @toggle-tool-panel="handleToggleRightSidebar"
      @suggestion="handleSuggestion"
    >
      <!-- èŠå¤©å®¹å™¨æ’æ§½ -->
      <template #chat-container>
        <ChatContainer
          :messages="messages"
          :current-ai-response="currentAIResponse"
          :input-message="inputMessage"
          :web-search="webSearch"
          :message-font-size="messageFontSize"
          :sending="sending"
          :is-registered="isRegistered"
          :is-loading="isLoading"
          :is-thinking="isThinking"
          :is-speaking="isSpeaking"
          :is-listening="isListening"
          :speech-status="speechStatus"
          :has-last-message="hasLastMessage"
          :show-suggestions="showSuggestions"
          :suggestions="suggestions"
          :show-quick-query-groups="quickQueryGroupsVisible"
          :show-context-optimization="contextOptimization?.visible || false"
          :is-fullscreen-mode="false"
          :context-optimization-collapsed="contextOptimization?.collapsed || false"
          :context-optimization-progress="contextOptimization?.progressPercentage || 0"
          :context-optimization-text="contextOptimization?.progressText || ''"
          :show-mobile-preview="mobilePreviewVisible"
          :mobile-preview-data="mobilePreviewData"
          :thinking-subtitle="thinkingSubtitle"
          :show-thinking-subtitle="showThinkingSubtitle"
          @send="handleSendMessage"
          @stop-sending="handleStopSending"
          @update:input-message="inputMessage = $event"
          @update:web-search="webSearch = $event"
          @toggle-voice="handleToggleVoice"
          @toggle-listening="handleToggleListening"
          @stop-speaking="handleStopSpeaking"
          @upload-file="handleUploadFile"
          @upload-image="handleUploadImage"
          @toggle-font-size="handleToggleFontSize"
          @toggle-quick-query-groups="handleToggleQuickQueryGroups"
          @toggle-context-optimization="toggleContextOptimization"
          @close-mobile-preview="mobilePreviewVisible = false"
          @suggestion="handleSuggestion"
          @toggle-voice-input="handleToggleVoiceInput"
          @toggle-voice-output="handleToggleVoiceOutput"
          @show-quick-query="handleShowQuickQuery"
          @toggle-thinking="handleToggleThinking"
        />
      </template>
    </SidebarLayout>

    <!-- å¯¹è¯æ¡†ç»„ä»¶ -->
    <AIStatistics
      v-model="statisticsVisible"
      :token-usage="tokenUsage"
      :loading="tokenLoading"
    />

    <!-- å¿«æ·æŸ¥è¯¢åˆ†ç»„ - åªåœ¨visibleæ—¶æ¸²æŸ“ -->
    <QuickQueryGroups
      v-if="quickQueryGroupsVisible"
      @select-query="handleQuickQuerySelect"
      @close="quickQueryGroupsVisible = false"
    />

    <!-- ç¼ºå¤±å­—æ®µè¡¥å……å¯¹è¯æ¡† -->
    <MissingFieldsDialog
      v-model="missingFieldsDialogVisible"
      :data="missingFieldsData"
      @submit="handleMissingFieldsSubmit"
    />

    <!-- ä¸Šä¸‹æ–‡ä¼˜åŒ–ç»„ä»¶ -->
    <ContextOptimization
      v-if="contextOptimization?.visible"
      :visible="contextOptimization.visible"
      :collapsed="contextOptimization.collapsed"
      :is-optimizing="contextOptimization.isOptimizing"
      :progress-percentage="contextOptimization.progressPercentage"
      :progress-text="contextOptimization.progressText"
      :optimization-data="contextOptimization.optimizationData"
      @toggle="toggleContextOptimization"
    />

    <MobilePhonePreview
      v-if="mobilePreviewVisible"
      :preview-data="mobilePreviewData"
    />

    <!-- HTMLé¢„è§ˆç»„ä»¶ - ä½¿ç”¨Teleportä¼ é€åˆ°bodyï¼Œç¡®ä¿åœ¨æœ€é¡¶å±‚ -->
    <Teleport to="body">
      <HtmlPreview
        v-if="htmlPreviewVisible"
        :visible="htmlPreviewVisible"
        :code="htmlPreviewData?.code || ''"
        :title="htmlPreviewData?.title || 'HTMLé¢„è§ˆ'"
        :content-type="htmlPreviewData?.contentType || 'course'"
        @close="handleHtmlPreviewClose"
      />
    </Teleport>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, withDefaults, nextTick } from 'vue'
import { ElMessage } from 'element-plus'
import UnifiedIcon from '@/components/icons/UnifiedIcon.vue'
import { useUserStore } from '@/stores/user'
import { useChatHistory } from '@/composables/useChatHistory'
import { useSpeech } from '@/composables/useSpeech'
import { useMultiRoundToolCalling } from '@/composables/useMultiRoundToolCalling'

// å¯¼å…¥é‡æ„åçš„ç»„ä»¶
import FullscreenLayout from './layout/FullscreenLayout.vue'
import SidebarLayout from './layout/SidebarLayout.vue'
import ChatContainer from './chat/ChatContainer.vue'
import AIAssistantCore from './core/AIAssistantCore.vue'

// å¯¼å…¥å¯¹è¯æ¡†ç»„ä»¶ï¼ˆå·²è¿ç§»åˆ°æ­£å¼ç›®å½•ï¼‰
import AIStatistics from './dialogs/AIStatistics.vue'
import QuickQueryGroups from './dialogs/QuickQueryGroups.vue'
import MissingFieldsDialog from './dialogs/MissingFieldsDialog.vue'
import MobilePhonePreview from '@/components/preview/MobilePhonePreview.vue'

// å¯¼å…¥AIå“åº”ç»„ä»¶
import ContextOptimization from './ai-response/ContextOptimization.vue'

// å¯¼å…¥HTMLé¢„è§ˆç»„ä»¶
import HtmlPreview from './preview/HtmlPreview.vue'

// å¯¼å…¥Vue Router
import { useRouter, useRoute } from 'vue-router'

// å¯¼å…¥composables
import { useAIAssistantState } from './composables/useAIAssistantState'
import { useMessageHandling } from './composables/useMessageHandling'
import { useAIResponse } from './composables/useAIResponse'
import { useUserPreferences } from './composables/useUserPreferences'
import { useFullscreenMode } from './composables/useFullscreenMode'

// å¯¼å…¥å·¥å…·å‡½æ•°
import { generateColumnsFromData } from './utils/tableUtils'
import { callUnifiedIntelligenceStream } from '@/api/endpoints/function-tools'

// å¯¼å…¥ç±»å‹
import type { AIAssistantProps, AIAssistantEmits, CurrentAIResponseState } from './types/aiAssistant'

// ==================== Props & Emits ====================
const props = withDefaults(defineProps<AIAssistantProps>(), {
  visible: true,  // ä½œä¸ºè·¯ç”±ç»„ä»¶æ—¶é»˜è®¤æ˜¾ç¤º
  isFullscreen: false,
  mode: 'fullscreen'  // é»˜è®¤å…¨å±æ¨¡å¼
})
const emit = defineEmits<AIAssistantEmits>()

// ==================== Router ====================
const router = useRouter()
const route = useRoute()

// ==================== æ˜¾ç¤ºæ¨¡å¼ ====================
const currentMode = computed(() => props.mode || 'fullscreen')

// ==================== æ ¸å¿ƒä¾èµ– ====================
const userStore = useUserStore()
const chatHistory = useChatHistory()
const speech = useSpeech()

// ==================== ç§»é™¤WebSocketï¼Œç›´æ¥ä½¿ç”¨HTTP API ====================
// ğŸ”§ ç§»é™¤äº† usePersistentProgress å’Œ WebSocket è¿æ¥
// ç°åœ¨ç›´æ¥é€šè¿‡ HTTP API è°ƒç”¨åç«¯ AIBridge æœåŠ¡
const aiConnected = ref(false) // ä¿æŒå…¼å®¹æ€§ï¼Œä½†å§‹ç»ˆä¸ºfalse
const connectionStatus = ref<'disconnected'>('disconnected')
const connectionStatusText = computed(() => 'ä½¿ç”¨HTTP APIæ¨¡å¼')
const updateActivity = () => {} // ç©ºå‡½æ•°ï¼Œä¿æŒå…¼å®¹æ€§

// ==================== æ ¸å¿ƒç»„ä»¶å¼•ç”¨ ====================
const coreRef = ref<InstanceType<typeof AIAssistantCore>>()

// ==================== ä½¿ç”¨Composablesç›´æ¥ç®¡ç†çŠ¶æ€ ====================
// AIåŠ©æ‰‹çŠ¶æ€
const aiState = useAIAssistantState()
// æ¶ˆæ¯å¤„ç†
const messageHandling = useMessageHandling()
// AIå“åº”
const aiResponse = useAIResponse()
// å¤šè½®å·¥å…·è°ƒç”¨
const toolCalling = useMultiRoundToolCalling()
// ğŸ†• ç”¨æˆ·åå¥½ç®¡ç†
const userPreferences = useUserPreferences()
// ğŸ†• å…¨å±æ¨¡å¼ç®¡ç†
const fullscreenMode = useFullscreenMode()

// ==================== å“åº”å¼çŠ¶æ€ï¼ˆä»Composablesè·å–ï¼‰ ====================
// AIå“åº”çŠ¶æ€
// ğŸ”§ ä¿®å¤ï¼šä¸è¦è§£æ„ ref å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨ aiResponse.currentAIResponse ä¿æŒå“åº”å¼
const {
  showThinkingPhase,
  showFunctionCall,
  showFinalAnswer,
  toggleThinking,
  // ä¸Šä¸‹æ–‡ä¼˜åŒ–ç›¸å…³
  showContextOptimization,
  startContextOptimization,
  updateOptimizationProgress,
  completeContextOptimization,
  toggleContextOptimization
} = aiResponse

// ğŸ¯ ç›´æ¥ä½¿ç”¨ ref å¯¹è±¡ï¼Œä¿æŒå“åº”å¼
const currentAIResponse = aiResponse.currentAIResponse
const contextOptimization = aiResponse.contextOptimization

// å¸ƒå±€çŠ¶æ€
const {
  fullscreenState,
  isWorkflowTransparent,
  leftSidebarCollapsed,
  rightSidebarVisible,
  rightSidebarLoading,
  conversationId,
  conversations,
  conversationsLoading,
  tokenUsage,
  tokenLoading,
  statisticsVisible,
  quickQueryGroupsVisible,
  mobilePreviewVisible,
  mobilePreviewData,
  // HTMLé¢„è§ˆçŠ¶æ€
  htmlPreviewVisible,
  htmlPreviewData,
  // ç¼ºå¤±å­—æ®µå¯¹è¯æ¡†çŠ¶æ€
  missingFieldsDialogVisible,
  missingFieldsData,
  // å·¥å…·è°ƒç”¨å’Œç»„ä»¶çŠ¶æ€
  toolCalls,
  renderedComponents,
  activeStepQueues,
  // ğŸ†• ä¸“å®¶ç®¡ç†çŠ¶æ€
  selectedExperts,
  customExperts,
  // ğŸ†• ä¸“å®¶ç®¡ç†æ–¹æ³•
  updateSelectedExperts,
  addCustomExpert,
  updateCustomExpert,
  deleteCustomExpert,
  loadExpertsFromStorage
} = aiState

// ğŸ†• ç”¨æˆ·åå¥½çŠ¶æ€
const {
  webSearch,
  messageFontSize,
  loadPreferences,
  markInitialized
} = userPreferences

// æœ¬åœ°çŠ¶æ€
const inputMessage = ref('')
const sending = ref(false)
const currentTheme = ref('theme-light')

// ğŸ¯ å³ä¾§ä¾§è¾¹æ AIæ€è€ƒçŠ¶æ€ (ç‹¬ç«‹ç®¡ç†ï¼Œ3è¡Œé™åˆ¶)
const rightSidebarThinking = ref('')

// ğŸ¯ è¾“å…¥æ¡†ä¸Šæ–¹çš„æ€è€ƒå­—å¹•çŠ¶æ€
const thinkingSubtitle = ref('')
const showThinkingSubtitle = ref(false)

// ğŸ”§ ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„å“åº”å¼çŠ¶æ€
const isLoading = ref(false)
const showSuggestions = ref(false)
const suggestions = ref<string[]>([])

// ğŸ”§ ä¿®å¤Bug #1: é˜²æ­¢æ¶ˆæ¯é‡å¤ä¿å­˜çš„æ ‡å¿—
const currentRequestSaved = ref(false)

// ğŸ” æœç´¢æ¶ˆæ¯IDï¼Œç”¨äºæ›´æ–°æœç´¢è¿›åº¦
const currentSearchMessageId = ref('')

// ğŸ¤” æ€è€ƒæ¶ˆæ¯IDï¼Œç”¨äºæ›´æ–°æ€è€ƒå†…å®¹
const currentThinkingMessageId = ref('')

// ğŸ” æœç´¢çŠ¶æ€è¿½è¸ª - ç”¨äºè¿‡æ»¤æœç´¢æœŸé—´çš„å…¶ä»–äº‹ä»¶
const isSearching = ref(false)

// ==================== è®¡ç®—å±æ€§ ====================
const messages = computed(() => chatHistory.currentMessages.value || [])
const messageCount = computed(() => messages.value.length)
// ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ username åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²æ³¨å†Œï¼ˆå…¼å®¹åç«¯æœªè¿”å› id çš„æƒ…å†µï¼‰
const isRegistered = computed(() => !!userStore.userInfo?.username || !!userStore.userInfo?.id)

const isListening = computed(() => speech.isListening.value)
const isSpeaking = computed(() => speech.isSpeaking.value)
const speechStatus = computed(() => speech.speechStatus.value)
const hasLastMessage = computed(() => messages.value.length > 0)

// AIå“åº”ç›¸å…³è®¡ç®—å±æ€§
const isThinking = computed(() => rightSidebarThinking.value.length > 0)
const currentThinkingMessage = computed(() => rightSidebarThinking.value || '')

// ==================== ç›‘å¬å™¨ ====================
// ğŸ”§ ç›‘å¬å·¥å…·è°ƒç”¨å˜åŒ–ï¼Œè‡ªåŠ¨æ‰“å¼€å³ä¾§æ 
watch(
  () => currentAIResponse.value?.functionCalls?.length,
  (newLength, oldLength) => {
    // å½“æœ‰æ–°çš„å·¥å…·è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨æ‰“å¼€å³ä¾§æ 
    if (newLength && newLength > (oldLength || 0)) {
      console.log('ğŸ”§ æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼Œè‡ªåŠ¨æ‰“å¼€å³ä¾§æ ')
      rightSidebarVisible.value = true
    }
  },
  { immediate: false }
)

// ğŸ”§ ç›‘å¬ç”¨æˆ·åå¥½å˜åŒ–å·²åœ¨useUserPreferencesä¸­è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€é‡å¤ç›‘å¬

// ==================== äº‹ä»¶å¤„ç†æ–¹æ³• ====================
const handleToggleLeftSidebar = () => {
  leftSidebarCollapsed.value = !leftSidebarCollapsed.value
}

const handleToggleRightSidebar = () => {
  rightSidebarVisible.value = !rightSidebarVisible.value
}

const handleToggleFullscreen = () => {
  // å…¨å±æ¨¡å¼æ˜¯å”¯ä¸€æ¨¡å¼ï¼Œåˆ‡æ¢å…¨å±ç­‰åŒäºå…³é—­AIåŠ©æ‰‹
  emit('update:visible', false)
}

const handleToggleTheme = () => {
  currentTheme.value = currentTheme.value === 'theme-light' ? 'theme-dark' : 'theme-light'
  document.documentElement.className = currentTheme.value
}

const handleShowStatistics = () => {
  statisticsVisible.value = true
}

const handleShowClearOptions = () => {
  // å®ç°æ¸…ç©ºé€‰é¡¹é€»è¾‘
  console.log('æ˜¾ç¤ºæ¸…ç©ºé€‰é¡¹')
}

// ğŸ¯ ä¸“å®¶é€‰æ‹©äº‹ä»¶å¤„ç†ï¼ˆä½¿ç”¨composableæ–¹æ³•ï¼‰
const handleUpdateSelectedExperts = (expertIds: string[]) => {
  updateSelectedExperts(expertIds)
}

const handleAddCustomExpert = (expert: any) => {
  addCustomExpert(expert, userStore.userInfo?.id)
}

const handleUpdateCustomExpert = (expert: any) => {
  updateCustomExpert(expert)
}

const handleDeleteCustomExpert = (expertId: string) => {
  deleteCustomExpert(expertId)
}

const handleStepQueueClose = (queueId: string) => {
  const index = activeStepQueues.value.indexOf(queueId)
  if (index > -1) {
    activeStepQueues.value.splice(index, 1)
  }
}

const handleStepQueueCancel = (queueId: string) => {
  handleStepQueueClose(queueId)
}

const handleStepQueueRetry = (queueId: string) => {
  // å®ç°é‡è¯•é€»è¾‘
  console.log('é‡è¯•å·¥ä½œæµ:', queueId)
}

const handleSelectComponent = (component: any) => {
  // å®ç°ç»„ä»¶é€‰æ‹©é€»è¾‘
  console.log('é€‰æ‹©ç»„ä»¶:', component)
}

// ä¾§è¾¹æ å…³é—­äº‹ä»¶å¤„ç†
const handleSidebarClose = () => {
  emit('update:visible', false)
}

// ä¾§è¾¹æ åˆ‡æ¢åˆ°å…¨å±æ¨¡å¼
const handleSidebarToggleFullscreen = () => {
  // è·³è½¬åˆ°å…¨å±é¡µé¢
  router.push('/ai')
}

const handleSendMessage = async () => {
  if (!inputMessage.value.trim() || sending.value) return

  const message = inputMessage.value.trim()
  inputMessage.value = ''
  sending.value = true

  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸ“¤ [HTTP APIæ¨¡å¼] å¼€å§‹å‘é€æ¶ˆæ¯')
  console.log('ğŸ“ [æ¶ˆæ¯å†…å®¹]:', message)
  console.log('ğŸ¤– [AIæ™ºèƒ½è·¯ç”±] è‡ªåŠ¨åˆ†ææ¶ˆæ¯æ„å›¾å¹¶è°ƒç”¨å·¥å…·')
  console.log('ğŸ‘¤ [ç”¨æˆ·ID]:', userStore.userInfo?.id)
  console.log('ğŸ’¬ [ä¼šè¯ID]:', conversationId.value)

  // ğŸ¯ å…³é”®æ£€æŸ¥ï¼šç¡®ä¿ä¼šè¯IDå­˜åœ¨
  if (!conversationId.value) {
    console.warn('âš ï¸ [ä¼šè¯æ£€æŸ¥] ä¼šè¯IDä¸ºç©ºï¼Œå°è¯•åˆå§‹åŒ–...')
    try {
      const convId = await messageHandling.ensureConversation()
      conversationId.value = convId
      console.log('âœ… [ä¼šè¯æ£€æŸ¥] ä¼šè¯IDåˆå§‹åŒ–æˆåŠŸ:', convId)
    } catch (error) {
      console.error('âŒ [ä¼šè¯æ£€æŸ¥] ä¼šè¯IDåˆå§‹åŒ–å¤±è´¥:', error)
      const tempId = `temp_${Date.now()}`
      conversationId.value = tempId
      console.log('âš ï¸ [ä¼šè¯æ£€æŸ¥] ä½¿ç”¨ä¸´æ—¶ä¼šè¯ID:', tempId)
    }
  }

  console.log('âœ… [ä¼šè¯ç¡®è®¤] æœ€ç»ˆä½¿ç”¨çš„ä¼šè¯ID:', conversationId.value)
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

  // ğŸ¯ éšè—æ€è€ƒå­—å¹•
  showThinkingSubtitle.value = false
  thinkingSubtitle.value = ''

  // ğŸ”§ Bug #1ä¿®å¤: é‡ç½®æ¶ˆæ¯ä¿å­˜æ ‡å¿—
  currentRequestSaved.value = false

  try {
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    chatHistory.addMessage({
      role: 'user',
      content: message
    })

    // ğŸŒ ç›´æ¥ä½¿ç”¨HTTP APIè°ƒç”¨åç«¯AIBridge
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('ğŸŒ [HTTP APIæ¨¡å¼] ç›´æ¥è°ƒç”¨åç«¯AIBridgeæœåŠ¡')
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('ğŸš€ [AIæ™ºèƒ½è·¯ç”±] åç«¯è‡ªåŠ¨åˆ†ææ¶ˆæ¯æ„å›¾å¹¶è°ƒç”¨å·¥å…·')
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

    // ğŸ†• ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆä¸ç­‰å¾…åç«¯å“åº”ï¼‰
    isLoading.value = true
    console.log('âœ… [åŠ è½½çŠ¶æ€] å·²æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯')

    // æ‰“å¼€å³ä¾§å·¥å…·ä¾§è¾¹æ 
    rightSidebarVisible.value = true
    rightSidebarLoading.value = true
    // æ¸…ç†ä¸Šä¸€è½®çš„å·¥å…·è°ƒç”¨å†å²ï¼ˆé¿å…æ–°ä¸€è½®å åŠ åˆ°æ—§è®°å½•ä¸Šï¼‰
    try { toolCalls.value = [] } catch (_) {}
    // ğŸ¯ æ¸…ç©ºå½“å‰AIå“åº”ï¼Œé¿å…æ˜¾ç¤ºä¸Šä¸€æ¬¡çš„å“åº”
    aiResponse.clearCurrentAIResponse()
    console.log('âœ… [å‘é€æ¶ˆæ¯] å·²æ¸…ç©ºä¸Šä¸€æ¬¡çš„AIå“åº”')

    // ğŸ¯ è°ƒç”¨ç»Ÿä¸€æ™ºèƒ½è·¯ç”±æœåŠ¡
    await callUnifiedIntelligenceWithProgress(message)
  } catch (error) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error)
    // ğŸ†• é”™è¯¯æ—¶å…³é—­åŠ è½½çŠ¶æ€
    isLoading.value = false
    // ğŸ”§ é”™è¯¯æ—¶ä¹Ÿè¦é‡ç½®sendingçŠ¶æ€
    sending.value = false
  }
}

const handleCancelSend = () => {
  sending.value = false
}

// ğŸ”§ å¤„ç†AIå“åº”å®Œæˆäº‹ä»¶
const handleAIResponseComplete = () => {
  console.log('âœ… [AIAssistant] AIå“åº”å·²å®Œæˆï¼Œé‡ç½®sendingçŠ¶æ€')
  sending.value = false
}

// ï¿½ æ£€æµ‹æ˜¯å¦ä¸ºæœç´¢æŸ¥è¯¢
const isSearchQuery = (message: string): boolean => {
  const searchKeywords = ['æœç´¢', 'æŸ¥è¯¢ç½‘é¡µ', 'æœç´¢ç½‘é¡µ', 'ç½‘ç»œæœç´¢', 'æŸ¥æ‰¾', 'æœä¸€ä¸‹', 'æœç´¢ä¸€ä¸‹', 'search', 'web search']
  return searchKeywords.some(keyword => message.toLowerCase().includes(keyword.toLowerCase()))
}

// ï¿½ğŸš€ è°ƒç”¨ç»Ÿä¸€æ™ºèƒ½è·¯ç”±æœåŠ¡ï¼ˆæ”¯æŒè¿›åº¦å›è°ƒï¼‰
const callUnifiedIntelligenceWithProgress = async (message: string) => {
  try {
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
    console.log('ğŸš€ [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å¼€å§‹è°ƒç”¨ç»Ÿä¸€æ™ºèƒ½æœåŠ¡')
    console.log('ğŸ“ [æ¶ˆæ¯å†…å®¹]:', message)
    console.log('ğŸ‘¤ [ç”¨æˆ·ID]:', userStore.userInfo?.id)
    console.log('ğŸ’¬ [ä¼šè¯ID]:', conversationId.value)
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

    // ğŸ” æ£€æµ‹æœç´¢æŸ¥è¯¢å¹¶è‡ªåŠ¨å¯ç”¨ç½‘ç»œæœç´¢
    const enableWebSearch = isSearchQuery(message)
    console.log(`ğŸ” [æœç´¢æ£€æµ‹] æ˜¯å¦ä¸ºæœç´¢æŸ¥è¯¢: ${enableWebSearch}`)

    // è°ƒç”¨ç»Ÿä¸€æ™ºèƒ½æµå¼æ¥å£
    await callUnifiedIntelligenceStream(
      {
        message,
        userId: userStore.userInfo?.id?.toString(),
        conversationId: conversationId.value,
        context: {
          currentPage: route.path,
          pageTitle: route.meta?.title || 'AIåŠ©æ‰‹',
          userRole: userStore.userInfo?.role || 'user',
          enableTools: true,
          enableWebSearch  // ğŸ” è‡ªåŠ¨æ£€æµ‹æœç´¢æŸ¥è¯¢å¹¶å¯ç”¨ç½‘ç»œæœç´¢
          // ğŸ”§ ç§»é™¤ï¼šautoExecute å·²åºŸå¼ƒï¼Œç°åœ¨ç”±å¤§æ¨¡å‹è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦è°ƒç”¨å·¥å…·
        }
      },
      // è¿›åº¦å›è°ƒ
      (event) => {
        console.log(`[ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] ${event.type}:`, event.message || event.data)

        switch (event.type) {
          case 'start':
            console.log('ğŸš€ [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å¼€å§‹å¤„ç†è¯·æ±‚')
            break

          case 'thinking_start':
            console.log('ğŸ¤” [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å¼€å§‹æ€è€ƒ')
            emit('loading-complete')
            break

          case 'thinking':
          case 'thinking_update':
            // ğŸ” æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡æ€è€ƒäº‹ä»¶
            if (isSearching.value) {
              console.log(`â¸ï¸ [äº‹ä»¶è¿‡æ»¤] æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡ ${event.type} äº‹ä»¶`)
              break
            }
            if (event.data?.content || event.message) {
              const thinkingContent = event.data?.content || event.message || ''
              rightSidebarThinking.value = thinkingContent
              aiResponse.showThinkingPhase(thinkingContent)

              // ğŸ†• åœ¨èŠå¤©å†å²ä¸­æ˜¾ç¤ºæ€è€ƒæ¶ˆæ¯
              if (!currentThinkingMessageId.value) {
                const thinkingMsg = {
                  id: `thinking-${Date.now()}`,
                  role: 'assistant' as const,
                  type: 'thinking' as const,
                  content: thinkingContent,
                  timestamp: new Date().toISOString()
                }
                chatHistory.addMessage(thinkingMsg)
                currentThinkingMessageId.value = thinkingMsg.id
              } else {
                chatHistory.updateMessage(currentThinkingMessageId.value, {
                  content: thinkingContent
                })
              }
            }
            break

          case 'tool_intent':
            // ğŸ” æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡å·¥å…·æ„å›¾äº‹ä»¶
            if (isSearching.value) {
              console.log(`â¸ï¸ [äº‹ä»¶è¿‡æ»¤] æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡ tool_intent äº‹ä»¶`)
              break
            }
            console.log('ğŸ¯ [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å·¥å…·æ„å›¾è¯´æ˜:', event.message)
            // æ˜¾ç¤ºå·¥å…·æ„å›¾è¯´æ˜ï¼Œè®©ç”¨æˆ·çŸ¥é“AIå‡†å¤‡æ‰§è¡Œä»€ä¹ˆæ“ä½œ
            if (event.message) {
              // å¯ä»¥åœ¨å³ä¾§è¾¹æ æˆ–è€…æ¶ˆæ¯ä¸­æ˜¾ç¤ºå·¥å…·æ„å›¾
              rightSidebarThinking.value = `ğŸ”§ å‡†å¤‡æ‰§è¡Œ: ${event.message}`
              // æˆ–è€…æ·»åŠ åˆ°AIå“åº”çš„æ€è€ƒé˜¶æ®µ
              if (aiResponse.showThinkingPhase) {
                aiResponse.showThinkingPhase(`ğŸ”§ å·¥å…·æ„å›¾: ${event.message}`)
              }
              // ğŸ†• æ·»åŠ åˆ°èŠå¤©å†å²ä¸­æ˜¾ç¤º
              chatHistory.addMessage({
                id: `tool-intent-${Date.now()}`,
                role: 'assistant' as const,
                type: 'tool_intent' as const,
                content: event.message,
                timestamp: new Date().toISOString()
              })
            }
            break

          case 'tool_call_start':
            console.log('ğŸ”§ [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å¼€å§‹å·¥å…·è°ƒç”¨:', event.data)
            if (!currentAIResponse.value.visible) {
              currentAIResponse.value.visible = true
            }
            rightSidebarLoading.value = false

            // ğŸ”§ æ–°å¢ï¼šä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯åˆ°currentAIResponseå’ŒchatHistory
            if (event.data) {
              const toolId = `tool-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
              const toolName = event.data.name || 'æœªçŸ¥å·¥å…·'
              const toolIntent = event.data.intent || ''
              const toolDescription = event.message || ''

              const toolCall = {
                name: toolName,
                description: toolDescription,
                arguments: event.data.arguments || {},
                status: 'running' as const,
                result: null
              }
              currentAIResponse.value.functionCalls.push(toolCall)
              console.log('âœ… [å·¥å…·è°ƒç”¨] å·²æ·»åŠ åˆ°functionCalls:', toolCall.name)

              // ğŸ¯ åŒæ—¶æ·»åŠ åˆ°chatHistoryï¼Œä½¿å…¶èƒ½åœ¨MessageListä¸­æ˜¾ç¤º
              chatHistory.addMessage({
                id: toolId,
                role: 'assistant' as const,
                type: 'tool_call' as const,
                content: toolName,
                toolName: toolName,
                toolIntent: toolIntent,
                toolDescription: toolDescription,
                toolStatus: 'running' as const,
                timestamp: new Date().toISOString()
              })
              console.log('âœ… [å·¥å…·è°ƒç”¨] å·²æ·»åŠ åˆ°chatHistory:', toolId, toolName)
            }
            break

          // ğŸ” æœç´¢äº‹ä»¶å¤„ç†
          case 'search_start':
            console.log('ğŸ” [æœç´¢] å¼€å§‹æœç´¢:', event.data)
            // ğŸ” è®¾ç½®æœç´¢çŠ¶æ€ï¼Œå¼€å§‹è¿‡æ»¤å…¶ä»–äº‹ä»¶
            isSearching.value = true
            const searchStartMsg = {
              id: `search-${Date.now()}`,
              role: 'assistant' as const,
              type: 'search' as const,
              content: event.message || 'ğŸ” æ­£åœ¨æœç´¢ç½‘ç»œä¿¡æ¯...',
              timestamp: new Date().toISOString(),
              searchStatus: 'start' as const,
              searchQuery: event.data?.query || ''
            }
            chatHistory.addMessage(searchStartMsg)
            // ä¿å­˜æœç´¢æ¶ˆæ¯IDï¼Œç”¨äºåç»­æ›´æ–°
            currentSearchMessageId.value = searchStartMsg.id
            break

          case 'search_progress':
            console.log('ğŸ” [æœç´¢] æœç´¢è¿›åº¦:', event.data)
            // æ›´æ–°æœ€åä¸€æ¡æœç´¢æ¶ˆæ¯
            const lastSearchMsg = messages.value.find(
              m => m.id === currentSearchMessageId.value
            )
            if (lastSearchMsg) {
              lastSearchMsg.searchStatus = 'progress'
              lastSearchMsg.searchPercentage = event.data?.progress || 0
              lastSearchMsg.content = event.message || 'æœç´¢ä¸­...'
              lastSearchMsg.timestamp = new Date().toISOString()
              console.log('âœ… [æœç´¢] å·²æ›´æ–°æœç´¢è¿›åº¦:', event.data?.progress)
            }
            break

          case 'search_complete':
            console.log('âœ… [æœç´¢] æœç´¢å®Œæˆ:', event.data)
            // æ›´æ–°æœç´¢æ¶ˆæ¯ä¸ºå®ŒæˆçŠ¶æ€
            const completeSearchMsg = messages.value.find(
              m => m.id === currentSearchMessageId.value
            )
            if (completeSearchMsg) {
              completeSearchMsg.searchStatus = 'complete'
              completeSearchMsg.searchPercentage = 100
              completeSearchMsg.searchResultCount = event.data?.resultCount || 0
              completeSearchMsg.searchResults = event.data?.results || []
              completeSearchMsg.content = event.message || `âœ… æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${event.data?.resultCount || 0} ä¸ªç»“æœ`
              completeSearchMsg.timestamp = new Date().toISOString()
              console.log('âœ… [æœç´¢] å·²æ›´æ–°æœç´¢å®ŒæˆçŠ¶æ€')
            }
            currentSearchMessageId.value = ''
            // ğŸ” æœç´¢å®Œæˆï¼Œæ¢å¤å…¶ä»–äº‹ä»¶å¤„ç†
            isSearching.value = false
            break

          case 'tool_call_complete':
            console.log('âœ… [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] å·¥å…·è°ƒç”¨å®Œæˆ:', event.data)

            // ğŸ”§ æ–°å¢ï¼šæ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€
            if (event.data?.name) {
              const toolName = event.data.name
              const toolCall = currentAIResponse.value.functionCalls.find(
                tc => tc.name === toolName && tc.status === 'running'
              )
              if (toolCall) {
                toolCall.status = event.data.result?.status === 'success' ? 'completed' : 'failed'
                toolCall.result = event.data.result
                console.log('âœ… [å·¥å…·è°ƒç”¨] çŠ¶æ€å·²æ›´æ–°:', toolCall.name, 'â†’', toolCall.status)
              }

              // ğŸ¯ åŒæ—¶æ›´æ–°chatHistoryä¸­çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯çŠ¶æ€
              const toolCallMsg = messages.value.find(m =>
                m.type === 'tool_call' && m.toolName === toolName && m.toolStatus === 'running'
              )
              if (toolCallMsg) {
                toolCallMsg.toolStatus = event.data.result?.status === 'success' ? 'completed' : 'failed'
                console.log('âœ… [å·¥å…·è°ƒç”¨] chatHistoryçŠ¶æ€å·²æ›´æ–°:', toolCallMsg.toolName, 'â†’', toolCallMsg.toolStatus)
              }

              // ğŸ¯ å¤„ç†UIæŒ‡ä»¤ï¼ˆnavigateã€render_componentç­‰ï¼‰
              const uiInstruction = event.data?.result?.result?.ui_instruction
              if (uiInstruction) {
                console.log('ğŸ¨ [UIæŒ‡ä»¤] æ£€æµ‹åˆ°UIæŒ‡ä»¤:', uiInstruction.type)

                // å¤„ç†é¡µé¢å¯¼èˆª
                if (uiInstruction.type === 'navigate' && uiInstruction.target) {
                  console.log('ğŸ§­ [é¡µé¢å¯¼èˆª] æ‰§è¡Œé¡µé¢è·³è½¬:', uiInstruction.target)
                  try {
                    router.push(uiInstruction.target)
                    ElMessage.success(`æ­£åœ¨å¯¼èˆªåˆ°${uiInstruction.page || 'ç›®æ ‡é¡µé¢'}...`)
                  } catch (error) {
                    console.error('âŒ [é¡µé¢å¯¼èˆª] å¯¼èˆªå¤±è´¥:', error)
                    ElMessage.error('é¡µé¢å¯¼èˆªå¤±è´¥')
                  }
                }

                // å¤„ç†ç»„ä»¶æ¸²æŸ“ï¼ˆè¿™ä¸ªä¼šé€šè¿‡componentDataè‡ªåŠ¨å¤„ç†ï¼‰
                if (uiInstruction.type === 'render_component') {
                  console.log('ğŸ“Š [ç»„ä»¶æ¸²æŸ“] æ£€æµ‹åˆ°ç»„ä»¶æ¸²æŸ“æŒ‡ä»¤ï¼Œå°†åœ¨æ¶ˆæ¯ä¸­æ˜¾ç¤º')
                }
              }
            }
            break

          // ğŸ†• å·¥å…·è°ƒç”¨æè¿°äº‹ä»¶
          case 'tool_call_description':
            console.log('ğŸ“ [å·¥å…·è°ƒç”¨æè¿°]:', event.data)
            if (event.data?.name) {
              const toolCall = currentAIResponse.value.functionCalls.find(
                tc => tc.name === event.data.name && tc.status === 'running'
              )
              if (toolCall) {
                toolCall.description = event.data.description || toolCall.description
                console.log('âœ… [å·¥å…·æè¿°] å·²æ›´æ–°:', toolCall.name)
              }
              // ğŸ†• æ·»åŠ åˆ°èŠå¤©å†å²ä¸­æ˜¾ç¤º
              chatHistory.addMessage({
                id: `tool-desc-${Date.now()}`,
                role: 'assistant' as const,
                type: 'tool_call_description' as const,
                content: event.data.description || `å·¥å…· ${event.data.name} çš„è¯´æ˜`,
                toolName: event.data.name,
                timestamp: new Date().toISOString()
              })
            }
            break

          // ğŸ†• å·¥å…·è§£è¯´äº‹ä»¶ - æ˜¾ç¤ºAIå¯¹å·¥å…·æ‰§è¡Œç»“æœçš„è§£è¯´
          case 'tool_narration':
            console.log('ğŸ’¬ [å·¥å…·è§£è¯´]:', event.data)
            // ğŸ”§ ä¿®å¤ï¼ševent.data ä¸­çš„å­—æ®µæ˜¯ toolName è€Œä¸æ˜¯ name
            const toolNameForNarration = event.data?.toolName || event.data?.name
            if (toolNameForNarration) {
              const toolCall = currentAIResponse.value.functionCalls.find(
                tc => tc.name === toolNameForNarration
              )
              if (toolCall) {
                toolCall.narration = event.data.narration || ''
                console.log('âœ… [å·¥å…·è§£è¯´] å·²æ·»åŠ :', toolCall.name)
              }
              // åŒæ—¶æ·»åŠ åˆ°chatHistoryä½œä¸ºæ¶ˆæ¯æ˜¾ç¤º
              chatHistory.addMessage({
                id: `narration-${Date.now()}`,
                role: 'assistant' as const,
                type: 'tool_narration' as const,
                content: event.data.narration || '',
                toolName: toolNameForNarration,
                timestamp: new Date().toISOString()
              })
              console.log('âœ… [å·¥å…·è§£è¯´] å·²æ·»åŠ åˆ°èŠå¤©å†å²:', toolNameForNarration)
            }
            break

          case 'context_optimization_start':
            if (aiResponse.startContextOptimization) {
              aiResponse.startContextOptimization()
            }
            // ğŸ†• æ·»åŠ åˆ°èŠå¤©å†å²ä¸­æ˜¾ç¤º
            chatHistory.addMessage({
              id: `context-opt-${Date.now()}`,
              role: 'assistant' as const,
              type: 'context_optimization' as const,
              content: event.message || 'ğŸ§  å¼€å§‹æ™ºèƒ½ä¸Šä¸‹æ–‡ä¼˜åŒ–...',
              optimizationStatus: 'start' as const,
              timestamp: new Date().toISOString()
            })
            break

          case 'context_optimization_progress':
            if (event.data?.percentage !== undefined && event.data?.text && aiResponse.updateOptimizationProgress) {
              aiResponse.updateOptimizationProgress(event.data.percentage, event.data.text)
            }
            // ğŸ†• æ›´æ–°èŠå¤©å†å²ä¸­çš„ä¼˜åŒ–è¿›åº¦
            const lastOptMsg = messages.value.find(
              m => m.type === 'context_optimization' && m.optimizationStatus === 'start'
            )
            if (lastOptMsg) {
              lastOptMsg.content = event.data?.text || event.message || 'æ­£åœ¨ä¼˜åŒ–ä¸Šä¸‹æ–‡...'
              lastOptMsg.optimizationPercentage = event.data?.percentage || 0
              lastOptMsg.timestamp = new Date().toISOString()
            }
            break

          case 'context_optimization_complete':
            if (event.data && aiResponse.completeContextOptimization) {
              aiResponse.completeContextOptimization(event.data)
            }
            // ğŸ†• æ›´æ–°èŠå¤©å†å²ä¸­çš„ä¼˜åŒ–å®ŒæˆçŠ¶æ€
            const completeOptMsg = messages.value.find(
              m => m.type === 'context_optimization' && m.optimizationStatus === 'start'
            )
            if (completeOptMsg) {
              completeOptMsg.optimizationStatus = 'complete'
              completeOptMsg.content = event.message || 'âœ… ä¸Šä¸‹æ–‡ä¼˜åŒ–å®Œæˆ'
              completeOptMsg.optimizationPercentage = 100
              completeOptMsg.timestamp = new Date().toISOString()
            }
            break

          // ğŸ” æ³¨æ„ï¼šsearch_start/search_progress/search_complete å·²åœ¨ä¸Šé¢å¤„ç†è¿‡ï¼Œä¸éœ€è¦é‡å¤å¤„ç†

          // ğŸ”„ å·¥ä½œæµäº‹ä»¶å¤„ç†
          case 'workflow_step_start':
            console.log('ğŸ”„ [å·¥ä½œæµ] æ­¥éª¤å¼€å§‹:', event.data)
            chatHistory.addMessage({
              id: `workflow-${Date.now()}`,
              role: 'assistant' as const,
              type: 'workflow_step' as const,
              content: event.data?.stepTitle || 'å·¥ä½œæµæ­¥éª¤å¼€å§‹',
              workflowStatus: 'start' as const,
              timestamp: new Date().toISOString()
            })
            break

          case 'workflow_step_complete':
            console.log('âœ… [å·¥ä½œæµ] æ­¥éª¤å®Œæˆ:', event.data)
            chatHistory.addMessage({
              id: `workflow-${Date.now()}`,
              role: 'assistant' as const,
              type: 'workflow_step' as const,
              content: `âœ… ${event.data?.stepTitle || 'å·¥ä½œæµæ­¥éª¤å®Œæˆ'}`,
              workflowStatus: 'complete' as const,
              timestamp: new Date().toISOString()
            })
            break

          case 'workflow_step_failed':
            console.log('âŒ [å·¥ä½œæµ] æ­¥éª¤å¤±è´¥:', event.data)
            chatHistory.addMessage({
              id: `workflow-${Date.now()}`,
              role: 'assistant' as const,
              type: 'workflow_step' as const,
              content: `âŒ ${event.data?.stepTitle || 'å·¥ä½œæµæ­¥éª¤å¤±è´¥'}`,
              workflowStatus: 'failed' as const,
              timestamp: new Date().toISOString()
            })
            break

          case 'workflow_complete':
            console.log('ğŸ‰ [å·¥ä½œæµ] å®Œæˆ:', event.data)
            chatHistory.addMessage({
              id: `workflow-${Date.now()}`,
              role: 'assistant' as const,
              type: 'workflow_step' as const,
              content: event.data?.message || 'ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ',
              workflowStatus: 'complete' as const,
              timestamp: new Date().toISOString()
            })
            break

          case 'content_update':
          case 'answer_chunk':
            if (!currentAIResponse.value.answer.visible) {
              currentAIResponse.value.answer.visible = true
              currentAIResponse.value.answer.streaming = true
              currentAIResponse.value.answer.content = ''
            }
            if (event.data?.chunk) {
              currentAIResponse.value.answer.content += event.data.chunk
            } else if (event.data?.content) {
              currentAIResponse.value.answer.content = event.data.content
            }
            break

          case 'answer_complete':
          case 'final_answer':
          case 'complete':
            currentAIResponse.value.answer.streaming = false
            if (event.data?.content) {
              currentAIResponse.value.answer.content = event.data.content
            }
            rightSidebarLoading.value = false
            sending.value = false
            isLoading.value = false

            // ğŸ”§ Bug #1ä¿®å¤: é˜²æ­¢é‡å¤ä¿å­˜æ¶ˆæ¯ï¼ˆåç«¯å‘é€å¤šæ¬¡completeäº‹ä»¶ï¼‰
            if (currentRequestSaved.value) {
              console.log('âš ï¸ [å»é‡æ£€æŸ¥] æ¶ˆæ¯å·²ä¿å­˜è¿‡ï¼Œè·³è¿‡æ­¤æ¬¡completeäº‹ä»¶')
              break
            }

            // ğŸ”§ ä¿®å¤ï¼šæ·»åŠ æœ€ç»ˆç­”æ¡ˆåˆ°èŠå¤©å†å²
            // å³ä½¿æ²¡æœ‰æ–‡æœ¬å†…å®¹ï¼Œä¹Ÿè¦ä¿å­˜AIå“åº”ï¼ˆå¯èƒ½åªæœ‰å·¥å…·è°ƒç”¨ç»“æœï¼‰
            const aiResponseContent = event.data?.content || currentAIResponse.value.answer.content || ''
            
            // å¦‚æœæœ‰å†…å®¹æˆ–è€…æœ‰å·¥å…·è°ƒç”¨ï¼Œéƒ½è¦ä¿å­˜æ¶ˆæ¯
            if (aiResponseContent || currentAIResponse.value.functionCalls.length > 0) {
              console.log('ğŸ’¾ [ä¿å­˜AIå“åº”] å†…å®¹é•¿åº¦:', aiResponseContent.length, 'å·¥å…·è°ƒç”¨æ•°:', currentAIResponse.value.functionCalls.length)
              
              // æ„å»ºæ¶ˆæ¯å†…å®¹ï¼šæ–‡æœ¬å†…å®¹ + å·¥å…·è°ƒç”¨ä¿¡æ¯
              let messageContent = aiResponseContent
              
              // å¦‚æœæœ‰å·¥å…·è°ƒç”¨ä½†æ²¡æœ‰æ–‡æœ¬å†…å®¹ï¼Œç”Ÿæˆå·¥å…·è°ƒç”¨æ‘˜è¦
              if (!messageContent && currentAIResponse.value.functionCalls.length > 0) {
                const toolNames = currentAIResponse.value.functionCalls
                  .map(fc => fc.name || 'æœªçŸ¥å·¥å…·')
                  .join(', ')
                messageContent = `âœ… å·²æ‰§è¡Œå·¥å…·: ${toolNames}`
              }
              
              // ğŸ”§ æå–ç»„ä»¶æ•°æ®ï¼ˆä»å·¥å…·è°ƒç”¨ç»“æœä¸­ï¼‰
              let componentData = null
              if (currentAIResponse.value.functionCalls.length > 0) {
                // æŸ¥æ‰¾render_componentçš„ç»“æœ
                const renderComponentCall = currentAIResponse.value.functionCalls.find(
                  fc => fc.name === 'render_component' && fc.status === 'completed'
                )
                if (renderComponentCall?.result?.result) {
                  componentData = renderComponentCall.result.result
                  console.log('ğŸ“¦ [ä¿å­˜AIå“åº”] æå–åˆ°ç»„ä»¶æ•°æ®:', componentData)
                }
              }
              
              chatHistory.addMessage({
                role: 'assistant',
                content: messageContent,
                // ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œç”¨äºåç»­æ¸²æŸ“
                toolCalls: currentAIResponse.value.functionCalls.length > 0 
                  ? currentAIResponse.value.functionCalls 
                  : undefined,
                // ä¿å­˜ç»„ä»¶æ•°æ®ï¼Œç”¨äºMessageItemæ¸²æŸ“
                componentData: componentData,
                // æ ‡è®°æ˜¯å¦æœ‰å¢å¼ºæ•°æ®
                hasEnhancedData: currentAIResponse.value.functionCalls.length > 0
              })
              
              // ğŸ”§ Bug #1ä¿®å¤: æ ‡è®°æ¶ˆæ¯å·²ä¿å­˜
              currentRequestSaved.value = true
              console.log('âœ… [ä¿å­˜AIå“åº”] æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©å†å²ï¼Œå·²æ ‡è®°ä¸ºå·²ä¿å­˜')
            } else {
              console.warn('âš ï¸ [ä¿å­˜AIå“åº”] æ²¡æœ‰å†…å®¹ä¹Ÿæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè·³è¿‡ä¿å­˜')
            }
            break

          case 'error':
            const errorMsg = event.message || 'ç»Ÿä¸€æ™ºèƒ½æœåŠ¡è°ƒç”¨å¤±è´¥'
            ElMessage.error(`ç»Ÿä¸€æ™ºèƒ½æœåŠ¡å¤±è´¥ï¼š${errorMsg}`)
            sending.value = false
            isLoading.value = false
            rightSidebarLoading.value = false
            break

          case 'progress':
            // ğŸ” æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡è¿›åº¦äº‹ä»¶
            if (isSearching.value) {
              console.log(`â¸ï¸ [äº‹ä»¶è¿‡æ»¤] æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡ progress äº‹ä»¶`)
              break
            }
            // æ™®é€šè¿›åº¦æ¶ˆæ¯å¤„ç†
            if (event.message) {
              console.log('ğŸ“‹ [è¿›åº¦]:', event.message)
            }
            break

          // ğŸ†• é»˜è®¤æƒ…å†µï¼šè®°å½•æœªå¤„ç†çš„äº‹ä»¶
          default:
            // ğŸ” æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡å…¶ä»–äº‹ä»¶
            if (isSearching.value && event.type && !event.type.startsWith('search_')) {
              console.log(`â¸ï¸ [äº‹ä»¶è¿‡æ»¤] æœç´¢è¿›è¡Œä¸­ï¼Œè·³è¿‡äº‹ä»¶: ${event.type}`)
              break
            }
            if (event.type && !event.type.startsWith('_')) {
              console.warn('âš ï¸ [æœªå¤„ç†äº‹ä»¶] äº‹ä»¶ç±»å‹:', event.type, 'äº‹ä»¶æ•°æ®:', event.data)
            }
            break
        }
      }
    )

    console.log('âœ… [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] è°ƒç”¨å®Œæˆ')
  } catch (error) {
    console.error('âŒ [ç»Ÿä¸€æ™ºèƒ½è·¯ç”±] è°ƒç”¨å¤±è´¥:', error)
    ElMessage.error('ç»Ÿä¸€æ™ºèƒ½æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œè¯·é‡è¯•')
    sending.value = false
    isLoading.value = false
    rightSidebarLoading.value = false
  }
}

// ğŸ›‘ å¤„ç†åœæ­¢å‘é€
const handleStopSending = () => {
  console.log('ğŸ›‘ [åœæ­¢å‘é€] ç”¨æˆ·ç‚¹å‡»åœæ­¢æŒ‰é’®')

  // ä¸­æ­¢SSEè¿æ¥ï¼ˆæ™®é€šèŠå¤©æ¨¡å¼ï¼‰
  if (messageHandling.abortCurrentRequest) {
    messageHandling.abortCurrentRequest()
    console.log('âœ… [åœæ­¢å‘é€] SSEè¿æ¥å·²ä¸­æ­¢')
  }

  // ä¸­æ­¢AIAssistantCoreçš„å·¥å…·è°ƒç”¨ï¼ˆä¼ ç»ŸAutoæ¨¡å¼ï¼‰
  if (coreRef.value && coreRef.value.abortToolCalling) {
    coreRef.value.abortToolCalling()
    console.log('âœ… [åœæ­¢å‘é€] å·¥å…·è°ƒç”¨å·²ä¸­æ­¢')
  }

  // TODO: æ·»åŠ ç»Ÿä¸€æ™ºèƒ½è·¯ç”±è°ƒç”¨çš„ä¸­æ­¢é€»è¾‘ï¼ˆéœ€è¦ä¿®æ”¹APIä»¥æ”¯æŒä¸­æ­¢ï¼‰

  // é‡ç½®æ‰€æœ‰çŠ¶æ€
  sending.value = false
  isLoading.value = false
  rightSidebarLoading.value = false
  showThinkingSubtitle.value = false
  thinkingSubtitle.value = ''

  console.log('âœ… [åœæ­¢å‘é€] AIå“åº”å·²åœæ­¢ï¼Œæ‰€æœ‰çŠ¶æ€å·²é‡ç½®')
}

const handleSuggestion = (text: string) => {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸ¯ [AIAssistant] handleSuggestion å‡½æ•°è¢«è°ƒç”¨!')
  console.log('ğŸ” [å»ºè®®ç‚¹å‡»] æ”¶åˆ°å»ºè®®æ–‡æœ¬:', text)
  console.log('ğŸ” [å»ºè®®ç‚¹å‡»] å½“å‰çŠ¶æ€:', {
    inputMessage: inputMessage.value,
    sending: sending.value,
    autoExecute: autoExecute.value,
    conversationId: conversationId.value,
    callStack: new Error().stack?.split('\n').slice(0, 5).join('\n')
  })

  // ğŸ”§ ç‰¹æ®Šå¤„ç†ï¼šæ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒçš„å»ºè®®
  if (text.includes('æ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒ')) {
    console.log('ğŸ” [å»ºè®®ç‚¹å‡»] æ£€æµ‹åˆ°æ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒçš„å»ºè®®ï¼Œå‡†å¤‡å¯¼èˆª...')
    // æå–å®é™…è¦è¾“å…¥çš„æ–‡æœ¬ï¼ˆå»æ‰"æ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒå¹¶è¾“å…¥"éƒ¨åˆ†ï¼‰
    const actualText = text.replace('æ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒå¹¶è¾“å…¥', '').trim()
    console.log('ğŸ” [å»ºè®®ç‚¹å‡»] å®é™…è¾“å…¥æ–‡æœ¬:', actualText)

    // å¯¼èˆªåˆ°æ‹›ç”Ÿä¸­å¿ƒï¼ˆä½¿ç”¨æ­£ç¡®çš„è·¯ç”±è·¯å¾„ï¼‰
    router.push('/teacher-center/enrollment').then(() => {
      console.log('âœ… [å»ºè®®ç‚¹å‡»] å·²å¯¼èˆªåˆ°æ‹›ç”Ÿä¸­å¿ƒ')
      // å¯¼èˆªå®Œæˆåï¼Œè®¾ç½®è¾“å…¥æ¡†æ–‡æœ¬å¹¶å‘é€æ¶ˆæ¯
      setTimeout(() => {
        inputMessage.value = actualText
        nextTick(() => {
          console.log('ğŸ” [å»ºè®®ç‚¹å‡»] åœ¨æ‹›ç”Ÿä¸­å¿ƒå‘é€æ¶ˆæ¯:', {
            finalInputMessage: inputMessage.value
          })
          handleSendMessage()
        })
      }, 500) // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    }).catch((err) => {
      console.error('âŒ [å»ºè®®ç‚¹å‡»] å¯¼èˆªå¤±è´¥:', err)
      // å¦‚æœå¯¼èˆªå¤±è´¥ï¼Œä»ç„¶å°è¯•å‘é€æ¶ˆæ¯
      inputMessage.value = text
      nextTick(() => {
        handleSendMessage()
      })
    })
  } else {
    // æ™®é€šå»ºè®®å¤„ç†
    inputMessage.value = text

    nextTick(() => {
      console.log('ğŸ” [å»ºè®®ç‚¹å‡»] å‡†å¤‡å‘é€æ¶ˆæ¯:', {
        finalInputMessage: inputMessage.value
      })
      handleSendMessage()
    })
  }
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
}

const handleToggleVoiceInput = () => {
  if (isListening.value) {
    speech.stopListening()
  } else {
    speech.startListening()
  }
}

const handleToggleVoiceOutput = () => {
  if (isSpeaking.value) {
    speech.stopSpeaking()
  } else {
    // å®ç°è¯­éŸ³è¾“å‡ºé€»è¾‘
  }
}

const handleShowQuickQuery = () => {
  quickQueryGroupsVisible.value = true
}

const handleToggleThinking = () => {
  toggleThinking()
}

const handleQuickQuerySelect = (query: any) => {
  console.log('ğŸ¯ [å¿«æ·æŸ¥è¯¢é€‰æ‹©] æ¥æ”¶åˆ°æŸ¥è¯¢:', query)

  // å¤„ç†æŸ¥è¯¢å¯¹è±¡æˆ–å­—ç¬¦ä¸²
  const queryText = typeof query === 'string' ? query : query.keyword

  console.log('ğŸ“ [å¿«æ·æŸ¥è¯¢é€‰æ‹©] æŸ¥è¯¢æ–‡æœ¬:', queryText)

  inputMessage.value = queryText
  quickQueryGroupsVisible.value = false

  nextTick(() => {
    console.log('ğŸš€ [å¿«æ·æŸ¥è¯¢é€‰æ‹©] å‡†å¤‡å‘é€æ¶ˆæ¯:', queryText)
    handleSendMessage()
  })
}

// ğŸ”§ ç§»é™¤ï¼šautoExecute å·²åºŸå¼ƒï¼Œç°åœ¨ç”±å¤§æ¨¡å‹è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦è°ƒç”¨å·¥å…·



const handleToggleVoice = () => {
  console.log('ğŸ” [è¯­éŸ³åˆ‡æ¢] åˆ‡æ¢è¯­éŸ³åŠŸèƒ½')
  handleToggleVoiceInput()
}

const handleToggleListening = () => {
  console.log('ğŸ” [ç›‘å¬åˆ‡æ¢] åˆ‡æ¢è¯­éŸ³ç›‘å¬')
  handleToggleVoiceInput()
}

const handleStopSpeaking = () => {
  console.log('ğŸ” [åœæ­¢è¯­éŸ³] åœæ­¢è¯­éŸ³æ’­æ”¾')
  if (isSpeaking.value) {
    speech.stopSpeaking()
  }
}

const handleUploadFile = (event: Event) => {
  console.log('ğŸ” [æ–‡ä»¶ä¸Šä¼ ] å¤„ç†æ–‡ä»¶ä¸Šä¼ äº‹ä»¶')
  // å¯ä»¥åœ¨è¿™é‡Œå®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘
  ElMessage.info('æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...')
}

const handleUploadImage = (event: Event) => {
  console.log('ğŸ” [å›¾ç‰‡ä¸Šä¼ ] å¤„ç†å›¾ç‰‡ä¸Šä¼ äº‹ä»¶')
  // å¯ä»¥åœ¨è¿™é‡Œå®ç°å›¾ç‰‡ä¸Šä¼ é€»è¾‘
  ElMessage.info('å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å¼€å‘ä¸­...')
}

const handleToggleFontSize = () => {
  console.log('ğŸ” [å­—ä½“å¤§å°åˆ‡æ¢] åˆ‡æ¢å­—ä½“å¤§å°')
  // å®ç°å­—ä½“å¤§å°åˆ‡æ¢é€»è¾‘
  messageFontSize.value = messageFontSize.value === 14 ? 16 : (messageFontSize.value === 16 ? 18 : 14)
  ElMessage.success(`å­—ä½“å¤§å°: ${messageFontSize.value}px`)
}

const handleToggleQuickQueryGroups = () => {
  console.log('ğŸ” [å¿«æ·æŸ¥è¯¢ç»„åˆ‡æ¢] åˆ‡æ¢å¿«æ·æŸ¥è¯¢ç»„æ˜¾ç¤º')
  quickQueryGroupsVisible.value = !quickQueryGroupsVisible.value
}

// ==================== åŠ è½½çŠ¶æ€äº‹ä»¶å¤„ç† ====================
/**
 * å¤„ç†åŠ è½½å®Œæˆäº‹ä»¶ - å…³é—­åŠ è½½çŠ¶æ€
 */
const handleLoadingComplete = () => {
  console.log('âœ… [åŠ è½½å®Œæˆ] å…³é—­åŠ è½½çŠ¶æ€')
  isLoading.value = false
  rightSidebarLoading.value = false
}

// ==================== ç¼ºå¤±å­—æ®µå¯¹è¯æ¡†äº‹ä»¶å¤„ç† ====================
/**
 * å¤„ç†ç¼ºå¤±å­—æ®µæ£€æµ‹äº‹ä»¶
 */
const handleMissingFieldsDetected = (data: any) => {
  console.log('âš ï¸ [ç¼ºå¤±å­—æ®µ] æ£€æµ‹åˆ°ç¼ºå¤±å­—æ®µäº‹ä»¶:', data)

  // è®¾ç½®ç¼ºå¤±å­—æ®µæ•°æ®
  missingFieldsData.value = data

  // æ˜¾ç¤ºç¼ºå¤±å­—æ®µå¯¹è¯æ¡†
  missingFieldsDialogVisible.value = true

  console.log('âœ… [ç¼ºå¤±å­—æ®µ] å¯¹è¯æ¡†å·²æ˜¾ç¤º')
}

/**
 * å¤„ç†ç¼ºå¤±å­—æ®µè¡¥å……æäº¤
 */
const handleMissingFieldsSubmit = async (data: { table_name: string; data: any }) => {
  console.log('âœ… [ç¼ºå¤±å­—æ®µ] æ¥æ”¶åˆ°è¡¥å……æ•°æ®:', data)

  try {
    // å…³é—­å¯¹è¯æ¡†
    missingFieldsDialogVisible.value = false

    // é‡æ–°è°ƒç”¨åˆ›å»ºå·¥å…·ï¼Œè¿™æ¬¡å¸¦ä¸Šå®Œæ•´æ•°æ®
    const message = `åˆ›å»º${data.table_name}è®°å½•ï¼Œæ•°æ®ï¼š${JSON.stringify(data.data)}`

    // å‘é€æ¶ˆæ¯
    await handleSendMessage(message)

    ElMessage.success('æ•°æ®è¡¥å……æˆåŠŸï¼Œæ­£åœ¨åˆ›å»ºè®°å½•')
  } catch (error) {
    console.error('âŒ [ç¼ºå¤±å­—æ®µ] æäº¤å¤±è´¥:', error)
    ElMessage.error('æ•°æ®æäº¤å¤±è´¥')
  }
}

// ==================== HTMLé¢„è§ˆäº‹ä»¶å¤„ç† ====================
/**
 * æ˜¾ç¤ºHTMLé¢„è§ˆ
 */
const handleShowHtmlPreview = (data: { code: string; title: string; contentType: string }) => {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸ¨ [HTMLé¢„è§ˆ] æ¥æ”¶åˆ°é¢„è§ˆæ•°æ®')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ğŸ“Š [HTMLé¢„è§ˆ] æ•°æ®è¯¦æƒ…:', {
    codeLength: data.code?.length || 0,
    title: data.title,
    contentType: data.contentType,
    codePreview: data.code?.substring(0, 100) || ''
  })

  // è®¾ç½®HTMLé¢„è§ˆæ•°æ®
  htmlPreviewData.value = {
    code: data.code,
    title: data.title,
    contentType: data.contentType
  }

  // æ˜¾ç¤ºHTMLé¢„è§ˆ
  htmlPreviewVisible.value = true

  // éšè—ä¾§è¾¹æ ï¼Œå…¨å±æ˜¾ç¤ºé¢„è§ˆ
  rightSidebarVisible.value = false
  leftSidebarCollapsed.value = true

  console.log('âœ… [HTMLé¢„è§ˆ] é¢„è§ˆçª—å£å·²æ‰“å¼€')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
}

/**
 * å…³é—­HTMLé¢„è§ˆ
 */
const handleHtmlPreviewClose = () => {
  console.log('ğŸ¨ [HTMLé¢„è§ˆ] å…³é—­é¢„è§ˆ')
  htmlPreviewVisible.value = false
  htmlPreviewData.value = null

  // æ¢å¤ä¾§è¾¹æ çŠ¶æ€
  rightSidebarVisible.value = true
  leftSidebarCollapsed.value = false
}

// ==================== é”®ç›˜äº‹ä»¶å¤„ç† ====================
const handleKeydown = (event: KeyboardEvent) => {
  if (event.key === 'Escape' && props.visible) {
    event.preventDefault()
    handleToggleFullscreen()
  }
}

// ==================== ç”Ÿå‘½å‘¨æœŸ ====================
onMounted(async () => {
  console.log('é‡æ„åçš„AIåŠ©æ‰‹ç»„ä»¶å·²æŒ‚è½½')
  console.log('Props:', props)
  console.log('isFullscreen:', props.isFullscreen)
  console.log('ğŸ”Œ [æŒä¹…åŒ–è¿æ¥] AIåŠ©æ‰‹é¡µé¢åŠ è½½ï¼Œå»ºç«‹æŒä¹…è¿æ¥')

  // ğŸ”§ æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬è°ƒè¯•
  console.log('ğŸ” [äº‹ä»¶è°ƒè¯•] ç»„ä»¶æŒ‚è½½ï¼ŒhandleSuggestionå‡½æ•°æ£€æŸ¥:', {
    handleSuggestion: typeof handleSuggestion,
    handleSuggestionExists: !!handleSuggestion
  })

  // ğŸ¯ é¡µé¢åŠ è½½æ—¶æ›´æ–°æ´»åŠ¨æ—¶é—´ï¼Œé˜²æ­¢è¿æ¥ç«‹å³æ–­å¼€
  updateActivity()

  // ğŸ†• åŠ è½½ç”¨æˆ·åå¥½ï¼ˆä½¿ç”¨composableï¼‰
  loadPreferences()

  // ğŸ¯ æ ‡è®°åå¥½ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘å¬å˜åŒ–
  markInitialized()

  // ï¿½ åŠ è½½ä¸“å®¶æ•°æ®ï¼ˆä½¿ç”¨composableï¼‰
  loadExpertsFromStorage()

  // ğŸ¯ å…³é”®ä¿®å¤ï¼šåˆå§‹åŒ–ä¼šè¯IDå¹¶åŒæ­¥åˆ°aiState
  console.log('ğŸ”§ [ä¼šè¯åˆå§‹åŒ–] å¼€å§‹åˆå§‹åŒ–ä¼šè¯ID')
  try {
    const convId = await messageHandling.ensureConversation()
    console.log('âœ… [ä¼šè¯åˆå§‹åŒ–] ä¼šè¯IDåˆå§‹åŒ–æˆåŠŸ:', convId)

    // ğŸ¯ åŒæ­¥ä¼šè¯IDåˆ°aiStateï¼ˆç¡®ä¿å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨æ­£ç¡®çš„ä¼šè¯IDï¼‰
    conversationId.value = convId
    console.log('âœ… [ä¼šè¯åŒæ­¥] ä¼šè¯IDå·²åŒæ­¥åˆ°aiState.conversationId:', conversationId.value)
  } catch (error) {
    console.error('âŒ [ä¼šè¯åˆå§‹åŒ–] åˆå§‹åŒ–å¤±è´¥:', error)
    // å³ä½¿å¤±è´¥ä¹Ÿè®¾ç½®ä¸€ä¸ªä¸´æ—¶ä¼šè¯ID
    const tempId = `temp_${Date.now()}`
    conversationId.value = tempId
    console.log('âš ï¸ [ä¼šè¯åˆå§‹åŒ–] ä½¿ç”¨ä¸´æ—¶ä¼šè¯ID:', tempId)
  }

  // ï¿½ å·²ç§»é™¤WebSocketç›¸å…³çš„å›è°ƒè®¾ç½®
  // ç°åœ¨ä½¿ç”¨HTTP APIæ¨¡å¼ï¼Œä¸éœ€è¦WebSocketè¿æ¥


  // ğŸ†• å¦‚æœæ˜¯å…¨å±æ¨¡å¼ï¼Œæ‰§è¡Œå…¨å±åˆå§‹åŒ–ï¼ˆä½¿ç”¨composableï¼‰
  if (props.isFullscreen) {
    fullscreenMode.setupFullscreenMode()
  }

  // æ·»åŠ ESCé”®ç›‘å¬
  document.addEventListener('keydown', handleKeydown)
})

onUnmounted(() => {
  // ğŸ†• å¦‚æœæ˜¯å…¨å±æ¨¡å¼ï¼Œæ¸…ç†å…¨å±åˆå§‹åŒ–ï¼ˆä½¿ç”¨composableï¼‰
  if (props.isFullscreen) {
    fullscreenMode.cleanupFullscreenMode()
  }

  // ç§»é™¤ESCé”®ç›‘å¬
  document.removeEventListener('keydown', handleKeydown)
})

// ç›‘å¬visibleå˜åŒ–
watch(() => props.visible, (newVal) => {
  console.log('ğŸ” visible changed:', newVal)
  if (newVal) {
    console.log('ğŸ” visibleå˜ä¸ºtrueæ—¶çš„propså€¼:')
    console.log('  - fullscreenState:', fullscreenState)
    console.log('  - conversations:', conversations)
    console.log('  - toolCalls:', toolCalls)
    console.log('  - renderedComponents:', renderedComponents)
    console.log('  - activeStepQueues:', activeStepQueues)
  }
}, { immediate: true })

// ğŸ†• ç›‘å¬AIAssistantCoreä¸­çš„currentThinkingMessageï¼ŒåŒæ­¥åˆ°rightSidebarThinking
watch(() => coreRef.value?.currentThinkingMessage, (newVal) => {
  console.log('ğŸ” [AIAssistant] watch currentThinkingMessage:', newVal?.substring?.(0, 50))
  if (newVal) {
    console.log('âœ… [AIAssistant] æ›´æ–°rightSidebarThinking')
    rightSidebarThinking.value = newVal
  }
}, { immediate: true, deep: true })

// ==================== æš´éœ²ç»™çˆ¶ç»„ä»¶ ====================
defineExpose({
  // çŠ¶æ€
  currentAIResponse,
  toolCalls,
  conversations,

  // æ–¹æ³•
  handleSendMessage,
  handleToggleFullscreen
})
</script>

<style lang="scss" scoped>
// ğŸ¨ AIåŠ©æ‰‹åŒ…è£…å™¨ - ç»ç’ƒæ€æ•ˆæœå®¹å™¨
.ai-assistant-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  // ğŸ¨ æ·»åŠ èƒŒæ™¯æ¸å˜ï¼Œä¸ºç»ç’ƒæ€æ•ˆæœæä¾›åŸºç¡€
  background: linear-gradient(135deg, #f0f2ff 0%, #f8fafc 100%);

  // ğŸ¨ èƒŒæ™¯è£…é¥° - å¢å¼ºç»ç’ƒæ€æ•ˆæœçš„å±‚æ¬¡æ„Ÿ
  &::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
      radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  // ğŸ¨ ç¡®ä¿å­å…ƒç´ åœ¨è£…é¥°å±‚ä¹‹ä¸Š
  > * {
    position: relative;
    z-index: 1;
  }
}

/* ä½¿ç”¨å…¨å±€è®¾è®¡ä»¤ç‰Œç³»ç»Ÿ */
@import '@/styles/design-tokens.scss';
@import '@/styles/mixins/responsive.scss';
@import '@/styles/mixins/card-mixins.scss';
</style>
