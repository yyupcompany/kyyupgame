<template>
  <div class="app-container cls-final-fix-2025 cls-ultimate-fix-2025 cls-performance-fix">
    <!-- 侧边栏 -->
    <Sidebar 
      :collapsed="sidebarCollapsed"
      :is-mobile="isMobile"
      :current-theme="currentTheme"
      @toggle="toggleSidebar"
      @menu-click="handleSidebarMenuClick"
      @theme-change="changeTheme"
    />

    <!-- 主内容区域 -->
    <div class="main-container" :class="{ 'main-expanded': sidebarCollapsed }">
      <!-- 顶部导航栏 -->
      <div class="navbar">
        <div class="navbar-left">
          <el-breadcrumb separator="/">
            <el-breadcrumb-item :to="{ path: '/dashboard' }">首页</el-breadcrumb-item>
            <el-breadcrumb-item>{{ currentPageTitle }}</el-breadcrumb-item>
          </el-breadcrumb>
        </div>
        
        <div class="navbar-right">
          <!-- 全屏按钮 -->
          <button class="header-action-btn" @click="toggleFullscreen" title="全屏切换">
            <el-icon>
              <component :is="isFullscreen ? 'Aim' : 'FullScreen'" />
            </el-icon>
          </button>
          
          <!-- 主题切换按钮 -->
          <div class="theme-selector">
            <button class="header-action-btn" @click="toggleThemeDropdown" title="主题切换">
              <el-icon><Sunny /></el-icon>
            </button>
            
            <!-- 主题下拉菜单 -->
            <div v-if="showThemeDropdown" class="theme-dropdown">
              <div 
                v-for="theme in themes" 
                :key="theme.value"
                class="theme-option"
                :class="{ active: currentTheme === theme.value }"
                @click="changeTheme(theme.value)"
              >
                <div class="theme-color" :style="{ backgroundColor: theme.color }"></div>
                <span class="theme-name">{{ theme.name }}</span>
              </div>
            </div>
          </div>
          
          <div class="user-info cls-performance-fix">
            <div class="user-avatar">
              <span v-if="userDisplayName" class="user-avatar-text">{{ userDisplayName.charAt(0).toUpperCase() }}</span>
              <span v-else class="user-avatar-text skeleton">U</span>
            </div>
            <span class="user-name" :class="{ 'skeleton': !userDisplayName }">{{ userDisplayName || '加载中...' }}</span>
            <span class="user-role" :class="{ 'skeleton': !userRoleDisplay }">({{ userRoleDisplay || '角色加载中' }})</span>
          </div>
          
          <el-button type="primary" size="small" @click="handleLogout">
            <el-icon><SwitchButton /></el-icon>
            退出登录
          </el-button>
        </div>
      </div>

      <!-- 页面内容 -->
      <div class="page-content">
        <router-view />
      </div>
    </div>

    <!-- 移动端遮罩层 -->
    <div 
      v-if="isMobile && !sidebarCollapsed" 
      class="mobile-overlay"
      @click="sidebarCollapsed = true"
    ></div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useUserStore } from '../stores/user'
import { PERMISSIONS, ROLES } from '../utils/permission'
import { 
  SwitchButton, Sunny, FullScreen, Aim
} from '@element-plus/icons-vue'
import Sidebar from './components/Sidebar.vue'

// 路由和状态
const router = useRouter()
const route = useRoute()
const userStore = useUserStore()

// 响应式状态
const sidebarCollapsed = ref(false)
const windowWidth = ref(window.innerWidth)
const isFullscreen = ref(false)
const showThemeDropdown = ref(false)
const currentTheme = ref('glass-light')

// 主题配置 - 与preview.html保持一致的7个主题
const themes = ref([
  { name: '浅色玻璃', value: 'glass-light', color: '#667eea' },
  { name: '深色玻璃', value: 'glass-dark', color: '#0f0f23' },
  { name: '霓虹玻璃', value: 'neon-glass', color: '#ff00ff' },
  { name: '渐变玻璃', value: 'gradient-glass', color: '#ff6b6b' },
  { name: '明亮夏日', value: 'bright-summer', color: '#ffeaa7' },
  { name: '清新自然', value: 'bright-nature', color: '#a8e6cf' },
  { name: '简约明亮', value: 'bright-minimalist', color: '#f8fafc' }
])

// 计算属性
const isMobile = computed(() => windowWidth.value < 768)

const currentPageTitle = computed(() => {
  const pathMap: Record<string, string> = {
    // 工作台
    '/dashboard': '数据概览',
    '/dashboard/schedule': '日程管理',
    '/dashboard/important-notices': '消息通知',
    '/dashboard/campus-overview': '园区概览',
    '/dashboard/data-statistics': '数据统计',
    
    // 招生管理
    '/enrollment-plan': '招生计划',
    '/enrollment': '招生活动',
    '/enrollment-plan/statistics': '招生统计',
    '/enrollment-plan/quota-manage': '名额管理',
    
    // 客户管理
    '/customer': '客户列表',
    '/principal/customer-pool': '客户池',
    
    // 学生管理
    '/class': '班级管理',
    '/application': '入园申请',
    
    // 活动管理
    '/activity': '活动列表',
    '/activity/create': '创建活动',
    '/principal/activities': '园长活动',
    
    // 家长服务
    '/parent': '家长列表',
    '/parent/children': '孩子列表',
    
    // 教师管理
    '/teacher': '教师列表',
    
    // 营销工具
    '/principal/poster-editor': '海报编辑',
    '/principal/poster-generator': '海报生成器',
    '/chat': '在线咨询',
    '/ai': 'AI助手',
    
    // 数据分析
    '/statistics': '统计报表',
    '/principal/performance': '绩效管理',
    '/principal/marketing-analysis': '经营分析',
    '/principal/dashboard': '园长仪表盘',
    
    // 系统管理
    '/system/users': '用户管理',
    '/system/roles': '角色管理',
    '/system/permissions': '权限管理',
    '/system/logs': '系统日志',
    '/system/backup': '数据备份',
    '/system/settings': '系统配置',
    '/system/ai-model-config': 'AI模型配置'
  }
  return pathMap[route.path] || '未知页面'
})

const userDisplayName = computed(() => {
  return userStore.userInfo?.username || '用户'
})

const userRoleDisplay = computed(() => {
  const roleMap: Record<string, string> = {
    'admin': '系统管理员',
    'super_admin': '超级管理员',
    'teacher': '教师',
    'principal': '园长',
    'parent': '家长',
    'user': '普通用户'
  }
  
  // 优先使用 role 字段，如果不存在则使用 roles 数组的第一个元素的 code
  const userRole = userStore.userInfo?.role || (userStore.userInfo?.roles && userStore.userInfo.roles[0]?.code) || 'user'
  return roleMap[userRole] || roleMap['user']
})

// 方法
const toggleSidebar = () => {
  sidebarCollapsed.value = !sidebarCollapsed.value
  // 持久化侧边栏状态
  localStorage.setItem('sidebarCollapsed', String(sidebarCollapsed.value))
}

// 处理侧边栏菜单点击
const handleSidebarMenuClick = () => {
  // 移动端点击菜单后自动收起侧边栏
  if (isMobile.value) {
    sidebarCollapsed.value = true
  }
}

const handleLogout = async () => {
  try {
    // 清除localStorage中的认证信息
    localStorage.removeItem('token')
    localStorage.removeItem('kindergarten_token')
    localStorage.removeItem('auth_token')
    localStorage.removeItem('refreshToken')
    localStorage.removeItem('refresh_token')
    localStorage.removeItem('userInfo')
    
    // 重置用户store
    userStore.clearUserInfo()
    
    // 重置侧边栏状态
    sidebarCollapsed.value = false
    localStorage.removeItem('sidebarCollapsed')
    
    // 跳转到登录页
    await router.push('/login')
  } catch (error) {
    console.error('退出登录失败:', error)
  }
}

// 全屏功能
const toggleFullscreen = async () => {
  try {
    if (!document.fullscreenElement) {
      await document.documentElement.requestFullscreen()
      isFullscreen.value = true
    } else {
      await document.exitFullscreen()
      isFullscreen.value = false
    }
  } catch (error) {
    console.error('全屏切换失败:', error)
  }
}

// 监听全屏状态变化
const handleFullscreenChange = () => {
  isFullscreen.value = !!document.fullscreenElement
}

// 主题切换功能
const toggleThemeDropdown = () => {
  showThemeDropdown.value = !showThemeDropdown.value
}

const changeTheme = (theme: string) => {
  currentTheme.value = theme
  showThemeDropdown.value = false
  
  console.log('MainLayout switching theme to:', theme)
  
  // 移除所有主题类
  document.documentElement.classList.remove('theme-light', 'theme-dark', 'theme-blue', 'theme-purple', 'theme-green')
  
  // 设置data-theme属性，与preview.html保持一致
  document.documentElement.setAttribute('data-theme', theme)
  
  // 添加调试日志
  console.log('Theme switched to:', theme)
  console.log('Current data-theme:', document.documentElement.getAttribute('data-theme'))
  
  // 持久化主题设置
  localStorage.setItem('theme', theme)
}

// 点击外部关闭主题下拉菜单
const handleClickOutside = (event: Event) => {
  const target = event.target as Element
  if (!target.closest('.theme-selector')) {
    showThemeDropdown.value = false
  }
}

const handleResize = () => {
  windowWidth.value = window.innerWidth
  
  // 移动端自动收起侧边栏
  if (isMobile.value) {
    sidebarCollapsed.value = true
  }
}

// 生命周期
onMounted(() => {
  // 确保用户信息已加载
  if (!userStore.userInfo) {
    userStore.tryRestoreFromLocalStorage()
  }
  
  // 恢复侧边栏状态
  const savedSidebarState = localStorage.getItem('sidebarCollapsed')
  if (savedSidebarState !== null) {
    sidebarCollapsed.value = savedSidebarState === 'true'
  }
  
  // 恢复主题设置
  const savedTheme = localStorage.getItem('theme')
  if (savedTheme && themes.value.some(t => t.value === savedTheme)) {
    changeTheme(savedTheme)
  } else {
    // 默认使用浅色玻璃主题
    changeTheme('glass-light')
  }
  
  // 添加调试日志
  console.log('MainLayout mounted')
  console.log('Available themes:', themes.value.length)
  console.log('Themes:', themes.value.map(t => t.name))
  console.log('Current theme:', currentTheme.value)
  
  // 初始化全屏状态
  isFullscreen.value = !!document.fullscreenElement
  
  // 监听窗口大小变化
  window.addEventListener('resize', handleResize)
  
  // 监听全屏状态变化
  document.addEventListener('fullscreenchange', handleFullscreenChange)
  
  // 监听点击外部关闭下拉菜单
  document.addEventListener('click', handleClickOutside)
  
  // 清理函数
  const cleanup = () => {
    window.removeEventListener('resize', handleResize)
    document.removeEventListener('fullscreenchange', handleFullscreenChange)
    document.removeEventListener('click', handleClickOutside)
  }
  
  // 在组件卸载时清理事件监听器
  return cleanup
})
</script>

<style lang="scss" scoped>
@import '@/styles/index.scss';

.app-container {
  display: flex;
  height: 100vh;
  background-color: var(--bg-secondary);
}

/* 侧边栏组件样式调整 */

/* 主内容区域 */
.main-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* 顶部导航栏 */
.navbar {
  height: 60px;
  background-color: var(--bg-card);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.06);
}

.navbar-left {
  flex: 1;
}

.navbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-avatar {
  width: 32px !important;
  height: 32px !important;
  min-width: 32px !important;
  min-height: 32px !important;
  max-width: 32px !important;
  max-height: 32px !important;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  contain: layout style !important;
  transform: translateZ(0) !important;
  backface-visibility: hidden !important;
  
  .user-avatar-text {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-height: 20px !important;
    
    &.skeleton {
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.1) 25%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0.1) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      color: transparent;
    }
  }
}

.user-name {
  font-size: 14px;
  color: var(--text-primary);
  font-weight: 500;
  min-width: 60px !important;
  min-height: 20px !important;
  display: inline-block !important;
  contain: layout style !important;
  
  &.skeleton {
    background: linear-gradient(90deg, 
      var(--bg-secondary) 25%, 
      var(--bg-tertiary) 50%, 
      var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    color: transparent;
    border-radius: 4px;
  }
}

.user-role {
  font-size: 12px;
  color: var(--text-secondary);
  min-width: 80px !important;
  min-height: 16px !important;
  display: inline-block !important;
  contain: layout style !important;
  
  &.skeleton {
    background: linear-gradient(90deg, 
      var(--bg-secondary) 25%, 
      var(--bg-tertiary) 50%, 
      var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    color: transparent;
    border-radius: 4px;
  }
}

/* 页面内容 */
.page-content {
  flex: 1;
  overflow-y: auto;
  background-color: var(--bg-secondary);
}

/* 主题切换和功能按钮样式 */
.theme-selector {
  position: relative;
}

.header-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 6px;
  background-color: var(--bg-tertiary);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.3s;
  
  &:hover {
    background-color: var(--bg-hover);
    color: var(--text-primary);
  }
  
  &:active {
    transform: scale(0.95);
  }
}

.theme-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background-color: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 8px;
  min-width: 160px;
  z-index: 1000;
}

.theme-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  color: var(--text-primary);
  
  &:hover {
    background-color: var(--bg-hover);
  }
  
  &.active {
    background-color: var(--primary-color);
    color: white;
  }
}

.theme-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--border-color);
}

/* 移动端样式 */
.mobile-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 999;
}

/* 响应式调整 */
@media screen and (max-width: 768px) {
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 1000;
    transform: translateX(-100%);
    
    &:not(.sidebar-collapsed) {
      transform: translateX(0);
    }
  }
  
  .main-container {
    margin-left: 0;
  }
  
  .navbar {
    padding: 0 16px;
  }
  
  .navbar-right {
    gap: 8px;
  }
  
  .user-name,
  .user-role {
    display: none;
  }
  
  .logo-icon {
    width: 36px;
    height: 36px;
    
    .logo-image {
      width: 100%;
      height: 100%;
    }
  }
}

@media screen and (max-width: 480px) {
  .logo-icon {
    width: 32px;
    height: 32px;
  }
  
  .logo-text {
    font-size: 14px;
  }
}

/* CLS优化动画 */
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
</style>
