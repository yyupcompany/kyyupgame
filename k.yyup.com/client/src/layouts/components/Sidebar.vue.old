<template>
  <div 
    class="sidebar" 
    :class="{ 'sidebar-collapsed': collapsed }"
  >
    <!-- LogoåŒºåŸŸ -->
    <div class="sidebar-logo">
      <div class="logo-content">
        <div class="logo-icon cls-performance-fix">
          <img 
            src="@/assets/logo.png" 
            alt="å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ" 
            class="logo-image"
            width="40"
            height="40"
            loading="eager"
            @error="handleImageError"
            style="width: 40px !important; height: 40px !important; object-fit: cover !important;"
          />
        </div>
        <div class="logo-text" v-show="!collapsed">å¹¼å„¿å›­ç®¡ç†</div>
      </div>
    </div>

    <!-- å¯¼èˆªèœå• -->
    <div class="sidebar-menu-container cls-final-fix-2025">
      <el-menu
        :default-active="$route.path"
        :collapse="collapsed"
        :unique-opened="true"
        router
        class="sidebar-menu cls-menu-static-stable"
      >
      <!-- å·¥ä½œå° -->
      <el-sub-menu index="dashboard" class="cls-menu-always-visible cls-menu-absolute-stable">
        <template #title>
          <el-icon><House /></el-icon>
          <span>å·¥ä½œå°</span>
        </template>
        <el-menu-item index="/dashboard">æ•°æ®æ¦‚è§ˆ</el-menu-item>
        <el-menu-item index="/dashboard/schedule">æ—¥ç¨‹ç®¡ç†</el-menu-item>
        <el-menu-item index="/dashboard/important-notices">æ¶ˆæ¯é€šçŸ¥</el-menu-item>
        <el-menu-item index="/dashboard/campus-overview">å›­åŒºæ¦‚è§ˆ</el-menu-item>
        <el-menu-item index="/dashboard/data-statistics">æ•°æ®ç»Ÿè®¡</el-menu-item>
      </el-sub-menu>

      <!-- æ‹›ç”Ÿç®¡ç† -->
      <el-sub-menu index="enrollment" class="cls-menu-always-visible cls-menu-absolute-stable">
        <template #title>
          <el-icon><UserFilled /></el-icon>
          <span>æ‹›ç”Ÿç®¡ç†</span>
        </template>
        <el-menu-item index="/enrollment-plan">æ‹›ç”Ÿè®¡åˆ’</el-menu-item>
        <el-menu-item index="/enrollment">æ‹›ç”Ÿæ´»åŠ¨</el-menu-item>
        <el-menu-item index="/enrollment-plan/statistics">æ‹›ç”Ÿç»Ÿè®¡</el-menu-item>
        <el-menu-item index="/enrollment-plan/quota-manage">åé¢ç®¡ç†</el-menu-item>
      </el-sub-menu>

      <!-- å®¢æˆ·ç®¡ç† -->
      <el-sub-menu index="customer" class="cls-menu-always-visible cls-menu-absolute-stable">
        <template #title>
          <el-icon><User /></el-icon>
          <span>å®¢æˆ·ç®¡ç†</span>
        </template>
        <el-menu-item index="/customer">å®¢æˆ·åˆ—è¡¨</el-menu-item>
        <el-menu-item index="/principal/customer-pool">å®¢æˆ·æ± </el-menu-item>
      </el-sub-menu>

      <!-- å­¦ç”Ÿç®¡ç† -->
      <el-sub-menu index="student">
        <template #title>
          <el-icon><Avatar /></el-icon>
          <span>å­¦ç”Ÿç®¡ç†</span>
        </template>
        <el-menu-item index="/class">ç­çº§ç®¡ç†</el-menu-item>
        <el-menu-item index="/application">å…¥å›­ç”³è¯·</el-menu-item>
      </el-sub-menu>

      <!-- æ´»åŠ¨ç®¡ç† -->
      <el-sub-menu index="activity">
        <template #title>
          <el-icon><Calendar /></el-icon>
          <span>æ´»åŠ¨ç®¡ç†</span>
        </template>
        <el-menu-item index="/activity">æ´»åŠ¨åˆ—è¡¨</el-menu-item>
        <el-menu-item index="/activity/create">åˆ›å»ºæ´»åŠ¨</el-menu-item>
        <el-menu-item index="/principal/activities">å›­é•¿æ´»åŠ¨</el-menu-item>
      </el-sub-menu>

      <!-- å®¶é•¿æœåŠ¡ -->
      <el-sub-menu index="parent">
        <template #title>
          <el-icon><User /></el-icon>
          <span>å®¶é•¿æœåŠ¡</span>
        </template>
        <el-menu-item index="/parent">å®¶é•¿åˆ—è¡¨</el-menu-item>
        <el-menu-item index="/parent/children">å­©å­åˆ—è¡¨</el-menu-item>
      </el-sub-menu>

      <!-- æ•™å¸ˆç®¡ç† -->
      <el-sub-menu index="teacher">
        <template #title>
          <el-icon><Avatar /></el-icon>
          <span>æ•™å¸ˆç®¡ç†</span>
        </template>
        <el-menu-item index="/teacher">æ•™å¸ˆåˆ—è¡¨</el-menu-item>
      </el-sub-menu>

      <!-- è¥é”€å·¥å…· -->
      <el-sub-menu index="marketing">
        <template #title>
          <el-icon><Promotion /></el-icon>
          <span>è¥é”€å·¥å…·</span>
        </template>
        <el-menu-item index="/principal/poster-editor">æµ·æŠ¥ç¼–è¾‘</el-menu-item>
        <el-menu-item index="/principal/poster-generator">æµ·æŠ¥ç”Ÿæˆå™¨</el-menu-item>
        <el-menu-item index="/chat">åœ¨çº¿å’¨è¯¢</el-menu-item>
        <el-menu-item index="/ai">AIåŠ©æ‰‹</el-menu-item>
      </el-sub-menu>

      <!-- æ•°æ®åˆ†æ -->
      <el-sub-menu index="analytics">
        <template #title>
          <el-icon><TrendCharts /></el-icon>
          <span>æ•°æ®åˆ†æ</span>
        </template>
        <el-menu-item index="/statistics">ç»Ÿè®¡æŠ¥è¡¨</el-menu-item>
        <el-menu-item index="/principal/performance">ç»©æ•ˆç®¡ç†</el-menu-item>
        <el-menu-item index="/principal/marketing-analysis">ç»è¥åˆ†æ</el-menu-item>
        <el-menu-item index="/principal/dashboard">å›­é•¿ä»ªè¡¨ç›˜</el-menu-item>
      </el-sub-menu>

      <!-- ç³»ç»Ÿç®¡ç† -->
      <el-sub-menu index="system">
        <template #title>
          <el-icon><Setting /></el-icon>
          <span>ç³»ç»Ÿç®¡ç†</span>
        </template>
        <el-menu-item index="/system/users">ç”¨æˆ·ç®¡ç†</el-menu-item>
        <el-menu-item index="/system/roles">è§’è‰²ç®¡ç†</el-menu-item>
        <el-menu-item index="/system/permissions">æƒé™ç®¡ç†</el-menu-item>
        <el-menu-item index="/system/logs">ç³»ç»Ÿæ—¥å¿—</el-menu-item>
        <el-menu-item index="/system/backup">æ•°æ®å¤‡ä»½</el-menu-item>
        <el-menu-item index="/system/settings">ç³»ç»Ÿé…ç½®</el-menu-item>
        <el-menu-item index="/system/ai-model-config">AIæ¨¡å‹é…ç½®</el-menu-item>
      </el-sub-menu>
    </el-menu>
    
    <!-- ä¸»é¢˜é€‰æ‹©éƒ¨åˆ† -->
    <div class="theme-section" v-if="!collapsed">
      <div class="theme-section-title">ä¸»é¢˜é€‰æ‹©</div>
      <div class="theme-grid">
        <button 
          v-for="(theme, index) in availableThemes" 
          :key="theme.key"
          class="theme-preview" 
          :class="{ 
            active: currentTheme === theme.key,
            'span-two': index === 6
          }"
          @click="switchTheme(theme.key)"
          :title="theme.name"
        >
          <div class="theme-preview-bg" :style="{ background: theme.preview }"></div>
        </button>
      </div>
    </div>
    </div>

    <!-- æ”¶èµ·/å±•å¼€æŒ‰é’® -->
    <div class="sidebar-toggle" @click="handleToggle">
      <el-icon>
        <component :is="collapsed ? 'Expand' : 'Fold'" />
      </el-icon>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, nextTick } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useUserStore } from '../../stores/user'
import { PERMISSIONS, ROLES } from '../../utils/permission'
import { 
  House, User, Calendar, TrendCharts, Avatar, Setting, 
  Expand, Fold, SwitchButton, Sunny, FullScreen, Aim,
  UserFilled, Promotion
} from '@element-plus/icons-vue'

// Props
interface Props {
  collapsed?: boolean
  isMobile?: boolean
  currentTheme?: string
}

const props = withDefaults(defineProps<Props>(), {
  collapsed: false,
  isMobile: false,
  currentTheme: 'glass-light'
})

// Emits
const emit = defineEmits<{
  toggle: []
  menuClick: []
  themeChange: [theme: string]
}>()

// è·¯ç”±å’ŒçŠ¶æ€
const router = useRouter()
const route = useRoute()
const userStore = useUserStore()

// å½“å‰ä¸»é¢˜
const currentTheme = computed(() => props.currentTheme)

// å¯ç”¨ä¸»é¢˜ - ä¸preview.htmlå’ŒMainLayoutå®Œå…¨ä¸€è‡´
const availableThemes = [
  { 
    key: 'glass-light', 
    name: 'æµ…è‰²ç»ç’ƒ',
    preview: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  },
  { 
    key: 'glass-dark', 
    name: 'æ·±è‰²ç»ç’ƒ',
    preview: 'linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%)'
  },
  { 
    key: 'neon-glass', 
    name: 'éœ“è™¹ç»ç’ƒ',
    preview: 'linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #1a0a1a 100%)'
  },
  { 
    key: 'gradient-glass', 
    name: 'æ¸å˜ç»ç’ƒ',
    preview: 'linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 20%, #45b7d1 40%, #f9ca24 60%, #f0932b 80%, #ee5a24 100%)'
  },
  { 
    key: 'bright-summer', 
    name: 'æ˜äº®å¤æ—¥',
    preview: 'linear-gradient(135deg, #ffeaa7 0%, #fab1a0 25%, #fd79a8 50%, #e17055 75%, #fdcb6e 100%)'
  },
  { 
    key: 'bright-nature', 
    name: 'æ¸…æ–°è‡ªç„¶',
    preview: 'linear-gradient(135deg, #a8e6cf 0%, #dcedc1 25%, #c7f2c3 50%, #7fcdcd 75%, #87ceeb 100%)'
  },
  { 
    key: 'bright-minimalist', 
    name: 'ç®€çº¦æ˜äº®',
    preview: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 25%, #cbd5e1 50%, #f1f5f9 75%, #ffffff 100%)'
  }
]

// ä¸»é¢˜åˆ‡æ¢æ–¹æ³•
const switchTheme = (theme: string) => {
  console.log('Sidebar switching theme to:', theme)
  emit('themeChange', theme)
}

// å›¾ç‰‡é”™è¯¯å¤„ç†
const handleImageError = (event: Event) => {
  const target = event.target as HTMLImageElement
  if (target) {
    target.style.display = 'none'
    const parent = target.parentElement
    if (parent) {
      parent.innerHTML = '<div class="logo-fallback">ğŸ«</div>'
    }
  }
}

// å¤„ç†åˆ‡æ¢
const handleToggle = () => {
  emit('toggle')
}

// å¤„ç†èœå•ç‚¹å‡»
const handleMenuClick = () => {
  emit('menuClick')
}

// æ·»åŠ debugæ—¥å¿—
onMounted(() => {
  console.log('Sidebar mounted')
  console.log('Available themes in sidebar:', availableThemes.length)
  console.log('Themes:', availableThemes.map(t => t.name))
  console.log('Current theme prop:', props.currentTheme)
})
</script>

<style lang="scss" scoped>
@import '@/styles/index.scss';

/* ä¾§è¾¹æ æ ·å¼ */
.sidebar {
  width: 200px;
  background-color: var(--sidebar-bg);
  color: var(--sidebar-text);
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
  position: relative;
  z-index: 1000;
  border-right: 1px solid var(--sidebar-border);
  height: 100%;

  &.sidebar-collapsed {
    width: 64px;
  }
}

.sidebar-logo {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1px solid var(--sidebar-border);
  padding: 0 16px;
  background-color: var(--sidebar-bg);
}

.logo-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-icon {
  font-size: 24px;
  flex-shrink: 0;
  color: var(--sidebar-text-hover);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  overflow: hidden;
  
  .logo-image {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 50%;
  }
  
  .logo-fallback {
    font-size: 20px;
    color: var(--sidebar-text-hover);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
}

.logo-text {
  font-size: 16px;
  font-weight: 600;
  white-space: nowrap;
  color: var(--sidebar-text-hover);
}

.sidebar-menu-container {
  flex: 1;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding: 8px 0;
  position: relative !important;
  contain: layout style !important;
}

.sidebar-menu {
  background-color: transparent !important;
  border: none !important;
  width: 100%;
  
  /* ä½¿ç”¨å…¨å±€æç»†æ»šåŠ¨æ¡æ ·å¼ */
  
  &::-webkit-scrollbar-thumb {
    background: var(--border-light);
    border-radius: 2px;
    
    &:hover {
      background: var(--border-color);
    }
  }
}

/* åŸºç¡€èœå•æ ·å¼ - åªä¿ç•™å¿…è¦çš„æ ·å¼ï¼Œè®©Element Plusä½¿ç”¨é»˜è®¤è¡Œä¸º */
.sidebar-menu {
  background-color: transparent;
  border: none;
  width: 100%;
}

.sidebar-toggle {
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-top: 1px solid var(--sidebar-border);
  color: var(--sidebar-text);
  transition: all 0.3s;
  background-color: var(--sidebar-bg);
  
  &:hover {
    background-color: var(--sidebar-item-hover);
    color: var(--sidebar-text-hover);
  }
}

/* å“åº”å¼è°ƒæ•´ */
@media screen and (max-width: 768px) {
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 1000;
    transform: translateX(-100%);
    
    &:not(.sidebar-collapsed) {
      transform: translateX(0);
    }
  }
  
  .logo-icon {
    width: 36px;
    height: 36px;
    
    .logo-image {
      width: 100%;
      height: 100%;
    }
  }
}

@media screen and (max-width: 480px) {
  .logo-icon {
    width: 32px;
    height: 32px;
  }
  
  .logo-text {
    font-size: 14px;
  }
}

/* ä¸»é¢˜é€‰æ‹©éƒ¨åˆ†æ ·å¼ */
.theme-section {
  padding: 16px;
  border-top: 1px solid var(--sidebar-border);
  margin-top: auto;
}

.theme-section-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--sidebar-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  opacity: 0.7;
}

.theme-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.theme-preview {
  width: 100%;
  height: 32px;
  border: 2px solid var(--sidebar-border);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
  background: none;
  padding: 0;
  
  &:hover {
    transform: scale(1.05);
    border-color: var(--sidebar-text);
  }
  
  &.active {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px var(--primary-color);
  }
  
  &.span-two {
    grid-column: span 2;
  }
}

.theme-preview-bg {
  width: 100%;
  height: 100%;
  border-radius: 4px;
}
</style> 
