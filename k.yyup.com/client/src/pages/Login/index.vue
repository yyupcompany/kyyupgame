<template>
  <div class="modern-login-page">
    <!-- å…¨å±Loadingé®ç½© - å½“å…¥åœºåŠ¨ç”»æ’­æ”¾æ—¶ä¸æ˜¾ç¤º -->
    <div v-if="shouldShowLoading" class="fullscreen-loading">
      <div class="loading-spinner-large"></div>
    </div>

    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="animated-background">
      <div class="gradient-mesh"></div>
      <div class="floating-particles">
        <div class="particle particle-1"></div>
        <div class="particle particle-2"></div>
        <div class="particle particle-3"></div>
        <div class="particle particle-4"></div>
        <div class="particle particle-5"></div>
        <div class="particle particle-6"></div>
      </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="login-container" :style="{ opacity: showEntranceAnimation ? 0 : 1, pointerEvents: showEntranceAnimation ? 'none' : 'auto', transition: 'opacity 0.3s ease' }">
      <div class="auth-panel">

      <!-- å·¦ä¾§å“ç‰ŒåŒºåŸŸ -->
      <div class="brand-section">
        <div class="brand-content">
          <!-- Logoå’Œå“ç‰Œ -->
          <div class="brand-header">
            <div class="logo-container">
              <div class="logo-icon">
                <img src="@/assets/logo.png" alt="å©´å©´å‘ä¸Šæ™ºèƒ½æ‹›ç”Ÿç³»ç»Ÿ" class="logo-image" />
              </div>
            </div>
            <h1 class="brand-title">
              <span class="title-main">æ™ºæ…§å¹¼å„¿å›­</span>
              <span class="title-sub">ç®¡ç†ç³»ç»Ÿ</span>
            </h1>
            <p class="brand-slogan">è®©æ•™è‚²æ›´æ™ºèƒ½ Â· è®©æˆé•¿æ›´ç¾å¥½</p>
          </div>

          <!-- æ ¸å¿ƒä»·å€¼å±•ç¤º -->
          <div class="core-values">
            <div class="value-item">
              <div class="value-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                  <path d="M2 17L12 22L22 17"/>
                  <path d="M2 12L12 17L22 12"/>
                </svg>
              </div>
              <div class="value-content">
                <h3>æ™ºæ…§ç®¡ç†</h3>
                <p>ä¸€ç«™å¼æ•°å­—åŒ–è§£å†³æ–¹æ¡ˆï¼Œæå‡å›­åŒºè¿è¥æ•ˆç‡</p>
              </div>
            </div>

            <div class="value-item">
              <div class="value-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 6V12L16 14"/>
                </svg>
              </div>
              <div class="value-content">
                <h3>å®æ—¶åŒæ­¥</h3>
                <p>å®¶å›­äº’é€šï¼Œè®©å®¶é•¿éšæ—¶äº†è§£å­©å­çš„æˆé•¿åŠ¨æ€</p>
              </div>
            </div>

            <div class="value-item">
              <div class="value-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
              </div>
              <div class="value-content">
                <h3>åˆ›æ–°æ•™å­¦</h3>
                <p>AIèµ‹èƒ½æ•™è‚²ï¼Œå¼€å¯ä¸ªæ€§åŒ–å­¦ä¹ æ–°ä½“éªŒ</p>
              </div>
            </div>
          </div>

          <!-- æ•°æ®å±•ç¤º -->
          <div class="stats-showcase">
            <div class="stat-item">
              <div class="stat-number">5000+</div>
              <div class="stat-label">åˆä½œå›­æ‰€</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">50ä¸‡+</div>
              <div class="stat-label">æœåŠ¡å®¶åº­</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">99.9%</div>
              <div class="stat-label">ç³»ç»Ÿç¨³å®šæ€§</div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ç™»å½•åŒºåŸŸ -->
      <div class="login-section">
        <div class="login-card">
          <!-- ç™»å½•è¡¨å•å¤´éƒ¨ -->
          <div class="login-header">
            <div class="welcome-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                <polyline points="10 17 15 12 10 7"/>
                <line x1="15" y1="12" x2="3" y2="12"/>
              </svg>
            </div>
            <h2 class="login-title">æ¬¢è¿ç™»å½•</h2>
            <p class="login-subtitle">å¼€å¯æ™ºæ…§æ•™è‚²æ–°ä½“éªŒ</p>
          </div>

          <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
          <div class="login-mode-toggle">
            <div class="toggle-tabs">
              <button
                class="tab-btn"
                :class="{ active: loginMode === 0 }"
                @click="toggleLoginMode(0)"
              >
                <div class="tab-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                </div>
                <span>ç”¨æˆ·åç™»å½•</span>
              </button>
              <button
                class="tab-btn"
                :class="{ active: loginMode === 1 }"
                @click="toggleLoginMode(1)"
              >
                <div class="tab-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                  </svg>
                </div>
                <span>æ‰‹æœºå·ç™»å½•</span>
              </button>
            </div>
            <div class="toggle-indicator" :style="{ transform: `translateX(${loginMode * 100}%)` }"></div>
          </div>

          <!-- ç™»å½•è¡¨å• -->
          <form @submit.prevent="handleLogin" class="login-form">
            <!-- ç”¨æˆ·å/æ‰‹æœºå·è¾“å…¥ -->
            <div class="input-group" v-if="loginMode === 0">
              <div class="input-container">
                <div class="input-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>
                <input
                  v-model="loginForm.username"
                  type="text"
                  placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                  :disabled="loading"
                  required
                  class="form-input"
                  :class="{ 'error': errors.username }"
                  autocomplete="username"
                  data-testid="username-input"
                />
              </div>
              <div v-if="errors.username" class="error-message">
                {{ errors.username }}
              </div>
            </div>

            <!-- æ‰‹æœºå·è¾“å…¥ -->
            <div class="input-group" v-if="loginMode === 1">
              <div class="input-container">
                <div class="input-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                  </svg>
                </div>
                <input
                  v-model="loginForm.phone"
                  type="tel"
                  placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
                  :disabled="loading"
                  required
                  class="form-input"
                  :class="{ 'error': errors.phone }"
                  autocomplete="tel"
                  data-testid="phone-input"
                  maxlength="11"
                />
              </div>
              <div v-if="errors.phone" class="error-message">
                {{ errors.phone }}
              </div>
            </div>

            <!-- ç§Ÿæˆ·ä»£ç è¾“å…¥ï¼ˆå¯é€‰ï¼‰ -->
            <div class="input-group" v-if="loginMode === 1">
              <div class="input-container">
                <div class="input-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                  </svg>
                </div>
                <input
                  v-model="loginForm.tenantCode"
                  type="text"
                  placeholder="ç§Ÿæˆ·ä»£ç ï¼ˆå¯é€‰ï¼‰"
                  :disabled="loading"
                  class="form-input"
                  :class="{ 'error': errors.tenantCode }"
                  autocomplete="organization"
                  data-testid="tenant-code-input"
                />
              </div>
              <div v-if="errors.tenantCode" class="error-message">
                {{ errors.tenantCode }}
              </div>
              <div class="input-hint">
                å¯é€‰å¡«ï¼Œå¦‚ä¸å¡«å†™å°†æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ç§Ÿæˆ·ä¾›é€‰æ‹©
              </div>
            </div>

            <!-- å¯†ç è¾“å…¥ -->
            <div class="input-group">
              <div class="input-container">
                <div class="input-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18,8h-1V6c0-2.76-2.24-5-5-5S7,3.24,7,6v2H6c-1.1,0-2,0.9-2,2v10c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V10C20,8.9,19.1,8,18,8z M12,17c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S13.1,17,12,17z M15.1,8H8.9V6c0-1.71,1.39-3.1,3.1-3.1s3.1,1.39,3.1,3.1V8z"/>
                  </svg>
                </div>
                <input
                  v-model="loginForm.password"
                  type="password"
                  placeholder="è¯·è¾“å…¥å¯†ç "
                  :disabled="loading"
                  required
                  class="form-input"
                  :class="{ 'error': errors.password }"
                  autocomplete="current-password"
                  data-testid="password-input"
                />
              </div>
              <div v-if="errors.password" class="error-message">
                {{ errors.password }}
              </div>
            </div>

            <!-- å…¨å±€é”™è¯¯ä¿¡æ¯ -->
            <div v-if="globalError" class="global-error" data-testid="error-message">
              <div class="error-icon">âš ï¸</div>
              <span>{{ globalError }}</span>
            </div>

            <!-- ç™»å½•æŒ‰é’® -->
            <button
              type="submit"
              class="login-btn"
              :disabled="loading"
              data-testid="login-button"
            >
              <span class="btn-text">ç«‹å³ç™»å½•</span>
              <div class="btn-arrow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                </svg>
              </div>
            </button>
          </form>

          <!-- ç§Ÿæˆ·é€‰æ‹©å¼¹çª— -->
          <div v-if="showTenantSelection" class="tenant-selection-overlay" @click.self="showTenantSelection = false">
            <div class="tenant-selection-modal">
              <div class="modal-header">
                <div class="modal-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 21V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5m-4 0h4"/>
                  </svg>
                </div>
                <h3 class="modal-title">é€‰æ‹©ç§Ÿæˆ·</h3>
                <p class="modal-subtitle">æ‚¨çš„æ‰‹æœºå·å…³è”äº†å¤šä¸ªç§Ÿæˆ·ï¼Œè¯·é€‰æ‹©è¦ç™»å½•çš„ç§Ÿæˆ·</p>
              </div>

              <div class="tenant-list">
                <div
                  v-for="tenant in availableTenants"
                  :key="tenant.tenantCode"
                  class="tenant-item"
                  @click="selectTenant(tenant)"
                  :class="{ disabled: tenant.status !== 'active' }"
                >
                  <div class="tenant-info">
                    <div class="tenant-name">{{ tenant.tenantName }}</div>
                    <div class="tenant-code">{{ tenant.tenantCode }}</div>
                    <div class="tenant-meta">
                      <span class="tenant-domain">{{ tenant.domain }}</span>
                      <span class="tenant-status" :class="tenant.status">
                        {{ tenant.status === 'active' ? 'æ­£å¸¸' : 'å·²åœç”¨' }}
                      </span>
                    </div>
                  </div>
                  <div class="tenant-arrow">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="modal-actions">
                <button class="cancel-btn" @click="showTenantSelection = false">
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>

          <!-- å¿«æ·ç™»å½• -->
          <div class="quick-login">
            <div class="divider">
              <span class="divider-text">å¿«é€Ÿä½“éªŒ</span>
            </div>

            <div class="quick-description">
              <span class="quick-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
              </span>
              <span class="quick-text">é€‰æ‹©è§’è‰²ï¼Œä¸€é”®ä½“éªŒç³»ç»ŸåŠŸèƒ½</span>
            </div>

            <div class="quick-buttons">
              <button
                class="quick-btn admin-btn"
                @click="quickLogin('admin')"
                :disabled="loading"
                title="ä½“éªŒå®Œæ•´ç³»ç»Ÿç®¡ç†åŠŸèƒ½"
              >
                <div class="btn-content">
                  <div class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </div>
                  <div class="btn-info">
                    <div class="btn-title">ç³»ç»Ÿç®¡ç†å‘˜</div>
                    <div class="btn-desc">å…¨å±€ç®¡ç†</div>
                  </div>
                </div>
              </button>

              <button
                class="quick-btn principal-btn"
                @click="quickLogin('principal')"
                :disabled="loading"
                title="ä½“éªŒå›­é•¿ç®¡ç†åŠŸèƒ½"
              >
                <div class="btn-content">
                  <div class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="6"/>
                      <circle cx="12" cy="12" r="2"/>
                    </svg>
                  </div>
                  <div class="btn-info">
                    <div class="btn-title">å›­é•¿</div>
                    <div class="btn-desc">å›­åŒºç®¡ç†</div>
                  </div>
                </div>
              </button>

              <button
                class="quick-btn teacher-btn"
                @click="quickLogin('teacher')"
                :disabled="loading"
                title="ä½“éªŒæ•™å¸ˆå·¥ä½œåŠŸèƒ½"
              >
                <div class="btn-content">
                  <div class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                      <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                  </div>
                  <div class="btn-info">
                    <div class="btn-title">æ•™å¸ˆ</div>
                    <div class="btn-desc">æ•™å­¦ç®¡ç†</div>
                  </div>
                </div>
              </button>

              <button
                class="quick-btn parent-btn"
                @click="quickLogin('parent')"
                :disabled="loading"
                title="ä½“éªŒå®¶é•¿æœåŠ¡åŠŸèƒ½"
              >
                <div class="btn-content">
                  <div class="btn-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="9" cy="7" r="4"/>
                      <path d="M1 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    </svg>
                  </div>
                  <div class="btn-info">
                    <div class="btn-title">å®¶é•¿</div>
                    <div class="btn-desc">å®¶å›­äº’åŠ¨</div>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»é¢˜é€‚é…å…¥åœºåŠ¨ç”» -->
    <EntranceAnimationWrapper
      :show="showEntranceAnimation"
      type="theme-adaptive"
      @complete="onEntranceAnimationComplete"
    />

    <!-- è§’è‰²é€‰æ‹©å¼¹çª—ï¼ˆç”¨äºæœªæ³¨å†Œç”¨æˆ·ï¼‰ -->
    <RoleSelectionModal
      v-model="showRoleSelection"
      :tenant-name="pendingRegistrationTenantName"
      :available-roles-codes="pendingRegistrationRoles"
      @success="onRegistrationSuccess"
      @cancel="onRegistrationCancel"
    />
    </div>

    <div class="page-footer">
      <p>&copy; 2024 æ™ºæ…§å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ Â· è®©æ•™è‚²æ›´æ™ºèƒ½</p>
      <p class="tech-support">
        <a :href="currentOrigin" target="_blank" rel="noopener noreferrer" class="tech-link">
          å©´å©´å‘ä¸Šï¼ˆåŒ—äº¬ï¼‰æ•™è‚²ç§‘æŠ€å…¬å¸æä¾›æŠ€æœ¯æ”¯æŒ
        </a>
      </p>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/stores/user'
import { usePermissionsStore } from '@/stores/permissions-simple'
import { useAuthStore } from '@/store/modules/auth'
import { login } from '@/api/modules/user'
import DesignTokenManager from '@/config/design-tokens'
import AnimationConfigManager from '@/config/animation-config'
import EntranceAnimationWrapper from '@/components/EntranceAnimationWrapper.vue'
import RoleSelectionModal from '@/components/auth/RoleSelectionModal.vue'
import { useGlobalLoading, setGlobalLoading, setEntranceAnimationActive } from '@/composables/useGlobalLoading'

const router = useRouter()
const route = useRoute()
const userStore = useUserStore()
const permissionsStore = usePermissionsStore()
const authStore = useAuthStore()

// åˆå§‹åŒ–å…¨å±€loadingç®¡ç†
const { shouldShowLoading } = useGlobalLoading()

// ç»Ÿä¸€è®¤è¯é…ç½®
const UNIFIED_AUTH_URL = import.meta.env.VITE_UNIFIED_AUTH_CENTER_URL || 'http://rent.yyup.cc'
const UNIFIED_AUTH_PORT = '5174' // ç»Ÿä¸€è®¤è¯å‰ç«¯ç«¯å£
const CURRENT_TENANT_URL = typeof window !== 'undefined' ? window.location.origin : '' // å½“å‰ç§Ÿæˆ·ç³»ç»ŸURL

// å½“å‰åŸŸåï¼ˆç”¨äºæ¨¡æ¿ï¼‰
const currentOrigin = computed(() => typeof window !== 'undefined' ? window.location.origin : '')

// ç™»å½•æ–¹å¼ï¼š0=ç”¨æˆ·åç™»å½•ï¼Œ1=æ‰‹æœºå·ç™»å½•
const loginMode = ref(0)

// è¡¨å•æ•°æ®
const loginForm = ref({
  username: '',
  phone: '',
  password: '',
  tenantCode: ''
})

// ç§Ÿæˆ·é€‰æ‹©ç›¸å…³çŠ¶æ€
const showTenantSelection = ref(false)
const availableTenants = ref([])

// è§’è‰²é€‰æ‹©ç›¸å…³çŠ¶æ€ï¼ˆç”¨äºæœªæ³¨å†Œç”¨æˆ·ï¼‰
const showRoleSelection = ref(false)
const pendingRegistrationTenantName = computed(() => authStore.pendingRegistration?.tenantName || '')
const pendingRegistrationRoles = computed(() => authStore.pendingRegistration?.availableRoles || ['principal', 'teacher', 'parent'])

// ç™»å½•æ¨¡å¼åˆ‡æ¢
const toggleLoginMode = (mode: number) => {
  loginMode.value = mode
  globalError.value = ''
  clearErrors()
}

// çŠ¶æ€ç®¡ç†
const loading = ref(false)
const globalError = ref('')
const errors = ref({
  username: '',
  password: ''
})

// æ·»åŠ ä¸€ä¸ªç”¨äºé˜²æ­¢é‡å¤æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯çš„å¼•ç”¨
const lastErrorMessage = ref('')
const lastErrorMessageTime = ref(0)

// å…¥åœºåŠ¨ç”»çŠ¶æ€
const showEntranceAnimation = ref(false)

// ç»Ÿä¸€è®¤è¯å›è°ƒå¤„ç†
const handleUnifiedAuthCallback = () => {
  if (typeof window === 'undefined') return false
  const urlParams = new URLSearchParams(window.location.search)
  const token = urlParams.get('token')
  const tenantCode = urlParams.get('tenantCode')

  if (token) {
    console.log('âœ… æ£€æµ‹åˆ°ç»Ÿä¸€è®¤è¯å›è°ƒï¼Œtoken:', token.substring(0, 20) + '...')
    console.log('âœ… ç§Ÿæˆ·ä»£ç :', tenantCode)

    // ä¿å­˜ token åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('kindergarten_token', token)
    if (tenantCode) {
      localStorage.setItem('tenant_code', tenantCode)
    }
    localStorage.setItem('unified_auth_mode', 'true')

    // æ¸…é™¤ URL ä¸­çš„å‚æ•°
    if (typeof window !== 'undefined') {
      const cleanUrl = window.location.origin + window.location.pathname
      window.history.replaceState({}, document.title, cleanUrl)
    }

    // è·³è½¬åˆ°é¦–é¡µ
    ElMessage.success('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿å›æ¥ï¼')
    setTimeout(() => {
      router.push('/dashboard')
    }, 500)

    return true
  }

  return false
}

// é‡å®šå‘åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
const redirectToUnifiedAuth = () => {
  console.log('ğŸ”„ é‡å®šå‘åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ...')
  console.log('ç»Ÿä¸€è®¤è¯URL:', `${UNIFIED_AUTH_URL}:${UNIFIED_AUTH_PORT}`)
  console.log('å›è°ƒURL:', CURRENT_TENANT_URL)

  const redirectUrl = `${UNIFIED_AUTH_URL}:${UNIFIED_AUTH_PORT}/login?redirect=${encodeURIComponent(CURRENT_TENANT_URL)}`
  console.log('å®Œæ•´é‡å®šå‘URL:', redirectUrl)

  // å»¶è¿Ÿé‡å®šå‘ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æç¤º
  ElMessage.info('æ­£åœ¨è·³è½¬åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ...')
  setTimeout(() => {
    if (typeof window !== 'undefined') {
      window.location.href = redirectUrl
    }
  }, 500)
}

// æ¸…é™¤é”™è¯¯ä¿¡æ¯
const clearErrors = () => {
  errors.value.username = ''
  errors.value.phone = ''
  errors.value.password = ''
  errors.value.tenantCode = ''
}

// è¡¨å•éªŒè¯
const validateForm = () => {
  clearErrors()
  globalError.value = ''

  let isValid = true

  if (loginMode.value === 0) {
    // ç”¨æˆ·åç™»å½•éªŒè¯
    if (!loginForm.value.username.trim()) {
      errors.value.username = 'è¯·è¾“å…¥ç”¨æˆ·å'
      isValid = false
    }
  } else {
    // æ‰‹æœºå·ç™»å½•éªŒè¯
    if (!loginForm.value.phone.trim()) {
      errors.value.phone = 'è¯·è¾“å…¥æ‰‹æœºå·'
      isValid = false
    } else if (!/^1[3-9]\d{9}$/.test(loginForm.value.phone.trim())) {
      errors.value.phone = 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼'
      isValid = false
    }

    // ç§Ÿæˆ·ä»£ç éªŒè¯ï¼ˆå¯é€‰ï¼‰
    if (loginForm.value.tenantCode.trim() && !/^[a-zA-Z0-9]{3,10}$/.test(loginForm.value.tenantCode.trim())) {
      errors.value.tenantCode = 'ç§Ÿæˆ·ä»£ç æ ¼å¼ä¸æ­£ç¡®'
      isValid = false
    }
  }

  if (!loginForm.value.password.trim()) {
    errors.value.password = 'è¯·è¾“å…¥å¯†ç '
    isValid = false
  }

  return isValid
}

// ä¸»ç™»å½•å¤„ç†å‡½æ•°
const handleLogin = async () => {
  console.log('ğŸš€ å¼€å§‹ç™»å½•æµç¨‹...')

  if (!validateForm()) {
    console.log('âŒ è¡¨å•éªŒè¯å¤±è´¥')
    return
  }

  setGlobalLoading(true)
  globalError.value = ''

  try {
    let response

    if (loginMode.value === 0) {
      // ç”¨æˆ·åç™»å½• - ä½¿ç”¨ä¼ ç»Ÿè®¤è¯
      console.log('ğŸ“¡ ç”¨æˆ·åç™»å½•:', {
        username: loginForm.value.username,
        password: '***'
      })

      response = await login({
        username: loginForm.value.username,
        password: loginForm.value.password
      })

      if (response.success && response.data) {
        await processTraditionalLoginSuccess(response.data)
      } else {
        throw new Error(response.message || 'ç™»å½•å¤±è´¥')
      }
    } else {
      // æ‰‹æœºå·ç™»å½• - ä½¿ç”¨ç»Ÿä¸€è®¤è¯
      console.log('ğŸ“¡ æ‰‹æœºå·ç™»å½•:', {
        phone: loginForm.value.phone,
        password: '***',
        tenantCode: loginForm.value.tenantCode || 'ä¸æŒ‡å®š'
      })

      response = await authStore.flexibleLogin(
        loginForm.value.phone,
        loginForm.value.password,
        loginForm.value.tenantCode || undefined
      )

      await processUnifiedLoginSuccess(response)
    }

    console.log('âœ… ç™»å½•å“åº”:', response)

  } catch (error: any) {
    console.error('âŒ ç™»å½•å¤±è´¥:', error)
    handleLoginError(error)
  } finally {
    setGlobalLoading(false)
  }
}


// å¤„ç†ä¼ ç»Ÿç™»å½•æˆåŠŸ
const processTraditionalLoginSuccess = async (loginData: any) => {
  console.log('ğŸ‰ ç™»å½•æˆåŠŸï¼Œå¤„ç†ç”¨æˆ·æ•°æ®:', loginData)
  console.log('ğŸ” loginDataç»“æ„:', {
    hasToken: !!loginData.token,
    hasUser: !!loginData.user,
    userStructure: loginData.user ? Object.keys(loginData.user) : 'no user'
  })

  try {
    // ä¿å­˜tokenåˆ°å¤šä¸ªä½ç½®ï¼ˆå…¼å®¹æ€§ï¼‰
    const token = loginData.token
    if (!token) {
      console.error('âŒ Tokenç¼ºå¤±ï¼ŒloginData:', loginData)
      throw new Error('ç™»å½•å“åº”ä¸­ç¼ºå°‘token')
    }

    localStorage.setItem('kindergarten_token', token)
    localStorage.setItem('token', token)
    localStorage.setItem('auth_token', token)

    console.log('âœ… Tokenå·²ä¿å­˜åˆ°localStorage:', {
      kindergarten_token: !!localStorage.getItem('kindergarten_token'),
      token: !!localStorage.getItem('token'),
      auth_token: !!localStorage.getItem('auth_token')
    })

    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°store - é€‚é…åç«¯è¿”å›çš„æ•°æ®æ ¼å¼
    const userInfo = {
      token: token,
      username: loginData.user.username,
      displayName: loginData.user.realName || loginData.user.real_name || loginData.user.username,
      role: (loginData.user.role || loginData.user.user_role)?.toLowerCase() || 'user',  // ç»Ÿä¸€ä½¿ç”¨å°å†™
      roles: loginData.user.roles || [loginData.user.role || loginData.user.user_role],
      permissions: loginData.user.permissions || (loginData.user.isAdmin ? ['*'] : []),
      email: loginData.user.email,
      avatar: loginData.user.avatar,
      id: loginData.user.id,
      isAdmin: loginData.user.isAdmin || loginData.user.role === 'admin' || loginData.user.user_role === 'admin',
      kindergartenId: loginData.user.kindergartenId || loginData.user.kindergarten_id,  // æ”¯æŒä¸¤ç§å‘½åæ ¼å¼
      status: 'active'
    }

    console.log('ğŸ’¾ ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°store:', userInfo)

    // æ¸…é™¤æ—§çš„æƒé™æ•°æ®ï¼Œç¡®ä¿è§’è‰²åˆ‡æ¢æ—¶æƒé™æ­£ç¡®æ›´æ–°
    permissionsStore.clearPermissions()
    userStore.setUserInfo(userInfo)

    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorageï¼ˆæŒä¹…åŒ–ï¼‰- ä¿å­˜åˆ°ä¸¤ä¸ªåœ°æ–¹ç¡®ä¿å…¼å®¹æ€§
    localStorage.setItem('userInfo', JSON.stringify(userInfo))
    localStorage.setItem('kindergarten_user_info', JSON.stringify(userInfo))

    console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°localStorage:', {
      userInfo: !!localStorage.getItem('userInfo'),
      kindergarten_user_info: !!localStorage.getItem('kindergarten_user_info'),
      userInfoContent: localStorage.getItem('userInfo') ? 'æœ‰æ•ˆ' : 'ç©º'
    })

    ElMessage.success(`æ¬¢è¿å›æ¥ï¼Œ${userInfo.displayName}ï¼`)

    // å¤„ç†é‡å®šå‘ - ä½¿ç”¨æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ
    let redirectUrl = route.query.redirect as string

    if (!redirectUrl) {
      // ä½¿ç”¨æ™ºèƒ½è·¯ç”±ç³»ç»Ÿï¼šæ ¹æ®è®¾å¤‡ç±»å‹å’Œç”¨æˆ·è§’è‰²è‡ªåŠ¨é€‰æ‹©è·¯ç”±
      const { getLoginRedirectPath } = await import('@/router/smart-redirect')
      const { getActualDeviceType } = await import('@/utils/device-detect')
      
      const userRole = userInfo.role?.toLowerCase() as any
      const deviceType = getActualDeviceType()
      
      redirectUrl = getLoginRedirectPath(userRole)
      
      console.log('ğŸ¯ æ™ºèƒ½è·¯ç”±é‡å®šå‘:')
      console.log('  - ç”¨æˆ·è§’è‰²:', userRole)
      console.log('  - è®¾å¤‡ç±»å‹:', deviceType)
      console.log('  - è·³è½¬è·¯å¾„:', redirectUrl)
    }

    console.log('ğŸ”€ å‡†å¤‡è·³è½¬åˆ°:', redirectUrl)

    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ Pinia çŠ¶æ€å®Œå…¨åŒæ­¥åå†è¿›è¡Œè·¯ç”±è·³è½¬
    await nextTick()
    
    // éªŒè¯ç™»å½•çŠ¶æ€æ˜¯å¦æ­£ç¡®è®¾ç½®
    console.log('ğŸ” éªŒè¯ç™»å½•çŠ¶æ€:', {
      isLoggedIn: userStore.isLoggedIn,
      hasToken: !!userStore.token,
      hasUserInfo: !!userStore.user,
      username: userStore.user?.username
    })
    
    if (!userStore.isLoggedIn) {
      console.error('âŒ ç™»å½•çŠ¶æ€è®¾ç½®å¤±è´¥ï¼Œå°è¯•é‡æ–°è®¾ç½®...')
      // å¦‚æœçŠ¶æ€ä»ç„¶ä¸æ­£ç¡®ï¼Œç­‰å¾…ä¸€ä¸‹å†æ£€æŸ¥
      await new Promise(resolve => setTimeout(resolve, 50))
      
      if (!userStore.isLoggedIn) {
        console.error('âŒ ç™»å½•çŠ¶æ€ä»ç„¶æ— æ•ˆï¼Œå¯èƒ½æ˜¯æ•°æ®é—®é¢˜')
        throw new Error('ç™»å½•çŠ¶æ€è®¾ç½®å¤±è´¥')
      }
    }

    // æ˜¾ç¤ºç³»ç»Ÿå…¥åœºåŠ¨ç”»ï¼Œç„¶åè·³è½¬
    console.log('ğŸ¬ ç™»å½•æˆåŠŸï¼Œå¼€å§‹æ˜¾ç¤ºç³»ç»Ÿå…¥åœºåŠ¨ç”»')
    showEntranceAnimation.value = true
    setEntranceAnimationActive(true)

    // ğŸ¯ æ”¹è¿›çš„æµç¨‹ï¼šåŠ¨ç”» -> è·³è½¬ -> æ˜¾ç¤ºæ–°é¡µé¢
    // ç»™åŠ¨ç”»ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿä»¥ç¡®ä¿å®Œå…¨æ˜¾ç¤º
    await new Promise(resolve => setTimeout(resolve, 100))

    // ç«‹å³æ‰§è¡Œè·¯ç”±è·³è½¬ï¼ˆä½¿ç”¨ await ç¡®ä¿è·³è½¬å®Œæˆï¼‰
    console.log('ğŸ¬ åŠ¨ç”»å¼€å§‹ï¼Œæ‰§è¡Œè·¯ç”±è·³è½¬')
    try {
      await router.replace(redirectUrl)
      console.log('âœ… é¡µé¢è·³è½¬å®Œæˆ')
      // è·³è½¬åéšè—ç™»å½•å®¹å™¨å’ŒåŠ¨ç”»
      showEntranceAnimation.value = false
      setEntranceAnimationActive(false)
    } catch (error) {
      console.error('âŒ è·¯ç”±è·³è½¬å¤±è´¥:', error)
      // è·³è½¬å¤±è´¥æ—¶æ¢å¤æ˜¾ç¤ºç™»å½•é¡µ
      showEntranceAnimation.value = false
      setEntranceAnimationActive(false)
      throw error
    }

  } catch (error) {
    console.error('âŒ å¤„ç†ç™»å½•æ•°æ®å¤±è´¥:', error)
    throw new Error('ç™»å½•æ•°æ®å¤„ç†å¤±è´¥')
  }
}

// å¤„ç†ç»Ÿä¸€è®¤è¯ç™»å½•æˆåŠŸ
const processUnifiedLoginSuccess = async (loginResponse: any) => {
  console.log('ğŸ‰ ç»Ÿä¸€è®¤è¯ç™»å½•æˆåŠŸ:', loginResponse)

  try {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ³¨å†Œï¼ˆç”¨æˆ·åœ¨ç»Ÿä¸€è®¤è¯å­˜åœ¨ä½†æœªç»‘å®šå½“å‰ç§Ÿæˆ·ï¼‰
    if (authStore.needsRegistration) {
      console.log('ğŸ”„ ç”¨æˆ·éœ€è¦æ³¨å†Œåˆ°å½“å‰ç§Ÿæˆ·')
      console.log('ğŸ“‹ å¾…æ³¨å†Œä¿¡æ¯:', authStore.pendingRegistration)
      showRoleSelection.value = true
      return
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç§Ÿæˆ·é€‰æ‹©
    if (authStore.requiresTenantSelection && authStore.availableTenants.length > 0) {
      console.log('ğŸ”„ éœ€è¦é€‰æ‹©ç§Ÿæˆ·')
      availableTenants.value = authStore.availableTenants
      showTenantSelection.value = true
      return
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç§Ÿæˆ·ç»‘å®š
    if (authStore.requiresTenantBinding) {
      console.log('ğŸ”„ éœ€è¦ç»‘å®šç§Ÿæˆ·')
      ElMessage.info('æ‚¨çš„è´¦å·éœ€è¦ç»‘å®šç§Ÿæˆ·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜')
      return
    }

    // ç›´æ¥ç™»å½•æˆåŠŸï¼Œå¤„ç†åç»­æµç¨‹
    await processLoginSuccessRedirect()
  } catch (error) {
    console.error('âŒ å¤„ç†ç»Ÿä¸€è®¤è¯ç™»å½•æ•°æ®å¤±è´¥:', error)
    throw new Error('ç»Ÿä¸€è®¤è¯ç™»å½•æ•°æ®å¤„ç†å¤±è´¥')
  }
}

// é€‰æ‹©ç§Ÿæˆ·å¤„ç†
const selectTenant = async (tenant: any) => {
  console.log('ğŸ¢ é€‰æ‹©ç§Ÿæˆ·:', tenant)

  try {
    authStore.selectTenant(tenant)
    showTenantSelection.value = false

    // é‡æ–°å°è¯•ç™»å½•
    await authStore.unifiedLogin(
      loginForm.value.phone,
      loginForm.value.password,
      tenant.tenantCode
    )

    await processLoginSuccessRedirect()
  } catch (error: any) {
    console.error('âŒ ç§Ÿæˆ·é€‰æ‹©å¤±è´¥:', error)
    ElMessage.error(error.message || 'ç§Ÿæˆ·é€‰æ‹©å¤±è´¥')
  }
}

// æ³¨å†ŒæˆåŠŸå¤„ç†
const onRegistrationSuccess = async () => {
  console.log('âœ… æ³¨å†ŒæˆåŠŸï¼Œç»§ç»­ç™»å½•æµç¨‹')
  showRoleSelection.value = false

  // æ³¨å†ŒæˆåŠŸåï¼ŒauthStore å·²ç»æ›´æ–°äº†ç”¨æˆ·ä¿¡æ¯å’Œ token
  // ç›´æ¥æ‰§è¡Œç™»å½•æˆåŠŸåçš„é‡å®šå‘
  await processLoginSuccessRedirect()
}

// æ³¨å†Œå–æ¶ˆå¤„ç†
const onRegistrationCancel = () => {
  console.log('âŒ ç”¨æˆ·å–æ¶ˆæ³¨å†Œ')
  showRoleSelection.value = false
  ElMessage.info('æ‚¨å·²å–æ¶ˆæ³¨å†Œï¼Œè¯·é‡æ–°ç™»å½•')
}

// ç™»å½•æˆåŠŸåçš„é‡å®šå‘å¤„ç†
const processLoginSuccessRedirect = async () => {
  // æ„å»ºç”¨æˆ·ä¿¡æ¯ï¼ˆå…¼å®¹ç°æœ‰ç³»ç»Ÿï¼‰
  const currentUser = authStore.user
  const userInfo = {
    token: authStore.token,
    username: currentUser?.username || '',
    displayName: currentUser?.realName || currentUser?.username || '',
    role: currentUser?.role?.toLowerCase() || 'user',
    roles: currentUser?.roles || [currentUser?.role],
    permissions: currentUser?.permissions || [],
    email: currentUser?.email,
    avatar: currentUser?.avatar,
    id: currentUser?.id,
    isAdmin: currentUser?.role === 'admin',
    kindergartenId: currentUser?.kindergartenId,
    status: 'active',
    // ç»Ÿä¸€è®¤è¯æ‰©å±•ä¿¡æ¯
    isUnifiedAuth: authStore.isUnifiedAuth,
    globalUserId: authStore.globalUserId,
    currentTenant: authStore.currentTenant
  }

  console.log('ğŸ’¾ ä¿å­˜ç»Ÿä¸€è®¤è¯ç”¨æˆ·ä¿¡æ¯åˆ°store:', userInfo)
  // æ¸…é™¤æ—§çš„æƒé™æ•°æ®ï¼Œç¡®ä¿è§’è‰²åˆ‡æ¢æ—¶æƒé™æ­£ç¡®æ›´æ–°
  permissionsStore.clearPermissions()
  userStore.setUserInfo(userInfo)

  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
  localStorage.setItem('userInfo', JSON.stringify(userInfo))
  localStorage.setItem('kindergarten_user_info', JSON.stringify(userInfo))

  ElMessage.success(`æ¬¢è¿å›æ¥ï¼Œ${userInfo.displayName}ï¼`)

  // å¤„ç†é‡å®šå‘
  let redirectUrl = route.query.redirect as string

  if (!redirectUrl) {
    const { getLoginRedirectPath } = await import('@/router/smart-redirect')
    const { getActualDeviceType } = await import('@/utils/device-detect')

    const userRole = userInfo.role?.toLowerCase() as any
    const deviceType = getActualDeviceType()

    redirectUrl = getLoginRedirectPath(userRole)

    console.log('ğŸ¯ æ™ºèƒ½è·¯ç”±é‡å®šå‘:')
    console.log('  - ç”¨æˆ·è§’è‰²:', userRole)
    console.log('  - è®¾å¤‡ç±»å‹:', deviceType)
    console.log('  - è·³è½¬è·¯å¾„:', redirectUrl)
  }

  console.log('ğŸ”€ å‡†å¤‡è·³è½¬åˆ°:', redirectUrl)

  // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ Pinia çŠ¶æ€å®Œå…¨åŒæ­¥åå†è¿›è¡Œè·¯ç”±è·³è½¬
  await nextTick()
  
  // éªŒè¯ç™»å½•çŠ¶æ€æ˜¯å¦æ­£ç¡®è®¾ç½®
  console.log('ğŸ” éªŒè¯ç»Ÿä¸€è®¤è¯ç™»å½•çŠ¶æ€:', {
    isLoggedIn: userStore.isLoggedIn,
    hasToken: !!userStore.token,
    hasUserInfo: !!userStore.user,
    username: userStore.user?.username
  })
  
  if (!userStore.isLoggedIn) {
    console.error('âŒ ç»Ÿä¸€è®¤è¯ç™»å½•çŠ¶æ€è®¾ç½®å¤±è´¥ï¼Œå°è¯•é‡æ–°è®¾ç½®...')
    await new Promise(resolve => setTimeout(resolve, 50))
    
    if (!userStore.isLoggedIn) {
      console.error('âŒ ç»Ÿä¸€è®¤è¯ç™»å½•çŠ¶æ€ä»ç„¶æ— æ•ˆ')
      ElMessage.error('ç™»å½•çŠ¶æ€è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•')
      return
    }
  }

  // æ˜¾ç¤ºç³»ç»Ÿå…¥åœºåŠ¨ç”»ï¼Œç„¶åè·³è½¬
  console.log('ğŸ¬ ç™»å½•æˆåŠŸï¼Œå¼€å§‹æ˜¾ç¤ºç³»ç»Ÿå…¥åœºåŠ¨ç”»')
  showEntranceAnimation.value = true
  setEntranceAnimationActive(true)

  await new Promise(resolve => setTimeout(resolve, 100))

  console.log('ğŸ¬ åŠ¨ç”»å¼€å§‹ï¼Œæ‰§è¡Œè·¯ç”±è·³è½¬')
  try {
    await router.replace(redirectUrl)
    console.log('âœ… é¡µé¢è·³è½¬å®Œæˆ')
    showEntranceAnimation.value = false
    setEntranceAnimationActive(false)
  } catch (error) {
    console.error('âŒ è·¯ç”±è·³è½¬å¤±è´¥:', error)
    showEntranceAnimation.value = false
    setEntranceAnimationActive(false)
  }
}

// å¤„ç†ç™»å½•é”™è¯¯
const handleLoginError = (error: any) => {
  let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•'

  if (error.response?.data?.message) {
    errorMessage = error.response.data.message
  } else if (error.message) {
    errorMessage = error.message
  }

  // é˜²æ­¢é‡å¤æ˜¾ç¤ºç›¸åŒçš„é”™è¯¯æ¶ˆæ¯ï¼ˆ5ç§’å†…ä¸é‡å¤æ˜¾ç¤ºç›¸åŒæ¶ˆæ¯ï¼‰
  const now = Date.now()
  if (lastErrorMessage.value === errorMessage && now - lastErrorMessageTime.value < 5000) {
    // å¦‚æœæ˜¯ç›¸åŒé”™è¯¯æ¶ˆæ¯ä¸”åœ¨5ç§’å†…ï¼Œåˆ™åªæ›´æ–°å…¨å±€é”™è¯¯çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºElMessage
    globalError.value = errorMessage
    return
  }

  // æ›´æ–°æœ€åé”™è¯¯æ¶ˆæ¯å’Œæ—¶é—´
  lastErrorMessage.value = errorMessage
  lastErrorMessageTime.value = now

  globalError.value = errorMessage
  ElMessage.error(errorMessage)

  console.error('Error details:', error)
}

// å¿«æ·ç™»å½•ï¼ˆä½¿ç”¨çœŸå®åç«¯APIï¼‰
const quickLogin = async (role: string) => {
  console.log('âš¡ å¿«æ·ç™»å½•:', role)
  loading.value = true
  setGlobalLoading(true)

  try {
    // æ ¹æ®è§’è‰²ç¡®å®šç”¨æˆ·å
    const usernameMap: Record<string, string> = {
      admin: 'test_admin',
      principal: 'principal',
      teacher: 'teacher',
      parent: 'test_parent' // ä½¿ç”¨test_parentï¼Œå› ä¸ºè¿™ä¸ªç”¨æˆ·åœ¨æ•°æ®åº“ä¸­æœ‰å¯¹åº”çš„ç…§ç‰‡æ•°æ®
    }

    const username = usernameMap[role] || role
    const password = '123456' // é»˜è®¤å¯†ç 

    console.log(`ğŸ” è°ƒç”¨çœŸå®ç™»å½•API: ${username}`)

    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä½¿ç”¨ç”¨æˆ·åç™»å½•æ¨¡å¼
    loginMode.value = 0
    loginForm.value.username = username
    loginForm.value.password = password

    // è°ƒç”¨ç™»å½•å¤„ç†å‡½æ•°
    await handleLogin()
  } catch (error: any) {
    console.error('âŒ å¿«æ·ç™»å½•å¤±è´¥:', error)
    ElMessage.error(error.message || 'ç™»å½•å¤±è´¥')
    loading.value = false
    setGlobalLoading(false)
  }
}

// å›¾ç‰‡é”™è¯¯å¤„ç†
const handleImageError = (event: Event) => {
  const target = event.target as HTMLImageElement
  if (target) {
    target.style.display = 'none'
    const parent = target.parentElement
    if (parent) {
      parent.innerHTML = '<div class="logo-fallback">ğŸ«</div>'
    }
  }
}

// å…¥åœºåŠ¨ç”»å®Œæˆå¤„ç†
let resolveAnimationComplete: (() => void) | null = null

const onEntranceAnimationComplete = () => {
  console.log('ğŸ¬ ç™»å½•å…¥åœºåŠ¨ç”»å®Œæˆ')
  showEntranceAnimation.value = false
  setEntranceAnimationActive(false)

  if (resolveAnimationComplete) {
    resolveAnimationComplete()
    resolveAnimationComplete = null
  }
}

// ç»„ä»¶æŒ‚è½½æ—¶çš„åˆå§‹åŒ–
onMounted(() => {
  console.log('ğŸ”§ ç™»å½•é¡µé¢åˆå§‹åŒ–')
  console.log('ç¯å¢ƒä¿¡æ¯:', {
    mode: import.meta.env.MODE,
    dev: import.meta.env.DEV,
    redirectUrl: route.query.redirect
  })

  // åˆå§‹åŒ–è®¾è®¡ä»¤ç‰Œå’ŒåŠ¨ç”»é…ç½®CSSå˜é‡
  DesignTokenManager.applyCSSVariables()
  AnimationConfigManager.applyCSSVariables()

  // æ¢å¤ä¸»é¢˜è®¾ç½®
  const savedTheme = localStorage.getItem('theme')
  if (savedTheme) {
    console.log('ğŸ¨ åº”ç”¨ä¿å­˜çš„ä¸»é¢˜:', savedTheme)

    // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
    const allThemes = ['theme-light', 'theme-dark', 'glass-light', 'glass-dark', 'glass-neon', 'glass-gradient']
    document.documentElement.classList.remove(...allThemes)
    document.body.classList.remove(...allThemes)
    document.documentElement.removeAttribute('data-theme')
    document.body.removeAttribute('data-theme')

    // åº”ç”¨ä¸»é¢˜
    if (savedTheme.startsWith('glass-')) {
      document.documentElement.setAttribute('data-theme', savedTheme)
      document.body.setAttribute('data-theme', savedTheme)
      document.documentElement.classList.add(savedTheme)
      document.body.classList.add(savedTheme)
    } else {
      document.documentElement.classList.add(savedTheme)
      document.body.classList.add(savedTheme)
    }
  } else {
    // é»˜è®¤åº”ç”¨æ˜äº®ä¸»é¢˜
    document.documentElement.classList.add('theme-light')
    document.body.classList.add('theme-light')
  }

  // ğŸ”‘ æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æ¥è‡ªç»Ÿä¸€è®¤è¯çš„å›è°ƒ
  console.log('ğŸ” æ£€æŸ¥ç»Ÿä¸€è®¤è¯å›è°ƒ...')
  const hasToken = handleUnifiedAuthCallback()
  if (hasToken) {
    console.log('âœ… å·²å¤„ç†ç»Ÿä¸€è®¤è¯å›è°ƒï¼Œåœæ­¢åç»­åˆå§‹åŒ–')
    return
  }

  // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•ï¼ˆæ”¯æŒä¼ ç»Ÿè®¤è¯å’Œç»Ÿä¸€è®¤è¯ï¼‰
  const isLoggedIn = userStore.isLoggedIn || authStore.isAuthenticated
  if (isLoggedIn) {
    console.log('ğŸ‘¤ ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨è·³è½¬')
    console.log('  - ä¼ ç»Ÿè®¤è¯çŠ¶æ€:', userStore.isLoggedIn)
    console.log('  - ç»Ÿä¸€è®¤è¯çŠ¶æ€:', authStore.isAuthenticated)
    console.log('  - ç»Ÿä¸€è®¤è¯æ¨¡å¼:', authStore.isUnifiedAuth)

    let redirectUrl = route.query.redirect as string

    if (!redirectUrl) {
      // ä¼˜å…ˆä½¿ç”¨ç»Ÿä¸€è®¤è¯çš„ç”¨æˆ·è§’è‰²ï¼Œå¦åˆ™ä½¿ç”¨ä¼ ç»Ÿè®¤è¯çš„è§’è‰²
      const userRole = (authStore.user?.role || userStore.userInfo?.role)?.toLowerCase()
      console.log('ğŸ¯ æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·è§’è‰²:', userRole)

      switch (userRole) {
        case 'teacher':
          redirectUrl = '/teacher-center/dashboard'
          break
        case 'parent':
          redirectUrl = '/parent-center/dashboard'
          break
        case 'admin':
        case 'super_admin':
        case 'principal':
        default:
          redirectUrl = '/'
          break
      }
    }

    router.replace(redirectUrl)
    return
  }

  // ğŸš€ æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
  const currentHostname = typeof window !== 'undefined' ? window.location.hostname : ''
  const isDemoSystem = ['localhost', '127.0.0.1', 'k.yyup.cc', 'k.yyup.com'].includes(currentHostname)

  if (isDemoSystem) {
    console.log('ğŸ  Demoç³»ç»Ÿç¯å¢ƒï¼Œä½¿ç”¨æœ¬åœ°è®¤è¯ï¼Œä¸é‡å®šå‘åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ')
    // Demoæ¨¡å¼ï¼šæ˜¾ç¤ºæœ¬åœ°ç™»å½•è¡¨å•ï¼Œä¸é‡å®šå‘
  } else {
    console.log('âš ï¸ éDemoç¯å¢ƒä¸”æœªç™»å½•ï¼Œéœ€è¦é‡å®šå‘åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ')
    redirectToUnifiedAuth()
  }
})
</script>

<style lang="scss" scoped>
// å¯¼å…¥ç‹¬ç«‹æ ·å¼æ–‡ä»¶
@use './login-styles.scss' as *;


</style>