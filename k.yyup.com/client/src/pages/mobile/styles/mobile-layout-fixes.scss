/**
 * 移动端排版修复样式
 * Mobile Layout Fix Styles
 *
 * 修复移动端列表、字段和卡片排版问题
 * Fix mobile list, field and card layout issues
 */

// 导入设计令牌
@use '@/styles/design-tokens.scss' as *;

// ==================== 移动端统一排版系统 ====================
// Mobile Unified Typography System

// 移动端响应式字体大小
@mixin mobile-fluid-font($min-size, $max-size, $min-vw: 320, $max-vw: 768) {
  font-size: $min-size;

  @media (min-width: $min-vw) and (max-width: $max-vw) {
    font-size: calc(
      #{$min-size} + #{strip-unit($max-size - $min-size)} *
      (100vw - #{$min-vw}) / #{strip-unit($max-vw - $min-vw)}
    );
  }

  @media (min-width: $max-vw) {
    font-size: $max-size;
  }
}

// 去除单位的辅助函数
@function strip-unit($number) {
  @if type-of($number) == 'number' and not unitless($number) {
    @return $number / ($number * 0 + 1);
  }
  @return $number;
}

// ==================== 移动端卡片系统修复 ====================
// Mobile Card System Fixes

.mobile-card-fixed {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color-light);
  transition: var(--transition-base);
  overflow: hidden; // 防止内容溢出
  word-wrap: break-word; // 长单词换行
  word-break: break-all; // 强制换行

  // 卡片标题统一处理
  .card-title {
    @include mobile-fluid-font(16px, 18px);
    font-weight: var(--font-semibold);
    color: var(--mobile-text-primary);
    margin-bottom: var(--spacing-sm);
    line-height: var(--leading-tight);
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);

    .van-icon {
      color: var(--primary-color);
      flex-shrink: 0;
    }

    .van-tag {
      margin-left: auto;
      flex-shrink: 0;
    }
  }

  // 卡片内容统一处理
  .card-content {
    @include mobile-fluid-font(14px, 15px);
    color: var(--mobile-text-secondary);
    line-height: var(--leading-relaxed);

    // 防止文字溢出
    .text-ellipsis {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .text-ellipsis-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .text-ellipsis-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }

  // 卡片元信息
  .card-meta {
    @include mobile-fluid-font(12px, 13px);
    color: var(--mobile-text-tertiary);
    margin-top: var(--spacing-sm);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--border-color-light);

    .meta-item {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-xs);

      &:last-child {
        margin-bottom: 0;
      }

      .meta-label {
        min-width: 60px;
        margin-right: var(--spacing-xs);
        font-weight: var(--font-medium);
      }

      .meta-value {
        flex: 1;
        word-break: break-all;
      }
    }
  }

  // 触摸效果
  &:active {
    transform: scale(0.98);
  }

  // 小屏幕适配
  @media (max-width: 479px) {
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-xs);
    border-radius: var(--radius-md);

    .card-title {
      @include mobile-fluid-font(15px, 16px);
      margin-bottom: var(--spacing-xs);
    }

    .card-content {
      @include mobile-fluid-font(13px, 14px);
    }

    .card-meta {
      @include mobile-fluid-font(11px, 12px);
    }
  }

  // 大屏幕适配
  @media (min-width: 768px) {
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    border-radius: var(--radius-xl);

    .card-title {
      @include mobile-fluid-font(17px, 19px);
    }

    .card-content {
      @include mobile-fluid-font(15px, 16px);
    }

    .card-meta {
      @include mobile-fluid-font(13px, 14px);
    }
  }
}

// ==================== 移动端列表系统修复 ====================
// Mobile List System Fixes

.mobile-list-fixed {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  overflow: hidden;
  margin-bottom: var(--spacing-md);

  // 列表项统一处理
  .list-item {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-color-light);
    transition: var(--transition-fast);
    position: relative;
    min-height: 60px; // 确保触摸目标足够大

    &:last-child {
      border-bottom: none;
    }

    // 列表项内容
    .item-content {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      width: 100%;

      // 图标区域
      .item-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        background: var(--primary-light-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;

        .van-icon {
          color: var(--primary-color);
          font-size: var(--text-lg);
        }
      }

      // 文本区域
      .item-text {
        flex: 1;
        min-width: 0; // 允许文本收缩

        .item-title {
          @include mobile-fluid-font(15px, 16px);
          font-weight: var(--font-medium);
          color: var(--mobile-text-primary);
          margin-bottom: var(--spacing-xs);
          line-height: var(--leading-tight);
          word-break: break-word;

          // 标题溢出处理
          &.title-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }

          &.title-ellipsis-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }
        }

        .item-description {
          @include mobile-fluid-font(13px, 14px);
          color: var(--mobile-text-secondary);
          line-height: var(--leading-normal);
          word-break: break-word;

          // 描述溢出处理
          &.desc-ellipsis {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
          }
        }

        .item-meta {
          @include mobile-fluid-font(12px, 13px);
          color: var(--mobile-text-tertiary);
          margin-top: var(--spacing-xs);
          display: flex;
          align-items: center;
          gap: var(--spacing-md);
          flex-wrap: wrap;

          .meta-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            background: var(--bg-secondary);
            padding: 2px var(--spacing-xs);
            border-radius: var(--radius-sm);
          }
        }
      }

      // 右侧操作区域
      .item-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--spacing-xs);
        flex-shrink: 0;

        .item-status {
          .van-tag {
            flex-shrink: 0;
          }
        }

        .item-buttons {
          display: flex;
          gap: var(--spacing-xs);

          .van-button {
            min-width: 60px;
          }
        }
      }
    }

    // 触摸效果
    &:active {
      background: var(--bg-hover);
    }

    // 小屏幕适配
    @media (max-width: 479px) {
      padding: var(--spacing-sm) var(--spacing-xs);
      min-height: 56px;

      .item-content {
        gap: var(--spacing-sm);

        .item-icon {
          width: 36px;
          height: 36px;

          .van-icon {
            font-size: var(--text-base);
          }
        }

        .item-text {
          .item-title {
            @include mobile-fluid-font(14px, 15px);
          }

          .item-description {
            @include mobile-fluid-font(12px, 13px);
          }

          .item-meta {
            @include mobile-fluid-font(11px, 12px);
            gap: var(--spacing-sm);
          }
        }

        .item-actions {
          .item-buttons {
            .van-button {
              min-width: 50px;
              font-size: var(--text-xs);
            }
          }
        }
      }
    }

    // 大屏幕适配
    @media (min-width: 768px) {
      padding: var(--spacing-lg);
      min-height: 68px;

      .item-content {
        .item-icon {
          width: 44px;
          height: 44px;

          .van-icon {
            font-size: var(--text-xl);
          }
        }

        .item-text {
          .item-title {
            @include mobile-fluid-font(16px, 17px);
          }

          .item-description {
            @include mobile-fluid-font(14px, 15px);
          }

          .item-meta {
            @include mobile-fluid-font(13px, 14px);
          }
        }
      }
    }
  }
}

// ==================== 移动端统计卡片网格修复 ====================
// Mobile Statistics Grid Cards Fix

.mobile-stats-grid-fixed {
  display: grid;
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-md);

  // 2列布局（默认）
  &.cols-2 {
    grid-template-columns: repeat(2, 1fr);
  }

  // 3列布局
  &.cols-3 {
    grid-template-columns: repeat(3, 1fr);

    @media (max-width: 479px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  // 4列布局
  &.cols-4 {
    grid-template-columns: repeat(4, 1fr);

    @media (max-width: 479px) {
      grid-template-columns: repeat(2, 1fr);
    }

    @media (max-width: 600px) {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  // 统计卡片项
  .stat-item {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
    text-align: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color-light);
    transition: var(--transition-base);
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 80px;

    .stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--spacing-xs);
      background: var(--primary-light-bg);

      .van-icon {
        color: var(--primary-color);
        font-size: var(--text-lg);
      }
    }

    .stat-value {
      @include mobile-fluid-font(18px, 22px);
      font-weight: var(--font-bold);
      color: var(--mobile-text-primary);
      margin-bottom: var(--spacing-xs);
      line-height: 1;
    }

    .stat-label {
      @include mobile-fluid-font(11px, 12px);
      color: var(--mobile-text-tertiary);
      line-height: var(--leading-tight);
      word-break: break-word;
    }

    // 触摸效果
    &:active {
      transform: scale(0.95);
    }

    // 小屏幕适配
    @media (max-width: 479px) {
      padding: var(--spacing-sm);
      min-height: 70px;

      .stat-icon {
        width: 32px;
        height: 32px;
        margin-bottom: var(--spacing-xs);

        .van-icon {
          font-size: var(--text-base);
        }
      }

      .stat-value {
        @include mobile-fluid-font(16px, 18px);
      }

      .stat-label {
        @include mobile-fluid-font(10px, 11px);
      }
    }

    // 大屏幕适配
    @media (min-width: 768px) {
      padding: var(--spacing-lg);
      min-height: 90px;

      .stat-icon {
        width: 40px;
        height: 40px;

        .van-icon {
          font-size: var(--text-xl);
        }
      }

      .stat-value {
        @include mobile-fluid-font(20px, 24px);
      }

      .stat-label {
        @include mobile-fluid-font(12px, 13px);
      }
    }
  }
}

// ==================== 移动端表单布局修复 ====================
// Mobile Form Layout Fixes

.mobile-form-fixed {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-md);

  .form-group {
    margin-bottom: var(--spacing-md);

    &:last-child {
      margin-bottom: 0;
    }

    .form-label {
      @include mobile-fluid-font(14px, 15px);
      font-weight: var(--font-medium);
      color: var(--mobile-text-primary);
      margin-bottom: var(--spacing-xs);
      display: block;
    }

    .form-field {
      // Vant字段组件覆盖
      :deep(.van-field) {
        .van-field__label {
          @include mobile-fluid-font(14px, 15px);
          font-weight: var(--font-medium);
        }

        .van-field__value {
          .van-field__control {
            @include mobile-fluid-font(14px, 15px);
          }
        }
      }
    }

    .form-actions {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);

      .van-button {
        flex: 1;
        min-height: 44px; // iOS触摸目标最小尺寸

        .van-button__text {
          @include mobile-fluid-font(14px, 15px);
        }
      }
    }
  }

  // 小屏幕适配
  @media (max-width: 479px) {
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);

    .form-group {
      margin-bottom: var(--spacing-sm);

      .form-label {
        @include mobile-fluid-font(13px, 14px);
      }

      .form-actions {
        gap: var(--spacing-xs);
        margin-top: var(--spacing-sm);

        .van-button {
          min-height: 40px;

          .van-button__text {
            @include mobile-fluid-font(13px, 14px);
          }
        }
      }
    }
  }
}

// ==================== 移动端底部安全区域处理 ====================
// Mobile Bottom Safe Area Handling

.mobile-bottom-safe {
  padding-bottom: max(
    var(--spacing-xl),
    env(safe-area-inset-bottom),
    60px // 为底部导航栏预留空间
  );
}

.mobile-bottom-safe-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card-bg);
  border-top: 1px solid var(--border-color-light);
  padding: var(--spacing-md);
  padding-bottom: max(
    var(--spacing-md),
    env(safe-area-inset-bottom)
  );
  z-index: var(--z-footer);
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

// ==================== 移动端横屏适配 ====================
// Mobile Landscape Orientation Adaptation

@media screen and (orientation: landscape) and (max-height: 600px) {
  .mobile-card-fixed,
  .mobile-form-fixed {
    padding: var(--spacing-sm) var(--spacing-md);
    margin-bottom: var(--spacing-xs);
  }

  .mobile-list-fixed .list-item {
    padding: var(--spacing-xs) var(--spacing-sm);
    min-height: 48px;

    .item-content {
      .item-text {
        .item-title {
          @include mobile-fluid-font(14px, 15px);
          margin-bottom: 2px;
        }

        .item-description {
          display: none; // 横屏时隐藏描述以节省空间
        }
      }
    }
  }

  .mobile-stats-grid-fixed .stat-item {
    padding: var(--spacing-xs);
    min-height: 60px;

    .stat-icon {
      width: 28px;
      height: 28px;
      margin-bottom: 2px;

      .van-icon {
        font-size: var(--text-sm);
      }
    }

    .stat-value {
      @include mobile-fluid-font(16px, 18px);
      margin-bottom: 2px;
    }

    .stat-label {
      @include mobile-fluid-font(10px, 11px);
    }
  }
}

// ==================== 超小屏幕适配 ====================
// Extra Small Screen Adaptation (iPhone SE, etc.)

@media (max-width: 374px) {
  .mobile-card-fixed {
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);

    .card-title {
      @include mobile-fluid-font(14px, 15px);
    }

    .card-content {
      @include mobile-fluid-font(13px, 14px);
    }
  }

  .mobile-list-fixed .list-item {
    padding: var(--spacing-xs);
    min-height: 52px;

    .item-content {
      gap: var(--spacing-xs);

      .item-icon {
        width: 32px;
        height: 32px;

        .van-icon {
          font-size: var(--text-sm);
        }
      }

      .item-text {
        .item-title {
          @include mobile-fluid-font(13px, 14px);
        }

        .item-description {
          @include mobile-fluid-font(12px, 13px);
        }

        .item-meta {
          @include mobile-fluid-font(10px, 11px);
        }
      }
    }
  }

  .mobile-stats-grid-fixed {
    gap: var(--spacing-xs);

    .stat-item {
      padding: var(--spacing-xs);
      min-height: 60px;

      .stat-icon {
        width: 28px;
        height: 28px;

        .van-icon {
          font-size: var(--text-sm);
        }
      }

      .stat-value {
        @include mobile-fluid-font(14px, 16px);
      }

      .stat-label {
        @include mobile-fluid-font(9px, 10px);
      }
    }
  }
}