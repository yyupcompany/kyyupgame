<template>
  <UnifiedCenterLayout
    title="äº’åŠ¨AIè¯¾ç¨‹ç”Ÿæˆå™¨"
    description="âœ¨ ä¸€é”®ç”Ÿæˆç²¾ç¾äº’åŠ¨è¯¾ç¨‹ | åŒ…å«ä»£ç ã€å›¾ç‰‡ã€è§†é¢‘"
    icon="Sparkles"
    :show-breadcrumb="false"
  >
    <!-- é¡µé¢å¤´éƒ¨æ“ä½œåŒº -->
    <template #header-actions>
      <el-button @click="goBack" size="small">
        <UnifiedIcon name="ArrowLeft" />
        è¿”å›åˆ—è¡¨
      </el-button>
      <el-tag type="success">AI é©±åŠ¨</el-tag>
      <el-tag type="info">å¿«é€Ÿç”Ÿæˆ</el-tag>
    </template>

  <div class="interactive-curriculum-container">

    <!-- ä¸»å®¹å™¨ - å·¦å³å¸ƒå±€ -->
    <div class="icc-main">
      <!-- å·¦ä¾§ï¼šè¾“å…¥è¡¨å•åŒºåŸŸ -->
      <div class="left-panel">
        <!-- æ¬¢è¿å¡ç‰‡ - é¦–æ¬¡è®¿é—®æ˜¾ç¤º -->
        <div v-if="showWelcome" class="welcome-card">
          <div class="welcome-content">
            <div class="welcome-icon">ğŸ“</div>
            <h2>æ¬¢è¿ä½¿ç”¨è¯¾ç¨‹ç”Ÿæˆå™¨</h2>
            <p>åªéœ€ç®€å•æè¿°ä½ æƒ³è¦çš„è¯¾ç¨‹ï¼ŒAI å°†ä¸ºä½ ç”Ÿæˆå®Œæ•´çš„äº’åŠ¨æ•™å­¦å†…å®¹</p>

            <!-- å¿«é€Ÿå¼€å§‹æ­¥éª¤ -->
            <div class="quick-start-steps">
              <div class="step">
                <div class="step-number">1ï¸âƒ£</div>
                <div class="step-content">
                  <h4>æè¿°è¯¾ç¨‹</h4>
                  <p>å‘Šè¯‰æˆ‘ä»¬ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„è¯¾ç¨‹</p>
                </div>
              </div>
              <div class="step">
                <div class="step-number">2ï¸âƒ£</div>
                <div class="step-content">
                  <h4>é€‰æ‹©é¢†åŸŸ</h4>
                  <p>é€‰æ‹©è¯¾ç¨‹æ‰€å±çš„æ•™å­¦é¢†åŸŸ</p>
                </div>
              </div>
              <div class="step">
                <div class="step-number">3ï¸âƒ£</div>
                <div class="step-content">
                  <h4>AI ç”Ÿæˆ</h4>
                  <p>AI è‡ªåŠ¨ç”Ÿæˆä»£ç ã€å›¾ç‰‡å’Œè§†é¢‘</p>
                </div>
              </div>
            </div>

            <!-- ç¤ºä¾‹æç¤º -->
            <div class="tips-section">
              <h4>ğŸ’¡ ç‚¹å‡»å¿«é€Ÿå¡«å……ç¤ºä¾‹</h4>
              <div class="tips-list">
                <div class="tip-item" @click="fillExample('ç”Ÿæˆä¸€ä¸ªå…³äºã€Šæ˜¥æ™“ã€‹å¤è¯—çš„äº’åŠ¨è¯¾ç¨‹ï¼Œé€‚åˆä¸­ç­å¹¼å„¿ï¼ŒåŒ…å«å¡é€šé£æ ¼çš„å›¾ç‰‡å’Œæœ—è¯»äº’åŠ¨')">
                  <span class="tip-icon">ğŸ“–</span>
                  <span>å¤è¯—å­¦ä¹ è¯¾ç¨‹</span>
                </div>
                <div class="tip-item" @click="fillExample('åˆ›å»ºä¸€ä¸ªæ•°å­—1-10è®¤çŸ¥çš„äº’åŠ¨æ¸¸æˆè¯¾ç¨‹ï¼Œé€‚åˆå°ç­å¹¼å„¿ï¼ŒåŒ…å«æ•°æ•°å­æ¸¸æˆå’Œæ‹–æ‹½æ’åº')">
                  <span class="tip-icon">ğŸ”¢</span>
                  <span>æ•°å­—è®¤çŸ¥æ¸¸æˆ</span>
                </div>
                <div class="tip-item" @click="fillExample('è®¾è®¡ä¸€ä¸ªè®¤è¯†å°åŠ¨ç‰©çš„äº’åŠ¨è¯¾ç¨‹ï¼ŒåŒ…æ‹¬å°çŒ«ã€å°ç‹—ã€å°å…”å­ï¼Œé€‚åˆæ‰˜ç­å¹¼å„¿ï¼Œé…åˆå¯çˆ±å¡é€šå›¾ç‰‡')">
                  <span class="tip-icon">ğŸ¾</span>
                  <span>è®¤è¯†å°åŠ¨ç‰©</span>
                </div>
                <div class="tip-item" @click="fillExample('åˆ›å»ºä¸€ä¸ªå®‰å…¨æ•™è‚²è¯¾ç¨‹ï¼Œæ•™å¹¼å„¿è®¤è¯†äº¤é€šæ ‡å¿—å’Œè¿‡é©¬è·¯è§„åˆ™ï¼Œé€‚åˆå¤§ç­å¹¼å„¿')">
                  <span class="tip-icon">ğŸš¦</span>
                  <span>å®‰å…¨æ•™è‚²</span>
                </div>
                <div class="tip-item" @click="fillExample('è®¾è®¡ä¸€ä¸ªè®¤è¯†é¢œè‰²çš„äº’åŠ¨è¯¾ç¨‹ï¼ŒåŒ…å«çº¢é»„è“ç»¿ç­‰åŸºç¡€è‰²ï¼Œé€šè¿‡æ¸¸æˆå­¦ä¹ é¢œè‰²åç§°')">
                  <span class="tip-icon">ğŸ¨</span>
                  <span>è®¤è¯†é¢œè‰²</span>
                </div>
                <div class="tip-item" @click="fillExample('åˆ›å»ºä¸€ä¸ªå¥åº·é¥®é£Ÿä¹ æƒ¯çš„äº’åŠ¨è¯¾ç¨‹ï¼Œæ•™å¹¼å„¿è®¤è¯†æ°´æœå’Œè”¬èœï¼ŒåŸ¹å…»ä¸æŒ‘é£Ÿçš„å¥½ä¹ æƒ¯')">
                  <span class="tip-icon">ğŸ¥¦</span>
                  <span>å¥åº·é¥®é£Ÿ</span>
                </div>
              </div>
            </div>

            <!-- å¼€å§‹æŒ‰é’® -->
            <div class="welcome-actions">
              <el-button type="primary" size="large" @click="startCreating">
                ğŸš€ å¼€å§‹åˆ›å»ºè¯¾ç¨‹
              </el-button>
            </div>
          </div>
        </div>

        <!-- è¾“å…¥è¡¨å•å¡ç‰‡ -->
        <div v-else class="input-card">
          <div class="input-header">
            <h3>ğŸ“ è¯¾ç¨‹éœ€æ±‚</h3>
            <p v-if="!isGenerating && !generationComplete">è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯æ¥ç”Ÿæˆä½ çš„è¯¾ç¨‹</p>
            <p v-else-if="isGenerating" class="generating-text">æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>
          </div>

          <div class="input-form">
            <!-- è¯¾ç¨‹æè¿° -->
            <div class="form-group">
              <label>è¯¾ç¨‹æè¿° <span class="required">*</span></label>
              <el-input
                v-model="prompt"
                type="textarea"
                :rows="4"
                placeholder="ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ä¸ªè®¤è¯†å°çŒ«å’ªçš„äº’åŠ¨è¯¾ç¨‹ï¼Œé€‚åˆ4-5å²å¹¼å„¿ï¼ŒåŒ…å«å¡é€šé£æ ¼çš„å›¾ç‰‡å’ŒåŠ¨ç”»è§†é¢‘"
                :disabled="isGenerating"
                maxlength="500"
                show-word-limit
              />
              <div class="form-hint">ğŸ’¡ æç¤ºï¼šæè¿°è¶Šè¯¦ç»†ï¼Œç”Ÿæˆçš„è¯¾ç¨‹è´¨é‡è¶Šå¥½</div>
            </div>

            <!-- è¯¾ç¨‹é¢†åŸŸ -->
            <div class="form-group">
              <label>è¯¾ç¨‹é¢†åŸŸ <span class="required">*</span></label>
              <el-select
                v-model="selectedDomain"
                placeholder="é€‰æ‹©è¯¾ç¨‹æ‰€å±çš„æ•™å­¦é¢†åŸŸ"
                :disabled="isGenerating"
                style="width: 100%"
              >
                <el-option label="ğŸƒ å¥åº·é¢†åŸŸ" value="health" />
                <el-option label="ğŸ’¬ è¯­è¨€é¢†åŸŸ" value="language" />
                <el-option label="ğŸ‘¥ ç¤¾ä¼šé¢†åŸŸ" value="social" />
                <el-option label="ğŸ”¬ ç§‘å­¦é¢†åŸŸ" value="science" />
                <el-option label="ğŸ¨ è‰ºæœ¯é¢†åŸŸ" value="art" />
              </el-select>
            </div>

            <!-- å¹´é¾„æ®µ -->
            <div class="form-group">
              <label>å¹´é¾„æ®µ <span class="required">*</span></label>
              <el-select
                v-model="ageGroup"
                placeholder="é€‰æ‹©é€‚åˆçš„å¹´é¾„æ®µ"
                :disabled="isGenerating"
                style="width: 100%"
              >
                <el-option label="ğŸ‘¶ æ‰˜ç­ (2-3å²)" value="æ‰˜ç­(2-3å²)" />
                <el-option label="ğŸŒ± å°ç­ (3-4å²)" value="å°ç­(3-4å²)" />
                <el-option label="ğŸŒ¿ ä¸­ç­ (4-5å²)" value="ä¸­ç­(4-5å²)" />
                <el-option label="ğŸŒ³ å¤§ç­ (5-6å²)" value="å¤§ç­(5-6å²)" />
              </el-select>
              <div class="form-hint">ğŸ’¡ æç¤ºï¼šAIå°†æ ¹æ®å¹´é¾„æ®µè°ƒæ•´å†…å®¹éš¾åº¦å’Œäº’åŠ¨æ–¹å¼</div>
            </div>

            <!-- ğŸ¨ åª’ä½“ç”Ÿæˆé€‰é¡¹ -->
            <div class="form-group media-options">
              <label>åª’ä½“é€‰é¡¹</label>
              <div class="media-options-grid">
                <el-checkbox 
                  v-model="enableImage" 
                  :disabled="isGenerating"
                  class="media-option"
                >
                  <div class="option-content">
                    <span class="option-icon">ğŸ–¼ï¸</span>
                    <span class="option-label">ç”Ÿæˆå›¾ç‰‡</span>
                  </div>
                </el-checkbox>
                <el-checkbox 
                  v-model="enableVoice" 
                  :disabled="isGenerating"
                  class="media-option"
                >
                  <div class="option-content">
                    <span class="option-icon">ğŸ—£ï¸</span>
                    <span class="option-label">å¯ç”¨è¯­éŸ³</span>
                  </div>
                </el-checkbox>
                <el-checkbox 
                  v-model="enableSoundEffect" 
                  :disabled="isGenerating"
                  class="media-option"
                >
                  <div class="option-content">
                    <span class="option-icon">ğŸ””</span>
                    <span class="option-label">å¯ç”¨éŸ³æ•ˆ</span>
                  </div>
                </el-checkbox>
              </div>
              <div class="form-hint">ğŸ’¡ å‹¾é€‰åAIå°†ç”Ÿæˆå¯¹åº”çš„å¤šåª’ä½“å†…å®¹ï¼Œå¢å¼ºè¯¾ç¨‹äº’åŠ¨æ€§</div>
            </div>

            <!-- ğŸ§± æ¸²æŸ“æ¨¡å¼å¼€å…³ï¼ˆé»˜è®¤ä½¿ç”¨A2UIï¼Œå¯¹æ™®é€šç”¨æˆ·éšè—ï¼‰ -->
            <!-- å¦‚éœ€è°ƒè¯•å¯å–æ¶ˆæ³¨é‡Š
            <div class="form-group mode-switch">
              <label>ğŸ§± æ¸²æŸ“æ¨¡å¼</label>
              <div class="mode-toggle">
                <el-switch
                  v-model="useA2UIMode"
                  :disabled="isGenerating"
                  active-text="A2UIæ­ç§¯æœ¨"
                  inactive-text="ä¼ ç»ŸHTML"
                  inline-prompt
                />
                <span class="mode-hint" v-if="useA2UIMode">âœ¨ å®æ—¶æ¸²æŸ“ï¼Œè¾¹ç”Ÿæˆè¾¹æ˜¾ç¤º</span>
                <span class="mode-hint" v-else>ç­‰å¾…å®Œæˆåæ˜¾ç¤º</span>
              </div>
            </div>
            -->

            <!-- ç”ŸæˆæŒ‰é’® -->
            <div class="form-actions">
              <el-button
                type="primary"
                size="large"
                :loading="isGenerating"
                @click="handleGenerate"
                class="generate-btn"
                style="width: 100%"
              >
                <UnifiedIcon name="default" />
                {{ isGenerating ? 'ç”Ÿæˆä¸­...' : 'ğŸš€ å¼€å§‹ç”Ÿæˆè¯¾ç¨‹' }}
              </el-button>
              <div class="generate-time-hint" v-if="!isGenerating">
                â±ï¸ é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼š2-3åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
              </div>
              <el-button
                v-if="prompt"
                @click="clearForm"
                :disabled="isGenerating"
                style="width: 100%; margin-top: var(--spacing-sm)"
              >
                ğŸ”„ æ¸…ç©º
              </el-button>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šç»“æœå±•ç¤ºåŒºåŸŸ -->
      <div class="right-panel">
        <!-- AI Think æ€è€ƒè¿‡ç¨‹å¡ç‰‡ -->
        <div v-if="thinkingProcess && showThinking" class="thinking-process-card">
          <div class="thinking-header">
            <h4>ğŸ§  AI æ€è€ƒè¿‡ç¨‹</h4>
            <el-button
              link
              type="primary"
              @click="showThinking = false"
              size="small"
            >
              æ”¶èµ·
            </el-button>
          </div>
          <div class="thinking-content">
            <el-scrollbar max-height="200px">
              <div class="thinking-text">{{ thinkingProcess }}</div>
            </el-scrollbar>
          </div>
        </div>

        <!-- æ˜¾ç¤º Think æ€è€ƒè¿‡ç¨‹çš„æŒ‰é’® -->
        <div v-if="thinkingProcess && !showThinking" class="thinking-toggle">
          <el-button
            link
            type="primary"
            @click="showThinking = true"
            size="small"
          >
            ğŸ’­ æŸ¥çœ‹ AI æ€è€ƒè¿‡ç¨‹
          </el-button>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤ºå¡ç‰‡ -->
        <div v-if="isGenerating" class="progress-card">
          <div class="progress-header">
            <h3>â³ ç”Ÿæˆè¿›åº¦</h3>
            <p>{{ currentStage }}</p>
          </div>
          <ProgressPanel :progress="progress" :stage="currentStage" />
        </div>

        <!-- æˆåŠŸæç¤ºå¡ç‰‡ -->
        <div v-if="generationComplete && !isGenerating" class="success-card">
          <div class="success-icon">âœ…</div>
          <h3>ğŸ‰ è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼</h3>
          <p class="success-message">ä½ çš„äº’åŠ¨è¯¾ç¨‹å·²å‡†å¤‡å°±ç»ªï¼Œç°åœ¨å¯ä»¥å¼€å§‹ä½“éªŒäº†</p>

          <div class="success-actions">
            <el-button
              type="primary"
              size="large"
              @click="startInteractiveCourse"
              class="start-course-btn"
            >
              <UnifiedIcon name="default" />
              ğŸ“ ç«‹å³ä½“éªŒè¯¾ç¨‹
            </el-button>
            <el-button
              type="default"
              size="large"
              @click="activeTab = 'info'"
              class="view-details-btn"
            >
              <UnifiedIcon name="default" />
              ğŸ“‹ æŸ¥çœ‹è¯¾ç¨‹è¯¦æƒ…
            </el-button>
          </div>

          <div class="success-tips">
            <p>ğŸ’¡ æç¤ºï¼šç‚¹å‡»"ç«‹å³ä½“éªŒè¯¾ç¨‹"è¿›å…¥å…¨å±äº’åŠ¨æ¨¡å¼ï¼ŒæŒ‰ ESC é”®å¯é€€å‡º</p>
          </div>
        </div>

        <!-- é¢„è§ˆåŒºåŸŸ - æ ‡ç­¾é¡µ -->
        <div v-if="curriculum" class="preview-card">
          <div class="preview-header">
            <h3>ğŸ“± è¯¾ç¨‹é¢„è§ˆ</h3>
            <div class="preview-actions">
              <el-button type="primary" @click="editCurriculum" size="small">
                <UnifiedIcon name="Edit" />
                ç¼–è¾‘è¯¾ç¨‹
              </el-button>
              <el-button type="success" @click="saveCurriculum" :loading="isSaving" size="small">
                <UnifiedIcon name="default" />
                ä¿å­˜è¯¾ç¨‹
              </el-button>
            </div>
          </div>

          <el-tabs v-model="activeTab" class="preview-tabs">
            <!-- ğŸ§± A2UIå®æ—¶æ¸²æŸ“ä½“éªŒ -->
            <el-tab-pane label="ğŸ§± A2UIä½“éªŒ" name="a2ui">
              <div v-if="a2uiSessionId" class="a2ui-preview">
                <div class="a2ui-info-bar">
                  <span>ğŸ§± ç»„ä»¶æ•°é‡: {{ a2uiComponentCount }}</span>
                  <span v-if="isGenerating" class="generating-indicator">âœ¨ å®æ—¶æ¸²æŸ“ä¸­...</span>
                </div>
                <A2UIRenderer
                  :key="a2uiSessionId"
                  :node="a2uiRootNode"
                  :session-id="a2uiSessionId"
                  theme="light"
                  debug-mode
                  @ready="() => console.log('A2UIæ¸²æŸ“å™¨å°±ç»ª')"
                  @error="(e: any) => console.error('A2UIé”™è¯¯:', e)"
                />
              </div>
              <div v-else class="empty-state">
                <p>ç”Ÿæˆè¯¾ç¨‹åæ˜¾ç¤ºA2UIå®æ—¶ä½“éªŒ</p>
                <p class="empty-hint">ğŸ§± å¯ç”¨A2UIæ¨¡å¼åï¼Œå¯çœ‹åˆ°ç»„ä»¶é€ä¸ªæ­å»º</p>
              </div>
            </el-tab-pane>

            <!-- äº’åŠ¨ä½“éªŒï¼ˆæ™ºèƒ½é€‰æ‹©A2UIæˆ–ä¼ ç»ŸHTML/CSS/JSï¼‰ -->
            <el-tab-pane label="ğŸ“ äº’åŠ¨ä½“éªŒ" name="code">
              <!-- ä¼˜å…ˆä½¿ç”¨A2UIæ¸²æŸ“å™¨ï¼ˆå¦‚æœæœ‰A2UIæ•°æ®ï¼‰ -->
              <div v-if="a2uiSessionId && a2uiRootNode" class="a2ui-preview">
                <div class="a2ui-info-bar">
                  <span>ğŸ§± A2UIäº’åŠ¨æ¨¡å¼ | ç»„ä»¶æ•°é‡: {{ a2uiComponentCount }}</span>
                </div>
                <A2UIRenderer
                  :key="'interactive-' + a2uiSessionId"
                  :node="a2uiRootNode"
                  :session-id="a2uiSessionId"
                  theme="light"
                  @ready="() => console.log('äº’åŠ¨ä½“éªŒA2UIæ¸²æŸ“å™¨å°±ç»ª')"
                  @error="(e: any) => console.error('äº’åŠ¨ä½“éªŒA2UIé”™è¯¯:', e)"
                />
              </div>
              <!-- ä¼ ç»ŸHTML/CSS/JSé¢„è§ˆï¼ˆå¦‚æœæœ‰ä»£ç æ•°æ®ï¼‰ -->
              <div v-else-if="curriculum && curriculum.htmlCode" class="code-preview">
                <CurriculumPreview
                  ref="curriculumPreviewRef"
                  :html-code="curriculum.htmlCode"
                  :css-code="curriculum.cssCode"
                  :js-code="curriculum.jsCode"
                />
              </div>
              <!-- ç©ºçŠ¶æ€ -->
              <div v-else class="empty-state">
                <el-empty description="æš‚æ— è¯¾ç¨‹å†…å®¹">
                  <p class="empty-hint">è¯·å…ˆç”Ÿæˆè¯¾ç¨‹æˆ–é€‰æ‹©ä¸€ä¸ªå·²æœ‰è¯¾ç¨‹</p>
                </el-empty>
              </div>
            </el-tab-pane>

            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <el-tab-pane label="ğŸ–¼ï¸ è¯¾ç¨‹å›¾ç‰‡" name="images">
              <div v-if="curriculum?.media?.images?.length" class="images-preview">
                <ImageCarousel :images="curriculum.media.images" />
              </div>
              <div v-else class="empty-state">
                <p>ç”Ÿæˆè¯¾ç¨‹åæ˜¾ç¤ºè¯¾ç¨‹å›¾ç‰‡</p>
              </div>
            </el-tab-pane>

            <!-- è§†é¢‘é¢„è§ˆ - æš‚æ—¶éšè— -->
            <!-- <el-tab-pane label="ğŸ¬ è¯¾ç¨‹è§†é¢‘" name="video">
              <div v-if="curriculum?.media?.video?.url" class="video-preview">
                <VideoPlayer :video="curriculum.media.video" />
              </div>
              <div v-else class="empty-state">
                <p>ç”Ÿæˆè¯¾ç¨‹åæ˜¾ç¤ºè¯¾ç¨‹è§†é¢‘</p>
              </div>
            </el-tab-pane> -->

            <!-- è¯¾ç¨‹ä¿¡æ¯ -->
            <el-tab-pane label="ğŸ“‹ è¯¾ç¨‹ä¿¡æ¯" name="info">
              <div v-if="curriculum" class="info-preview">
                <el-form label-width="100px">
                  <el-form-item label="è¯¾ç¨‹åç§°">
                    <span>{{ curriculum.name }}</span>
                  </el-form-item>
                  <el-form-item label="è¯¾ç¨‹æè¿°">
                    <span>{{ curriculum.description }}</span>
                  </el-form-item>
                  <el-form-item label="è¯¾ç¨‹é¢†åŸŸ">
                    <span>{{ curriculum.domain }}</span>
                  </el-form-item>
                  <el-form-item label="å¹´é¾„æ®µ">
                    <span>{{ curriculum.ageGroup }}</span>
                  </el-form-item>
                  <el-form-item label="è¯¾ç¨‹ç±»å‹">
                    <span>{{ curriculum.curriculumType }}</span>
                  </el-form-item>
                </el-form>
              </div>
              <div v-else class="empty-state">
                <p>ç”Ÿæˆè¯¾ç¨‹åæ˜¾ç¤ºè¯¾ç¨‹ä¿¡æ¯</p>
              </div>
            </el-tab-pane>
          </el-tabs>
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div v-if="!isGenerating && !curriculum && !showWelcome" class="empty-result">
          <div class="empty-icon">ğŸ“‹</div>
          <p>å¡«å†™å·¦ä¾§è¡¨å•åï¼Œç‚¹å‡»"å¼€å§‹ç”Ÿæˆè¯¾ç¨‹"æŒ‰é’®</p>
          <p class="empty-hint">ç”Ÿæˆç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ¯ å…¨å±è¯¾ç¨‹ä½“éªŒå¼¹çª— - ä½¿ç”¨A2UISlideshowå¹»ç¯ç‰‡æ¨¡å¼ -->
  <el-dialog
    v-model="showFullscreenDialog"
    :fullscreen="true"
    :show-close="false"
    :close-on-click-modal="false"
    :close-on-press-escape="true"
    class="fullscreen-course-dialog"
    @close="closeFullscreenDialog"
  >
    <div class="fullscreen-slideshow-wrapper">
      <A2UISlideshow
        v-if="slidesData.length > 0"
        ref="fullscreenSlideshowRef"
        :key="'fullscreen-slideshow-' + a2uiSessionId"
        :slides="slidesData"
        :session-id="a2uiSessionId || 'fullscreen-session'"
        theme="colorful"
        :show-navigation="true"
        :show-score="true"
        :show-exit-button="false"
        @change="handleSlideChange"
        @event="handleSlideshowEvent"
        @complete="handleCourseComplete"
        @score-change="handleScoreChange"
      />
      <div v-else class="fullscreen-empty">
        <el-empty description="æš‚æ— è¯¾ç¨‹å†…å®¹" />
      </div>
      
      <!-- é€€å‡ºå…¨å±æŒ‰é’® -->
      <button class="exit-fullscreen-btn" @click="closeFullscreenDialog">
        <el-icon><Close /></el-icon>
        <span>é€€å‡ºå…¨å± (ESC)</span>
      </button>
    </div>
  </el-dialog>
  </UnifiedCenterLayout>
</template>

<script setup lang="ts">
import { ref, computed, onUnmounted } from 'vue';
import { ElMessage } from 'element-plus';
import { Star, Edit, DocumentAdd, VideoPlay, Document, Close } from '@element-plus/icons-vue';
import { interactiveCurriculumAPI } from '@/api/modules/interactive-curriculum';
import { useRouter } from 'vue-router';
import CurriculumPreview from './components/CurriculumPreview.vue';
import ImageCarousel from './components/ImageCarousel.vue';
import VideoPlayer from './components/VideoPlayer.vue';
import ProgressPanel from './components/ProgressPanel.vue';
import A2UIRenderer from '@/components/a2ui/A2UIRenderer.vue';
import A2UISlideshow from '@/components/a2ui/components/slideshow/A2UISlideshow.vue';
import type { SlideData } from '@/components/a2ui/components/slideshow';
import UnifiedCenterLayout from '@/components/layout/UnifiedCenterLayout.vue';
import { useA2UIStore } from '@/stores/a2ui';
import { useA2UIAudio } from '@/composables/useA2UIAudio';

const router = useRouter();
const a2uiStore = useA2UIStore();

/**
 * è¿”å›è¯¾ç¨‹åˆ—è¡¨é¡µé¢
 */
function goBack() {
  router.push('/teacher-center/creative-curriculum');
}

// ğŸµ åˆå§‹åŒ–éŸ³é¢‘å¤„ç†
const audioComposable = useA2UIAudio({
  enabled: true,
  voiceEnabled: true,
  effectsEnabled: true,
  voiceVolume: 80,
  effectsVolume: 80,
  autoPlayWelcome: true
});

// çŠ¶æ€
const prompt = ref('');
const selectedDomain = ref('science');
const ageGroup = ref('ä¸­ç­(4-5å²)');
const isGenerating = ref(false);
const isSaving = ref(false);
const progress = ref(0);
const currentStage = ref('');
const generationComplete = ref(false);
const activeTab = ref('code');
const curriculum = ref<any>(null);
const taskId = ref('');
const hasStarted = ref(false); // æ˜¯å¦å·²å¼€å§‹åˆ›å»º
const thinkingProcess = ref(''); // AI Think çš„æ€è€ƒè¿‡ç¨‹
const showThinking = ref(false); // æ˜¯å¦æ˜¾ç¤º Think æ€è€ƒè¿‡ç¨‹
const curriculumPreviewRef = ref<InstanceType<typeof CurriculumPreview>>(); // CurriculumPreview ç»„ä»¶å¼•ç”¨

// ğŸ¨ åª’ä½“ç”Ÿæˆé€‰é¡¹
const enableImage = ref(true);        // æ˜¯å¦ç”Ÿæˆå›¾ç‰‡ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
const enableVoice = ref(true);        // æ˜¯å¦å¯ç”¨è¯­éŸ³ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
const enableSoundEffect = ref(true);  // æ˜¯å¦å¯ç”¨éŸ³æ•ˆï¼ˆé»˜è®¤å¯ç”¨ï¼‰

// ğŸ§± A2UIæ­ç§¯æœ¨æ¨¡å¼æ–°å¢çŠ¶æ€
const useA2UIMode = ref(true); // é»˜è®¤ä½¿ç”¨A2UIæ¨¡å¼
const a2uiSessionId = ref<string | null>(null);
const a2uiComponentCount = ref(0);

// ğŸ¯ å…¨å±å¼¹çª—çŠ¶æ€
const showFullscreenDialog = ref(false);
const abortController = ref<AbortController | null>(null);
const fullscreenSlideshowRef = ref<InstanceType<typeof A2UISlideshow>>();
const currentScore = ref(0);

// ğŸ§± A2UI rootNode è®¡ç®—å±æ€§ - ä» store è·å–å½“å‰ä¼šè¯çš„æ ¹èŠ‚ç‚¹
const a2uiRootNode = computed(() => {
  if (!a2uiSessionId.value) return undefined;
  const session = a2uiStore.getSession(a2uiSessionId.value);
  return session?.rootNode || undefined;
});

// ğŸ“ å¹»ç¯ç‰‡æ•°æ® - ä»curriculumæˆ–a2uiRootNodeè½¬æ¢
const slidesData = computed<SlideData[]>(() => {
  console.log('ğŸ“ [slidesData] è®¡ç®—å¹»ç¯ç‰‡æ•°æ®...');
  console.log('  - curriculum.value:', curriculum.value ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
  console.log('  - curriculum.value?.slides:', curriculum.value?.slides?.length || 0);
  console.log('  - curriculum.value?.courseAnalysis:', curriculum.value?.courseAnalysis ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
  console.log('  - curriculum.value?.courseAnalysis?.activities:', curriculum.value?.courseAnalysis?.activities?.length || 0);
  console.log('  - a2uiRootNode.value:', a2uiRootNode.value ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
  
  // ä¼˜å…ˆä½¿ç”¨curriculumä¸­çš„slideså­—æ®µ
  if (curriculum.value?.slides?.length) {
    console.log('âœ… [slidesData] ä½¿ç”¨ curriculum.slides');
    return curriculum.value.slides;
  }
  
  // ä»courseAnalysisè½¬æ¢ä¸ºå¹»ç¯ç‰‡æ ¼å¼
  if (curriculum.value?.courseAnalysis) {
    console.log('âœ… [slidesData] ä½¿ç”¨ courseAnalysis è½¬æ¢');
    const slides = convertCourseAnalysisToSlides(curriculum.value);
    console.log('ğŸ“Š [slidesData] è½¬æ¢åçš„å¹»ç¯ç‰‡æ•°é‡:', slides.length);
    return slides;
  }
  
  // ä»A2UI rootNodeè½¬æ¢ä¸ºå¹»ç¯ç‰‡æ ¼å¼
  if (a2uiRootNode.value) {
    console.log('âœ… [slidesData] ä½¿ç”¨ a2uiRootNode è½¬æ¢');
    const slides = convertA2UIToSlides(a2uiRootNode.value);
    console.log('ğŸ“Š [slidesData] è½¬æ¢åçš„å¹»ç¯ç‰‡æ•°é‡:', slides.length);
    return slides;
  }
  
  console.log('âš ï¸ [slidesData] æ²¡æœ‰å¯ç”¨çš„æ•°æ®æºï¼Œè¿”å›ç©ºæ•°ç»„');
  return [];
});

/**
 * å°†courseAnalysisæ•°æ®è½¬æ¢ä¸ºå¹»ç¯ç‰‡æ ¼å¼
 */
function convertCourseAnalysisToSlides(data: any): SlideData[] {
  console.log('ğŸ”„ [convertCourseAnalysisToSlides] å¼€å§‹è½¬æ¢...');
  console.log('ğŸ“¦ [convertCourseAnalysisToSlides] è¾“å…¥æ•°æ®:', JSON.stringify(data?.courseAnalysis, null, 2)?.slice(0, 500));
  
  if (!data?.courseAnalysis) {
    console.warn('âš ï¸ [convertCourseAnalysisToSlides] courseAnalysis ä¸ºç©º');
    return [];
  }
  
  const courseAnalysis = data.courseAnalysis;
  // å…¼å®¹å¤šç§æ•°æ®æ ¼å¼
  const title = courseAnalysis.title || data.name || 'äº’åŠ¨è¯¾ç¨‹';
  const objectives = courseAnalysis.objectives || [];
  // ğŸ”§ ä¿®å¤ï¼šæ´»åŠ¨æ•°æ®å¯èƒ½åœ¨å¤šä¸ªä½ç½®
  const activities = courseAnalysis.activities || courseAnalysis.activity || [];
  const images = data.media?.images || courseAnalysis.images || [];
  
  console.log('ğŸ“Š [convertCourseAnalysisToSlides] è§£æç»“æœ:');
  console.log('  - æ ‡é¢˜:', title);
  console.log('  - ç›®æ ‡æ•°:', objectives?.length || 0);
  console.log('  - æ´»åŠ¨æ•°:', activities?.length || 0);
  console.log('  - å›¾ç‰‡æ•°:', images?.length || 0);
  
  // å¦‚æœæ´»åŠ¨æ˜¯æ•°ç»„ä½†ç¬¬ä¸€å±‚æ˜¯å¯¹è±¡ï¼Œå±•å¼€å¤„ç†
  let processedActivities = activities;
  if (activities && !Array.isArray(activities)) {
    console.log('âš ï¸ [convertCourseAnalysisToSlides] activitiesä¸æ˜¯æ•°ç»„ï¼Œå°è¯•è½¬æ¢');
    processedActivities = Object.values(activities);
  }
  
  console.log('ğŸ“‹ [convertCourseAnalysisToSlides] å¤„ç†åçš„æ´»åŠ¨:', processedActivities);
  
  const slides: SlideData[] = [];
  
  // 1. æ ‡é¢˜é¡µ
  slides.push({
    id: 'slide-title',
    type: 'title',
    background: {
      type: 'gradient',
      value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
    },
    components: [
      {
        type: 'title',
        id: 'title-comp',
        props: {
          text: title,
          subtitle: `${data.ageGroup || courseAnalysis.ageGroup || 'å¹¼å„¿å›­'} Â· äº’åŠ¨å­¦ä¹ `
        }
      },
      ...(objectives?.length ? [{
        type: 'objectives',
        id: 'objectives-comp',
        props: { items: objectives }
      }] : [])
    ]
  });
  
  // 2. å›¾ç‰‡å†…å®¹é¡µ
  if (images.length > 0) {
    console.log('ğŸ–¼ï¸ [convertCourseAnalysisToSlides] æ·»åŠ å›¾ç‰‡é¡µ');
    slides.push({
      id: 'slide-media',
      type: 'media',
      components: [{
        type: 'image-carousel',
        id: 'carousel-comp',
        props: {
          images: images.map((img: any) => ({
            id: img.id || `img-${Math.random().toString(36).slice(2)}`,
            url: img.url || img.src,
            alt: img.description || img.alt || 'è¯¾ç¨‹å›¾ç‰‡'
          }))
        }
      }]
    });
  }
  
  // 3. æ´»åŠ¨é¡µ - éå†æ¯ä¸ªæ´»åŠ¨åˆ›å»ºç‹¬ç«‹é¡µé¢
  if (processedActivities?.length) {
    console.log('ğŸ® [convertCourseAnalysisToSlides] æ·»åŠ æ´»åŠ¨é¡µé¢...');
    processedActivities.forEach((activity: any, index: number) => {
      console.log(`  - æ´»åŠ¨${index + 1}: type=${activity.type}, title=${activity.title}`);
      slides.push({
        id: `slide-activity-${index}`,
        type: 'activity',
        components: [convertActivityToSlideComponent(activity, index)]
      });
    });
  } else {
    console.warn('âš ï¸ [convertCourseAnalysisToSlides] æ²¡æœ‰æ´»åŠ¨æ•°æ®ï¼');
  }
  
  // 4. æ€»ç»“é¡µ
  slides.push({
    id: 'slide-summary',
    type: 'summary',
    components: [{
      type: 'summary',
      id: 'summary-comp',
      props: {
        title: 'è¯¾ç¨‹å®Œæˆ',
        points: objectives?.length ? objectives : ['å®Œæˆäº†æ‰€æœ‰å­¦ä¹ å†…å®¹', 'æŒæ¡äº†æ–°çŸ¥è¯†', 'è¡¨ç°å¾ˆæ£’']
      }
    }]
  });
  
  console.log('âœ… [convertCourseAnalysisToSlides] è½¬æ¢å®Œæˆï¼Œæ€»é¡µæ•°:', slides.length);
  return slides;
}

/**
 * å°†å•ä¸ªæ´»åŠ¨è½¬æ¢ä¸ºå¹»ç¯ç‰‡ç»„ä»¶
 */
function convertActivityToSlideComponent(activity: any, index: number): any {
  switch (activity.type) {
    case 'choice':
      return {
        type: 'choice-question',
        id: activity.id || `choice-${index}`,
        props: {
          title: activity.title,
          question: activity.question || activity.instruction,
          options: activity.options || [],
          points: activity.points || 10,
          hint: activity.instruction
        }
      };
    case 'drag-sort':
      return {
        type: 'drag-sort',
        id: activity.id || `drag-${index}`,
        props: {
          title: activity.title,
          instructions: activity.instruction || 'æ‹–æ‹½é¡¹ç›®åˆ°æ­£ç¡®ä½ç½®',
          items: activity.items || [],
          correctOrder: activity.correctOrder || [],
          points: activity.points || 15
        }
      };
    default:
      return {
        type: 'text',
        id: activity.id || `text-${index}`,
        props: {
          title: activity.title,
          content: activity.instruction || 'æ´»åŠ¨å†…å®¹'
        }
      };
  }
}

/**
 * ä»A2UI rootNodeè½¬æ¢ä¸ºå¹»ç¯ç‰‡æ ¼å¼
 */
function convertA2UIToSlides(rootNode: any): SlideData[] {
  console.log('ğŸ”„ [convertA2UIToSlides] å¼€å§‹è½¬æ¢A2UI rootNode...');
  console.log('ğŸ“¦ [convertA2UIToSlides] rootNode:', rootNode?.type, rootNode?.id);
  console.log('ğŸ“¦ [convertA2UIToSlides] childrenæ•°é‡:', rootNode?.children?.length || 0);
  
  if (!rootNode?.children?.length) {
    console.warn('âš ï¸ [convertA2UIToSlides] rootNodeæ²¡æœ‰children');
    return [];
  }
  
  const slides: SlideData[] = [];
  const children = rootNode.children || [];
  
  // æ‰“å°æ‰€æœ‰å­ç»„ä»¶ç±»å‹ï¼Œç”¨äºè°ƒè¯•
  console.log('ğŸ“‹ [convertA2UIToSlides] æ‰€æœ‰å­ç»„ä»¶:');
  children.forEach((c: any, i: number) => {
    console.log(`  ${i + 1}. type=${c.type}, id=${c.id}, children=${c.children?.length || 0}`);
  });
  
  // ğŸ”§ é€’å½’æŸ¥æ‰¾ç‰¹å®šç±»å‹ç»„ä»¶çš„è¾…åŠ©å‡½æ•°
  const findComponentsByType = (node: any, types: string[]): any[] => {
    const results: any[] = [];
    if (!node) return results;
    
    if (types.includes(node.type)) {
      results.push(node);
    }
    
    // é€’å½’æœç´¢å­èŠ‚ç‚¹
    if (node.children?.length) {
      for (const child of node.children) {
        results.push(...findComponentsByType(child, types));
      }
    }
    
    return results;
  };
  
  // ğŸ”§ é€’å½’æŸ¥æ‰¾æ´»åŠ¨å¡ç‰‡ï¼ˆåŒ…å«æ´»åŠ¨ç»„ä»¶çš„å¡ç‰‡ï¼‰
  const findActivityCards = (node: any): any[] => {
    const results: any[] = [];
    if (!node) return results;
    
    // æŸ¥æ‰¾idåŒ…å«"activity"çš„å¡ç‰‡
    if (node.type === 'card' && node.id?.includes('activity')) {
      results.push(node);
    }
    
    // é€’å½’æœç´¢å­èŠ‚ç‚¹
    if (node.children?.length) {
      for (const child of node.children) {
        results.push(...findActivityCards(child));
      }
    }
    
    return results;
  };
  
  // æŸ¥æ‰¾æ ‡é¢˜å¡ç‰‡
  const titleCards = findComponentsByType(rootNode, ['card']).filter(
    (c: any) => c.id?.includes('title') || c.props?.title
  );
  const titleCard = titleCards[0];
  
  // æŸ¥æ‰¾å›¾ç‰‡è½®æ’­
  const carousels = findComponentsByType(rootNode, ['image-carousel']);
  const carousel = carousels[0];
  
  // ğŸ”§ ä¿®å¤ï¼šæŸ¥æ‰¾æ´»åŠ¨å¡ç‰‡ï¼ˆæ´»åŠ¨ç»„ä»¶è¢«åŒ…è£…åœ¨å¡ç‰‡ä¸­ï¼‰
  const activityCards = findActivityCards(rootNode);
  
  // ğŸ”§ æ”¯æŒçš„æ´»åŠ¨ç±»å‹
  const activityTypes = [
    'choice', 'choice-question', 
    'drag-sort', 'drag-sorting',
    'fill-blank', 'fill-blank-question', 
    'puzzle-game', 'puzzle',
    'matching', 'matching-game',
    'sorting', 'sequence',
    'whiteboard'
  ];
  
  // ç›´æ¥çš„æ´»åŠ¨ç»„ä»¶ï¼ˆéåµŒå¥—ï¼‰
  const directActivities = findComponentsByType(rootNode, activityTypes);
  
  console.log('ğŸ” [convertA2UIToSlides] æ‰¾åˆ°çš„ç»„ä»¶:');
  console.log('  - æ ‡é¢˜å¡ç‰‡:', titleCard ? 'æœ‰' : 'æ— ');
  console.log('  - å›¾ç‰‡è½®æ’­:', carousel ? 'æœ‰' : 'æ— ');
  console.log('  - æ´»åŠ¨å¡ç‰‡:', activityCards.length, 'ä¸ª');
  console.log('  - ç›´æ¥æ´»åŠ¨ç»„ä»¶:', directActivities.length, 'ä¸ª');
  
  // 1. æ ‡é¢˜é¡µ
  if (titleCard || rootNode.props?.title) {
    slides.push({
      id: 'slide-title',
      type: 'title',
      background: {
        type: 'gradient',
        value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
      },
      components: [{
        type: 'title',
        id: 'title-comp',
        props: {
          text: titleCard?.props?.title || rootNode.props?.title || 'äº’åŠ¨è¯¾ç¨‹',
          subtitle: ageGroup.value || 'å¹¼å„¿å›­äº’åŠ¨å­¦ä¹ '
        }
      }]
    });
  }
  
  // 2. å›¾ç‰‡è½®æ’­é¡µ
  if (carousel) {
    slides.push({
      id: 'slide-media',
      type: 'media',
      components: [{
        type: 'image-carousel',
        id: carousel.id,
        props: {
          images: (carousel.props?.images || []).map((img: any) => ({
            id: img.id,
            url: img.src || img.url,
            alt: img.alt || 'è¯¾ç¨‹å›¾ç‰‡'
          }))
        }
      }]
    });
  }
  
  // 3. æ´»åŠ¨é¡µ - ä¼˜å…ˆä½¿ç”¨æ´»åŠ¨å¡ç‰‡
  if (activityCards.length > 0) {
    console.log('ğŸ® [convertA2UIToSlides] ä½¿ç”¨æ´»åŠ¨å¡ç‰‡åˆ›å»ºæ´»åŠ¨é¡µ...');
    activityCards.forEach((card: any, index: number) => {
      console.log(`  ${index + 1}. å¡ç‰‡: ${card.id}, æ ‡é¢˜: ${card.props?.title}`);
      
      // ä»å¡ç‰‡ä¸­æå–æ´»åŠ¨ç»„ä»¶
      const activityComp = findComponentsByType(card, activityTypes)[0];
      
      slides.push({
        id: `slide-activity-${index}`,
        type: 'activity',
        components: [{
          type: activityComp?.type || 'card',
          id: card.id,
          props: {
            title: card.props?.title || `æ´»åŠ¨ ${index + 1}`,
            ...activityComp?.props
          }
        }]
      });
    });
  } else if (directActivities.length > 0) {
    // æ²¡æœ‰æ´»åŠ¨å¡ç‰‡æ—¶ä½¿ç”¨ç›´æ¥çš„æ´»åŠ¨ç»„ä»¶
    console.log('ğŸ® [convertA2UIToSlides] ä½¿ç”¨ç›´æ¥æ´»åŠ¨ç»„ä»¶åˆ›å»ºæ´»åŠ¨é¡µ...');
    directActivities.forEach((activity: any, index: number) => {
      console.log(`  ${index + 1}. æ´»åŠ¨: ${activity.type}, ${activity.id}`);
      
      // æ ‡å‡†åŒ–æ´»åŠ¨ç±»å‹åç§°
      let normalizedType = activity.type;
      if (activity.type === 'choice') normalizedType = 'choice-question';
      if (activity.type === 'drag-sorting') normalizedType = 'drag-sort';
      
      slides.push({
        id: `slide-activity-${index}`,
        type: 'activity',
        components: [{
          type: normalizedType,
          id: activity.id,
          props: activity.props
        }]
      });
    });
  } else {
    console.warn('âš ï¸ [convertA2UIToSlides] æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ´»åŠ¨ç»„ä»¶ï¼');
  }
  
  // 4. æ€»ç»“é¡µ
  slides.push({
    id: 'slide-summary',
    type: 'summary',
    components: [{
      type: 'summary',
      id: 'summary-comp',
      props: {
        title: 'è¯¾ç¨‹å®Œæˆ',
        points: ['å®Œæˆäº†æ‰€æœ‰å­¦ä¹ å†…å®¹', 'æŒæ¡äº†æ–°çŸ¥è¯†', 'è¡¨ç°å¾ˆæ£’']
      }
    }]
  });
  
  console.log('âœ… [convertA2UIToSlides] è½¬æ¢å®Œæˆï¼Œæ€»é¡µæ•°:', slides.length);
  return slides;
}

// è®¡ç®—å±æ€§
const isGenerating_computed = computed(() => isGenerating.value);

// æ˜¯å¦æ˜¾ç¤ºæ¬¢è¿å¡ç‰‡
const showWelcome = computed(() => {
  return !hasStarted.value && !isGenerating.value && !generationComplete.value && !curriculum.value;
});

/**
 * ç”Ÿæˆè¯¾ç¨‹ï¼ˆæ™ºèƒ½é€‰æ‹©æ¨¡å¼ï¼‰
 */
async function handleGenerate() {
  if (!prompt.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥è¯¾ç¨‹éœ€æ±‚');
    return;
  }

  if (!selectedDomain.value) {
    ElMessage.warning('è¯·é€‰æ‹©è¯¾ç¨‹é¢†åŸŸ');
    return;
  }

  // æ ¹æ®æ¨¡å¼é€‰æ‹©ç”Ÿæˆæ–¹å¼
  if (useA2UIMode.value) {
    await handleGenerateA2UI();
  } else {
    await handleGenerateStream();
  }
}

/**
 * ğŸ§± A2UIæ­ç§¯æœ¨æ¨¡å¼ç”Ÿæˆè¯¾ç¨‹
 * å®æ—¶åˆ†æ®µå‘é€ç»„ä»¶ï¼Œå‰ç«¯å¢é‡æ¸²æŸ“
 */
async function handleGenerateA2UI() {
  isGenerating.value = true;
  hasStarted.value = true;
  progress.value = 0;
  currentStage.value = 'ğŸ§± åˆå§‹åŒ–A2UIæ­ç§¯æœ¨æ¨¡å¼...';
  generationComplete.value = false;
  thinkingProcess.value = '';
  showThinking.value = true;
  activeTab.value = 'a2ui'; // åˆ‡æ¢åˆ°A2UIé¢„è§ˆæ ‡ç­¾é¡µ

  // åˆ›å»ºA2UIä¼šè¯
  const sessionId = `curriculum-${Date.now()}`;
  a2uiSessionId.value = sessionId;
  a2uiStore.createSession(sessionId);
  a2uiComponentCount.value = 0;

  try {
    // ä½¿ç”¨A2UIæµå¼APIç”Ÿæˆè¯¾ç¨‹
    abortController.value = interactiveCurriculumAPI.generateA2UIStream(
      {
        prompt: prompt.value,
        domain: selectedDomain.value,
        ageGroup: ageGroup.value,
        // ğŸ¨ ä¼ é€’åª’ä½“é€‰é¡¹
        enableImage: enableImage.value,
        enableVoice: enableVoice.value,
        enableSoundEffect: enableSoundEffect.value
      },
      {
        onConnected: (newTaskId: string) => {
          taskId.value = newTaskId;
          console.log('âœ… [A2UIæ­ç§¯æœ¨] è¿æ¥å·²å»ºç«‹ï¼ŒtaskId:', newTaskId);
          ElMessage.success('ğŸ§± å¼€å§‹æ­å»ºè¯¾ç¨‹ï¼Œå®æ—¶æ¸²æŸ“ä¸­...');
          currentStage.value = 'å·²è¿æ¥ï¼Œç­‰å¾…AIå“åº”...';
        },
        onComponent: (msg) => {
          console.log(`ğŸ§± [A2UIæ­ç§¯æœ¨] æ”¶åˆ°ç»„ä»¶: ${msg.action} - ${msg.component.id}`);

          try {
            // ğŸµ å¢å¼ºç»„ä»¶éŸ³é¢‘é…ç½®ï¼ˆå¦‚æœç»„ä»¶æœ‰éŸ³é¢‘å±æ€§ï¼‰
            const enhancedComponent = audioComposable.enhanceComponentTree(msg.component);

            // è°ƒç”¨storeå¤„ç†ç»„ä»¶æ¶ˆæ¯
            a2uiStore.handleComponentMessage(sessionId, {
              type: 'component',
              action: msg.action,
              targetId: msg.targetId,
              component: enhancedComponent || undefined
            });

            // ğŸµ å¦‚æœç»„ä»¶æœ‰æ¬¢è¿è¯­éŸ³ä¸”æ ‡è®°ä¸ºè‡ªåŠ¨æ’­æ”¾ï¼Œè§¦å‘æ’­æ”¾
            if (msg.component.audio?.autoPlay && msg.component.audio.ttsUrl) {
              audioComposable.autoPlayWelcome(
                msg.component.audio.ttsUrl,
                msg.component.audio.ttsText || '',
                msg.component.audio.playDelay || 1000
              );
            }

            // æ›´æ–°ç»„ä»¶è®¡æ•°
            a2uiComponentCount.value = a2uiStore.getComponentCount(sessionId);
          } catch (e) {
            console.error('âŒ [A2UIæ­ç§¯æœ¨] onComponentå¤„ç†å¤±è´¥:', e);
          }
        },
        onThinking: (content: string) => {
          // å®æ—¶è¿½åŠ æ€è€ƒå†…å®¹ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°undefined
          thinkingProcess.value = (thinkingProcess.value || '') + content;
          console.log('ğŸ§  [A2UIæ­ç§¯æœ¨] æ”¶åˆ°æ€è€ƒå†…å®¹ï¼Œå½“å‰æ€»é•¿åº¦:', thinkingProcess.value?.length || 0);
        },
        onProgress: (message: string) => {
          currentStage.value = message;
          console.log('ğŸ“Š [A2UIæ­ç§¯æœ¨] è¿›åº¦:', message);

          // æ ¹æ®æ¶ˆæ¯æ›´æ–°è¿›åº¦æ¡
          if (message.includes('åˆå§‹åŒ–') || message.includes('åˆ†æ')) {
            progress.value = 20;
          } else if (message.includes('åŠ è½½') || message.includes('æ ‡é¢˜') || message.includes('ç›®æ ‡')) {
            progress.value = 40;
          } else if (message.includes('å›¾ç‰‡')) {
            progress.value = 60;
          } else if (message.includes('æ´»åŠ¨')) {
            progress.value = 80;
          } else if (message.includes('å®Œæˆ')) {
            progress.value = 95;
          }
        },
        onImageReady: (imageId: string, imageUrl: string) => {
          console.log(`ğŸ–¼ï¸ [A2UIæ­ç§¯æœ¨] å›¾ç‰‡å°±ç»ª: ${imageId}`);
          // æ›´æ–°è½®æ’­ç»„ä»¶ä¸­çš„å›¾ç‰‡
          a2uiStore.updateImageInCarousel(sessionId, 'media-carousel', imageId, imageUrl);
        },
        onComplete: (message: string) => {
          console.log('âœ… [A2UIæ­ç§¯æœ¨]', message);
        },
        onFinished: async (curriculumId: number, plan: any) => {
          console.log('ğŸ‰ [A2UIæ­ç§¯æœ¨] è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼ŒID:', curriculumId);
          console.log('ğŸ“‹ [A2UIæ­ç§¯æœ¨] è¯¾ç¨‹è®¡åˆ’:', plan);

          try {
            // æ›´æ–°UIçŠ¶æ€
            progress.value = 100;
            currentStage.value = 'ğŸ‰ è¯¾ç¨‹æ­å»ºå®Œæˆï¼';
            generationComplete.value = true;
            isGenerating.value = false;
            ElMessage.success('ğŸ§± è¯¾ç¨‹æ­å»ºå®Œæˆï¼å¯ä»¥å¼€å§‹ä½“éªŒäº†');

            // æ— è®ºA2UIæ¨¡å¼è¿˜æ˜¯ä¼ ç»Ÿæ¨¡å¼ï¼Œåªè¦æœ‰curriculumIdå°±åŠ è½½è¯¾ç¨‹è¯¦æƒ…
            // è¿™æ ·curriculum.valueä¼šè¢«æ­£ç¡®è®¾ç½®ï¼Œä¿å­˜åŠŸèƒ½æ‰èƒ½æ­£å¸¸å·¥ä½œ
            if (curriculumId) {
              console.log('ğŸ“¦ [A2UIæ­ç§¯æœ¨] åŠ è½½è¯¾ç¨‹è¯¦æƒ…ç”¨äºä¿å­˜åŠŸèƒ½...');
              await loadCurriculumDetail(curriculumId);
              console.log('âœ… [A2UIæ­ç§¯æœ¨] è¯¾ç¨‹è¯¦æƒ…å·²åŠ è½½ï¼Œcurriculum.value.id:', curriculum.value?.id);
            } else {
              console.log('âš ï¸ [A2UIæ­ç§¯æœ¨] æ— curriculumIdï¼Œä»…ä½¿ç”¨æµå¼æ•°æ®ï¼ˆä¿å­˜åŠŸèƒ½å°†ä¸å¯ç”¨ï¼‰');
            }
            
            console.log('âœ… [A2UIæ­ç§¯æœ¨] å¤„ç†å®Œæˆ');
          } catch (e) {
            console.error('âŒ [A2UIæ­ç§¯æœ¨] onFinishedå¤„ç†å¤±è´¥:', e);
          }
        },
        onError: (error: string) => {
          console.error('âŒ [A2UIæ­ç§¯æœ¨] é”™è¯¯:', error);
          ElMessage.error(`ç”Ÿæˆå¤±è´¥: ${error}`);
          isGenerating.value = false;
          currentStage.value = `ç”Ÿæˆå¤±è´¥: ${error}`;
          a2uiStore.setSessionError(sessionId, { code: 'GENERATE_ERROR', message: error });
        }
      }
    );

  } catch (error) {
    console.error('âŒ A2UIç”Ÿæˆè¯¾ç¨‹å¤±è´¥:', error);
    ElMessage.error('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    isGenerating.value = false;
    currentStage.value = 'ç”Ÿæˆå¤±è´¥';
  }
}

/**
 * æ—§ç‰ˆæµå¼ç”Ÿæˆè¯¾ç¨‹ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
 */
async function handleGenerateStream() {
  if (!prompt.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥è¯¾ç¨‹éœ€æ±‚');
    return;
  }

  if (!selectedDomain.value) {
    ElMessage.warning('è¯·é€‰æ‹©è¯¾ç¨‹é¢†åŸŸ');
    return;
  }

  isGenerating.value = true;
  hasStarted.value = true;
  progress.value = 0;
  currentStage.value = 'åˆå§‹åŒ–...';
  generationComplete.value = false;
  thinkingProcess.value = '';
  showThinking.value = true;

  try {
    // ä½¿ç”¨æµå¼APIç”Ÿæˆè¯¾ç¨‹
    interactiveCurriculumAPI.generateCurriculumStream(
      {
        prompt: prompt.value,
        domain: selectedDomain.value,
        ageGroup: ageGroup.value,
        // ğŸ¨ ä¼ é€’åª’ä½“é€‰é¡¹
        enableImage: enableImage.value,
        enableVoice: enableVoice.value,
        enableSoundEffect: enableSoundEffect.value
      },
      {
        onConnected: (newTaskId: string) => {
          taskId.value = newTaskId;
          console.log('âœ… [æµå¼ç”Ÿæˆ] è¿æ¥å·²å»ºç«‹ï¼ŒtaskId:', newTaskId);
          ElMessage.success('è¯¾ç¨‹ç”Ÿæˆå·²å¯åŠ¨ï¼Œæ­£åœ¨å¤„ç†ä¸­...');
          currentStage.value = 'å·²è¿æ¥ï¼Œç­‰å¾…AIå“åº”...';
        },
        onThinking: (content: string) => {
          // å®æ—¶è¿½åŠ æ€è€ƒå†…å®¹
          thinkingProcess.value = (thinkingProcess.value || '') + content;
          console.log('ğŸ§  [æµå¼ç”Ÿæˆ] æ”¶åˆ°æ€è€ƒå†…å®¹ï¼Œå½“å‰æ€»é•¿åº¦:', thinkingProcess.value?.length || 0);
        },
        onProgress: (message: string) => {
          currentStage.value = message;
          console.log('ğŸ“Š [æµå¼ç”Ÿæˆ] è¿›åº¦æ›´æ–°:', message);

          // æ ¹æ®è¿›åº¦æ¶ˆæ¯æ›´æ–°è¿›åº¦æ¡
          if (message.includes('åˆå§‹åŒ–')) {
            progress.value = 5;
          } else if (message.includes('æ·±åº¦åˆ†æ')) {
            progress.value = 20;
          } else if (message.includes('ç”Ÿæˆèµ„æº')) {
            progress.value = 60;
          } else if (message.includes('ä¿å­˜')) {
            progress.value = 90;
          }
        },
        onComplete: () => {
          console.log('âœ… [æµå¼ç”Ÿæˆ] æ€è€ƒè¿‡ç¨‹å®Œæˆ');
        },
        onFinished: async (curriculumId: number, plan?: any) => {
          console.log('ğŸ‰ [æµå¼ç”Ÿæˆ] è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼ŒID:', curriculumId);
          console.log('ğŸ“‹ [æµå¼ç”Ÿæˆ] è¯¾ç¨‹è®¡åˆ’:', plan);

          // å¦‚æœæ²¡æœ‰curriculumIdä½†æœ‰planï¼Œè¯´æ˜ç”Ÿæˆåœ¨A2UIæ¨¡å¼ä¸‹å®Œæˆï¼Œæ•°æ®å·²ç»åœ¨storeä¸­
          if (!curriculumId && plan) {
            console.log('âœ… [æµå¼ç”Ÿæˆ] A2UIæ¨¡å¼ç”Ÿæˆå®Œæˆï¼Œä½¿ç”¨æµå¼æ•°æ®');
            progress.value = 100;
            currentStage.value = 'ç”Ÿæˆå®Œæˆ';
            generationComplete.value = true;
            isGenerating.value = false;
            ElMessage.success('è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼');
            return;
          }

          progress.value = 100;
          currentStage.value = 'ç”Ÿæˆå®Œæˆ';
          generationComplete.value = true;
          isGenerating.value = false;

          ElMessage.success('è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼');

          // åŠ è½½è¯¾ç¨‹è¯¦æƒ…ï¼ˆä»…å½“curriculumIdå­˜åœ¨æ—¶ï¼‰
          if (curriculumId) {
            await loadCurriculumDetail(curriculumId);
          }
        },
        onError: (error: string) => {
          console.error('âŒ [æµå¼ç”Ÿæˆ] é”™è¯¯:', error);
          ElMessage.error(`ç”Ÿæˆå¤±è´¥: ${error}`);
          isGenerating.value = false;
          currentStage.value = `ç”Ÿæˆå¤±è´¥: ${error}`;
        }
      }
    );

  } catch (error) {
    console.error('âŒ ç”Ÿæˆè¯¾ç¨‹å¤±è´¥:', error);
    ElMessage.error('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
    isGenerating.value = false;
    currentStage.value = 'ç”Ÿæˆå¤±è´¥';
  }
}

/**
 * å¼€å§‹äº’åŠ¨è¯¾ç¨‹ä½“éªŒ - æ‰“å¼€å…¨å±å¼¹çª—
 */
function startInteractiveCourse() {
  // A2UI æ¨¡å¼ï¼šæ‰“å¼€å…¨å±å¼¹çª—ä½“éªŒ
  if (useA2UIMode.value && a2uiSessionId.value && a2uiRootNode.value) {
    showFullscreenDialog.value = true;
    ElMessage.success('ğŸ“ è¿›å…¥å…¨å±äº’åŠ¨ä½“éªŒæ¨¡å¼ï¼ŒæŒ‰ ESC é”®å¯é€€å‡º');
    return;
  }

  // ä¼ ç»Ÿæ¨¡å¼ï¼šéœ€è¦è¯¾ç¨‹æ•°æ®
  if (!curriculum.value) {
    ElMessage.warning('è¯·å…ˆç”Ÿæˆè¯¾ç¨‹');
    return;
  }

  // ä¼ ç»Ÿæ¨¡å¼ï¼šæ‰“å¼€å…¨å±å¼¹çª—
  showFullscreenDialog.value = true;
  ElMessage.success('ğŸ“ è¿›å…¥å…¨å±äº’åŠ¨ä½“éªŒæ¨¡å¼ï¼ŒæŒ‰ ESC é”®å¯é€€å‡º');
}

/**
 * å…³é—­å…¨å±å¼¹çª—
 */
function closeFullscreenDialog() {
  showFullscreenDialog.value = false;
  ElMessage.info('å·²é€€å‡ºå…¨å±äº’åŠ¨ä½“éªŒ');
}

/**
 * å¤„ç†å¹»ç¯ç‰‡åˆ‡æ¢
 */
function handleSlideChange(index: number, slide: SlideData) {
  console.log('[äº’åŠ¨è¯¾ç¨‹] åˆ‡æ¢åˆ°å¹»ç¯ç‰‡:', index, slide.type);
}

/**
 * å¤„ç†å¹»ç¯ç‰‡äº‹ä»¶
 */
function handleSlideshowEvent(event: any) {
  console.log('[äº’åŠ¨è¯¾ç¨‹] å¹»ç¯ç‰‡äº‹ä»¶:', event);
}

/**
 * å¤„ç†è¯¾ç¨‹å®Œæˆ
 */
function handleCourseComplete() {
  console.log('[äº’åŠ¨è¯¾ç¨‹] è¯¾ç¨‹å®Œæˆ');
  ElMessage.success('ğŸ‰ æ­å–œå®Œæˆè¯¾ç¨‹ï¼');
}

/**
 * å¤„ç†å¾—åˆ†å˜åŒ–
 */
function handleScoreChange(score: number) {
  currentScore.value = score;
  console.log('[äº’åŠ¨è¯¾ç¨‹] å¾—åˆ†æ›´æ–°:', score);
}

/**
 * åŠ è½½è¯¾ç¨‹è¯¦æƒ…
 * ç”¨äºæµå¼ç”Ÿæˆå®Œæˆåï¼Œæ ¹æ®åç«¯è¿”å›çš„è¯¾ç¨‹ ID æ‹‰å–å®Œæ•´è¯¾ç¨‹æ•°æ®å¹¶å¡«å……é¢„è§ˆ
 */
async function loadCurriculumDetail(curriculumId: number) {
  if (!curriculumId) return;

  try {
    console.log('ğŸ“¦ [åŠ è½½è¯¾ç¨‹è¯¦æƒ…] å¼€å§‹åŠ è½½è¯¾ç¨‹ID:', curriculumId);
    const response = await interactiveCurriculumAPI.getCurriculumDetail(curriculumId);
    console.log('ğŸ“¦ [åŠ è½½è¯¾ç¨‹è¯¦æƒ…] APIå“åº”:', response);

    // APIè¿”å›æ ¼å¼: { success: boolean; data: CurriculumDetail }
    if (response && response.success && response.data) {
      curriculum.value = response.data;
      console.log('âœ… [åŠ è½½è¯¾ç¨‹è¯¦æƒ…] è¯¾ç¨‹æ•°æ®å·²è®¾ç½®:', curriculum.value?.id, curriculum.value?.name);
      // ç¡®ä¿åˆ‡æ¢åˆ°äº’åŠ¨ä½“éªŒæ ‡ç­¾é¡µï¼Œæ–¹ä¾¿è€å¸ˆä¸€é”®å…¨å±ä¸Šè¯¾
      activeTab.value = 'code';
    } else {
      console.error('âŒ è·å–è¯¾ç¨‹è¯¦æƒ…è¿”å›ç»“æ„å¼‚å¸¸:', response);
      ElMessage.error('è·å–è¯¾ç¨‹è¯¦æƒ…å¤±è´¥');
    }
  } catch (error) {
    console.error('âŒ è·å–è¯¾ç¨‹è¯¦æƒ…å¤±è´¥:', error);
    ElMessage.error('è·å–è¯¾ç¨‹è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}

/**
 * æ—§ç‰ˆæœ¬ç”Ÿæˆè¯¾ç¨‹ï¼ˆéæµå¼ï¼Œä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
 */
async function handleGenerateOld() {
  if (!prompt.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥è¯¾ç¨‹éœ€æ±‚');
    return;
  }

  if (!selectedDomain.value) {
    ElMessage.warning('è¯·é€‰æ‹©è¯¾ç¨‹é¢†åŸŸ');
    return;
  }

  isGenerating.value = true;
  progress.value = 0;
  currentStage.value = 'åˆå§‹åŒ–...';
  generationComplete.value = false;

  try {
    // è°ƒç”¨ç”ŸæˆAPI
    const response = await interactiveCurriculumAPI.generateCurriculum({
      prompt: prompt.value,
      domain: selectedDomain.value,
      ageGroup: ageGroup.value
    });

    // è°ƒè¯•ï¼šæ‰“å°å“åº”ç»“æ„
    console.log('ğŸ” ç”ŸæˆAPIå“åº”:', response);
    console.log('ğŸ” å“åº”ç±»å‹:', typeof response);
    console.log('ğŸ” å“åº”keys:', Object.keys(response || {}));

    // APIè¿”å›æ ¼å¼: { success: boolean; data: { taskId: string; message: string } }
    if (!response || !response.success || !response.data?.taskId) {
      console.error('âŒ å“åº”ç»“æ„é”™è¯¯:', { response });
      throw new Error('ç”Ÿæˆå¤±è´¥ï¼šæ— æ³•è·å–ä»»åŠ¡ID');
    }

    taskId.value = response.data.taskId;
    ElMessage.success('è¯¾ç¨‹ç”Ÿæˆå·²å¯åŠ¨ï¼Œæ­£åœ¨å¤„ç†ä¸­...');

    // ä½¿ç”¨ SSE æµå¼è·å– Think æ€è€ƒè¿‡ç¨‹ï¼ˆå®æ—¶æ¨é€ï¼‰
    interactiveCurriculumAPI.getThinkingProcessStream(
      taskId.value,
      (data) => {
        console.log('ğŸŒŠ [Think SSE] æ”¶åˆ°äº‹ä»¶:', data.type);

        if (data.type === 'connected') {
          console.log('âœ… Think SSE è¿æ¥å·²å»ºç«‹');
        } else if (data.type === 'thinking') {
          // æ”¶åˆ°æ€è€ƒè¿‡ç¨‹å†…å®¹
          thinkingProcess.value = data.content || '';
          console.log('ğŸ§  è·å– Think æ€è€ƒè¿‡ç¨‹æˆåŠŸï¼Œé•¿åº¦:', data.content?.length || 0);
        } else if (data.type === 'complete') {
          console.log('âœ… Think æ€è€ƒè¿‡ç¨‹å·²å®Œæˆ');
        } else if (data.type === 'timeout') {
          console.warn('âš ï¸ Think æ€è€ƒè¿‡ç¨‹è·å–è¶…æ—¶');
        }
      },
      (error) => {
        console.warn('âš ï¸ Think SSE è¿æ¥é”™è¯¯:', error);
      }
    );

    // è½®è¯¢è¿›åº¦
    const result = await interactiveCurriculumAPI.pollProgress(taskId.value);
    progress.value = result.progress;
    currentStage.value = result.stage;

    // è·å–è¯¾ç¨‹è¯¦æƒ…
    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä»åç«¯è¿”å›çš„å“åº”ä¸­è·å–è¯¾ç¨‹ID
    // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”è¯¥ä»åç«¯è·å–
    ElMessage.success('è¯¾ç¨‹ç”Ÿæˆå®Œæˆï¼');
    generationComplete.value = true;
  } catch (error) {
    console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
    ElMessage.error('è¯¾ç¨‹ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    isGenerating.value = false;
  }
}

/**
 * å¼€å§‹åˆ›å»ºè¯¾ç¨‹
 */
function startCreating() {
  hasStarted.value = true;
}

/**
 * å¡«å……ç¤ºä¾‹
 */
function fillExample(example: string) {
  prompt.value = example;
  hasStarted.value = true; // ç‚¹å‡»ç¤ºä¾‹åè‡ªåŠ¨è¿›å…¥åˆ›å»ºæ¨¡å¼
}

/**
 * æ¸…ç©ºè¡¨å•
 */
function clearForm() {
  prompt.value = '';
  selectedDomain.value = 'science';
  ageGroup.value = '4-5å²';
  curriculum.value = null;
  generationComplete.value = false;
  hasStarted.value = false; // é‡ç½®ä¸ºæ¬¢è¿é¡µé¢
  thinkingProcess.value = ''; // æ¸…é™¤ Think æ€è€ƒè¿‡ç¨‹
  showThinking.value = false; // éšè— Think æ€è€ƒè¿‡ç¨‹
  
  // ğŸ¨ é‡ç½®åª’ä½“é€‰é¡¹ä¸ºé»˜è®¤å€¼
  enableImage.value = true;
  enableVoice.value = true;
  enableSoundEffect.value = true;
  
  // ğŸ§± æ¸…ç†A2UIä¼šè¯
  if (a2uiSessionId.value) {
    a2uiStore.clearSession(a2uiSessionId.value);
    a2uiSessionId.value = null;
  }
  a2uiComponentCount.value = 0;
}

/**
 * ğŸ§± å–æ¶ˆç”Ÿæˆ
 */
function cancelGenerate() {
  if (abortController.value) {
    abortController.value.abort();
    abortController.value = null;
    isGenerating.value = false;
    currentStage.value = 'å·²å–æ¶ˆ';
    ElMessage.info('å·²å–æ¶ˆç”Ÿæˆ');
  }
}

// ğŸ§± ç»„ä»¶é”€æ¯æ—¶æ¸…ç†
onUnmounted(() => {
  // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
  if (abortController.value) {
    abortController.value.abort();
  }
  // æ¸…ç†A2UIä¼šè¯
  if (a2uiSessionId.value) {
    a2uiStore.clearSession(a2uiSessionId.value);
  }
});

/**
 * ç¼–è¾‘è¯¾ç¨‹
 */
function editCurriculum() {
  if (!curriculum.value) return;
  // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
  router.push({
    path: '/teacher-center/creative-curriculum',
    query: { id: curriculum.value.id }
  });
}

/**
 * ä¿å­˜è¯¾ç¨‹
 */
async function saveCurriculum() {
  if (!curriculum.value) return;

  isSaving.value = true;
  try {
    await interactiveCurriculumAPI.saveCurriculum(curriculum.value.id, {
      status: 'published'
    });
    ElMessage.success('è¯¾ç¨‹å·²ä¿å­˜');
  } catch (error) {
    console.error('âŒ ä¿å­˜å¤±è´¥:', error);
    ElMessage.error('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    isSaving.value = false;
  }
}

// å¸ƒå±€ä¿®å¤å·²é€šè¿‡ CSS å®Œæˆï¼Œä¸å†éœ€è¦ JavaScript åŠ¨æ€è®¾ç½®
</script>

<style scoped lang="scss">
.interactive-curriculum-container {
  width: 100%;
  margin: 0 !important;
  padding: var(--spacing-lg);
  background: var(--bg-page);
  min-height: 100vh;

  .page-header {
    margin-bottom: var(--spacing-2xl);
    padding: var(--spacing-2xl);
    background: var(--gradient-purple);
    border-radius: var(--radius-lg);
    box-shadow: 0 var(--spacing-sm) var(--text-3xl) var(--glow-purple);
    color: var(--text-on-primary);

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--spacing-lg);
    }

    .header-title {
      flex: 1;

      h1 {
        font-size: var(--text-3xl);
        margin: 0 0 var(--spacing-sm) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        color: var(--text-on-primary);
        font-weight: var(--font-bold);
      }

      .subtitle {
        margin: 0;
        color: var(--text-on-primary-secondary);
        font-size: var(--text-base);
        font-weight: var(--font-medium);
      }
    }

    .header-badge {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      justify-content: flex-end;

      :deep(.el-tag) {
        background: color-mix(in oklab, var(--el-color-white) 20%, transparent);
        border-color: color-mix(in oklab, var(--el-color-white) 30%, transparent);
        color: var(--text-on-primary);
      }
    }
  }

  .icc-main {
    display: flex;
    flex-direction: row;
    gap: var(--spacing-xl);
    width: 100%;
    max-width: none;
    margin-top: 0;
    align-items: flex-start;
    min-height: calc(100vh - 200px);

    // å·¦ä¾§é¢æ¿
    .left-panel {
      flex: 0 0 480px;
      width: 480px;
      min-width: 480px;
      max-width: 480px;
      position: sticky;
      top: var(--spacing-lg);
      max-height: calc(100vh - 120px);
      overflow-y: auto;

      &::-webkit-scrollbar {
        width: auto;
      }

      &::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: var(--radius-xs);
      }
    }

    // å³ä¾§é¢æ¿
    .right-panel {
      flex: 1 1 auto;
      min-width: 400px;
      max-width: calc(100% - 500px);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    // ç©ºçŠ¶æ€æç¤º
    .empty-result {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-3xl);
      text-align: center;
      border: 2px dashed var(--border-color);

      .empty-icon {
        font-size: var(--text-6xl);
        margin-bottom: var(--spacing-lg);
        opacity: 0.5;
      }

      p {
        margin: 0 0 var(--spacing-sm) 0;
        font-size: var(--text-base);
        color: var(--text-secondary);
      }

      .empty-hint {
        font-size: var(--text-sm);
        color: var(--text-tertiary);
      }
    }

    // æ¬¢è¿å¡ç‰‡
    .welcome-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-2xl);
      margin-top: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: var(--border-width-base) solid var(--border-color);
      width: 100%;

      .welcome-content {
        text-align: center;
      }

      .welcome-icon {
        font-size: var(--text-6xl);
        margin-bottom: var(--spacing-lg);
        display: block;
      }

      h2 {
        font-size: var(--text-2xl);
        margin: 0 0 var(--spacing-md) 0;
        color: var(--text-primary);
        font-weight: var(--font-bold);
      }

      > p {
        font-size: var(--text-base);
        color: var(--text-secondary);
        margin: 0 0 var(--spacing-2xl) 0;
      }

      .quick-start-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-2xl);

        .step {
          display: flex;
          gap: var(--spacing-md);
          align-items: flex-start;
          padding: var(--spacing-lg);
          background: var(--bg-tertiary);
          border-radius: var(--radius-md);
          border-left: var(--spacing-xs) solid var(--primary-color);

          .step-number {
            font-size: var(--text-2xl);
            flex-shrink: 0;
          }

          .step-content {
            text-align: left;

            h4 {
              margin: 0 0 var(--spacing-sm) 0;
              font-size: var(--text-base);
              font-weight: var(--font-semibold);
              color: var(--text-primary);
            }

            p {
              margin: 0;
              font-size: var(--text-sm);
              color: var(--text-secondary);
            }
          }
        }
      }

      .tips-section {
        text-align: left;
        padding: var(--spacing-lg);
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        border-left: var(--spacing-xs) solid var(--primary-color);

        h4 {
          margin: 0 0 var(--spacing-md) 0;
          font-size: var(--text-base);
          font-weight: var(--font-semibold);
          color: var(--text-primary);
        }

        .tips-list {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: var(--spacing-md);
        }

        .tip-item {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          padding: var(--spacing-md) var(--spacing-lg);
          background: var(--bg-card);
          border-radius: var(--radius-sm);
          cursor: pointer;
          transition: var(--transition-normal);
          border: var(--border-width-base) solid var(--border-color);

          &:hover {
            background: var(--primary-color);
            color: var(--text-on-primary);
            border-color: var(--primary-color);
            transform: translateY(var(--transform-hover-lift));
          }

          .tip-icon {
            font-size: var(--text-lg);
          }

          span:last-child {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
          }
        }
      }

      .welcome-actions {
        margin-top: var(--spacing-2xl);
        text-align: center;

        .el-button {
          padding: var(--spacing-lg) var(--spacing-2xl);
          font-size: var(--text-base);
          font-weight: var(--font-semibold);
          border-radius: var(--radius-md);
        }
      }
    }

    // Think æ€è€ƒè¿‡ç¨‹å¡ç‰‡
    .thinking-process-card {
      background: var(--bg-page);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      border: var(--border-width-base) solid var(--border-color);
      border-left: var(--spacing-xs) solid var(--primary-color);

      .thinking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);

        h4 {
          margin: 0;
          font-size: var(--text-base);
          font-weight: var(--font-semibold);
          color: var(--text-primary);
        }
      }

      .thinking-content {
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);

        .thinking-text {
          font-size: var(--text-sm);
          color: var(--text-secondary);
          line-height: 1.6;
          white-space: pre-wrap;
          word-break: break-word;
        }
      }
    }

    // Think æ€è€ƒè¿‡ç¨‹åˆ‡æ¢æŒ‰é’®
    .thinking-toggle {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-page);
      border-radius: var(--radius-sm);
      border: var(--border-width-base) dashed var(--border-color);
      text-align: center;
    }

    // è¾“å…¥å¡ç‰‡
    .input-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: var(--border-width-base) solid var(--border-color);
      width: 100%;

      .input-header {
        margin-bottom: var(--spacing-lg);

        h3 {
          margin: 0 0 var(--spacing-xs) 0;
          font-size: var(--text-lg);
          font-weight: var(--font-bold);
          color: var(--text-primary);
        }

        p {
          margin: 0;
          font-size: var(--text-sm);
          color: var(--text-secondary);

          &.generating-text {
            color: var(--primary-color);
            font-weight: var(--font-medium);
          }
        }
      }

      .input-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);

        .form-group {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-xs);

          label {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--text-primary);

            .required {
              color: var(--danger-color);
              margin-left: var(--spacing-xs);
            }
          }

          .form-hint {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--spacing-sm);
          }
        }

        .form-actions {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-xs);
          margin-top: var(--spacing-sm);

          .generate-btn {
            width: 100%;
            height: var(--button-height-lg);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            background: var(--gradient-purple);
            border: none;

            &:hover {
              background: var(--gradient-purple);
            }
          }
        }

        // ğŸ¨ åª’ä½“é€‰é¡¹æ ·å¼
        .media-options {
          .media-options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: var(--border-width-base) solid var(--border-color);

            .media-option {
              flex: 1;
              min-width: 100px;
              padding: var(--spacing-sm) var(--spacing-md);
              background: var(--bg-card);
              border-radius: var(--radius-sm);
              border: var(--border-width-base) solid var(--border-color);
              transition: var(--transition-normal);

              &:hover {
                border-color: var(--primary-color);
                box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.15);
              }

              :deep(.el-checkbox__label) {
                padding-left: var(--spacing-sm);
              }

              .option-content {
                display: flex;
                align-items: center;
                gap: var(--spacing-xs);

                .option-icon {
                  font-size: var(--text-lg);
                }

                .option-label {
                  font-size: var(--text-sm);
                  font-weight: var(--font-medium);
                  color: var(--text-primary);
                }
              }
            }

            // é€‰ä¸­çŠ¶æ€
            .media-option:has(.el-checkbox.is-checked) {
              background: linear-gradient(135deg, rgba(var(--primary-color-rgb), 0.1) 0%, rgba(var(--primary-color-rgb), 0.05) 100%);
              border-color: var(--primary-color);
            }
          }
        }
      }
    }

    // è¿›åº¦å¡ç‰‡
    .progress-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: var(--border-width-base) solid var(--border-color);
      width: 100%;
      position: relative;
      z-index: var(--z-index-dropdown);

      .progress-header {
        margin-bottom: var(--spacing-md);

        h3 {
          margin: 0 0 var(--spacing-xs) 0;
          font-size: var(--text-base);
          font-weight: var(--font-bold);
          color: var(--text-primary);
        }

        p {
          margin: 0;
          font-size: var(--text-sm);
          color: var(--text-secondary);
        }
      }
    }

    // æˆåŠŸå¡ç‰‡
    .success-card {
      background: var(--gradient-success);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      text-align: center;
      box-shadow: 0 var(--spacing-sm) var(--text-3xl) var(--glow-success);
      color: var(--text-on-primary);
      width: 100%;
      position: relative;
      z-index: var(--z-index-dropdown);

      .success-icon {
        font-size: var(--text-5xl);
        margin-bottom: var(--spacing-md);
        display: block;
      }

      h3 {
        margin: 0 0 var(--spacing-xs) 0;
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
        color: var(--text-on-primary);
      }

      p {
        margin: 0;
        font-size: var(--text-sm);
        color: var(--text-on-primary-secondary);
      }

      .success-message {
        font-size: var(--text-base);
        margin-bottom: var(--spacing-lg);
      }

      .success-actions {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
        margin-bottom: var(--spacing-md);

        .start-course-btn {
          font-size: var(--text-base);
          font-weight: var(--font-bold);
          padding: var(--spacing-md) var(--spacing-2xl);
          background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
          border: none;
          box-shadow: 0 var(--spacing-xs) 15px rgba(102, 126, 234, 0.4);
          transition: all 0.3s ease;

          &:hover {
            transform: translateY(var(--transform-hover-lift));
            box-shadow: 0 6px var(--text-2xl) rgba(102, 126, 234, 0.6);
          }

          &:active {
            transform: translateY(0);
          }
        }

        .view-details-btn {
          font-size: var(--text-base);
          padding: var(--spacing-md) var(--spacing-xl);
        }
      }

      .success-tips {
        text-align: center;
        padding: var(--spacing-sm);
        background: color-mix(in oklab, var(--el-color-white) 20%, transparent);
        border-radius: var(--radius-sm);
        border: var(--border-width-base) dashed color-mix(in oklab, var(--el-color-white) 30%, transparent);

        p {
          margin: 0;
          font-size: var(--text-xs);
          color: var(--text-on-primary-secondary);
        }
      }
    }

    // é¢„è§ˆå¡ç‰‡
    .preview-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-md);
      border: var(--border-width-base) solid var(--border-color);
      width: 100%;
      position: relative;
      z-index: var(--z-index-dropdown);

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);

        h3 {
          margin: 0;
          font-size: var(--text-lg);
          font-weight: var(--font-bold);
          color: var(--text-primary);
        }

        .preview-actions {
          display: flex;
          gap: var(--spacing-sm);
        }
      }

      .preview-tabs {
        :deep(.el-tabs__content) {
          padding: var(--spacing-lg) 0;
        }
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-2xl) var(--spacing-lg);
        color: var(--text-secondary);
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        border: var(--border-width-base) dashed var(--border-color);

        p {
          margin: 0;
          font-size: var(--text-base);
        }
      }
    }
  }
}

/* å…¨å±€æ ·å¼ - è¦†ç›– .page-content å’Œ .main-container çš„é«˜åº¦é™åˆ¶ */
:global(.interactive-curriculum-container) {
  :global(.icc-main) {
    height: auto !important;
    max-height: none !important;
    min-height: auto !important;
    overflow: visible !important;
  }

  :global(.page-content) {
    height: auto !important;
    max-height: none !important;
    min-height: auto !important;
    overflow: visible !important;
  }
}

/* ç§»é™¤çˆ¶å®¹å™¨çš„ paddingï¼Œè®© .interactive-curriculum-container å¡«æ»¡æ•´ä¸ªåŒºåŸŸ */
:global(.creative-curriculum:has(.interactive-curriculum-container)) {
  padding: 0 !important;
}

/* ä»…æœ¬é¡µï¼šå»æ‰ page-content çš„å†…è¾¹è·ï¼Œé¿å…å·¦å³ç•™é»‘ */
:global(.page-content:has(.interactive-curriculum-container)) {
  padding: 0 !important;
}

/* ä»…æœ¬é¡µï¼šå–æ¶ˆ page-content å­å®¹å™¨çš„å±…ä¸­/æœ€å¤§å®½åº¦é™åˆ¶ï¼Œé“ºæ»¡å¯ç”¨å®½åº¦ */
:global(.page-content:has(.interactive-curriculum-container) > .creative-curriculum),
:global(.page-content:has(.interactive-curriculum-container) > .page-container),
:global(.page-content:has(.interactive-curriculum-container) > .center-page) {
  max-width: none !important;
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: var(--breakpoint-xl)) {
  .interactive-curriculum-container {
    .icc-main {
      flex-direction: column;

      .left-panel {
        flex: 1;
        min-width: 100%;
        max-width: 100%;
        position: relative;
        top: 0;
        max-height: none;
      }

      .right-panel {
        width: 100%;
      }
    }
  }
}

@media (max-width: var(--breakpoint-md)) {
  .interactive-curriculum-container {
    padding: var(--spacing-md);

    .page-header {
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);

      .header-content {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .header-title h1 {
        font-size: var(--text-2xl);
      }

      .header-badge {
        justify-content: flex-start;
      }
    }

    .icc-main {
      gap: var(--spacing-lg);

      .welcome-card {
        padding: var(--spacing-lg);
        margin-top: var(--spacing-md);

        .welcome-icon {
          font-size: var(--text-5xl);
          margin-bottom: var(--spacing-md);
        }

        h2 {
          font-size: var(--text-xl);
        }

        .quick-start-steps {
          grid-template-columns: 1fr;
          gap: var(--spacing-md);
        }
      }

      .input-card,
      .progress-card,
      .preview-card {
        padding: var(--spacing-md);
      }

      .success-card {
        padding: var(--spacing-md);

        .success-icon {
          font-size: var(--text-5xl);
          margin-bottom: var(--spacing-sm);
        }

        h3 {
          font-size: var(--text-base);
        }
      }
    }
  }
}

@media (max-width: var(--breakpoint-sm)) {
  .interactive-curriculum-container {
    padding: var(--spacing-sm);

    .page-header {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);

      .header-title h1 {
        font-size: var(--text-xl);
        gap: var(--spacing-sm);
      }

      .header-badge {
        gap: var(--spacing-xs);
      }
    }

    .icc-main {
      gap: var(--spacing-md);

      .welcome-card {
        padding: var(--spacing-md);

        .welcome-icon {
          font-size: var(--text-5xl);
        }

        h2 {
          font-size: var(--text-lg);
        }

        .quick-start-steps {
          grid-template-columns: 1fr;
        }

        .tips-list {
          grid-template-columns: 1fr;
        }
      }

      .input-card,
      .progress-card,
      .preview-card {
        padding: var(--spacing-md);
      }

      .success-card {
        padding: var(--spacing-md);

        .success-icon {
          font-size: var(--text-5xl);
        }
      }
    }
  }
}

// ğŸ§± A2UIæ­ç§¯æœ¨æ¨¡å¼æ ·å¼
.mode-switch {
  .mode-toggle {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    
    .mode-hint {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }
  }
}

.a2ui-preview {
  background: var(--color-bg-elevated);
  border-radius: var(--radius-md);
  padding: var(--spacing-md);
  min-height: 500px;
  
  .a2ui-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    margin-bottom: var(--spacing-md);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    
    .generating-indicator {
      color: var(--el-color-success);
      animation: pulse 1.5s infinite;
    }
  }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

// ç”Ÿæˆæ—¶é—´æç¤º
.generate-time-hint {
  margin-top: var(--spacing-sm);
  text-align: center;
  font-size: var(--text-sm);
  color: var(--text-secondary);
}

// ç¤ºä¾‹æ¨¡æ¿ç½‘æ ¼å¸ƒå±€ï¼ˆ6ä¸ªå¡ç‰‡ï¼‰
.tips-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-sm);
}

// ğŸ¯ å…¨å±è¯¾ç¨‹ä½“éªŒå¼¹çª—æ ·å¼ - å¹»ç¯ç‰‡æ¨¡å¼
:deep(.fullscreen-course-dialog) {
  .el-dialog__header {
    display: none !important;
  }
  
  .el-dialog__body {
    padding: 0 !important;
    height: 100vh;
    overflow: hidden;
    background: #000;
  }
  
  .fullscreen-slideshow-wrapper {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    
    :deep(.a2ui-slideshow) {
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
      border-radius: 0;
      aspect-ratio: auto;
    }
    
    .exit-fullscreen-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      
      &:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
      }
      
      .el-icon {
        font-size: 18px;
      }
    }
  }
  
  .fullscreen-empty {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    color: white;
  }
}
</style>

