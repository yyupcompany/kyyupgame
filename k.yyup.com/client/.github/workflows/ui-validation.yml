name: UIç»„ä»¶è´¨é‡éªŒè¯

on:
  push:
    branches: [ master, main, gameaiweb ]
    paths:
      - 'src/components/**'
      - 'src/pages/**'
      - 'src/styles/**'
  pull_request:
    branches: [ master, main, gameaiweb ]
    paths:
      - 'src/components/**'
      - 'src/pages/**'
      - 'src/styles/**'

jobs:
  ui-validation:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡ŒUIç»„ä»¶éªŒè¯
      run: |
        node validate-ui-components.cjs

    - name: è¿è¡ŒCIéªŒè¯
      run: |
        node ui-validation-ci-tool.cjs --threshold-score 70 --threshold-pass-rate 75
      continue-on-error: true

    - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-validation-reports
        path: |
          ui-component-validation-report.json
          ui-validation-report.md
          ui-validation-github-output.json

    - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          try {
            const report = JSON.parse(fs.readFileSync('ui-validation-github-output.json', 'utf8'));
            const markdown = fs.readFileSync('ui-validation-report.md', 'utf8');

            const { summary, metrics, issues } = report;

            let comment = `## ğŸ¨ UIç»„ä»¶è´¨é‡éªŒè¯æŠ¥å‘Š\n\n`;
            comment += `### ğŸ“Š è´¨é‡æ¦‚è§ˆ\n\n`;
            comment += `- **æ•´ä½“å¾—åˆ†**: ${summary.overallScore}/100\n`;
            comment += `- **é€šè¿‡ç‡**: ${summary.passRate}%\n`;
            comment += `- **è´¨é‡è¯„çº§**: ${summary.qualityGrade}\n`;
            comment += `- **éªŒè¯çŠ¶æ€**: ${summary.status === 'passed' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}\n\n`;

            comment += `### ğŸ“‹ åˆ†ç±»å¾—åˆ†\n\n`;
            comment += `| ç±»åˆ« | å¾—åˆ† |\n`;
            comment += `|------|------|\n`;
            comment += `| ä¸­å¿ƒç»„ä»¶ | ${metrics['center-components-score']}/100 |\n`;
            comment += `| ç³»ç»Ÿç»„ä»¶ | ${metrics['system-components-score']}/100 |\n`;
            comment += `| æ´»åŠ¨ç»„ä»¶ | ${metrics['activity-components-score']}/100 |\n\n`;

            if (issues.length > 0) {
              comment += `### âš ï¸ å‘ç°çš„é—®é¢˜\n\n`;
              issues.forEach((issue, index) => {
                const icons = { high: 'âŒ', medium: 'âš ï¸', low: 'â„¹ï¸' };
                comment += `${index + 1}. ${icons[issue.severity]} ${issue.message}\n`;
              });
              comment += `\n`;
            }

            comment += `<details>\n<summary>ğŸ“„ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š</summary>\n\n`;
            comment += markdown;
            comment += `\n</details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('æ— æ³•ç”ŸæˆPRè¯„è®º:', error.message);
          }

    - name: è®¾ç½®è´¨é‡æŒ‡æ ‡
      if: github.event_name == 'pull_request'
      run: |
        echo "UI_COMPONENTS_SCORE=$(node -p "
          try {
            const report = JSON.parse(require('fs').readFileSync('ui-validation-github-output.json', 'utf8'));
            report.metrics['ui-components-score'];
          } catch {
            0;
          }
        ")" >> $GITHUB_ENV

        echo "UI_COMPONENTS_PASS_RATE=$(node -p "
          try {
            const report = JSON.parse(require('fs').readFileSync('ui-validation-github-output.json', 'utf8'));
            report.metrics['ui-components-pass-rate'];
          } catch {
            0;
          }
        ")" >> $GITHUB_ENV

    - name: åˆ›å»ºçŠ¶æ€æ£€æŸ¥
      if: github.event_name == 'pull_request'
      run: |
        if [ "${{ env.UI_COMPONENTS_SCORE }}" -ge 70 ] && [ "${{ env.UI_COMPONENTS_PASS_RATE }}" -ge 75 ]; then
          echo "âœ… UIç»„ä»¶è´¨é‡æ£€æŸ¥é€šè¿‡"
          exit 0
        else
          echo "âŒ UIç»„ä»¶è´¨é‡æ£€æŸ¥å¤±è´¥"
          echo "å¾—åˆ†: ${{ env.UI_COMPONENTS_SCORE }}/100, é€šè¿‡ç‡: ${{ env.UI_COMPONENTS_PASS_RATE }}%"
          exit 1
        fi