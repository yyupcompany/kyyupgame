# ğŸ”§ äººå‘˜æ·»åŠ å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

**æ–¹æ¡ˆç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**ä¼˜å…ˆçº§**: ğŸ”´ **é«˜**

---

## ğŸ“‹ é—®é¢˜æ€»ç»“

### å½“å‰çŠ¶æ€

åœ¨äººå‘˜ä¸­å¿ƒæ·»åŠ äººå‘˜æ—¶ï¼Œ**åªç”Ÿæˆäº†éƒ¨åˆ†è®°å½•**ï¼š

| è®°å½•ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| User è¡¨ | âœ… | åˆ›å»ºäº†ç”¨æˆ·è®°å½• |
| Teacher è¡¨ | âœ… | åˆ›å»ºäº†æ•™å¸ˆè®°å½• |
| user_roles è¡¨ | âŒ | **ç¼ºå¤±** - æ²¡æœ‰ç»‘å®šè§’è‰² |
| group_id | âŒ | **ç¼ºå¤±** - æ²¡æœ‰ç»‘å®šé›†å›¢ID |

### ç¼ºå¤±çš„åŠŸèƒ½

1. âŒ **æ²¡æœ‰åˆ›å»º user_roles å…³è”** - ç”¨æˆ·æ²¡æœ‰æ˜ç¡®çš„è§’è‰²æƒé™
2. âŒ **æ²¡æœ‰ç»‘å®š group_id** - æ— æ³•è¿½è¸ªæ•™å¸ˆå±äºå“ªä¸ªé›†å›¢
3. âŒ **Teacher æ¨¡å‹ç¼ºå°‘ group_id å­—æ®µ** - æ•°æ®åº“ç»“æ„ä¸å®Œæ•´
4. âŒ **æ²¡æœ‰æ•°æ®éªŒè¯** - æ²¡æœ‰éªŒè¯å¹¼å„¿å›­æ˜¯å¦å±äºè¯¥é›†å›¢

---

## âœ… å®Œæ•´çš„ä¿®å¤æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šä¿®æ”¹ Teacher æ¨¡å‹ï¼Œæ·»åŠ  group_id å­—æ®µ

**æ–‡ä»¶**: `server/src/models/teacher.model.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
export class Teacher extends Model<...> {
  declare id: CreationOptional<number>;
  declare userId: ForeignKey<User['id']>;
  declare kindergartenId: ForeignKey<Kindergarten['id']>;
  declare groupId: ForeignKey<Group['id']> | null;  // âœ… æ–°å¢
  declare teacherNo: string;
  // ... å…¶ä»–å­—æ®µ
}

export const initTeacher = (sequelize: Sequelize) => {
  Teacher.init({
    // ... å…¶ä»–å­—æ®µ
    groupId: {
      type: DataTypes.INTEGER,
      allowNull: true,
      field: 'group_id',
      comment: 'æ‰€å±é›†å›¢ID',
      references: {
        model: 'groups',
        key: 'id'
      }
    },
    // ... å…¶ä»–å­—æ®µ
  });
};
```

### æ­¥éª¤2ï¼šåˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶

**æ–‡ä»¶**: `server/src/migrations/20250110000004-add-group-id-to-teachers.js`

```javascript
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.addColumn('teachers', 'group_id', {
      type: Sequelize.INTEGER,
      allowNull: true,
      comment: 'æ‰€å±é›†å›¢ID',
      references: {
        model: 'groups',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    });
  },
  
  async down(queryInterface, Sequelize) {
    await queryInterface.removeColumn('teachers', 'group_id');
  }
};
```

### æ­¥éª¤3ï¼šä¿®æ”¹æ·»åŠ æ•™å¸ˆçš„è·¯ç”±

**æ–‡ä»¶**: `server/src/routes/teachers.routes.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
router.post('/', async (req, res) => {
  const transaction = await sequelize.transaction();
  
  try {
    const { realName, phone, email, teacherNo, position, hireDate, education, major, roleId } = req.body;
    const kindergartenId = (req.user as any)?.kindergartenId;
    const creatorId = (req.user as any)?.id;
    
    if (!kindergartenId) {
      await transaction.rollback();
      return ApiResponse.error(res, 'ç”¨æˆ·æœªå…³è”å¹¼å„¿å›­', 'BAD_REQUEST', 400);
    }
    
    // âœ… æ­¥éª¤1ï¼šè·å–å¹¼å„¿å›­ä¿¡æ¯ï¼ŒåŒ…æ‹¬ group_id
    const kindergartenResult = await sequelize.query(
      `SELECT id, group_id FROM kindergartens WHERE id = :kindergartenId`,
      { replacements: { kindergartenId }, type: 'SELECT', transaction }
    );
    
    const kindergartenList = Array.isArray(kindergartenResult) ? kindergartenResult : [];
    if (kindergartenList.length === 0) {
      await transaction.rollback();
      return ApiResponse.error(res, 'å¹¼å„¿å›­ä¸å­˜åœ¨', 'BAD_REQUEST', 400);
    }
    
    const groupId = (kindergartenList[0] as any).group_id;
    
    // âœ… æ­¥éª¤2ï¼šåˆ›å»º User è®°å½•
    const user = await User.create({
      username: phone,
      password: await bcrypt.hash('123456', 10),
      realName,
      phone,
      email,
      role: 'teacher' as any,
      status: 'active' as any
    }, { transaction });
    
    console.log('âœ… Useråˆ›å»ºæˆåŠŸ, ID:', user.id);
    
    // âœ… æ­¥éª¤3ï¼šåˆ›å»º user_roles å…³è”
    if (roleId) {
      await sequelize.query(
        `INSERT INTO user_roles (user_id, role_id, created_at, updated_at) 
         VALUES (:userId, :roleId, NOW(), NOW())`,
        {
          replacements: { userId: user.id, roleId },
          type: 'INSERT',
          transaction
        }
      );
      console.log('âœ… user_rolesåˆ›å»ºæˆåŠŸ');
    }
    
    // âœ… æ­¥éª¤4ï¼šåˆ›å»º Teacher è®°å½•ï¼ˆåŒ…å« group_idï¼‰
    const teacher = await Teacher.create({
      userId: user.id,
      kindergartenId,
      groupId,  // âœ… ç»‘å®šé›†å›¢ID
      teacherNo,
      position,
      hireDate,
      education,
      major,
      creatorId,
      status: 1
    }, { transaction });
    
    console.log('âœ… Teacheråˆ›å»ºæˆåŠŸ, ID:', teacher.id);
    
    await transaction.commit();
    
    return ApiResponse.success(res, {
      user: {
        id: user.id,
        username: user.username,
        realName: user.realName,
        phone: user.phone,
        email: user.email,
        role: user.role,
        status: user.status
      },
      teacher: {
        id: teacher.id,
        userId: teacher.userId,
        kindergartenId: teacher.kindergartenId,
        groupId: teacher.groupId,  // âœ… è¿”å›é›†å›¢ID
        teacherNo: teacher.teacherNo,
        position: teacher.position,
        status: teacher.status
      }
    }, 'åˆ›å»ºæ•™å¸ˆæˆåŠŸ');
    
  } catch (error) {
    await transaction.rollback();
    console.error('åˆ›å»ºæ•™å¸ˆå¤±è´¥:', error);
    return ApiResponse.error(res, 'åˆ›å»ºæ•™å¸ˆå¤±è´¥', 'INTERNAL_ERROR', 500);
  }
});
```

---

## ğŸ“Š ä¿®å¤åçš„æ•°æ®ç»“æ„

### æ·»åŠ æ•™å¸ˆæ—¶ç”Ÿæˆçš„è®°å½•

```
1. User è¡¨
   â”œâ”€â”€ id: 123
   â”œâ”€â”€ username: 13800138000
   â”œâ”€â”€ realName: å¼ ä¸‰
   â”œâ”€â”€ phone: 13800138000
   â”œâ”€â”€ email: zhangsan@example.com
   â”œâ”€â”€ role: teacher
   â””â”€â”€ status: active

2. user_roles è¡¨
   â”œâ”€â”€ user_id: 123
   â”œâ”€â”€ role_id: 3 (æ•™å¸ˆè§’è‰²)
   â””â”€â”€ created_at: 2025-10-28

3. Teacher è¡¨
   â”œâ”€â”€ id: 456
   â”œâ”€â”€ user_id: 123
   â”œâ”€â”€ kindergarten_id: 1
   â”œâ”€â”€ group_id: 1 âœ… æ–°å¢
   â”œâ”€â”€ teacher_no: T001
   â”œâ”€â”€ position: 5 (æ™®é€šæ•™å¸ˆ)
   â””â”€â”€ status: 1 (åœ¨èŒ)
```

---

## ğŸ¯ ä¿®å¤æ¸…å•

### ç«‹å³éœ€è¦ (ä¼˜å…ˆçº§ï¼šğŸ”´ é«˜)

- [ ] ä¿®æ”¹ Teacher æ¨¡å‹ï¼Œæ·»åŠ  group_id å­—æ®µ
- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶
- [ ] ä¿®æ”¹ teachers.routes.tsï¼Œæ·»åŠ  user_roles å’Œ group_id ç»‘å®š
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æµ‹è¯•æ·»åŠ æ•™å¸ˆçš„å®Œæ•´æµç¨‹

### éœ€è¦æ£€æŸ¥çš„å…¶ä»–äººå‘˜ç±»å‹ (ä¼˜å…ˆçº§ï¼šğŸŸ¡ ä¸­)

- [ ] æ·»åŠ ç®¡ç†å‘˜æ—¶æ˜¯å¦æœ‰ç›¸åŒé—®é¢˜
- [ ] æ·»åŠ å›­é•¿æ—¶æ˜¯å¦æœ‰ç›¸åŒé—®é¢˜
- [ ] æ·»åŠ å…¶ä»–å‘˜å·¥æ—¶æ˜¯å¦æœ‰ç›¸åŒé—®é¢˜

### é•¿æœŸè§„åˆ’ (ä¼˜å…ˆçº§ï¼šğŸŸ¢ ä½)

- [ ] ä¸ºå…¶ä»–äººå‘˜ç±»å‹æ·»åŠ ç›¸åŒçš„é€»è¾‘
- [ ] æ·»åŠ å®Œæ•´çš„æ•°æ®éªŒè¯
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹

---

## âœ¨ ä¿®å¤åçš„ä¼˜åŠ¿

âœ… **å®Œæ•´çš„ç”¨æˆ·è®°å½•** - User + user_roles + Teacher  
âœ… **é›†å›¢æ•°æ®éš”ç¦»** - é€šè¿‡ group_id å®ç°éš”ç¦»  
âœ… **æ•°æ®ä¸€è‡´æ€§** - ç¡®ä¿å¹¼å„¿å›­å’Œé›†å›¢çš„å…³ç³»æ­£ç¡®  
âœ… **æƒé™ç®¡ç†** - é€šè¿‡ user_roles ç®¡ç†ç”¨æˆ·æƒé™  

---

**è¿™ä¸ªä¿®å¤æ–¹æ¡ˆå°†ç¡®ä¿æ·»åŠ äººå‘˜æ—¶ç”Ÿæˆå®Œæ•´çš„è®°å½•ï¼** âœ…


