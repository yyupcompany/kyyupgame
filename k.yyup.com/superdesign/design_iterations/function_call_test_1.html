<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Call æ™ºèƒ½æµ‹è¯•ç•Œé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-blue': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                            950: '#172554'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-deep-blue-50 to-deep-blue-100 font-sans">
    <div class="min-h-screen p-4">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="max-w-7xl mx-auto mb-8">
            <div class="text-center py-8">
                <h1 class="text-4xl font-bold text-deep-blue-900 mb-4">ğŸ§  Function Call æ™ºèƒ½æµ‹è¯•ä¸­å¿ƒ</h1>
                <p class="text-lg text-deep-blue-700">æµ‹è¯•å¹¼å„¿å›­AIåŠ©æ‰‹çš„æ™ºèƒ½ç†è§£ä¸å·¥å…·è°ƒç”¨èƒ½åŠ›</p>
            </div>
        </div>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- å·¦ä¾§ï¼šæµ‹è¯•è¾“å…¥åŒºåŸŸ -->
            <div class="lg:col-span-1 space-y-6">
                <!-- æµ‹è¯•è¾“å…¥ -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-deep-blue-100">
                    <h2 class="text-xl font-semibold text-deep-blue-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-deep-blue-500 rounded-full flex items-center justify-center text-white text-sm mr-3">1</span>
                        æ™ºèƒ½æŸ¥è¯¢è¾“å…¥
                    </h2>
                    <div class="space-y-4">
                        <textarea id="queryInput" 
                                  class="w-full h-32 p-4 border-2 border-deep-blue-200 rounded-xl resize-none focus:border-deep-blue-500 focus:ring-2 focus:ring-deep-blue-200 transition-all" 
                                  placeholder="è¾“å…¥æ‚¨çš„å¤æ‚æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ æŸ¥è¯¢æœ€å—æ¬¢è¿çš„æ´»åŠ¨ç±»å‹&#10;â€¢ åˆ†ææ‹›ç”Ÿè¶‹åŠ¿å’Œæ•°æ®&#10;â€¢ ç»Ÿè®¡å­¦ç”Ÿå‚ä¸æ´»åŠ¨çš„æƒ…å†µ&#10;â€¢ åˆ›å»ºä¸€ä¸ªæ˜¥å­£äº²å­æ´»åŠ¨"></textarea>
                        
                        <button id="testBtn" 
                                class="w-full bg-deep-blue-600 hover:bg-deep-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition-all transform hover:scale-105 focus:ring-4 focus:ring-deep-blue-300">
                            ğŸš€ æ‰§è¡Œæ™ºèƒ½åˆ†æ
                        </button>
                    </div>
                </div>

                <!-- é¢„è®¾æµ‹è¯•ç”¨ä¾‹ -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-deep-blue-100">
                    <h2 class="text-xl font-semibold text-deep-blue-900 mb-4 flex items-center">
                        <span class="w-8 h-8 bg-deep-blue-500 rounded-full flex items-center justify-center text-white text-sm mr-3">2</span>
                        æ™ºèƒ½æµ‹è¯•ç”¨ä¾‹
                    </h2>
                    <div class="space-y-2">
                        <button class="test-case w-full text-left p-3 bg-deep-blue-50 hover:bg-deep-blue-100 rounded-xl transition-all text-sm text-deep-blue-800" 
                                data-query="æŸ¥è¯¢è¿‡å»3ä¸ªæœˆæœ€å—æ¬¢è¿çš„æ´»åŠ¨">
                            ğŸ¯ ç®€å•æŸ¥è¯¢ï¼šæ´»åŠ¨æ•°æ®åˆ†æ
                        </button>
                        <button class="test-case w-full text-left p-3 bg-deep-blue-50 hover:bg-deep-blue-100 rounded-xl transition-all text-sm text-deep-blue-800" 
                                data-query="å¸®æˆ‘åˆ†æä¸€ä¸‹ä»Šå¹´çš„æ‹›ç”Ÿæƒ…å†µï¼ŒåŒ…æ‹¬å„ä¸ªæœˆä»½çš„ç”³è¯·æ•°é‡å’Œå½•å–ç‡">
                            ğŸ“Š å¤æ‚åˆ†æï¼šæ‹›ç”Ÿè¶‹åŠ¿ç»Ÿè®¡
                        </button>
                        <button class="test-case w-full text-left p-3 bg-deep-blue-50 hover:bg-deep-blue-100 rounded-xl transition-all text-sm text-deep-blue-800" 
                                data-query="æŸ¥æ‰¾å‚ä¸æ´»åŠ¨æœ€å¤šçš„å­¦ç”Ÿï¼Œå¹¶æ˜¾ç¤ºä»–ä»¬çš„è¯¦ç»†ä¿¡æ¯">
                            ğŸ” å…³è”æŸ¥è¯¢ï¼šå­¦ç”Ÿæ´»åŠ¨å‚ä¸åº¦
                        </button>
                        <button class="test-case w-full text-left p-3 bg-deep-blue-50 hover:bg-deep-blue-100 rounded-xl transition-all text-sm text-deep-blue-800" 
                                data-query="æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªæ¯äº²èŠ‚äº²å­æ´»åŠ¨ï¼Œæ—¶é—´åœ¨5æœˆ12æ—¥ä¸‹åˆï¼Œåœ°ç‚¹åœ¨å¤šåŠŸèƒ½å…ï¼Œé™50äºº">
                            âš¡ ä¸šåŠ¡æ“ä½œï¼šæ™ºèƒ½æ´»åŠ¨åˆ›å»º
                        </button>
                        <button class="test-case w-full text-left p-3 bg-deep-blue-50 hover:bg-deep-blue-100 rounded-xl transition-all text-sm text-deep-blue-800" 
                                data-query="æ¯”è¾ƒä¸åŒç­çº§å­¦ç”Ÿçš„æ´»åŠ¨å‚ä¸æƒ…å†µï¼Œæ‰¾å‡ºå‚ä¸åº¦æœ€é«˜çš„ç­çº§">
                            ğŸ“ˆ é«˜çº§æŸ¥è¯¢ï¼šå¤šè¡¨å…³è”åˆ†æ
                        </button>
                        <button class="test-case w-full text-left p-3 bg-orange-50 hover:bg-orange-100 rounded-xl transition-all text-sm text-orange-800" 
                                data-query="è¯·å…ˆæŸ¥è¯¢æœ€å—æ¬¢è¿çš„3ä¸ªæ´»åŠ¨ï¼Œç„¶ååŸºäºè¿™äº›æ•°æ®åˆ›å»ºä¸€ä¸ªæ–°çš„ç»¼åˆæ€§äº²å­æ´»åŠ¨">
                            ğŸ”„ å¤šæ­¥éª¤ï¼šæŸ¥è¯¢+åˆ›å»ºä»»åŠ¡
                        </button>
                        <button class="test-case w-full text-left p-3 bg-purple-50 hover:bg-purple-100 rounded-xl transition-all text-sm text-purple-800" 
                                data-query="å¸®æˆ‘åˆ†ææ‹›ç”Ÿè¶‹åŠ¿ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœåˆ¶å®šä¸‹ä¸ªæœˆçš„è¥é”€ç­–ç•¥">
                            ğŸ§  å¤æ‚ä»»åŠ¡ï¼šåˆ†æ+å†³ç­–+è§„åˆ’
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="lg:col-span-2 space-y-6">
                <!-- å“åº”çŠ¶æ€ -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-deep-blue-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-deep-blue-900">ğŸ¯ AIå“åº”çŠ¶æ€</h2>
                        <div id="statusBadge" class="px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                            ç­‰å¾…æµ‹è¯•...
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="p-4 bg-deep-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-deep-blue-900" id="responseTime">--</div>
                            <div class="text-sm text-deep-blue-600">å“åº”æ—¶é—´(ms)</div>
                        </div>
                        <div class="p-4 bg-deep-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-deep-blue-900" id="toolsUsed">--</div>
                            <div class="text-sm text-deep-blue-600">è°ƒç”¨å·¥å…·æ•°</div>
                        </div>
                        <div class="p-4 bg-deep-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-deep-blue-900" id="dataCount">--</div>
                            <div class="text-sm text-deep-blue-600">è¿”å›æ•°æ®é‡</div>
                        </div>
                        <div class="p-4 bg-deep-blue-50 rounded-xl">
                            <div class="text-2xl font-bold text-deep-blue-900" id="modelUsed">--</div>
                            <div class="text-sm text-deep-blue-600">AIæ¨¡å‹</div>
                        </div>
                    </div>
                </div>

                <!-- å·¥å…·è°ƒç”¨åˆ†æ -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-deep-blue-100">
                    <h2 class="text-xl font-semibold text-deep-blue-900 mb-4">ğŸ”§ Function Tools è°ƒç”¨åˆ†æ</h2>
                    <div id="toolAnalysis" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-6xl mb-4">ğŸ¤–</div>
                            <p>ç­‰å¾…AIæ‰§è¡ŒFunction Call...</p>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®ç»“æœå±•ç¤º -->
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-deep-blue-100">
                    <h2 class="text-xl font-semibold text-deep-blue-900 mb-4">ğŸ“Š æŸ¥è¯¢ç»“æœå±•ç¤º</h2>
                    <div id="dataResults" class="min-h-64">
                        <div class="text-center text-gray-500 py-12">
                            <div class="text-6xl mb-4">ğŸ“ˆ</div>
                            <p>æŸ¥è¯¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                            <p class="text-sm mt-2">æ”¯æŒè¡¨æ ¼ã€å›¾è¡¨ã€æ‘˜è¦ç­‰å¤šç§æ ¼å¼</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€æ¨¡æ€æ¡† -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm mx-4 text-center">
            <div class="animate-spin w-12 h-12 border-4 border-deep-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-deep-blue-900 mb-2">AIæ­£åœ¨æ€è€ƒ...</h3>
            <p class="text-sm text-deep-blue-600">æ­£åœ¨åˆ†ææ‚¨çš„æŸ¥è¯¢å¹¶è°ƒç”¨ç›¸åº”å·¥å…·</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isLoading = false;

        // DOM å…ƒç´ 
        const queryInput = document.getElementById('queryInput');
        const testBtn = document.getElementById('testBtn');
        const testCases = document.querySelectorAll('.test-case');
        const loadingModal = document.getElementById('loadingModal');
        const statusBadge = document.getElementById('statusBadge');

        // é¢„è®¾æµ‹è¯•ç”¨ä¾‹ç‚¹å‡»äº‹ä»¶
        testCases.forEach(btn => {
            btn.addEventListener('click', () => {
                queryInput.value = btn.dataset.query;
                queryInput.focus();
            });
        });

        // ä¸»æµ‹è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        testBtn.addEventListener('click', async () => {
            const query = queryInput.value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }
            await executeTest(query);
        });

        // æ‰§è¡Œæµ‹è¯•å‡½æ•°
        async function executeTest(query) {
            if (isLoading) return;
            
            isLoading = true;
            loadingModal.classList.remove('hidden');
            updateStatus('processing', 'ğŸ¤– AIåˆ†æä¸­...');
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('http://localhost:3000/api/ai/function-tools/smart-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxMjEsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTQ1NDQzOTksImV4cCI6ODY0MDAwMDAwMDAwMH0.mockSignatureForDevAndTestingPurposesOnly'
                    },
                    body: JSON.stringify({
                        messages: [{
                            role: 'user',
                            content: query
                        }],
                        conversation_id: Date.now().toString(),
                        max_iterations: 5
                    })
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    updateStatus('success', 'âœ… æ‰§è¡ŒæˆåŠŸ');
                    displayResults(data.data, responseTime, query);
                } else {
                    throw new Error(data.error || 'æ‰§è¡Œå¤±è´¥');
                }

            } catch (error) {
                updateStatus('error', 'âŒ æ‰§è¡Œå¤±è´¥');
                displayError(error.message, Date.now() - startTime);
            } finally {
                isLoading = false;
                loadingModal.classList.add('hidden');
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const colors = {
                processing: 'bg-yellow-100 text-yellow-800',
                success: 'bg-green-100 text-green-800', 
                error: 'bg-red-100 text-red-800'
            };
            statusBadge.className = `px-4 py-2 rounded-full text-sm font-medium ${colors[status]}`;
            statusBadge.textContent = text;
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(data, responseTime, originalQuery) {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('responseTime').textContent = responseTime;
            document.getElementById('modelUsed').textContent = data.model_used?.split('-').pop() || 'AI';
            
            // å¦‚æœæœ‰å¤šè½®å¯¹è¯å†å²
            if (data.conversation_history && data.conversation_history.length > 0) {
                const totalTools = data.conversation_history.reduce((sum, round) => 
                    sum + (round.tool_calls?.length || 0), 0);
                document.getElementById('toolsUsed').textContent = totalTools + ` (${data.iterations}è½®)`;
                
                displayConversationHistory(data.conversation_history);
            } else {
                // æ—§æ ¼å¼å…¼å®¹
                document.getElementById('toolsUsed').textContent = data.tool_calls?.length || 0;
                displayToolAnalysis(data.tool_calls, data.tool_results);
                displayDataResults(data.tool_results, originalQuery);
            }
            
            // æ›´æ–°æ•°æ®é‡
            let totalRecords = 0;
            if (data.conversation_history) {
                data.conversation_history.forEach(round => {
                    if (round.tool_results) {
                        round.tool_results.forEach(result => {
                            const parsedResult = JSON.parse(result.content);
                            totalRecords += parsedResult.data?.length || parsedResult.summary?.recordCount || 0;
                        });
                    }
                });
            } else {
                totalRecords = data.tool_results?.reduce((sum, result) => {
                    return sum + (result.result?.data?.length || result.result?.summary?.recordCount || 0);
                }, 0) || 0;
            }
            document.getElementById('dataCount').textContent = totalRecords;
        }

        // æ˜¾ç¤ºå¤šè½®å¯¹è¯å†å²
        function displayConversationHistory(conversationHistory) {
            const toolContainer = document.getElementById('toolAnalysis');
            const dataContainer = document.getElementById('dataResults');
            
            let toolHtml = '';
            let dataHtml = '';
            
            conversationHistory.forEach((round, index) => {
                // æ˜¾ç¤ºæ¯è½®çš„AIå›å¤
                if (round.ai_response) {
                    toolHtml += `
                        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-xl">
                            <h4 class="font-medium text-blue-900 mb-2">ğŸ¤– ç¬¬${round.iteration}è½® AIå›å¤</h4>
                            <p class="text-sm text-gray-700">${round.ai_response}</p>
                            <div class="text-xs text-gray-500 mt-2">${new Date(round.timestamp).toLocaleTimeString()}</div>
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºå·¥å…·è°ƒç”¨
                if (round.tool_calls && round.tool_calls.length > 0) {
                    round.tool_calls.forEach((toolCall, toolIndex) => {
                        const toolResult = round.tool_results?.[toolIndex];
                        const isSuccess = toolResult && !JSON.parse(toolResult.content).error;
                        
                        toolHtml += `
                            <div class="border-l-4 ${isSuccess ? 'border-green-500' : 'border-red-500'} pl-4 py-3 bg-gray-50 rounded-r-xl mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-deep-blue-900">ğŸ”§ ${toolCall.function.name}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs px-2 py-1 rounded-full ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}
                                        </span>
                                        <span class="text-xs text-gray-500">ç¬¬${round.iteration}è½®</span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-700 space-y-2">
                                    <div><strong>å‚æ•°:</strong> <code class="bg-gray-200 px-2 py-1 rounded text-xs">${toolCall.function.arguments}</code></div>
                                </div>
                            </div>
                        `;
                        
                        // æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
                        if (toolResult) {
                            try {
                                const resultData = JSON.parse(toolResult.content);
                                if (resultData.data && Array.isArray(resultData.data)) {
                                    dataHtml += generateDataTable(resultData, `ç¬¬${round.iteration}è½® - ${toolCall.function.name}`, index * 10 + toolIndex);
                                }
                            } catch (e) {
                                console.warn('è§£æå·¥å…·ç»“æœå¤±è´¥:', e);
                            }
                        }
                    });
                }
            });
            
            // æ·»åŠ æœ€ç»ˆæ€»ç»“
            toolHtml += `
                <div class="mt-4 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-xl">
                    <h4 class="font-medium text-green-900 mb-2">âœ… å¯¹è¯å®Œæˆ</h4>
                    <p class="text-sm text-gray-700">å…±è¿›è¡Œäº† ${conversationHistory.length} è½®å¯¹è¯ï¼ŒæˆåŠŸå®Œæˆä»»åŠ¡</p>
                </div>
            `;
            
            toolContainer.innerHTML = toolHtml;
            dataContainer.innerHTML = dataHtml || '<div class="text-center text-gray-500 py-4">æ²¡æœ‰è¿”å›æ•°æ®ç»“æœ</div>';
        }
        
        // ç”Ÿæˆæ•°æ®è¡¨æ ¼
        function generateDataTable(resultData, title, index) {
            if (!resultData.data || !Array.isArray(resultData.data) || resultData.data.length === 0) {
                return '';
            }
            
            const data = resultData.data;
            const headers = Object.keys(data[0]);
            const rows = data.slice(0, 10);
            
            return `
                <div class="mb-6">
                    <h3 class="font-semibold text-deep-blue-900 mb-3">ğŸ“Š ${title}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto border-collapse">
                            <thead>
                                <tr class="bg-deep-blue-50">
                                    ${headers.map(h => `<th class="border border-deep-blue-200 px-4 py-2 text-left text-sm font-medium text-deep-blue-900">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${rows.map(row => `
                                    <tr class="hover:bg-deep-blue-25">
                                        ${headers.map(h => `<td class="border border-deep-blue-100 px-4 py-2 text-sm text-gray-700">${formatValue(row[h])}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${data.length > 10 ? `<p class="text-sm text-gray-500 mt-2">æ˜¾ç¤ºå‰10æ¡ï¼Œå…±${data.length}æ¡è®°å½•</p>` : ''}
                    ${resultData.metadata?.summary ? `
                        <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                            <h4 class="font-medium text-deep-blue-900 mb-2">ğŸ“ˆ æ•°æ®æ‘˜è¦</h4>
                            <pre class="text-sm text-gray-700">${JSON.stringify(resultData.metadata.summary, null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // æ˜¾ç¤ºå·¥å…·è°ƒç”¨åˆ†æ
        function displayToolAnalysis(toolCalls, toolResults) {
            const container = document.getElementById('toolAnalysis');
            
            if (!toolCalls || toolCalls.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>æ²¡æœ‰è°ƒç”¨Function Tools</p>
                        <p class="text-sm">AIä½¿ç”¨äº†æ™®é€šå›å¤æ¨¡å¼</p>
                    </div>
                `;
                return;
            }

            const html = toolCalls.map((call, index) => {
                const result = toolResults?.[index];
                const isSuccess = result?.result?.status !== 'error';
                
                return `
                    <div class="border-l-4 ${isSuccess ? 'border-green-500' : 'border-red-500'} pl-4 py-3 bg-gray-50 rounded-r-xl">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-deep-blue-900">ğŸ”§ ${call.function.name}</h3>
                            <span class="text-xs px-2 py-1 rounded-full ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}
                            </span>
                        </div>
                        <div class="text-sm text-gray-700 space-y-2">
                            <div><strong>å‚æ•°:</strong> <code class="bg-gray-200 px-2 py-1 rounded text-xs">${call.function.arguments}</code></div>
                            ${result?.result?.metadata?.explanation ? `<div><strong>è¯´æ˜:</strong> ${result.result.metadata.explanation}</div>` : ''}
                            ${result?.result?.metadata?.generatedSQL ? `<div><strong>SQL:</strong> <code class="bg-blue-100 px-2 py-1 rounded text-xs">${result.result.metadata.generatedSQL}</code></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ•°æ®ç»“æœ
        function displayDataResults(toolResults, originalQuery) {
            const container = document.getElementById('dataResults');
            
            if (!toolResults || toolResults.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>æ²¡æœ‰è¿”å›æ•°æ®ç»“æœ</p>
                    </div>
                `;
                return;
            }

            const html = toolResults.map((result, index) => {
                const data = result.result?.data || result.result?.result;
                const metadata = result.result?.metadata;
                
                if (!data) return '';

                if (Array.isArray(data) && data.length > 0) {
                    // è¡¨æ ¼æ˜¾ç¤º
                    const headers = Object.keys(data[0]);
                    const rows = data.slice(0, 10); // åªæ˜¾ç¤ºå‰10æ¡

                    return `
                        <div class="mb-6">
                            <h3 class="font-semibold text-deep-blue-900 mb-3">ğŸ“Š ${metadata?.name || 'æŸ¥è¯¢ç»“æœ'} ${index + 1}</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full table-auto border-collapse">
                                    <thead>
                                        <tr class="bg-deep-blue-50">
                                            ${headers.map(h => `<th class="border border-deep-blue-200 px-4 py-2 text-left text-sm font-medium text-deep-blue-900">${h}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rows.map(row => `
                                            <tr class="hover:bg-deep-blue-25">
                                                ${headers.map(h => `<td class="border border-deep-blue-100 px-4 py-2 text-sm text-gray-700">${formatValue(row[h])}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${data.length > 10 ? `<p class="text-sm text-gray-500 mt-2">æ˜¾ç¤ºå‰10æ¡ï¼Œå…±${data.length}æ¡è®°å½•</p>` : ''}
                            ${metadata?.summary ? `
                                <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                                    <h4 class="font-medium text-deep-blue-900 mb-2">ğŸ“ˆ æ•°æ®æ‘˜è¦</h4>
                                    <pre class="text-sm text-gray-700">${JSON.stringify(metadata.summary, null, 2)}</pre>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else if (data.type) {
                    // ç‰¹æ®Šæ ¼å¼æ˜¾ç¤º
                    return `
                        <div class="mb-6">
                            <h3 class="font-semibold text-deep-blue-900 mb-3">ğŸ“‹ ${data.type} ç»“æœ</h3>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <pre class="text-sm text-gray-700 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                } else {
                    // é»˜è®¤JSONæ˜¾ç¤º
                    return `
                        <div class="mb-6">
                            <h3 class="font-semibold text-deep-blue-900 mb-3">ğŸ“„ åŸå§‹ç»“æœ</h3>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <pre class="text-sm text-gray-700">${JSON.stringify(result, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            container.innerHTML = html || '<div class="text-center text-gray-500 py-4">æ²¡æœ‰å¯æ˜¾ç¤ºçš„æ•°æ®</div>';
        }

        // æ˜¾ç¤ºé”™è¯¯
        function displayError(message, responseTime) {
            document.getElementById('responseTime').textContent = responseTime;
            document.getElementById('toolsUsed').textContent = 0;
            document.getElementById('dataCount').textContent = 0;
            document.getElementById('modelUsed').textContent = 'N/A';
            
            document.getElementById('toolAnalysis').innerHTML = `
                <div class="text-center text-red-500 py-4">
                    <div class="text-4xl mb-2">âŒ</div>
                    <p><strong>æ‰§è¡Œå¤±è´¥:</strong> ${message}</p>
                </div>
            `;
            
            document.getElementById('dataResults').innerHTML = `
                <div class="text-center text-red-500 py-8">
                    <div class="text-6xl mb-4">ğŸ’¥</div>
                    <p>æŸ¥è¯¢æ‰§è¡Œå¤±è´¥</p>
                    <p class="text-sm mt-2">${message}</p>
                </div>
            `;
        }

        // æ ¼å¼åŒ–å€¼æ˜¾ç¤º
        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'string' && value.length > 50) {
                return value.substring(0, 50) + '...';
            }
            if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            return String(value);
        }

        // å›è½¦é”®æäº¤
        queryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                testBtn.click();
            }
        });
    </script>
</body>
</html>