# 权限认证中间件标准规范

## 概述

本文档定义了项目中权限认证中间件的标准使用规范，确保所有API路由具有一致的认证和权限检查机制。

## 核心原则

### 1. 安全第一
- 所有API路由必须经过用户认证（公开接口除外）
- 权限检查必须在用户认证之后进行
- 严禁存在绕过认证的后门

### 2. 一致性原则
- 统一使用相同的认证中间件
- 统一的错误响应格式
- 统一的日志记录格式

### 3. 维护性原则
- 减少代码重复
- 便于统一修改和升级
- 清晰的中间件执行顺序

## 中间件架构

### 认证流程层次

```
请求 → 全局认证中间件 → 权限检查中间件 → 业务逻辑控制器
```

### 中间件类型

#### 1. 全局认证中间件（推荐）
```javascript
// 在路由文件顶部应用，对该路由器下所有路由生效
router.use(verifyToken);
```

#### 2. 路由级认证中间件
```javascript
// 对特定路由单独应用
router.get('/api/resource', verifyToken, checkPermission('resource:view'), controller.getResource);
```

#### 3. 权限检查中间件
```javascript
// 在用户认证之后检查特定权限
checkPermission('permission:code')
checkRole(['admin', 'principal'])
```

## 标准使用模式

### 模式1：标准认证 + 权限检查（推荐）
```javascript
import { Router } from 'express';
import { verifyToken, checkPermission } from '../middlewares/auth.middleware';
import { SomeController } from '../controllers/some.controller';

const router = Router();

// 1. 全局认证中间件 - 对所有路由生效
router.use(verifyToken);

// 2. 权限检查中间件 - 根据需要应用
router.get('/overview',
  checkPermission('dashboard:overview:view'),
  SomeController.getOverview
);

router.post('/create',
  checkPermission('resource:create'),
  SomeController.create
);

router.get('/list',
  checkPermission('resource:list'),
  SomeController.getList
);

// 3. 公开接口（不需要认证）- 需要明确标注
router.get('/public/info', SomeController.getPublicInfo);
```

### 模式2：特殊认证中间件（登录接口）
```javascript
// 登录接口使用特殊的认证中间件
router.post('/auth/login', authenticateWithUnifiedAuth);
```

### 模式3：公开接口
```javascript
// 明确标注为公开接口，不需要认证
router.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});
```

## 中间件导入规范

### 统一导入路径
```javascript
// ✅ 正确：从统一路径导入
import { verifyToken, checkPermission, checkRole } from '../middlewares/auth.middleware';

// ❌ 错误：从不同路径导入
import { authenticate } from '../middlewares/auth.middleware';
import { authMiddleware } from '../middlewares/auth.middleware';
```

### 中间件别名规范
```javascript
// ✅ 正确：使用标准命名
export const authMiddleware = verifyToken;
export const authenticate = verifyToken;

// 代码中使用标准名称
router.use(verifyToken); // 或 authMiddleware
```

## 路由文件标准模板

### 基础路由模板
```javascript
/**
 * [模块名称]路由
 *
 * 功能描述：
 * - 主要功能1
 * - 主要功能2
 *
 * 认证要求：
 * - 用户认证：全部接口（除公开接口）
 * - 权限检查：根据具体功能
 */

import { Router } from 'express';
import { verifyToken, checkPermission } from '../middlewares/auth.middleware';
import { ModuleController } from '../controllers/module.controller';

const router = Router();

// 全局认证中间件 - 所有路由都需要用户认证
router.use(verifyToken);

// === 公开接口（如需要） ===
// router.get('/public', ModuleController.getPublicInfo);

// === 认证接口 ===

/**
 * @swagger
 * /api/module/overview:
 *   get:
 *     summary: 获取概览信息
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: 获取成功
 *       401:
 *         description: 未认证
 *       403:
 *         description: 权限不足
 */
router.get('/overview',
  checkPermission('module:overview:view'),
  ModuleController.getOverview
);

/**
 * @swagger
 * /api/module/create:
 *   post:
 *     summary: 创建资源
 *     security:
 *       - bearerAuth: []
 *     responses:
 *       200:
 *         description: 创建成功
 *       401:
 *         description: 未认证
 *       403:
 *         description: 权限不足
 */
router.post('/create',
  checkPermission('module:create'),
  ModuleController.create
);

export default router;
```

## 权限代码命名规范

### 权限代码格式
```
模块:操作:资源

示例：
- enrollment:overview:view - 招生概览查看
- student:create - 学生创建
- class:update - 班级更新
- finance:report:view - 财务报表查看
```

### 常用权限代码
```javascript
// 查看类权限
'module:list'        // 列表查看
'module:overview:view' // 概览查看
'module:detail:view'   // 详情查看

// 操作类权限
'module:create'     // 创建
'module:update'     // 更新
'module:delete'     // 删除
'module:export'     // 导出

// 管理类权限
'module:manage'     // 管理
'module:config'     // 配置
'module:audit'      // 审核
```

## 错误处理规范

### 标准错误响应
```javascript
// 认证失败（401）
{
  "success": false,
  "message": "用户未认证",
  "error": "UNAUTHORIZED"
}

// 权限不足（403）
{
  "success": false,
  "message": "权限不足",
  "error": "FORBIDDEN",
  "details": {
    "requiredPermission": "module:create",
    "userId": 123
  }
}
```

## 日志记录规范

### 认证日志格式
```javascript
// 认证开始
[认证] 开始验证Token { path: '/api/module/overview', domain: 'localhost', isDemo: true }

// 认证成功
[认证] Demo系统Token验证成功 { userId: 123, role: 'admin' }

// 权限检查
[统一权限检查] 检查权限: module:overview:view, 用户: 123
[权限检查] 权限验证通过
```

## 常见问题及解决方案

### 问题1：缺少认证中间件
```javascript
// ❌ 错误：直接使用权限检查
router.get('/overview', checkPermission('overview:view'), controller.getOverview);

// ✅ 正确：先认证再检查权限
router.use(verifyToken);
router.get('/overview', checkPermission('overview:view'), controller.getOverview);
```

### 问题2：中间件导入混乱
```javascript
// ❌ 错误：使用不同名称的中间件
import { authenticate } from '../middlewares/auth.middleware';
import { authMiddleware } from '../middlewares/auth.middleware';
router.use(authenticate);

// ✅ 正确：使用统一的中间件名称
import { verifyToken } from '../middlewares/auth.middleware';
router.use(verifyToken);
```

### 问题3：全局认证被注释
```javascript
// ❌ 错误：注释掉全局认证
// router.use(verifyToken); // 已注释：全局认证中间件已移除

// ✅ 正确：启用全局认证
router.use(verifyToken);
```

## 检查清单

在提交代码前，请确认：

- [ ] 路由文件是否正确导入了认证中间件
- [ ] 是否启用了全局认证中间件（除公开接口）
- [ ] 权限检查是否在认证之后进行
- [ ] 权限代码命名是否符合规范
- [ ] 是否添加了适当的错误处理
- [ ] Swagger文档是否正确标注了认证要求
- [ ] 日志记录是否完整

## 维护指南

### 添加新的路由文件
1. 复制标准模板
2. 导入必要的中间件
3. 启用全局认证中间件
4. 根据需要添加权限检查
5. 更新权限代码文档

### 修改认证逻辑
1. 在 `auth.middleware.ts` 中修改
2. 更新本文档
3. 通知所有开发者
4. 进行回归测试

---

**文档版本**: 1.0
**最后更新**: 2025-12-13
**维护者**: 开发团队