# é›†å›¢ç®¡ç†ç³»ç»Ÿå¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ä¸€ã€é¡¹ç›®èƒŒæ™¯](#ä¸€é¡¹ç›®èƒŒæ™¯)
- [äºŒã€ç°çŠ¶åˆ†æ](#äºŒç°çŠ¶åˆ†æ)
- [ä¸‰ã€æ ¸å¿ƒè®¾è®¡æ–¹æ¡ˆ](#ä¸‰æ ¸å¿ƒè®¾è®¡æ–¹æ¡ˆ)
- [å››ã€æ•°æ®åº“è®¾è®¡](#å››æ•°æ®åº“è®¾è®¡)
- [äº”ã€åç«¯å¼€å‘](#äº”åç«¯å¼€å‘)
- [å…­ã€å‰ç«¯å¼€å‘](#å…­å‰ç«¯å¼€å‘)
- [ä¸ƒã€å¹³æ»‘å‡çº§æ–¹æ¡ˆ](#ä¸ƒå¹³æ»‘å‡çº§æ–¹æ¡ˆ)
- [å…«ã€å®æ–½æ­¥éª¤](#å…«å®æ–½æ­¥éª¤)
- [ä¹ã€æµ‹è¯•æ–¹æ¡ˆ](#ä¹æµ‹è¯•æ–¹æ¡ˆ)
- [åã€éƒ¨ç½²æ–¹æ¡ˆ](#åéƒ¨ç½²æ–¹æ¡ˆ)

---

## ä¸€ã€é¡¹ç›®èƒŒæ™¯

### 1.1 ä¸šåŠ¡éœ€æ±‚

**æ ¸å¿ƒè¯‰æ±‚:**
- ğŸ¯ æŠ•èµ„äººéœ€è¦ä¾¿æ·ç®¡ç†å¤šä¸ªå¹¼å„¿å›­
- ğŸ¯ é›†å›¢éœ€è¦ç»Ÿä¸€çš„æ•°æ®æ±‡æ€»å’Œåˆ†æ
- ğŸ¯ å•å›­æ‰€éœ€è¦å¹³æ»‘å‡çº§ä¸ºé›†å›¢ç®¡ç†
- ğŸ¯ æ‰€æœ‰ä¸šåŠ¡æ•°æ®éœ€è¦ä¸é›†å›¢IDå…³è”

**ä½¿ç”¨åœºæ™¯:**
1. **æŠ•èµ„äººè§†è§’**: ä¸€é”®æŸ¥çœ‹æ‰€æœ‰å›­æ‰€çš„è¿è¥æ•°æ®
2. **é›†å›¢ç®¡ç†**: ç»Ÿä¸€ç®¡ç†å“ç‰Œã€æ ‡å‡†ã€æµç¨‹
3. **æ•°æ®åˆ†æ**: è·¨å›­æ‰€å¯¹æ¯”åˆ†æ,å‘ç°é—®é¢˜
4. **æƒé™ç®¡ç†**: é›†å›¢çº§ã€å›­æ‰€çº§åˆ†çº§æƒé™æ§åˆ¶

### 1.2 è®¾è®¡ç›®æ ‡

âœ… **é›¶ç ´åæ€§å‡çº§** - ç°æœ‰å•å›­æ‰€ç³»ç»Ÿä¸å—å½±å“  
âœ… **æŠ•èµ„äººå‹å¥½** - ç®€æ´ç›´è§‚çš„ç®¡ç†ç•Œé¢  
âœ… **æ•°æ®å®Œæ•´æ€§** - æ‰€æœ‰ä¸šåŠ¡æ•°æ®ä¸é›†å›¢å…³è”  
âœ… **é«˜æ‰©å±•æ€§** - æ”¯æŒæ— é™å›­æ‰€æ‰©å±•  
âœ… **æ€§èƒ½ä¼˜åŒ–** - å¤§æ•°æ®é‡ä¸‹çš„å¿«é€ŸæŸ¥è¯¢

---

## äºŒã€ç°çŠ¶åˆ†æ

### 2.1 å½“å‰æ¶æ„ç‰¹ç‚¹

**âœ… ä¼˜åŠ¿:**
- å®Œæ•´çš„å•å›­æ‰€ä¸šåŠ¡ä½“ç³» (73+æ•°æ®æ¨¡å‹)
- æˆç†Ÿçš„RBACæƒé™ç³»ç»Ÿ
- ä¸°å¯Œçš„ä¸šåŠ¡æ¨¡å— (æ‹›ç”Ÿã€æ•™å­¦ã€æ´»åŠ¨ã€è¥é”€)
- å®Œå–„çš„æ•°æ®å…³è”å…³ç³»

**âš ï¸ é™åˆ¶:**
- æ‰€æœ‰ä¸šåŠ¡æ¨¡å—éƒ½ä¸å•ä¸ª `kindergartenId` å…³è”
- ç¼ºå°‘é›†å›¢å±‚çº§çš„æ•°æ®ç»“æ„
- æŠ•èµ„äººæ— æ³•ç»Ÿä¸€æŸ¥çœ‹å¤šä¸ªå›­æ‰€
- ç¼ºå°‘è·¨å›­æ‰€çš„æ•°æ®æ±‡æ€»å’Œå¯¹æ¯”

### 2.2 æ ¸å¿ƒæ•°æ®æ¨¡å‹å…³ç³»

```
User (ç”¨æˆ·)
  â†“
Teacher (æ•™å¸ˆ) â†’ Kindergarten (å¹¼å„¿å›­) â†’ Group (é›†å›¢) [æ–°å¢]
  â†“                    â†“
Class (ç­çº§)      Student (å­¦ç”Ÿ)
  â†“                    â†“
Activity (æ´»åŠ¨) â† EnrollmentPlan (æ‹›ç”Ÿè®¡åˆ’)
  â†“
MarketingCampaign (è¥é”€æ´»åŠ¨)
```

**å…³é”®å…³è”å­—æ®µ:**
- `kindergartenId` - æ‰€æœ‰ä¸šåŠ¡è¡¨çš„æ ¸å¿ƒå¤–é”®
- `groupId` - æ–°å¢çš„é›†å›¢å…³è”å­—æ®µ (å¯ä¸ºNULL)

---

## ä¸‰ã€æ ¸å¿ƒè®¾è®¡æ–¹æ¡ˆ

### 3.1 è®¾è®¡åŸåˆ™

1. **å‘åå…¼å®¹**: `group_id` ä¸º NULL æ—¶ä¿æŒåŸæœ‰é€»è¾‘
2. **æ¸è¿›å¼å‡çº§**: å•å›­æ‰€å¯éšæ—¶å‡çº§ä¸ºé›†å›¢
3. **æ•°æ®éš”ç¦»**: é›†å›¢æ•°æ®ä¸å›­æ‰€æ•°æ®é€»è¾‘åˆ†ç¦»
4. **æƒé™åˆ†çº§**: é›†å›¢çº§ã€å›­æ‰€çº§ã€ä¸šåŠ¡çº§ä¸‰çº§æƒé™

### 3.2 æ ¸å¿ƒè¡¨è®¾è®¡

#### 3.2.1 é›†å›¢è¡¨ (groups)

**ç”¨é€”**: å­˜å‚¨é›†å›¢åŸºæœ¬ä¿¡æ¯

**æ ¸å¿ƒå­—æ®µ:**
- `id` - é›†å›¢ID (ä¸»é”®)
- `name` - é›†å›¢åç§°
- `code` - é›†å›¢ç¼–ç  (å”¯ä¸€)
- `investor_id` - ä¸»è¦æŠ•èµ„äººç”¨æˆ·ID
- `kindergarten_count` - å›­æ‰€æ•°é‡ (å†—ä½™å­—æ®µ,æå‡æŸ¥è¯¢æ€§èƒ½)
- `total_students` - æ€»å­¦ç”Ÿæ•° (å†—ä½™å­—æ®µ)
- `status` - çŠ¶æ€ (0-ç¦ç”¨ 1-æ­£å¸¸)

#### 3.2.2 é›†å›¢ç”¨æˆ·å…³è”è¡¨ (group_users)

**ç”¨é€”**: ç®¡ç†é›†å›¢çº§ç”¨æˆ·æƒé™

**æ ¸å¿ƒå­—æ®µ:**
- `group_id` - é›†å›¢ID
- `user_id` - ç”¨æˆ·ID
- `role` - é›†å›¢è§’è‰² (1-æŠ•èµ„äºº 2-é›†å›¢ç®¡ç†å‘˜ 3-è´¢åŠ¡æ€»ç›‘ 4-è¿è¥æ€»ç›‘)
- `can_view_all_kindergartens` - å¯æŸ¥çœ‹æ‰€æœ‰å›­æ‰€
- `can_manage_kindergartens` - å¯ç®¡ç†å›­æ‰€

#### 3.2.3 å¹¼å„¿å›­è¡¨æ‰©å±• (kindergartens)

**æ–°å¢å­—æ®µ:**
- `group_id` - æ‰€å±é›†å›¢ID (å¯ä¸ºNULL)
- `is_group_headquarters` - æ˜¯å¦é›†å›¢æ€»éƒ¨
- `join_group_date` - åŠ å…¥é›†å›¢æ—¥æœŸ
- `group_role` - é›†å›¢è§’è‰² (1-æ——èˆ°å›­ 2-æ ‡å‡†å›­ 3-åŠ ç›Ÿå›­)

### 3.3 ä¸šåŠ¡æ•°æ®å…³è”ç­–ç•¥

**æ–¹æ¡ˆ**: é€šè¿‡ `kindergartenId` é—´æ¥å…³è”åˆ° `groupId`

**ä¼˜åŠ¿:**
- âœ… ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä¸šåŠ¡è¡¨ç»“æ„
- âœ… æŸ¥è¯¢æ—¶é€šè¿‡ JOIN è·å–é›†å›¢ä¿¡æ¯
- âœ… ä¿æŒæ•°æ®ä¸€è‡´æ€§

**ç¤ºä¾‹æŸ¥è¯¢:**
```sql
-- æŸ¥è¯¢é›†å›¢ä¸‹æ‰€æœ‰æ´»åŠ¨
SELECT a.* 
FROM activities a
INNER JOIN kindergartens k ON a.kindergarten_id = k.id
WHERE k.group_id = ?
```

---

## å››ã€æ•°æ®åº“è®¾è®¡

### 4.1 å®Œæ•´å»ºè¡¨è¯­å¥

è¯¦è§: `docs/é›†å›¢ç®¡ç†/database-schema.sql`

**æ ¸å¿ƒè¡¨:**
1. `groups` - é›†å›¢è¡¨
2. `group_users` - é›†å›¢ç”¨æˆ·å…³è”è¡¨
3. `kindergartens` - å¹¼å„¿å›­è¡¨ (æ‰©å±•)

### 4.2 æ•°æ®åº“è¿ç§»æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**: `server/migrations/`

**è¿ç§»é¡ºåº:**
1. `20250110000001-create-groups.js` - åˆ›å»ºé›†å›¢è¡¨
2. `20250110000002-create-group-users.js` - åˆ›å»ºé›†å›¢ç”¨æˆ·è¡¨
3. `20250110000003-extend-kindergartens-for-group.js` - æ‰©å±•å¹¼å„¿å›­è¡¨

### 4.3 ç´¢å¼•ä¼˜åŒ–

**å…³é”®ç´¢å¼•:**
```sql
-- groups è¡¨
CREATE INDEX idx_groups_code ON groups(code);
CREATE INDEX idx_groups_investor ON groups(investor_id);
CREATE INDEX idx_groups_status ON groups(status);

-- kindergartens è¡¨
CREATE INDEX idx_kindergartens_group ON kindergartens(group_id);

-- group_users è¡¨
CREATE UNIQUE INDEX uk_group_user ON group_users(group_id, user_id);
CREATE INDEX idx_group_users_user ON group_users(user_id);
```

---

## äº”ã€åç«¯å¼€å‘

### 5.1 æ¨¡å‹å®šä¹‰

#### 5.1.1 Group æ¨¡å‹

**æ–‡ä»¶**: `server/src/models/group.model.ts`

**æ ¸å¿ƒå­—æ®µ:**
```typescript
export class Group extends Model {
  declare id: number;
  declare name: string;
  declare code: string;
  declare investorId: number;
  declare kindergartenCount: number;
  declare totalStudents: number;
  declare totalTeachers: number;
  declare status: number;
  
  // å…³è”
  public readonly kindergartens?: Kindergarten[];
  public readonly investor?: User;
  public readonly groupUsers?: GroupUser[];
}
```

**å…³è”å…³ç³»:**
```typescript
export const initGroupAssociations = () => {
  Group.hasMany(Kindergarten, {
    foreignKey: 'groupId',
    as: 'kindergartens'
  });
  
  Group.belongsTo(User, {
    foreignKey: 'investorId',
    as: 'investor'
  });
  
  Group.hasMany(GroupUser, {
    foreignKey: 'groupId',
    as: 'groupUsers'
  });
};
```

#### 5.1.2 GroupUser æ¨¡å‹

**æ–‡ä»¶**: `server/src/models/group-user.model.ts`

**æšä¸¾å®šä¹‰:**
```typescript
export enum GroupRole {
  INVESTOR = 1,        // æŠ•èµ„äºº
  ADMIN = 2,           // é›†å›¢ç®¡ç†å‘˜
  FINANCE_DIRECTOR = 3, // è´¢åŠ¡æ€»ç›‘
  OPERATION_DIRECTOR = 4 // è¿è¥æ€»ç›‘
}
```

### 5.2 æœåŠ¡å±‚è®¾è®¡

#### 5.2.1 GroupService

**æ–‡ä»¶**: `server/src/services/group.service.ts`

**æ ¸å¿ƒæ–¹æ³•:**
```typescript
export class GroupService {
  // åˆ›å»ºé›†å›¢
  async createGroup(data: CreateGroupDto): Promise<Group>
  
  // è·å–é›†å›¢è¯¦æƒ…
  async getGroupDetail(groupId: number): Promise<Group>
  
  // æ›´æ–°é›†å›¢ä¿¡æ¯
  async updateGroup(groupId: number, data: UpdateGroupDto): Promise<Group>
  
  // åˆ é™¤é›†å›¢
  async deleteGroup(groupId: number): Promise<void>
  
  // è·å–é›†å›¢åˆ—è¡¨
  async getGroupList(params: GroupListParams): Promise<PaginatedResult<Group>>
}
```

#### 5.2.2 GroupStatisticsService

**æ–‡ä»¶**: `server/src/services/group-statistics.service.ts`

**æ ¸å¿ƒæ–¹æ³•:**
```typescript
export class GroupStatisticsService {
  // è·å–é›†å›¢æ±‡æ€»æ•°æ®
  async getGroupAggregatedData(groupId: number): Promise<GroupStats>
  
  // è·å–é›†å›¢æ´»åŠ¨æ•°æ®
  async getGroupActivityData(groupId: number, dateRange: DateRange): Promise<ActivityStats>
  
  // è·å–é›†å›¢æ‹›ç”Ÿæ•°æ®
  async getGroupEnrollmentData(groupId: number): Promise<EnrollmentStats>
  
  // è·å–é›†å›¢è´¢åŠ¡æ•°æ®
  async getGroupFinanceData(groupId: number): Promise<FinanceStats>
  
  // å›­æ‰€å¯¹æ¯”åˆ†æ
  async compareKindergartens(groupId: number, kindergartenIds: number[]): Promise<ComparisonData>
}
```

#### 5.2.3 GroupUpgradeService

**æ–‡ä»¶**: `server/src/services/group-upgrade.service.ts`

**æ ¸å¿ƒæ–¹æ³•:**
```typescript
export class GroupUpgradeService {
  // æ£€æµ‹å‡çº§èµ„æ ¼
  async checkUpgradeEligibility(userId: number): Promise<UpgradeEligibility>
  
  // æ‰§è¡Œå‡çº§
  async upgradeToGroup(params: UpgradeParams): Promise<Group>
  
  // å›­æ‰€åŠ å…¥é›†å›¢
  async addKindergartenToGroup(groupId: number, kindergartenId: number): Promise<void>
  
  // å›­æ‰€é€€å‡ºé›†å›¢
  async removeKindergartenFromGroup(groupId: number, kindergartenId: number): Promise<void>
}
```

### 5.3 æ§åˆ¶å™¨è®¾è®¡

**æ–‡ä»¶**: `server/src/controllers/group.controller.ts`

**APIç«¯ç‚¹:**
```typescript
export class GroupController {
  // GET /api/groups - è·å–é›†å›¢åˆ—è¡¨
  static async getGroupList(req: Request, res: Response)
  
  // GET /api/groups/:id - è·å–é›†å›¢è¯¦æƒ…
  static async getGroupDetail(req: Request, res: Response)
  
  // POST /api/groups - åˆ›å»ºé›†å›¢
  static async createGroup(req: Request, res: Response)
  
  // PUT /api/groups/:id - æ›´æ–°é›†å›¢
  static async updateGroup(req: Request, res: Response)
  
  // DELETE /api/groups/:id - åˆ é™¤é›†å›¢
  static async deleteGroup(req: Request, res: Response)
  
  // GET /api/groups/:id/statistics - è·å–é›†å›¢ç»Ÿè®¡æ•°æ®
  static async getGroupStatistics(req: Request, res: Response)
  
  // GET /api/groups/:id/kindergartens - è·å–é›†å›¢ä¸‹çš„å›­æ‰€åˆ—è¡¨
  static async getGroupKindergartens(req: Request, res: Response)
  
  // POST /api/groups/upgrade - å•å›­æ‰€å‡çº§ä¸ºé›†å›¢
  static async upgradeToGroup(req: Request, res: Response)
  
  // POST /api/groups/:id/add-kindergarten - å›­æ‰€åŠ å…¥é›†å›¢
  static async addKindergartenToGroup(req: Request, res: Response)
  
  // POST /api/groups/:id/remove-kindergarten - å›­æ‰€é€€å‡ºé›†å›¢
  static async removeKindergartenFromGroup(req: Request, res: Response)
}
```

### 5.4 æƒé™ä¸­é—´ä»¶

**æ–‡ä»¶**: `server/src/middlewares/group-permission.middleware.ts`

**æ ¸å¿ƒåŠŸèƒ½:**
```typescript
// æ£€æŸ¥é›†å›¢æƒé™
export const checkGroupPermission = (requiredRole: GroupRole[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    // 1. éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰é›†å›¢è®¿é—®æƒé™
    // 2. éªŒè¯ç”¨æˆ·è§’è‰²æ˜¯å¦æ»¡è¶³è¦æ±‚
    // 3. å°†é›†å›¢ä¸Šä¸‹æ–‡é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
  };
};

// æ£€æŸ¥å›­æ‰€è®¿é—®æƒé™
export const checkKindergartenAccess = () => {
  return async (req: Request, res: Response, next: NextFunction) => {
    // 1. è·å–å›­æ‰€ID
    // 2. æ£€æŸ¥å›­æ‰€æ˜¯å¦å±äºç”¨æˆ·æœ‰æƒé™çš„é›†å›¢
    // 3. æˆ–æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯è¯¥å›­æ‰€çš„ç®¡ç†å‘˜
  };
};
```

### 5.5 è·¯ç”±é…ç½®

**æ–‡ä»¶**: `server/src/routes/group.routes.ts`

```typescript
import { Router } from 'express';
import { GroupController } from '../controllers/group.controller';
import { authenticate } from '../middlewares/auth.middleware';
import { checkGroupPermission } from '../middlewares/group-permission.middleware';
import { GroupRole } from '../models/group-user.model';

const router = Router();

// é›†å›¢ç®¡ç†è·¯ç”±
router.get('/groups', 
  authenticate, 
  GroupController.getGroupList
);

router.get('/groups/:id', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN]),
  GroupController.getGroupDetail
);

router.post('/groups', 
  authenticate, 
  GroupController.createGroup
);

router.put('/groups/:id', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN]),
  GroupController.updateGroup
);

router.delete('/groups/:id', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR]),
  GroupController.deleteGroup
);

// é›†å›¢ç»Ÿè®¡è·¯ç”±
router.get('/groups/:id/statistics', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN, GroupRole.FINANCE_DIRECTOR]),
  GroupController.getGroupStatistics
);

// å›­æ‰€ç®¡ç†è·¯ç”±
router.get('/groups/:id/kindergartens', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN]),
  GroupController.getGroupKindergartens
);

router.post('/groups/upgrade', 
  authenticate, 
  GroupController.upgradeToGroup
);

router.post('/groups/:id/add-kindergarten', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN]),
  GroupController.addKindergartenToGroup
);

router.post('/groups/:id/remove-kindergarten', 
  authenticate, 
  checkGroupPermission([GroupRole.INVESTOR, GroupRole.ADMIN]),
  GroupController.removeKindergartenFromGroup
);

export default router;
```

---

## å…­ã€å‰ç«¯å¼€å‘

### 6.1 é¡µé¢ç»“æ„

```
client/src/pages/group-center/
â”œâ”€â”€ Dashboard.vue              # é›†å›¢æ¦‚è§ˆ
â”œâ”€â”€ Kindergartens.vue          # å›­æ‰€ç®¡ç†
â”œâ”€â”€ KindergartenDetail.vue     # å›­æ‰€è¯¦æƒ…
â”œâ”€â”€ Settings.vue               # é›†å›¢è®¾ç½®
â”œâ”€â”€ Analytics.vue              # æ•°æ®åˆ†æ
â”œâ”€â”€ UpgradeWizard.vue          # å‡çº§å‘å¯¼
â””â”€â”€ components/
    â”œâ”€â”€ StatCard.vue           # ç»Ÿè®¡å¡ç‰‡
    â”œâ”€â”€ KindergartenCard.vue   # å›­æ‰€å¡ç‰‡
    â”œâ”€â”€ ComparisonTable.vue    # å¯¹æ¯”è¡¨æ ¼
    â””â”€â”€ GroupSelector.vue      # é›†å›¢é€‰æ‹©å™¨
```

### 6.2 çŠ¶æ€ç®¡ç†

**æ–‡ä»¶**: `client/src/stores/group.ts`

```typescript
import { defineStore } from 'pinia';

export const useGroupStore = defineStore('group', {
  state: () => ({
    currentGroup: null as Group | null,
    groupList: [] as Group[],
    currentKindergarten: null as number | null,
    groupStats: null as GroupStats | null
  }),
  
  getters: {
    hasGroupPermission: (state) => {
      return state.currentGroup !== null;
    },
    
    kindergartenList: (state) => {
      return state.currentGroup?.kindergartens || [];
    }
  },
  
  actions: {
    async fetchGroupList() {
      const response = await getGroupList();
      this.groupList = response.data;
    },
    
    async fetchGroupDetail(groupId: number) {
      const response = await getGroupDetail(groupId);
      this.currentGroup = response.data;
    },
    
    async fetchGroupStatistics(groupId: number) {
      const response = await getGroupStatistics(groupId);
      this.groupStats = response.data;
    },
    
    setCurrentKindergarten(kindergartenId: number | null) {
      this.currentKindergarten = kindergartenId;
    }
  }
});
```

### 6.3 APIå°è£…

**æ–‡ä»¶**: `client/src/api/modules/group.ts`

```typescript
import { request } from '@/utils/request';

export interface Group {
  id: number;
  name: string;
  code: string;
  kindergartenCount: number;
  totalStudents: number;
  totalTeachers: number;
  // ...å…¶ä»–å­—æ®µ
}

// è·å–é›†å›¢åˆ—è¡¨
export const getGroupList = (params?: any) => {
  return request.get<ApiResponse<Group[]>>('/groups', { params });
};

// è·å–é›†å›¢è¯¦æƒ…
export const getGroupDetail = (id: number) => {
  return request.get<ApiResponse<Group>>(`/groups/${id}`);
};

// åˆ›å»ºé›†å›¢
export const createGroup = (data: any) => {
  return request.post<ApiResponse<Group>>('/groups', data);
};

// æ›´æ–°é›†å›¢
export const updateGroup = (id: number, data: any) => {
  return request.put<ApiResponse<Group>>(`/groups/${id}`, data);
};

// åˆ é™¤é›†å›¢
export const deleteGroup = (id: number) => {
  return request.delete<ApiResponse<void>>(`/groups/${id}`);
};

// è·å–é›†å›¢ç»Ÿè®¡æ•°æ®
export const getGroupStatistics = (id: number) => {
  return request.get<ApiResponse<any>>(`/groups/${id}/statistics`);
};

// è·å–é›†å›¢ä¸‹çš„å›­æ‰€åˆ—è¡¨
export const getGroupKindergartens = (id: number) => {
  return request.get<ApiResponse<any>>(`/groups/${id}/kindergartens`);
};

// å•å›­æ‰€å‡çº§ä¸ºé›†å›¢
export const upgradeToGroup = (data: any) => {
  return request.post<ApiResponse<Group>>('/groups/upgrade', data);
};
```

### 6.4 æ ¸å¿ƒç»„ä»¶ç¤ºä¾‹

#### 6.4.1 é›†å›¢æ¦‚è§ˆé¡µé¢

**æ–‡ä»¶**: `client/src/pages/group-center/Dashboard.vue`

```vue
<template>
  <div class="group-dashboard">
    <!-- é›†å›¢é€‰æ‹©å™¨ -->
    <div class="header">
      <h1>{{ currentGroup?.name || 'é›†å›¢ç®¡ç†ä¸­å¿ƒ' }}</h1>
      <el-select v-model="currentGroupId" @change="handleGroupChange">
        <el-option
          v-for="group in groupList"
          :key="group.id"
          :label="group.name"
          :value="group.id"
        />
      </el-select>
    </div>

    <!-- å…³é”®æŒ‡æ ‡ -->
    <el-row :gutter="20" class="stats-row">
      <el-col :span="6">
        <StatCard
          title="å›­æ‰€æ•°é‡"
          :value="groupStats?.kindergartenCount || 0"
          icon="school"
          color="#409EFF"
        />
      </el-col>
      <el-col :span="6">
        <StatCard
          title="æ€»å­¦ç”Ÿæ•°"
          :value="groupStats?.totalStudents || 0"
          icon="users"
          color="#67C23A"
        />
      </el-col>
      <el-col :span="6">
        <StatCard
          title="æ€»æ•™å¸ˆæ•°"
          :value="groupStats?.totalTeachers || 0"
          icon="user-tie"
          color="#E6A23C"
        />
      </el-col>
      <el-col :span="6">
        <StatCard
          title="æœ¬æœˆæ”¶å…¥"
          :value="groupStats?.monthlyRevenue || 0"
          prefix="Â¥"
          color="#F56C6C"
        />
      </el-col>
    </el-row>

    <!-- å›­æ‰€åˆ—è¡¨ -->
    <div class="kindergarten-section">
      <h2>å›­æ‰€æ¦‚è§ˆ</h2>
      <el-row :gutter="20">
        <el-col
          v-for="kg in kindergartenList"
          :key="kg.id"
          :span="8"
        >
          <KindergartenCard
            :kindergarten="kg"
            @click="handleKindergartenClick(kg.id)"
          />
        </el-col>
      </el-row>
    </div>

    <!-- æ•°æ®å›¾è¡¨ -->
    <el-row :gutter="20" class="charts-row">
      <el-col :span="12">
        <el-card>
          <template #header>æ‹›ç”Ÿè¶‹åŠ¿</template>
          <EnrollmentTrendChart :data="enrollmentData" />
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card>
          <template #header>å›­æ‰€å¯¹æ¯”</template>
          <KindergartenComparisonChart :data="comparisonData" />
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { useGroupStore } from '@/stores/group';
import { useRouter } from 'vue-router';
import StatCard from './components/StatCard.vue';
import KindergartenCard from './components/KindergartenCard.vue';

const groupStore = useGroupStore();
const router = useRouter();

const currentGroupId = ref<number | null>(null);

const currentGroup = computed(() => groupStore.currentGroup);
const groupList = computed(() => groupStore.groupList);
const groupStats = computed(() => groupStore.groupStats);
const kindergartenList = computed(() => groupStore.kindergartenList);

const handleGroupChange = async (groupId: number) => {
  await groupStore.fetchGroupDetail(groupId);
  await groupStore.fetchGroupStatistics(groupId);
};

const handleKindergartenClick = (kindergartenId: number) => {
  router.push(`/group-center/kindergartens/${kindergartenId}`);
};

onMounted(async () => {
  await groupStore.fetchGroupList();
  if (groupList.value.length > 0) {
    currentGroupId.value = groupList.value[0].id;
    await handleGroupChange(currentGroupId.value);
  }
});
</script>
```

#### 6.4.2 å›­æ‰€ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `client/src/pages/group-center/Kindergartens.vue`

```vue
<template>
  <div class="kindergarten-management">
    <div class="toolbar">
      <el-input
        v-model="searchKeyword"
        placeholder="æœç´¢å›­æ‰€åç§°"
        style="width: 300px"
      />
      <el-button type="primary" @click="handleAddKindergarten">
        æ·»åŠ å›­æ‰€
      </el-button>
    </div>

    <el-table :data="filteredKindergartens" stripe>
      <el-table-column prop="name" label="å›­æ‰€åç§°" />
      <el-table-column prop="code" label="å›­æ‰€ç¼–ç " />
      <el-table-column prop="studentCount" label="å­¦ç”Ÿæ•°" />
      <el-table-column prop="teacherCount" label="æ•™å¸ˆæ•°" />
      <el-table-column prop="classCount" label="ç­çº§æ•°" />
      <el-table-column label="çŠ¶æ€">
        <template #default="{ row }">
          <el-tag :type="row.status === 1 ? 'success' : 'danger'">
            {{ row.status === 1 ? 'æ­£å¸¸' : 'ç¦ç”¨' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="200">
        <template #default="{ row }">
          <el-button size="small" @click="handleView(row)">æŸ¥çœ‹</el-button>
          <el-button size="small" @click="handleEdit(row)">ç¼–è¾‘</el-button>
          <el-button
            size="small"
            type="danger"
            @click="handleRemove(row)"
          >
            ç§»é™¤
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useGroupStore } from '@/stores/group';
import { ElMessage, ElMessageBox } from 'element-plus';

const groupStore = useGroupStore();
const searchKeyword = ref('');

const kindergartens = computed(() => groupStore.kindergartenList);

const filteredKindergartens = computed(() => {
  if (!searchKeyword.value) return kindergartens.value;
  return kindergartens.value.filter(kg =>
    kg.name.includes(searchKeyword.value)
  );
});

const handleAddKindergarten = () => {
  // æ‰“å¼€æ·»åŠ å›­æ‰€å¯¹è¯æ¡†
};

const handleView = (kindergarten: any) => {
  // è·³è½¬åˆ°å›­æ‰€è¯¦æƒ…é¡µ
};

const handleEdit = (kindergarten: any) => {
  // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
};

const handleRemove = async (kindergarten: any) => {
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦å°† ${kindergarten.name} ä»é›†å›¢ä¸­ç§»é™¤å—?`,
      'ç¡®è®¤ç§»é™¤',
      { type: 'warning' }
    );

    // è°ƒç”¨ç§»é™¤API
    ElMessage.success('ç§»é™¤æˆåŠŸ');
  } catch {
    // ç”¨æˆ·å–æ¶ˆ
  }
};
</script>
```

### 6.5 åŠ¨æ€è·¯ç”±é›†æˆ

**æ–‡ä»¶**: `client/src/router/group-routes.ts`

```typescript
import type { RouteRecordRaw } from 'vue-router';

export const groupRoutes: RouteRecordRaw = {
  path: '/group-center',
  name: 'GroupCenter',
  component: () => import('@/layouts/MainLayout.vue'),
  meta: {
    title: 'é›†å›¢ç®¡ç†ä¸­å¿ƒ',
    icon: 'building',
    requiresAuth: true,
    permissions: ['view_group_center']
  },
  children: [
    {
      path: 'dashboard',
      name: 'GroupDashboard',
      component: () => import('@/pages/group-center/Dashboard.vue'),
      meta: {
        title: 'é›†å›¢æ¦‚è§ˆ',
        permissions: ['view_group_dashboard']
      }
    },
    {
      path: 'kindergartens',
      name: 'GroupKindergartens',
      component: () => import('@/pages/group-center/Kindergartens.vue'),
      meta: {
        title: 'å›­æ‰€ç®¡ç†',
        permissions: ['view_group_kindergartens']
      }
    },
    {
      path: 'kindergartens/:id',
      name: 'KindergartenDetail',
      component: () => import('@/pages/group-center/KindergartenDetail.vue'),
      meta: {
        title: 'å›­æ‰€è¯¦æƒ…',
        permissions: ['view_kindergarten_detail']
      }
    },
    {
      path: 'settings',
      name: 'GroupSettings',
      component: () => import('@/pages/group-center/Settings.vue'),
      meta: {
        title: 'é›†å›¢è®¾ç½®',
        permissions: ['manage_group_settings']
      }
    },
    {
      path: 'analytics',
      name: 'GroupAnalytics',
      component: () => import('@/pages/group-center/Analytics.vue'),
      meta: {
        title: 'æ•°æ®åˆ†æ',
        permissions: ['view_group_analytics']
      }
    },
    {
      path: 'upgrade',
      name: 'GroupUpgrade',
      component: () => import('@/pages/group-center/UpgradeWizard.vue'),
      meta: {
        title: 'å‡çº§ä¸ºé›†å›¢',
        permissions: ['upgrade_to_group']
      }
    }
  ]
};
```

**é›†æˆåˆ°ä¸»è·¯ç”±:**

```typescript
// client/src/router/index.ts
import { groupRoutes } from './group-routes';

const routes = [
  // ...å…¶ä»–è·¯ç”±
  groupRoutes
];
```

---

## ä¸ƒã€å¹³æ»‘å‡çº§æ–¹æ¡ˆ

### 7.1 å‡çº§è§¦å‘æ¡ä»¶

**è‡ªåŠ¨æ£€æµ‹:**
- ç”¨æˆ·åˆ›å»ºäº†2ä¸ªåŠä»¥ä¸Šå¹¼å„¿å›­
- ç³»ç»Ÿè‡ªåŠ¨æç¤ºå‡çº§ä¸ºé›†å›¢

**æ‰‹åŠ¨è§¦å‘:**
- ç”¨æˆ·ä¸»åŠ¨ç”³è¯·å‡çº§ä¸ºé›†å›¢

### 7.2 å‡çº§æµç¨‹

```
1. æ£€æµ‹å‡çº§èµ„æ ¼
   â†“
2. ç”¨æˆ·å¡«å†™é›†å›¢ä¿¡æ¯
   â†“
3. é€‰æ‹©è¦åŠ å…¥é›†å›¢çš„å›­æ‰€
   â†“
4. è®¾ç½®é›†å›¢æ€»éƒ¨
   â†“
5. æ‰§è¡Œå‡çº§æ“ä½œ (äº‹åŠ¡)
   â”œâ”€â”€ åˆ›å»ºé›†å›¢è®°å½•
   â”œâ”€â”€ æ›´æ–°å›­æ‰€çš„ group_id
   â”œâ”€â”€ åˆ›å»ºé›†å›¢ç®¡ç†å‘˜æƒé™
   â””â”€â”€ æ›´æ–°ç»Ÿè®¡æ•°æ®
   â†“
6. å‡çº§å®Œæˆ,è·³è½¬åˆ°é›†å›¢ç®¡ç†ä¸­å¿ƒ
```

### 7.3 å‡çº§æœåŠ¡å®ç°

**æ–‡ä»¶**: `server/src/services/group-upgrade.service.ts`

```typescript
import { sequelize } from '../init';
import { Group } from '../models/group.model';
import { Kindergarten } from '../models/kindergarten.model';
import { GroupUser, GroupRole } from '../models/group-user.model';

export class GroupUpgradeService {
  /**
   * æ£€æµ‹å‡çº§èµ„æ ¼
   */
  async checkUpgradeEligibility(userId: number) {
    const kindergartens = await Kindergarten.findAll({
      where: {
        creatorId: userId,
        status: 1,
        groupId: null // æœªåŠ å…¥é›†å›¢çš„å›­æ‰€
      }
    });

    return {
      eligible: kindergartens.length >= 2,
      kindergartenCount: kindergartens.length,
      kindergartens: kindergartens.map(kg => ({
        id: kg.id,
        name: kg.name,
        code: kg.code
      })),
      suggestUpgrade: kindergartens.length >= 2
    };
  }

  /**
   * æ‰§è¡Œå‡çº§æ“ä½œ
   */
  async upgradeToGroup(params: {
    userId: number;
    groupName: string;
    groupCode?: string;
    kindergartenIds: number[];
    headquartersId?: number;
  }) {
    const transaction = await sequelize.transaction();

    try {
      // 1. éªŒè¯å›­æ‰€æ‰€æœ‰æƒ
      const kindergartens = await Kindergarten.findAll({
        where: {
          id: params.kindergartenIds,
          creatorId: params.userId,
          groupId: null
        },
        transaction
      });

      if (kindergartens.length !== params.kindergartenIds.length) {
        throw new Error('éƒ¨åˆ†å›­æ‰€ä¸å­˜åœ¨æˆ–å·²åŠ å…¥å…¶ä»–é›†å›¢');
      }

      // 2. åˆ›å»ºé›†å›¢
      const group = await Group.create({
        name: params.groupName,
        code: params.groupCode || `GRP${Date.now()}`,
        investorId: params.userId,
        kindergartenCount: kindergartens.length,
        totalStudents: kindergartens.reduce((sum, kg) => sum + kg.studentCount, 0),
        totalTeachers: kindergartens.reduce((sum, kg) => sum + kg.teacherCount, 0),
        status: 1,
        creatorId: params.userId
      }, { transaction });

      // 3. å…³è”å¹¼å„¿å›­åˆ°é›†å›¢
      await Kindergarten.update(
        {
          groupId: group.id,
          joinGroupDate: new Date()
        },
        {
          where: { id: params.kindergartenIds },
          transaction
        }
      );

      // 4. è®¾ç½®é›†å›¢æ€»éƒ¨
      const headquartersId = params.headquartersId || params.kindergartenIds[0];
      await Kindergarten.update(
        { isGroupHeadquarters: 1 },
        {
          where: { id: headquartersId },
          transaction
        }
      );

      // 5. åˆ›å»ºé›†å›¢ç®¡ç†å‘˜æƒé™
      await GroupUser.create({
        groupId: group.id,
        userId: params.userId,
        role: GroupRole.INVESTOR,
        canViewAllKindergartens: 1,
        canManageKindergartens: 1,
        status: 1
      }, { transaction });

      await transaction.commit();

      return {
        success: true,
        group,
        message: 'å‡çº§æˆåŠŸ'
      };

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  /**
   * å›­æ‰€åŠ å…¥é›†å›¢
   */
  async addKindergartenToGroup(
    groupId: number,
    kindergartenId: number,
    userId: number
  ) {
    const transaction = await sequelize.transaction();

    try {
      // 1. éªŒè¯é›†å›¢æƒé™
      const groupUser = await GroupUser.findOne({
        where: {
          groupId,
          userId,
          role: [GroupRole.INVESTOR, GroupRole.ADMIN]
        }
      });

      if (!groupUser) {
        throw new Error('æ‚¨æ²¡æœ‰æƒé™ç®¡ç†è¯¥é›†å›¢');
      }

      // 2. éªŒè¯å›­æ‰€çŠ¶æ€
      const kindergarten = await Kindergarten.findByPk(kindergartenId, { transaction });

      if (!kindergarten) {
        throw new Error('å›­æ‰€ä¸å­˜åœ¨');
      }

      if (kindergarten.groupId) {
        throw new Error('è¯¥å›­æ‰€å·²åŠ å…¥å…¶ä»–é›†å›¢');
      }

      // 3. æ›´æ–°å›­æ‰€
      await kindergarten.update({
        groupId,
        joinGroupDate: new Date()
      }, { transaction });

      // 4. æ›´æ–°é›†å›¢ç»Ÿè®¡
      await Group.increment(
        {
          kindergartenCount: 1,
          totalStudents: kindergarten.studentCount,
          totalTeachers: kindergarten.teacherCount
        },
        { where: { id: groupId }, transaction }
      );

      await transaction.commit();

      return {
        success: true,
        message: 'å›­æ‰€åŠ å…¥æˆåŠŸ'
      };

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }

  /**
   * å›­æ‰€é€€å‡ºé›†å›¢
   */
  async removeKindergartenFromGroup(
    groupId: number,
    kindergartenId: number,
    userId: number
  ) {
    const transaction = await sequelize.transaction();

    try {
      // 1. éªŒè¯é›†å›¢æƒé™
      const groupUser = await GroupUser.findOne({
        where: {
          groupId,
          userId,
          role: [GroupRole.INVESTOR, GroupRole.ADMIN]
        }
      });

      if (!groupUser) {
        throw new Error('æ‚¨æ²¡æœ‰æƒé™ç®¡ç†è¯¥é›†å›¢');
      }

      // 2. éªŒè¯å›­æ‰€
      const kindergarten = await Kindergarten.findOne({
        where: {
          id: kindergartenId,
          groupId
        },
        transaction
      });

      if (!kindergarten) {
        throw new Error('å›­æ‰€ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥é›†å›¢');
      }

      // 3. æ£€æŸ¥æ˜¯å¦æ˜¯é›†å›¢æ€»éƒ¨
      if (kindergarten.isGroupHeadquarters) {
        throw new Error('é›†å›¢æ€»éƒ¨ä¸èƒ½é€€å‡ºé›†å›¢,è¯·å…ˆè®¾ç½®å…¶ä»–å›­æ‰€ä¸ºæ€»éƒ¨');
      }

      // 4. æ›´æ–°å›­æ‰€
      await kindergarten.update({
        groupId: null,
        joinGroupDate: null,
        groupRole: null
      }, { transaction });

      // 5. æ›´æ–°é›†å›¢ç»Ÿè®¡
      await Group.decrement(
        {
          kindergartenCount: 1,
          totalStudents: kindergarten.studentCount,
          totalTeachers: kindergarten.teacherCount
        },
        { where: { id: groupId }, transaction }
      );

      await transaction.commit();

      return {
        success: true,
        message: 'å›­æ‰€é€€å‡ºæˆåŠŸ'
      };

    } catch (error) {
      await transaction.rollback();
      throw error;
    }
  }
}
```

---

## å…«ã€å®æ–½æ­¥éª¤

### Phase 1: æ•°æ®åº“è®¾è®¡ (1-2å¤©)

**ä»»åŠ¡æ¸…å•:**
- [ ] åˆ›å»º `groups` è¡¨è¿ç§»æ–‡ä»¶
- [ ] åˆ›å»º `group_users` è¡¨è¿ç§»æ–‡ä»¶
- [ ] åˆ›å»º `kindergartens` è¡¨æ‰©å±•è¿ç§»æ–‡ä»¶
- [ ] ç¼–å†™ç§å­æ•°æ®æ–‡ä»¶
- [ ] æµ‹è¯•è¿ç§»æ–‡ä»¶æ‰§è¡Œ
- [ ] éªŒè¯ç´¢å¼•åˆ›å»º

**äº¤ä»˜ç‰©:**
- `server/migrations/20250110000001-create-groups.js`
- `server/migrations/20250110000002-create-group-users.js`
- `server/migrations/20250110000003-extend-kindergartens-for-group.js`
- `server/seeders/20250110000001-demo-groups.js`

### Phase 2: åç«¯å¼€å‘ (3-5å¤©)

**Day 1: æ¨¡å‹å’Œå…³è”**
- [ ] åˆ›å»º Group æ¨¡å‹
- [ ] åˆ›å»º GroupUser æ¨¡å‹
- [ ] æ‰©å±• Kindergarten æ¨¡å‹
- [ ] é…ç½®æ¨¡å‹å…³è”å…³ç³»
- [ ] ç¼–å†™æ¨¡å‹å•å…ƒæµ‹è¯•

**Day 2: æœåŠ¡å±‚**
- [ ] å®ç° GroupService
- [ ] å®ç° GroupStatisticsService
- [ ] å®ç° GroupUpgradeService
- [ ] ç¼–å†™æœåŠ¡å±‚å•å…ƒæµ‹è¯•

**Day 3: æ§åˆ¶å™¨å’Œè·¯ç”±**
- [ ] å®ç° GroupController
- [ ] é…ç½®è·¯ç”±
- [ ] å®ç°æƒé™ä¸­é—´ä»¶
- [ ] ç¼–å†™APIé›†æˆæµ‹è¯•

**Day 4-5: ä¼˜åŒ–å’Œæµ‹è¯•**
- [ ] æ€§èƒ½ä¼˜åŒ– (æŸ¥è¯¢ä¼˜åŒ–ã€ç¼“å­˜)
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] APIæ–‡æ¡£ç¼–å†™
- [ ] å®Œæ•´æµ‹è¯•è¦†ç›–

**äº¤ä»˜ç‰©:**
- æ¨¡å‹æ–‡ä»¶ (3ä¸ª)
- æœåŠ¡æ–‡ä»¶ (3ä¸ª)
- æ§åˆ¶å™¨æ–‡ä»¶ (1ä¸ª)
- è·¯ç”±æ–‡ä»¶ (1ä¸ª)
- ä¸­é—´ä»¶æ–‡ä»¶ (1ä¸ª)
- æµ‹è¯•æ–‡ä»¶ (10+ä¸ª)

### Phase 3: å‰ç«¯å¼€å‘ (5-7å¤©)

**Day 1: åŸºç¡€è®¾æ–½**
- [ ] åˆ›å»º Pinia store
- [ ] å°è£… API æ¥å£
- [ ] é…ç½®è·¯ç”±
- [ ] åˆ›å»ºåŸºç¡€ç»„ä»¶

**Day 2-3: æ ¸å¿ƒé¡µé¢**
- [ ] é›†å›¢æ¦‚è§ˆé¡µé¢
- [ ] å›­æ‰€ç®¡ç†é¡µé¢
- [ ] å›­æ‰€è¯¦æƒ…é¡µé¢

**Day 4-5: é«˜çº§åŠŸèƒ½**
- [ ] é›†å›¢è®¾ç½®é¡µé¢
- [ ] æ•°æ®åˆ†æé¡µé¢
- [ ] å‡çº§å‘å¯¼é¡µé¢

**Day 6-7: ä¼˜åŒ–å’Œæµ‹è¯•**
- [ ] UI/UX ä¼˜åŒ–
- [ ] å“åº”å¼é€‚é…
- [ ] ç»„ä»¶å•å…ƒæµ‹è¯•
- [ ] E2E æµ‹è¯•

**äº¤ä»˜ç‰©:**
- é¡µé¢ç»„ä»¶ (6ä¸ª)
- ä¸šåŠ¡ç»„ä»¶ (10+ä¸ª)
- Store æ–‡ä»¶ (1ä¸ª)
- API æ–‡ä»¶ (1ä¸ª)
- æµ‹è¯•æ–‡ä»¶ (15+ä¸ª)

### Phase 4: é›†æˆæµ‹è¯• (2-3å¤©)

**ä»»åŠ¡æ¸…å•:**
- [ ] å‰åç«¯è”è°ƒ
- [ ] å‡çº§æµç¨‹æµ‹è¯•
- [ ] æƒé™ç³»ç»Ÿæµ‹è¯•
- [ ] æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•

**æµ‹è¯•åœºæ™¯:**
1. å•å›­æ‰€å‡çº§ä¸ºé›†å›¢
2. å›­æ‰€åŠ å…¥/é€€å‡ºé›†å›¢
3. é›†å›¢æ•°æ®æ±‡æ€»
4. è·¨å›­æ‰€æ•°æ®å¯¹æ¯”
5. æƒé™æ§åˆ¶éªŒè¯

---

## ä¹ã€æµ‹è¯•æ–¹æ¡ˆ

### 9.1 å•å…ƒæµ‹è¯•

#### 9.1.1 æ¨¡å‹æµ‹è¯•

**æ–‡ä»¶**: `server/tests/unit/models/group.model.test.ts`

```typescript
describe('Group Model', () => {
  it('should create a group', async () => {
    const group = await Group.create({
      name: 'æµ‹è¯•é›†å›¢',
      code: 'TEST001',
      investorId: 1
    });

    expect(group.id).toBeDefined();
    expect(group.name).toBe('æµ‹è¯•é›†å›¢');
  });

  it('should have kindergarten association', async () => {
    const group = await Group.findByPk(1, {
      include: [{ model: Kindergarten, as: 'kindergartens' }]
    });

    expect(group.kindergartens).toBeDefined();
  });
});
```

#### 9.1.2 æœåŠ¡æµ‹è¯•

**æ–‡ä»¶**: `server/tests/unit/services/group.service.test.ts`

```typescript
describe('GroupService', () => {
  describe('createGroup', () => {
    it('should create a group successfully', async () => {
      const result = await GroupService.createGroup({
        name: 'æ–°é›†å›¢',
        code: 'NEW001',
        investorId: 1
      });

      expect(result.success).toBe(true);
      expect(result.data.name).toBe('æ–°é›†å›¢');
    });
  });

  describe('upgradeToGroup', () => {
    it('should upgrade kindergartens to group', async () => {
      const result = await GroupUpgradeService.upgradeToGroup({
        userId: 1,
        groupName: 'å‡çº§é›†å›¢',
        kindergartenIds: [1, 2]
      });

      expect(result.success).toBe(true);
      expect(result.group.kindergartenCount).toBe(2);
    });
  });
});
```

### 9.2 é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `server/tests/integration/group.api.test.ts`

```typescript
describe('Group API Integration Tests', () => {
  let authToken: string;

  beforeAll(async () => {
    // ç™»å½•è·å–token
    const response = await request(app)
      .post('/api/auth/login')
      .send({ username: 'admin', password: 'password' });
    authToken = response.body.data.token;
  });

  describe('POST /api/groups', () => {
    it('should create a group', async () => {
      const response = await request(app)
        .post('/api/groups')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          name: 'APIæµ‹è¯•é›†å›¢',
          code: 'API001'
        });

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
    });
  });

  describe('GET /api/groups/:id/statistics', () => {
    it('should return group statistics', async () => {
      const response = await request(app)
        .get('/api/groups/1/statistics')
        .set('Authorization', `Bearer ${authToken}`);

      expect(response.status).toBe(200);
      expect(response.body.data).toHaveProperty('kindergartenCount');
      expect(response.body.data).toHaveProperty('totalStudents');
    });
  });
});
```

### 9.3 E2Eæµ‹è¯•

**æ–‡ä»¶**: `client/tests/e2e/group-management.spec.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('Group Management', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å½•
    await page.goto('http://localhost:5173/login');
    await page.fill('input[name="username"]', 'admin');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL('**/dashboard');
  });

  test('should display group dashboard', async ({ page }) => {
    await page.goto('http://localhost:5173/group-center/dashboard');

    await expect(page.locator('h1')).toContainText('é›†å›¢ç®¡ç†ä¸­å¿ƒ');
    await expect(page.locator('.stat-card')).toHaveCount(4);
  });

  test('should upgrade to group', async ({ page }) => {
    await page.goto('http://localhost:5173/group-center/upgrade');

    await page.fill('input[name="groupName"]', 'E2Eæµ‹è¯•é›†å›¢');
    await page.click('button:has-text("ä¸‹ä¸€æ­¥")');

    // é€‰æ‹©å›­æ‰€
    await page.click('input[type="checkbox"]');
    await page.click('button:has-text("å®Œæˆå‡çº§")');

    await expect(page.locator('.success-message')).toBeVisible();
  });
});
```

---

## åã€éƒ¨ç½²æ–¹æ¡ˆ

### 10.1 æ•°æ®åº“è¿ç§»

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p kindergarten_db > backup_$(date +%Y%m%d).sql

# 2. æ‰§è¡Œè¿ç§»
cd server
npx sequelize-cli db:migrate

# 3. éªŒè¯è¿ç§»
npx sequelize-cli db:migrate:status

# 4. å¦‚éœ€å›æ»š
npx sequelize-cli db:migrate:undo
```

### 10.2 åç«¯éƒ¨ç½²

```bash
# 1. å®‰è£…ä¾èµ–
cd server
npm install

# 2. ç¼–è¯‘TypeScript
npm run build

# 3. å¯åŠ¨æœåŠ¡
npm run start

# æˆ–ä½¿ç”¨PM2
pm2 start dist/index.js --name kindergarten-api
```

### 10.3 å‰ç«¯éƒ¨ç½²

```bash
# 1. å®‰è£…ä¾èµ–
cd client
npm install

# 2. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# 3. éƒ¨ç½²åˆ°Nginx
cp -r dist/* /var/www/html/

# 4. é…ç½®Nginx
# è¯¦è§ nginx.conf
```

### 10.4 ç¯å¢ƒå˜é‡é…ç½®

**åç«¯ç¯å¢ƒå˜é‡** (`server/.env`):
```env
# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_NAME=kindergarten_db
DB_USER=root
DB_PASSWORD=your_password

# é›†å›¢åŠŸèƒ½å¼€å…³
ENABLE_GROUP_MANAGEMENT=true

# å…¶ä»–é…ç½®...
```

### 10.5 ç›‘æ§å’Œæ—¥å¿—

**æ—¥å¿—é…ç½®:**
```typescript
// server/src/utils/logger.ts
import winston from 'winston';

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({
      filename: 'logs/group-management.log',
      level: 'info'
    }),
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error'
    })
  ]
});
```

**æ€§èƒ½ç›‘æ§:**
- ä½¿ç”¨ PM2 ç›‘æ§è¿›ç¨‹çŠ¶æ€
- ä½¿ç”¨ New Relic æˆ– Datadog ç›‘æ§åº”ç”¨æ€§èƒ½
- é…ç½®æ•°æ®åº“æ…¢æŸ¥è¯¢æ—¥å¿—

---

## é™„å½•

### A. æ•°æ®åº“å®Œæ•´Schema

è¯¦è§: `docs/é›†å›¢ç®¡ç†/database-schema.sql`

### B. APIæ¥å£æ–‡æ¡£

è¯¦è§: `docs/é›†å›¢ç®¡ç†/api-documentation.md`

### C. å‰ç«¯ç»„ä»¶æ–‡æ¡£

è¯¦è§: `docs/é›†å›¢ç®¡ç†/component-documentation.md`

### D. å¸¸è§é—®é¢˜FAQ

è¯¦è§: `docs/é›†å›¢ç®¡ç†/faq.md`

---

## æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è¯´æ˜ |
|------|------|------|------|
| 1.0.0 | 2025-01-10 | å¼€å‘å›¢é˜Ÿ | åˆå§‹ç‰ˆæœ¬ |

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-01-10
**çŠ¶æ€**: âœ… å·²å®Œæˆ

