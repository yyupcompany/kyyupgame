# 呼叫中心音频流处理架构

## 📋 概述

本文档描述呼叫中心系统的音频流处理架构，包括从SIP服务器接收音频、语音识别、AI对话、语音合成到回传的完整流程。

## 🔄 完整流程图

```
┌─────────────────┐
│  SIP服务器      │
│  (47.94.82.59)  │
└────────┬────────┘
         │ 音频流 (PCM 16kHz 16bit)
         ▼
┌─────────────────────────────────────────────────────────┐
│  CallAudioStreamService (音频流处理服务)                │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │  1. 音频缓冲 (1秒缓存)                           │  │
│  │     - 接收实时音频流                              │  │
│  │     - 缓存1秒数据 (32000 bytes)                  │  │
│  │     - 自动刷新缓冲区                              │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐  │
│  │  2. 语音识别 (ASR)                               │  │
│  │     - 火山引擎大模型语音识别                      │  │
│  │     - WebSocket实时连接                          │  │
│  │     - 返回识别文本 + 置信度                       │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐  │
│  │  3. AI对话处理                                   │  │
│  │     - 维护对话历史                                │  │
│  │     - 调用豆包大模型                              │  │
│  │     - 生成个性化回复                              │  │
│  │     - 应用系统提示词                              │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐  │
│  │  4. 语音合成 (TTS)                               │  │
│  │     - 豆包语音合成                                │  │
│  │     - 文本转PCM音频                               │  │
│  │     - 可配置音色、语速                            │  │
│  └──────────────────────────────────────────────────┘  │
│                        │                                 │
└────────────────────────┼─────────────────────────────────┘
                         │ 合成音频 (PCM)
                         ▼
                ┌─────────────────┐
                │  SIP服务器      │
                │  回传给客户      │
                └─────────────────┘
```

## 🏗️ 核心组件

### 1. CallAudioStreamService (音频流处理服务)

**文件位置**: `server/src/services/call-audio-stream.service.ts`

**主要功能**:
- 管理通话会话
- 音频缓冲和流控制
- 协调ASR、AI、TTS服务
- 保存对话记录

**核心方法**:

```typescript
// 创建通话会话
createCallSession(callId: string, customerId?: number, systemPrompt?: string): void

// 处理音频数据块
processAudioChunk(callId: string, audioChunk: Buffer): Promise<void>

// 结束通话会话
endCallSession(callId: string): void

// 获取会话信息
getSessionInfo(callId: string): CallSession | undefined
```

**会话数据结构**:

```typescript
interface CallSession {
  callId: string;                    // 通话唯一标识
  customerId?: number;               // 客户ID
  audioBuffer: Buffer[];             // 音频缓冲区
  bufferStartTime: number;           // 缓冲开始时间
  asrConnection?: WebSocket;         // ASR WebSocket连接
  conversationHistory: Array<{       // 对话历史
    role: string;                    // 'user' | 'assistant'
    content: string;                 // 对话内容
  }>;
  systemPrompt: string;              // 系统提示词
}
```

### 2. AIBridgeService (AI桥接服务)

**文件位置**: `server/src/services/ai-bridge.service.ts`

**主要功能**:
- 火山引擎ASR语音识别
- 豆包TTS语音合成
- AI大模型对话

**核心方法**:

```typescript
// 语音转文字
async speechToText(audioData: Buffer, options?: any): Promise<string>

// 文字转语音
async textToSpeech(text: string, options?: any): Promise<Buffer>

// 分析通话内容
async analyzeCall(transcript: string, options?: any): Promise<any>
```

## 📊 音频参数配置

### 音频格式规范

| 参数 | 值 | 说明 |
|------|-----|------|
| 格式 | PCM | 原始音频格式 |
| 采样率 | 16000 Hz | 16kHz |
| 位深度 | 16 bit | 2 bytes per sample |
| 声道 | 1 (Mono) | 单声道 |
| 语言 | zh-CN | 中文 |

### 缓冲区配置

| 参数 | 值 | 计算 |
|------|-----|------|
| 缓冲时长 | 1秒 | BUFFER_DURATION_MS = 1000 |
| 采样数 | 16000 | SAMPLE_RATE = 16000 |
| 字节数 | 32000 | 16000 * 2 bytes |

## 🔌 火山引擎ASR集成

### WebSocket连接

**URL格式**:
```
wss://openspeech.bytedance.com/api/v3/sauc/bigmodel?appid={appId}&token={apiKey}&cluster={cluster}&format=pcm&rate=16000&bits=16&channel=1&language=zh-CN
```

**请求头**:
```
X-Api-App-Key: {appId}
X-Api-Access-Key: {apiKey}
X-Api-Resource-Id: volc.bigasr.sauc.duration
```

### 配置管理

配置存储在数据库表 `volcengine_asr_configs`:

```sql
CREATE TABLE volcengine_asr_configs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL,
  app_id VARCHAR(50) NOT NULL,
  api_key VARCHAR(200) NOT NULL,
  ws_url VARCHAR(200) DEFAULT 'wss://openspeech.bytedance.com/api/v3/sauc/bigmodel',
  resource_id VARCHAR(100) DEFAULT 'volc.bigasr.sauc.duration',
  cluster_name VARCHAR(50) DEFAULT 'volcengine_input_common',
  sample_rate INT DEFAULT 16000,
  format VARCHAR(20) DEFAULT 'pcm',
  bits INT DEFAULT 16,
  channel INT DEFAULT 1,
  language VARCHAR(20) DEFAULT 'zh-CN',
  is_active BOOLEAN DEFAULT TRUE
);
```

## 🤖 AI对话系统

### 系统提示词

默认系统提示词用于指导AI的行为:

```
你是一位专业的幼儿园招生顾问，负责通过电话与家长沟通。
你的任务是：
1. 礼貌、热情地与家长交流
2. 了解家长的需求和孩子的情况
3. 介绍幼儿园的特色和优势
4. 回答家长的疑问
5. 引导家长预约参观或报名

注意事项：
- 保持专业和友好的语气
- 回答要简洁明了，每次回复控制在50字以内
- 不要做绝对化承诺
- 尊重家长的选择
- 如果家长表示不感兴趣，礼貌结束通话
```

### 对话历史管理

对话历史格式:

```typescript
[
  { role: 'system', content: '系统提示词' },
  { role: 'user', content: '客户: 你好，我想了解一下你们幼儿园' },
  { role: 'assistant', content: 'AI: 您好！我是XX幼儿园的招生顾问...' },
  { role: 'user', content: '客户: 学费是多少？' },
  { role: 'assistant', content: 'AI: 我们幼儿园的学费...' }
]
```

## 💾 数据持久化

### 通话记录保存

通话结束时，对话历史自动保存到 `call_records` 表:

```sql
UPDATE call_records 
SET transcription = ?,      -- 完整对话文本
    ai_responses = ?        -- AI回复JSON
WHERE call_id = ?
```

**transcription 格式**:
```
客户: 你好，我想了解一下你们幼儿园
AI: 您好！我是XX幼儿园的招生顾问，很高兴为您服务。请问您的孩子多大了？
客户: 3岁半
AI: 好的，3岁半的孩子可以上我们的小班。您方便来参观一下吗？
```

**ai_responses 格式**:
```json
[
  { "role": "assistant", "content": "您好！我是XX幼儿园的招生顾问..." },
  { "role": "assistant", "content": "好的，3岁半的孩子可以上我们的小班..." }
]
```

## 🔧 使用示例

### 创建通话会话

```typescript
import { callAudioStreamService } from './services/call-audio-stream.service';

// 创建会话
const callId = 'call_123456';
const customerId = 1001;
const systemPrompt = '你是一位专业的幼儿园招生顾问...';

callAudioStreamService.createCallSession(callId, customerId, systemPrompt);
```

### 处理音频流

```typescript
// 从SIP服务器接收音频数据
sipServer.on('audio-data', async (callId, audioChunk) => {
  await callAudioStreamService.processAudioChunk(callId, audioChunk);
});

// 监听AI语音响应
callAudioStreamService.on('audio-response', (data) => {
  const { callId, audioData, text } = data;
  
  // 将合成语音发送回SIP服务器
  sipServer.sendAudio(callId, audioData);
  
  console.log(`AI回复: ${text}`);
});
```

### 结束通话

```typescript
// 通话结束时
sipServer.on('call-ended', (callId) => {
  callAudioStreamService.endCallSession(callId);
});
```

## 📈 性能优化

### 1. 音频缓冲优化

- **缓冲时长**: 1秒 (平衡延迟和识别准确度)
- **自动刷新**: 缓冲区满时自动发送
- **内存管理**: 及时清理已处理的缓冲区

### 2. WebSocket连接池

- **连接复用**: 每个会话维护独立的ASR连接
- **自动重连**: 连接断开时自动重连
- **心跳检测**: 定期检测连接状态

### 3. 并发处理

- **多会话支持**: 使用Map管理多个并发会话
- **异步处理**: 所有I/O操作异步执行
- **事件驱动**: 基于EventEmitter的事件通知

## 🧪 测试

### 运行测试

```bash
cd server
npm run build
node tests/call-audio-stream-test.js
```

### 测试覆盖

- ✅ 会话创建和销毁
- ✅ 音频缓冲和刷新
- ✅ ASR识别流程
- ✅ AI对话生成
- ✅ TTS语音合成
- ✅ 对话历史保存

## 🔒 安全考虑

1. **API密钥保护**: 配置存储在数据库，不暴露在代码中
2. **数据加密**: 敏感数据传输使用HTTPS/WSS
3. **访问控制**: 基于角色的权限控制
4. **审计日志**: 记录所有通话和操作日志

## 📝 待办事项

- [ ] 集成真实的豆包大模型API
- [ ] 实现豆包TTS语音合成
- [ ] 添加语音质量检测
- [ ] 实现噪音过滤
- [ ] 添加情绪分析
- [ ] 优化延迟和响应时间
- [ ] 添加更多测试用例

---

**文档版本**: v1.0  
**创建时间**: 2025-01-14  
**最后更新**: 2025-01-14

