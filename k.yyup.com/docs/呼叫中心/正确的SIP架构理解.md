# æ­£ç¡®çš„SIPæ¶æ„ç†è§£

## ğŸ” æ¶æ„çº æ­£

### âŒ ä¹‹å‰çš„é”™è¯¯ç†è§£

```
æˆ‘ä»¬çš„ç³»ç»Ÿ â†’ SIPæœåŠ¡å™¨(47.94.82.59:5060)
ä½¿ç”¨è´¦å·: sales001 / zhuge3944
```

**é”™è¯¯**: sales001ä¸æ˜¯è´¦å·ï¼Œæ˜¯ç½‘å…³ï¼

### âœ… æ­£ç¡®çš„æ¶æ„

```
æˆ‘ä»¬çš„ç³»ç»Ÿ â†’ SIPæœåŠ¡å™¨(47.94.82.59:5060) â†’ å‘¼å«ç½‘å…³(sales001) â†’ ç”µè¯ç½‘ç»œ
è®¤è¯è´¦å·: kanderadmin / Szblade3944
```

## ğŸ“Š å®Œæ•´æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ      â”‚
â”‚  (Node.jsåç«¯)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ SIPåè®®
           â”‚ è®¤è¯: kanderadmin
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SIPæœåŠ¡å™¨         â”‚
â”‚  47.94.82.59:5060   â”‚
â”‚  (Asterisk/FreeSWITCH)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ è·¯ç”±åˆ°ç½‘å…³
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘¼å«ç½‘å…³          â”‚
â”‚   sales001          â”‚
â”‚  (å¤–å‘¼æ‹¨å·)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ PSTN/VoIP
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”µè¯ç½‘ç»œ          â”‚
â”‚  18611141133        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ­£ç¡®çš„æ‹¨æ‰“æµç¨‹

### æ­¥éª¤1: ä½¿ç”¨kanderadminè®¤è¯

```javascript
// 1. REGISTERæ³¨å†Œ
REGISTER sip:47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
To: <sip:kanderadmin@47.94.82.59>
Authorization: Digest username="kanderadmin", ...
```

### æ­¥éª¤2: é€šè¿‡ç½‘å…³æ‹¨æ‰“

```javascript
// 2. INVITEé€šè¿‡ç½‘å…³æ‹¨æ‰“
INVITE sip:18611141133@47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
To: <sip:18611141133@47.94.82.59>
Route: <sip:sales001@47.94.82.59>  // æŒ‡å®šç½‘å…³
```

æˆ–è€…ä½¿ç”¨ç½‘å…³å‰ç¼€ï¼š

```javascript
// ä½¿ç”¨ç½‘å…³å‰ç¼€æ‹¨æ‰“
INVITE sip:sales001/18611141133@47.94.82.59 SIP/2.0
```

## ğŸ“ å…³é”®æ¦‚å¿µ

### 1. è®¤è¯è´¦å· vs ç½‘å…³

| ç±»å‹ | åç§° | ç”¨é€” | å¯†ç  |
|------|------|------|------|
| **è®¤è¯è´¦å·** | kanderadmin | ç™»å½•SIPæœåŠ¡å™¨ | Szblade3944 |
| **å‘¼å«ç½‘å…³** | sales001 | å¤–å‘¼è·¯ç”± | zhuge3944 |

### 2. SIPæœåŠ¡å™¨è§’è‰²

**SIPæœåŠ¡å™¨** (47.94.82.59:5060):
- æ¥æ”¶æˆ‘ä»¬çš„REGISTERå’ŒINVITEè¯·æ±‚
- éªŒè¯kanderadminè´¦å·
- å°†å‘¼å«è·¯ç”±åˆ°sales001ç½‘å…³
- ç®¡ç†é€šè¯ä¼šè¯

**å‘¼å«ç½‘å…³** (sales001):
- è¿æ¥åˆ°ç”µè¯ç½‘ç»œ(PSTN/VoIP)
- å®é™…æ‹¨æ‰“å¤–éƒ¨å·ç 
- ä¼ è¾“éŸ³é¢‘æµ
- å¯èƒ½æœ‰è‡ªå·±çš„è®¤è¯(zhuge3944)

### 3. ä¸ºä»€ä¹ˆä¹‹å‰æ”¶åˆ°404

```
ä¹‹å‰çš„è¯·æ±‚:
INVITE sip:18611141133@47.94.82.59 SIP/2.0
From: <sip:sales001@47.94.82.59>  âŒ é”™è¯¯ï¼šæŠŠç½‘å…³å½“è´¦å·

é—®é¢˜:
1. sales001æ˜¯ç½‘å…³ï¼Œä¸æ˜¯è®¤è¯è´¦å·
2. æ²¡æœ‰å…ˆREGISTERæ³¨å†Œ
3. æ²¡æœ‰æŒ‡å®šé€šè¿‡å“ªä¸ªç½‘å…³è·¯ç”±
```

## ğŸš€ æ­£ç¡®çš„å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨Routeå¤´æŒ‡å®šç½‘å…³

```javascript
const inviteRequest = {
  method: 'INVITE',
  uri: `sip:18611141133@47.94.82.59`,
  headers: {
    from: { uri: `sip:kanderadmin@47.94.82.59`, params: { tag: fromTag } },
    to: { uri: `sip:18611141133@47.94.82.59` },
    route: [{ uri: `sip:sales001@47.94.82.59` }],  // æŒ‡å®šç½‘å…³
    'call-id': callId,
    cseq: { method: 'INVITE', seq: 1 },
    contact: [{ uri: `sip:kanderadmin@47.94.82.59` }],
    'content-type': 'application/sdp'
  },
  content: generateSDP()
};
```

### æ–¹æ¡ˆ2: ä½¿ç”¨ç½‘å…³å‰ç¼€

```javascript
const inviteRequest = {
  method: 'INVITE',
  uri: `sip:sales001/18611141133@47.94.82.59`,  // ç½‘å…³/å·ç 
  headers: {
    from: { uri: `sip:kanderadmin@47.94.82.59`, params: { tag: fromTag } },
    to: { uri: `sip:18611141133@47.94.82.59` },
    'call-id': callId,
    cseq: { method: 'INVITE', seq: 1 },
    contact: [{ uri: `sip:kanderadmin@47.94.82.59` }],
    'content-type': 'application/sdp'
  },
  content: generateSDP()
};
```

### æ–¹æ¡ˆ3: å…ˆREGISTERå†INVITE

```javascript
// 1. å…ˆæ³¨å†Œ
REGISTER sip:47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
Authorization: Digest username="kanderadmin", password="Szblade3944"

// 2. æ³¨å†ŒæˆåŠŸåæ‹¨æ‰“
INVITE sip:18611141133@47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
Route: <sip:sales001@47.94.82.59>
```

## ğŸ“‹ éœ€è¦ç¡®è®¤çš„ä¿¡æ¯

### ä»SIPæœåŠ¡å™¨ç®¡ç†å‘˜ç¡®è®¤

1. **ç½‘å…³é…ç½®**:
   - sales001æ˜¯å¦æ˜¯æ­£ç¡®çš„ç½‘å…³åç§°ï¼Ÿ
   - æ˜¯å¦è¿˜æœ‰å…¶ä»–ç½‘å…³ï¼Ÿ
   - ç½‘å…³çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼Ÿ

2. **æ‹¨å·æ ¼å¼**:
   - æ˜¯å¦éœ€è¦Routeå¤´ï¼Ÿ
   - æ˜¯å¦ä½¿ç”¨ç½‘å…³å‰ç¼€ï¼Ÿ
   - å·ç æ ¼å¼è¦æ±‚ï¼Ÿ

3. **è®¤è¯æµç¨‹**:
   - æ˜¯å¦å¿…é¡»å…ˆREGISTERï¼Ÿ
   - kanderadminæ˜¯å¦æœ‰ä½¿ç”¨sales001ç½‘å…³çš„æƒé™ï¼Ÿ
   - æ˜¯å¦éœ€è¦é¢å¤–çš„æˆæƒï¼Ÿ

## ğŸ¯ ä¸‹ä¸€æ­¥æµ‹è¯•è®¡åˆ’

### æµ‹è¯•1: ä½¿ç”¨Routeå¤´

```bash
node tests/make-call-with-route.js
```

**æµ‹è¯•å†…å®¹**:
- ä½¿ç”¨kanderadminè®¤è¯
- æ·»åŠ Routeå¤´æŒ‡å®šsales001ç½‘å…³
- æ‹¨æ‰“18611141133

### æµ‹è¯•2: ä½¿ç”¨ç½‘å…³å‰ç¼€

```bash
node tests/make-call-with-gateway-prefix.js
```

**æµ‹è¯•å†…å®¹**:
- URI: sip:sales001/18611141133@47.94.82.59
- ä½¿ç”¨kanderadminè®¤è¯

### æµ‹è¯•3: å…ˆREGISTERå†INVITE

```bash
node tests/make-call-with-register.js
```

**æµ‹è¯•å†…å®¹**:
- å…ˆREGISTERæ³¨å†Œ
- æ”¶åˆ°200 OKå
- å†å‘é€INVITE

## ğŸ“š å‚è€ƒèµ„æ–™

### SIP Routeå¤´

**RFC 3261**:
```
Route: <sip:gateway@server.com>

The Route header field is used to force routing for a request 
through the listed set of proxies.
```

### ç½‘å…³æ‹¨å·æ¨¡å¼

**å¸¸è§æ¨¡å¼**:
1. `sip:gateway/number@server` - ç½‘å…³å‰ç¼€
2. `Route: <sip:gateway@server>` - Routeå¤´
3. `sip:number@gateway.server` - ç½‘å…³åŸŸå

## âœ… æ€»ç»“

### å…³é”®çº æ­£

1. âŒ **sales001ä¸æ˜¯è´¦å·** - æ˜¯å‘¼å«ç½‘å…³
2. âœ… **kanderadminæ˜¯è´¦å·** - ç”¨äºè®¤è¯
3. âœ… **éœ€è¦æŒ‡å®šç½‘å…³** - é€šè¿‡Routeå¤´æˆ–URIå‰ç¼€

### æ¶æ„ç†è§£

```
è®¤è¯: kanderadmin (ç™»å½•SIPæœåŠ¡å™¨)
  â†“
è·¯ç”±: sales001 (å‘¼å«ç½‘å…³)
  â†“
æ‹¨æ‰“: 18611141133 (ç›®æ ‡å·ç )
```

### ä¸‹ä¸€æ­¥

1. åˆ›å»ºä½¿ç”¨Routeå¤´çš„æµ‹è¯•è„šæœ¬
2. åˆ›å»ºä½¿ç”¨ç½‘å…³å‰ç¼€çš„æµ‹è¯•è„šæœ¬
3. åˆ›å»ºå…ˆREGISTERçš„æµ‹è¯•è„šæœ¬
4. è”ç³»ç®¡ç†å‘˜ç¡®è®¤æ­£ç¡®çš„ç½‘å…³ä½¿ç”¨æ–¹å¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-01-14  
**çŠ¶æ€**: æ¶æ„ç†è§£å·²çº æ­£

