# è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹è°ƒç ”æŠ¥å‘Š

**è°ƒç ”æ—¶é—´**: 2025-10-14  
**è°ƒç ”äººå‘˜**: AI Assistant  
**äº§å“**: è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹ (Realtime Voice Model)

---

## ğŸ“‹ äº§å“æ¦‚è¿°

### å®˜æ–¹äº§å“é¡µé¢
- **äº§å“åç§°**: è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹
- **å®˜æ–¹é“¾æ¥**: https://www.volcengine.com/product/realtime-voice-model
- **APIæ–‡æ¡£**: https://www.volcengine.com/docs/6561/1594356

### æ ¸å¿ƒç‰¹æ€§

1. **ç«¯åˆ°ç«¯è¯­éŸ³å¯¹è¯**
   - ä½¿ç”¨åŸç”Ÿæ–¹æ³•æ·±åº¦èåˆè¯­éŸ³ä¸æ–‡æœ¬æ¨¡æ€
   - çœŸæ­£æ„ä¹‰ä¸Šçš„ç«¯åˆ°ç«¯è¯­éŸ³å¯¹è¯æ¨¡å‹
   - æ— éœ€åˆ†ç¦»ASRã€LLMã€TTSä¸‰ä¸ªæ­¥éª¤

2. **çœŸäººçº§åˆ«äº¤äº’**
   - çœŸäººçº§åˆ«çš„è¯­éŸ³å¯¹è¯äº¤äº’
   - èƒ½å¤Ÿä¸ºç”¨æˆ·å¸¦æ¥æ— å¯æ›¿ä»£çš„æƒ…æ„Ÿä»·å€¼
   - æ”¯æŒè¯­éŸ³æ‰“æ–­

3. **ä½å»¶è¿Ÿ**
   - è¶…ä½æ—¶å»¶ï¼šæ•´ä½“é“¾è·¯æ—¶å»¶ç¼©çŸ­è‡³1ç§’
   - åŸºäºå…¨é“¾è·¯æµå¼å¤„ç†
   - å®æ—¶ç§’å›ã€é€šè¯æµç•…

4. **å¤šè¯­è¨€æ”¯æŒ**
   - æ”¯æŒä¸­æ–‡å’Œè‹±è¯­ä¸¤å¤§è¯­ç§

---

## ğŸ”Œ APIæ¥å…¥ä¿¡æ¯

### WebSocketè¿æ¥åœ°å€

```
wss://openspeech.bytedance.com/api/v3/realtime/dialogue
```

### åè®®æ”¯æŒ

- **åè®®**: WebSocket (WSS)
- **äº¤äº’æ–¹å¼**: æµå¼äº¤äº’ï¼ˆå®¢æˆ·è¾¹å‘é€æ•°æ®è¾¹æ¥æ”¶æ•°æ®ï¼‰
- **æ•°æ®æ ¼å¼**: JSON

### è¯·æ±‚Headers

| Key | è¯´æ˜ | æ˜¯å¦å¿…é¡» | Valueç¤ºä¾‹ |
|-----|------|----------|-----------|
| `X-Api-App-ID` | ä½¿ç”¨ç«å±±å¼•æ“æ§åˆ¶å°åˆ›å»ºçš„åº”ç”¨ID | âœ… å¿…é¡» | `your-app-id` |
| `X-Api-Access-Key` | åº”ç”¨çš„è®¿é—®å¯†é’¥ | âœ… å¿…é¡» | `your-access-key` |

### å®¢æˆ·ç«¯äº‹ä»¶

#### 1. StartSession - å¯åŠ¨ä¼šè¯

```json
{
  "type": "session.start",
  "session": {
    "model": "doubao-realtime-voice-v1",
    "language": "zh",
    "voice": "zh_female_cancan_mars_bigtts",
    "instructions": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¹¼å„¿å›­æ‹›ç”Ÿé¡¾é—®...",
    "turn_detection": {
      "type": "server_vad",
      "threshold": 0.5,
      "prefix_padding_ms": 300,
      "silence_duration_ms": 500
    }
  }
}
```

**å‚æ•°è¯´æ˜**:
- `model`: æ¨¡å‹åç§°
- `language`: è¯­è¨€ï¼ˆzh/enï¼‰
- `voice`: è¯­éŸ³éŸ³è‰²
- `instructions`: ç³»ç»Ÿæç¤ºè¯
- `turn_detection`: è¯­éŸ³æ´»åŠ¨æ£€æµ‹é…ç½®

#### 2. SendAudio - å‘é€éŸ³é¢‘

```json
{
  "type": "input_audio_buffer.append",
  "audio": "base64ç¼–ç çš„éŸ³é¢‘æ•°æ®"
}
```

#### 3. CommitAudio - æäº¤éŸ³é¢‘

```json
{
  "type": "input_audio_buffer.commit"
}
```

#### 4. CancelResponse - å–æ¶ˆå“åº”

```json
{
  "type": "response.cancel"
}
```

### æœåŠ¡ç«¯äº‹ä»¶

#### 1. SessionCreated - ä¼šè¯åˆ›å»ºæˆåŠŸ

```json
{
  "type": "session.created",
  "session": {
    "id": "session_xxx",
    "model": "doubao-realtime-voice-v1"
  }
}
```

#### 2. AudioDelta - éŸ³é¢‘å¢é‡

```json
{
  "type": "response.audio.delta",
  "delta": "base64ç¼–ç çš„éŸ³é¢‘æ•°æ®"
}
```

#### 3. AudioDone - éŸ³é¢‘å®Œæˆ

```json
{
  "type": "response.audio.done"
}
```

#### 4. TextDelta - æ–‡æœ¬å¢é‡

```json
{
  "type": "response.text.delta",
  "delta": "AIå›å¤çš„æ–‡æœ¬ç‰‡æ®µ"
}
```

#### 5. Error - é”™è¯¯

```json
{
  "type": "error",
  "error": {
    "code": "error_code",
    "message": "é”™è¯¯æè¿°"
  }
}
```

---

## ğŸ¯ ä¸ç°æœ‰æ¶æ„çš„å¯¹æ¯”

### æ–¹æ¡ˆ1: åˆ†ç¦»å¼æ¶æ„ï¼ˆå½“å‰å®ç°ï¼‰

```
å®¢æˆ·éŸ³é¢‘ â†’ ASR (speechToText) â†’ LLM (generateChatCompletion) â†’ TTS (textToSpeech) â†’ AIéŸ³é¢‘
```

**ä¼˜ç‚¹**:
- âœ… çµæ´»æ€§é«˜ï¼Œå¯ä»¥å•ç‹¬æ›¿æ¢æ¯ä¸ªç»„ä»¶
- âœ… å¯ä»¥è·å–ä¸­é—´æ–‡æœ¬ç»“æœ
- âœ… æ˜“äºè°ƒè¯•

**ç¼ºç‚¹**:
- âŒ å»¶è¿Ÿé«˜ï¼ˆ3ä¸ªæ­¥éª¤ç´¯åŠ ï¼‰
- âŒ æˆæœ¬é«˜ï¼ˆ3æ¬¡APIè°ƒç”¨ï¼‰
- âŒ æƒ…æ„Ÿè¡¨è¾¾å—é™

### æ–¹æ¡ˆ2: ç«¯åˆ°ç«¯æ¶æ„ï¼ˆè±†åŒ…å®æ—¶è¯­éŸ³ï¼‰

```
å®¢æˆ·éŸ³é¢‘ â†’ è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹ â†’ AIéŸ³é¢‘
```

**ä¼˜ç‚¹**:
- âœ… å»¶è¿Ÿä½ï¼ˆ1ç§’å†…ï¼‰
- âœ… æˆæœ¬ä½ï¼ˆ1æ¬¡APIè°ƒç”¨ï¼‰
- âœ… æƒ…æ„Ÿè¡¨è¾¾è‡ªç„¶
- âœ… æ”¯æŒè¯­éŸ³æ‰“æ–­

**ç¼ºç‚¹**:
- âŒ çµæ´»æ€§ä½ï¼Œæ— æ³•å•ç‹¬æ›¿æ¢ç»„ä»¶
- âŒ å¯èƒ½æ— æ³•è·å–ä¸­é—´æ–‡æœ¬ï¼ˆå–å†³äºAPIï¼‰

---

## ğŸ’» é›†æˆæ–¹æ¡ˆ

### æ•°æ®åº“é…ç½®

éœ€è¦åœ¨ `ai_model_config` è¡¨ä¸­æ·»åŠ ï¼š

```sql
INSERT INTO ai_model_config (
  name,
  display_name,
  provider,
  model_type,
  endpoint_url,
  api_key,
  model_parameters,
  status,
  is_default,
  description
) VALUES (
  'doubao-realtime-voice-v1',
  'è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹',
  'bytedance_doubao',
  'multimodal',
  'wss://openspeech.bytedance.com/api/v3/realtime/dialogue',
  'ä½ çš„API Key',
  JSON_OBJECT(
    'app_id', 'ä½ çš„App ID',
    'language', 'zh',
    'voice', 'zh_female_cancan_mars_bigtts'
  ),
  'active',
  1,
  'è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹ï¼Œæ”¯æŒä½å»¶è¿Ÿè¯­éŸ³å¯¹è¯'
);
```

### ä»£ç é›†æˆ

#### æ–¹æ¡ˆA: åœ¨AIBridgeä¸­æ·»åŠ å®æ—¶è¯­éŸ³æ–¹æ³•

```typescript
// server/src/services/ai/bridge/ai-bridge.service.ts

async realtimeVoiceSession(params: {
  model: string;
  language: string;
  voice: string;
  instructions: string;
}, config?: {
  appId?: string;
  apiKey?: string;
}): Promise<WebSocket> {
  const wsUrl = 'wss://openspeech.bytedance.com/api/v3/realtime/dialogue';
  
  const ws = new WebSocket(wsUrl, {
    headers: {
      'X-Api-App-ID': config?.appId || process.env.VOLCANO_APP_ID,
      'X-Api-Access-Key': config?.apiKey || process.env.VOLCANO_API_KEY
    }
  });
  
  ws.on('open', () => {
    // å‘é€StartSessionäº‹ä»¶
    ws.send(JSON.stringify({
      type: 'session.start',
      session: {
        model: params.model,
        language: params.language,
        voice: params.voice,
        instructions: params.instructions
      }
    }));
  });
  
  return ws;
}
```

#### æ–¹æ¡ˆB: åˆ›å»ºä¸“é—¨çš„å®æ—¶è¯­éŸ³æœåŠ¡

```typescript
// server/src/services/doubao-realtime-voice-v2.service.ts

import WebSocket from 'ws';
import { EventEmitter } from 'events';

class DoubaoRealtimeVoiceService extends EventEmitter {
  private ws: WebSocket | null = null;
  
  async startSession(params: {
    callId: string;
    instructions: string;
    language?: string;
    voice?: string;
  }): Promise<void> {
    const wsUrl = 'wss://openspeech.bytedance.com/api/v3/realtime/dialogue';
    
    this.ws = new WebSocket(wsUrl, {
      headers: {
        'X-Api-App-ID': process.env.VOLCANO_APP_ID,
        'X-Api-Access-Key': process.env.VOLCANO_API_KEY
      }
    });
    
    this.ws.on('open', () => {
      this.ws?.send(JSON.stringify({
        type: 'session.start',
        session: {
          model: 'doubao-realtime-voice-v1',
          language: params.language || 'zh',
          voice: params.voice || 'zh_female_cancan_mars_bigtts',
          instructions: params.instructions
        }
      }));
    });
    
    this.ws.on('message', (data) => {
      const event = JSON.parse(data.toString());
      
      switch (event.type) {
        case 'session.created':
          this.emit('session-ready', { callId: params.callId });
          break;
        case 'response.audio.delta':
          this.emit('audio-delta', {
            callId: params.callId,
            audioData: Buffer.from(event.delta, 'base64')
          });
          break;
        case 'response.text.delta':
          this.emit('text-delta', {
            callId: params.callId,
            text: event.delta
          });
          break;
        case 'error':
          this.emit('error', {
            callId: params.callId,
            error: event.error
          });
          break;
      }
    });
  }
  
  async sendAudio(audioData: Buffer): Promise<void> {
    if (!this.ws) return;
    
    this.ws.send(JSON.stringify({
      type: 'input_audio_buffer.append',
      audio: audioData.toString('base64')
    }));
  }
  
  async commitAudio(): Promise<void> {
    if (!this.ws) return;
    
    this.ws.send(JSON.stringify({
      type: 'input_audio_buffer.commit'
    }));
  }
  
  async endSession(): Promise<void> {
    if (this.ws) {
      this.ws.close();
      this.ws = null;
    }
  }
}

export const doubaoRealtimeVoiceService = new DoubaoRealtimeVoiceService();
```

---

## ğŸš€ æ¨èæ–¹æ¡ˆ

### å»ºè®®ä½¿ç”¨ï¼šæ–¹æ¡ˆBï¼ˆä¸“é—¨çš„å®æ—¶è¯­éŸ³æœåŠ¡ï¼‰

**ç†ç”±**:
1. **æ›´ç¬¦åˆå®æ—¶è¯­éŸ³çš„ç‰¹æ€§** - WebSocketé•¿è¿æ¥ï¼Œäº‹ä»¶é©±åŠ¨
2. **æ›´æ˜“äºé›†æˆåˆ°SIP UDPæœåŠ¡** - ç›´æ¥è½¬å‘éŸ³é¢‘æµ
3. **æ›´å¥½çš„æ€§èƒ½** - å‡å°‘ä¸­é—´æ­¥éª¤ï¼Œé™ä½å»¶è¿Ÿ
4. **æ›´ä½çš„æˆæœ¬** - å•æ¬¡APIè°ƒç”¨æ›¿ä»£3æ¬¡è°ƒç”¨

### é›†æˆåˆ°SIP UDPæœåŠ¡

```typescript
// server/src/services/sip-udp.service.ts

async makeCall(phoneNumber: string, customerId?: number, systemPrompt?: string) {
  // ... SIP INVITEå‘é€ ...
  
  // å½“æ”¶åˆ°200 OKæ—¶
  if (statusCode === 200) {
    // å¯åŠ¨è±†åŒ…å®æ—¶è¯­éŸ³ä¼šè¯
    await doubaoRealtimeVoiceService.startSession({
      callId,
      instructions: systemPrompt || 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¹¼å„¿å›­æ‹›ç”Ÿé¡¾é—®...',
      language: 'zh',
      voice: 'zh_female_cancan_mars_bigtts'
    });
    
    // ç›‘å¬AIéŸ³é¢‘å“åº”
    doubaoRealtimeVoiceService.on('audio-delta', ({ callId, audioData }) => {
      // é€šè¿‡SIPå‘é€éŸ³é¢‘ç»™å®¢æˆ·
      this.sendAudioToClient(callId, audioData);
    });
  }
}

async processAudio(callId: string, audioData: Buffer) {
  // ç›´æ¥è½¬å‘éŸ³é¢‘åˆ°è±†åŒ…å®æ—¶è¯­éŸ³æœåŠ¡
  await doubaoRealtimeVoiceService.sendAudio(audioData);
  await doubaoRealtimeVoiceService.commitAudio();
}
```

---

## ğŸ“ æ€»ç»“

### âœ… **è±†åŒ…ç¡®å®æœ‰ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹ï¼**

- **äº§å“åç§°**: è±†åŒ…ç«¯åˆ°ç«¯å®æ—¶è¯­éŸ³å¤§æ¨¡å‹
- **APIåœ°å€**: `wss://openspeech.bytedance.com/api/v3/realtime/dialogue`
- **åè®®**: WebSocket
- **ç‰¹æ€§**: ä½å»¶è¿Ÿï¼ˆ1ç§’ï¼‰ã€æ”¯æŒæ‰“æ–­ã€çœŸäººçº§äº¤äº’

### ğŸ¯ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

1. **è·å–APIå‡­è¯**
   - åœ¨ç«å±±å¼•æ“æ§åˆ¶å°åˆ›å»ºåº”ç”¨
   - è·å– `App ID` å’Œ `Access Key`

2. **æ·»åŠ æ•°æ®åº“é…ç½®**
   - åœ¨ `ai_model_config` è¡¨ä¸­æ·»åŠ å®æ—¶è¯­éŸ³æ¨¡å‹é…ç½®

3. **å®ç°å®æ—¶è¯­éŸ³æœåŠ¡**
   - åˆ›å»º `doubao-realtime-voice-v2.service.ts`
   - å®ç°WebSocketè¿æ¥å’Œäº‹ä»¶å¤„ç†

4. **é›†æˆåˆ°SIP UDPæœåŠ¡**
   - ä¿®æ”¹ `sip-udp.service.ts`
   - ä½¿ç”¨å®æ—¶è¯­éŸ³æœåŠ¡æ›¿ä»£ASR+LLM+TTS

5. **æµ‹è¯•éªŒè¯**
   - ç«¯åˆ°ç«¯æµ‹è¯•å®Œæ•´å‘¼å«æµç¨‹
   - éªŒè¯å»¶è¿Ÿå’ŒéŸ³è´¨

---

**æ–‡æ¡£ç»´æŠ¤**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-14 11:45

