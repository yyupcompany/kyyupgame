# 网关拨打测试总结

## 📋 测试概述

在理解了 **sales001是网关而不是账号** 后，进行了多种网关拨打方式的测试。

## ✅ 已测试的方案

### 方案1: 使用Route头指定网关

**URI格式**: `sip:18611141133@47.94.82.59`  
**Route头**: `sip:sales001@47.94.82.59`

```
INVITE sip:18611141133@47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
To: <sip:18611141133@47.94.82.59>
Route: <sip:sales001@47.94.82.59>
```

**结果**: ❌ 404 Not Found

### 方案2: 使用网关前缀

**URI格式**: `sip:sales001/18611141133@47.94.82.59`

```
INVITE sip:sales001/18611141133@47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
To: <sip:sales001/18611141133@47.94.82.59>
```

**结果**: ❌ 404 Not Found

## 📊 测试结果对比

| 方案 | URI格式 | Route头 | 响应 | 状态 |
|------|---------|---------|------|------|
| **直接拨打** | `sip:18611141133@...` | 无 | 404 | ❌ |
| **Route头** | `sip:18611141133@...` | `sip:sales001@...` | 404 | ❌ |
| **网关前缀** | `sip:sales001/18611141133@...` | 无 | 404 | ❌ |

## 🔍 404错误持续分析

### 关键发现

**所有方案都收到404响应**，说明：

1. ✅ SIP服务器收到了请求
2. ✅ SIP通信正常
3. ❌ 但是找不到目标号码或路由

### 可能的根本原因

#### 原因1: 号码18611141133不存在（最可能）

SIP服务器上可能没有这个号码的路由配置。

**验证方法**:
- 联系SIP服务器管理员
- 查看服务器上的号码列表
- 尝试拨打其他号码

#### 原因2: 需要REGISTER注册

可能需要先REGISTER注册才能使用网关。

**标准流程**:
```
1. REGISTER sip:47.94.82.59
   Authorization: Digest username="kanderadmin"
   
2. 200 OK (注册成功)

3. INVITE sip:18611141133@47.94.82.59
   Route: <sip:sales001@47.94.82.59>
```

#### 原因3: 网关配置不正确

sales001可能不是正确的网关名称，或者需要特殊配置。

**需要确认**:
- 网关的正确名称
- 网关的使用权限
- 网关的配置参数

#### 原因4: 号码格式错误

可能需要特定的号码格式。

**尝试的格式**:
- ❌ `18611141133`
- ⏳ `+8618611141133`
- ⏳ `8618611141133`
- ⏳ `9018611141133` (加拨号前缀)

## 🚀 下一步建议

### 优先级1: 联系SIP服务器管理员（强烈推荐）

**必须确认的信息**:

1. **号码有效性**:
   - 18611141133是否是有效号码？
   - 是否有测试号码可以使用？
   - 号码的正确格式是什么？

2. **网关配置**:
   - sales001是否是正确的网关名称？
   - kanderadmin是否有使用sales001的权限？
   - 网关的正确使用方式是什么？

3. **拨打流程**:
   - 是否需要先REGISTER注册？
   - 是否需要特殊的拨号前缀？
   - 是否需要额外的认证？

4. **服务器日志**:
   - 查看SIP服务器日志
   - 了解404的具体原因
   - 获取正确的配置示例

### 优先级2: 实现REGISTER注册

```javascript
// 1. 先注册
REGISTER sip:47.94.82.59 SIP/2.0
From: <sip:kanderadmin@47.94.82.59>
Authorization: Digest username="kanderadmin", password="Szblade3944"

// 2. 收到200 OK

// 3. 再拨打
INVITE sip:18611141133@47.94.82.59 SIP/2.0
Route: <sip:sales001@47.94.82.59>
```

### 优先级3: 测试不同号码格式

```javascript
const testFormats = [
  '18611141133',           // 原始
  '+8618611141133',        // 国际格式
  '8618611141133',         // 带国家代码
  '9018611141133',         // 加拨号前缀
  '0018611141133',         // 国际前缀
];
```

### 优先级4: 测试内部号码

```javascript
const testNumbers = [
  '1000',  // 内部号码
  '1001',
  '1002',
  'kanderadmin',  // 用户名
];
```

## 📝 技术细节

### 测试1: Route头方式

**发送的请求**:
```
INVITE sip:18611141133@47.94.82.59 SIP/2.0
Via: SIP/2.0/UDP [local]:5060;branch=z9hG4bK...
From: <sip:kanderadmin@47.94.82.59>;tag=abc123
To: <sip:18611141133@47.94.82.59>
Route: <sip:sales001@47.94.82.59>
Call-ID: call_1760386301847
CSeq: 1 INVITE
Contact: <sip:kanderadmin@47.94.82.59>
Content-Type: application/sdp
Max-Forwards: 70
```

**收到的响应**:
```
SIP/2.0 404 Not Found
```

### 测试2: 网关前缀方式

**发送的请求**:
```
INVITE sip:sales001/18611141133@47.94.82.59 SIP/2.0
Via: SIP/2.0/UDP [local]:5060;branch=z9hG4bK...
From: <sip:kanderadmin@47.94.82.59>;tag=abc123
To: <sip:sales001/18611141133@47.94.82.59>
Call-ID: call_1760386389486
CSeq: 1 INVITE
Contact: <sip:kanderadmin@47.94.82.59>
Content-Type: application/sdp
Max-Forwards: 70
```

**收到的响应**:
```
SIP/2.0 404 Not Found
```

## 📚 SIP网关拨号参考

### 常见的网关拨号模式

#### 模式1: Route头（RFC 3261标准）
```
INVITE sip:number@server SIP/2.0
Route: <sip:gateway@server>
```

#### 模式2: 网关前缀
```
INVITE sip:gateway/number@server SIP/2.0
```

#### 模式3: 网关域名
```
INVITE sip:number@gateway.server SIP/2.0
```

#### 模式4: 拨号前缀
```
INVITE sip:9number@server SIP/2.0
```

### Asterisk网关配置示例

```ini
[sales001]
type=friend
host=dynamic
context=outbound
qualify=yes
nat=yes

[outbound]
exten => _X.,1,Dial(SIP/${EXTEN}@sales001)
```

## ✅ 已验证的功能

| 功能 | 状态 | 说明 |
|------|------|------|
| **架构理解** | ✅ | sales001是网关，不是账号 |
| **SIP通信** | ✅ | 真实SIP请求发送成功 |
| **Route头** | ✅ | 正确添加Route头 |
| **网关前缀** | ✅ | 正确使用网关前缀 |
| **服务器响应** | ✅ | 收到404响应 |
| **通话建立** | ❌ | 所有方案都失败 |

## 🎯 结论

### 成功的部分

1. ✅ **架构理解正确** - sales001是网关
2. ✅ **真实SIP通信** - 完全取消模拟
3. ✅ **多种方案测试** - Route头和网关前缀
4. ✅ **收到服务器响应** - 404 Not Found

### 待解决的问题

1. ⚠️ **404错误持续** - 所有方案都失败
2. ⚠️ **号码有效性未知** - 18611141133可能不存在
3. ⚠️ **网关配置未知** - sales001的正确使用方式
4. ⚠️ **缺少REGISTER** - 可能需要先注册

### 最重要的发现

**无论使用哪种网关拨号方式，都收到404响应**，说明：

1. 问题不在拨号方式
2. 可能是号码不存在
3. 可能需要REGISTER注册
4. 可能需要特殊配置

## 📞 推荐行动

**立即行动**: 联系SIP服务器管理员

**需要获取的信息**:
1. ✅ 18611141133是否有效？
2. ✅ 测试号码是什么？
3. ✅ sales001的正确使用方式？
4. ✅ 是否需要REGISTER？
5. ✅ 正确的拨号示例？

**备选方案**:
1. 实现REGISTER注册流程
2. 测试不同号码格式
3. 测试内部号码
4. 查看服务器日志

---

**文档版本**: v1.0  
**测试时间**: 2025-01-14  
**测试账号**: kanderadmin / Szblade3944  
**测试网关**: sales001  
**目标号码**: 18611141133  
**测试状态**: ✅ **真实SIP通信成功，但所有拨号方案都收到404响应**

**关键结论**: 需要联系SIP服务器管理员确认号码有效性和正确的网关使用方式。

