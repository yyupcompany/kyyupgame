# 呼叫中心系统开发需求文档

## 1. 项目概述

### 1.1 项目背景
为幼儿园管理系统开发智能呼叫中心模块，实现自动化外呼、客户管理、话术生成和合规审查等功能。

### 1.2 项目目标
- 建立基于SIP协议的呼叫中心系统
- 实现客户分类管理和话术模板配置
- 集成AI大模型进行话术生成和合规审查
- 提供完整的通话记录和统计功能
- 符合通信行业合规要求

### 1.3 技术栈
- **前端**: Vue 3 + TypeScript + Element Plus
- **后端**: Node.js + Express.js + TypeScript
- **通信协议**: SIP (Session Initiation Protocol)
- **AI语音合成**: 豆包语音合成 (通过AIBridge集成)
- **数据库**: MySQL + Sequelize ORM
- **实时通信**: WebSocket

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端管理界面   │────│   后端API服务   │────│   SIP服务器     │
│   Vue 3应用     │    │   Express.js    │    │   47.94.82.59   │
└─────────────────┘    └─────────────────┘    │      5060       │
                                │              └─────────────────┘
                       ┌─────────────────┐              │
                       │  AIBridge服务   │──────────────┤
                       │ 豆包语音合成     │              │
                       └─────────────────┘              │
                                │              ┌─────────────────┐
                       ┌─────────────────┐    │   呼叫网关      │
                       │   数据库存储     │    │  (外呼拨号)     │
                       │   MySQL         │    └─────────────────┘
                       └─────────────────┘              │
                                                       ┌─────────────────┐
                                                       │   分级SIP账号    │
                                                       │   1001等扩展账号 │
                                                       └─────────────────┘
```

### 2.2 语音合成技术链路
```
呼叫任务流程链路:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  呼叫中心系统    │───▶│   SIP服务器     │───▶│   呼叫网关      │
│  发起呼叫任务    │    │  接收任务       │    │  开始拨打电话    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │              │
                                ▼              ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   后端API服务   │◀───│   SIP服务器     │◀───│   呼叫网关      │
│  接收通话语音    │    │  传递语音数据    │    │  传输客户语音    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │
         ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  AIBridge服务   │───▶│   后端API服务   │───▶│   SIP服务器     │
│ 豆包语音合成     │    │  AI语音处理     │    │  传输合成语音    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │              │
         ┌──────────────────────┘              └──────────────────────┐
         ▼                                                           ▼
┌─────────────────┐                                          ┌─────────────────┐
│   通话记录      │                                          │   呼叫网关      │
│  存储文字内容    │                                          │  播放合成语音    │
│  (用于分析)     │                                          └─────────────────┘
└─────────────────┘
```

**语音合成流程说明:**
1. **呼叫发起**: 呼叫中心系统发起呼叫任务，推送任务给SIP服务器
2. **网关拨号**: SIP服务器将任务传递给呼叫网关，网关开始拨打客户电话
3. **语音接收**: 客户接听后，语音通过网关传回SIP服务器，再传到我们系统后台
4. **AI语音处理**: 后台调用AIBridge中的豆包语音合成大模型
5. **语音生成**: AI模型生成回复文字和合成语音
6. **语音传输**: 合成语音直接发送给SIP服务器，再传给网关播放给客户
7. **文字记录**: 回复文字内容记录在通话记录中，用于后期分析

### 2.3 模块划分
- **配置管理模块**: SIP服务器配置管理
- **通信模块**: SIP客户端和通话管理
- **语音合成模块**: 豆包语音合成集成
- **客户管理模块**: 客户分类和联系人管理
- **话术管理模块**: 话术模板和AI生成
- **合规审查模块**: AI驱动的合规检查
- **统计报表模块**: 通话记录和数据分析

## 3. 功能需求详细说明

### 3.1 SIP服务器配置管理

#### 3.1.1 主服务器配置
- **服务器地址**: 47.94.82.59
- **端口**: 5060
- **主账号**: kanderadmin
- **密码**: Szblade3944
- **协议**: SIP over UDP/TCP

#### 3.1.2 分级账号管理
- **功能**: 支持1001等扩展SIP账号配置
- **字段**:
  - 账号ID (如: 1001, 1002...)
  - 分机密码
  - 权限级别
  - 呼出权限
  - 并发通话数限制
- **状态管理**: 账号启用/禁用状态

#### 3.1.3 注册管理
- **自动注册**: 每小时自动重新注册
- **状态监控**: 实时监控注册状态
- **故障恢复**: 注册失败自动重试机制
- **日志记录**: 完整的注册日志

### 3.2 SIP客户端通信

#### 3.2.1 连接管理
- **连接池**: 管理多个SIP客户端连接
- **心跳检测**: 定期检测连接状态
- **断线重连**: 网络异常自动重连
- **负载均衡**: 多账号间的负载分配

#### 3.2.2 呼叫功能
- **外呼发起**: 支持单呼和批量外呼
- **呼叫状态**: 呼叫中、通话中、已挂断等状态
- **DTMF控制**: 支持按键控制
- **通话录音**: 可选的通话录音功能

#### 3.2.3 实时状态
- **WebSocket推送**: 实时推送通话状态
- **状态同步**: 多客户端状态同步
- **事件通知**: 呼叫事件实时通知

### 3.3 客户管理系统

#### 3.3.1 客户分类
- **老客户**:
  - 历史通话记录
  - 客户标签分类
  - 优先级设置
  - 最后联系时间
- **新客户**:
  - 潜在客户信息
  - 跟进状态
  - 转化率跟踪
  - 来源渠道

#### 3.3.2 联系人管理
- **基础信息**: 姓名、性别、年龄、联系方式
- **扩展信息**:
  - 孩子信息（年龄、兴趣等）
  - 家庭背景
  - 教育需求
  - 沟通偏好
- **黑名单管理**: 不再联系的号码管理

#### 3.3.3 客户标签系统
- **预设标签**: 高意向、犹豫中、已报名等
- **自定义标签**: 支持创建个性化标签
- **标签筛选**: 基于标签的客户筛选
- **标签统计**: 标签分布统计

### 3.4 话术模板管理

#### 3.4.1 话术分类
- **按场景分类**:
  - 新生招生话术
  - 活动邀请话术
  - 满意度调研话术
  - 续费提醒话术
- **按客户类型分类**:
  - 老客户回访话术
  - 新客户开发话术
  - 流失客户挽回话术

#### 3.4.2 话术结构
```
话术模板结构:
├── 开场白 (必选)
├── 身份确认 (必选)
├── 需求了解 (可选)
├── 产品介绍 (可选)
├── 异议处理 (可选)
├── 促成行动 (必选)
└── 结束语 (必选)
```

#### 3.4.3 话术变量
- **动态变量**: `[客户姓名]`、`[孩子姓名]`、`[活动名称]`等
- **条件分支**: 根据客户回答选择不同话术路径
- **个性化插入**: 根据客户信息定制化内容

### 3.5 语音合成与AI话术

#### 3.5.1 语音合成技术集成
- **AIBridge集成**: 复用现有AIBridge服务架构
- **豆包语音合成**:
  - 语音转文字 (ASR) - 客户语音识别
  - 文字转语音 (TTS) - AI回复语音合成
  - 支持多种音色和语调配置
- **实时处理**: 低延迟语音合成和传输
- **音频流管理**: 音频数据流的实时传输和处理

#### 3.5.2 语音处理流程
```
语音处理详细流程:
客户语音输入 → 网关接收 → SIP服务器 → 后端API
                                                    ↓
                                          AIBridge语音识别(ASR)
                                                    ↓
                                          AI话术生成与逻辑处理
                                                    ↓
                                          AIBridge语音合成(TTS)
                                                    ↓
                                          后端API → SIP服务器 → 网关 → 客户接收
```

#### 3.5.3 话术生成
- **模型集成**: 使用AIBridge中的豆包大模型
- **生成场景**:
  - 基于客户信息生成个性化话术
  - 根据通话目的生成专业话术
  - 针对特定场景的应急话术
- **参数配置**:
  - 话术长度控制
  - 语言风格设置
  - 专业程度调节
- **语音合成参数**:
  - 音色选择 (男声/女声/童声)
  - 语速控制
  - 情感表达配置
  - 停顿和重音设置

#### 3.5.4 合规审查
- **敏感词检测**:
  - 违规词汇库维护
  - 实时敏感词标记
  - 替换建议提供
- **合规规则**:
  - 不得承诺100%效果
  - 避免绝对化用语
  - 禁止误导性表述
  - 时间表述规范
- **审查报告**:
  - 合规评分
  - 风险等级
  - 修改建议

#### 3.5.5 话术优化
- **A/B测试**: 不同话术版本效果对比
- **效果分析**: 基于通话结果的话术优化
- **智能推荐**: AI推荐最佳话术模板

### 3.6 通话记录管理

#### 3.6.1 通话信息记录
- **基础信息**:
  - 通话时间（开始/结束）
  - 通话时长
  - 主叫号码
  - 被叫号码
  - 通话状态（接通/未接通/忙线等）

#### 3.6.2 通话内容记录
- **录音文件**: 通话录音存储和播放
- **AI文字转写**:
  - 通过豆包ASR自动转写客户语音
  - AI回复文字内容自动记录
  - 完整对话文字记录保存
- **关键信息提取**:
  - 客户意向度
  - 下一步行动
  - 重要事项记录
  - AI识别的对话要点
- **标签标记**: 通话结果标签
- **语音质量评估**: AI语音识别准确率分析

#### 3.6.3 通话质量评估
- **质量评分**: 通话质量自动评分
- **情绪分析**: 客户情绪状态分析
- **效果评估**: 通话效果和转化率
- **改进建议**: 基于分析结果的改进建议

### 3.7 统计报表系统

#### 3.7.1 实时监控
- **当前状态**: 实时通话状态显示
- **坐席状态**: 各SIP账号使用情况
- **呼叫队列**: 待处理呼叫队列
- **系统负载**: 系统资源使用情况

#### 3.7.2 统计报表
- **日报表**:
  - 日通话量统计
  - 接通率分析
  - 平均通话时长
  - 客户转化统计
- **月报表**:
  - 月度趋势分析
  - 客户活跃度统计
  - 话术效果对比
  - 坐席绩效统计
- **自定义报表**:
  - 自定义时间范围
  - 多维度数据分析
  - 图表可视化
  - 数据导出功能

#### 3.7.3 数据分析
- **转化漏斗**: 从呼听到转化的完整漏斗
- **客户画像**: 基于通话记录的客户分析
- **最佳实践**: 高效话术和时段分析
- **预测分析**: 基于历史数据的趋势预测

## 4. 数据库设计

### 4.1 核心数据表

#### 4.1.1 SIP配置表 (sip_configs)
```sql
CREATE TABLE sip_configs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL COMMENT '配置名称',
  server_host VARCHAR(255) NOT NULL COMMENT 'SIP服务器地址',
  server_port INT NOT NULL DEFAULT 5060 COMMENT 'SIP服务器端口',
  username VARCHAR(100) NOT NULL COMMENT 'SIP用户名',
  password VARCHAR(255) NOT NULL COMMENT 'SIP密码',
  protocol ENUM('UDP', 'TCP') DEFAULT 'UDP' COMMENT '通信协议',
  is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  last_register_time TIMESTAMP NULL COMMENT '最后注册时间',
  register_interval INT DEFAULT 3600 COMMENT '注册间隔(秒)',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 4.1.2 分机账号表 (sip_extensions)
```sql
CREATE TABLE sip_extensions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  sip_config_id INT NOT NULL COMMENT '关联SIP配置ID',
  extension VARCHAR(20) NOT NULL COMMENT '分机号',
  password VARCHAR(255) NOT NULL COMMENT '分机密码',
  display_name VARCHAR(100) COMMENT '显示名称',
  permission_level INT DEFAULT 1 COMMENT '权限级别',
  max_concurrent_calls INT DEFAULT 1 COMMENT '最大并发通话数',
  allow_outbound BOOLEAN DEFAULT TRUE COMMENT '允许呼出',
  is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  last_register_time TIMESTAMP NULL COMMENT '最后注册时间',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (sip_config_id) REFERENCES sip_configs(id)
);
```

#### 4.1.3 客户表 (call_center_customers)
```sql
CREATE TABLE call_center_customers (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(100) NOT NULL COMMENT '客户姓名',
  phone VARCHAR(20) NOT NULL COMMENT '电话号码',
  customer_type ENUM('NEW', 'EXISTING') NOT NULL COMMENT '客户类型',
  gender ENUM('MALE', 'FEMALE', 'UNKNOWN') DEFAULT 'UNKNOWN' COMMENT '性别',
  age_range VARCHAR(20) COMMENT '年龄段',
  children_info JSON COMMENT '孩子信息',
  family_background TEXT COMMENT '家庭背景',
  education_needs TEXT COMMENT '教育需求',
  communication_preference JSON COMMENT '沟通偏好',
  source_channel VARCHAR(100) COMMENT '来源渠道',
  last_contact_time TIMESTAMP NULL COMMENT '最后联系时间',
  contact_count INT DEFAULT 0 COMMENT '联系次数',
  priority_level INT DEFAULT 1 COMMENT '优先级',
  tags JSON COMMENT '客户标签',
  is_blacklisted BOOLEAN DEFAULT FALSE COMMENT '是否黑名单',
  notes TEXT COMMENT '备注信息',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_phone (phone)
);
```

#### 4.1.4 话术模板表 (call_scripts)
```sql
CREATE TABLE call_scripts (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(200) NOT NULL COMMENT '话术名称',
  category VARCHAR(100) NOT NULL COMMENT '话术分类',
  customer_type ENUM('NEW', 'EXISTING', 'BOTH') DEFAULT 'BOTH' COMMENT '适用客户类型',
  scenario VARCHAR(100) NOT NULL COMMENT '适用场景',
  content JSON NOT NULL COMMENT '话术内容(结构化)',
  variables JSON COMMENT '话术变量定义',
  compliance_score DECIMAL(3,2) DEFAULT 0.00 COMMENT '合规评分',
  is_ai_generated BOOLEAN DEFAULT FALSE COMMENT '是否AI生成',
  usage_count INT DEFAULT 0 COMMENT '使用次数',
  success_rate DECIMAL(5,2) DEFAULT 0.00 COMMENT '成功率',
  is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  created_by INT COMMENT '创建人ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 4.1.5 通话记录表 (call_records)
```sql
CREATE TABLE call_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  call_id VARCHAR(100) NOT NULL COMMENT '通话唯一标识',
  sip_extension_id INT COMMENT '使用分机ID',
  customer_id INT COMMENT '客户ID',
  phone_number VARCHAR(20) NOT NULL COMMENT '被叫号码',
  direction ENUM('OUTBOUND', 'INBOUND') DEFAULT 'OUTBOUND' COMMENT '呼叫方向',
  start_time TIMESTAMP NOT NULL COMMENT '开始时间',
  end_time TIMESTAMP NULL COMMENT '结束时间',
  duration INT DEFAULT 0 COMMENT '通话时长(秒)',
  status ENUM('PENDING', 'CONNECTED', 'MISSED', 'FAILED', 'HANGUP') DEFAULT 'PENDING' COMMENT '通话状态',
  recording_file_path VARCHAR(500) COMMENT '录音文件路径',
  transcription TEXT COMMENT '完整通话转录文本(客户语音+AI回复)',
  customer_speech TEXT COMMENT '客户语音转写内容',
  ai_responses TEXT COMMENT 'AI回复文字内容',
  speech_confidence DECIMAL(3,2) COMMENT '语音识别置信度',
  call_purpose VARCHAR(200) COMMENT '通话目的',
  call_result ENUM('SUCCESS', 'FAILED', 'PENDING', 'CALL_BACK') COMMENT '通话结果',
  customer_intent VARCHAR(100) COMMENT '客户意向',
  next_action TEXT COMMENT '下一步行动',
  notes TEXT COMMENT '通话备注',
  tags JSON COMMENT '通话标签',
  quality_score DECIMAL(3,2) COMMENT '通话质量评分',
  emotion_analysis JSON COMMENT '情绪分析结果',
  ai_voice_settings JSON COMMENT 'AI语音合成参数',
  speech_quality_score DECIMAL(3,2) COMMENT '语音质量评分',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (sip_extension_id) REFERENCES sip_extensions(id),
  FOREIGN KEY (customer_id) REFERENCES call_center_customers(id),
  INDEX idx_call_time (start_time),
  INDEX idx_phone_number (phone_number),
  INDEX idx_status (status)
);
```

#### 4.1.6 合规审查记录表 (compliance_checks)
```sql
CREATE TABLE compliance_checks (
  id INT PRIMARY KEY AUTO_INCREMENT,
  script_id INT COMMENT '话术模板ID',
  call_record_id INT COMMENT '通话记录ID',
  check_type ENUM('SCRIPT', 'RECORDING', 'TRANSCRIPTION') NOT NULL COMMENT '检查类型',
  content TEXT NOT NULL COMMENT '检查内容',
  sensitive_words JSON COMMENT '敏感词检测结果',
  compliance_score DECIMAL(3,2) NOT NULL COMMENT '合规评分',
  risk_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL') NOT NULL COMMENT '风险等级',
  violations JSON COMMENT '违规项详情',
  suggestions JSON COMMENT '修改建议',
  is_approved BOOLEAN DEFAULT FALSE COMMENT '是否通过审查',
  checked_by INT COMMENT '审查人ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (script_id) REFERENCES call_scripts(id),
  FOREIGN KEY (call_record_id) REFERENCES call_records(id)
);
```

## 5. API接口设计

### 5.1 SIP配置管理接口

#### 5.1.1 SIP配置CRUD
```typescript
// 获取SIP配置列表
GET /api/call-center/sip-configs
Response: {
  success: boolean,
  data: {
    configs: Array<{
      id: number,
      name: string,
      server_host: string,
      server_port: number,
      username: string,
      is_active: boolean,
      last_register_time: string,
      extensions: Array<SIPExtension>
    }>
  }
}

// 创建SIP配置
POST /api/call-center/sip-configs
Body: {
  name: string,
  server_host: string,
  server_port: number,
  username: string,
  password: string,
  protocol: 'UDP' | 'TCP'
}

// 更新SIP配置
PUT /api/call-center/sip-configs/:id
Body: Partial<SIPConfig>

// 删除SIP配置
DELETE /api/call-center/sip-configs/:id
```

#### 5.1.2 分机管理
```typescript
// 获取分机列表
GET /api/call-center/sip-extensions
Response: {
  success: boolean,
  data: {
    extensions: Array<{
      id: number,
      extension: string,
      display_name: string,
      permission_level: number,
      is_active: boolean,
      registration_status: 'REGISTERED' | 'UNREGISTERED',
      current_calls: number
    }>
  }
}

// 创建分机
POST /api/call-center/sip-extensions
Body: {
  sip_config_id: number,
  extension: string,
  password: string,
  display_name: string,
  permission_level: number,
  max_concurrent_calls: number
}

// 分机注册状态
GET /api/call-center/sip-extensions/:id/status
Response: {
  success: boolean,
  data: {
    registration_status: string,
    last_register_time: string,
    current_calls: number
  }
}
```

### 5.2 通话管理接口

#### 5.2.1 发起呼叫
```typescript
// 发起呼叫
POST /api/call-center/calls
Body: {
  sip_extension_id: number,
  phone_number: string,
  customer_id?: number,
  call_purpose: string,
  script_id?: number
}

// 获取通话状态
GET /api/call-center/calls/:callId/status
Response: {
  success: boolean,
  data: {
    call_id: string,
    status: 'PENDING' | 'CONNECTED' | 'MISSED' | 'FAILED' | 'HANGUP',
    duration: number,
    start_time: string,
    end_time?: string
  }
}

// 挂断通话
POST /api/call-center/calls/:callId/hangup
```

#### 5.2.2 批量呼叫
```typescript
// 批量呼叫
POST /api/call-center/batch-calls
Body: {
  customer_ids: number[],
  sip_extension_id: number,
  call_purpose: string,
  script_id?: number,
  batch_name: string
}

// 批量呼叫状态
GET /api/call-center/batch-calls/:batchId/status
```

### 5.3 客户管理接口

#### 5.3.1 客户CRUD
```typescript
// 获取客户列表
GET /api/call-center/customers
Query: {
  page: number,
  limit: number,
  customer_type?: 'NEW' | 'EXISTING',
  tags?: string[],
  search?: string
}

// 创建客户
POST /api/call-center/customers
Body: {
  name: string,
  phone: string,
  customer_type: 'NEW' | 'EXISTING',
  gender?: 'MALE' | 'FEMALE',
  age_range?: string,
  children_info?: object,
  tags?: string[]
}

// 更新客户
PUT /api/call-center/customers/:id
```

#### 5.3.2 客户标签
```typescript
// 获取标签列表
GET /api/call-center/customer-tags

// 添加客户标签
POST /api/call-center/customers/:id/tags
Body: { tags: string[] }

// 移除客户标签
DELETE /api/call-center/customers/:id/tags/:tag
```

### 5.4 话术管理接口

#### 5.4.1 话术模板
```typescript
// 获取话术模板
GET /api/call-center/scripts
Query: {
  category?: string,
  customer_type?: 'NEW' | 'EXISTING',
  scenario?: string
}

// 创建话术模板
POST /api/call-center/scripts
Body: {
  name: string,
  category: string,
  customer_type: 'NEW' | 'EXISTING' | 'BOTH',
  scenario: string,
  content: object, // 结构化话术内容
  variables?: object
}

// AI生成话术
POST /api/call-center/scripts/ai-generate
Body: {
  customer_info: object,
  call_purpose: string,
  scenario: string,
  style_preferences?: object,
  voice_settings?: {
    voice_type: 'male' | 'female' | 'child',
    speech_rate: number,
    emotion: string
  }
}
Response: {
  success: boolean,
  data: {
    generated_script: object,
    compliance_score: number,
    suggestions: string[],
    voice_audio_url?: string // 生成的示例语音
  }
}

// 语音合成接口
POST /api/call-center/voice/synthesize
Body: {
  text: string,
  voice_settings: {
    voice_type: 'male' | 'female' | 'child',
    speech_rate: number,
    emotion: string,
    volume: number
  }
}
Response: {
  success: boolean,
  data: {
    audio_url: string,
    audio_duration: number,
    text: string
  }
}

// 语音识别接口
POST /api/call-center/voice/recognize
Body: {
  audio_file_path: string,
  format: 'wav' | 'mp3' | 'pcm'
}
Response: {
  success: boolean,
  data: {
    text: string,
    confidence: number,
    alternatives: Array<{
      text: string,
      confidence: number
    }>
  }
}
```

#### 5.4.2 合规审查
```typescript
// 话术合规审查
POST /api/call-center/scripts/compliance-check
Body: {
  script_content: string,
  check_type: 'SCRIPT' | 'RECORDING' | 'TRANSCRIPTION'
}
Response: {
  success: boolean,
  data: {
    compliance_score: number,
    risk_level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL',
    sensitive_words: Array<{
      word: string,
      position: number,
      suggestion: string
    }>,
    violations: Array<{
      type: string,
      description: string,
      suggestion: string
    }>,
    is_approved: boolean
  }
}
```

### 5.5 统计报表接口

#### 5.5.1 实时统计
```typescript
// 获取实时统计
GET /api/call-center/statistics/realtime
Response: {
  success: boolean,
  data: {
    active_calls: number,
    total_calls_today: number,
    connection_rate: number,
    average_duration: number,
    extension_status: Array<{
      extension: string,
      status: 'IDLE' | 'BUSY' | 'RINGING',
      active_calls: number
    }>
  }
}
```

#### 5.5.2 历史统计
```typescript
// 获取通话统计
GET /api/call-center/statistics/calls
Query: {
  start_date: string,
  end_date: string,
  group_by?: 'day' | 'week' | 'month',
  dimension?: 'extension' | 'customer_type' | 'script'
}

// 获取转化统计
GET /api/call-center/statistics/conversions
Query: {
  start_date: string,
  end_date: string,
  customer_type?: string
}
```

## 6. 前端页面设计

### 6.1 页面结构
```
呼叫中心模块
├── 仪表板 (Dashboard)
│   ├── 实时监控
│   ├── 今日统计
│   └── 快捷操作
├── SIP配置管理
│   ├── 服务器配置
│   ├── 分机管理
│   └── 注册状态监控
├── 客户管理
│   ├── 客户列表
│   ├── 客户详情
│   ├── 标签管理
│   └── 黑名单管理
├── 话术中心
│   ├── 话术模板
│   ├── AI话术生成
│   ├── 合规审查
│   └── 效果分析
├── 通话管理
│   ├── 发起呼叫
│   ├── 通话记录
│   ├── 录音管理
│   └── 批量呼叫
└── 统计报表
    ├── 通话统计
    ├── 转化分析
    ├── 坐席绩效
    └── 自定义报表
```

### 6.2 核心页面组件

#### 6.2.1 呼叫中心仪表板
```vue
<template>
  <div class="call-center-dashboard">
    <!-- 实时状态监控 -->
    <el-row :gutter="20" class="status-cards">
      <el-col :span="6">
        <el-card title="当前通话">
          <div class="metric-value">{{ realtimeStats.activeCalls }}</div>
          <div class="metric-label">进行中通话</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card title="今日通话">
          <div class="metric-value">{{ realtimeStats.totalCallsToday }}</div>
          <div class="metric-label">总通话数</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card title="接通率">
          <div class="metric-value">{{ realtimeStats.connectionRate }}%</div>
          <div class="metric-label">接通成功率</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card title="平均时长">
          <div class="metric-value">{{ formatTime(realtimeStats.averageDuration) }}</div>
          <div class="metric-label">平均通话时长</div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 分机状态 -->
    <el-card title="分机状态" class="extension-status">
      <el-table :data="extensionStatus">
        <el-table-column prop="extension" label="分机号" />
        <el-table-column prop="status" label="状态">
          <template #default="{ row }">
            <el-tag :type="getStatusType(row.status)">
              {{ getStatusText(row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="activeCalls" label="当前通话" />
        <el-table-column label="操作">
          <template #default="{ row }">
            <el-button
              size="small"
              @click="makeCall(row.extension)"
              :disabled="row.status !== 'IDLE'"
            >
              发起呼叫
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 快捷操作 -->
    <el-card title="快捷操作" class="quick-actions">
      <el-row :gutter="20">
        <el-col :span="8">
          <el-button type="primary" @click="showCallDialog = true">
            <el-icon><Phone /></el-icon>
            发起呼叫
          </el-button>
        </el-col>
        <el-col :span="8">
          <el-button @click="showBatchCallDialog = true">
            <el-icon><List /></el-icon>
            批量呼叫
          </el-button>
        </el-col>
        <el-col :span="8">
          <el-button @click="generateAIScript">
            <el-icon><Magic /></el-icon>
            AI话术生成
          </el-button>
        </el-col>
      </el-row>
    </el-card>
  </div>
</template>
```

#### 6.2.2 SIP配置管理页面
```vue
<template>
  <div class="sip-config-management">
    <!-- 服务器配置 -->
    <el-card title="SIP服务器配置" class="server-config">
      <el-form :model="serverForm" label-width="120px">
        <el-form-item label="服务器地址">
          <el-input v-model="serverForm.server_host" placeholder="47.94.82.59" />
        </el-form-item>
        <el-form-item label="端口">
          <el-input-number v-model="serverForm.server_port" :min="1" :max="65535" />
        </el-form-item>
        <el-form-item label="用户名">
          <el-input v-model="serverForm.username" placeholder="kanderadmin" />
        </el-form-item>
        <el-form-item label="密码">
          <el-input v-model="serverForm.password" type="password" />
        </el-form-item>
        <el-form-item label="协议">
          <el-select v-model="serverForm.protocol">
            <el-option label="UDP" value="UDP" />
            <el-option label="TCP" value="TCP" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="saveServerConfig">保存配置</el-button>
          <el-button @click="testConnection">测试连接</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 分机管理 -->
    <el-card title="分机账号管理" class="extension-management">
      <div class="extension-header">
        <el-button type="primary" @click="showExtensionDialog = true">
          添加分机
        </el-button>
        <el-button @click="refreshExtensions">刷新状态</el-button>
      </div>

      <el-table :data="extensions" v-loading="loading">
        <el-table-column prop="extension" label="分机号" />
        <el-table-column prop="display_name" label="显示名称" />
        <el-table-column prop="permission_level" label="权限级别" />
        <el-table-column prop="max_concurrent_calls" label="最大并发" />
        <el-table-column prop="registration_status" label="注册状态">
          <template #default="{ row }">
            <el-tag :type="row.registration_status === 'REGISTERED' ? 'success' : 'danger'">
              {{ row.registration_status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="current_calls" label="当前通话" />
        <el-table-column label="操作">
          <template #default="{ row }">
            <el-button size="small" @click="editExtension(row)">编辑</el-button>
            <el-button size="small" type="danger" @click="deleteExtension(row.id)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 分机添加/编辑对话框 -->
    <el-dialog v-model="showExtensionDialog" :title="editingExtension ? '编辑分机' : '添加分机'">
      <el-form :model="extensionForm" label-width="120px">
        <el-form-item label="分机号" required>
          <el-input v-model="extensionForm.extension" placeholder="如: 1001" />
        </el-form-item>
        <el-form-item label="密码" required>
          <el-input v-model="extensionForm.password" type="password" />
        </el-form-item>
        <el-form-item label="显示名称">
          <el-input v-model="extensionForm.display_name" />
        </el-form-item>
        <el-form-item label="权限级别">
          <el-input-number v-model="extensionForm.permission_level" :min="1" :max="10" />
        </el-form-item>
        <el-form-item label="最大并发">
          <el-input-number v-model="extensionForm.max_concurrent_calls" :min="1" :max="10" />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showExtensionDialog = false">取消</el-button>
        <el-button type="primary" @click="saveExtension">保存</el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

## 7. 项目架构集成

### 7.1 现有项目架构分析

#### 7.1.1 前端架构概览
基于扫描分析，现有项目具备完善的架构体系：

**目录结构规模**:
- **前端组件**: 80+ Vue组件，162+页面
- **API模块**: 30+ API模块，按业务域分类
- **路由系统**: 动态路由 + 中心化页面
- **状态管理**: Pinia stores (用户、权限、AI助手等)
- **样式系统**: SCSS变量 + 主题切换

**核心架构特点**:
- Vue 3 + TypeScript + Vite
- Element Plus UI组件库
- 动态权限路由系统
- 中心化页面设计模式
- AI助手集成架构

#### 7.1.2 动态菜单认证系统

**四级权限架构**:
```
Level 1: 菜单权限 (侧边栏显示)
Level 2: 页面访问权限 (路由守卫)
Level 3: 组件权限 (按钮/功能)
Level 4: 数据权限 (CRUD操作)
```

**权限管理核心**:
- **动态路由生成**: `client/src/router/dynamic-routes.ts` (1500+行)
- **权限Store**: `client/src/stores/permissions.ts`
- **权限API**: `/api/dynamic-permissions/*`
- **组件映射**: 160+预定义组件映射

**权限验证流程**:
```typescript
// 1. 获取用户权限
GET /api/dynamic-permissions/user-permissions

// 2. 动态路由生成
GET /api/dynamic-permissions/dynamic-routes

// 3. 页面权限验证
POST /api/dynamic-permissions/check-permission
```

#### 7.1.3 全局样式和主题系统

**SCSS变量系统** (`client/src/assets/scss/_variables.scss`):
```scss
// 主色调
$primary-color: #007bff;
$secondary-color: #6c757d;

// 功能色彩
$success-color: #28a745;
$danger-color: #dc3545;
$warning-color: #ffc107;
$info-color: #17a2b8;

// 灰度色板
$gray-100: #f8f9fa;
$gray-200: #e9ecef;
// ... 完整的灰度系统

// 间距系统
$spacer: 1rem; // 16px基准
$spacers: (
  0: 0,
  1: $spacer * .25,  // 4px
  2: $spacer * .5,   // 8px
  3: $spacer,        // 16px
  4: $spacer * 1.5,  // 24px
  5: $spacer * 3     // 48px
);
```

**主题切换系统**:
- **暗黑主题**: `theme-dark` (默认)
- **明亮主题**: `theme-light`
- **动态切换**: 支持实时切换和持久化存储
- **CSS变量**: 使用CSS自定义属性实现主题切换

**布局系统** (`client/src/layouts/MainLayout.vue`):
- **响应式设计**: 支持桌面端、平板、移动端
- **侧边栏**: 可折叠，支持多种样式
- **顶部导航**: 面包屑 + 用户信息 + 功能按钮
- **AI助手集成**: 侧边栏联动，全屏模式

### 7.2 呼叫中心架构集成策略

#### 7.2.1 模块集成方案

**1. 中心化页面集成**
```typescript
// 在 dynamic-routes.ts 中添加呼叫中心路由
{
  path: 'centers/call-center',
  name: 'CallCenter',
  component: componentMap['pages/centers/CallCenter.vue'],
  meta: {
    title: '呼叫中心',
    requiresAuth: true,
    permission: 'CALL_CENTER_VIEW'
  }
}
```

**2. 权限系统集成**
```sql
-- 添加呼叫中心权限记录
INSERT INTO permissions (name, code, type, category) VALUES
('呼叫中心查看', 'CALL_CENTER_VIEW', 'menu', '呼叫中心'),
('呼叫中心管理', 'CALL_CENTER_MANAGE', 'menu', '呼叫中心'),
('SIP配置管理', 'SIP_CONFIG_MANAGE', 'button', '呼叫中心'),
('客户管理', 'CALL_CUSTOMER_MANAGE', 'button', '呼叫中心'),
('话术管理', 'CALL_SCRIPT_MANAGE', 'button', '呼叫中心');
```

**3. API模块集成**
```typescript
// 创建 client/src/api/modules/call-center.ts
export const callCenterAPI = {
  // SIP配置管理
  getSIPConfigs: () => get('/call-center/sip-configs'),
  createSIPConfig: (data: any) => post('/call-center/sip-configs', data),

  // 通话管理
  makeCall: (data: any) => post('/call-center/calls', data),
  getCallRecords: (params: any) => get('/call-center/call-records', params),

  // 客户管理
  getCustomers: (params: any) => get('/call-center/customers', params),

  // 话术管理
  getScripts: (params: any) => get('/call-center/scripts', params),

  // 统计报表
  getStatistics: (params: any) => get('/call-center/statistics', params)
};
```

#### 7.2.2 UI组件设计规范

**1. 设计语言一致性**
- 使用Element Plus组件库
- 遵循现有色彩系统 (primary, success, danger, warning)
- 统一间距系统 ($spacers)
- 一致的圆角和阴影风格

**2. 响应式设计**
```vue
<template>
  <div class="call-center-container">
    <!-- 遵循现有布局模式 -->
    <el-row :gutter="20">
      <el-col :xs="24" :sm="24" :md="18" :lg="18" :xl="18">
        <!-- 主内容区 -->
      </el-col>
      <el-col :xs="24" :sm="24" :md="6" :lg="6" :xl="6">
        <!-- 侧边栏 -->
      </el-col>
    </el-row>
  </div>
</template>

<style lang="scss" scoped>
.call-center-container {
  padding: var(--spacing-md);

  // 使用统一的变量系统
  .status-indicator {
    background-color: $success-color;
    border-radius: $border-radius-lg;
  }
}
</style>
```

**3. 主题适配**
```scss
// 支持暗黑/明亮主题
.call-center-dashboard {
  background: var(--el-bg-color);
  color: var(--el-text-color-primary);

  .metric-card {
    background: var(--el-bg-color-overlay);
    border: 1px solid var(--el-border-color-light);
  }
}
```

#### 7.2.3 状态管理集成

**Pinia Store设计**:
```typescript
// client/src/stores/call-center.ts
import { defineStore } from 'pinia'

export const useCallCenterStore = defineStore('callCenter', () => {
  // SIP配置状态
  const sipConfigs = ref([])
  const activeExtensions = ref([])

  // 通话状态
  const activeCalls = ref([])
  const callHistory = ref([])

  // 实时统计
  const realtimeStats = ref({
    activeCalls: 0,
    totalCallsToday: 0,
    connectionRate: 0,
    averageDuration: 0
  })

  // WebSocket连接
  const wsConnection = ref(null)

  // actions
  const initializeCallCenter = async () => {
    // 初始化呼叫中心
  }

  const makeCall = async (phoneNumber: string) => {
    // 发起呼叫
  }

  const hangupCall = async (callId: string) => {
    // 挂断通话
  }

  return {
    sipConfigs,
    activeExtensions,
    activeCalls,
    callHistory,
    realtimeStats,
    wsConnection,
    initializeCallCenter,
    makeCall,
    hangupCall
  }
})
```

### 7.3 后端架构集成

#### 7.3.1 Controller层设计

**遵循现有模式**:
```typescript
// server/src/controllers/call-center.controller.ts
import { BaseResponse } from '../types/common'
import { CallCenterService } from '../services/call-center.service'

@Controller('call-center')
export class CallCenterController {
  constructor(private readonly callCenterService: CallCenterService) {}

  @Get('sip-configs')
  @UseGuards(JwtAuthGuard)
  async getSIPConfigs(@Request() req): Promise<BaseResponse> {
    return this.callCenterService.getSIPConfigs(req.user)
  }

  @Post('calls')
  @UseGuards(JwtAuthGuard, PermissionsGuard)
  @RequirePermissions('CALL_CENTER_MANAGE')
  async makeCall(@Body() callData: any, @Request() req): Promise<BaseResponse> {
    return this.callCenterService.makeCall(callData, req.user)
  }
}
```

#### 7.3.2 Service层设计

**复用现有服务模式**:
```typescript
// server/src/services/call-center.service.ts
import { Injectable } from '@nestjs/common'
import { AIBridgeService } from './ai-bridge.service'

@Injectable()
export class CallCenterService {
  constructor(
    private readonly aiBridgeService: AIBridgeService,
    private readonly sipService: SIPService
  ) {}

  async makeCall(callData: any, user: any) {
    // 1. 验证权限
    // 2. 创建通话记录
    // 3. 调用SIP服务
    // 4. 处理语音合成
  }

  async processVoiceInput(audioBuffer: Buffer) {
    // 调用AIBridge语音识别
    return this.aiBridgeService.speechToText(audioBuffer)
  }

  async generateVoiceResponse(text: string, voiceSettings: any) {
    // 调用AIBridge语音合成
    return this.aiBridgeService.textToSpeech(text, voiceSettings)
  }
}
```

#### 7.3.3 数据库集成

**扩展现有模型**:
```typescript
// 在现有数据库中添加呼叫中心表
// server/src/models/call-center.model.ts
import { DataTypes, Model } from 'sequelize'

export class CallRecord extends Model {
  static initModel(sequelize) {
    CallRecord.init({
      id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
      callId: { type: DataTypes.STRING(100), allowNull: false },
      customerId: { type: DataTypes.INTEGER },
      phoneNumber: { type: DataTypes.STRING(20), allowNull: false },
      // ... 其他字段
    }, {
      sequelize,
      modelName: 'CallRecord',
      tableName: 'call_records'
    })
  }
}
```

### 7.4 AI服务集成

#### 7.4.1 AIBridge集成

**复用现有AI架构**:
```typescript
// 扩展现有 AIBridgeService
export class AIBridgeService {
  // 现有方法...

  // 新增呼叫中心相关方法
  async speechToText(audioBuffer: Buffer): Promise<{
    text: string;
    confidence: number;
  }> {
    // 调用豆包ASR
  }

  async textToSpeech(text: string, settings: VoiceSettings): Promise<{
    audioBuffer: Buffer;
    duration: number;
  }> {
    // 调用豆包TTS
  }

  async generateCallScript(customerInfo: any, purpose: string): Promise<{
    script: string;
    complianceScore: number;
  }> {
    // 生成个性化话术
  }

  async checkCompliance(content: string): Promise<{
    isCompliant: boolean;
    issues: string[];
    suggestions: string[];
  }> {
    // 合规审查
  }
}
```

#### 7.4.2 实时通信集成

**WebSocket集成**:
```typescript
// server/src/gateways/call-center.gateway.ts
@WebSocketGateway({
  namespace: '/call-center',
  cors: true
})
export class CallCenterGateway {
  @WebSocketServer()
  server: Server

  @SubscribeMessage('join-call-center')
  handleJoinCallCenter(client: Socket, data: any) {
    // 加入呼叫中心房间
  }

  @SubscribeMessage('call-status-update')
  handleCallStatusUpdate(client: Socket, data: any) {
    // 广播通话状态更新
  }

  // 实时推送通话状态、统计信息等
}
```

### 7.5 测试集成

#### 7.5.1 遵循现有测试规范

**测试结构**:
```
client/tests/call-center/
├── unit/
│   ├── components/
│   ├── services/
│   └── stores/
├── integration/
│   ├── api/
│   └── websocket/
└── e2e/
    ├── call-flow.test.ts
    └── sip-connection.test.ts
```

**测试工具集成**:
- **单元测试**: Vitest (复用现有配置)
- **集成测试**: 现有API测试框架
- **E2E测试**: Playwright (复用现有配置)

## 8. 技术实现要点

### 8.1 SIP客户端实现
- **技术选择**: 使用 `sip.js` 或 `drachtio` 等Node.js SIP库
- **连接管理**: 实现连接池和自动重连机制
- **注册机制**: 定时注册和状态监控
- **媒体处理**: 音频编码解码和录音功能
- **网关通信**: 与呼叫网关的协议适配

### 7.2 豆包语音合成集成
- **AIBridge复用**: 复用现有AIBridge服务架构
- **语音识别(ASR)**:
  - 实时语音流处理
  - 噪音过滤和语音增强
  - 多语言和方言支持
- **语音合成(TTS)**:
  - 自然语音合成
  - 多音色选择和情感控制
  - 流式语音生成
- **音频处理**:
  - 音频格式转换
  - 音质优化
  - 延迟控制
- **错误处理**: 语音识别失败的备选方案

### 7.3 AI大模型集成
- **豆包大模型**: 配置模型参数和提示词模板
- **对话管理**: 上下文理解和对话状态管理
- **合规词库**: 建立敏感词库和规则引擎
- **实时分析**: 通话过程中的实时合规检查
- **个性化**: 基于客户信息的个性化回复

### 7.4 实时通信
- **WebSocket**: 实现状态推送和实时通知
- **事件驱动**: 基于事件的通话状态管理
- **并发处理**: 多通道并发通话处理
- **队列管理**: 呼叫队列和优先级管理
- **音频流传输**: 实时音频数据传输协议

### 7.5 数据存储优化
- **索引优化**: 关键字段建立合适索引
- **分区表**: 大数据量表按时间分区
- **缓存策略**: Redis缓存热点数据
- **数据归档**: 历史数据定期归档

## 8. 安全与合规

### 8.1 数据安全
- **加密存储**: 敏感信息加密存储
- **访问控制**: 基于角色的数据访问控制
- **审计日志**: 完整的操作审计日志
- **备份恢复**: 数据备份和恢复机制

### 8.2 通信合规
- **录音提示**: 通话录音前告知提示
- **数据保护**: 个人信息保护措施
- **合规检查**: 话术和通话内容合规审查
- **监管接口**: 符合通信监管要求

### 8.3 系统安全
- **身份认证**: 强身份认证机制
- **权限控制**: 细粒度权限控制
- **安全审计**: 安全事件监控和审计
- **漏洞防护**: 安全漏洞防护措施

## 9. 部署与运维

### 9.1 系统部署
- **环境要求**: Node.js 18+, MySQL 8.0, Redis
- **配置管理**: 环境配置和密钥管理
- **服务部署**: Docker容器化部署
- **负载均衡**: 多实例负载均衡

### 9.2 监控告警
- **系统监控**: CPU、内存、网络监控
- **业务监控**: 通话质量、成功率监控
- **日志监控**: 错误日志和异常监控
- **告警机制**: 多渠道告警通知

### 9.3 性能优化
- **数据库优化**: 查询优化和索引调优
- **缓存优化**: 多级缓存策略
- **网络优化**: 网络延迟和带宽优化
- **资源优化**: 资源使用优化

## 10. 测试策略

### 10.1 单元测试
- **API测试**: 所有接口功能测试
- **服务测试**: 业务逻辑单元测试
- **组件测试**: 前端组件单元测试
- **覆盖率要求**: 代码覆盖率≥90%

### 10.2 集成测试
- **SIP集成**: SIP服务器连接测试
- **AI集成**: AI服务集成测试
- **数据库集成**: 数据库操作测试
- **端到端测试**: 完整业务流程测试

### 10.3 性能测试
- **并发测试**: 多用户并发呼叫测试
- **负载测试**: 系统负载能力测试
- **稳定性测试**: 长时间运行稳定性测试
- **压力测试**: 极限负载压力测试

## 11. 项目计划

### 11.1 开发阶段
- **第一阶段** (2周): SIP配置管理和基础通话功能
- **第二阶段** (2周): 客户管理和话术模板系统
- **第三阶段** (2周): AI集成和合规审查功能
- **第四阶段** (1周): 统计报表和数据分析
- **第五阶段** (1周): 测试、优化和部署

### 11.2 里程碑
- **里程碑1**: SIP客户端连通性验证
- **里程碑2**: 基础呼叫功能完成
- **里程碑3**: AI话术生成功能完成
- **里程碑4**: 合规审查功能完成
- **里程碑5**: 系统完整测试通过

### 11.3 风险管控
- **技术风险**: SIP协议兼容性和网络稳定性
- **合规风险**: 通信合规要求和数据保护
- **资源风险**: 开发资源和技术能力
- **时间风险**: 开发进度和质量控制

---

*文档版本: v1.0*
*创建时间: 2025-01-14*
*最后更新: 2025-01-14*