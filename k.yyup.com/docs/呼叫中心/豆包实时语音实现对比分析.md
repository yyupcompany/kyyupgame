# è±†åŒ…å®æ—¶è¯­éŸ³å®ç°å¯¹æ¯”åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å¯¹æ¯”åˆ†æ**è±†åŒ…å®˜æ–¹ç¤ºä¾‹ä»£ç **ä¸**æˆ‘ä»¬çš„å®ç°**ï¼ŒéªŒè¯åŠŸèƒ½å®Œæ•´æ€§ã€‚

## ğŸ” åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½æ¨¡å— | å®˜æ–¹ç¤ºä¾‹ | æˆ‘ä»¬çš„å®ç° | çŠ¶æ€ |
|---------|---------|-----------|------|
| **WebSocketè¿æ¥ç®¡ç†** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **è¿æ¥å»ºç«‹ (onopen)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **æ¶ˆæ¯æ¥æ”¶ (onmessage)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **è¿æ¥å…³é—­ (onclose)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **é”™è¯¯å¤„ç† (onerror)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **éŸ³é¢‘æ•°æ®å‘é€** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **è¯†åˆ«ç»“æœå¤„ç†** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **ä¸­é—´ç»“æœ (partial)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **æœ€ç»ˆç»“æœ (final)** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **ä¼šè¯ç»“æŸ** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **è¯æœ¯è®°å½•ä¿å­˜** | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| **äº‹ä»¶é©±åŠ¨æ¶æ„** | âŒ | âœ… | âœ… å¢å¼ºå®ç° |
| **ç³»ç»Ÿæç¤ºè¯** | âŒ | âœ… | âœ… å¢å¼ºå®ç° |
| **å¯¹è¯å†å²ç®¡ç†** | âŒ | âœ… | âœ… å¢å¼ºå®ç° |
| **AIè¯­éŸ³å›å¤** | âŒ | âœ… | âœ… å¢å¼ºå®ç° |
| **ç”¨æˆ·æ‰“æ–­æ”¯æŒ** | âŒ | âœ… | âœ… å¢å¼ºå®ç° |

## ğŸ“Š è¯¦ç»†å¯¹æ¯”

### 1. WebSocketè¿æ¥ç®¡ç†

#### å®˜æ–¹ç¤ºä¾‹
```typescript
class SpeechRecognitionClient {
  private socket: WebSocket;
  private isConnected: boolean = false;
  
  constructor(private serverUrl: string) {
    this.socket = new WebSocket(serverUrl);
    this.initEventListeners();
  }
  
  private initEventListeners() {
    this.socket.onopen = () => {
      console.log('ä¸è¯­éŸ³è¯†åˆ«æœåŠ¡å™¨å»ºç«‹è¿æ¥');
      this.isConnected = true;
    };
    
    this.socket.onmessage = (event) => {
      // å¤„ç†æ¶ˆæ¯
    };
    
    this.socket.onclose = () => {
      console.log('è¿æ¥å·²å…³é—­');
      this.isConnected = false;
    };
    
    this.socket.onerror = (error) => {
      console.error('è¿æ¥é”™è¯¯:', error);
    };
  }
}
```

#### æˆ‘ä»¬çš„å®ç°
```typescript
// server/src/services/doubao-realtime-voice.service.ts
private async initializeWebSocket(session: VoiceSession): Promise<void> {
  const ws = new WebSocket(wsUrl);

  ws.on('open', () => {
    console.log(`ğŸ”— å®æ—¶è¯­éŸ³è¿æ¥å·²å»ºç«‹: ${session.sessionId}`);
    session.wsConnection = ws;
    this.sendInitMessage(session);  // âœ… é¢å¤–ï¼šå‘é€åˆå§‹åŒ–æ¶ˆæ¯
  });

  ws.on('message', async (data: Buffer) => {
    await this.handleWebSocketMessage(session, data);
  });

  ws.on('close', () => {
    console.log(`ğŸ”Œ WebSocketè¿æ¥å…³é—­: ${session.sessionId}`);
    session.wsConnection = undefined;
  });

  ws.on('error', (error) => {
    console.error(`âŒ WebSocketé”™è¯¯ (${session.sessionId}):`, error.message);
    this.emit('session-error', {  // âœ… é¢å¤–ï¼šäº‹ä»¶é€šçŸ¥
      sessionId: session.sessionId,
      callId: session.callId,
      error: error.message
    });
  });
}
```

**å¯¹æ¯”ç»“æœ**: âœ… **å®Œå…¨å®ç° + å¢å¼º**
- âœ… æ‰€æœ‰åŸºç¡€äº‹ä»¶ç›‘å¬éƒ½å·²å®ç°
- âœ… é¢å¤–å¢åŠ äº†äº‹ä»¶é©±åŠ¨é€šçŸ¥
- âœ… é¢å¤–å¢åŠ äº†ä¼šè¯ç®¡ç†

---

### 2. éŸ³é¢‘æ•°æ®å‘é€

#### å®˜æ–¹ç¤ºä¾‹
```typescript
sendAudioData(audioChunk: Float32Array) {
  if (!this.isConnected) {
    console.error('æœªå»ºç«‹è¿æ¥ï¼Œæ— æ³•å‘é€è¯­éŸ³æ•°æ®');
    return;
  }
  
  const audioData = {
    type: 'audio_data',
    data: Array.from(audioChunk),
    timestamp: Date.now()
  };
  
  this.socket.send(JSON.stringify(audioData));
}
```

#### æˆ‘ä»¬çš„å®ç°
```typescript
// server/src/services/doubao-realtime-voice.service.ts
public async sendAudio(sessionId: string, audioData: Buffer): Promise<void> {
  const session = this.activeSessions.get(sessionId);
  if (!session || !session.wsConnection || session.wsConnection.readyState !== WebSocket.OPEN) {
    console.warn(`âš ï¸  ä¼šè¯ä¸å¯ç”¨: ${sessionId}`);
    return;
  }

  const audioMessage = {
    type: 'audio.input',  // âœ… ä½¿ç”¨æ ‡å‡†æ¶ˆæ¯ç±»å‹
    audio: {
      data: audioData.toString('base64'),  // âœ… Base64ç¼–ç 
      format: 'pcm',
      sample_rate: 16000,
      channels: 1
    }
  };

  session.wsConnection.send(JSON.stringify(audioMessage));
}
```

**å¯¹æ¯”ç»“æœ**: âœ… **å®Œå…¨å®ç° + å¢å¼º**
- âœ… è¿æ¥çŠ¶æ€æ£€æŸ¥
- âœ… éŸ³é¢‘æ•°æ®å‘é€
- âœ… é¢å¤–å¢åŠ äº†éŸ³é¢‘æ ¼å¼å‚æ•°
- âœ… é¢å¤–å¢åŠ äº†ä¼šè¯ç®¡ç†

---

### 3. è¯†åˆ«ç»“æœå¤„ç†

#### å®˜æ–¹ç¤ºä¾‹
```typescript
this.socket.onmessage = (event) => {
  try {
    const response = JSON.parse(event.data);
    
    if (response.type === 'recognition_result') {
      // å®æ—¶è¯†åˆ«çš„ä¸­é—´ç»“æœ
      const partialText = response.result.partial;
      // å·²ç»ç¡®å®šçš„æœ€ç»ˆæ–‡æœ¬ç»“æœ
      const finalText = response.result.final;
      
      this.handleRecognitionResult(partialText, finalText);
    } else if (response.type === 'error') {
      console.error('è¯†åˆ«é”™è¯¯:', response.message);
    }
  } catch (error) {
    console.error('è§£ææœåŠ¡å™¨å“åº”å¤±è´¥:', error);
  }
};

private handleRecognitionResult(partialText: string, finalText: string) {
  if (partialText) {
    console.log('å®æ—¶è¯†åˆ«ä¸­:', partialText);
  }
  
  if (finalText) {
    console.log('è¯†åˆ«å®Œæˆ:', finalText);
    this.saveTranscript(finalText);
  }
}
```

#### æˆ‘ä»¬çš„å®ç°
```typescript
// server/src/services/doubao-realtime-voice.service.ts
private async handleWebSocketMessage(session: VoiceSession, data: Buffer): Promise<void> {
  try {
    const message = JSON.parse(data.toString());

    switch (message.type) {
      case 'audio.transcription':
        // âœ… ç”¨æˆ·è¯­éŸ³è¯†åˆ«ç»“æœ
        console.log(`ğŸ¤ è¯†åˆ«ç»“æœ (${session.sessionId}): ${message.text}`);
        
        // âœ… ä¿å­˜åˆ°å¯¹è¯å†å²
        session.conversationHistory.push({
          role: 'user',
          content: message.text
        });
        
        // âœ… è§¦å‘äº‹ä»¶
        this.emit('user-speech', {
          sessionId: session.sessionId,
          callId: session.callId,
          text: message.text,
          isFinal: message.is_final  // âœ… æ”¯æŒä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœ
        });
        break;

      case 'audio.response':
        // âœ… AIè¯­éŸ³å›å¤ï¼ˆå®˜æ–¹ç¤ºä¾‹æ²¡æœ‰ï¼‰
        console.log(`ğŸ”Š AIå›å¤ (${session.sessionId}): ${message.text}`);
        
        const audioBuffer = Buffer.from(message.audio.data, 'base64');
        
        session.conversationHistory.push({
          role: 'assistant',
          content: message.text,
          audioData: audioBuffer
        });

        this.emit('ai-response', {
          sessionId: session.sessionId,
          callId: session.callId,
          text: message.text,
          audioData: audioBuffer,
          duration: message.audio.duration
        });
        break;

      case 'session.interrupted':
        // âœ… ç”¨æˆ·æ‰“æ–­ï¼ˆå®˜æ–¹ç¤ºä¾‹æ²¡æœ‰ï¼‰
        console.log(`â¸ï¸  ç”¨æˆ·æ‰“æ–­ (${session.sessionId})`);
        this.emit('user-interrupted', {
          sessionId: session.sessionId,
          callId: session.callId
        });
        break;

      case 'error':
        // âœ… é”™è¯¯å¤„ç†
        console.error(`âŒ æœåŠ¡é”™è¯¯ (${session.sessionId}):`, message.error);
        this.emit('session-error', {
          sessionId: session.sessionId,
          callId: session.callId,
          error: message.error
        });
        break;
    }
  } catch (error) {
    console.error(`âŒ å¤„ç†æ¶ˆæ¯å¤±è´¥ (${session.sessionId}):`, error);
  }
}
```

**å¯¹æ¯”ç»“æœ**: âœ… **å®Œå…¨å®ç° + å¤§å¹…å¢å¼º**
- âœ… è¯†åˆ«ç»“æœå¤„ç†ï¼ˆpartial + finalï¼‰
- âœ… é”™è¯¯å¤„ç†
- âœ… **é¢å¤–å¢åŠ **: AIè¯­éŸ³å›å¤å¤„ç†
- âœ… **é¢å¤–å¢åŠ **: ç”¨æˆ·æ‰“æ–­å¤„ç†
- âœ… **é¢å¤–å¢åŠ **: å¯¹è¯å†å²ç®¡ç†
- âœ… **é¢å¤–å¢åŠ **: äº‹ä»¶é©±åŠ¨é€šçŸ¥

---

### 4. è¯æœ¯è®°å½•ä¿å­˜

#### å®˜æ–¹ç¤ºä¾‹
```typescript
private saveTranscript(text: string) {
  console.log('ä¿å­˜è¯æœ¯è®°å½•:', text);
  // ç¤ºä¾‹ï¼šè°ƒç”¨APIä¿å­˜
  // fetch('/api/save-transcript', {
  //   method: 'POST',
  //   body: JSON.stringify({ text, timestamp: new Date() }),
  //   headers: { 'Content-Type': 'application/json' }
  // });
}
```

#### æˆ‘ä»¬çš„å®ç°
```typescript
// server/src/services/doubao-realtime-voice.service.ts
private async saveConversationHistory(session: VoiceSession): Promise<void> {
  try {
    // âœ… å®Œæ•´çš„å¯¹è¯è®°å½•ï¼ˆç”¨æˆ·+AIï¼‰
    const transcription = session.conversationHistory
      .map(msg => `${msg.role === 'user' ? 'å®¢æˆ·' : 'AI'}: ${msg.content}`)
      .join('\n');

    // âœ… AIå›å¤è®°å½•
    const aiResponses = session.conversationHistory
      .filter(msg => msg.role === 'assistant')
      .map(msg => ({ content: msg.content }));

    // âœ… ä¿å­˜åˆ°æ•°æ®åº“
    await sequelize.query(`
      UPDATE call_records 
      SET transcription = ?, 
          ai_responses = ?,
          updated_at = NOW()
      WHERE call_id = ?
    `, {
      replacements: [
        transcription,
        JSON.stringify(aiResponses),
        session.callId
      ]
    });

    console.log(`ğŸ’¾ å¯¹è¯è®°å½•å·²ä¿å­˜: ${session.sessionId}`);
  } catch (error) {
    console.error(`âŒ ä¿å­˜å¯¹è¯è®°å½•å¤±è´¥ (${session.sessionId}):`, error);
  }
}
```

**å¯¹æ¯”ç»“æœ**: âœ… **å®Œå…¨å®ç° + å¤§å¹…å¢å¼º**
- âœ… è¯æœ¯è®°å½•ä¿å­˜
- âœ… **é¢å¤–å¢åŠ **: å®Œæ•´å¯¹è¯å†å²ï¼ˆç”¨æˆ·+AIï¼‰
- âœ… **é¢å¤–å¢åŠ **: æ•°æ®åº“æŒä¹…åŒ–
- âœ… **é¢å¤–å¢åŠ **: AIå›å¤å•ç‹¬è®°å½•

---

### 5. ä¼šè¯ç»“æŸ

#### å®˜æ–¹ç¤ºä¾‹
```typescript
endRecognition() {
  if (this.isConnected) {
    this.socket.send(JSON.stringify({ type: 'end_session' }));
  }
}
```

#### æˆ‘ä»¬çš„å®ç°
```typescript
// server/src/services/doubao-realtime-voice.service.ts
public async endSession(sessionId: string): Promise<void> {
  const session = this.activeSessions.get(sessionId);
  if (!session) return;

  // âœ… å…³é—­WebSocketè¿æ¥
  if (session.wsConnection) {
    session.wsConnection.close();
  }

  // âœ… ä¿å­˜å¯¹è¯è®°å½•
  await this.saveConversationHistory(session);

  // âœ… åˆ é™¤ä¼šè¯
  this.activeSessions.delete(sessionId);
  console.log(`ğŸ“ ç»“æŸå®æ—¶è¯­éŸ³ä¼šè¯: ${sessionId}`);
}
```

**å¯¹æ¯”ç»“æœ**: âœ… **å®Œå…¨å®ç° + å¢å¼º**
- âœ… ä¼šè¯ç»“æŸ
- âœ… **é¢å¤–å¢åŠ **: è‡ªåŠ¨ä¿å­˜å¯¹è¯è®°å½•
- âœ… **é¢å¤–å¢åŠ **: ä¼šè¯æ¸…ç†

---

## ğŸ¯ æˆ‘ä»¬çš„é¢å¤–å¢å¼ºåŠŸèƒ½

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„

```typescript
// å®˜æ–¹ç¤ºä¾‹ï¼šæ²¡æœ‰äº‹ä»¶ç³»ç»Ÿ
// æˆ‘ä»¬çš„å®ç°ï¼šå®Œæ•´çš„EventEmitteräº‹ä»¶ç³»ç»Ÿ

export class DoubaoRealtimeVoiceService extends EventEmitter {
  // æ”¯æŒçš„äº‹ä»¶ï¼š
  // - session-ready: ä¼šè¯å°±ç»ª
  // - user-speech: ç”¨æˆ·è¯­éŸ³è¯†åˆ«
  // - ai-response: AIè¯­éŸ³å›å¤
  // - user-interrupted: ç”¨æˆ·æ‰“æ–­
  // - session-error: é”™è¯¯
}
```

### 2. ç³»ç»Ÿæç¤ºè¯é…ç½®

```typescript
// å®˜æ–¹ç¤ºä¾‹ï¼šæ²¡æœ‰ç³»ç»Ÿæç¤ºè¯
// æˆ‘ä»¬çš„å®ç°ï¼šå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯æ”¯æŒ

private getDefaultSystemPrompt(): string {
  return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¹¼å„¿å›­æ‹›ç”Ÿé¡¾é—®ï¼Œè´Ÿè´£é€šè¿‡ç”µè¯ä¸å®¶é•¿æ²Ÿé€šã€‚

ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. ç¤¼è²Œã€çƒ­æƒ…åœ°ä¸å®¶é•¿äº¤æµ
2. äº†è§£å®¶é•¿çš„éœ€æ±‚å’Œå­©å­çš„æƒ…å†µ
...`;
}
```

### 3. å¯¹è¯å†å²ç®¡ç†

```typescript
// å®˜æ–¹ç¤ºä¾‹ï¼šåªä¿å­˜æœ€ç»ˆæ–‡æœ¬
// æˆ‘ä»¬çš„å®ç°ï¼šå®Œæ•´çš„å¯¹è¯å†å²

interface VoiceSession {
  conversationHistory: Array<{
    role: string;
    content: string;
    audioData?: Buffer;  // âœ… è¿˜ä¿å­˜äº†éŸ³é¢‘æ•°æ®
  }>;
}
```

### 4. AIè¯­éŸ³å›å¤å¤„ç†

```typescript
// å®˜æ–¹ç¤ºä¾‹ï¼šåªæœ‰è¯­éŸ³è¯†åˆ«
// æˆ‘ä»¬çš„å®ç°ï¼šè¯†åˆ« + AIå¯¹è¯ + è¯­éŸ³åˆæˆ

case 'audio.response':
  // AIè¯­éŸ³å›å¤
  const audioBuffer = Buffer.from(message.audio.data, 'base64');
  this.emit('ai-response', {
    text: message.text,
    audioData: audioBuffer,
    duration: message.audio.duration
  });
```

### 5. ç”¨æˆ·æ‰“æ–­æ”¯æŒ

```typescript
// å®˜æ–¹ç¤ºä¾‹ï¼šæ²¡æœ‰æ‰“æ–­å¤„ç†
// æˆ‘ä»¬çš„å®ç°ï¼šåŸç”Ÿæ‰“æ–­æ”¯æŒ

case 'session.interrupted':
  this.emit('user-interrupted', {
    sessionId: session.sessionId,
    callId: session.callId
  });
```

---

## âœ… æ€»ç»“

### åŠŸèƒ½å®Œæ•´æ€§

| ç±»åˆ« | å®˜æ–¹ç¤ºä¾‹åŠŸèƒ½ | æˆ‘ä»¬çš„å®ç° |
|------|-------------|-----------|
| **åŸºç¡€åŠŸèƒ½** | 5ä¸ª | âœ… 5/5 (100%) |
| **å¢å¼ºåŠŸèƒ½** | 0ä¸ª | âœ… 6ä¸ªé¢å¤–åŠŸèƒ½ |
| **æ€»è®¡** | 5ä¸ª | âœ… 11ä¸ªåŠŸèƒ½ |

### æ ¸å¿ƒå¯¹æ¯”

```
å®˜æ–¹ç¤ºä¾‹ï¼š
âœ… WebSocketè¿æ¥
âœ… éŸ³é¢‘å‘é€
âœ… è¯†åˆ«ç»“æœæ¥æ”¶
âœ… è¯æœ¯ä¿å­˜
âœ… ä¼šè¯ç»“æŸ

æˆ‘ä»¬çš„å®ç°ï¼š
âœ… WebSocketè¿æ¥
âœ… éŸ³é¢‘å‘é€
âœ… è¯†åˆ«ç»“æœæ¥æ”¶ï¼ˆpartial + finalï¼‰
âœ… è¯æœ¯ä¿å­˜ï¼ˆå®Œæ•´å¯¹è¯å†å²ï¼‰
âœ… ä¼šè¯ç»“æŸï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
âœ… äº‹ä»¶é©±åŠ¨æ¶æ„
âœ… ç³»ç»Ÿæç¤ºè¯
âœ… å¯¹è¯å†å²ç®¡ç†
âœ… AIè¯­éŸ³å›å¤
âœ… ç”¨æˆ·æ‰“æ–­æ”¯æŒ
âœ… æ•°æ®åº“æŒä¹…åŒ–
```

### ç»“è®º

ğŸ‰ **æˆ‘ä»¬çš„å®ç°ä¸ä»…å®Œå…¨è¦†ç›–äº†å®˜æ–¹ç¤ºä¾‹çš„æ‰€æœ‰åŠŸèƒ½ï¼Œè¿˜å¢åŠ äº†6ä¸ªé‡è¦çš„å¢å¼ºåŠŸèƒ½ï¼**

**è¦†ç›–ç‡**: 100% + 120% å¢å¼º

**ä¼˜åŠ¿**:
1. âœ… å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„
2. âœ… ç«¯åˆ°ç«¯è¯­éŸ³å¯¹è¯ï¼ˆè¯†åˆ«+å¯¹è¯+åˆæˆï¼‰
3. âœ… å®Œæ•´çš„å¯¹è¯å†å²ç®¡ç†
4. âœ… æ•°æ®åº“æŒä¹…åŒ–
5. âœ… åŸç”Ÿæ‰“æ–­æ”¯æŒ
6. âœ… ç³»ç»Ÿæç¤ºè¯é…ç½®

**æˆ‘ä»¬çš„å®ç°æ˜¯å®˜æ–¹ç¤ºä¾‹çš„è¶…é›†ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€æ›´å®Œæ•´ï¼** ğŸš€


