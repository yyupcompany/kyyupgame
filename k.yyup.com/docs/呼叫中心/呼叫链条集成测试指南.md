# 呼叫链条集成测试指南

## 📋 测试目标

验证完整的呼叫链条是否成功连接：

```
SIP配置 → 音频流 → 豆包实时语音 → AI对话 → 语音回复
```

## 🔧 测试账号

**SIP账号**: sales001  
**密码**: zhuge3944  
**服务器**: 47.94.82.59:5060  
**协议**: UDP

## 🚀 测试步骤

### 步骤1: 插入sales001 SIP配置

```bash
cd server
node scripts/insert-sales001-sip-config.js
```

**预期输出**:
```
🔌 正在连接数据库...
✅ 数据库连接成功

📋 检查sip_configs表是否存在...
✅ sip_configs表存在

🗑️  删除已存在的sales001配置...
✅ 已删除旧配置

📝 插入sales001 SIP配置...
✅ sales001 SIP配置插入成功

🔍 验证插入的配置...
✅ 配置验证成功:
   ID: 1
   服务器: 47.94.82.59:5060
   用户名: sales001
   协议: UDP
   状态: 启用
   注册间隔: 3600秒

🎉 sales001 SIP配置插入完成！
```

### 步骤2: 编译TypeScript代码

```bash
cd server
npm run build
```

### 步骤3: 运行集成测试

```bash
cd server
node tests/call-chain-integration-test.js
```

## 📊 测试流程

### 测试1: SIP配置加载

**目标**: 验证SIP配置能否正确加载

**测试内容**:
- ✅ 从数据库加载SIP配置
- ✅ 验证配置字段完整性
- ✅ 确认使用sales001账号

**预期输出**:
```
========================================
测试1: SIP配置加载
========================================

✅ SIP配置加载成功:
   服务器: 47.94.82.59:5060
   用户名: sales001
   协议: UDP
✅ 确认使用 sales001 账号
```

### 测试2: 创建通话会话

**目标**: 验证能否创建豆包实时语音会话

**测试内容**:
- ✅ 创建通话会话
- ✅ 设置系统提示词
- ✅ 初始化事件监听
- ✅ 等待会话就绪

**预期输出**:
```
========================================
测试2: 创建通话会话
========================================

📞 创建通话会话: test_call_1705234567890
   客户ID: 1001
   电话号码: 13800138000
📡 设置事件监听...

✅ 通话会话创建成功

✅ 事件: 通话就绪
   Call ID: test_call_1705234567890
```

### 测试3: 发送音频数据

**目标**: 验证音频数据能否正确发送和处理

**测试内容**:
- ✅ 生成模拟PCM音频数据
- ✅ 分批发送音频流
- ✅ 触发语音识别
- ✅ 接收AI回复

**预期输出**:
```
========================================
测试3: 发送音频数据
========================================

🎤 模拟发送音频数据...
   音频格式: PCM 16kHz 16bit Mono
   音频大小: 32000 bytes
   音频时长: 1秒
   发送音频块 1/5 (6400 bytes)
   发送音频块 2/5 (6400 bytes)
   发送音频块 3/5 (6400 bytes)
   发送音频块 4/5 (6400 bytes)
   发送音频块 5/5 (6400 bytes)
✅ 音频数据发送完成

⏳ 等待AI处理和回复...

🎤 事件: 用户语音
   文本: 你好，我想了解一下你们幼儿园
   是否最终: true

🤖 事件: AI回复
   文本: 您好！我是XX幼儿园的招生顾问，很高兴为您服务。请问您的孩子多大了？
   音频大小: 48000 bytes
   时长: 3秒
```

### 测试4: 结束通话

**目标**: 验证通话能否正常结束

**测试内容**:
- ✅ 结束通话会话
- ✅ 保存对话记录
- ✅ 清理资源

**预期输出**:
```
========================================
测试4: 结束通话
========================================

📞 结束通话...
✅ 通话结束成功

📞 事件: 通话结束
   Call ID: test_call_1705234567890
   时长: 10秒
```

## 📈 测试报告

### 完整测试报告示例

```
========================================
测试报告
========================================

测试结果:
  ✅ SIP配置加载
  ✅ 通话会话创建
  ✅ 音频数据发送
  ✅ 用户语音识别
  ✅ AI语音回复
  ✅ 通话结束

通过率: 6/6 (100.0%)

链条状态:
  SIP配置 → 音频流 → 豆包实时语音 → AI对话 → 语音回复
  ✅        ✅      ✅            ✅      ✅

🎉 测试全部通过！
```

## 🔍 测试验证点

### 1. SIP配置验证

- [ ] SIP配置成功从数据库加载
- [ ] 配置使用sales001账号
- [ ] 服务器地址正确 (47.94.82.59:5060)
- [ ] 协议正确 (UDP)

### 2. 通话会话验证

- [ ] 通话会话成功创建
- [ ] 会话ID生成正确
- [ ] 系统提示词设置成功
- [ ] 事件监听器正常工作

### 3. 音频流验证

- [ ] 音频数据格式正确 (PCM 16kHz 16bit Mono)
- [ ] 音频数据成功发送
- [ ] 音频流分批发送正常
- [ ] 无音频传输错误

### 4. 语音识别验证

- [ ] 用户语音识别事件触发
- [ ] 识别文本返回
- [ ] 中间结果和最终结果区分
- [ ] 识别准确度可接受

### 5. AI回复验证

- [ ] AI回复事件触发
- [ ] 回复文本生成
- [ ] 回复音频生成
- [ ] 音频格式正确

### 6. 通话结束验证

- [ ] 通话正常结束
- [ ] 对话记录保存
- [ ] 资源正确清理
- [ ] 无内存泄漏

## ⚠️ 注意事项

### 当前限制

1. **模拟音频**: 测试使用模拟的正弦波音频，不是真实语音
2. **WebSocket连接**: 需要确认豆包实时语音API的实际URL和协议
3. **API密钥**: 使用的是火山引擎ASR的AppID和API Key
4. **SIP连接**: 当前只加载配置，未实际连接到SIP服务器

### 可能的问题

#### 问题1: WebSocket连接失败

**原因**: 豆包实时语音API的URL可能不正确

**解决方案**:
1. 确认官方API文档中的WebSocket URL
2. 更新 `doubao-realtime-voice.service.ts` 中的 `wsUrl`
3. 验证AppID和API Key是否正确

#### 问题2: 没有AI回复

**原因**: 
- 模拟音频无法被识别
- API配置不正确
- WebSocket消息格式不匹配

**解决方案**:
1. 使用真实的音频文件测试
2. 检查WebSocket消息格式
3. 查看服务器日志

#### 问题3: SIP配置未加载

**原因**: 数据库中没有sales001配置

**解决方案**:
```bash
node scripts/insert-sales001-sip-config.js
```

## 🎯 成功标准

### 最低标准（当前可达到）

- ✅ SIP配置加载成功
- ✅ 通话会话创建成功
- ✅ 音频数据发送成功
- ✅ 事件监听正常工作
- ✅ 通话结束成功

### 理想标准（需要真实API）

- ✅ 最低标准全部达到
- ✅ 用户语音识别成功
- ✅ AI回复生成成功
- ✅ 音频质量良好
- ✅ 延迟在500ms以内

## 📝 测试日志

### 日志位置

测试过程中的所有日志会输出到控制台。

### 关键日志

**成功日志**:
```
✅ SIP配置加载成功
✅ 通话会话创建成功
✅ 音频数据发送完成
🎤 事件: 用户语音
🤖 事件: AI回复
✅ 通话结束成功
```

**错误日志**:
```
❌ SIP配置加载失败
❌ 创建通话会话失败
❌ 发送音频数据失败
❌ 事件: 通话错误
```

## 🔧 故障排查

### 1. 编译错误

```bash
cd server
npm run build
```

### 2. 数据库连接错误

检查 `.env` 文件:
```env
DB_HOST=dbconn.sealoshzh.site
DB_PORT=43906
DB_USER=root
DB_PASSWORD=Yyup@2024
DB_NAME=kindergarten_management
```

### 3. 模块未找到

```bash
cd server
npm install
npm run build
```

## 📚 相关文档

- [豆包实时语音大模型集成方案](./豆包实时语音大模型集成方案.md)
- [豆包实时语音集成总结](./豆包实时语音集成总结.md)
- [SIP配置启动加载实现总结](./SIP配置启动加载实现总结.md)

## ✅ 总结

这个集成测试验证了完整的呼叫链条：

1. ✅ **SIP配置** - 使用sales001账号
2. ✅ **音频流** - PCM格式音频传输
3. ✅ **豆包实时语音** - WebSocket连接和消息处理
4. ✅ **AI对话** - 系统提示词和对话管理
5. ✅ **语音回复** - 音频生成和返回

**当前状态**: 框架完整，等待真实API验证

---

**文档版本**: v1.0  
**创建时间**: 2025-01-14  
**测试账号**: sales001 / zhuge3944

