# 活动报名自动加入客户池 - 测试指南

## 📋 功能概述

本功能实现了活动报名自动加入客户池的完整流程：
1. ✅ 园长/老师生成带有分享者ID的活动链接
2. ✅ 家长通过分享链接报名活动
3. ✅ 系统自动将家长信息加入客户池
4. ✅ 自动分配给分享链接的老师
5. ✅ 老师在"客户跟踪"页面管理客户

---

## 🚀 已完成的开发工作

### 1. 数据库字段 ✅
- ✅ `activity_registrations` 表添加5个字段
- ✅ `teacher_customers` 表添加4个字段
- ✅ 添加4个索引

### 2. 后端代码 ✅
- ✅ `ActivityRegistration` 模型更新
- ✅ `ActivityRegistrationService` 添加自动加入客户池逻辑
- ✅ 后端编译成功

### 3. 前端代码 ✅
- ✅ 移动端报名页面获取分享参数
- ✅ 分享链接生成工具函数
- ✅ 分享链接对话框组件
- ✅ 安装 qrcode 库

---

## 🧪 测试步骤

### 步骤1: 启动服务

```bash
# 启动前后端服务
npm run start:all

# 或分别启动
npm run start:frontend  # 前端 (5173端口)
npm run start:backend   # 后端 (3000端口)
```

---

### 步骤2: 生成分享链接

#### 方式1: 使用分享链接对话框组件（推荐）

在活动详情页面添加"生成分享链接"按钮：

```vue
<template>
  <div class="activity-detail">
    <!-- 活动信息 -->
    <div class="activity-info">
      <h1>{{ activity.title }}</h1>
      <p>{{ activity.description }}</p>
      
      <!-- 分享按钮 -->
      <el-button 
        type="primary" 
        @click="showShareDialog = true"
      >
        生成分享链接
      </el-button>
    </div>
    
    <!-- 分享链接对话框 -->
    <ShareLinkDialog
      v-model="showShareDialog"
      :activity-id="activity.id"
    />
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import ShareLinkDialog from '@/components/activity/ShareLinkDialog.vue'

const showShareDialog = ref(false)
const activity = ref({
  id: 123,
  title: '春季招生开放日',
  description: '欢迎家长和孩子参加'
})
</script>
```

#### 方式2: 手动生成链接

```typescript
import { generateActivityShareLink } from '@/utils/share-link'
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()
const userId = userStore.user?.id

// 生成老师分享链接
const teacherLink = generateActivityShareLink(123, userId, 'teacher')
console.log('老师分享链接:', teacherLink)
// 输出: http://localhost:5173/mobile/activity/123?shareBy=456&shareType=teacher

// 生成园长分享链接
const principalLink = generateActivityShareLink(123, userId, 'principal')
console.log('园长分享链接:', principalLink)
// 输出: http://localhost:5173/mobile/activity/123?shareBy=456&shareType=principal

// 生成二维码链接
const qrcodeLink = generateActivityShareLink(123, userId, 'qrcode')
console.log('二维码链接:', qrcodeLink)
// 输出: http://localhost:5173/mobile/activity/123?shareBy=456&shareType=qrcode
```

---

### 步骤3: 家长通过分享链接报名

1. **复制分享链接**
   ```
   http://localhost:5173/mobile/activity/123?shareBy=456&shareType=teacher
   ```

2. **在浏览器中打开链接**
   - 打开新的浏览器窗口或隐身模式
   - 粘贴链接并访问

3. **填写报名表单**
   - 姓名：张三
   - 手机号：13800138000
   - 孩子姓名：张小宝
   - 孩子年龄：4岁
   - 备注：（可选）

4. **提交报名**
   - 点击"确认报名"按钮
   - 等待提交成功提示

---

### 步骤4: 验证自动加入客户池

#### 4.1 检查数据库

```sql
-- 1. 检查报名记录
SELECT 
  id, contact_name, contact_phone, 
  share_by, share_type, source_type, 
  source_detail, auto_assigned
FROM activity_registrations
WHERE contact_phone = '13800138000'
ORDER BY created_at DESC
LIMIT 1;

-- 预期结果:
-- share_by: 456 (分享者ID)
-- share_type: 'teacher'
-- source_type: 'ACTIVITY_ONLINE'
-- auto_assigned: 1 (true)

-- 2. 检查客户池记录
SELECT 
  id, teacher_id, customer_name, phone,
  source, source_type, source_id,
  source_detail, auto_assigned
FROM teacher_customers
WHERE phone = '13800138000'
ORDER BY created_at DESC
LIMIT 1;

-- 预期结果:
-- teacher_id: 456 (自动分配给分享者)
-- source_type: 'ACTIVITY_ONLINE'
-- source_id: (报名记录ID)
-- auto_assigned: 1 (true)
```

#### 4.2 检查后端日志

查看后端控制台输出：

```
✅ 创建新客户记录 - 客户ID: 1001, 分配给老师ID: 456
```

或者如果客户已存在：

```
✅ 客户已存在，添加跟进记录 - 客户ID: 1001
```

---

### 步骤5: 老师查看客户

1. **登录老师账号**
   - 使用老师ID 456 的账号登录
   - 或者使用分享链接的老师账号

2. **进入客户跟踪页面**
   ```
   http://localhost:5173/teacher-center/customer-tracking
   ```

3. **查看客户列表**
   - 应该能看到新客户"张三"
   - 来源显示："线上活动"或"ACTIVITY_ONLINE"
   - 自动分配标记：是

4. **查看客户详情**
   - 点击客户查看详情
   - 来源详情应该包含：
     - 活动ID
     - 活动标题
     - 报名时间
     - 分享者信息

---

## 📊 测试用例

### 用例1: 老师分享链接报名

**前置条件**：
- 老师ID: 456
- 活动ID: 123

**测试步骤**：
1. 老师生成分享链接（shareType=teacher）
2. 家长通过链接报名
3. 验证报名记录的 share_by=456, share_type='teacher'
4. 验证客户池记录的 teacher_id=456, auto_assigned=true

**预期结果**：
- ✅ 报名成功
- ✅ 客户自动加入客户池
- ✅ 自动分配给老师456

---

### 用例2: 园长分享链接报名

**前置条件**：
- 园长ID: 789
- 活动ID: 123

**测试步骤**：
1. 园长生成分享链接（shareType=principal）
2. 家长通过链接报名
3. 验证报名记录的 share_by=789, share_type='principal'
4. 验证客户池记录的 teacher_id=789, auto_assigned=true

**预期结果**：
- ✅ 报名成功
- ✅ 客户自动加入客户池
- ✅ 自动分配给园长789

---

### 用例3: 重复报名（客户已存在）

**前置条件**：
- 客户"张三"已在客户池中
- 手机号: 13800138000

**测试步骤**：
1. 使用相同手机号再次报名
2. 验证不会创建重复客户记录
3. 验证添加了新的跟进记录

**预期结果**：
- ✅ 报名成功
- ✅ 不创建重复客户
- ✅ 添加跟进记录

---

### 用例4: 无分享参数的直接报名

**前置条件**：
- 直接访问活动页面（无 shareBy 参数）

**测试步骤**：
1. 直接访问 `http://localhost:5173/mobile/activity/123`
2. 填写报名表单并提交
3. 验证报名记录的 share_by=null, auto_assigned=false

**预期结果**：
- ✅ 报名成功
- ✅ 客户加入客户池（但不自动分配）
- ✅ 需要园长手动分配

---

## 🔍 调试技巧

### 1. 查看分享参数

在浏览器控制台查看：

```javascript
// 在移动端活动详情页面
console.log('分享者ID:', shareBy.value)
console.log('分享类型:', shareType.value)
```

### 2. 查看报名提交数据

在浏览器控制台查看网络请求：

```
POST /api/activity-plans/123/register
Request Payload:
{
  "name": "张三",
  "phone": "13800138000",
  "notes": "",
  "shareBy": 456,
  "shareType": "teacher"
}
```

### 3. 查看后端日志

```bash
# 查看后端日志
cd server && npm run dev

# 应该看到:
✅ 创建新客户记录 - 客户ID: 1001, 分配给老师ID: 456
```

---

## ✅ 验证清单

- [ ] 数据库字段添加成功
- [ ] 后端编译成功
- [ ] 前端编译成功
- [ ] 分享链接生成成功
- [ ] 分享链接包含正确的参数
- [ ] 报名页面获取分享参数
- [ ] 报名提交包含分享参数
- [ ] 报名记录保存分享信息
- [ ] 客户自动加入客户池
- [ ] 客户自动分配给分享者
- [ ] 老师能看到自动分配的客户
- [ ] 来源信息显示正确
- [ ] 重复报名不创建重复客户

---

## 🐛 常见问题

### 问题1: 分享参数没有传递

**症状**：报名后 share_by 为 null

**解决方案**：
1. 检查URL是否包含 shareBy 参数
2. 检查前端是否正确获取 route.query.shareBy
3. 检查报名提交时是否包含 shareBy 字段

### 问题2: 客户没有自动加入客户池

**症状**：报名成功但客户池没有记录

**解决方案**：
1. 检查后端日志是否有错误
2. 检查 teacher_customers 表是否存在
3. 检查数据库字段是否添加成功

### 问题3: 客户没有自动分配给老师

**症状**：客户池有记录但 teacher_id 为 null

**解决方案**：
1. 检查 share_by 参数是否正确传递
2. 检查后端逻辑中的 assignedTeacherId 赋值
3. 检查数据库插入语句

---

## 📚 相关文档

1. `docs/活动报名自动加入客户池方案.md` - 完整方案设计
2. `docs/活动报名自动加入客户池-实现总结.md` - 实现总结
3. `docs/活动中心数据库关系分析.md` - 数据库关系分析

---

**文档版本**：v1.0  
**最后更新**：2025-10-05  
**维护人员**：AI Assistant

