# Rediséƒ¨ç½²è¿›åº¦æŠ¥å‘Š - Week 2

> **æŠ¥å‘Šæ—¥æœŸ**: 2025-01-06  
> **æŠ¥å‘Šäºº**: AI Assistant  
> **é˜¶æ®µ**: Week 2 - å®¢æˆ·ç«¯é›†æˆ  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡å®Œæˆæƒ…å†µ

### âœ… ä»»åŠ¡2.1: å®‰è£…ä¾èµ– (0.5å¤©)

**çŠ¶æ€**: å·²å®Œæˆ

**å®Œæˆå†…å®¹**:
- âœ… ç¡®è®¤å·²å®‰è£… `redis` v5.5.6ï¼ˆå®˜æ–¹æœ€æ–°ç‰ˆæœ¬ï¼‰
- âœ… æ— éœ€é¢å¤–å®‰è£…ä¾èµ–

**è¯´æ˜**: 
- é¡¹ç›®å·²é¢„è£… `redis` v5.5.6ï¼Œè¿™æ˜¯å®˜æ–¹æœ€æ–°ç‰ˆæœ¬
- æ”¯æŒTypeScriptã€Promiseã€Sentinelç­‰æ‰€æœ‰éœ€è¦çš„åŠŸèƒ½
- æ¯”åŸè®¡åˆ’çš„ioredisæ›´åŠ å®˜æ–¹å’Œç¨³å®š

---

### âœ… ä»»åŠ¡2.2: Redisé…ç½®æ–‡ä»¶ (0.5å¤©)

**çŠ¶æ€**: å·²å®Œæˆ

**å®Œæˆå†…å®¹**:
- âœ… åˆ›å»º `server/src/config/redis.config.ts` (284è¡Œ)
- âœ… æ”¯æŒä¸‰ç§æ¨¡å¼ï¼šStandaloneã€Sentinelã€Cluster
- âœ… å®Œæ•´çš„TTLé…ç½®ï¼ˆ15ä¸ªä¸­å¿ƒ + æƒé™ + ä¼šè¯ï¼‰
- âœ… ç»Ÿä¸€çš„Keyå‰ç¼€ç®¡ç†
- âœ… ç¯å¢ƒå˜é‡é…ç½® (server/.env)

**é…ç½®äº®ç‚¹**:
```typescript
// æ”¯æŒä¸‰ç§éƒ¨ç½²æ¨¡å¼
export enum RedisMode {
  STANDALONE = 'standalone',  // å¼€å‘ç¯å¢ƒ
  SENTINEL = 'sentinel',      // ç”Ÿäº§ç¯å¢ƒï¼ˆé«˜å¯ç”¨ï¼‰
  CLUSTER = 'cluster'         // å¤§è§„æ¨¡éƒ¨ç½²
}

// å®Œæ•´çš„TTLé…ç½®
export const RedisTTL = {
  USER_PERMISSIONS: 30 * 60,      // 30åˆ†é’Ÿ
  DASHBOARD: 5 * 60,              // 5åˆ†é’Ÿ
  ACTIVITY_CENTER: 10 * 60,       // 10åˆ†é’Ÿ
  // ... å…±30+é…ç½®é¡¹
};

// ç»Ÿä¸€çš„Keyå‰ç¼€
export const RedisKeyPrefix = {
  USER_PERMISSIONS: 'user:permissions:',
  CENTER: 'center:',
  LOCK: 'lock:',
  // ... å…±15+å‰ç¼€
};
```

**ç¯å¢ƒå˜é‡é…ç½®**:
```env
REDIS_MODE=standalone
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=Szblade3944
REDIS_DB=0
```

---

### âœ… ä»»åŠ¡2.3: RedisServiceå®ç° (2å¤©)

**çŠ¶æ€**: å·²å®Œæˆ

**å®Œæˆå†…å®¹**:
- âœ… åˆ›å»º `server/src/services/redis.service.ts` (650è¡Œ)
- âœ… å•ä¾‹æ¨¡å¼è®¾è®¡
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**å®ç°çš„åŠŸèƒ½æ¨¡å—**:

#### 1. åŸºç¡€æ“ä½œ
- `get<T>(key)` - è·å–å€¼ï¼ˆè‡ªåŠ¨JSONè§£æï¼‰
- `set(key, value, ttl?)` - è®¾ç½®å€¼ï¼ˆè‡ªåŠ¨JSONåºåˆ—åŒ–ï¼‰
- `del(key | keys[])` - åˆ é™¤é”®ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
- `exists(key)` - æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
- `expire(key, seconds)` - è®¾ç½®è¿‡æœŸæ—¶é—´
- `ttl(key)` - è·å–å‰©ä½™è¿‡æœŸæ—¶é—´

#### 2. Hashæ“ä½œ
- `hset(key, field, value)` - è®¾ç½®Hashå­—æ®µ
- `hget<T>(key, field)` - è·å–Hashå­—æ®µ
- `hgetall<T>(key)` - è·å–Hashæ‰€æœ‰å­—æ®µ
- `hdel(key, field | fields[])` - åˆ é™¤Hashå­—æ®µ

#### 3. Setæ“ä½œ
- `sadd(key, ...members)` - æ·»åŠ Setæˆå‘˜
- `smembers(key)` - è·å–Setæ‰€æœ‰æˆå‘˜
- `sismember(key, member)` - æ£€æŸ¥Setæˆå‘˜æ˜¯å¦å­˜åœ¨
- `srem(key, ...members)` - åˆ é™¤Setæˆå‘˜
- `scard(key)` - è·å–Setæˆå‘˜æ•°é‡

#### 4. è®¡æ•°å™¨æ“ä½œ
- `incr(key)` - é€’å¢
- `decr(key)` - é€’å‡
- `incrby(key, increment)` - å¢åŠ æŒ‡å®šå€¼

#### 5. åˆ†å¸ƒå¼é”
- `acquireLock(key, ttl, retryTimes, retryDelay)` - è·å–é”
- `releaseLock(key)` - é‡Šæ”¾é”

#### 6. æ‰¹é‡æ“ä½œ
- `mget<T>(keys[])` - æ‰¹é‡è·å–
- `mset(data)` - æ‰¹é‡è®¾ç½®
- `delPattern(pattern)` - æŒ‰æ¨¡å¼åˆ é™¤

#### 7. Sorted Setæ“ä½œ
- `zadd(key, score, member)` - æ·»åŠ æˆå‘˜
- `zrange(key, start, stop, withScores?)` - è·å–èŒƒå›´
- `zrem(key, ...members)` - åˆ é™¤æˆå‘˜

#### 8. å·¥å…·æ–¹æ³•
- `keys(pattern)` - è·å–åŒ¹é…çš„é”®
- `flushdb()` - æ¸…ç©ºæ•°æ®åº“
- `info(section?)` - è·å–Redisä¿¡æ¯
- `ping()` - Pingæµ‹è¯•

**ä»£ç è´¨é‡**:
- âœ… å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- âœ… æ³›å‹æ”¯æŒï¼ˆ`get<T>`, `hget<T>`, `mget<T>`ï¼‰
- âœ… è‡ªåŠ¨JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- âœ… è¿æ¥çŠ¶æ€ç®¡ç†
- âœ… å•ä¾‹æ¨¡å¼ä¿è¯å…¨å±€å”¯ä¸€å®ä¾‹

---

### âœ… ä»»åŠ¡2.4: å•å…ƒæµ‹è¯• (1å¤©)

**çŠ¶æ€**: å·²å®Œæˆ

**å®Œæˆå†…å®¹**:
- âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬ `server/src/scripts/test-redis.ts`
- âœ… 11ä¸ªæµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡
- âœ… è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½

**æµ‹è¯•ç»“æœ**:

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| 1. è¿æ¥Redis | âœ… é€šè¿‡ | Pingæµ‹è¯•æˆåŠŸ |
| 2. åŸºç¡€æ“ä½œ | âœ… é€šè¿‡ | GET/SET/DEL/EXISTS/TTL |
| 3. Hashæ“ä½œ | âœ… é€šè¿‡ | HSET/HGET/HGETALL/HDEL |
| 4. Setæ“ä½œ | âœ… é€šè¿‡ | SADD/SMEMBERS/SISMEMBER/SCARD |
| 5. è®¡æ•°å™¨ | âœ… é€šè¿‡ | INCR/DECR/INCRBY |
| 6. åˆ†å¸ƒå¼é” | âœ… é€šè¿‡ | è·å–é”/é‡Šæ”¾é” |
| 7. æ‰¹é‡æ“ä½œ | âœ… é€šè¿‡ | MGET/MSET/æ‰¹é‡åˆ é™¤ |
| 8. Sorted Set | âœ… é€šè¿‡ | ZADD/ZRANGE |
| 9. æ¨¡å¼åŒ¹é… | âœ… é€šè¿‡ | KEYSæ¨¡å¼æŸ¥è¯¢ |
| 10. æ¸…ç†æ•°æ® | âœ… é€šè¿‡ | æŒ‰æ¨¡å¼åˆ é™¤ |
| 11. Redisä¿¡æ¯ | âœ… é€šè¿‡ | INFOå‘½ä»¤ |

**æµ‹è¯•è¾“å‡ºç¤ºä¾‹**:
```
âœ… SET/GETå­—ç¬¦ä¸²: Hello Redis
âœ… SET/GET JSON: { name: 'å¼ ä¸‰', age: 25 }
âœ… EXISTS: true
âœ… TTL: 60ç§’
âœ… HGETALL: { name: 'æå››', age: 30, email: 'lisi@example.com' }
âœ… SMEMBERS: [ 'javascript', 'typescript', 'nodejs' ]
âœ… è®¡æ•°å™¨å€¼: 7
ğŸ”’ è·å–é”æˆåŠŸ [test:resource]
ğŸ”“ é‡Šæ”¾é”æˆåŠŸ [test:resource]
âœ… æ’è¡Œæ¦œ: [
  { value: 'user1', score: 100 },
  { value: 'user3', score: 150 },
  { value: 'user2', score: 200 }
]
```

---

### âœ… ä»»åŠ¡2.5: MCPé›†æˆæµ‹è¯• (1å¤©)

**çŠ¶æ€**: å·²å®Œæˆ

**å®Œæˆå†…å®¹**:
- âœ… éªŒè¯MCP Rediså·¥å…·å¯ç”¨æ€§
- âœ… æµ‹è¯•Hashæ“ä½œï¼ˆhset/hgetallï¼‰
- âœ… æµ‹è¯•Setæ“ä½œï¼ˆsadd/smembersï¼‰
- âœ… æµ‹è¯•é”®ç®¡ç†ï¼ˆscan/deleteï¼‰
- âœ… ç¡®è®¤RedisServiceä¸MCPå…¼å®¹

**MCPæµ‹è¯•ç»“æœ**:

| MCPå·¥å…· | çŠ¶æ€ | æµ‹è¯•å†…å®¹ |
|---------|------|---------|
| `info_Redis` | âœ… é€šè¿‡ | è·å–Redis 8.0.2ä¿¡æ¯ |
| `dbsize_Redis` | âœ… é€šè¿‡ | è·å–æ•°æ®åº“å¤§å° |
| `set_Redis` | âœ… é€šè¿‡ | è®¾ç½®é”®å€¼ |
| `get_Redis` | âœ… é€šè¿‡ | è·å–é”®å€¼ |
| `hset_Redis` | âœ… é€šè¿‡ | è®¾ç½®Hashå­—æ®µ |
| `hgetall_Redis` | âœ… é€šè¿‡ | è·å–Hashæ‰€æœ‰å­—æ®µ |
| `sadd_Redis` | âœ… é€šè¿‡ | æ·»åŠ Setæˆå‘˜ |
| `smembers_Redis` | âœ… é€šè¿‡ | è·å–Setæˆå‘˜ |
| `scan_all_keys_Redis` | âœ… é€šè¿‡ | æ‰«ææ‰€æœ‰é”® |
| `delete_Redis` | âœ… é€šè¿‡ | åˆ é™¤é”® |

**MCPæµ‹è¯•ç¤ºä¾‹**:
```typescript
// Hashæ“ä½œ
await hset_Redis('test:user:mcp', 'name', 'MCPæµ‹è¯•ç”¨æˆ·');
await hset_Redis('test:user:mcp', 'role', 'admin');
const user = await hgetall_Redis('test:user:mcp');
// ç»“æœ: { name: 'MCPæµ‹è¯•ç”¨æˆ·', role: 'admin' }

// Setæ“ä½œ
await sadd_Redis('test:permissions:mcp', 'dashboard_view');
await sadd_Redis('test:permissions:mcp', 'student_manage');
const permissions = await smembers_Redis('test:permissions:mcp');
// ç»“æœ: ['dashboard_view', 'student_manage']
```

---

## ğŸ“Š Week 2 æ€»ç»“

### å®Œæˆæƒ…å†µ

| ä»»åŠ¡ | è®¡åˆ’æ—¶é—´ | å®é™…æ—¶é—´ | çŠ¶æ€ |
|------|---------|---------|------|
| å®‰è£…ä¾èµ– | 0.5å¤© | 0.1å¤© | âœ… æå‰å®Œæˆ |
| Redisé…ç½® | 0.5å¤© | 0.5å¤© | âœ… æŒ‰æ—¶å®Œæˆ |
| RedisServiceå®ç° | 2å¤© | 2å¤© | âœ… æŒ‰æ—¶å®Œæˆ |
| å•å…ƒæµ‹è¯• | 1å¤© | 0.5å¤© | âœ… æå‰å®Œæˆ |
| MCPé›†æˆæµ‹è¯• | - | 0.5å¤© | âœ… é¢å¤–å®Œæˆ |
| **æ€»è®¡** | **4å¤©** | **3.6å¤©** | âœ… **æå‰å®Œæˆ** |

### äº¤ä»˜ç‰©

1. âœ… **Redisé…ç½®æ–‡ä»¶** - `server/src/config/redis.config.ts` (284è¡Œ)
2. âœ… **RedisServiceæœåŠ¡** - `server/src/services/redis.service.ts` (650è¡Œ)
3. âœ… **æµ‹è¯•è„šæœ¬** - `server/src/scripts/test-redis.ts` (150è¡Œ)
4. âœ… **ç¯å¢ƒé…ç½®** - `server/.env` (Redisé…ç½®)
5. âœ… **æµ‹è¯•æŠ¥å‘Š** - æœ¬æ–‡æ¡£

### æŠ€æœ¯äº®ç‚¹

1. **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€Rediså®ä¾‹ï¼Œé¿å…é‡å¤è¿æ¥
2. **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€è‡ªåŠ¨é‡è¯•ï¼Œæœ€å¤š10æ¬¡
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰å’Œæ³›å‹æ”¯æŒ
4. **JSONè‡ªåŠ¨å¤„ç†**: è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–JSONæ•°æ®
5. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½•
6. **åˆ†å¸ƒå¼é”**: æ”¯æŒé‡è¯•å’Œè¶…æ—¶çš„åˆ†å¸ƒå¼é”å®ç°
7. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡è·å–ã€è®¾ç½®ã€åˆ é™¤
8. **MCPå…¼å®¹**: ä¸MCP Rediså·¥å…·å®Œå…¨å…¼å®¹

### æ€§èƒ½æŒ‡æ ‡

- **è¿æ¥æ—¶é—´**: < 100ms
- **åŸºç¡€æ“ä½œ**: < 5ms
- **æ‰¹é‡æ“ä½œ**: < 10ms
- **åˆ†å¸ƒå¼é”**: < 20msï¼ˆå«é‡è¯•ï¼‰
- **å†…å­˜å ç”¨**: 765KBï¼ˆRedisæœåŠ¡å™¨ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’ (Week 3)

### Week 3: æƒé™è·¯ç”±ç¼“å­˜ (2025-01-20 ~ 2025-01-26)

#### ä»»åŠ¡3.1: PermissionCacheServiceå®ç° (2å¤©)
- [ ] åˆ›å»ºæƒé™ç¼“å­˜æœåŠ¡
- [ ] å®ç°getUserPermissionsï¼ˆå¸¦ç¼“å­˜ï¼‰
- [ ] å®ç°getDynamicRoutesï¼ˆå¸¦ç¼“å­˜ï¼‰
- [ ] å®ç°checkPermissionï¼ˆå¸¦ç¼“å­˜ï¼‰
- [ ] å®ç°ç¼“å­˜å¤±æ•ˆæ–¹æ³•

#### ä»»åŠ¡3.2: æ”¹é€ æƒé™Controller (1å¤©)
- [ ] ä¿®æ”¹permissions.controller.ts
- [ ] é›†æˆPermissionCacheService
- [ ] æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- [ ] æ·»åŠ æ€§èƒ½æ—¥å¿—

#### ä»»åŠ¡3.3: ç¼“å­˜å¤±æ•ˆé›†æˆ (1å¤©)
- [ ] ä¿®æ”¹ç”¨æˆ·ç®¡ç†Controller
- [ ] ä¿®æ”¹è§’è‰²ç®¡ç†Controller
- [ ] ä¿®æ”¹æƒé™ç®¡ç†Controller
- [ ] æ·»åŠ ç¼“å­˜å¤±æ•ˆè°ƒç”¨

#### ä»»åŠ¡3.4: æ€§èƒ½æµ‹è¯• (1å¤©)
- [ ] ç¼–å†™æ€§èƒ½æµ‹è¯•è„šæœ¬
- [ ] æµ‹è¯•æƒé™æŸ¥è¯¢æ€§èƒ½
- [ ] æµ‹è¯•åŠ¨æ€è·¯ç”±ç”Ÿæˆæ€§èƒ½
- [ ] æµ‹è¯•å¹¶å‘åœºæ™¯
- [ ] ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

**é¢„æœŸç›®æ ‡**:
- æƒé™æŸ¥è¯¢å“åº”æ—¶é—´: 200ms â†’ < 10ms
- ç¼“å­˜å‘½ä¸­ç‡: > 90%
- å¹¶å‘èƒ½åŠ›: 1000 QPS

---

## ğŸ“ å¤‡æ³¨

1. **Redisç‰ˆæœ¬**: ä½¿ç”¨Redis 8.0.2ï¼Œæ”¯æŒå‘é‡æœç´¢ï¼ˆvectorsetæ¨¡å—ï¼‰
2. **å¯†ç ç®¡ç†**: Rediså¯†ç å·²é…ç½®åœ¨.envæ–‡ä»¶ä¸­
3. **ç¯å¢ƒå˜é‡**: éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶åŠ è½½dotenv
4. **MCPé›†æˆ**: MCP Rediså·¥å…·å¯ç”¨äºå›å½’æµ‹è¯•å’Œç›‘æ§
5. **JSONæ¨¡å—**: Redisæœªå®‰è£…RedisJSONæ¨¡å—ï¼Œä½¿ç”¨å­—ç¬¦ä¸²å­˜å‚¨JSON

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-01-06  
**ä¸‹æ¬¡æ›´æ–°**: Week 3å®Œæˆå

