# VOSéŸ³é¢‘å¤„ç†æ”¹è¿›æ–¹æ¡ˆæ€»ç»“

## ðŸ“‹ æ¦‚è¿°

æ ¹æ®æ‚¨æä¾›çš„**VOS + è±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£**ï¼Œæˆ‘å·²å®Œæˆå¯¹å½“å‰ç³»ç»Ÿçš„è¯¦ç»†åˆ†æžï¼Œå¹¶ç”Ÿæˆäº†å®Œæ•´çš„æ”¹è¿›æ–¹æ¡ˆã€‚

---

## ðŸŽ¯ æ ¸å¿ƒå‘çŽ°

### å½“å‰ç³»ç»Ÿçš„é—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|--------|
| âŒ **é‡‡æ ·çŽ‡è½¬æ¢æœªå®žçŽ°** | éŸ³é¢‘å¤±çœŸæˆ–æ— å£° | ðŸ”´ ä¸¥é‡ |
| âŒ **ç¼–ç è½¬æ¢æœªå®žçŽ°** | VOSå’ŒASR/TTSä¸å…¼å®¹ | ðŸ”´ ä¸¥é‡ |
| âš ï¸ **éŸ³é¢‘ç¼“å†²1ç§’** | ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ>1.5s | ðŸŸ  é«˜ |
| âš ï¸ **RTPæ—¶åºä¸ç²¾ç¡®** | éŸ³é¢‘å¡é¡¿ã€ä¸¢åŒ… | ðŸŸ  é«˜ |
| âš ï¸ **ASR/TTSåˆ†ç¦»** | å¯¹è¯æµç•…åº¦å·® | ðŸŸ¡ ä¸­ |

### æµ‹è¯•æ–‡æ¡£çš„ä¼˜åŠ¿

âœ… **è±†åŒ…å®žæ—¶è¯­éŸ³** - ç«¯åˆ°ç«¯å¤„ç†ï¼ˆASR+LLM+TTSä¸€ä½“ï¼‰
âœ… **é‡‡æ ·çŽ‡è½¬æ¢** - 8kHz â†” 16kHz â†” 24kHzå®Œæ•´æ”¯æŒ
âœ… **ç¼–ç è½¬æ¢** - PCMA â†” PCMè‡ªåŠ¨è½¬æ¢
âœ… **ç²¾ç¡®æ—¶åº** - Â±1-5msç²¾åº¦ï¼ˆvså½“å‰Â±100msï¼‰
âœ… **æ— ç¼“å†²è®¾è®¡** - ç«‹å³è½¬æ¢ç«‹å³å‘é€ï¼ˆvså½“å‰1000msï¼‰
âœ… **çº¯JavaScript** - 7-10msè½¬æ¢é€Ÿåº¦ï¼ˆvs ffmpeg 100-400msï¼‰

---

## ðŸ“Š æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¿«é€Ÿä¿®å¤ï¼ˆæŽ¨èï¼‰âœ…

**ç›®æ ‡**: åœ¨å½“å‰ASR+TTSåˆ†ç¦»æž¶æž„ä¸‹å¿«é€Ÿå®žçŽ°é‡‡æ ·çŽ‡è½¬æ¢

**å·¥ä½œé‡**: 2-3å¤©

**å…³é”®æ­¥éª¤**:
1. å®‰è£…ä¾èµ–ï¼š`alawmulaw` + `wave-resampler`
2. åˆ›å»º`AudioCodecConverter`ç±»
3. é›†æˆåˆ°ASRæµç¨‹ï¼šPCMA 8kHz â†’ PCM 16kHz
4. é›†æˆåˆ°TTSæµç¨‹ï¼šPCM 24kHz â†’ PCMA 8kHz
5. ä¼˜åŒ–RTPæ—¶åºï¼šç²¾ç¡®æ—¶é—´æŽ§åˆ¶
6. ç§»é™¤éŸ³é¢‘ç¼“å†²ï¼šç«‹å³å¤„ç†

**é¢„æœŸæ•ˆæžœ**:
- éŸ³é¢‘è´¨é‡ï¼šå¤±çœŸ â†’ æ¸…æ™°
- å»¶è¿Ÿï¼š>1.5s â†’ <0.5s
- æ—¶åºç²¾åº¦ï¼šÂ±100ms â†’ Â±1-5ms

### æ–¹æ¡ˆBï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: è¿ç§»åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³ï¼ˆç«¯åˆ°ç«¯ï¼‰

**å·¥ä½œé‡**: 2-3å‘¨

**ä¼˜åŠ¿**:
- å•ä¸ªWebSocketè¿žæŽ¥
- ç«¯åˆ°ç«¯å¤„ç†ï¼ˆæ›´è‡ªç„¶ï¼‰
- æ›´ä½Žçš„å»¶è¿Ÿ
- æ›´å¥½çš„ä¸Šä¸‹æ–‡ç†è§£

---

## ðŸ“š ç”Ÿæˆçš„æ–‡æ¡£

### 1. VOSéŸ³é¢‘å¤„ç†åˆ†æžæŠ¥å‘Š
**æ–‡ä»¶**: `docs/VOSéŸ³é¢‘å¤„ç†åˆ†æžæŠ¥å‘Š.md`

**å†…å®¹**:
- æ‰§è¡Œæ‘˜è¦
- å…³é”®é—®é¢˜åˆ†æž
- æ”¹è¿›æ–¹æ¡ˆå¯¹æ¯”
- å®žæ–½æ¸…å•
- é£Žé™©è¯„ä¼°
- æˆæœ¬æ•ˆç›Šåˆ†æž

**ç”¨é€”**: å†³ç­–å±‚å®¡æ‰¹

### 2. VOSéŸ³é¢‘å¤„ç†å¯¹æ¯”åˆ†æž
**æ–‡ä»¶**: `docs/VOSéŸ³é¢‘å¤„ç†å¯¹æ¯”åˆ†æž.md`

**å†…å®¹**:
- æž¶æž„å¯¹æ¯”ï¼ˆæµ‹è¯•æ–‡æ¡£ vs å½“å‰å®žçŽ°ï¼‰
- å…³é”®æŠ€æœ¯å¯¹æ¯”
- æ”¹è¿›å»ºè®®
- æ€§èƒ½å¯¹æ¯”è¡¨

**ç”¨é€”**: æŠ€æœ¯è¯„å®¡

### 3. éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—
**æ–‡ä»¶**: `docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md`

**å†…å®¹**:
- æ ¸å¿ƒéœ€æ±‚
- è¯¦ç»†å®žçŽ°æ­¥éª¤
- å®Œæ•´ä»£ç ç¤ºä¾‹
- æµ‹è¯•éªŒè¯æ–¹æ³•
- å¸¸è§é—®é¢˜è§£å†³

**ç”¨é€”**: å¼€å‘å‚è€ƒ

### 4. VOSéŸ³é¢‘å¤„ç†ä¼˜åŒ–æ€»ç»“
**æ–‡ä»¶**: `docs/VOSéŸ³é¢‘å¤„ç†ä¼˜åŒ–æ€»ç»“.md`

**å†…å®¹**:
- çŽ°çŠ¶åˆ†æž
- ä¼˜åŒ–æ–¹æ¡ˆ
- å®žæ–½æ¸…å•
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- é¢„æœŸæ”¶ç›Š

**ç”¨é€”**: é¡¹ç›®ç®¡ç†

### 5. SIPåˆ°VOSè¿ç§»æ€»ç»“
**æ–‡ä»¶**: `docs/SIPåˆ°VOSè¿ç§»æ€»ç»“.md`

**å†…å®¹**:
- è¿ç§»å®Œæˆæƒ…å†µ
- å˜æ›´æ¸…å•
- æ•°æ®åº“å˜æ›´
- APIå˜æ›´
- éƒ¨ç½²æ­¥éª¤

**ç”¨é€”**: ç³»ç»Ÿé›†æˆ

---

## ðŸ”§ å…³é”®æŠ€æœ¯æ–¹æ¡ˆ

### é‡‡æ ·çŽ‡è½¬æ¢

```typescript
// VOS â†’ ASR: PCMA 8kHz â†’ PCM 16kHz
const pcm8k = alawmulaw.alaw.decode(pcmaData)
const pcm16k = resample(pcm8k, 8000, 16000)

// TTS â†’ VOS: PCM 24kHz â†’ PCMA 8kHz
const pcm8k = resample(pcm24kData, 24000, 8000)
const pcma = alawmulaw.alaw.encode(pcm8k)
```

### ç²¾ç¡®RTPæ—¶åº

```typescript
// ä½¿ç”¨ç»å¯¹æ—¶é—´è€Œä¸æ˜¯ç´¯ç§¯setTimeout
const expectedTime = startTime + packetCount * packetInterval
const waitTime = expectedTime - Date.now()

if (waitTime > 0) {
  await new Promise(resolve => setTimeout(resolve, waitTime))
}
```

### æ— ç¼“å†²ç«‹å³å‘é€

```typescript
// æ”¶åˆ°éŸ³é¢‘åŽç«‹å³è½¬æ¢å¹¶å‘é€
doubaoService.on('audio_output', async (data) => {
  const pcma = await audioConverter.pcm24kToPcma(data.audioData)
  await sendToVOS(pcma)  // ç«‹å³å‘é€ï¼Œæ— ç¼“å†²
})
```

---

## ðŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡ |
|------|--------|--------|------|
| **é‡‡æ ·çŽ‡è½¬æ¢** | âŒ æ—  | âœ… 7-10ms | å¿…é¡» |
| **ç¼–ç è½¬æ¢** | âŒ æ—  | âœ… 2-3ms | å¿…é¡» |
| **éŸ³é¢‘ç¼“å†²** | 1000ms | 0ms | **æ¶ˆé™¤** |
| **RTPç²¾åº¦** | Â±100ms | Â±1-5ms | **20å€** |
| **æ€»å»¶è¿Ÿ** | >1.5s | <0.5s | **3å€** |

---

## ðŸš€ ç«‹å³è¡ŒåŠ¨

### æœ¬å‘¨ï¼ˆå®¡æ‰¹å’Œå‡†å¤‡ï¼‰

1. **å®¡æ‰¹æ–¹æ¡ˆ**
   - ç¡®è®¤é‡‡ç”¨æ–¹æ¡ˆAï¼ˆå¿«é€Ÿä¿®å¤ï¼‰
   - åˆ†é…å¼€å‘èµ„æº

2. **å‡†å¤‡å·¥ä½œ**
   - å®‰è£…ä¾èµ–
   - åˆ›å»ºåˆ†æ”¯
   - å‡†å¤‡æµ‹è¯•çŽ¯å¢ƒ

### ä¸‹å‘¨ï¼ˆå®žæ–½ï¼‰

1. **åˆ›å»ºéŸ³é¢‘è½¬æ¢å™¨**
   - å‚è€ƒï¼š`docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md`
   - æ–‡ä»¶ï¼š`server/src/services/vos/audio-codec-converter.ts`

2. **é›†æˆåˆ°ASRæµç¨‹**
   - ä¿®æ”¹ï¼š`server/src/services/call-audio-stream.service.ts`
   - åœ¨å‘é€ç»™ASRå‰è¿›è¡Œè½¬æ¢

3. **é›†æˆåˆ°TTSæµç¨‹**
   - ä¿®æ”¹ï¼š`server/src/services/doubao-realtime-voice.service.ts`
   - åœ¨æŽ¥æ”¶TTSéŸ³é¢‘åŽè¿›è¡Œè½¬æ¢

4. **æµ‹è¯•éªŒè¯**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

---

## ðŸ“‹ å®žæ–½æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šé‡‡æ ·çŽ‡è½¬æ¢ï¼ˆå¿…é¡»ï¼‰

- [ ] å®‰è£…ä¾èµ–
  ```bash
  npm install alawmulaw wave-resampler
  ```

- [ ] åˆ›å»º`AudioCodecConverter`ç±»
- [ ] é›†æˆåˆ°ASRæµç¨‹
- [ ] é›†æˆåˆ°TTSæµç¨‹
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆæŽ¨èï¼‰

- [ ] ç§»é™¤éŸ³é¢‘ç¼“å†²
- [ ] ç²¾ç¡®RTPæ—¶åº
- [ ] æ€§èƒ½ç›‘æŽ§

### ç¬¬ä¸‰é˜¶æ®µï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

- [ ] è¯„ä¼°è±†åŒ…å®žæ—¶è¯­éŸ³
- [ ] åˆ¶å®šå‡çº§è®¡åˆ’

---

## ðŸ’¡ å…³é”®å»ºè®®

### ç«‹å³é‡‡å–è¡ŒåŠ¨

1. **é‡‡ç”¨æ–¹æ¡ˆA**
   - å·¥ä½œé‡å°ï¼ˆ2-3å¤©ï¼‰
   - æ•ˆæžœæ˜¾è‘—ï¼ˆ3å€å»¶è¿Ÿæ”¹å–„ï¼‰
   - é£Žé™©ä½Žï¼ˆæ”¹åŠ¨èŒƒå›´æœ‰é™ï¼‰

2. **ä½¿ç”¨çº¯JavaScriptåº“**
   - ä¸è¦ä½¿ç”¨ffmpegï¼ˆå¤ªæ…¢ï¼‰
   - ä½¿ç”¨`alawmulaw` + `wave-resampler`
   - æ€§èƒ½æå‡40-57å€

3. **ç«‹å³è½¬æ¢ç«‹å³å‘é€**
   - ç§»é™¤1ç§’ç¼“å†²
   - é¢„æœŸå»¶è¿Ÿå‡å°‘1000ms

### é•¿æœŸè§„åˆ’

1. **ç›‘æŽ§å’Œä¼˜åŒ–**
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - æ€§èƒ½ç›‘æŽ§
   - æŒç»­ä¼˜åŒ–

2. **è¯„ä¼°å‡çº§**
   - 1-2æœˆåŽè¯„ä¼°è±†åŒ…å®žæ—¶è¯­éŸ³
   - åˆ¶å®šå‡çº§è®¡åˆ’

---

## ðŸ“ž æ”¯æŒèµ„æº

### æ–‡æ¡£

- `docs/VOSéŸ³é¢‘å¤„ç†åˆ†æžæŠ¥å‘Š.md` - å†³ç­–å±‚å®¡æ‰¹
- `docs/VOSéŸ³é¢‘å¤„ç†å¯¹æ¯”åˆ†æž.md` - æŠ€æœ¯è¯„å®¡
- `docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md` - å¼€å‘å‚è€ƒ
- `docs/VOSéŸ³é¢‘å¤„ç†ä¼˜åŒ–æ€»ç»“.md` - é¡¹ç›®ç®¡ç†

### ä»£ç ç¤ºä¾‹

- å®Œæ•´çš„`AudioCodecConverter`å®žçŽ°
- ASRé›†æˆç¤ºä¾‹
- TTSé›†æˆç¤ºä¾‹
- RTPæ—¶åºæŽ§åˆ¶ç¤ºä¾‹

### æµ‹è¯•ç”¨ä¾‹

- å•å…ƒæµ‹è¯•ç¤ºä¾‹
- é›†æˆæµ‹è¯•ç¤ºä¾‹
- æ€§èƒ½æµ‹è¯•ç¤ºä¾‹

---

## ðŸŽ‰ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- âœ… éŸ³é¢‘è´¨é‡æ˜¾è‘—æå‡
- âœ… å»¶è¿Ÿå‡å°‘3å€
- âœ… ç”¨æˆ·ä½“éªŒæ˜Žæ˜¾æ”¹å–„

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
- âœ… ç³»ç»Ÿç¨³å®šæ€§æé«˜
- âœ… ç”¨æˆ·æ»¡æ„åº¦æå‡
- âœ… å¯ä»¥è€ƒè™‘å‡çº§åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
- âœ… å®Œæ•´çš„AIè¯­éŸ³å¯¹è¯ç³»ç»Ÿ
- âœ… ä¸šç•Œé¢†å…ˆçš„éŸ³é¢‘è´¨é‡
- âœ… å¯å•†ç”¨çš„å‘¼å«ä¸­å¿ƒè§£å†³æ–¹æ¡ˆ

---

## âœ… æ€»ç»“

æ ¹æ®æ‚¨æä¾›çš„æµ‹è¯•æ–‡æ¡£ï¼Œæˆ‘å·²ç»ï¼š

1. âœ… **å®Œæˆåˆ†æž** - è¯†åˆ«äº†5ä¸ªå…³é”®é—®é¢˜
2. âœ… **æå‡ºæ–¹æ¡ˆ** - æ–¹æ¡ˆAï¼ˆå¿«é€Ÿä¿®å¤ï¼‰å’Œæ–¹æ¡ˆBï¼ˆé•¿æœŸå‡çº§ï¼‰
3. âœ… **ç”Ÿæˆæ–‡æ¡£** - 5ä»½è¯¦ç»†çš„å®žæ–½æŒ‡å—
4. âœ… **æä¾›ä»£ç ** - å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œå®žçŽ°æŒ‡å—
5. âœ… **åˆ¶å®šè®¡åˆ’** - è¯¦ç»†çš„å®žæ–½æ¸…å•å’Œæ—¶é—´è¡¨

**å»ºè®®**: ç«‹å³å¯åŠ¨æ–¹æ¡ˆAå®žæ–½ï¼Œé¢„æœŸ2-3å¤©å†…å®Œæˆï¼Œæ•ˆæžœæ˜¾è‘—ã€‚

---

**ç‰ˆæœ¬**: v1.0  
**ç”Ÿæˆæ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: å¾…å®¡æ‰¹  
**ä¸‹ä¸€æ­¥**: å®¡æ‰¹æ–¹æ¡ˆå¹¶åˆ†é…å¼€å‘èµ„æº

