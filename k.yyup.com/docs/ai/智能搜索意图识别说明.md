# 智能搜索意图识别说明

## 📋 概述

在统一智能工具识别系统中，我们实现了智能搜索意图识别功能，能够根据用户查询的上下文自动判断是使用**本地数据库搜索**还是**网络搜索**。

---

## 🎯 核心功能

### 1. 智能意图判断

当用户查询中出现"搜索"、"最新"等关键词时，系统会：

1. **分析查询内容** - 识别关键词和模式
2. **判断搜索范围** - 本地数据 vs 网络信息
3. **选择合适工具** - `query_data` vs `web_search`
4. **执行搜索操作** - 返回最相关的结果

---

## 🔍 判断规则

### 触发网络搜索的条件

满足以下**任一条件**时，使用 `web_search` 工具：

#### 1. 明确的网络搜索关键词
```
✅ "网上搜索幼儿园教育政策"
✅ "在线查找最新教育资讯"
✅ "百度一下幼儿园管理方法"
✅ "谷歌搜索儿童心理学"
```

**关键词**: 网上、互联网、在线、百度、谷歌、搜索引擎

#### 2. 时效性关键词
```
✅ "最新幼儿园教育政策"
✅ "今天的教育新闻"
✅ "本周的教育资讯"
✅ "最近的幼教政策变化"
```

**关键词**: 最新、今天、昨天、本周、本月、今年、最近、新闻、政策、资讯

#### 3. 知识性查询
```
✅ "什么是蒙台梭利教育"
✅ "如何提高幼儿注意力"
✅ "为什么要进行早期教育"
✅ "了解STEAM教育理念"
```

**关键词**: 什么是、如何、怎么、为什么、了解

#### 4. 通用搜索关键词（需结合上下文）
```
✅ "搜索幼儿园教育理念"
✅ "查找儿童发展理论"
✅ "搜一下最新教育方法"
```

**关键词**: 搜索、查找、搜一下、找一下、查一查

---

### 排除网络搜索的条件

满足以下**任一条件**时，**不使用** `web_search` 工具，改用本地数据库查询：

#### 1. 本地业务数据查询
```
❌ "查询学生信息"
❌ "搜索教师档案"
❌ "查找班级数据"
❌ "搜索活动记录"
❌ "查询家长信息"
```

**关键词**: 学生、教师、班级、活动、家长 + 查询/搜索

#### 2. 统计分析查询
```
❌ "统计学生人数"
❌ "统计教师出勤"
❌ "统计班级活动"
❌ "分析招生数据"
```

**关键词**: 统计、分析 + 学生/教师/班级/活动

#### 3. 历史记录查询
```
❌ "历史活动记录"
❌ "过往招生数据"
❌ "本园历史数据"
❌ "我们的学生记录"
```

**关键词**: 历史、过往、本园、我们 + 记录/数据

---

## 📊 实现细节

### 1. 配置文件

**文件**: `server/src/services/ai/tools/config/function-mapping.config.ts`

```typescript
'web_search': {
  patterns: [
    // 明确的网络搜索意图
    /网上|互联网|在线|百度|谷歌|搜索引擎/i,
    // 时效性关键词
    /最新.*政策|最新.*新闻|最新.*资讯/i,
    // 知识性查询
    /什么是.*(?!学生|教师|班级|活动)/i,
    // 搜索关键词
    /搜索.*(?!学生|教师|班级|活动)/i
  ],
  toolGroup: 'webOperation',
  defaultTools: ['web_search'],
  weight: 8,
  // 🚨 排除模式
  excludePatterns: [
    /查询.*学生|查询.*教师|查询.*班级|查询.*活动/i,
    /统计.*学生|统计.*教师|统计.*班级|统计.*活动/i,
    /历史.*记录|过往.*数据|本园.*数据/i,
    /我们.*学生|我们.*教师|我们.*班级|我们.*活动/i
  ]
}
```

### 2. 工具选择器

**文件**: `server/src/services/ai/tools/core/tool-selector.service.ts`

```typescript
// 🔍 特殊处理：网络搜索意图需要检查排除模式
if (intentName === 'web_search' && config.excludePatterns) {
  let shouldExclude = false;
  
  // 检查是否匹配排除模式
  for (const excludePattern of config.excludePatterns) {
    if (excludePattern.test(query)) {
      console.log(`🚫 [搜索意图] 匹配排除模式，不使用网络搜索`);
      shouldExclude = true;
      break;
    }
  }
  
  // 如果匹配排除模式，跳过此意图
  if (shouldExclude) {
    console.log(`📊 [搜索意图] 判断为本地数据库查询`);
    continue;
  }
}
```

### 3. 工具权重配置

**文件**: `server/src/services/ai/tools/config/tool-groups.config.ts`

```typescript
toolWeights: {
  'render_component': 10,      // UI展示（最高优先级）
  'query_data': 9,              // 数据查询
  'web_search': 8,              // 🔍 网络搜索（高优先级）
  'consult_recruitment_planner': 8,
  'call_expert': 7,
  // ...
}
```

---

## 🧪 测试用例

### 网络搜索示例

| 用户查询 | 判断结果 | 使用工具 | 说明 |
|---------|---------|---------|------|
| "网上搜索最新幼儿园政策" | ✅ 网络搜索 | `web_search` | 明确网络搜索 + 时效性 |
| "最新的幼儿教育资讯" | ✅ 网络搜索 | `web_search` | 时效性关键词 |
| "什么是蒙台梭利教育" | ✅ 网络搜索 | `web_search` | 知识性查询 |
| "如何提高幼儿注意力" | ✅ 网络搜索 | `web_search` | 知识性查询 |
| "搜索幼儿园管理方法" | ✅ 网络搜索 | `web_search` | 通用搜索（无本地数据关键词） |

### 本地查询示例

| 用户查询 | 判断结果 | 使用工具 | 说明 |
|---------|---------|---------|------|
| "查询学生信息" | ❌ 本地查询 | `query_data` | 本地业务数据 |
| "搜索教师档案" | ❌ 本地查询 | `query_data` | 本地业务数据 |
| "统计班级人数" | ❌ 本地查询 | `query_data` | 统计分析 |
| "历史活动记录" | ❌ 本地查询 | `query_data` | 历史记录 |
| "我们的学生数据" | ❌ 本地查询 | `query_data` | 本园数据 |

---

## 🔧 工具数量限制

### 当前配置

- **最大工具数量**: 8个（从3个增加到8个）
- **默认工具**: `render_component`（总是包含）
- **网络搜索权重**: 8（高优先级）

### 工具组合示例

**查询**: "搜索最新幼儿园政策并生成活动方案"

**选择的工具**:
1. `web_search` - 网络搜索最新政策
2. `create_activity` - 生成活动方案
3. `render_component` - 展示结果

---

## 📈 优势

### 1. 智能判断
- ✅ 自动识别用户意图
- ✅ 减少用户操作步骤
- ✅ 提高搜索准确性

### 2. 上下文感知
- ✅ 结合查询内容判断
- ✅ 排除本地数据关键词
- ✅ 优先本地数据查询

### 3. 灵活配置
- ✅ 可扩展的模式匹配
- ✅ 可调整的权重配置
- ✅ 可定制的排除规则

### 4. 性能优化
- ✅ 避免不必要的网络请求
- ✅ 优先使用本地数据
- ✅ 减少API调用成本

---

## 🚀 使用方式

### 前端调用

用户在AI助手中输入查询，系统自动判断：

```typescript
// 用户输入
"最新的幼儿园教育政策"

// 系统自动识别
{
  intent: 'web_search',
  confidence: 8,
  selectedTools: ['web_search', 'render_component']
}

// 执行网络搜索
const result = await aiBridgeService.search({
  query: '最新的幼儿园教育政策',
  maxResults: 10,
  enableAISummary: true
});
```

### 后端日志

```
🎯 [工具选择器] 开始智能选择工具
🧠 [功能识别] 识别到的意图: ['web_search']
🔍 [搜索意图] 检测到网络搜索意图，置信度: 8
🔍 [搜索意图] 匹配的关键词: ['最新', '政策']
✅ [最终选择] 最终选择的工具: ['web_search', 'render_component']
```

---

## 📝 注意事项

### 1. 模式优先级
- 排除模式优先于匹配模式
- 本地数据查询优先于网络搜索
- 明确关键词优先于模糊匹配

### 2. 边界情况
- 如果查询同时包含本地和网络关键词，优先本地查询
- 如果无法判断，默认使用本地查询
- 用户可以通过明确关键词强制使用网络搜索

### 3. 性能考虑
- 网络搜索有API调用成本
- 本地查询速度更快
- 合理使用可以提高系统性能

---

## 🔄 未来优化

### 1. 机器学习
- 基于用户历史查询学习意图
- 动态调整权重配置
- 个性化搜索策略

### 2. 混合搜索
- 同时使用本地和网络搜索
- 结果融合和排序
- 智能去重

### 3. 缓存优化
- 缓存常见网络搜索结果
- 减少重复API调用
- 提高响应速度

---

**最后更新**: 2025-10-07
**版本**: v1.0
**状态**: ✅ 已实现并测试

