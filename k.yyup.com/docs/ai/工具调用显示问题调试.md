# å·¥å…·è°ƒç”¨æ˜¾ç¤ºé—®é¢˜è°ƒè¯•æ–‡æ¡£

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**ï¼šåç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨å·¥å…·ï¼Œä½†å‰ç«¯æ— æ³•æ˜¾ç¤ºå·¥å…·è°ƒç”¨ä¿¡æ¯

**å½±å“èŒƒå›´**ï¼š
- å…¨å±æ¨¡å¼ï¼ˆFullscreenLayoutï¼‰çš„å³ä¾§å·¥å…·é¢æ¿ï¼ˆRightSidebarï¼‰
- èŠå¤©åŒºåŸŸï¼ˆMessageListï¼‰çš„å·¥å…·è°ƒç”¨æ˜¾ç¤º

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### 1. å·¥å…·è°ƒç”¨æ˜¾ç¤ºçš„ä¸¤ä¸ªä½ç½®

#### ä½ç½®1ï¼šèŠå¤©åŒºåŸŸï¼ˆMessageListï¼‰
- **ç»„ä»¶è·¯å¾„**ï¼š`client/src/components/ai-assistant/chat/MessageList.vue`
- **æ˜¾ç¤ºç»„ä»¶**ï¼š`FunctionCallList.vue`
- **æ•°æ®æ¥æº**ï¼š`currentAIResponse.functionCalls`
- **æ˜¾ç¤ºæ¡ä»¶**ï¼š`v-if="currentAIResponse?.functionCalls?.length > 0"`

#### ä½ç½®2ï¼šå³ä¾§å·¥å…·é¢æ¿ï¼ˆRightSidebarï¼‰
- **ç»„ä»¶è·¯å¾„**ï¼š`client/src/components/ai-assistant/panels/RightSidebar.vue`
- **æ˜¾ç¤ºåŒºåŸŸ**ï¼šå·¥å…·è°ƒç”¨å†å²åˆ—è¡¨
- **æ•°æ®æ¥æº**ï¼š`toolCalls` prop
- **æ˜¾ç¤ºæ¡ä»¶**ï¼š`v-if="toolCalls.length > 0"`

### 2. æ•°æ®æµå‘

```
åç«¯SSEäº‹ä»¶ (tool_call_start)
    â†“
AIAssistantCore.vue (handleMultiRoundToolCalling)
    â†“
åŒæ—¶æ›´æ–°ä¸¤ä¸ªçŠ¶æ€ï¼š
    â”œâ”€ currentAIResponse.value.functionCalls.push(toolCallData)  â†’ MessageListæ˜¾ç¤º
    â””â”€ toolCalls.value.push({...})                               â†’ RightSidebaræ˜¾ç¤º
```

### 3. çŠ¶æ€ç®¡ç†

#### currentAIResponse
- **æ¥æº**ï¼š`useAIResponse` composable
- **ç±»å‹**ï¼š`CurrentAIResponseState`
- **åŒ…å«**ï¼šthinking, functionCalls, answer
- **ä¼ é€’è·¯å¾„**ï¼š
  ```
  AIAssistantRefactored
    â†’ ChatContainer (prop: currentAIResponse)
      â†’ MessageList (prop: currentAIResponse)
        â†’ FunctionCallList (prop: functionCalls)
  ```

#### toolCalls
- **æ¥æº**ï¼š`useAIAssistantState` composable
- **ç±»å‹**ï¼š`ToolCallState[]`
- **ä¼ é€’è·¯å¾„**ï¼š
  ```
  AIAssistantRefactored
    â†’ FullscreenLayout (prop: tool-calls)
      â†’ RightSidebar (prop: toolCalls)
  ```

## ğŸ” è°ƒè¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

å·²åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š

1. **MessageList.vue** (ç¬¬42-58è¡Œ)
   ```vue
   <!-- ğŸ”§ è°ƒè¯•ï¼šæ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€ -->
   <div v-if="currentAIResponse?.visible" style="...">
     <div>ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š</div>
     <div>currentAIResponse.visible: {{ currentAIResponse?.visible }}</div>
     <div>functionCallsæ•°é‡: {{ currentAIResponse?.functionCalls?.length || 0 }}</div>
   </div>
   ```

2. **RightSidebar.vue** (ç¬¬60-67è¡Œ)
   ```vue
   <!-- ğŸ”§ è°ƒè¯•ä¿¡æ¯ -->
   <div style="...">
     <div>ğŸ” RightSidebarè°ƒè¯•ï¼š</div>
     <div>visible: {{ visible }}</div>
     <div>toolCallsæ•°é‡: {{ toolCalls.length }}</div>
   </div>
   ```

3. **RightSidebar.vue** (ç¬¬299-312è¡Œ)
   ```typescript
   // ğŸ”§ æ·»åŠ å·¥å…·è°ƒç”¨å˜åŒ–çš„è°ƒè¯•æ—¥å¿—
   watch(() => props.toolCalls, (newTools, oldTools) => {
     console.log('ğŸ”§ [å·¥å…·è°ƒç”¨ç›‘å¬] å·¥å…·è°ƒç”¨åˆ—è¡¨å˜åŒ–:', {
       newCount: newTools.length,
       oldCount: oldTools?.length || 0,
       newTools: newTools.map(t => ({...}))
     })
   }, { deep: true, immediate: true })
   ```

### ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æµç¨‹

1. **å¯åŠ¨æœåŠ¡**
   ```bash
   npm run start:all
   ```

2. **è®¿é—®AIåŠ©æ‰‹**
   - æ‰“å¼€æµè§ˆå™¨ï¼šhttp://localhost:5173
   - ç™»å½•adminè´¦å·
   - ç‚¹å‡»å¤´éƒ¨"YY-AIåŠ©æ‰‹"æŒ‰é’®

3. **è§¦å‘å·¥å…·è°ƒç”¨**
   - ç‚¹å‡»å³ä¾§çš„"æ™ºèƒ½ä»£ç†"æŒ‰é’®ï¼ˆç¡®ä¿Autoæ¨¡å¼å¼€å¯ï¼‰
   - è¾“å…¥éœ€è¦å·¥å…·è°ƒç”¨çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š
     - "æ‰“å¼€æ‹›ç”Ÿä¸­å¿ƒ"
     - "æŸ¥è¯¢å­¦ç”Ÿåˆ—è¡¨"
     - "ç”Ÿæˆæ´»åŠ¨æ–¹æ¡ˆ"

4. **è§‚å¯Ÿè°ƒè¯•ä¿¡æ¯**
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
   - æŸ¥çœ‹Consoleæ ‡ç­¾é¡µçš„æ—¥å¿—è¾“å‡º
   - æŸ¥çœ‹é¡µé¢ä¸Šçš„è°ƒè¯•ä¿¡æ¯æ¡†

### ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥ç‚¹

#### æ£€æŸ¥ç‚¹1ï¼šåç«¯äº‹ä»¶æ˜¯å¦å‘é€
```javascript
// åœ¨Consoleä¸­æŸ¥æ‰¾ï¼š
ğŸ”§ [SSEäº‹ä»¶] tool_call_start
```

#### æ£€æŸ¥ç‚¹2ï¼šå‰ç«¯æ˜¯å¦æ¥æ”¶äº‹ä»¶
```javascript
// åœ¨Consoleä¸­æŸ¥æ‰¾ï¼š
ğŸ”§ [å·¥å…·è°ƒç”¨ç›‘å¬] å·¥å…·è°ƒç”¨åˆ—è¡¨å˜åŒ–
```

#### æ£€æŸ¥ç‚¹3ï¼šçŠ¶æ€æ˜¯å¦æ›´æ–°
- æŸ¥çœ‹MessageListçš„è°ƒè¯•æ¡†ï¼šfunctionCallsæ•°é‡åº”è¯¥ > 0
- æŸ¥çœ‹RightSidebarçš„è°ƒè¯•æ¡†ï¼štoolCallsæ•°é‡åº”è¯¥ > 0

#### æ£€æŸ¥ç‚¹4ï¼šç»„ä»¶æ˜¯å¦æ¸²æŸ“
- MessageListä¸­åº”è¯¥æ˜¾ç¤ºFunctionCallListç»„ä»¶
- RightSidebarä¸­åº”è¯¥æ˜¾ç¤ºå·¥å…·è°ƒç”¨å†å²åˆ—è¡¨

## ğŸ› å¯èƒ½çš„é—®é¢˜åŸå› 

### åŸå› 1ï¼šçŠ¶æ€æœªæ­£ç¡®æ›´æ–°
- **ç—‡çŠ¶**ï¼šConsoleæœ‰äº‹ä»¶æ—¥å¿—ï¼Œä½†çŠ¶æ€æ•°é‡ä¸º0
- **æ£€æŸ¥**ï¼šAIAssistantCore.vueçš„tool_call_startäº‹ä»¶å¤„ç†
- **ä½ç½®**ï¼š`client/src/components/ai-assistant/core/AIAssistantCore.vue:243-289`

### åŸå› 2ï¼šPropsæœªæ­£ç¡®ä¼ é€’
- **ç—‡çŠ¶**ï¼šçŠ¶æ€æœ‰æ•°æ®ï¼Œä½†å­ç»„ä»¶æ”¶ä¸åˆ°
- **æ£€æŸ¥**ï¼š
  - AIAssistantRefactored â†’ FullscreenLayout â†’ RightSidebar
  - AIAssistantRefactored â†’ ChatContainer â†’ MessageList
- **ä½ç½®**ï¼š
  - `AIAssistantRefactored.vue:154` (tool-callsä¼ é€’)
  - `AIAssistantRefactored.vue:182` (current-ai-responseä¼ é€’)

### åŸå› 3ï¼šComposableå•ä¾‹é—®é¢˜
- **ç—‡çŠ¶**ï¼šä¸åŒç»„ä»¶è·å–çš„çŠ¶æ€ä¸ä¸€è‡´
- **æ£€æŸ¥**ï¼š
  - `useAIResponse` æ˜¯å¦æ­£ç¡®å®ç°å•ä¾‹
  - `useAIAssistantState` æ˜¯å¦æ­£ç¡®å®ç°å•ä¾‹
- **ä½ç½®**ï¼š
  - `client/src/components/ai-assistant/composables/useAIResponse.ts`
  - `client/src/components/ai-assistant/composables/useAIAssistantState.ts`

### åŸå› 4ï¼šçŠ¶æ€è¢«æ„å¤–æ¸…ç©º
- **ç—‡çŠ¶**ï¼šçŠ¶æ€å…ˆæœ‰æ•°æ®åå˜ä¸ºç©º
- **æ£€æŸ¥**ï¼š
  - `clearCurrentAIResponse()` è°ƒç”¨æ—¶æœº
  - `resetState()` è°ƒç”¨æ—¶æœº
  - `complete` äº‹ä»¶å¤„ç†ï¼ˆ5ç§’åæ¸…ç©ºtoolCallsï¼‰
- **ä½ç½®**ï¼š`AIAssistantCore.vue:462-465`

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆå·²å®Œæˆï¼‰
2. â³ å¯åŠ¨æœåŠ¡å¹¶æµ‹è¯•
3. â³ æ ¹æ®è°ƒè¯•ä¿¡æ¯å®šä½é—®é¢˜
4. â³ ä¿®å¤é—®é¢˜
5. â³ ç§»é™¤è°ƒè¯•ä»£ç 
6. â³ æäº¤ä¿®å¤

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `client/src/components/ai-assistant/AIAssistantRefactored.vue`
- `client/src/components/ai-assistant/core/AIAssistantCore.vue`
- `client/src/components/ai-assistant/chat/MessageList.vue`
- `client/src/components/ai-assistant/chat/ChatContainer.vue`
- `client/src/components/ai-assistant/panels/RightSidebar.vue`
- `client/src/components/ai-assistant/ai-response/FunctionCallList.vue`
- `client/src/components/ai-assistant/composables/useAIResponse.ts`
- `client/src/components/ai-assistant/composables/useAIAssistantState.ts`

## ğŸ“š å‚è€ƒ

- Gitå†å²å¯¹æ¯”ï¼š`cb3eb79` (å·¥å…·è°ƒç”¨æ­£å¸¸å·¥ä½œçš„ç‰ˆæœ¬)
- æœ€è¿‘æäº¤ï¼š`b815f69` (ä¿®å¤AIåŠ©æ‰‹ä¾§è¾¹æ ChatContainerç¼ºå¤±propså’Œå·¥å…·è°ƒç”¨æ˜¾ç¤ºé—®é¢˜)

