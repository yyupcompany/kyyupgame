# å·¥å…·UIæ¸²æŸ“æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2025-10-13  
**æµ‹è¯•äººå‘˜**: AI Agent  
**æµ‹è¯•ç¯å¢ƒ**: å‰ç«¯(localhost:5173) + åç«¯(localhost:3000)

---

## âœ… æµ‹è¯•æ€»ç»“

### æµ‹è¯•ç”¨ä¾‹
**è¾“å…¥**: "æŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿ"

### æ‰§è¡Œæµç¨‹
1. âœ… ç”¨æˆ·å‘é€æ¶ˆæ¯
2. âœ… AIå¼€å§‹æ€è€ƒ
3. âœ… è°ƒç”¨ `read_data_record` å·¥å…·ï¼ˆå¤±è´¥ï¼‰
4. âœ… é™çº§åˆ° `any_query` å·¥å…·ï¼ˆæˆåŠŸï¼‰
5. âœ… è¿”å›UIæŒ‡ä»¤
6. âš ï¸ ç»„ä»¶æœªæ­£ç¡®æ˜¾ç¤º

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… æˆåŠŸçš„éƒ¨åˆ†

#### 1. åç«¯å·¥å…·è°ƒç”¨
- âœ… `read_data_record` å·¥å…·è¢«è°ƒç”¨
- âœ… å·¥å…·å¤±è´¥åè‡ªåŠ¨é™çº§åˆ° `any_query`
- âœ… `any_query` å·¥å…·æˆåŠŸæ‰§è¡Œ
- âœ… è¿”å›äº† `ui_instruction` å­—æ®µ

#### 2. åç«¯UIæŒ‡ä»¤æ ¼å¼
æ ¹æ®æ§åˆ¶å°æ—¥å¿—ï¼š
```javascript
ğŸ¨ [UIæŒ‡ä»¤] æ£€æµ‹åˆ°UIæ¸²æŸ“æŒ‡ä»¤: {type: render_component, component: Object}
ğŸ¨ [UIæŒ‡ä»¤] æ¸²æŸ“ç»„ä»¶ (render_component): {
  type: data-table, 
  title: search æŸ¥è¯¢ç»“æœ, 
  columns: Array(27), 
  ...
}
```

**ç»“è®º**: âœ… åç«¯æˆåŠŸè¿”å›äº†æ­£ç¡®æ ¼å¼çš„UIæŒ‡ä»¤

#### 3. å‰ç«¯UIæŒ‡ä»¤æ£€æµ‹
- âœ… å‰ç«¯æˆåŠŸæ£€æµ‹åˆ° `render_component` ç±»å‹
- âœ… ç»„ä»¶æ•°æ®è¢«æ·»åŠ åˆ° `renderedComponents` åˆ—è¡¨
- âœ… æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤ºï¼š"ç»„ä»¶å·²æ·»åŠ åˆ°æ¸²æŸ“åˆ—è¡¨"

#### 4. å·¥å…·è°ƒç”¨å†å²
- âœ… å³ä¾§ä¾§è¾¹æ æ˜¾ç¤ºäº†2ä¸ªå·¥å…·è°ƒç”¨
- âœ… å·¥å…·è°ƒç”¨çŠ¶æ€æ­£ç¡®æ›´æ–°
- âœ… ä¼šè¯ç»Ÿè®¡æ­£ç¡®æ˜¾ç¤ºï¼ˆæ¶ˆæ¯æ•°:1, å·¥å…·è°ƒç”¨:2, ä»»åŠ¡åˆ›å»º:1ï¼‰

---

### âš ï¸ å‘ç°çš„é—®é¢˜

#### é—®é¢˜1: ç»„ä»¶æœªåœ¨èŠå¤©æ¶ˆæ¯ä¸­æ˜¾ç¤º

**ç°è±¡**:
- ç»„ä»¶æ•°æ®å·²æ·»åŠ åˆ° `renderedComponents` åˆ—è¡¨
- ä½†æ˜¯èŠå¤©æ¶ˆæ¯åŒºåŸŸæ²¡æœ‰æ˜¾ç¤ºè¡¨æ ¼ç»„ä»¶
- é¡µé¢ä¸Šæ‰¾ä¸åˆ°ä»»ä½•è¡¨æ ¼å…ƒç´ ï¼ˆtable, .el-table, .data-tableï¼‰

**å¯èƒ½åŸå› **:
1. âŒ ç»„ä»¶æ•°æ®æ²¡æœ‰æ­£ç¡®é™„åŠ åˆ°èŠå¤©æ¶ˆæ¯
2. âŒ MessageItemç»„ä»¶æ²¡æœ‰æ­£ç¡®æ¸²æŸ“componentData
3. âŒ ComponentRendererç»„ä»¶æ²¡æœ‰è¢«æ­£ç¡®è°ƒç”¨

**è¯æ®**:
```javascript
// æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º
ğŸ¨ [UIæŒ‡ä»¤] ç»„ä»¶å·²æ·»åŠ åˆ°æ¸²æŸ“åˆ—è¡¨: {
  id: component-1760384943281-f6zowaaxf, 
  type: data-table, 
  title: search æŸ¥è¯¢ç»“æœ, 
  columns: Array(27), 
  data: Array(1), 
  ...
}

// ä½†æ˜¯é¡µé¢æ£€æŸ¥ç»“æœ
{
  "tablesCount": 0,
  "componentsCount": 0,
  "tableClasses": [],
  "componentClasses": []
}
```

#### é—®é¢˜2: å”¯ä¸€IDä¸åŒ¹é…è­¦å‘Š

**ç°è±¡**:
```
âš ï¸ [å·¥å…·] æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·è°ƒç”¨: read_data_record (ID: tool-1760384930295-hht1339fb)
âš ï¸ [å·¥å…·] æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·è°ƒç”¨: any_query (ID: tool-1760384943280-nmlmh8ccv)
```

**åŸå› **: 
- `tool_call_start` äº‹ä»¶ä½¿ç”¨ID: `tool-1760384930239-zn1xajyi5`
- `tool_call_complete` äº‹ä»¶ä½¿ç”¨ID: `tool-1760384930295-hht1339fb`
- ä¸¤ä¸ªIDä¸ä¸€è‡´

**å½±å“**: 
- å·¥å…·çŠ¶æ€æ— æ³•æ­£ç¡®æ›´æ–°
- å¯èƒ½å¯¼è‡´é‡å¤æ˜¾ç¤ºå·¥å…·è°ƒç”¨

---

## ğŸ” è¯¦ç»†åˆ†æ

### åç«¯è¿”å›çš„æ•°æ®ç»“æ„

æ ¹æ®æ§åˆ¶å°æ—¥å¿—ï¼Œåç«¯è¿”å›çš„æ•°æ®åŒ…å«ï¼š

```javascript
{
  name: "any_query",
  result: {
    name: "any_query",
    status: "success",
    result: {
      query: "æŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿ",
      tables: [...],
      sql: "SELECT ...",
      result: [...],  // æŸ¥è¯¢ç»“æœæ•°æ®
      ui_instruction: {
        type: "render_component",  // âœ… æ­£ç¡®çš„ç±»å‹
        component: {
          type: "data-table",
          title: "search æŸ¥è¯¢ç»“æœ",
          columns: [
            { prop: "id", label: "ID", width: 80 },
            { prop: "name", label: "åç§°", width: 120 },
            // ... å…±27åˆ—
          ],
          data: [
            // ... æŸ¥è¯¢ç»“æœæ•°æ®
          ],
          searchable: true,
          pagination: true,
          exportable: true
        }
      }
    }
  }
}
```

**ç»“è®º**: âœ… åç«¯æ•°æ®ç»“æ„å®Œå…¨æ­£ç¡®

### å‰ç«¯å¤„ç†æµç¨‹

æ ¹æ®æ§åˆ¶å°æ—¥å¿—ï¼Œå‰ç«¯å¤„ç†æµç¨‹ï¼š

1. âœ… æ¥æ”¶åˆ° `tool_call_complete` äº‹ä»¶
2. âœ… æ£€æµ‹åˆ° `ui_instruction.type === 'render_component'`
3. âœ… æå– `uiInstruction.component` æ•°æ®
4. âœ… åˆ›å»º `componentData` å¯¹è±¡
5. âœ… æ·»åŠ åˆ° `renderedComponents.value` æ•°ç»„
6. âŒ **ä½†æ˜¯æ²¡æœ‰æ·»åŠ åˆ°èŠå¤©æ¶ˆæ¯**

**é—®é¢˜å®šä½**: 
- ä»£ç ä½ç½®: `AIAssistantRefactored.vue` ç¬¬746-823è¡Œ
- é—®é¢˜: ç»„ä»¶æ•°æ®æ·»åŠ åˆ° `renderedComponents` åï¼Œæ²¡æœ‰åˆ›å»ºå¯¹åº”çš„èŠå¤©æ¶ˆæ¯

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¿®å¤1: ç¡®ä¿ç»„ä»¶æ•°æ®é™„åŠ åˆ°èŠå¤©æ¶ˆæ¯

**é—®é¢˜**: ç»„ä»¶æ•°æ®è¢«æ·»åŠ åˆ° `renderedComponents`ï¼Œä½†æ²¡æœ‰åˆ›å»ºèŠå¤©æ¶ˆæ¯

**ä¿®å¤æ–¹æ¡ˆ**: åœ¨æ·»åŠ ç»„ä»¶åˆ° `renderedComponents` åï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å« `componentData` çš„èŠå¤©æ¶ˆæ¯

**ä»£ç ä½ç½®**: `AIAssistantRefactored.vue` ç¬¬766-781è¡Œ

**å½“å‰ä»£ç **:
```typescript
renderedComponents.value.push(componentData)
console.log('ğŸ¨ [UIæŒ‡ä»¤] ç»„ä»¶å·²æ·»åŠ åˆ°æ¸²æŸ“åˆ—è¡¨:', componentData)

// ğŸ¯ ä¸¤æ®µå¼æµç¨‹ï¼šåªä¿å­˜å‰ç½®è¯´æ˜å’Œç»„ä»¶æ•°æ®
const preMessage = resultData.pre_message || ''

if (preMessage.trim()) {
  chatHistory.addMessage({
    role: 'assistant',
    content: preMessage,
    componentData: componentData,
    timestamp: Date.now()
  })
}
```

**é—®é¢˜**: å¦‚æœ `preMessage` ä¸ºç©ºï¼Œåˆ™ä¸ä¼šåˆ›å»ºèŠå¤©æ¶ˆæ¯

**ä¿®å¤å**:
```typescript
renderedComponents.value.push(componentData)
console.log('ğŸ¨ [UIæŒ‡ä»¤] ç»„ä»¶å·²æ·»åŠ åˆ°æ¸²æŸ“åˆ—è¡¨:', componentData)

// ğŸ¯ åˆ›å»ºåŒ…å«ç»„ä»¶æ•°æ®çš„èŠå¤©æ¶ˆæ¯
const preMessage = resultData.pre_message || resultData.message || 'æŸ¥è¯¢ç»“æœ'

chatHistory.addMessage({
  role: 'assistant',
  content: preMessage,
  componentData: componentData,  // âœ… ç¡®ä¿ç»„ä»¶æ•°æ®é™„åŠ åˆ°æ¶ˆæ¯
  timestamp: Date.now()
})
console.log('ğŸ¨ [UIæŒ‡ä»¤] å·²å°†ç»„ä»¶æ•°æ®æ·»åŠ åˆ°èŠå¤©æ¶ˆæ¯')
```

### ä¿®å¤2: ä¿®å¤å”¯ä¸€IDä¸åŒ¹é…é—®é¢˜

**é—®é¢˜**: `tool_call_start` å’Œ `tool_call_complete` ä½¿ç”¨ä¸åŒçš„ID

**ä¿®å¤æ–¹æ¡ˆ**: ç¡®ä¿åç«¯åœ¨ä¸¤ä¸ªäº‹ä»¶ä¸­ä½¿ç”¨ç›¸åŒçš„ID

**ä»£ç ä½ç½®**: `server/src/services/ai-operator/unified-intelligence.service.ts` ç¬¬1287-1450è¡Œ

**æ£€æŸ¥**: ç¡®è®¤ `toolCallId` åœ¨ `tool_call_start` å’Œ `tool_call_complete` ä¸­ä¿æŒä¸€è‡´

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ä¼˜å…ˆçº§1: ä¿®å¤ç»„ä»¶æ˜¾ç¤ºé—®é¢˜
- [ ] ä¿®æ”¹ `AIAssistantRefactored.vue` ç¬¬766-781è¡Œ
- [ ] ç¡®ä¿å³ä½¿ `preMessage` ä¸ºç©ºä¹Ÿåˆ›å»ºèŠå¤©æ¶ˆæ¯
- [ ] æµ‹è¯•éªŒè¯ç»„ä»¶æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

### ä¼˜å…ˆçº§2: ä¿®å¤å”¯ä¸€IDé—®é¢˜
- [ ] æ£€æŸ¥åç«¯ `unified-intelligence.service.ts` ä¸­çš„IDç”Ÿæˆé€»è¾‘
- [ ] ç¡®ä¿ `tool_call_start` å’Œ `tool_call_complete` ä½¿ç”¨ç›¸åŒID
- [ ] æµ‹è¯•éªŒè¯IDåŒ¹é…æ˜¯å¦æ­£ç¡®

### ä¼˜å…ˆçº§3: å®Œæ•´å›å½’æµ‹è¯•
- [ ] æµ‹è¯•å•ä¸ªå·¥å…·è°ƒç”¨
- [ ] æµ‹è¯•å¤šå·¥å…·å¹¶å‘è°ƒç”¨
- [ ] æµ‹è¯•å›¾è¡¨æ•°æ®æ¸²æŸ“
- [ ] æµ‹è¯•åˆ—è¡¨æ•°æ®æ¸²æŸ“

---

## ğŸ“Š æµ‹è¯•æ•°æ®

### å·¥å…·è°ƒç”¨ç»Ÿè®¡
- æ€»è°ƒç”¨æ¬¡æ•°: 2
- æˆåŠŸæ¬¡æ•°: 1 (any_query)
- å¤±è´¥æ¬¡æ•°: 1 (read_data_record)
- é™çº§æ¬¡æ•°: 1

### æ•°æ®è¿”å›ç»Ÿè®¡
- è¿”å›åˆ—æ•°: 27åˆ—
- è¿”å›è¡Œæ•°: 1è¡Œ
- UIæŒ‡ä»¤ç±»å‹: render_component âœ…
- ç»„ä»¶ç±»å‹: data-table âœ…

### å‰ç«¯å¤„ç†ç»Ÿè®¡
- UIæŒ‡ä»¤æ£€æµ‹: æˆåŠŸ âœ…
- ç»„ä»¶æ•°æ®åˆ›å»º: æˆåŠŸ âœ…
- ç»„ä»¶æ·»åŠ åˆ°åˆ—è¡¨: æˆåŠŸ âœ…
- ç»„ä»¶æ˜¾ç¤ºåœ¨é¡µé¢: å¤±è´¥ âŒ

---

## ğŸ¯ ç»“è®º

### âœ… æˆåŠŸçš„éƒ¨åˆ†
1. âœ… åç«¯æˆåŠŸè¿”å›æ­£ç¡®æ ¼å¼çš„UIæŒ‡ä»¤
2. âœ… å‰ç«¯æˆåŠŸæ£€æµ‹å¹¶å¤„ç†UIæŒ‡ä»¤
3. âœ… ç»„ä»¶æ•°æ®æ­£ç¡®åˆ›å»ºå’Œå­˜å‚¨
4. âœ… å·¥å…·è°ƒç”¨é™çº§ç­–ç•¥æ­£å¸¸å·¥ä½œ

### âš ï¸ éœ€è¦ä¿®å¤çš„éƒ¨åˆ†
1. âš ï¸ ç»„ä»¶æ•°æ®æœªæ­£ç¡®æ˜¾ç¤ºåœ¨èŠå¤©æ¶ˆæ¯ä¸­
2. âš ï¸ å”¯ä¸€IDä¸åŒ¹é…å¯¼è‡´å·¥å…·çŠ¶æ€æ›´æ–°å¤±è´¥

### ğŸš€ ä¿®å¤ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**: ä¿®å¤ç»„ä»¶æ˜¾ç¤ºé—®é¢˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
2. **ä¸­ä¼˜å…ˆçº§**: ä¿®å¤å”¯ä¸€IDé—®é¢˜ï¼ˆå½±å“å·¥å…·çŠ¶æ€ï¼‰
3. **ä½ä¼˜å…ˆçº§**: ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-10-13 20:00:00  
**æµ‹è¯•çŠ¶æ€**: éƒ¨åˆ†æˆåŠŸï¼Œéœ€è¦ä¿®å¤  
**ä¸‹ä¸€æ­¥**: ä¿®å¤ç»„ä»¶æ˜¾ç¤ºé—®é¢˜å¹¶é‡æ–°æµ‹è¯•

