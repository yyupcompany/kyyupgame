# ğŸ”§ å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ - æŠ€æœ¯æ ˆè¯¦è§£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è§£æå¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿä¸­ä½¿ç”¨çš„æŠ€æœ¯æ ˆï¼ŒåŒ…æ‹¬å‰ç«¯ã€åç«¯ã€æ•°æ®åº“ã€å·¥å…·é“¾ç­‰å„ä¸ªæ–¹é¢çš„æŠ€æœ¯é€‰å‹ã€ç‰ˆæœ¬ä¿¡æ¯ã€é…ç½®æ–¹æ³•å’Œæœ€ä½³å®è·µã€‚

### ğŸ¯ æŠ€æœ¯æ ˆä¸€è§ˆ

```
å‰ç«¯æŠ€æœ¯æ ˆ ğŸ¨
â”œâ”€â”€ Vue 3.5.16           # æ¸è¿›å¼JavaScriptæ¡†æ¶
â”œâ”€â”€ TypeScript 4.8.3     # JavaScriptè¶…é›†ï¼Œé™æ€ç±»å‹æ£€æŸ¥
â”œâ”€â”€ Element Plus 2.2.16  # Vue 3 UIç»„ä»¶åº“
â”œâ”€â”€ Vite 3.1.0          # å‰ç«¯æ„å»ºå·¥å…·
â”œâ”€â”€ Pinia 2.0.22        # Vue çŠ¶æ€ç®¡ç†åº“
â”œâ”€â”€ Vue Router 4.1.5    # Vue å®˜æ–¹è·¯ç”±å™¨
â”œâ”€â”€ Axios 1.6.7         # HTTPå®¢æˆ·ç«¯
â”œâ”€â”€ ECharts 5.4.3       # æ•°æ®å¯è§†åŒ–å›¾è¡¨åº“
â”œâ”€â”€ DayJS 1.11.13       # è½»é‡çº§æ—¥æœŸå¤„ç†åº“
â””â”€â”€ Sass 1.54.9         # CSSé¢„å¤„ç†å™¨

åç«¯æŠ€æœ¯æ ˆ ğŸš€
â”œâ”€â”€ Node.js 16+         # JavaScriptè¿è¡Œæ—¶
â”œâ”€â”€ Express.js          # Webåº”ç”¨æ¡†æ¶
â”œâ”€â”€ TypeScript          # ç±»å‹å®‰å…¨çš„JavaScript
â”œâ”€â”€ MySQL 8.0           # å…³ç³»å‹æ•°æ®åº“
â”œâ”€â”€ Sequelize           # Node.js ORM
â”œâ”€â”€ JWT                 # JSON Web Token
â”œâ”€â”€ Zod                 # è¿è¡Œæ—¶æ•°æ®éªŒè¯
â”œâ”€â”€ Swagger             # APIæ–‡æ¡£ç”Ÿæˆ
â”œâ”€â”€ PM2                 # Node.jsè¿›ç¨‹ç®¡ç†
â””â”€â”€ Docker              # å®¹å™¨åŒ–éƒ¨ç½²

å¼€å‘å·¥å…·é“¾ ğŸ› ï¸
â”œâ”€â”€ VS Code             # ä»£ç ç¼–è¾‘å™¨
â”œâ”€â”€ ESLint              # JavaScriptä»£ç æ£€æŸ¥
â”œâ”€â”€ Prettier            # ä»£ç æ ¼å¼åŒ–
â”œâ”€â”€ Vitest              # å•å…ƒæµ‹è¯•æ¡†æ¶
â”œâ”€â”€ Playwright          # ç«¯åˆ°ç«¯æµ‹è¯•
â”œâ”€â”€ Git                 # ç‰ˆæœ¬æ§åˆ¶
â”œâ”€â”€ GitHub Actions      # CI/CD
â””â”€â”€ Nginx               # WebæœåŠ¡å™¨
```

## ğŸ¨ å‰ç«¯æŠ€æœ¯æ ˆè¯¦è§£

### Vue 3.5.16 - æ ¸å¿ƒæ¡†æ¶

#### é€‰å‹ç†ç”±
- **Composition API** - æ›´å¥½çš„é€»è¾‘å¤ç”¨å’Œä»£ç ç»„ç»‡
- **æ›´å¥½çš„TypeScriptæ”¯æŒ** - åŸç”ŸTypeScriptæ”¯æŒ
- **æ€§èƒ½ä¼˜åŒ–** - Proxyå“åº”å¼ç³»ç»Ÿï¼Œæ›´å°çš„åŒ…ä½“ç§¯
- **ç”Ÿæ€æˆç†Ÿ** - ä¸°å¯Œçš„ç¬¬ä¸‰æ–¹åº“å’Œå·¥å…·é“¾

#### æ ¸å¿ƒç‰¹æ€§é…ç½®

```typescript
// main.ts - Vueåº”ç”¨åˆå§‹åŒ–
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import { createRouter } from 'vue-router'
import ElementPlus from 'element-plus'
import App from './App.vue'

const app = createApp(App)

// é…ç½®æ’ä»¶
app.use(createPinia())
app.use(createRouter(routerOptions))
app.use(ElementPlus)

// å…¨å±€é…ç½®
app.config.globalProperties.$ELEMENT = {
  size: 'default',
  zIndex: 3000
}

app.mount('#app')
```

#### Composition API ä½¿ç”¨ç¤ºä¾‹

```typescript
// ç»„åˆå¼APIæœ€ä½³å®è·µ
import { ref, reactive, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'

export default defineComponent({
  setup() {
    // å“åº”å¼æ•°æ®
    const loading = ref(false)
    const userForm = reactive({
      username: '',
      email: '',
      role: ''
    })
    
    // è®¡ç®—å±æ€§
    const isFormValid = computed(() => {
      return userForm.username && userForm.email
    })
    
    // ç”Ÿå‘½å‘¨æœŸ
    onMounted(() => {
      initializeData()
    })
    
    // æ–¹æ³•
    const handleSubmit = async () => {
      if (!isFormValid.value) return
      
      loading.value = true
      try {
        await submitUserForm(userForm)
        ElMessage.success('æ“ä½œæˆåŠŸ')
      } catch (error) {
        ElMessage.error('æ“ä½œå¤±è´¥')
      } finally {
        loading.value = false
      }
    }
    
    return {
      loading,
      userForm,
      isFormValid,
      handleSubmit
    }
  }
})
```

### TypeScript 4.8.3 - ç±»å‹ç³»ç»Ÿ

#### é…ç½®æ–‡ä»¶

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "preserve",
    "strict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"],
      "@/components/*": ["src/components/*"],
      "@/utils/*": ["src/utils/*"],
      "@/api/*": ["src/api/*"],
      "@/stores/*": ["src/stores/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

#### ç±»å‹å®šä¹‰ç¤ºä¾‹

```typescript
// types/api.ts - APIç±»å‹å®šä¹‰
export interface ApiResponse<T> {
  code: number
  message: string
  data: T
  success: boolean
  timestamp?: string
  total?: number
}

export interface PaginationParams {
  page: number
  pageSize: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}

export interface User {
  id: string
  username: string
  email: string
  role: UserRole
  department: string
  avatar?: string
  createdAt: string
  updatedAt: string
}

export type UserRole = 'admin' | 'principal' | 'teacher' | 'parent'

// types/route.ts - è·¯ç”±ç±»å‹å®šä¹‰
export interface RoutePermission {
  id: string
  path: string
  name: string
  component: string
  meta: RouteMeta
  children?: RoutePermission[]
}

export interface RouteMeta {
  title: string
  icon?: string
  roles: UserRole[]
  permissions?: string[]
  hidden?: boolean
  cache?: boolean
}
```

### Element Plus 2.2.16 - UIç»„ä»¶åº“

#### é€‰å‹ä¼˜åŠ¿
- **Vue 3 åŸç”Ÿæ”¯æŒ** - ä¸“ä¸ºVue 3è®¾è®¡
- **TypeScriptå‹å¥½** - å®Œæ•´çš„ç±»å‹å®šä¹‰
- **ç»„ä»¶ä¸°å¯Œ** - 60+é«˜è´¨é‡ç»„ä»¶
- **ä¸»é¢˜å®šåˆ¶** - æ”¯æŒæ·±åº¦å®šåˆ¶
- **å›½é™…åŒ–** - å¤šè¯­è¨€æ”¯æŒ

#### æŒ‰éœ€å¼•å…¥é…ç½®

```typescript
// vite.config.ts - æŒ‰éœ€å¼•å…¥é…ç½®
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      resolvers: [ElementPlusResolver()],
      dts: true,
    }),
    Components({
      resolvers: [ElementPlusResolver()],
      dts: true,
    }),
  ]
})
```

#### ä¸»é¢˜å®šåˆ¶

```scss
// styles/element-plus-unified.scss
@use "element-plus/theme-chalk/src/common/var.scss" as *;
@use "element-plus/theme-chalk/src/mixins/mixins" as *;

:root {
  // ä¸»è¦é¢œè‰²
  --el-color-primary: #1890ff;
  --el-color-success: #52c41a;
  --el-color-warning: #faad14;
  --el-color-danger: #ff4d4f;
  --el-color-info: #909399;
  
  // æ–‡å­—é¢œè‰²
  --el-text-color-primary: #303133;
  --el-text-color-regular: #606266;
  --el-text-color-secondary: #909399;
  --el-text-color-placeholder: #a8abb2;
  
  // è¾¹æ¡†é¢œè‰²
  --el-border-color: #dcdfe6;
  --el-border-color-light: #e4e7ed;
  --el-border-color-lighter: #ebeef5;
  --el-border-color-extra-light: #f2f6fc;
  
  // èƒŒæ™¯é¢œè‰²
  --el-bg-color: #ffffff;
  --el-bg-color-page: #f2f3f5;
  --el-bg-color-overlay: #ffffff;
  
  // ç§»åŠ¨ç«¯é€‚é…
  --el-component-size-large: 44px;
  --el-component-size: 36px;
  --el-component-size-small: 32px;
  
  // åœ†è§’
  --el-border-radius-base: 6px;
  --el-border-radius-small: 4px;
  --el-border-radius-round: 20px;
  --el-border-radius-circle: 100%;
}

// ç§»åŠ¨ç«¯ä¼˜åŒ–
@media (max-width: 768px) {
  .el-button {
    min-height: 44px;
    font-size: 16px;
  }
  
  .el-input__inner {
    height: 44px;
    font-size: 16px;
  }
  
  .el-form-item {
    margin-bottom: 16px;
  }
  
  .el-dialog {
    margin: 8px;
    max-height: calc(100vh - 16px);
  }
}
```

### Vite 3.1.0 - æ„å»ºå·¥å…·

#### é€‰å‹ä¼˜åŠ¿
- **æé€Ÿå¯åŠ¨** - ESMåŸç”Ÿæ”¯æŒï¼Œå¼€å‘æœåŠ¡å™¨ç§’çº§å¯åŠ¨
- **çƒ­æ›´æ–°å¿«** - HMRçƒ­æ¨¡å—æ›¿æ¢
- **æ’ä»¶ç”Ÿæ€** - ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€
- **TypeScriptåŸç”Ÿæ”¯æŒ** - æ— éœ€é¢å¤–é…ç½®

#### é…ç½®æ–‡ä»¶

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      imports: ['vue', 'vue-router', 'pinia'],
      resolvers: [ElementPlusResolver()],
      dts: true,
    }),
    Components({
      resolvers: [ElementPlusResolver()],
      dts: true,
    }),
  ],
  
  resolve: {
    alias: {
      '@': resolve(__dirname, './src'),
      '@/components': resolve(__dirname, './src/components'),
      '@/utils': resolve(__dirname, './src/utils'),
      '@/api': resolve(__dirname, './src/api'),
      '@/stores': resolve(__dirname, './src/stores'),
    }
  },
  
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        secure: false
      }
    }
  },
  
  build: {
    target: 'es2015',
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    minify: 'terser',
    rollupOptions: {
      output: {
        chunkFileNames: 'assets/js/[name]-[hash].js',
        entryFileNames: 'assets/js/[name]-[hash].js',
        assetFileNames: 'assets/[ext]/[name]-[hash].[ext]',
        manualChunks: {
          'element-plus': ['element-plus'],
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'utils': ['axios', 'dayjs', 'lodash-es']
        }
      }
    }
  },
  
  define: {
    __VUE_I18N_FULL_INSTALL__: true,
    __VUE_I18N_LEGACY_API__: false,
    __INTLIFY_PROD_DEVTOOLS__: false,
  }
})
```

### Pinia 2.0.22 - çŠ¶æ€ç®¡ç†

#### é€‰å‹ä¼˜åŠ¿
- **Vue 3 åŸç”Ÿæ”¯æŒ** - ä¸“ä¸ºVue 3å’ŒComposition APIè®¾è®¡
- **TypeScriptå‹å¥½** - å®Œæ•´çš„ç±»å‹æ¨æ–­
- **DevToolsæ”¯æŒ** - å®Œç¾çš„è°ƒè¯•ä½“éªŒ
- **æ¨¡å—åŒ–** - è‡ªç„¶çš„ä»£ç æ‹†åˆ†

#### Storeå®šä¹‰ç¤ºä¾‹

```typescript
// stores/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { User, UserRole } from '@/types/user'
import { login, logout, getUserInfo } from '@/api/auth'

export const useUserStore = defineStore('user', () => {
  // çŠ¶æ€
  const userInfo = ref<User | null>(null)
  const token = ref<string>('')
  const permissions = ref<string[]>([])
  const roles = ref<UserRole[]>([])
  
  // è®¡ç®—å±æ€§
  const isLoggedIn = computed(() => !!token.value)
  const isAdmin = computed(() => roles.value.includes('admin'))
  const isPrincipal = computed(() => roles.value.includes('principal'))
  const isTeacher = computed(() => roles.value.includes('teacher'))
  const isParent = computed(() => roles.value.includes('parent'))
  
  const currentRole = computed(() => {
    if (isAdmin.value) return 'admin'
    if (isPrincipal.value) return 'principal'
    if (isTeacher.value) return 'teacher'
    if (isParent.value) return 'parent'
    return null
  })
  
  // åŠ¨ä½œ
  const setToken = (newToken: string) => {
    token.value = newToken
    localStorage.setItem('token', newToken)
  }
  
  const setUserInfo = (user: User) => {
    userInfo.value = user
    roles.value = [user.role]
  }
  
  const setPermissions = (perms: string[]) => {
    permissions.value = perms
  }
  
  const loginUser = async (credentials: LoginCredentials) => {
    try {
      const response = await login(credentials)
      setToken(response.token)
      setUserInfo(response.user)
      setPermissions(response.permissions)
      return response
    } catch (error) {
      throw error
    }
  }
  
  const logoutUser = async () => {
    try {
      await logout()
    } finally {
      token.value = ''
      userInfo.value = null
      permissions.value = []
      roles.value = []
      localStorage.removeItem('token')
    }
  }
  
  const fetchUserInfo = async () => {
    if (!token.value) return
    
    try {
      const response = await getUserInfo()
      setUserInfo(response.user)
      setPermissions(response.permissions)
    } catch (error) {
      // Tokenå¯èƒ½è¿‡æœŸï¼Œæ¸…é™¤çŠ¶æ€
      logoutUser()
      throw error
    }
  }
  
  const hasPermission = (permission: string) => {
    return permissions.value.includes(permission)
  }
  
  const hasRole = (role: UserRole) => {
    return roles.value.includes(role)
  }
  
  const hasAnyRole = (roleList: UserRole[]) => {
    return roleList.some(role => roles.value.includes(role))
  }
  
  return {
    // çŠ¶æ€
    userInfo,
    token,
    permissions,
    roles,
    
    // è®¡ç®—å±æ€§
    isLoggedIn,
    isAdmin,
    isPrincipal,
    isTeacher,
    isParent,
    currentRole,
    
    // åŠ¨ä½œ
    setToken,
    setUserInfo,
    setPermissions,
    loginUser,
    logoutUser,
    fetchUserInfo,
    hasPermission,
    hasRole,
    hasAnyRole
  }
})
```

### Vue Router 4.1.5 - è·¯ç”±ç®¡ç†

#### åŠ¨æ€è·¯ç”±é…ç½®

```typescript
// router/index.ts
import { createRouter, createWebHistory } from 'vue-router'
import type { RouteRecordRaw } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { generateDynamicRoutes } from './dynamic-routes'

// é™æ€è·¯ç”±
const staticRoutes: RouteRecordRaw[] = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/pages/Login/index.vue'),
    meta: { title: 'ç”¨æˆ·ç™»å½•', requiresAuth: false }
  },
  {
    path: '/404',
    name: 'NotFound',
    component: () => import('@/pages/404.vue'),
    meta: { title: 'é¡µé¢ä¸å­˜åœ¨' }
  },
  {
    path: '/',
    redirect: '/dashboard'
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes: staticRoutes
})

// è·¯ç”±å®ˆå«
router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore()
  const requiresAuth = to.meta?.requiresAuth !== false
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  if (requiresAuth && !userStore.isLoggedIn) {
    next('/login')
    return
  }
  
  // åŠ¨æ€æ·»åŠ è·¯ç”±
  if (userStore.isLoggedIn && router.getRoutes().length <= 3) {
    try {
      const dynamicRoutes = await generateDynamicRoutes()
      dynamicRoutes.forEach(route => {
        router.addRoute(route)
      })
      next({ ...to, replace: true })
      return
    } catch (error) {
      console.error('Failed to generate dynamic routes:', error)
      next('/login')
      return
    }
  }
  
  // æƒé™æ£€æŸ¥
  if (to.meta?.permissions) {
    const hasPermission = (to.meta.permissions as string[])
      .some(permission => userStore.hasPermission(permission))
    
    if (!hasPermission) {
      next('/403')
      return
    }
  }
  
  next()
})

export default router
```

### Axios 1.6.7 - HTTPå®¢æˆ·ç«¯

#### è¯·æ±‚æ‹¦æˆªå™¨é…ç½®

```typescript
// utils/request.ts
import axios, { type AxiosResponse, type InternalAxiosRequestConfig } from 'axios'
import { ElMessage, ElLoading } from 'element-plus'
import { useUserStore } from '@/stores/user'
import router from '@/router'
import type { ApiResponse } from '@/types/api'

// åˆ›å»ºaxioså®ä¾‹
const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
})

let loadingInstance: any = null
let requestCount = 0

// æ˜¾ç¤ºloading
const showLoading = () => {
  if (requestCount === 0) {
    loadingInstance = ElLoading.service({
      text: 'åŠ è½½ä¸­...',
      background: 'rgba(0, 0, 0, 0.7)'
    })
  }
  requestCount++
}

// éšè—loading
const hideLoading = () => {
  requestCount--
  if (requestCount <= 0) {
    requestCount = 0
    loadingInstance?.close()
    loadingInstance = null
  }
}

// è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(
  (config: InternalAxiosRequestConfig) => {
    // æ˜¾ç¤ºloadingï¼ˆæŸäº›æ¥å£ä¸éœ€è¦ï¼‰
    if (!config.hideLoading) {
      showLoading()
    }
    
    // æ·»åŠ è®¤è¯token
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers['Authorization'] = `Bearer ${userStore.token}`
    }
    
    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
    if (config.method === 'get') {
      config.params = {
        ...config.params,
        _t: Date.now()
      }
    }
    
    return config
  },
  (error) => {
    hideLoading()
    ElMessage.error('è¯·æ±‚é…ç½®é”™è¯¯')
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  (response: AxiosResponse<ApiResponse<any>>) => {
    hideLoading()
    
    const { data } = response
    
    // å¤„ç†ä¸šåŠ¡é”™è¯¯
    if (!data.success) {
      ElMessage.error(data.message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(data.message || 'è¯·æ±‚å¤±è´¥'))
    }
    
    return data
  },
  (error) => {
    hideLoading()
    
    if (error.response) {
      const { status, data } = error.response
      
      switch (status) {
        case 401:
          ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
          const userStore = useUserStore()
          userStore.logoutUser()
          router.push('/login')
          break
        case 403:
          ElMessage.error('æƒé™ä¸è¶³ï¼Œç¦æ­¢è®¿é—®')
          break
        case 404:
          ElMessage.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')
          break
        case 500:
          ElMessage.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
          break
        default:
          ElMessage.error(data?.message || 'ç½‘ç»œé”™è¯¯')
      }
    } else if (error.request) {
      ElMessage.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ')
    } else {
      ElMessage.error('è¯·æ±‚é…ç½®é”™è¯¯')
    }
    
    return Promise.reject(error)
  }
)

export default request

// æ‰©å±•axiosç±»å‹
declare module 'axios' {
  interface AxiosRequestConfig {
    hideLoading?: boolean
  }
}
```

## ğŸš€ åç«¯æŠ€æœ¯æ ˆè¯¦è§£

### Node.js 16+ & Express.js - æœåŠ¡ç«¯æ¡†æ¶

#### Expressåº”ç”¨é…ç½®

```typescript
// server/src/app.ts
import express, { Application } from 'express'
import cors from 'cors'
import helmet from 'helmet'
import compression from 'compression'
import rateLimit from 'express-rate-limit'
import { errorHandler } from './middlewares/error.middleware'
import { requestLogger } from './middlewares/logger.middleware'
import routes from './routes'

const app: Application = express()

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  }
}))

// CORSé…ç½®
app.use(cors({
  origin: process.env.NODE_ENV === 'production' 
    ? ['https://localhost:5173'] 
    : ['http://localhost:5173', 'http://localhost:5173:5173'],
  credentials: true,
  optionsSuccessStatus: 200
}))

// å‹ç¼©ä¸­é—´ä»¶
app.use(compression())

// é™æµä¸­é—´ä»¶
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // æœ€å¤š100ä¸ªè¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
})
app.use('/api/', limiter)

// è§£æä¸­é—´ä»¶
app.use(express.json({ limit: '10mb' }))
app.use(express.urlencoded({ extended: true }))

// è¯·æ±‚æ—¥å¿—
app.use(requestLogger)

// è·¯ç”±
app.use('/api', routes)

// é”™è¯¯å¤„ç†
app.use(errorHandler)

export default app
```

### MySQL 8.0 & Sequelize - æ•°æ®åº“

#### Sequelizeé…ç½®

```typescript
// server/src/config/database.ts
import { Sequelize } from 'sequelize'
import mysql2 from 'mysql2'

const sequelize = new Sequelize({
  dialect: 'mysql',
  dialectModule: mysql2,
  host: process.env.DB_HOST || 'localhost',
  port: Number(process.env.DB_PORT) || 3306,
  database: process.env.DB_NAME || 'kindergarten_db',
  username: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  
  // è¿æ¥æ± é…ç½®
  pool: {
    max: 20,
    min: 0,
    acquire: 60000,
    idle: 10000
  },
  
  // æ—¥å¿—é…ç½®
  logging: process.env.NODE_ENV === 'development' ? console.log : false,
  
  // æ—¶åŒºé…ç½®
  timezone: '+08:00',
  
  // è¿æ¥é…ç½®
  dialectOptions: {
    charset: 'utf8mb4',
    collate: 'utf8mb4_unicode_ci',
    dateStrings: true,
    typeCast: true
  },
  
  // å®šä¹‰é…ç½®
  define: {
    timestamps: true,
    createdAt: 'created_at',
    updatedAt: 'updated_at',
    underscored: true,
    charset: 'utf8mb4',
    collate: 'utf8mb4_unicode_ci'
  }
})

export default sequelize
```

#### æ¨¡å‹å®šä¹‰ç¤ºä¾‹

```typescript
// server/src/models/User.model.ts
import { DataTypes, Model, Optional } from 'sequelize'
import sequelize from '../config/database'
import bcrypt from 'bcrypt'

export interface UserAttributes {
  id: string
  username: string
  email: string
  password: string
  role: 'admin' | 'principal' | 'teacher' | 'parent'
  department?: string
  avatar?: string
  isActive: boolean
  lastLoginAt?: Date
  createdAt?: Date
  updatedAt?: Date
}

export interface UserCreationAttributes extends Optional<UserAttributes, 'id' | 'createdAt' | 'updatedAt'> {}

class User extends Model<UserAttributes, UserCreationAttributes> implements UserAttributes {
  public id!: string
  public username!: string
  public email!: string
  public password!: string
  public role!: 'admin' | 'principal' | 'teacher' | 'parent'
  public department?: string
  public avatar?: string
  public isActive!: boolean
  public lastLoginAt?: Date
  public readonly createdAt!: Date
  public readonly updatedAt!: Date

  // å®ä¾‹æ–¹æ³•
  public async comparePassword(password: string): Promise<boolean> {
    return bcrypt.compare(password, this.password)
  }

  public toJSON() {
    const values = Object.assign({}, this.get())
    delete values.password
    return values
  }
}

User.init(
  {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    username: {
      type: DataTypes.STRING(50),
      allowNull: false,
      unique: true,
      validate: {
        len: [2, 50]
      }
    },
    email: {
      type: DataTypes.STRING(100),
      allowNull: false,
      unique: true,
      validate: {
        isEmail: true
      }
    },
    password: {
      type: DataTypes.STRING(255),
      allowNull: false,
      validate: {
        len: [6, 255]
      }
    },
    role: {
      type: DataTypes.ENUM('admin', 'principal', 'teacher', 'parent'),
      allowNull: false,
      defaultValue: 'parent'
    },
    department: {
      type: DataTypes.STRING(100),
      allowNull: true
    },
    avatar: {
      type: DataTypes.TEXT,
      allowNull: true
    },
    isActive: {
      type: DataTypes.BOOLEAN,
      allowNull: false,
      defaultValue: true
    },
    lastLoginAt: {
      type: DataTypes.DATE,
      allowNull: true
    }
  },
  {
    sequelize,
    tableName: 'users',
    modelName: 'User',
    
    hooks: {
      beforeSave: async (user: User) => {
        if (user.changed('password')) {
          const salt = await bcrypt.genSalt(10)
          user.password = await bcrypt.hash(user.password, salt)
        }
      }
    },
    
    indexes: [
      { fields: ['email'] },
      { fields: ['username'] },
      { fields: ['role'] },
      { fields: ['isActive'] }
    ]
  }
)

export default User
```

### JWT - èº«ä»½è®¤è¯

```typescript
// server/src/utils/jwt.ts
import jwt from 'jsonwebtoken'
import type { UserAttributes } from '../models/User.model'

interface JWTPayload {
  userId: string
  username: string
  role: string
  iat: number
  exp: number
}

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'
const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d'

export const generateToken = (user: UserAttributes): string => {
  const payload = {
    userId: user.id,
    username: user.username,
    role: user.role
  }

  return jwt.sign(payload, JWT_SECRET, {
    expiresIn: JWT_EXPIRES_IN,
    issuer: 'kindergarten-system',
    audience: 'kindergarten-users'
  })
}

export const verifyToken = (token: string): JWTPayload => {
  try {
    return jwt.verify(token, JWT_SECRET) as JWTPayload
  } catch (error) {
    if (error instanceof jwt.TokenExpiredError) {
      throw new Error('Tokenå·²è¿‡æœŸ')
    } else if (error instanceof jwt.JsonWebTokenError) {
      throw new Error('Tokenæ— æ•ˆ')
    } else {
      throw new Error('TokenéªŒè¯å¤±è´¥')
    }
  }
}

export const refreshToken = (oldToken: string): string => {
  try {
    const decoded = jwt.verify(oldToken, JWT_SECRET, { ignoreExpiration: true }) as JWTPayload
    
    // æ£€æŸ¥tokenæ˜¯å¦åœ¨å¯åˆ·æ–°æ—¶é—´èŒƒå›´å†…ï¼ˆæ¯”å¦‚è¿‡æœŸå1å°æ—¶å†…ï¼‰
    const now = Math.floor(Date.now() / 1000)
    const maxRefreshTime = decoded.exp + 3600 // è¿‡æœŸå1å°æ—¶
    
    if (now > maxRefreshTime) {
      throw new Error('Tokenè¿‡æœŸæ—¶é—´è¿‡é•¿ï¼Œæ— æ³•åˆ·æ–°')
    }
    
    const payload = {
      userId: decoded.userId,
      username: decoded.username,
      role: decoded.role
    }
    
    return jwt.sign(payload, JWT_SECRET, {
      expiresIn: JWT_EXPIRES_IN,
      issuer: 'kindergarten-system',
      audience: 'kindergarten-users'
    })
  } catch (error) {
    throw new Error('Tokenåˆ·æ–°å¤±è´¥')
  }
}
```

## ğŸ› ï¸ å¼€å‘å·¥å…·é“¾è¯¦è§£

### ESLint + Prettier - ä»£ç è§„èŒƒ

#### ESLinté…ç½®

```json
// .eslintrc.json
{
  "root": true,
  "env": {
    "browser": true,
    "es2020": true,
    "node": true
  },
  "extends": [
    "eslint:recommended",
    "@typescript-eslint/recommended",
    "@vue/eslint-config-typescript",
    "@vue/eslint-config-prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": ["@typescript-eslint", "vue"],
  "rules": {
    "@typescript-eslint/no-unused-vars": ["error", { "argsIgnorePattern": "^_" }],
    "@typescript-eslint/explicit-function-return-type": "off",
    "@typescript-eslint/explicit-module-boundary-types": "off",
    "@typescript-eslint/no-explicit-any": "warn",
    "vue/multi-word-component-names": "off",
    "vue/no-unused-vars": "error",
    "prefer-const": "error",
    "no-console": "warn",
    "no-debugger": "error"
  }
}
```

#### Prettieré…ç½®

```json
// .prettierrc.json
{
  "semi": false,
  "singleQuote": true,
  "trailingComma": "es5",
  "tabWidth": 2,
  "useTabs": false,
  "printWidth": 100,
  "endOfLine": "lf",
  "arrowParens": "avoid",
  "vueIndentScriptAndStyle": false
}
```

### Vitest - å•å…ƒæµ‹è¯•

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  test: {
    globals: true,
    environment: 'happy-dom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'dist/',
        '**/*.d.ts',
        'src/main.ts'
      ]
    }
  },
  resolve: {
    alias: {
      '@': resolve(__dirname, './src')
    }
  }
})
```

### Playwright - E2Eæµ‹è¯•

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
})
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å·¥å…·

### ä»£ç åˆ†å‰²é…ç½®

```typescript
// åœ¨Viteé…ç½®ä¸­çš„ä»£ç åˆ†å‰²
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // Vueæ ¸å¿ƒ
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          // UIåº“
          'element-plus': ['element-plus', '@element-plus/icons-vue'],
          // å·¥å…·åº“
          'utils': ['axios', 'dayjs', 'lodash-es'],
          // å›¾è¡¨åº“
          'charts': ['echarts'],
          // AIç›¸å…³
          'ai-modules': [
            './src/pages/ai/AIAssistantPage.vue',
            './src/pages/ai/ChatInterface.vue',
            './src/components/ai'
          ]
        }
      }
    }
  }
})
```

### ç¼“å­˜ç­–ç•¥

```typescript
// æœåŠ¡ç«¯ç¼“å­˜é…ç½®
import NodeCache from 'node-cache'

// åˆ›å»ºä¸åŒç±»å‹çš„ç¼“å­˜
export const apiCache = new NodeCache({ 
  stdTTL: 300,  // 5åˆ†é’Ÿ
  checkperiod: 60 
})

export const userCache = new NodeCache({ 
  stdTTL: 1800,  // 30åˆ†é’Ÿ
  checkperiod: 120 
})

export const routeCache = new NodeCache({ 
  stdTTL: 3600,  // 1å°æ—¶
  checkperiod: 300 
})

// ç¼“å­˜ä¸­é—´ä»¶
export const cacheMiddleware = (cacheName: string, ttl?: number) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const key = `${req.method}:${req.originalUrl}`
    const cache = cacheName === 'api' ? apiCache : userCache
    
    const cachedData = cache.get(key)
    if (cachedData) {
      return res.json(cachedData)
    }
    
    // é‡å†™res.jsonæ–¹æ³•ï¼Œåœ¨å“åº”æ—¶ç¼“å­˜æ•°æ®
    const originalJson = res.json
    res.json = function(data) {
      cache.set(key, data, ttl)
      return originalJson.call(this, data)
    }
    
    next()
  }
}
```

## ğŸ¯ æŠ€æœ¯æ ˆä¼˜åŠ¿æ€»ç»“

### 1. å¼€å‘æ•ˆç‡é«˜
- **Vue 3 + TypeScript** - ç°ä»£åŒ–å¼€å‘ä½“éªŒï¼Œç±»å‹å®‰å…¨
- **Element Plus** - ä¸°å¯Œçš„UIç»„ä»¶ï¼Œå¿«é€Ÿæ„å»ºç•Œé¢
- **Vite** - æé€Ÿçš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºå·¥å…·
- **è‡ªåŠ¨å¯¼å…¥** - å‡å°‘é‡å¤çš„importè¯­å¥

### 2. æ€§èƒ½è¡¨ç°ä¼˜ç§€
- **ç»„ä»¶æ‡’åŠ è½½** - æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘åˆå§‹åŒ…ä½“ç§¯
- **ä»£ç åˆ†å‰²** - åˆç†çš„chunkåˆ’åˆ†
- **ç¼“å­˜ç­–ç•¥** - å¤šçº§ç¼“å­˜æå‡å“åº”é€Ÿåº¦
- **å‹ç¼©ä¼˜åŒ–** - Gzip/Brotliå‹ç¼©

### 3. å¼€å‘ä½“éªŒå¥½
- **çƒ­æ¨¡å—æ›¿æ¢** - å¼€å‘æ—¶å³æ—¶æ›´æ–°
- **TypeScript** - ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
- **ESLint/Prettier** - ç»Ÿä¸€çš„ä»£ç é£æ ¼
- **è‡ªåŠ¨åŒ–æµ‹è¯•** - å•å…ƒæµ‹è¯•å’ŒE2Eæµ‹è¯•

### 4. ç”Ÿäº§ç¯å¢ƒç¨³å®š
- **å®¹å™¨åŒ–éƒ¨ç½²** - Dockeræ”¯æŒ
- **è¿›ç¨‹ç®¡ç†** - PM2é›†ç¾¤æ¨¡å¼
- **ç›‘æ§å‘Šè­¦** - æ€§èƒ½å’Œé”™è¯¯ç›‘æ§
- **å®‰å…¨é˜²æŠ¤** - å¤šå±‚å®‰å…¨é˜²æŠ¤

### 5. å¯ç»´æŠ¤æ€§å¼º
- **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„ä»£ç ç»„ç»‡
- **ç»„ä»¶åŒ–å¼€å‘** - å¯å¤ç”¨çš„ç»„ä»¶
- **æ–‡æ¡£å®Œå–„** - APIæ–‡æ¡£å’Œå¼€å‘æ–‡æ¡£
- **ç‰ˆæœ¬æ§åˆ¶** - Gitå·¥ä½œæµ

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [å¿«é€Ÿå¼€å§‹æŒ‡å—](./03-å¿«é€Ÿå¼€å§‹æŒ‡å—.md) äº†è§£å¦‚ä½•å¿«é€Ÿæ­å»ºå¼€å‘ç¯å¢ƒã€‚

*æ–‡æ¡£ç‰ˆæœ¬: v1.0.0*  
*æ›´æ–°æ—¶é—´: 2025-08-10*  
*åŸºäºå®é™…é¡¹ç›®é…ç½®æ•´ç†*