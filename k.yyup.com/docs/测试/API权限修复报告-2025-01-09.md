# APIæƒé™ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-01-09  
**ä¿®å¤äººå‘˜**: AI Assistant  
**é—®é¢˜æ¥æº**: æ•™å¸ˆè§’è‰²å®Œæ•´æµ‹è¯•  
**ä¿®å¤åˆ†æ”¯**: AIDEBUG1

---

## ğŸ“‹ é—®é¢˜æ€»ç»“

åœ¨æ•™å¸ˆè§’è‰²å®Œæ•´æµ‹è¯•ä¸­ï¼Œå‘ç°3ä¸ªAPIæ— æ³•è®¿é—®ï¼š

| API | é”™è¯¯ | åŸå›  |
|-----|------|------|
| `GET /activities/statistics` | 403 Forbidden | æƒé™æ£€æŸ¥é—®é¢˜ |
| `GET /teacher/customers/stats` | 404 Not Found | è·¯ç”±æœªæ³¨å†Œ |
| `GET /teacher/customers/list` | 404 Not Found | è·¯ç”±æœªæ³¨å†Œ |
| `GET /teacher/customers/conversion-funnel` | 404 Not Found | è·¯ç”±æœªæ³¨å†Œ |

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1: æ´»åŠ¨ç»Ÿè®¡API 403é”™è¯¯

**å‰ç«¯è°ƒç”¨**:
```typescript
// client/src/api/modules/activity.ts
GET /api/activities/statistics
```

**åç«¯è·¯ç”±**:
```typescript
// server/src/routes/activities.routes.ts (ç¬¬351è¡Œ)
router.get('/statistics', verifyToken, checkPermission('ACTIVITY_VIEW'), activityController.getStatistics);
```

**æƒé™é…ç½®**:
```typescript
// server/src/config/role-mapping.ts (ç¬¬184è¡Œ)
// æ•™å¸ˆè§’è‰²å·²é…ç½® ACTIVITY_VIEW æƒé™
permissions.ACTIVITY_VIEW,
```

**æƒé™æ£€æŸ¥ä¸­é—´ä»¶**:
```typescript
// server/src/middlewares/auth.middleware.ts (ç¬¬244è¡Œ)
// ä½¿ç”¨ p.code å­—æ®µæŸ¥è¯¢æƒé™
WHERE ur.user_id = ? AND p.code = ? AND p.status = 1
```

**æ ¹æœ¬åŸå› **:
- æƒé™æ£€æŸ¥ä¸­é—´ä»¶ä½¿ç”¨ `p.code` å­—æ®µ
- ä½†ä¼ å…¥çš„æ˜¯ `'ACTIVITY_VIEW'`ï¼ˆåº”è¯¥æ˜¯ permission å­—æ®µçš„å€¼ï¼‰
- éœ€è¦ç¡®è®¤æ•°æ®åº“ä¸­æƒé™è®°å½•çš„ code å­—æ®µå€¼

---

### é—®é¢˜2: æ•™å¸ˆå®¢æˆ·API 404é”™è¯¯

**å‰ç«¯è°ƒç”¨**:
```typescript
// client/src/api/modules/teacher.ts (ç¬¬342è¡Œ)
GET /api/teacher/customers/stats
GET /api/teacher/customers/list
GET /api/teacher/customers/{customerId}/follow
```

**åç«¯è·¯ç”±**:
```typescript
// server/src/routes/teacher-customers.routes.ts
router.get('/stats', TeacherCustomersController.getCustomerStats);
router.get('/list', TeacherCustomersController.getCustomerList);
router.get('/conversion-funnel', TeacherCustomersController.getConversionFunnel);
```

**è·¯ç”±æ³¨å†Œ**:
```typescript
// server/src/routes/index.ts
// âŒ æœªæ‰¾åˆ° router.use('/teacher-customers', teacherCustomersRoutes);
```

**æ ¹æœ¬åŸå› **:
- åç«¯è·¯ç”±æ–‡ä»¶å­˜åœ¨: `teacher-customers.routes.ts`
- ä½†æœªåœ¨ä¸»è·¯ç”±æ–‡ä»¶ `index.ts` ä¸­æ³¨å†Œ
- å‰ç«¯è°ƒç”¨è·¯å¾„: `/api/teacher/customers/*`
- åç«¯è·¯ç”±è·¯å¾„: `/api/teacher-customers/*`ï¼ˆå¦‚æœæ³¨å†Œçš„è¯ï¼‰

**è·¯å¾„ä¸åŒ¹é…é—®é¢˜**:
- å‰ç«¯æœŸæœ›: `/api/teacher/customers/*`
- åç«¯å®é™…: `/api/teacher-customers/*`ï¼ˆæ³¨å†Œåï¼‰
- éœ€è¦ä¿®æ”¹è·¯ç”±æ³¨å†Œè·¯å¾„æˆ–å‰ç«¯è°ƒç”¨è·¯å¾„

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: æ³¨å†Œæ•™å¸ˆå®¢æˆ·è·¯ç”±

**æ–‡ä»¶**: `server/src/routes/index.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬1020-1026è¡Œ

**ä¿®æ”¹å‰**:
```typescript
// æ´»åŠ¨ç®¡ç†è·¯ç”±
router.use('/activities', activitiesRoutes);
router.use('/activity-plans', activityPlanRoutes);
router.use('/activity-templates', activityTemplateRoutes);
router.use('/activity-registrations', activityRegistrationRoutes);
router.use('/activity-checkins', activityCheckinRoutes);
router.use('/activity-evaluations', activityEvaluationRoutes);
```

**ä¿®æ”¹å**:
```typescript
// æ´»åŠ¨ç®¡ç†è·¯ç”±
router.use('/activities', activitiesRoutes);
router.use('/activity-plans', activityPlanRoutes);
router.use('/activity-templates', activityTemplateRoutes);
router.use('/activity-registrations', activityRegistrationRoutes);
router.use('/activity-checkins', activityCheckinRoutes);
router.use('/activity-evaluations', activityEvaluationRoutes);

// æ•™å¸ˆå®¢æˆ·ç®¡ç†è·¯ç”±
router.use('/teacher-customers', teacherCustomersRoutes);
```

**è¯´æ˜**:
- âœ… æ³¨å†Œæ•™å¸ˆå®¢æˆ·è·¯ç”±
- âš ï¸ è·¯å¾„ä¸º `/teacher-customers`ï¼Œä¸å‰ç«¯è°ƒç”¨è·¯å¾„ `/teacher/customers` ä¸åŒ¹é…
- éœ€è¦è¿›ä¸€æ­¥ä¿®å¤è·¯å¾„é—®é¢˜

---

### ä¿®å¤2: ä¿®å¤è·¯å¾„ä¸åŒ¹é…é—®é¢˜

**æ–¹æ¡ˆA: ä¿®æ”¹åç«¯è·¯ç”±æ³¨å†Œè·¯å¾„**ï¼ˆæ¨èï¼‰

```typescript
// server/src/routes/index.ts
router.use('/teacher/customers', teacherCustomersRoutes);
```

**ä¼˜ç‚¹**:
- åªéœ€ä¿®æ”¹ä¸€å¤„
- å‰ç«¯ä»£ç æ— éœ€æ”¹åŠ¨
- ç¬¦åˆRESTfulè§„èŒƒ

**æ–¹æ¡ˆB: ä¿®æ”¹å‰ç«¯è°ƒç”¨è·¯å¾„**

```typescript
// client/src/api/modules/teacher.ts
// å°†æ‰€æœ‰ /api/teacher/customers/* æ”¹ä¸º /api/teacher-customers/*
```

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹å¤šä¸ªæ–‡ä»¶
- å¯èƒ½å½±å“å…¶ä»–åŠŸèƒ½

**é€‰æ‹©**: æ–¹æ¡ˆA

---

### ä¿®å¤3: æ£€æŸ¥æ´»åŠ¨ç»Ÿè®¡æƒé™

**éœ€è¦ç¡®è®¤çš„å†…å®¹**:

1. æ•°æ®åº“ä¸­æƒé™è®°å½•çš„ `code` å­—æ®µå€¼
2. æƒé™æ£€æŸ¥ä¸­é—´ä»¶ä½¿ç”¨çš„å­—æ®µ
3. è·¯ç”±ä¸­ä¼ å…¥çš„æƒé™ä»£ç 

**æ£€æŸ¥SQL**:
```sql
SELECT id, name, code, permission 
FROM permissions 
WHERE permission LIKE '%ACTIVITY%' OR code LIKE '%activity%'
ORDER BY id;
```

**å¯èƒ½çš„æƒ…å†µ**:

**æƒ…å†µ1**: code å­—æ®µå€¼ä¸º 'ACTIVITY_VIEW'
- âœ… æƒé™æ£€æŸ¥æ­£å¸¸
- é—®é¢˜å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹

**æƒ…å†µ2**: code å­—æ®µå€¼ä¸º 'activity'
- âŒ æƒé™æ£€æŸ¥å¤±è´¥
- éœ€è¦ä¿®æ”¹è·¯ç”±ä¸­çš„æƒé™ä»£ç : `checkPermission('activity')`

**æƒ…å†µ3**: æƒé™è®°å½•ä¸å­˜åœ¨
- âŒ æƒé™æ£€æŸ¥å¤±è´¥
- éœ€è¦æ·»åŠ æƒé™è®°å½•

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹è·¯ç”±æ³¨å†Œè·¯å¾„

```typescript
// server/src/routes/index.ts (ç¬¬1029è¡Œ)
router.use('/teacher/customers', teacherCustomersRoutes);
```

### æ­¥éª¤2: é‡å¯åç«¯æœåŠ¡

```bash
npm run stop
npm run start:backend
```

### æ­¥éª¤3: æµ‹è¯•æ•™å¸ˆå®¢æˆ·API

```bash
# æµ‹è¯•å®¢æˆ·ç»Ÿè®¡
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/teacher/customers/stats

# æµ‹è¯•å®¢æˆ·åˆ—è¡¨
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/teacher/customers/list

# æµ‹è¯•è½¬åŒ–æ¼æ–—
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/teacher/customers/conversion-funnel
```

### æ­¥éª¤4: æ£€æŸ¥æ´»åŠ¨ç»Ÿè®¡æƒé™

**æ–¹æ³•1**: æŸ¥çœ‹åç«¯æ—¥å¿—
- å¯åŠ¨åç«¯æœåŠ¡
- è°ƒç”¨æ´»åŠ¨ç»Ÿè®¡API
- æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„æƒé™æ£€æŸ¥æ—¥å¿—

**æ–¹æ³•2**: ä¿®æ”¹æƒé™ä»£ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
```typescript
// server/src/routes/activities.routes.ts (ç¬¬351è¡Œ)
// å¦‚æœæ•°æ®åº“ä¸­ code å­—æ®µä¸º 'activity'
router.get('/statistics', verifyToken, checkPermission('activity'), activityController.getStatistics);
```

### æ­¥éª¤5: æµ‹è¯•æ´»åŠ¨ç»Ÿè®¡API

```bash
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/activities/statistics
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### æ•™å¸ˆå®¢æˆ·API

**è¯·æ±‚**:
```
GET /api/teacher/customers/stats
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "totalCustomers": 0,
    "todayFollows": 0,
    "pendingFollows": 3,
    "successRate": 0
  }
}
```

**è¯·æ±‚**:
```
GET /api/teacher/customers/list?page=1&pageSize=10
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "list": [...],
    "total": 4,
    "page": 1,
    "pageSize": 10
  }
}
```

### æ´»åŠ¨ç»Ÿè®¡API

**è¯·æ±‚**:
```
GET /api/activities/statistics
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "totalActivities": 15,
    "upcomingActivities": 3,
    "ongoingActivities": 2,
    "completedActivities": 10
  }
}
```

---

## ğŸ“ ä¿®å¤è®°å½•

**ä¿®å¤æ—¶é—´**: 2025-01-09  
**ä¿®å¤æ–‡ä»¶**: 1ä¸ª
- `server/src/routes/index.ts`

**ä»£ç å˜æ›´**: 2è¡Œ
- æ–°å¢: 2è¡Œï¼ˆæ³¨å†Œæ•™å¸ˆå®¢æˆ·è·¯ç”±ï¼‰

**Gitæäº¤**: å¾…æäº¤
```bash
git add server/src/routes/index.ts
git commit -m "fix: æ³¨å†Œæ•™å¸ˆå®¢æˆ·ç®¡ç†è·¯ç”±

é—®é¢˜:
- æ•™å¸ˆå®¢æˆ·APIè¿”å›404é”™è¯¯
- è·¯ç”±æ–‡ä»¶å­˜åœ¨ä½†æœªæ³¨å†Œ

ä¿®å¤:
- åœ¨ server/src/routes/index.ts ä¸­æ³¨å†Œæ•™å¸ˆå®¢æˆ·è·¯ç”±
- è·¯å¾„: /teacher/customers

å½±å“:
- âœ… ä¿®å¤æ•™å¸ˆå®¢æˆ·ç»Ÿè®¡API
- âœ… ä¿®å¤æ•™å¸ˆå®¢æˆ·åˆ—è¡¨API
- âœ… ä¿®å¤å®¢æˆ·è½¬åŒ–æ¼æ–—API

æµ‹è¯•:
- éœ€è¦é‡å¯åç«¯æœåŠ¡
- éœ€è¦æµ‹è¯•æ‰€æœ‰æ•™å¸ˆå®¢æˆ·API"
```

---

## ğŸš€ åç»­å·¥ä½œ

1. **æµ‹è¯•ä¿®å¤æ•ˆæœ** (10åˆ†é’Ÿ)
   - é‡å¯åç«¯æœåŠ¡
   - æµ‹è¯•æ•™å¸ˆå®¢æˆ·API
   - æµ‹è¯•æ´»åŠ¨ç»Ÿè®¡API

2. **æ£€æŸ¥æ´»åŠ¨ç»Ÿè®¡æƒé™** (15åˆ†é’Ÿ)
   - æŸ¥çœ‹æ•°æ®åº“æƒé™è®°å½•
   - ç¡®è®¤æƒé™ä»£ç æ˜¯å¦æ­£ç¡®
   - ä¿®å¤æƒé™æ£€æŸ¥é—®é¢˜ï¼ˆå¦‚æœéœ€è¦ï¼‰

3. **å®Œæ•´å›å½’æµ‹è¯•** (30åˆ†é’Ÿ)
   - æµ‹è¯•æ‰€æœ‰æ•™å¸ˆè§’è‰²é¡µé¢
   - ç¡®è®¤æ‰€æœ‰APIæ­£å¸¸å·¥ä½œ
   - æ›´æ–°æµ‹è¯•æŠ¥å‘Š

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-09  
**æŠ¥å‘Šç”Ÿæˆäºº**: AI Assistant  
**ä¿®å¤çŠ¶æ€**: éƒ¨åˆ†å®Œæˆï¼ˆå¾…æµ‹è¯•ï¼‰

