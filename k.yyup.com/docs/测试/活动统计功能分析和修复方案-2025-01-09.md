# æ´»åŠ¨ç»Ÿè®¡åŠŸèƒ½åˆ†æå’Œä¿®å¤æ–¹æ¡ˆ

**åˆ†ææ—¥æœŸ**: 2025-01-09  
**åˆ†æäººå‘˜**: AI Assistant  
**é—®é¢˜æ¥æº**: ç”¨æˆ·åé¦ˆ - "æ´»åŠ¨ç»Ÿè®¡è¿™ä¸ªåŠŸèƒ½ï¼Œåº”è¯¥æ˜¯èƒ½çœ‹åˆ°ä»–è¢«åˆ†é…çš„æ´»åŠ¨çš„æ€»æŠ¥åäººæ•°å’Œå…¶ä»–äººæŠ¥åäººæ•°æ’è¡Œæ¦œï¼Œå’Œä»–è‡ªå·±çš„"  
**å½“å‰çŠ¶æ€**: âŒ 403 Forbidden

---

## ğŸ“‹ é—®é¢˜åˆ†æ

### å½“å‰å®ç°

**å‰ç«¯è°ƒç”¨**:
```typescript
// client/src/pages/teacher-center/activities/index.vue (ç¬¬359è¡Œ)
const response = await getActivityStatistics()

// client/src/api/modules/activity.ts (ç¬¬232è¡Œ)
export function getActivityStatistics(): Promise<ApiResponse<ActivityStatistics>> {
  return request.get(ACTIVITY_ENDPOINTS.STATISTICS);
}

// ACTIVITY_ENDPOINTS.STATISTICS = '/activities/statistics'
```

**åç«¯è·¯ç”±**:
```typescript
// server/src/routes/activities.routes.ts (ç¬¬351è¡Œ)
router.get('/statistics', 
  verifyToken, 
  checkPermission('ACTIVITY_VIEW'),  // âŒ æƒé™æ£€æŸ¥
  activityController.getStatistics
);
```

**åç«¯å®ç°**:
```typescript
// server/src/services/activity/activity.service.ts (ç¬¬408è¡Œ)
async getActivityStatistics(kindergartenId?: number): Promise<any> {
  // è¿”å›å…¨å±€æ´»åŠ¨ç»Ÿè®¡
  // - æ€»æ´»åŠ¨æ•°
  // - å„çŠ¶æ€æ´»åŠ¨æ•°
  // - æ€»æŠ¥åæ•°
  // - æ€»ç­¾åˆ°æ•°
  // - å¹³å‡æŠ¥åç‡
}
```

**é—®é¢˜**:
1. âŒ è°ƒç”¨çš„æ˜¯å…¨å±€ç»Ÿè®¡APIï¼Œéœ€è¦ `ACTIVITY_VIEW` æƒé™
2. âŒ æ•™å¸ˆè§’è‰²å¯èƒ½æ²¡æœ‰ `ACTIVITY_VIEW` æƒé™
3. âŒ è¿”å›çš„æ˜¯å…¨å±€ç»Ÿè®¡ï¼Œä¸æ˜¯æ•™å¸ˆä¸ªäººç»Ÿè®¡
4. âŒ æ²¡æœ‰æŠ¥åäººæ•°æ’è¡Œæ¦œ
5. âŒ æ²¡æœ‰æ•™å¸ˆè‡ªå·±çš„æŠ¥åæ•°æ®

---

### ç”¨æˆ·éœ€æ±‚

æ ¹æ®ç”¨æˆ·æè¿°ï¼Œæ•™å¸ˆè§’è‰²çš„æ´»åŠ¨ç»Ÿè®¡åº”è¯¥æ˜¾ç¤ºï¼š

1. **æ•™å¸ˆè¢«åˆ†é…çš„æ´»åŠ¨çš„æ€»æŠ¥åäººæ•°**
   - ä¸æ˜¯æ•™å¸ˆåˆ›å»ºçš„æ´»åŠ¨
   - è€Œæ˜¯åˆ†é…ç»™æ•™å¸ˆè´Ÿè´£çš„æ´»åŠ¨
   - æ˜¾ç¤ºè¿™äº›æ´»åŠ¨çš„æ€»æŠ¥åäººæ•°

2. **å…¶ä»–æ•™å¸ˆçš„æŠ¥åäººæ•°æ’è¡Œæ¦œ**
   - æ˜¾ç¤ºæ‰€æœ‰æ•™å¸ˆçš„æŠ¥åäººæ•°
   - æŒ‰æŠ¥åäººæ•°é™åºæ’åˆ—
   - å¯ä»¥çœ‹åˆ°è‡ªå·±çš„æ’å

3. **æ•™å¸ˆè‡ªå·±çš„æŠ¥åæ•°æ®**
   - è‡ªå·±è´Ÿè´£çš„æ´»åŠ¨æ•°é‡
   - è‡ªå·±è´Ÿè´£çš„æ´»åŠ¨çš„æ€»æŠ¥åäººæ•°
   - è‡ªå·±çš„æ’å

---

### ç°æœ‰çš„æ•™å¸ˆä¸“ç”¨API

**åç«¯å·²æœ‰æ•™å¸ˆæ´»åŠ¨ç»Ÿè®¡API**:
```typescript
// server/src/routes/teacher-dashboard.routes.ts (ç¬¬78è¡Œ)
router.get('/activity-statistics',
  requireRole(['teacher', 'admin']),
  TeacherDashboardController.getActivityStatistics
);

// è·¯å¾„: GET /api/teacher-dashboard/activity-statistics
```

**å½“å‰å®ç°**:
```typescript
// server/src/controllers/teacher-dashboard.controller.ts (ç¬¬112è¡Œ)
public static async getActivityStatistics(req: Request, res: Response) {
  // è·å–æ•™å¸ˆåˆ›å»ºçš„æ´»åŠ¨ç»Ÿè®¡
  const activityStatsRows = await sequelize.query(`
    SELECT
      COUNT(*) as totalActivities,
      SUM(a.registered_count) as totalRegistrations,
      SUM(a.checked_in_count) as totalCheckins,
      ...
    FROM activities a
    WHERE a.creator_id = :userId  // âŒ åªç»Ÿè®¡åˆ›å»ºçš„æ´»åŠ¨
  `);
  
  // è¿”å›æ•°æ®
  return {
    overview: {
      totalActivities,
      totalRegistrations,  // âœ… æœ‰æ€»æŠ¥åæ•°
      totalCheckins,
      avgCheckinRate
    },
    trends  // æœ€è¿‘30å¤©è¶‹åŠ¿
  };
}
```

**é—®é¢˜**:
1. âš ï¸ åªç»Ÿè®¡æ•™å¸ˆåˆ›å»ºçš„æ´»åŠ¨ï¼ˆ`creator_id`ï¼‰
2. âŒ æ²¡æœ‰ç»Ÿè®¡æ•™å¸ˆè¢«åˆ†é…çš„æ´»åŠ¨
3. âŒ æ²¡æœ‰æŠ¥åäººæ•°æ’è¡Œæ¦œ
4. âŒ æ²¡æœ‰æ•™å¸ˆè‡ªå·±çš„æ’å

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹å‰ç«¯è°ƒç”¨ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**:
- åªéœ€ä¿®æ”¹å‰ç«¯ä»£ç 
- ä½¿ç”¨ç°æœ‰çš„æ•™å¸ˆä¸“ç”¨API
- ä¸éœ€è¦ä¿®æ”¹åç«¯æƒé™

**ç¼ºç‚¹**:
- éœ€è¦è¿›ä¸€æ­¥å¢å¼ºåç«¯APIåŠŸèƒ½

**æ­¥éª¤**:

**1. ä¿®æ”¹å‰ç«¯APIè°ƒç”¨**

```typescript
// client/src/api/modules/teacher.ts
// æ·»åŠ æ•™å¸ˆæ´»åŠ¨ç»Ÿè®¡API
export function getTeacherActivityStatistics(): Promise<ApiResponse<any>> {
  return request.get('/teacher-dashboard/activity-statistics');
}
```

**2. ä¿®æ”¹å‰ç«¯é¡µé¢è°ƒç”¨**

```typescript
// client/src/pages/teacher-center/activities/index.vue (ç¬¬359è¡Œ)
const loadActivityStats = async () => {
  try {
    // ä¿®æ”¹ä¸ºè°ƒç”¨æ•™å¸ˆä¸“ç”¨API
    const response = await getTeacherActivityStatistics()
    if (response.success && response.data) {
      const stats = response.data.overview
      activityStats.upcoming = stats.totalActivities || 0
      activityStats.participating = stats.totalRegistrations || 0
      activityStats.thisWeek = 0  // éœ€è¦åç«¯æ·»åŠ 
      activityStats.responsible = stats.totalActivities || 0
    }
  } catch (error) {
    console.error('åŠ è½½æ´»åŠ¨ç»Ÿè®¡å¤±è´¥:', error)
    // é™çº§åˆ°æ¨¡æ‹Ÿæ•°æ®
  }
}
```

---

### æ–¹æ¡ˆ2: å¢å¼ºåç«¯APIåŠŸèƒ½ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**:
- å®Œå…¨æ»¡è¶³ç”¨æˆ·éœ€æ±‚
- æä¾›å®Œæ•´çš„æ•™å¸ˆæ´»åŠ¨ç»Ÿè®¡
- åŒ…å«æ’è¡Œæ¦œåŠŸèƒ½

**ç¼ºç‚¹**:
- éœ€è¦ä¿®æ”¹åç«¯ä»£ç 
- éœ€è¦ä¿®æ”¹æ•°æ®åº“æŸ¥è¯¢

**æ­¥éª¤**:

**1. ä¿®æ”¹åç«¯æ§åˆ¶å™¨**

```typescript
// server/src/controllers/teacher-dashboard.controller.ts
public static async getActivityStatistics(req: Request, res: Response) {
  try {
    const userId = req.user?.id;
    
    // 1. è·å–æ•™å¸ˆè¢«åˆ†é…çš„æ´»åŠ¨ç»Ÿè®¡ï¼ˆä¸ä»…ä»…æ˜¯åˆ›å»ºçš„ï¼‰
    const assignedActivitiesStats = await sequelize.query(`
      SELECT
        COUNT(DISTINCT a.id) as totalActivities,
        SUM(a.registered_count) as totalRegistrations,
        SUM(a.checked_in_count) as totalCheckins
      FROM activities a
      LEFT JOIN activity_teachers at ON a.id = at.activity_id
      WHERE (a.creator_id = :userId OR at.teacher_id = :teacherId)
        AND a.deleted_at IS NULL
    `, {
      replacements: { userId, teacherId },
      type: QueryTypes.SELECT
    });
    
    // 2. è·å–æ‰€æœ‰æ•™å¸ˆçš„æŠ¥åäººæ•°æ’è¡Œæ¦œ
    const teacherRankings = await sequelize.query(`
      SELECT
        t.id,
        t.name,
        u.username,
        COUNT(DISTINCT a.id) as activityCount,
        SUM(a.registered_count) as totalRegistrations,
        RANK() OVER (ORDER BY SUM(a.registered_count) DESC) as ranking
      FROM teachers t
      JOIN users u ON t.user_id = u.id
      LEFT JOIN activities a ON (a.creator_id = u.id OR EXISTS (
        SELECT 1 FROM activity_teachers at 
        WHERE at.activity_id = a.id AND at.teacher_id = t.id
      ))
      WHERE a.deleted_at IS NULL
      GROUP BY t.id, t.name, u.username
      ORDER BY totalRegistrations DESC
      LIMIT 10
    `, {
      type: QueryTypes.SELECT
    });
    
    // 3. è·å–å½“å‰æ•™å¸ˆçš„æ’å
    const myRanking = teacherRankings.find(r => r.teacher_id === teacherId);
    
    return res.json({
      success: true,
      data: {
        overview: {
          totalActivities: assignedActivitiesStats[0].totalActivities || 0,
          totalRegistrations: assignedActivitiesStats[0].totalRegistrations || 0,
          totalCheckins: assignedActivitiesStats[0].totalCheckins || 0,
          myRanking: myRanking?.ranking || 0
        },
        rankings: teacherRankings,  // æ’è¡Œæ¦œ
        myStats: myRanking  // æˆ‘çš„ç»Ÿè®¡
      }
    });
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

**2. ä¿®æ”¹å‰ç«¯é¡µé¢æ˜¾ç¤º**

```vue
<!-- client/src/pages/teacher-center/activities/index.vue -->
<template>
  <div class="teacher-activities">
    <!-- æ´»åŠ¨ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
      <el-row :gutter="20">
        <el-col :xs="24" :sm="12" :md="6">
          <ActivityStatCard 
            title="è´Ÿè´£æ´»åŠ¨"
            :value="activityStats.totalActivities"
            icon="Trophy"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6">
          <ActivityStatCard 
            title="æ€»æŠ¥åäººæ•°"
            :value="activityStats.totalRegistrations"
            icon="User"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6">
          <ActivityStatCard 
            title="æˆ‘çš„æ’å"
            :value="`#${activityStats.myRanking}`"
            icon="TrophyBase"
          />
        </el-col>
        <el-col :xs="24" :sm="12" :md="6">
          <ActivityStatCard 
            title="æ€»ç­¾åˆ°äººæ•°"
            :value="activityStats.totalCheckins"
            icon="Check"
          />
        </el-col>
      </el-row>
    </div>
    
    <!-- æŠ¥åäººæ•°æ’è¡Œæ¦œ -->
    <el-card class="rankings-card">
      <template #header>
        <h3>æ•™å¸ˆæŠ¥åäººæ•°æ’è¡Œæ¦œ</h3>
      </template>
      <el-table :data="teacherRankings" stripe>
        <el-table-column prop="ranking" label="æ’å" width="80" />
        <el-table-column prop="name" label="æ•™å¸ˆå§“å" />
        <el-table-column prop="activityCount" label="è´Ÿè´£æ´»åŠ¨æ•°" />
        <el-table-column prop="totalRegistrations" label="æ€»æŠ¥åäººæ•°" />
      </el-table>
    </el-card>
  </div>
</template>
```

---

## ğŸ”§ æ¨èå®æ–½æ­¥éª¤

### é˜¶æ®µ1: å¿«é€Ÿä¿®å¤ï¼ˆ10åˆ†é’Ÿï¼‰

1. âœ… ä¿®æ”¹å‰ç«¯APIè°ƒç”¨
   - ä» `getActivityStatistics()` æ”¹ä¸º `getTeacherActivityStatistics()`
   - è·¯å¾„ä» `/activities/statistics` æ”¹ä¸º `/teacher-dashboard/activity-statistics`

2. âœ… æµ‹è¯•éªŒè¯
   - éªŒè¯403é”™è¯¯æ˜¯å¦è§£å†³
   - éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦æ˜¾ç¤º

### é˜¶æ®µ2: åŠŸèƒ½å¢å¼ºï¼ˆ60åˆ†é’Ÿï¼‰

1. âœ… ä¿®æ”¹åç«¯æŸ¥è¯¢é€»è¾‘
   - ç»Ÿè®¡æ•™å¸ˆè¢«åˆ†é…çš„æ´»åŠ¨ï¼ˆä¸ä»…ä»…æ˜¯åˆ›å»ºçš„ï¼‰
   - æ·»åŠ æŠ¥åäººæ•°æ’è¡Œæ¦œæŸ¥è¯¢
   - æ·»åŠ æ•™å¸ˆè‡ªå·±çš„æ’å

2. âœ… ä¿®æ”¹å‰ç«¯é¡µé¢æ˜¾ç¤º
   - æ·»åŠ æ’è¡Œæ¦œç»„ä»¶
   - æ˜¾ç¤ºæ•™å¸ˆè‡ªå·±çš„æ’å
   - ä¼˜åŒ–ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤º

3. âœ… æµ‹è¯•éªŒè¯
   - éªŒè¯ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§
   - éªŒè¯æ’è¡Œæ¦œæ˜¾ç¤º
   - éªŒè¯æ’åè®¡ç®—

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### éœ€è¦çš„è¡¨

1. **activities** - æ´»åŠ¨è¡¨
   - `id` - æ´»åŠ¨ID
   - `creator_id` - åˆ›å»ºè€…IDï¼ˆç”¨æˆ·IDï¼‰
   - `registered_count` - æŠ¥åäººæ•°
   - `checked_in_count` - ç­¾åˆ°äººæ•°

2. **activity_teachers** - æ´»åŠ¨æ•™å¸ˆå…³è”è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   - `activity_id` - æ´»åŠ¨ID
   - `teacher_id` - æ•™å¸ˆID
   - `role` - è§’è‰²ï¼ˆè´Ÿè´£äººã€ååŠ©ç­‰ï¼‰

3. **teachers** - æ•™å¸ˆè¡¨
   - `id` - æ•™å¸ˆID
   - `user_id` - ç”¨æˆ·ID
   - `name` - æ•™å¸ˆå§“å

4. **users** - ç”¨æˆ·è¡¨
   - `id` - ç”¨æˆ·ID
   - `username` - ç”¨æˆ·å

---

## ğŸ“ ä¿®å¤è®°å½•

**ä¿®å¤æ—¶é—´**: 2025-01-09  
**ä¿®å¤çŠ¶æ€**: å¾…å®æ–½

**é˜¶æ®µ1ä¿®å¤**:
- æ–‡ä»¶: `client/src/api/modules/teacher.ts`
- æ–‡ä»¶: `client/src/pages/teacher-center/activities/index.vue`
- ä»£ç å˜æ›´: çº¦20è¡Œ

**é˜¶æ®µ2ä¿®å¤**:
- æ–‡ä»¶: `server/src/controllers/teacher-dashboard.controller.ts`
- æ–‡ä»¶: `client/src/pages/teacher-center/activities/index.vue`
- ä»£ç å˜æ›´: çº¦150è¡Œ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-09  
**æŠ¥å‘Šç”Ÿæˆäºº**: AI Assistant  
**åˆ†æå®Œæˆåº¦**: 100%

