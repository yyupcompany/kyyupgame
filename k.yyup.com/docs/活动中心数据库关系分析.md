# æ´»åŠ¨ä¸­å¿ƒæ•°æ®åº“å…³ç³»åˆ†æ

## ğŸ“‹ æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜1: æ´»åŠ¨ä¸æ‹›ç”Ÿè®¡åˆ’çš„å…³è”
**ç­”æ¡ˆ**: âœ… **å·²æœ‰å…³è”**

### é—®é¢˜2: æ´»åŠ¨æŠ¥ååå®¢æˆ·æ± è‡ªåŠ¨ç®¡ç†
**ç­”æ¡ˆ**: âŒ **æœªå®ç°è‡ªåŠ¨ç®¡ç†**ï¼ˆéœ€è¦å¼€å‘ï¼‰

---

## ğŸ”— æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EnrollmentPlan     â”‚  æ‹›ç”Ÿè®¡åˆ’
â”‚  (æ‹›ç”Ÿè®¡åˆ’è¡¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1
           â”‚
           â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Activity           â”‚  æ´»åŠ¨
â”‚  (æ´»åŠ¨è¡¨)            â”‚
â”‚  - planId (FK)      â”‚  â† å…³è”æ‹›ç”Ÿè®¡åˆ’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1
           â”‚
           â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ActivityRegistrationâ”‚  æ´»åŠ¨æŠ¥å
â”‚ (æ´»åŠ¨æŠ¥åè¡¨)         â”‚
â”‚ - activityId (FK)   â”‚
â”‚ - parentId (FK)     â”‚
â”‚ - studentId (FK)    â”‚
â”‚ - isConversion      â”‚  â† æ˜¯å¦è½¬åŒ–ä¸ºæ‹›ç”Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CustomerPool       â”‚  å®¢æˆ·æ± 
â”‚  (å®é™…ä½¿ç”¨å¤šä¸ªè¡¨)    â”‚
â”‚  - parents          â”‚  å®¶é•¿è¡¨
â”‚  - parent_followups â”‚  è·Ÿè¿›è®°å½•è¡¨
â”‚  - enrollment_      â”‚  æ‹›ç”Ÿå’¨è¯¢è¡¨
â”‚    consultations    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å·²æœ‰çš„å…³è”å…³ç³»

### 1. Activity.planId - æ´»åŠ¨å…³è”æ‹›ç”Ÿè®¡åˆ’

**æ•°æ®åº“å­—æ®µ**ï¼š
```typescript
// server/src/models/activity.model.ts
planId: {
  type: DataTypes.INTEGER,
  allowNull: true,
  comment: 'æ‹›ç”Ÿè®¡åˆ’ID',
}
```

**å…³è”å®šä¹‰**ï¼š
```typescript
Activity.belongsTo(EnrollmentPlan, {
  foreignKey: 'planId',
  as: 'plan',
});
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… åˆ›å»ºæ´»åŠ¨æ—¶å¯ä»¥å…³è”åˆ°å…·ä½“çš„æ‹›ç”Ÿè®¡åˆ’
- âœ… æŸ¥è¯¢æ´»åŠ¨æ—¶å¯ä»¥è·å–å…³è”çš„æ‹›ç”Ÿè®¡åˆ’ä¿¡æ¯
- âœ… ç»Ÿè®¡æ‹›ç”Ÿè®¡åˆ’ä¸‹çš„æ´»åŠ¨æ•°é‡å’Œæ•ˆæœ

**ç¤ºä¾‹**ï¼š
```typescript
// åˆ›å»ºæ´»åŠ¨æ—¶å…³è”æ‹›ç”Ÿè®¡åˆ’
const activity = await Activity.create({
  title: '2024æ˜¥å­£æ‹›ç”Ÿå¼€æ”¾æ—¥',
  planId: 123, // å…³è”åˆ°æ‹›ç”Ÿè®¡åˆ’ID
  activityType: ActivityType.OPEN_DAY,
  // ... å…¶ä»–å­—æ®µ
});

// æŸ¥è¯¢æ´»åŠ¨åŠå…¶å…³è”çš„æ‹›ç”Ÿè®¡åˆ’
const activity = await Activity.findByPk(1, {
  include: [{
    model: EnrollmentPlan,
    as: 'plan'
  }]
});
```

---

### 2. ActivityRegistration.isConversion - æ˜¯å¦è½¬åŒ–ä¸ºæ‹›ç”Ÿ

**æ•°æ®åº“å­—æ®µ**ï¼š
```typescript
// server/src/models/activity-registration.model.ts
isConversion: {
  type: DataTypes.BOOLEAN,
  allowNull: false,
  defaultValue: false,
  comment: 'æ˜¯å¦è½¬åŒ–ä¸ºæŠ¥å',
}
```

**ç”¨é€”**ï¼š
- âœ… æ ‡è®°æ´»åŠ¨æŠ¥åæ˜¯å¦è½¬åŒ–ä¸ºæ­£å¼æ‹›ç”Ÿ
- âœ… ç»Ÿè®¡æ´»åŠ¨çš„è½¬åŒ–ç‡
- âœ… åˆ†ææ´»åŠ¨æ•ˆæœ

---

## âŒ ç¼ºå¤±çš„è‡ªåŠ¨ç®¡ç†æœºåˆ¶

### 1. æ´»åŠ¨æŠ¥ååè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 

**å½“å‰çŠ¶æ€**ï¼šâŒ **æœªå®ç°**

**éœ€è¦å®ç°çš„é€»è¾‘**ï¼š
```typescript
// åœ¨æ´»åŠ¨æŠ¥ååˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 
async createRegistration(data) {
  const transaction = await sequelize.transaction();
  
  try {
    // 1. åˆ›å»ºæ´»åŠ¨æŠ¥å
    const registration = await ActivityRegistration.create(data, { transaction });
    
    // 2. è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± ï¼ˆéœ€è¦æ·»åŠ ï¼‰
    await this.addToCustomerPool({
      name: data.contactName,
      phone: data.contactPhone,
      childName: data.childName,
      childAge: data.childAge,
      childGender: data.childGender,
      source: 'ACTIVITY', // æ¥æºï¼šæ´»åŠ¨æŠ¥å
      activityId: data.activityId,
      registrationId: registration.id
    }, transaction);
    
    await transaction.commit();
    return registration;
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

---

### 2. å®¢æˆ·æ± æ•°æ®ç»“æ„

**å½“å‰å®¢æˆ·æ± ä½¿ç”¨çš„è¡¨**ï¼š

#### 2.1 parents è¡¨ï¼ˆå®¶é•¿è¡¨ï¼‰
```sql
CREATE TABLE parents (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT,
  name VARCHAR(50),
  phone VARCHAR(20),
  email VARCHAR(100),
  address VARCHAR(200),
  remark TEXT,
  created_at DATETIME,
  updated_at DATETIME,
  deleted_at DATETIME
);
```

#### 2.2 parent_followups è¡¨ï¼ˆè·Ÿè¿›è®°å½•è¡¨ï¼‰
```sql
CREATE TABLE parent_followups (
  id INT PRIMARY KEY AUTO_INCREMENT,
  parent_id INT,
  content TEXT,
  followup_date DATE,
  followup_type VARCHAR(50), -- è·Ÿè¿›ç±»å‹
  result VARCHAR(50),         -- è·Ÿè¿›ç»“æœ/çŠ¶æ€
  created_by INT,
  created_at DATETIME,
  updated_at DATETIME,
  deleted_at DATETIME
);
```

#### 2.3 enrollment_consultations è¡¨ï¼ˆæ‹›ç”Ÿå’¨è¯¢è¡¨ï¼‰
```sql
CREATE TABLE enrollment_consultations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  kindergarten_id INT,
  consultant_id INT,
  parent_name VARCHAR(50),
  child_name VARCHAR(50),
  child_age INT,
  child_gender TINYINT,
  contact_phone VARCHAR(20),
  source_channel TINYINT,     -- æ¥æºæ¸ é“
  consult_content TEXT,
  consult_method TINYINT,
  consult_date DATETIME,
  intention_level TINYINT,    -- æ„å‘ç­‰çº§
  followup_status TINYINT,    -- è·Ÿè¿›çŠ¶æ€
  creator_id INT,
  created_at DATETIME,
  updated_at DATETIME,
  deleted_at DATETIME
);
```

---

## ğŸ”§ éœ€è¦å¼€å‘çš„åŠŸèƒ½

### åŠŸèƒ½1: æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 

**å®ç°ä½ç½®**ï¼š`server/src/services/activity/activity-registration.service.ts`

**å®ç°æ­¥éª¤**ï¼š

#### æ­¥éª¤1: æ·»åŠ è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± çš„æ–¹æ³•
```typescript
/**
 * å°†æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 
 */
private async addToCustomerPool(data: {
  name: string;
  phone: string;
  childName?: string;
  childAge?: number;
  childGender?: number;
  source: string;
  activityId: number;
  registrationId: number;
}, transaction: Transaction): Promise<void> {
  try {
    // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ‰‹æœºå·çš„å®¢æˆ·
    const existingCustomer = await sequelize.query(
      `SELECT id FROM enrollment_consultations 
       WHERE contact_phone = ? AND deleted_at IS NULL 
       LIMIT 1`,
      {
        replacements: [data.phone],
        type: QueryTypes.SELECT,
        transaction
      }
    );
    
    if (existingCustomer && existingCustomer.length > 0) {
      // å®¢æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°è·Ÿè¿›è®°å½•
      await sequelize.query(
        `INSERT INTO parent_followups 
         (parent_id, content, followup_date, followup_type, result, created_by, created_at, updated_at) 
         VALUES (?, ?, NOW(), 'ACTIVITY', 'NEW', 1, NOW(), NOW())`,
        {
          replacements: [
            (existingCustomer[0] as any).id,
            `å‚åŠ æ´»åŠ¨æŠ¥å - æ´»åŠ¨ID: ${data.activityId}`
          ],
          type: QueryTypes.INSERT,
          transaction
        }
      );
    } else {
      // æ–°å®¢æˆ·ï¼Œåˆ›å»ºå®¢æˆ·è®°å½•
      await sequelize.query(
        `INSERT INTO enrollment_consultations 
         (kindergarten_id, consultant_id, parent_name, child_name, child_age, child_gender, 
          contact_phone, source_channel, consult_content, consult_method, consult_date, 
          intention_level, followup_status, creator_id, created_at, updated_at) 
         VALUES (1, 1, ?, ?, ?, ?, ?, 5, ?, 1, NOW(), 3, 1, 1, NOW(), NOW())`,
        {
          replacements: [
            data.name,
            data.childName || 'å¾…å¡«å†™',
            data.childAge || 36,
            data.childGender || 1,
            data.phone,
            `æ´»åŠ¨æŠ¥å - æ´»åŠ¨ID: ${data.activityId}, æŠ¥åID: ${data.registrationId}`
          ],
          type: QueryTypes.INSERT,
          transaction
        }
      );
    }
  } catch (error) {
    console.error('åŠ å…¥å®¢æˆ·æ± å¤±è´¥:', error);
    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“æŠ¥åæµç¨‹
  }
}
```

#### æ­¥éª¤2: åœ¨åˆ›å»ºæŠ¥åæ—¶è°ƒç”¨
```typescript
public async createRegistration(data, userId) {
  const transaction = await sequelize.transaction();
  
  try {
    // åˆ›å»ºæŠ¥åè®°å½•
    const registration = await ActivityRegistration.create({
      ...data,
      registrationTime: new Date(),
      status: activity.needsApproval ? 0 : 1,
      isConversion: false,
      creatorId: userId,
      updaterId: userId
    }, { transaction });
    
    // ğŸ†• è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 
    await this.addToCustomerPool({
      name: data.contactName,
      phone: data.contactPhone,
      childName: data.childName,
      childAge: data.childAge,
      childGender: data.childGender,
      source: 'ACTIVITY',
      activityId: data.activityId,
      registrationId: registration.id
    }, transaction);
    
    // æ›´æ–°æ´»åŠ¨æŠ¥åäººæ•°
    await activity.increment('registeredCount', { transaction });
    
    await transaction.commit();
    return registration;
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

---

### åŠŸèƒ½2: å®¢æˆ·æ± æ¥æºæ ‡è¯†

**éœ€è¦æ·»åŠ çš„å­—æ®µ**ï¼š

åœ¨ `enrollment_consultations` è¡¨ä¸­æ·»åŠ ï¼š
```sql
ALTER TABLE enrollment_consultations 
ADD COLUMN source_type VARCHAR(50) COMMENT 'æ¥æºç±»å‹: ACTIVITY/WEBSITE/PHONE/REFERRAL',
ADD COLUMN source_id INT COMMENT 'æ¥æºIDï¼ˆæ´»åŠ¨IDã€è¡¨å•IDç­‰ï¼‰',
ADD COLUMN source_detail TEXT COMMENT 'æ¥æºè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰';
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
{
  source_type: 'ACTIVITY',
  source_id: 123, // æ´»åŠ¨ID
  source_detail: JSON.stringify({
    activityTitle: '2024æ˜¥å­£æ‹›ç”Ÿå¼€æ”¾æ—¥',
    registrationId: 456,
    registrationTime: '2024-03-15 10:30:00'
  })
}
```

---

### åŠŸèƒ½3: å®¢æˆ·è½¬åŒ–è¿½è¸ª

**å®ç°é€»è¾‘**ï¼š

#### 3.1 æ´»åŠ¨æŠ¥åè½¬åŒ–ä¸ºæ­£å¼æ‹›ç”Ÿ
```typescript
/**
 * æ ‡è®°æ´»åŠ¨æŠ¥åå·²è½¬åŒ–
 */
public async markAsConverted(registrationId: number, applicationId: number): Promise<void> {
  const transaction = await sequelize.transaction();
  
  try {
    // 1. æ›´æ–°æŠ¥åè®°å½•
    await ActivityRegistration.update(
      { isConversion: true },
      { where: { id: registrationId }, transaction }
    );
    
    // 2. æ›´æ–°å®¢æˆ·æ± çŠ¶æ€
    const registration = await ActivityRegistration.findByPk(registrationId);
    await sequelize.query(
      `UPDATE enrollment_consultations 
       SET followup_status = 4, intention_level = 5 
       WHERE contact_phone = ? AND deleted_at IS NULL`,
      {
        replacements: [registration?.contactPhone],
        type: QueryTypes.UPDATE,
        transaction
      }
    );
    
    // 3. æ·»åŠ è½¬åŒ–è®°å½•
    await sequelize.query(
      `INSERT INTO parent_followups 
       (parent_id, content, followup_date, followup_type, result, created_by, created_at, updated_at) 
       VALUES (
         (SELECT id FROM enrollment_consultations WHERE contact_phone = ? LIMIT 1),
         ?, NOW(), 'CONVERSION', 'SUCCESS', 1, NOW(), NOW()
       )`,
      {
        replacements: [
          registration?.contactPhone,
          `æ´»åŠ¨è½¬åŒ–ä¸ºæ‹›ç”Ÿ - æŠ¥åID: ${registrationId}, ç”³è¯·ID: ${applicationId}`
        ],
        type: QueryTypes.INSERT,
        transaction
      }
    );
    
    await transaction.commit();
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
æ´»åŠ¨æŠ¥åæµç¨‹ + å®¢æˆ·æ± è‡ªåŠ¨ç®¡ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ç”¨æˆ·å¡«å†™æ´»åŠ¨æŠ¥åè¡¨å•
   â†“
2. åˆ›å»º ActivityRegistration è®°å½•
   â†“
3. è‡ªåŠ¨æ£€æŸ¥å®¢æˆ·æ± 
   â”œâ”€ å®¢æˆ·å·²å­˜åœ¨ â†’ æ·»åŠ è·Ÿè¿›è®°å½•
   â””â”€ æ–°å®¢æˆ· â†’ åˆ›å»ºå®¢æˆ·è®°å½•
   â†“
4. æ›´æ–°æ´»åŠ¨æŠ¥åäººæ•°
   â†“
5. å‘é€æŠ¥åç¡®è®¤é€šçŸ¥
   â†“
6. æ´»åŠ¨ç»“æŸå
   â”œâ”€ ç­¾åˆ° â†’ æ›´æ–°ç­¾åˆ°çŠ¶æ€
   â”œâ”€ è¯„ä»· â†’ æ”¶é›†åé¦ˆ
   â””â”€ è½¬åŒ– â†’ æ ‡è®°ä¸ºå·²è½¬åŒ–ï¼Œæ›´æ–°å®¢æˆ·æ± çŠ¶æ€
```

---

## ğŸ¯ æ€»ç»“

### âœ… å·²æœ‰çš„åŠŸèƒ½
1. **æ´»åŠ¨å…³è”æ‹›ç”Ÿè®¡åˆ’** - Activity.planId å­—æ®µ
2. **è½¬åŒ–æ ‡è®°** - ActivityRegistration.isConversion å­—æ®µ
3. **å®¢æˆ·æ± åŸºç¡€ç»“æ„** - parents, parent_followups, enrollment_consultations è¡¨

### âŒ éœ€è¦å¼€å‘çš„åŠŸèƒ½
1. **è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± ** - æ´»åŠ¨æŠ¥ååè‡ªåŠ¨åˆ›å»ºå®¢æˆ·è®°å½•
2. **æ¥æºè¿½è¸ª** - è®°å½•å®¢æˆ·æ¥æºï¼ˆæ´»åŠ¨ã€ç½‘ç«™ã€ç”µè¯ç­‰ï¼‰
3. **è½¬åŒ–è¿½è¸ª** - è‡ªåŠ¨æ›´æ–°å®¢æˆ·æ± çŠ¶æ€å’Œè½¬åŒ–è®°å½•
4. **æ•°æ®ç»Ÿè®¡** - æ´»åŠ¨å¸¦æ¥çš„å®¢æˆ·æ•°é‡ã€è½¬åŒ–ç‡ç­‰

### ğŸ“ å»ºè®®çš„å¼€å‘ä¼˜å…ˆçº§
1. **P0 - ç«‹å³å¼€å‘**ï¼šè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± åŠŸèƒ½
2. **P1 - é‡è¦**ï¼šæ¥æºè¿½è¸ªå’Œè½¬åŒ–è¿½è¸ª
3. **P2 - ä¼˜åŒ–**ï¼šæ•°æ®ç»Ÿè®¡å’ŒæŠ¥è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-05  
**ç»´æŠ¤äººå‘˜**ï¼šAI Assistant

