# å·¥å…·ç»“æœæ¸²æŸ“é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

**é—®é¢˜æ—¥æœŸ**: 2025-10-13  
**é—®é¢˜ç±»å‹**: å·¥å…·ç»“æœæ˜¾ç¤ºä¸ºJSONè€Œä¸æ˜¯ç»„ä»¶  
**å½±å“èŒƒå›´**: AIåŠ©æ‰‹å·¥å…·è°ƒç”¨åŠŸèƒ½

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1: å·¥å…·ç»“æœæ˜¾ç¤ºä¸ºJSONè€Œä¸æ˜¯è¡¨æ ¼/å›¾è¡¨

**ç°è±¡**:
- å·¥å…·è°ƒç”¨æˆåŠŸ
- è¿”å›çš„æ•°æ®æ˜¯JSONæ ¼å¼
- å‰ç«¯æ²¡æœ‰å°†JSONè½¬æ¢ä¸ºè¡¨æ ¼ã€åˆ—è¡¨æˆ–å›¾è¡¨ç»„ä»¶

**æ ¹æœ¬åŸå› **:
1. âŒ åç«¯å·¥å…·è¿”å›çš„æ•°æ®ç¼ºå°‘ `ui_instruction` å­—æ®µ
2. âŒ å‰ç«¯åªåœ¨æ£€æµ‹åˆ° `ui_instruction` æ—¶æ‰æ¸²æŸ“ç»„ä»¶
3. âŒ æ™®é€šçš„JSONæ•°æ®ç›´æ¥æ˜¾ç¤ºä¸ºæ–‡æœ¬

**ä»£ç ä½ç½®**:
- å‰ç«¯: `client/src/components/ai-assistant/AIAssistantRefactored.vue` ç¬¬747è¡Œ
- åç«¯: å·¥å…·æ‰§è¡Œç»“æœæ ¼å¼

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åç«¯æ·»åŠ ui_instructionï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**:
- âœ… åç«¯æ§åˆ¶UIæ¸²æŸ“ï¼Œæ›´çµæ´»
- âœ… å¯ä»¥ä¸ºä¸åŒå·¥å…·å®šåˆ¶ä¸åŒçš„UI
- âœ… å‰ç«¯åªéœ€è¦æ¸²æŸ“ï¼Œä¸éœ€è¦åˆ¤æ–­é€»è¾‘

**å®æ–½æ­¥éª¤**:

#### æ­¥éª¤1: ä¿®æ”¹å·¥å…·è¿”å›æ ¼å¼

**æ–‡ä»¶**: `server/src/services/ai-operator/tools/` ä¸‹çš„å„ä¸ªå·¥å…·æ–‡ä»¶

**å½“å‰æ ¼å¼**:
```typescript
return {
  success: true,
  data: [
    { name: "å¼ ä¸‰", age: 5, class: "å°ç­" },
    { name: "æå››", age: 6, class: "ä¸­ç­" }
  ]
}
```

**ä¿®æ”¹åæ ¼å¼**:
```typescript
return {
  success: true,
  result: {
    ui_instruction: {
      type: "render_component",
      component: {
        type: "data-table",
        title: "å­¦ç”Ÿåˆ—è¡¨",
        columns: [
          { prop: "name", label: "å§“å", width: 120 },
          { prop: "age", label: "å¹´é¾„", width: 80 },
          { prop: "class", label: "ç­çº§", width: 100 }
        ],
        data: [
          { name: "å¼ ä¸‰", age: 5, class: "å°ç­" },
          { name: "æå››", age: 6, class: "ä¸­ç­" }
        ],
        searchable: true,
        pagination: true,
        exportable: true
      }
    },
    pre_message: "æŸ¥è¯¢åˆ°ä»¥ä¸‹å­¦ç”Ÿæ•°æ®ï¼š",
    data: [...]  // åŸå§‹æ•°æ®
  }
}
```

#### æ­¥éª¤2: åˆ›å»ºå·¥å…·ç»“æœåŒ…è£…å‡½æ•°

**æ–‡ä»¶**: `server/src/services/ai-operator/tools/utils/result-wrapper.ts` (æ–°å»º)

```typescript
/**
 * å°†æ•°æ®åŒ…è£…ä¸ºè¡¨æ ¼ç»„ä»¶æ ¼å¼
 */
export function wrapAsDataTable(data: any[], options: {
  title: string
  columns: Array<{ prop: string; label: string; width?: number }>
  preMessage?: string
  searchable?: boolean
  pagination?: boolean
  exportable?: boolean
}) {
  return {
    success: true,
    result: {
      ui_instruction: {
        type: "render_component",
        component: {
          type: "data-table",
          title: options.title,
          columns: options.columns,
          data: data,
          searchable: options.searchable !== false,
          pagination: options.pagination !== false,
          exportable: options.exportable !== false
        }
      },
      pre_message: options.preMessage || `æŸ¥è¯¢åˆ° ${data.length} æ¡æ•°æ®ï¼š`,
      data: data
    }
  }
}

/**
 * å°†æ•°æ®åŒ…è£…ä¸ºå›¾è¡¨ç»„ä»¶æ ¼å¼
 */
export function wrapAsChart(data: any, options: {
  title: string
  chartType: 'bar' | 'line' | 'pie' | 'scatter'
  preMessage?: string
}) {
  return {
    success: true,
    result: {
      ui_instruction: {
        type: "render_component",
        component: {
          type: "chart",
          title: options.title,
          chartType: options.chartType,
          data: data,
          showLegend: true,
          exportable: true
        }
      },
      pre_message: options.preMessage || `ç”Ÿæˆå›¾è¡¨ï¼š${options.title}`,
      data: data
    }
  }
}

/**
 * å°†æ•°æ®åŒ…è£…ä¸ºåˆ—è¡¨ç»„ä»¶æ ¼å¼
 */
export function wrapAsList(items: any[], options: {
  title: string
  preMessage?: string
}) {
  return {
    success: true,
    result: {
      ui_instruction: {
        type: "render_component",
        component: {
          type: "todo-list",
          title: options.title,
          data: items,
          editable: false,
          showProgress: false
        }
      },
      pre_message: options.preMessage || `æŸ¥è¯¢åˆ° ${items.length} é¡¹ï¼š`,
      data: items
    }
  }
}
```

#### æ­¥éª¤3: ä¿®æ”¹read_data_recordå·¥å…·

**æ–‡ä»¶**: `server/src/services/ai-operator/tools/read-data-record.tool.ts`

**ç¤ºä¾‹ä¿®æ”¹**:
```typescript
import { wrapAsDataTable } from './utils/result-wrapper'

// ... å·¥å…·æ‰§è¡Œé€»è¾‘ ...

// æŸ¥è¯¢å­¦ç”Ÿæ•°æ®
if (tableName === 'students') {
  const students = await Student.findAll({ limit: 100 })
  
  return wrapAsDataTable(students, {
    title: 'å­¦ç”Ÿåˆ—è¡¨',
    columns: [
      { prop: 'name', label: 'å§“å', width: 120 },
      { prop: 'studentNo', label: 'å­¦å·', width: 100 },
      { prop: 'gender', label: 'æ€§åˆ«', width: 80 },
      { prop: 'birthDate', label: 'å‡ºç”Ÿæ—¥æœŸ', width: 120 },
      { prop: 'className', label: 'ç­çº§', width: 100 }
    ],
    preMessage: `æŸ¥è¯¢åˆ° ${students.length} åå­¦ç”Ÿï¼š`,
    searchable: true,
    pagination: true,
    exportable: true
  })
}
```

---

### æ–¹æ¡ˆ2: å‰ç«¯è‡ªåŠ¨è½¬æ¢ï¼ˆå¤‡é€‰ï¼‰

**ä¼˜ç‚¹**:
- âœ… ä¸éœ€è¦ä¿®æ”¹åç«¯
- âœ… å¯ä»¥å¿«é€Ÿå®æ–½

**ç¼ºç‚¹**:
- âŒ å‰ç«¯éœ€è¦åˆ¤æ–­æ•°æ®ç±»å‹
- âŒ ä¸å¤Ÿçµæ´»ï¼Œéš¾ä»¥å®šåˆ¶

**å®æ–½æ­¥éª¤**:

#### æ­¥éª¤1: åˆ›å»ºè‡ªåŠ¨è½¬æ¢å‡½æ•°

**æ–‡ä»¶**: `client/src/components/ai-assistant/utils/autoConvertToComponent.ts` (æ–°å»º)

```typescript
/**
 * è‡ªåŠ¨å°†JSONæ•°æ®è½¬æ¢ä¸ºç»„ä»¶æ ¼å¼
 */
export function autoConvertToComponent(data: any, toolName: string) {
  // å¦‚æœå·²ç»æœ‰ui_instructionï¼Œç›´æ¥è¿”å›
  if (data.ui_instruction || data.result?.ui_instruction) {
    return data
  }

  // åˆ¤æ–­æ•°æ®ç±»å‹
  const actualData = data.result?.data || data.data || data

  // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºè¡¨æ ¼
  if (Array.isArray(actualData) && actualData.length > 0) {
    const firstItem = actualData[0]
    
    // ç”Ÿæˆåˆ—é…ç½®
    const columns = Object.keys(firstItem).map(key => ({
      prop: key,
      label: formatLabel(key),
      width: 120
    }))

    return {
      ...data,
      result: {
        ...data.result,
        ui_instruction: {
          type: "render_component",
          component: {
            type: "data-table",
            title: `${toolName} æŸ¥è¯¢ç»“æœ`,
            columns: columns,
            data: actualData,
            searchable: true,
            pagination: true,
            exportable: true
          }
        }
      }
    }
  }

  // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºç»Ÿè®¡å¡ç‰‡
  if (typeof actualData === 'object' && !Array.isArray(actualData)) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç»Ÿè®¡æ•°æ®
    const values = Object.values(actualData)
    if (values.every(v => typeof v === 'number')) {
      return {
        ...data,
        result: {
          ...data.result,
          ui_instruction: {
            type: "render_component",
            component: {
              type: "chart",
              title: `${toolName} ç»Ÿè®¡`,
              chartType: "bar",
              data: {
                xAxis: Object.keys(actualData),
                series: [{
                  name: "æ•°é‡",
                  data: values
                }]
              }
            }
          }
        }
      }
    }
  }

  // é»˜è®¤è¿”å›åŸæ•°æ®
  return data
}

function formatLabel(key: string): string {
  // å°†é©¼å³°å‘½åè½¬æ¢ä¸ºä¸­æ–‡æ ‡ç­¾
  const labelMap: Record<string, string> = {
    name: 'å§“å',
    studentNo: 'å­¦å·',
    gender: 'æ€§åˆ«',
    birthDate: 'å‡ºç”Ÿæ—¥æœŸ',
    className: 'ç­çº§',
    age: 'å¹´é¾„',
    // ... æ›´å¤šæ˜ å°„
  }
  return labelMap[key] || key
}
```

#### æ­¥éª¤2: åœ¨å‰ç«¯åº”ç”¨è‡ªåŠ¨è½¬æ¢

**æ–‡ä»¶**: `client/src/components/ai-assistant/AIAssistantRefactored.vue`

**ä¿®æ”¹ä½ç½®**: ç¬¬746-783è¡Œ

```typescript
// ğŸ¨ å¤„ç†UIæŒ‡ä»¤ - å¦‚æœå·¥å…·è¿”å›äº†ui_instructionï¼Œåˆ™æ¸²æŸ“ç»„ä»¶
if (event.type === 'tool_call_complete' && event.data?.result) {
  // ğŸ”§ è‡ªåŠ¨è½¬æ¢ï¼šå¦‚æœæ²¡æœ‰ui_instructionï¼Œå°è¯•è‡ªåŠ¨è½¬æ¢
  let resultData = event.data.result
  if (!resultData.ui_instruction && !resultData.result?.ui_instruction) {
    resultData = autoConvertToComponent(resultData, event.data.name)
  }

  const uiInstruction = resultData.ui_instruction || resultData.result?.ui_instruction
  
  if (uiInstruction && uiInstruction.type === 'render_component' && uiInstruction.component) {
    console.log('ğŸ¨ [UIæŒ‡ä»¤] æ£€æµ‹åˆ°UIæ¸²æŸ“æŒ‡ä»¤:', uiInstruction)
    
    // ... ç°æœ‰çš„ç»„ä»¶æ¸²æŸ“é€»è¾‘ ...
  }
}
```

---

## ğŸ“Š æ¨èæ–¹æ¡ˆ

### æ¨è: æ–¹æ¡ˆ1ï¼ˆåç«¯æ·»åŠ ui_instructionï¼‰

**ç†ç”±**:
1. âœ… æ›´ç¬¦åˆæ¶æ„è®¾è®¡ï¼ˆåç«¯æ§åˆ¶UIï¼‰
2. âœ… æ›´çµæ´»ï¼Œå¯ä»¥ä¸ºä¸åŒå·¥å…·å®šåˆ¶UI
3. âœ… å‰ç«¯ä»£ç æ›´ç®€æ´
4. âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•

**å®æ–½ä¼˜å…ˆçº§**:
1. **é«˜ä¼˜å…ˆçº§**: åˆ›å»º `result-wrapper.ts` å·¥å…·å‡½æ•°
2. **é«˜ä¼˜å…ˆçº§**: ä¿®æ”¹ `read_data_record` å·¥å…·
3. **ä¸­ä¼˜å…ˆçº§**: ä¿®æ”¹å…¶ä»–å¸¸ç”¨å·¥å…·ï¼ˆany_query, navigate_toç­‰ï¼‰
4. **ä½ä¼˜å…ˆçº§**: ä¿®æ”¹æ‰€æœ‰å·¥å…·

---

## ğŸ¯ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: åˆ›å»ºå·¥å…·å‡½æ•°ï¼ˆ30åˆ†é’Ÿï¼‰
- [ ] åˆ›å»º `result-wrapper.ts` æ–‡ä»¶
- [ ] å®ç° `wrapAsDataTable` å‡½æ•°
- [ ] å®ç° `wrapAsChart` å‡½æ•°
- [ ] å®ç° `wrapAsList` å‡½æ•°

### é˜¶æ®µ2: ä¿®æ”¹æ ¸å¿ƒå·¥å…·ï¼ˆ1å°æ—¶ï¼‰
- [ ] ä¿®æ”¹ `read_data_record` å·¥å…·
- [ ] ä¿®æ”¹ `any_query` å·¥å…·
- [ ] æµ‹è¯•å·¥å…·è¿”å›æ ¼å¼

### é˜¶æ®µ3: æµ‹è¯•éªŒè¯ï¼ˆ30åˆ†é’Ÿï¼‰
- [ ] æµ‹è¯•å•ä¸ªå·¥å…·è°ƒç”¨
- [ ] æµ‹è¯•å¤šä¸ªå·¥å…·å¹¶å‘è°ƒç”¨
- [ ] éªŒè¯ç»„ä»¶æ­£ç¡®æ¸²æŸ“

### é˜¶æ®µ4: æ‰©å±•åˆ°å…¶ä»–å·¥å…·ï¼ˆ2å°æ—¶ï¼‰
- [ ] ä¿®æ”¹å…¶ä»–æŸ¥è¯¢ç±»å·¥å…·
- [ ] ä¿®æ”¹ç»Ÿè®¡ç±»å·¥å…·
- [ ] ä¿®æ”¹å¯¼èˆªç±»å·¥å…·

---

## ğŸ“ æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: æŸ¥è¯¢å­¦ç”Ÿæ•°æ®
**è¾“å…¥**: "æŸ¥è¯¢æ‰€æœ‰å­¦ç”Ÿ"
**é¢„æœŸ**: æ˜¾ç¤ºå­¦ç”Ÿæ•°æ®è¡¨æ ¼ï¼ŒåŒ…å«å§“åã€å­¦å·ã€æ€§åˆ«ç­‰åˆ—

### æµ‹è¯•2: ç»Ÿè®¡æ•°æ®
**è¾“å…¥**: "ç»Ÿè®¡å„ç­çº§äººæ•°"
**é¢„æœŸ**: æ˜¾ç¤ºæŸ±çŠ¶å›¾ï¼ŒXè½´ä¸ºç­çº§åç§°ï¼ŒYè½´ä¸ºäººæ•°

### æµ‹è¯•3: å¤šå·¥å…·å¹¶å‘
**è¾“å…¥**: "æŸ¥è¯¢å­¦ç”Ÿå’Œæ•™å¸ˆ"
**é¢„æœŸ**: æ˜¾ç¤ºä¸¤ä¸ªè¡¨æ ¼ï¼Œåˆ†åˆ«æ˜¯å­¦ç”Ÿåˆ—è¡¨å’Œæ•™å¸ˆåˆ—è¡¨

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-13 19:35:00

