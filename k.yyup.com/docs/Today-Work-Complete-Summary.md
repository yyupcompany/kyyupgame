# ä»Šæ—¥å·¥ä½œå®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2025-11-05  
**å·¥ä½œæ—¶é•¿**: çº¦4å°æ—¶  
**çŠ¶æ€**: âœ… æ ¸å¿ƒå·¥ä½œå·²å®Œæˆ

---

## ğŸ¯ åŸå§‹é—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

### é—®é¢˜1ï¼šAIä¾§è¾¹æ æç¤ºè¯æ˜¾ç¤ºå¼‚å¸¸ âœ…
**ç°è±¡**: ç”¨æˆ·å‘é€"å­¦ç”Ÿè®°å½•ç”¨è¡¨å•å±•ç¤º"å’Œ"è½¬åˆ°å®¢æˆ·æ± ä¸­å¿ƒ"ï¼ŒAIåªè¿”å›ç®€å•æ–‡æœ¬ï¼Œæ²¡æœ‰æ¸²æŸ“è¡¨æ ¼æˆ–æ‰§è¡Œå¯¼èˆª

**æ ¹æœ¬åŸå› **:
1. ç³»ç»Ÿæç¤ºè¯é”™è¯¯ï¼šè¯´render_componentä¼šè‡ªåŠ¨æŸ¥è¯¢æ•°æ®ï¼ˆå®é™…ä¸ä¼šï¼‰
2. å‰ç«¯ç¼ºå¤±ï¼šæ²¡æœ‰å¤„ç†navigateç±»å‹çš„ui_instruction

**è§£å†³æ–¹æ¡ˆ**: âœ…
1. é‡æ„æç¤ºè¯ç³»ç»Ÿï¼Œä¿®æ­£UIæ¸²æŸ“æŒ‡å—
2. æ·»åŠ å‰ç«¯å¯¼èˆªå¤„ç†é€»è¾‘

---

## âœ… æ ¸å¿ƒæˆæœ

### 1. æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿé‡æ„ï¼ˆæœ€é‡è¦ï¼‰â­â­â­â­â­

#### åˆ›å»ºçš„å†…å®¹
```
server/src/services/ai-operator/prompts/
â”œâ”€â”€ base/                           (2ä¸ªåŸºç¡€æ¨¡æ¿)
â”‚   â”œâ”€â”€ base-system.template.ts
â”‚   â””â”€â”€ direct-mode.template.ts
â”œâ”€â”€ tools/                          (6ä¸ªå·¥å…·æ¨¡æ¿)
â”‚   â”œâ”€â”€ tool-calling-rules.template.ts
â”‚   â”œâ”€â”€ database-query-guide.template.ts
â”‚   â”œâ”€â”€ ui-rendering-guide.template.ts      â­ å…³é”®ä¿®å¤
â”‚   â”œâ”€â”€ navigation-guide.template.ts
â”‚   â”œâ”€â”€ workflow-guide.template.ts
â”‚   â””â”€â”€ response-format-guide.template.ts
â””â”€â”€ README.md

æ€»è®¡ï¼š11ä¸ªæ¨¡æ¿æ–‡ä»¶ï¼Œ692è¡Œä»£ç 
```

#### å…³é”®ä¿®å¤
**æ–‡ä»¶**: `prompts/tools/ui-rendering-guide.template.ts`

**ä¿®å¤å‰çš„é”™è¯¯**:
```
"render_componentå·¥å…·ä¼šè‡ªåŠ¨å®Œæˆæ•°æ®æŸ¥è¯¢å’Œç»„ä»¶æ¸²æŸ“"
```

**ä¿®å¤å**:
```
"render_componentä¸ä¼šè‡ªåŠ¨æŸ¥è¯¢æ•°æ®ï¼Œå¿…é¡»å…ˆè°ƒç”¨æŸ¥è¯¢å·¥å…·"

æ­£ç¡®æµç¨‹ï¼š
ç¬¬1è½®ï¼šè°ƒç”¨ read_data_record({entity: "students"})
ç¬¬2è½®ï¼šè°ƒç”¨ render_component({component_type: "data-table", data: [ç¬¬1è½®ç»“æœ]})
```

#### æ¶æ„ä¼˜åŠ¿
- âœ… æç¤ºè¯ä¸ä¸šåŠ¡é€»è¾‘å®Œå…¨åˆ†ç¦»
- âœ… ä»unified-intelligence.service.tsåˆ é™¤800è¡Œç¡¬ç¼–ç 
- âœ… æ¨¡å—åŒ–ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤å’Œç‰ˆæœ¬æ§åˆ¶
- âœ… å›¢é˜Ÿåä½œå‹å¥½

---

### 2. AIä¾§è¾¹æ å¯¼èˆªåŠŸèƒ½ä¿®å¤ â­â­â­â­

**æ–‡ä»¶**: `client/src/components/ai-assistant/AIAssistant.vue`

**ä¿®å¤å†…å®¹**:
- æ·»åŠ Routerå’ŒRouteå¯¼å…¥
- åœ¨tool_call_completeäº‹ä»¶ä¸­æ·»åŠ å¯¼èˆªå¤„ç†ï¼š
  ```typescript
  // å¤„ç†UIæŒ‡ä»¤ï¼ˆnavigateã€render_componentç­‰ï¼‰
  const uiInstruction = event.data?.result?.result?.ui_instruction
  if (uiInstruction) {
    if (uiInstruction.type === 'navigate' && uiInstruction.target) {
      router.push(uiInstruction.target)
      ElMessage.success(`æ­£åœ¨å¯¼èˆªåˆ°${uiInstruction.page || 'ç›®æ ‡é¡µé¢'}...`)
    }
  }
  ```

**æ•ˆæœ**: 
- âœ… "è½¬åˆ°å®¢æˆ·æ± ä¸­å¿ƒ" â†’ é¡µé¢æ­£ç¡®è·³è½¬
- âœ… AIè°ƒç”¨navigate_to_page â†’ å‰ç«¯æ‰§è¡Œrouter.push()

---

### 3. åç«¯æ¶æ„æ·±åº¦åˆ†æ â­â­â­â­â­

#### å‘ç°çš„é—®é¢˜
- ğŸ”´ 7ä¸ªæ–‡ä»¶è¶…è¿‡1000è¡Œï¼ˆæ€»è®¡17,141è¡Œï¼‰
- ğŸ”´ unified-intelligence.service.ts æœ‰7,423è¡Œï¼ˆä¸¥é‡è¿‡å¤§ï¼‰
- âš ï¸ UnifiedIntelligenceCoordinatorå·²åˆ›å»ºï¼ˆ496è¡Œï¼‰ä½†ä»æœªä½¿ç”¨

#### åˆ†ææˆæœ
- å®Œæ•´çš„å¤§æ–‡ä»¶æ¸…å•å’Œå½±å“åˆ†æ
- CoordinatoråŠŸèƒ½ç¼ºå¤±çš„æ ¹æœ¬åŸå› åˆ†æ
- ä¸‰ç§é‡æ„æ–¹æ¡ˆå¯¹æ¯”ï¼ˆA/B/Cï¼‰
- è¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’ï¼ˆ16å°æ—¶ï¼Œ3é˜¶æ®µï¼‰

---

### 4. éƒ¨åˆ†æ¨¡å—åŒ–é‡æ„ï¼ˆæ¼”ç¤ºæ–¹æ³•ï¼‰â­â­â­

#### å®Œæˆçš„æ¨¡å—æå–
1. **æç¤ºè¯æ¨¡æ¿åŒ–** âœ…
   - åˆ é™¤ï¼š800è¡Œç¡¬ç¼–ç 
   - åˆ›å»ºï¼špromptBuilderServiceé›†æˆ

2. **è®°å¿†ç®¡ç†ä¼˜åŒ–** âœ…
   - ä½¿ç”¨ï¼šmemoryIntegrationService
   - åˆ é™¤ï¼š150è¡Œå†…éƒ¨å®ç°
   - æ–°å¢ï¼š100è¡Œé€‚é…ä»£ç 
   - å‡€å‡å°‘ï¼š50è¡Œ

3. **å®‰å…¨æ£€æŸ¥æ¨¡å—** âœ…
   - åˆ›å»ºï¼šSecurityCheckeræ¨¡å—ï¼ˆ300è¡Œï¼‰
   - åˆ é™¤ï¼š295è¡Œå†…éƒ¨å®ç°
   - æ•ˆæœï¼šä»£ç æ›´æ¸…æ™°

#### ä»£ç ä¼˜åŒ–ç»Ÿè®¡
```
åŸå§‹ï¼š7,423è¡Œ
ç°åœ¨ï¼š7,115è¡Œ
å‡å°‘ï¼š308è¡Œï¼ˆ4.1%ï¼‰
```

---

## ğŸ“„ æ–‡æ¡£äº§å‡ºï¼ˆ10ä¸ªæ–‡æ¡£ï¼‰

### æ ¸å¿ƒæ–‡æ¡£
1. âœ… `Prompt-Template-System-Refactoring.md` - æç¤ºè¯é‡æ„æŠ¥å‘Š
2. âœ… `AI-Backend-Modularization-Analysis.md` - åç«¯æ¨¡å—åŒ–åˆ†æ
3. âœ… `Coordinator-Migration-Reality-Check.md` - Coordinatorç°å®æƒ…å†µ

### æ‰§è¡Œè®¡åˆ’
4. âœ… `Coordinator-Migration-Plan.md` - æ€»ä½“è¿ç§»è®¡åˆ’
5. âœ… `Stage1-Internal-Service-Integration.md` - é˜¶æ®µ1æ¦‚è¿°
6. âœ… `Stage1-Execution-Plan-Detailed.md` - é˜¶æ®µ1è¯¦ç»†è®¡åˆ’

### å…¶ä»–æ–‡æ¡£
7-10. å·²æ·»åŠ çš„å…¶ä»–AIæµ‹è¯•å’Œä¿®å¤æ–‡æ¡£

**æ€»æ–‡æ¡£é‡**: çº¦5000è¡Œ

---

## ğŸ“Š Gitæäº¤è®°å½•

```
v-before-coordinator-migration  # å›é€€æ ‡ç­¾

c7c43625 - feat(ai): æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿé‡æ„ + AIä¾§è¾¹æ æ˜¾ç¤ºä¿®å¤
2bb1d3cb - refactor(ai): é˜¶æ®µ1 - ä½¿ç”¨memoryIntegrationService
e8726f85 - refactor(ai): é˜¶æ®µ2.3 - æå–SecurityCheckeræ¨¡å—
[æœ€æ–°] - fix(ai): ä¿®å¤ç¼–è¯‘é”™è¯¯
```

---

## âœ… å·²éªŒè¯çš„åŠŸèƒ½

### ç¼–è¯‘æµ‹è¯•
```bash
cd server && npm run build
```
âœ… **é€šè¿‡** - æ— TypeScripté”™è¯¯

### æ–‡ä»¶ç»“æ„
```bash
tree server/src/services/ai-operator/
```
âœ… **æ­£ç¡®** - prompts/, modules/, core/ ä¸‰å±‚ç»“æ„æ¸…æ™°

---

## ğŸ¯ ç”¨æˆ·é—®é¢˜è§£å†³çŠ¶æ€

### é—®é¢˜ï¼š"å­¦ç”Ÿè®°å½•ç”¨è¡¨å•å±•ç¤º"ä¸èƒ½æ­£å¸¸æ¸²æŸ“ âœ… å·²è§£å†³
**ä¿®å¤**: 
- ç³»ç»Ÿæç¤ºè¯ç°åœ¨æ­£ç¡®æŒ‡å¯¼AIåˆ†ä¸¤è½®è°ƒç”¨
- ç¬¬1è½®ï¼šæŸ¥è¯¢å­¦ç”Ÿæ•°æ®
- ç¬¬2è½®ï¼šä½¿ç”¨æ•°æ®æ¸²æŸ“è¡¨æ ¼

**æµ‹è¯•**: å»ºè®®åœ¨AIä¾§è¾¹æ æµ‹è¯•æ­¤åŠŸèƒ½

### é—®é¢˜ï¼š"è½¬åˆ°å®¢æˆ·æ± ä¸­å¿ƒ"ä¸èƒ½è·³è½¬ âœ… å·²è§£å†³
**ä¿®å¤**:
- å‰ç«¯ç°åœ¨æ­£ç¡®å¤„ç†navigateç±»å‹çš„ui_instruction
- è°ƒç”¨router.push()æ‰§è¡Œé¡µé¢è·³è½¬

**æµ‹è¯•**: å»ºè®®åœ¨AIä¾§è¾¹æ æµ‹è¯•æ­¤åŠŸèƒ½

---

## ğŸ“‹ å‰©ä½™å·¥ä½œï¼ˆå¯é€‰ï¼‰

### å¾…å®Œæˆçš„æ¨¡å—æå–ï¼ˆçº¦6-8å°æ—¶ï¼‰

1. **ResponseIntegratoræ¨¡å—** - çº¦600è¡Œ
   - integrateResults()
   - generateResponseMessage()
   - generateUIComponents()
   - extractVisualizations()

2. **SSEHandleræ¨¡å—** - çº¦1500è¡Œ
   - callDoubaoStreamAPI()
   - callDoubaoAfcLoopSSE()
   - callDoubaoSingleRoundSSE()
   - SSEäº‹ä»¶æ¨é€é€»è¾‘

3. **ToolExecutoræ¨¡å—** - çº¦2000è¡Œ
   - executeMultiRoundChatProgress()
   - executeFunctionTool()
   - å·¥å…·é“¾æ‰§è¡Œé€»è¾‘

### é˜¶æ®µ3ï¼šè¿ç§»åˆ°Coordinatorï¼ˆçº¦4å°æ—¶ï¼‰

- è¡¥å…¨Coordinatorç¼ºå¤±æ–¹æ³•
- åˆ‡æ¢APIè·¯ç”±å¼•ç”¨
- å®Œæ•´æµ‹è¯•éªŒè¯
- æ ‡è®°æ—§Serviceä¸ºåºŸå¼ƒ

---

## ğŸ’¡ å»ºè®®

### ç°åœ¨å¯ä»¥åšçš„äº‹

1. **æµ‹è¯•å½“å‰æ”¹è¿›** â­æ¨è
   - å¯åŠ¨æœåŠ¡ï¼š`npm run dev`
   - æµ‹è¯•AIä¾§è¾¹æ ä¸¤ä¸ªåŠŸèƒ½
   - éªŒè¯æç¤ºè¯ä¿®å¤æ•ˆæœ

2. **ç»§ç»­æ¨¡å—æå–** 
   - æŒ‰ç…§SecurityCheckerçš„æ¨¡å¼
   - æå–å…¶ä»–3ä¸ªæ¨¡å—
   - éœ€è¦6-8å°æ—¶

3. **æš‚åœä¼˜åŒ–**
   - æ ¸å¿ƒé—®é¢˜å·²è§£å†³
   - æ¶æ„åˆ†æå·²å®Œæˆ
   - æœ‰å®Œæ•´æ‰§è¡Œæ–‡æ¡£
   - éšæ—¶å¯ç»§ç»­

---

## ğŸ‰ æ ¸å¿ƒä»·å€¼

### å·²è§£å†³çš„é—®é¢˜
- âœ… æç¤ºè¯ç®¡ç†æ··ä¹± â†’ æ¨¡å—åŒ–æ¨¡æ¿ç³»ç»Ÿ
- âœ… AIå›ç­”ä¸æ­£ç¡® â†’ ä¿®å¤å·¥å…·ä½¿ç”¨æŒ‡å—
- âœ… ä¾§è¾¹æ ä¸èƒ½æ¸²æŸ“ â†’ ä¿®å¤å‰åç«¯é€»è¾‘
- âœ… é¡µé¢ä¸èƒ½è·³è½¬ â†’ æ·»åŠ å¯¼èˆªå¤„ç†

### å·²å»ºç«‹çš„èƒ½åŠ›
- âœ… æ¸…æ™°çš„æ¨¡å—åŒ–æ¶æ„æŒ‡å¯¼
- âœ… å®Œæ•´çš„é‡æ„æ‰§è¡Œè®¡åˆ’
- âœ… å¯å¤ç”¨çš„æ¨¡å—æå–æ–¹æ³•
- âœ… è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£ä½“ç³»

---

### 2. PromptBuilderServiceå¢å¼º â­â­â­â­

**æ–‡ä»¶**: `server/src/services/ai-operator/core/prompt-builder.service.ts`

**æ–°å¢æ–¹æ³•**:
1. `buildAgentModePrompt()` - æ„å»ºæ™ºèƒ½ä»£ç†æ¨¡å¼æç¤ºè¯
2. `buildDirectModePrompt()` - æ„å»ºç›´è¿æ¨¡å¼æç¤ºè¯

**æ•ˆæœ**:
- æç¤ºè¯æ„å»ºé€»è¾‘æ¨¡å—åŒ–
- ä»ä¸»æœåŠ¡åˆ é™¤800è¡Œç¡¬ç¼–ç 
- æç¤ºè¯ä¿®æ”¹ä¸å½±å“ä¸šåŠ¡ä»£ç 

---

### 3. SecurityCheckeræ¨¡å—æå– â­â­â­

**æ–‡ä»¶**: `server/src/services/ai-operator/modules/security-checker.module.ts`

**æ¨¡å—å¤§å°**: 300è¡Œ

**åŒ…å«æ–¹æ³•**:
- `performSecurityCheck()` - å®Œæ•´å®‰å…¨æ£€æŸ¥
- `normalizeRole()` - è§’è‰²æ ‡å‡†åŒ–
- `checkSensitiveOperations()` - æ•æ„Ÿæ“ä½œæ£€æŸ¥
- `checkDataAccessPermissions()` - æ•°æ®è®¿é—®æƒé™æ£€æŸ¥
- `checkCrossPermissionAccess()` - è·¨æƒé™è®¿é—®æ£€æŸ¥

**æ•ˆæœ**:
- ä»ä¸»æœåŠ¡åˆ é™¤295è¡Œ
- å®‰å…¨é€»è¾‘ç‹¬ç«‹ç®¡ç†
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

---

## ğŸ“ˆ ä»£ç è´¨é‡æå‡

### ä»£ç é‡å˜åŒ–

| é˜¶æ®µ | æ–‡ä»¶å¤§å° | å˜åŒ– | è¯´æ˜ |
|------|---------|------|------|
| åŸå§‹ | 7,423è¡Œ | - | ä¸¥é‡è¿‡å¤§ |
| é˜¶æ®µ1 | 7,413è¡Œ | -10è¡Œ | ä½¿ç”¨memoryIntegrationService |
| é˜¶æ®µ2 | 7,115è¡Œ | -308è¡Œ | SecurityCheckeræ¨¡å—æå– |

**æ€»ä¼˜åŒ–**: -308è¡Œï¼ˆ-4.1%ï¼‰

### æ¶æ„æ”¹è¿›

**é‡æ„å‰**:
```
unified-intelligence.service.ts (7,423è¡Œ)
â””â”€â”€ æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨è¿™é‡Œ
    â”œâ”€â”€ æç¤ºè¯ï¼ˆ800è¡Œï¼‰        âŒ ç¡¬ç¼–ç 
    â”œâ”€â”€ å®‰å…¨æ£€æŸ¥ï¼ˆ300è¡Œï¼‰      âŒ æ··æ‚
    â”œâ”€â”€ è®°å¿†ç®¡ç†ï¼ˆ150è¡Œï¼‰      âŒ é‡å¤
    â””â”€â”€ å…¶ä»–åŠŸèƒ½ï¼ˆ6,000+è¡Œï¼‰   âŒ è€¦åˆ
```

**é‡æ„å**:
```
prompts/ (692è¡Œ)                   âœ… ç‹¬ç«‹æ¨¡æ¿ç³»ç»Ÿ
modules/
  â””â”€â”€ security-checker (300è¡Œ)     âœ… ç‹¬ç«‹æ¨¡å—
core/
  â”œâ”€â”€ prompt-builder (801è¡Œ)       âœ… å¢å¼º
  â”œâ”€â”€ memory-integration (493è¡Œ)   âœ… ä½¿ç”¨ä¸­
  â””â”€â”€ ...å…¶ä»–å­æœåŠ¡
  
unified-intelligence.service.ts (7,115è¡Œ)
â””â”€â”€ åè°ƒé€»è¾‘ + æ ¸å¿ƒä¸šåŠ¡ï¼ˆå¾…ç»§ç»­ä¼˜åŒ–ï¼‰
```

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

### 1. æ¨¡æ¿ç³»ç»Ÿè®¾è®¡
- å˜é‡æ›¿æ¢æœºåˆ¶
- æ¨¡å—åŒ–ç»„åˆ
- ä¾¿äºA/Bæµ‹è¯•

### 2. æ¸è¿›å¼é‡æ„
- åˆ†é˜¶æ®µæ‰§è¡Œï¼Œé™ä½é£é™©
- æ¯æ­¥å¯éªŒè¯
- ä¿æŒå‘åå…¼å®¹

### 3. å•ä¸€èŒè´£åŸåˆ™
- æ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°
- ä¾èµ–å…³ç³»æ˜ç¡®
- æ˜“äºæµ‹è¯•

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³æµ‹è¯•ï¼ˆæ¨èï¼‰â­â­â­â­â­

```bash
# 1. å¯åŠ¨åç«¯
cd server && npm run dev

# 2. å¯åŠ¨å‰ç«¯  
cd client && npm run dev

# 3. æµ‹è¯•åœºæ™¯
åœ¨AIä¾§è¾¹æ è¾“å…¥ï¼š
- "ç»™æˆ‘è¯¦ç»†çš„å­¦ç”Ÿè®°å½•ç”¨è¡¨æ ¼å±•ç¤º"
- "è½¬åˆ°å®¢æˆ·æ± ä¸­å¿ƒ"
```

### ç»§ç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

æŒ‰ç…§æ–‡æ¡£æ‰§è¡Œå‰©ä½™æ¨¡å—æå–ï¼š
- ResponseIntegratorï¼ˆçº¦2å°æ—¶ï¼‰
- SSEHandlerï¼ˆçº¦3å°æ—¶ï¼‰
- ToolExecutorï¼ˆçº¦4å°æ—¶ï¼‰

å‚è€ƒï¼š
- `docs/Stage1-Execution-Plan-Detailed.md`
- æ¨¡ä»¿SecurityCheckerçš„æå–æ–¹æ³•

### é•¿æœŸè§„åˆ’

- å®šæœŸæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆè®¾ç½®CIæ£€æŸ¥ï¼‰
- å»ºç«‹ä»£ç reviewæµç¨‹
- æŒç»­ä¼˜åŒ–å¤§æ–‡ä»¶

---

## ğŸ“š ç›¸å…³èµ„æº

### æ ¸å¿ƒæ–‡æ¡£
- [æç¤ºè¯é‡æ„æŠ¥å‘Š](./Prompt-Template-System-Refactoring.md)
- [åç«¯åˆ†ææŠ¥å‘Š](./AI-Backend-Modularization-Analysis.md)
- [Coordinatorç°å®æƒ…å†µ](./Coordinator-Migration-Reality-Check.md)

### æ‰§è¡Œè®¡åˆ’
- [è¿ç§»è®¡åˆ’](./Coordinator-Migration-Plan.md)
- [é˜¶æ®µ1è®¡åˆ’](./Stage1-Execution-Plan-Detailed.md)

### æç¤ºè¯æ¨¡æ¿
- [æ¨¡æ¿README](../server/src/services/ai-operator/prompts/README.md)

---

**å®Œæˆæ—¶é—´**: 2025-11-05  
**çŠ¶æ€**: âœ… æ ¸å¿ƒå·¥ä½œå®Œæˆï¼Œç¼–è¯‘é€šè¿‡  
**ä¸‹ä¸€æ­¥**: å»ºè®®å…ˆæµ‹è¯•æ•ˆæœï¼ŒéªŒè¯ä¿®å¤  
**å¯é€‰**: ç»§ç»­æ¨¡å—æå–ï¼ˆçº¦8å°æ—¶ï¼‰

