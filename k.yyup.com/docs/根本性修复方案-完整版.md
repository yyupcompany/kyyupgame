# æ ¹æœ¬æ€§ä¿®å¤æ–¹æ¡ˆ - å®Œæ•´ç‰ˆï¼ˆä¸å·¥å…·ç®¡ç†ç³»ç»ŸåŒæ­¥ï¼‰

**æ—¥æœŸ**: 2025-10-27  
**é—®é¢˜**: AIå·¥å…·é€‰æ‹©é”™è¯¯ - æŒç»­é€‰æ‹©read_data_recordè€Œéany_query  
**æ ¹æœ¬åŸå› **: å·¥å…·é€‰æ‹©å™¨ç¼ºä¹æŸ¥è¯¢ç‰¹å¾åˆ†æï¼Œç³»ç»Ÿæç¤ºè¯ç¼ºä¹å·¥å…·é€‰æ‹©è§„åˆ™

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### ç°æœ‰å·¥å…·ç®¡ç†ç³»ç»Ÿæ¶æ„
```
ToolRegistry (å·¥å…·æ³¨å†Œè¡¨)
    â†“
ToolSelector (å·¥å…·é€‰æ‹©å™¨) â† é—®é¢˜åœ¨è¿™é‡Œï¼
    â†“
ToolLoader (å·¥å…·åŠ è½½å™¨)
    â†“
ToolManager (å·¥å…·ç®¡ç†å™¨)
```

### é—®é¢˜æ ¹æº
1. **ToolSelectorç¼ºä¹æŸ¥è¯¢åˆ†æ**
   - åªåŸºäº"åŠŸèƒ½æ„å›¾"é€‰æ‹©å·¥å…·
   - æ²¡æœ‰åˆ†æ"æŸ¥è¯¢ç‰¹å¾"ï¼ˆæ˜¯å¦æœ‰è¿‡æ»¤ã€æ’åºã€ç»Ÿè®¡ç­‰ï¼‰
   - å¯¼è‡´å¤æ‚æŸ¥è¯¢ä¹Ÿé€‰æ‹©read_data_record

2. **å·¥å…·æƒé‡é…ç½®ä¸åˆç†**
   - read_data_recordæƒé‡: 8
   - any_queryæƒé‡: 5
   - å¤æ‚æŸ¥è¯¢æ—¶åº”è¯¥åè½¬æƒé‡

3. **ç³»ç»Ÿæç¤ºè¯ç¼ºä¹å·¥å…·é€‰æ‹©è§„åˆ™**
   - AIæ²¡æœ‰æ˜ç¡®çš„å·¥å…·é€‰æ‹©æŒ‡å¯¼
   - ä¾èµ–AIè‡ªå·±åˆ¤æ–­ï¼Œå®¹æ˜“å‡ºé”™

---

## ğŸ”§ ä¸‰å±‚æ ¹æœ¬æ€§ä¿®å¤æ–¹æ¡ˆ

### ç¬¬ä¸€å±‚ï¼šå¢å¼ºToolSelectorï¼ˆæœ€å…³é”®ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `server/src/services/ai/tools/core/tool-selector.service.ts`

**æ ¸å¿ƒä¿®æ”¹**ï¼šåœ¨`selectToolsByFunction()`ä¸­æ·»åŠ æŸ¥è¯¢ç‰¹å¾åˆ†æ

```typescript
async selectToolsByFunction(context: ToolSelectionContext): Promise<string[]> {
  // 1. æ–°å¢ï¼šåˆ†ææŸ¥è¯¢ç‰¹å¾
  const queryFeatures = this.analyzeQueryFeatures(context.query);
  console.log('ğŸ” [æŸ¥è¯¢ç‰¹å¾åˆ†æ]', queryFeatures);
  
  // 2. åŸºäºæŸ¥è¯¢ç‰¹å¾è°ƒæ•´å·¥å…·é€‰æ‹©
  if (queryFeatures.isComplex) {
    // å¤æ‚æŸ¥è¯¢ï¼šä¼˜å…ˆä½¿ç”¨any_query
    return this.selectComplexQueryTools(context);
  } else {
    // ç®€å•æŸ¥è¯¢ï¼šå¯ä»¥ä½¿ç”¨read_data_record
    return this.selectSimpleQueryTools(context);
  }
}

// æ–°å¢æ–¹æ³•ï¼šåˆ†ææŸ¥è¯¢ç‰¹å¾
private analyzeQueryFeatures(query: string): QueryFeatures {
  return {
    hasFilters: /è¿‡æ»¤|ç”·|å¥³|å¤§ç­|ä¸­ç­|åœ¨èŒ|è¯·å‡/.test(query),
    hasSorting: /æ’åº|ä»é«˜åˆ°ä½|ä»ä½åˆ°é«˜|æŒ‰/.test(query),
    hasStatistics: /ç»Ÿè®¡|æ±‚å’Œ|å¹³å‡|æœ€å¤§|æœ€å°/.test(query),
    hasJoin: /åŠå…¶|å’Œ|å…³è”|å¯¹åº”/.test(query),
    isComplex: false // ç”±ä¸Šé¢çš„æ¡ä»¶å†³å®š
  };
}

// æ–°å¢æ–¹æ³•ï¼šå¤æ‚æŸ¥è¯¢å·¥å…·é€‰æ‹©
private selectComplexQueryTools(context: ToolSelectionContext): string[] {
  // ä¼˜å…ˆè¿”å›any_query
  return ['any_query', 'render_component'];
}

// æ–°å¢æ–¹æ³•ï¼šç®€å•æŸ¥è¯¢å·¥å…·é€‰æ‹©
private selectSimpleQueryTools(context: ToolSelectionContext): string[] {
  // å¯ä»¥ä½¿ç”¨read_data_recordæˆ–any_query
  return ['read_data_record', 'any_query', 'render_component'];
}
```

### ç¬¬äºŒå±‚ï¼šè°ƒæ•´å·¥å…·æƒé‡é…ç½®

**ä¿®æ”¹æ–‡ä»¶**: `server/src/services/ai/tools/config/tool-groups.config.ts`

**æ ¸å¿ƒä¿®æ”¹**ï¼šæ ¹æ®æŸ¥è¯¢å¤æ‚åº¦åŠ¨æ€è°ƒæ•´æƒé‡

```typescript
// åŸæ¥çš„é™æ€æƒé‡
toolWeights: {
  'read_data_record': 8,
  'any_query': 5,
  // ...
}

// æ”¹ä¸ºï¼šæ ¹æ®æŸ¥è¯¢ç‰¹å¾åŠ¨æ€è°ƒæ•´
getToolWeights(queryFeatures: QueryFeatures): Record<string, number> {
  if (queryFeatures.isComplex) {
    // å¤æ‚æŸ¥è¯¢ï¼šany_queryä¼˜å…ˆçº§æ›´é«˜
    return {
      'any_query': 10,           // æå‡åˆ°æœ€é«˜
      'read_data_record': 1,     // é™ä½åˆ°æœ€ä½
      'render_component': 9,
      // ...
    };
  } else {
    // ç®€å•æŸ¥è¯¢ï¼šread_data_recordä¼˜å…ˆçº§æ›´é«˜
    return {
      'read_data_record': 8,
      'any_query': 5,
      'render_component': 10,
      // ...
    };
  }
}
```

### ç¬¬ä¸‰å±‚ï¼šç³»ç»Ÿæç¤ºè¯å¼ºåŒ–

**ä¿®æ”¹æ–‡ä»¶**: `server/src/services/ai-operator/unified-intelligence.service.ts`

**æ ¸å¿ƒä¿®æ”¹**ï¼šæ·»åŠ å·¥å…·é€‰æ‹©å†³ç­–æ ‘åˆ°ç³»ç»Ÿæç¤ºè¯

```
## ğŸ¯ å·¥å…·é€‰æ‹©å†³ç­–æ ‘ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰

### åˆ¤æ–­æŸ¥è¯¢å¤æ‚åº¦
1. æ˜¯å¦åŒ…å«è¿‡æ»¤æ¡ä»¶ï¼Ÿ(æ€§åˆ«ã€å¹´é¾„ã€ç­çº§ã€çŠ¶æ€ç­‰)
2. æ˜¯å¦åŒ…å«æ’åºè¦æ±‚ï¼Ÿ(æŒ‰XXæ’åº)
3. æ˜¯å¦åŒ…å«ç»Ÿè®¡è®¡ç®—ï¼Ÿ(ç»Ÿè®¡ã€æ±‚å’Œã€å¹³å‡)
4. æ˜¯å¦åŒ…å«å¤šè¡¨å…³è”ï¼Ÿ(å­¦ç”ŸåŠå…¶ç­çº§)
5. æ˜¯å¦åŒ…å«å¤æ‚æ¡ä»¶ï¼Ÿ(ä¸”ã€æˆ–ã€é)

### å·¥å…·é€‰æ‹©è§„åˆ™
- å¦‚æœä»»ä½•ä¸€é¡¹ä¸º"æ˜¯" â†’ å¿…é¡»ä½¿ç”¨ any_query
- å¦‚æœå…¨éƒ¨ä¸º"å¦" â†’ å¯ä»¥ä½¿ç”¨ read_data_record
- å¦‚æœä¸ç¡®å®š â†’ ä¼˜å…ˆä½¿ç”¨ any_queryï¼ˆæ›´å®‰å…¨ï¼‰

### ç¦æ­¢è§„åˆ™
- âŒ ç¦æ­¢ç”¨read_data_recordå¤„ç†æœ‰è¿‡æ»¤çš„æŸ¥è¯¢
- âŒ ç¦æ­¢ç”¨read_data_recordå¤„ç†æœ‰æ’åºçš„æŸ¥è¯¢
- âŒ ç¦æ­¢ç”¨read_data_recordå¤„ç†ç»Ÿè®¡æŸ¥è¯¢
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šå¢å¼ºToolSelectorï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. åœ¨`selectToolsByFunction()`ä¸­æ·»åŠ `analyzeQueryFeatures()`
2. æ ¹æ®æŸ¥è¯¢ç‰¹å¾é€‰æ‹©ä¸åŒçš„å·¥å…·é›†åˆ
3. æµ‹è¯•éªŒè¯

### æ­¥éª¤2ï¼šè°ƒæ•´å·¥å…·æƒé‡ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. ä¿®æ”¹`tool-groups.config.ts`
2. å®ç°`getToolWeights()`åŠ¨æ€æƒé‡æ–¹æ³•
3. åœ¨ToolSelectorä¸­ä½¿ç”¨åŠ¨æ€æƒé‡

### æ­¥éª¤3ï¼šæ›´æ–°ç³»ç»Ÿæç¤ºè¯ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. æ·»åŠ å·¥å…·é€‰æ‹©å†³ç­–æ ‘
2. åœ¨ç›´è¿æ¨¡å¼å’Œæ™ºèƒ½ä»£ç†æ¨¡å¼ä¸­éƒ½æ·»åŠ 

---

## âœ… é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç¬¬1è½®å·¥å…·é€‰æ‹©æ­£ç¡®ç‡ | 0% | 100% |
| å¹³å‡è½®æ•° | 4è½® | 1è½® |
| ç³»ç»Ÿå¯ç»´æŠ¤æ€§ | ä½ | é«˜ |
| ä¸å·¥å…·ç®¡ç†ç³»ç»Ÿçš„é›†æˆ | æ—  | å®Œå…¨é›†æˆ |

---

## ğŸš€ ä¼˜åŠ¿

1. **æ ¹æœ¬è§£å†³é—®é¢˜**ï¼šåœ¨å·¥å…·é€‰æ‹©é˜¶æ®µå°±åšå¯¹ï¼Œè€Œä¸æ˜¯äº‹åéªŒè¯
2. **ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ**ï¼šå……åˆ†åˆ©ç”¨ToolSelectorã€ToolWeightsç­‰ç°æœ‰æœºåˆ¶
3. **å¯æ‰©å±•æ€§å¼º**ï¼šæ–°å¢å·¥å…·æ—¶åªéœ€æ›´æ–°æƒé‡é…ç½®
4. **æ˜“äºç»´æŠ¤**ï¼šå·¥å…·é€‰æ‹©è§„åˆ™é›†ä¸­ç®¡ç†
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ä¸å¿…è¦çš„é‡è¯•ï¼Œæå‡å“åº”é€Ÿåº¦

---

**ä¸‹ä¸€æ­¥**: ç«‹å³å®æ–½æ­¥éª¤1-3ï¼Œç„¶åè¿›è¡Œæµ‹è¯•éªŒè¯

