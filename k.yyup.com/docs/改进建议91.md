# 改进建议 91

日期：2025-09-01
范围：AI 助手（前端 AIAssistant.vue / 统一智能接口 / 后端优化控制器）

## 目标
- 提升稳定性与一致性（接口契约、SSE 流、并发安全）
- 优化体验与可观测性（状态分轨、指标真实、历史语义清晰）
- 完善能力与工程化（参数化灰度、上传/语音增强、E2E 覆盖）

## 优先级与路线图
- P0（本周）：
  1) 统一后端响应契约并在 request 层适配（会话与查询）
  2) 重写 SSE 解析器（事件边界、data 聚合、指针循环、事件 id）
  3) 工具调用并发安全：引入 callId + Map 管理
  4) 修复 processingTime 统计为真实耗时
  5) 统一组件化回答协议并复用同一解析函数
- P1（下周）：
  6) 思考区与状态提示分轨渲染，移除重复打字机
  7) 统一 completeAIResponse 与 finally 的展示语义
  8) 页面介绍消息持久化 type=page-intro 并在摘要中过滤
  9) 快捷操作/导航成功写入结构化 metadata（用于分析）
- P2（两周内）：
  10) 复杂度评估参数化与灰度开关（阈值、contextSize、maxTools）
  11) 上传组件增强：批量/进度/失败重传；统一 accessUrl 字段
  12) 语音入/出增强：端点检测、播放打断、降级策略
  13) 新增关键路径 E2E：SSE 序列、工具并发、导航兜底、会话 URL 同步、上传与语音禁用态

---

## 详细建议与验收标准

### 1) 统一响应契约 + request 适配（P0）
- 痛点：会话创建多形态返回导致前端猜测解析，易脏数据
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:532-548,539
- 建议：后端统一返回 { success, data: { id } }；request 统一解包
- 验收：前端仅读取 data.id；移除临时 ID 兜底路径；切换会话/刷新稳定

### 2) SSE 解析器重写（P0）
- 痛点：按行解析 + indexOf 查找 next data 行，重复行/多 data 段会错位
  - 位置：client/src/api/endpoints/function-tools.ts:121-131,173-191
- 建议：以空行“\n\n”为事件分隔，聚合多 data，指针推进；支持 event:id；心跳跳过
- 验收：
  - 正确处理重复事件、分块、粘包；流结束有 final/complete 之一
  - 异常回退：网络中断可识别并触发降级提示

### 3) 工具并发管理（P0）
- 痛点：仅更新“最后一个调用”，并发时状态串扰
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:1987-2006,2028-2046
- 建议：事件携带 callId；前端 Map<callId, state> 管理；完成/错误均按 callId 定位
- 验收：并行 3+ 调用状态独立，结果与步骤按各自时间线展示

### 4) processingTime 真实统计（P0）
- 痛点：复杂查询 processingTime 恒为 0
  - 位置：server/src/controllers/ai-assistant-optimized.controller.ts:446
- 建议：控制器入参记录 startTime；messageService 返回耗时或在控制器测量
- 验收：stats 中平均耗时与端到端日志一致（±5%）

### 5) 统一组件化回答协议（P0）
- 痛点：历史用 [COMPONENTS]…，流式用 ```json…```，两套协议并存
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:1096-1121,2199-2216
- 建议：统一使用 ```json；抽象 parseComponentData 供历史/流式共用
- 验收：历史与流式均能正确渲染 ComponentRenderer，无歧义

### 6) 思考区与状态提示分轨（P1）
- 痛点：thinking 更新与状态打字机交叉引发闪烁
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:1921-1929
- 建议：独立 statusStrip；thinking 仅接收增量文本，状态区覆盖式刷新
- 验收：长思考流畅，无光标跳动与内容回滚

### 7) completeAIResponse 语义统一（P1）
- 痛点：“永久保留”与 finally 隐藏冲突
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:1154-1175,1868-1872
- 建议：明确策略 A 或 B：
  - A 保留当前块并淡出；B 立即隐藏，历史插入完整内容
- 验收：策略文档化，代码单一实现，无双重状态

### 8) 页面介绍消息类型化（P1）
- 痛点：与普通消息混淆，影响摘要
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:2311-2335
- 建议：metadata.type='page-intro' 持久化；列表/摘要过滤
- 验收：会话摘要不计入介绍消息；未读数准确

### 9) 快捷/导航 metadata 结构化（P1）
- 建议：写入 { action, route, latency, success }，用于优化命中率
- 验收：统计面板可见命中率与中位响应时间

### 10) 复杂度评估参数化与灰度（P2）
- 建议：阈值、maxTools、contextSize 读取配置；按 userId/role 灰度
- 验收：不重启即可调整；灰度人群命中率与成本曲线可观测

### 11) 上传组件增强（P2）
- 建议：多文件选择、进度条、失败重传；后端统一返回 accessUrl
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:1329-1391
- 验收：并发 5 个文件稳定；失败网络模拟下自动重试 ≤3 次

### 12) 语音入/出增强（P2）
- 建议：端点检测（VAD）、TTS 播放打断与队列、降级（禁用麦克/音频时提示）
  - 位置：client/src/components/ai-assistant/AIAssistant.vue:2149-2178
- 验收：连续对话不卡顿；禁用态清晰提示

### 13) 关键路径 E2E（P2）
- 场景：SSE 事件序列、工具并发、导航兜底、会话 URL 同步、上传与语音禁用态
- 验收：CI 稳定通过；失败日志含事件回放

---

## 风险与回滚
- SSE 解析器更改：先在灰度开关下启用；保留旧解析为 fallback
- 协议统一：保留双协议过渡 1 周，埋点两端对齐率

## 指标与度量
- 端到端成功率、平均/95 分位响应时间
- SSE 事件丢失率、工具调用对齐率
- Token 节省率、Direct/Semantic/Complex 命中占比

## 时间安排（建议）
- 本周：P0 全量；提交回归用例
- 下周：P1 完成 + 部分 P2 启动
- 两周内：P2 收尾 + 指标达标评估

---

## 主要代码参考
- client/src/components/ai-assistant/AIAssistant.vue:532, 986, 1096, 1154, 1543, 1665, 1921, 1987, 2028, 2050, 2149, 2199, 2311, 258
- client/src/api/endpoints/function-tools.ts:121, 173
- server/src/controllers/ai-assistant-optimized.controller.ts:130, 360, 413, 446, 711
- server/src/routes/ai-assistant-optimized.routes.ts:12, 33, 74