# VOSéŸ³é¢‘å¤„ç†ä¼˜åŒ–æ€»ç»“

## ðŸ“Š çŽ°çŠ¶åˆ†æž

### å½“å‰å®žçŽ°çš„é—®é¢˜

| é—®é¢˜ | å½±å“ | ä¸¥é‡æ€§ |
|------|------|--------|
| âŒ é‡‡æ ·çŽ‡è½¬æ¢æœªå®žçŽ° | éŸ³é¢‘å¤±çœŸæˆ–æ— å£° | ðŸ”´ ä¸¥é‡ |
| âŒ ç¼–ç è½¬æ¢æœªå®žçŽ° | VOSå’ŒASR/TTSä¸å…¼å®¹ | ðŸ”´ ä¸¥é‡ |
| âš ï¸ éŸ³é¢‘ç¼“å†²1ç§’ | ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿ>1.5s | ðŸŸ  é«˜ |
| âš ï¸ RTPæ—¶åºä¸ç²¾ç¡® | éŸ³é¢‘å¡é¡¿ã€ä¸¢åŒ… | ðŸŸ  é«˜ |
| âš ï¸ ASR/TTSåˆ†ç¦» | å¯¹è¯æµç•…åº¦å·® | ðŸŸ¡ ä¸­ |

### æµ‹è¯•æ–‡æ¡£çš„ä¼˜åŠ¿

âœ… **è±†åŒ…å®žæ—¶è¯­éŸ³** - ç«¯åˆ°ç«¯å¤„ç†ï¼ˆASR+LLM+TTSä¸€ä½“ï¼‰
âœ… **é‡‡æ ·çŽ‡è½¬æ¢** - 8kHz â†” 16kHz â†” 24kHzå®Œæ•´æ”¯æŒ
âœ… **ç¼–ç è½¬æ¢** - PCMA â†” PCMè‡ªåŠ¨è½¬æ¢
âœ… **ç²¾ç¡®æ—¶åº** - Â±1-5msç²¾åº¦ï¼ˆvså½“å‰Â±100msï¼‰
âœ… **æ— ç¼“å†²è®¾è®¡** - ç«‹å³è½¬æ¢ç«‹å³å‘é€ï¼ˆvså½“å‰1000msï¼‰
âœ… **çº¯JavaScript** - 7-10msè½¬æ¢é€Ÿåº¦ï¼ˆvs ffmpeg 100-400msï¼‰

---

## ðŸŽ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¿«é€Ÿä¿®å¤ï¼ˆæŽ¨èï¼‰

**ç›®æ ‡**: åœ¨å½“å‰ASR+TTSåˆ†ç¦»æž¶æž„ä¸‹ï¼Œå¿«é€Ÿå®žçŽ°é‡‡æ ·çŽ‡è½¬æ¢

**å·¥ä½œé‡**: 2-3å¤©

**æ­¥éª¤**:
1. âœ… å®‰è£…ä¾èµ–ï¼š`alawmulaw` + `wave-resampler`
2. âœ… åˆ›å»ºéŸ³é¢‘è½¬æ¢å™¨ï¼š`AudioCodecConverter`
3. âœ… é›†æˆåˆ°ASRæµç¨‹ï¼šPCMA 8kHz â†’ PCM 16kHz
4. âœ… é›†æˆåˆ°TTSæµç¨‹ï¼šPCM 24kHz â†’ PCMA 8kHz
5. âœ… ä¼˜åŒ–RTPæ—¶åºï¼šç²¾ç¡®æ—¶é—´æŽ§åˆ¶
6. âœ… ç§»é™¤éŸ³é¢‘ç¼“å†²ï¼šç«‹å³å¤„ç†

**é¢„æœŸæ•ˆæžœ**:
- éŸ³é¢‘è´¨é‡ï¼šä»Žå¤±çœŸ â†’ æ¸…æ™°
- å»¶è¿Ÿï¼šä»Ž>1.5s â†’ <0.5s
- æ—¶åºç²¾åº¦ï¼šä»ŽÂ±100ms â†’ Â±1-5ms

### æ–¹æ¡ˆBï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: è¿ç§»åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³ï¼ˆç«¯åˆ°ç«¯ï¼‰

**å·¥ä½œé‡**: 2-3å‘¨

**ä¼˜åŠ¿**:
- å•ä¸ªWebSocketè¿žæŽ¥
- ç«¯åˆ°ç«¯å¤„ç†ï¼ˆæ›´è‡ªç„¶çš„å¯¹è¯ï¼‰
- æ›´ä½Žçš„å»¶è¿Ÿ
- æ›´å¥½çš„ä¸Šä¸‹æ–‡ç†è§£

**é£Žé™©**:
- éœ€è¦é‡æž„å¯¹è¯æµç¨‹
- éœ€è¦é‡æ–°æµ‹è¯•
- å¯èƒ½éœ€è¦è°ƒæ•´è¯æœ¯æ¨¡æ¿

---

## ðŸ“‹ å®žæ–½æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šé‡‡æ ·çŽ‡è½¬æ¢ï¼ˆå¿…é¡»ï¼‰

- [ ] å®‰è£…ä¾èµ–
  ```bash
  npm install alawmulaw wave-resampler
  ```

- [ ] åˆ›å»ºéŸ³é¢‘è½¬æ¢å™¨
  - æ–‡ä»¶ï¼š`server/src/services/vos/audio-codec-converter.ts`
  - æ–¹æ³•ï¼š`pcmaToPcm16k()`, `pcm24kToPcma()`
  - å‚è€ƒï¼š`docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md`

- [ ] é›†æˆåˆ°ASRæµç¨‹
  - ä¿®æ”¹ï¼š`server/src/services/call-audio-stream.service.ts`
  - åœ¨å‘é€ç»™ASRå‰è¿›è¡Œè½¬æ¢

- [ ] é›†æˆåˆ°TTSæµç¨‹
  - ä¿®æ”¹ï¼š`server/src/services/doubao-realtime-voice.service.ts`
  - åœ¨æŽ¥æ”¶TTSéŸ³é¢‘åŽè¿›è¡Œè½¬æ¢

- [ ] æµ‹è¯•éªŒè¯
  - å•å…ƒæµ‹è¯•ï¼šé‡‡æ ·çŽ‡è½¬æ¢æ­£ç¡®æ€§
  - é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯éŸ³é¢‘æµ
  - æ€§èƒ½æµ‹è¯•ï¼šè½¬æ¢å»¶è¿Ÿ<15ms

### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆæŽ¨èï¼‰

- [ ] ç§»é™¤éŸ³é¢‘ç¼“å†²
  - æ”¹ä¸ºç«‹å³å¤„ç†
  - é¢„æœŸå»¶è¿Ÿå‡å°‘1000ms

- [ ] ç²¾ç¡®RTPæ—¶åº
  - å®žçŽ°ç»å¯¹æ—¶é—´è®¡ç®—
  - é¢„æœŸç²¾åº¦æå‡20å€

- [ ] æ€§èƒ½ç›‘æŽ§
  - æ·»åŠ è½¬æ¢å»¶è¿Ÿæ—¥å¿—
  - ç›‘æŽ§å†…å­˜å ç”¨
  - ç›‘æŽ§CPUå ç”¨

### ç¬¬ä¸‰é˜¶æ®µï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

- [ ] è¯„ä¼°è±†åŒ…å®žæ—¶è¯­éŸ³
  - å¯¹æ¯”æˆæœ¬æ•ˆç›Š
  - è¯„ä¼°è¿ç§»å·¥ä½œé‡
  - åˆ¶å®šå‡çº§è®¡åˆ’

---

## ðŸ”§ å…³é”®æ–‡ä»¶ä¿®æ”¹

### 1. æ–°å»ºæ–‡ä»¶

**`server/src/services/vos/audio-codec-converter.ts`**
- é‡‡æ ·çŽ‡è½¬æ¢ï¼š8kHz â†” 16kHz â†” 24kHz
- ç¼–ç è½¬æ¢ï¼šPCMA â†” PCM
- Bufferå¯¹é½å¤„ç†

### 2. ä¿®æ”¹æ–‡ä»¶

**`server/src/services/call-audio-stream.service.ts`**
- ç§»é™¤1ç§’ç¼“å†²
- æ·»åŠ é‡‡æ ·çŽ‡è½¬æ¢
- ç«‹å³å¤„ç†éŸ³é¢‘

**`server/src/services/doubao-realtime-voice.service.ts`**
- æ·»åŠ é‡‡æ ·çŽ‡è½¬æ¢
- ç«‹å³å‘é€ç»™VOS
- æ·»åŠ æ€§èƒ½æ—¥å¿—

**`server/src/services/vos/vos-dialer.service.ts`**
- å®žçŽ°ç²¾ç¡®RTPæ—¶åº
- ç»å¯¹æ—¶é—´è®¡ç®—
- æ—¶åºç²¾åº¦ç›‘æŽ§

---

## ðŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰åŽå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡ |
|------|--------|--------|------|
| **é‡‡æ ·çŽ‡è½¬æ¢** | âŒ æ—  | âœ… 7-10ms | å¿…é¡» |
| **ç¼–ç è½¬æ¢** | âŒ æ—  | âœ… 2-3ms | å¿…é¡» |
| **éŸ³é¢‘ç¼“å†²** | 1000ms | 0ms | **æ¶ˆé™¤** |
| **RTPç²¾åº¦** | Â±100ms | Â±1-5ms | **20å€** |
| **æ€»å»¶è¿Ÿ** | >1.5s | <0.5s | **3å€** |
| **éŸ³é¢‘è´¨é‡** | å¤±çœŸ/æ— å£° | æ¸…æ™° | **è´¨çš„é£žè·ƒ** |

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ |
|------|--------|--------|
| ç”¨æˆ·è¯´è¯ | 1.5såŽæ‰èƒ½å¬åˆ°AIå›žå¤ | 0.5såŽå°±èƒ½å¬åˆ° |
| éŸ³é¢‘è´¨é‡ | å¯èƒ½å¤±çœŸæˆ–æ— å£° | æ¸…æ™°è‡ªç„¶ |
| å¯¹è¯æµç•…åº¦ | æ˜Žæ˜¾å¡é¡¿ | å‡ ä¹Žæ— å¡é¡¿ |
| ç”¨æˆ·æ»¡æ„åº¦ | ä½Ž | é«˜ |

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–å®žæ–½ï¼ˆ1å¤©ï¼‰

```bash
# 1. å®‰è£…ä¾èµ–
npm install alawmulaw wave-resampler

# 2. å¤åˆ¶éŸ³é¢‘è½¬æ¢å™¨ä»£ç 
# ä»Ž docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md å¤åˆ¶ AudioCodecConverter ç±»

# 3. é›†æˆåˆ°ASRæµç¨‹
# ä¿®æ”¹ call-audio-stream.service.ts

# 4. é›†æˆåˆ°TTSæµç¨‹
# ä¿®æ”¹ doubao-realtime-voice.service.ts

# 5. æµ‹è¯•
npm run test:unit -- audio-codec-converter
```

### å®Œæ•´å®žæ–½ï¼ˆ2-3å¤©ï¼‰

```bash
# åŒ…æ‹¬ä¸Šè¿°æ‰€æœ‰æ­¥éª¤ï¼ŒåŠ ä¸Šï¼š
# - ç²¾ç¡®RTPæ—¶åºæŽ§åˆ¶
# - ç§»é™¤éŸ³é¢‘ç¼“å†²
# - æ€§èƒ½ç›‘æŽ§
# - å®Œæ•´æµ‹è¯•
```

---

## ðŸ“š å‚è€ƒæ–‡æ¡£

1. **VOSè±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£**
   - å®Œæ•´çš„æµ‹è¯•æµç¨‹
   - éŸ³é¢‘å¤„ç†æœ€ä½³å®žè·µ
   - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

2. **éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—**
   - è¯¦ç»†çš„ä»£ç ç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£å†³
   - æµ‹è¯•éªŒè¯æ–¹æ³•

3. **VOSéŸ³é¢‘å¤„ç†å¯¹æ¯”åˆ†æž**
   - æž¶æž„å¯¹æ¯”
   - æŠ€æœ¯å¯¹æ¯”
   - æ”¹è¿›å»ºè®®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§

- âœ… ä¸ŽçŽ°æœ‰ASR/TTSå…¼å®¹
- âœ… ä¸ŽVOS SIP/RTPå…¼å®¹
- âœ… ä¸Žè¯æœ¯æ¨¡æ¿ç³»ç»Ÿå…¼å®¹

### é£Žé™©

- ðŸŸ¡ éœ€è¦å……åˆ†æµ‹è¯•
- ðŸŸ¡ éœ€è¦æ€§èƒ½ç›‘æŽ§
- ðŸŸ¡ éœ€è¦å›žæ»šæ–¹æ¡ˆ

### å›žæ»šæ–¹æ¡ˆ

å¦‚æžœå‡ºçŽ°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›žæ»šï¼š
```bash
# æ¢å¤åˆ°åŽŸå§‹ç‰ˆæœ¬
git checkout HEAD -- server/src/services/
```

---

## ðŸ“ž æ”¯æŒ

### é—®é¢˜æŽ’æŸ¥

1. **éŸ³é¢‘æ— å£°**
   - æ£€æŸ¥é‡‡æ ·çŽ‡è½¬æ¢å‚æ•°
   - æ£€æŸ¥ç¼–ç è½¬æ¢æ˜¯å¦æˆåŠŸ
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **éŸ³é¢‘å¤±çœŸ**
   - æ£€æŸ¥Bufferå¯¹é½
   - æ£€æŸ¥é‡‡æ ·çŽ‡æ˜¯å¦æ­£ç¡®
   - å°è¯•è°ƒæ•´è½¬æ¢å‚æ•°

3. **å»¶è¿Ÿè¿‡é•¿**
   - æ£€æŸ¥æ˜¯å¦ç§»é™¤äº†ç¼“å†²
   - æ£€æŸ¥RTPæ—¶åºæŽ§åˆ¶
   - ç›‘æŽ§CPUå ç”¨

### èŽ·å–å¸®åŠ©

- æŸ¥çœ‹ `docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md` ä¸­çš„å¸¸è§é—®é¢˜
- æŸ¥çœ‹ `docs/VOSè±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£.md` ä¸­çš„æ•…éšœæŽ’æŸ¥
- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## ðŸŽ‰ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- âœ… éŸ³é¢‘è´¨é‡æ˜¾è‘—æå‡
- âœ… å»¶è¿Ÿå‡å°‘3å€
- âœ… ç”¨æˆ·ä½“éªŒæ˜Žæ˜¾æ”¹å–„

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
- âœ… ç³»ç»Ÿç¨³å®šæ€§æé«˜
- âœ… ç”¨æˆ·æ»¡æ„åº¦æå‡
- âœ… å¯ä»¥è€ƒè™‘å‡çº§åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
- âœ… å®Œæ•´çš„AIè¯­éŸ³å¯¹è¯ç³»ç»Ÿ
- âœ… ä¸šç•Œé¢†å…ˆçš„éŸ³é¢‘è´¨é‡
- âœ… å¯å•†ç”¨çš„å‘¼å«ä¸­å¿ƒè§£å†³æ–¹æ¡ˆ

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åŽæ›´æ–°**: 2025-10-25  
**çŠ¶æ€**: å¾…å®¡æ‰¹

