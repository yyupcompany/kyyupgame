# ğŸ¤– æ™ºèƒ½ä»£ç†åŠŸèƒ½æ£€æµ‹æŠ¥å‘Š

## ğŸ“‹ æ£€æµ‹æ¦‚è¿°

æœ¬æŠ¥å‘Šä»AIAssistant.vueä¸­å‹¾é€‰æ™ºèƒ½ä»£ç†å¼€å§‹ï¼Œå…¨é¢æ£€æµ‹å¤æ‚è°ƒç”¨å…³ç³»ã€åˆ›å»ºä»»åŠ¡åŠŸèƒ½æ”¯æŒæƒ…å†µï¼Œä»¥åŠå¯èƒ½çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­ç‚¹å’Œé”™è¯¯ã€‚

---

## ğŸ” æ™ºèƒ½ä»£ç†è§¦å‘æµç¨‹æ£€æµ‹

### 1. å‰ç«¯è§¦å‘æœºåˆ¶

#### âœ… æ­£å¸¸æµç¨‹
```typescript
// ä½ç½®: client/src/components/ai-assistant/InputArea.vue:189
const handleSmartAgentClick = () => {
  if (!props.canAutoExecute) {
    ElMessage.warning('æ‚¨æ²¡æœ‰ä½¿ç”¨æ™ºèƒ½ä»£ç†çš„æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜')
    return
  }
  emit('update:autoExecute', !props.autoExecute)
}

// ä½ç½®: client/src/components/ai-assistant/AIAssistant.vue:911
const autoExecute = ref(false)
const canAutoExecute = computed(() => userStore.isAdmin)
```

#### âš ï¸ æ½œåœ¨é—®é¢˜ç‚¹
1. **æƒé™æ£€æŸ¥ä¸å®Œæ•´**: ä»…æ£€æŸ¥`userStore.isAdmin`ï¼Œç¼ºå°‘ç»†ç²’åº¦æƒé™æ§åˆ¶
2. **çŠ¶æ€åŒæ­¥é£é™©**: `autoExecute`çŠ¶æ€å¯èƒ½ä¸åç«¯ä¸åŒæ­¥
3. **ç”¨æˆ·ä½“éªŒé—®é¢˜**: éç®¡ç†å‘˜ç”¨æˆ·çœ‹åˆ°æŒ‰é’®ä½†æ— æ³•ä½¿ç”¨

### 2. æ¶ˆæ¯å‘é€æµç¨‹

#### âœ… æ™ºèƒ½ä»£ç†æ¨¡å¼æ£€æµ‹
```typescript
// ä½ç½®: AIAssistant.vue:2280
if (autoExecute.value) {
  console.log('ğŸ¤– æ™ºèƒ½ä»£ç†æ¨¡å¼å·²æ¿€æ´»ï¼Œä¼˜å…ˆä½¿ç”¨AIåŠ©æ‰‹å¤„ç†è¯·æ±‚')
}

// ä½ç½®: AIAssistant.vue:2445
metadata: {
  enableTools: autoExecute.value,
  userRole: userStore.userInfo?.role || 'ADMIN'
}
```

#### âš ï¸ æ½œåœ¨é—®é¢˜ç‚¹
1. **é»˜è®¤è§’è‰²é£é™©**: å½“`userStore.userInfo?.role`ä¸ºç©ºæ—¶ï¼Œé»˜è®¤ä¸º'ADMIN'
2. **å…ƒæ•°æ®ä¼ é€’ä¸ä¸€è‡´**: ä¸åŒè°ƒç”¨è·¯å¾„ä¼ é€’çš„metadataç»“æ„å¯èƒ½ä¸åŒ

---

## ğŸ› ï¸ å¤æ‚è°ƒç”¨å…³ç³»æ£€æµ‹

### 1. ä¸‰çº§åˆ†çº§æ£€ç´¢ç³»ç»Ÿ

#### âœ… ç³»ç»Ÿæ¶æ„
```typescript
// ä½ç½®: server/src/routes/ai/unified-intelligence.routes.ts:231
async function processWithTieredRetrieval(userRequest) {
  // ç¬¬ä¸€çº§ï¼šç›´æ¥å“åº”æ£€ç´¢ (æ¯«ç§’çº§)
  const directResponse = await directResponseService.executeDirectAction('auto', userRequest.content);
  
  // ç¬¬äºŒçº§ï¼šå¤æ‚åº¦è¯„ä¼° (ç§’çº§)
  const complexityResult = await evaluateQueryComplexity(userRequest.content);
  
  // ç¬¬ä¸‰çº§ï¼šå®Œæ•´AIå¤„ç† (åˆ†é’Ÿçº§)
  const aiResponse = await unifiedIntelligenceService.processUserRequest(userRequest);
}
```

#### âš ï¸ ä¸šåŠ¡é€»è¾‘åˆ¤æ–­ç‚¹é”™è¯¯
1. **çº§åˆ«è·³è·ƒé€»è¾‘ç¼ºé™·**:
   ```typescript
   // é—®é¢˜: ç½‘ç»œæœç´¢ç›´æ¥è·³åˆ°ç¬¬ä¸‰çº§ï¼Œè·³è¿‡å¤æ‚åº¦è¯„ä¼°
   if (userRequest?.context?.enableWebSearch) {
     console.log('ğŸ” æ£€æµ‹åˆ°ç½‘ç»œæœç´¢ï¼Œç›´æ¥è·³åˆ°ç¬¬ä¸‰çº§');
     return await unifiedIntelligenceService.processUserRequest(userRequest);
   }
   ```

2. **å¤æ‚åº¦è¯„ä¼°ä¸å‡†ç¡®**:
   ```typescript
   // ä½ç½®: unified-intelligence.routes.ts:407
   const simplePatterns = [/^(ä½ å¥½|è°¢è°¢|å†è§)/];
   const complexPatterns = [/åˆ›å»º|ç”Ÿæˆ|æ‰§è¡Œ|æ“ä½œ/];
   // é—®é¢˜: æ­£åˆ™è¡¨è¾¾å¼è¿‡äºç®€å•ï¼Œå®¹æ˜“è¯¯åˆ¤
   ```

### 2. å·¥å…·è°ƒç”¨æœºåˆ¶

#### âœ… å·¥å…·é€‰æ‹©æµç¨‹
```typescript
// ä½ç½®: server/src/services/ai/message.service.ts:571
if (metadata?.enableTools === true) {
  const selectedTools = await toolManager.getToolsForQuery({
    query: content,
    userRole: metadata?.userRole,
    maxTools: 3
  });
}
```

#### âš ï¸ å·¥å…·è°ƒç”¨é”™è¯¯ç‚¹
1. **å·¥å…·æ•°é‡é™åˆ¶è¿‡ä¸¥**: æœ€å¤š3ä¸ªå·¥å…·å¯èƒ½ä¸è¶³ä»¥å¤„ç†å¤æ‚ä»»åŠ¡
2. **è§’è‰²æƒé™è¿‡æ»¤ä¸å®Œå–„**:
   ```typescript
   // ä½ç½®: message.service.ts:601
   const role = (metadata?.userRole || 'user').toLowerCase();
   if (role === 'admin') return true;
   // é—®é¢˜: åªæœ‰adminå’Œå…¶ä»–ä¸¤ç§è§’è‰²ï¼Œç¼ºå°‘ç»†åˆ†æƒé™
   ```

3. **å·¥å…·æ‰§è¡Œå¤±è´¥å¤„ç†ä¸å½“**:
   ```typescript
   // ä½ç½®: unified-intelligence.service.ts:4206
   catch (error) {
     return {
       success: false,
       error: 'Functionå·¥å…·è°ƒç”¨å¤±è´¥',
       message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
     };
   }
   // é—®é¢˜: é”™è¯¯ä¿¡æ¯è¿‡äºç®€å•ï¼Œä¸åˆ©äºè°ƒè¯•
   ```

---

## ğŸ“ åˆ›å»ºä»»åŠ¡åŠŸèƒ½æ£€æµ‹

### 1. TodoListåˆ›å»ºæ”¯æŒ

#### âœ… åŠŸèƒ½å®Œæ•´æ€§
```typescript
// ä½ç½®: server/src/services/ai-operator/function-tools.service.ts:2460
static async createTodoList(params: {
  title?: string;
  task?: string;
  description?: string;
  tasks?: Array<{
    title: string;
    priority: string;
    estimatedTime?: string;
    dependencies?: string[];
  }>;
})
```

#### âœ… å¤æ‚åº¦åˆ†æ
```typescript
// ä½ç½®: function-tools.service.ts:2688
if (!actualInput || actualInput.trim().length === 0) {
  return {
    needsTodoList: true,
    complexityLevel: 'medium',
    auto_action: 'force_create_todo_list'
  };
}
```

#### âš ï¸ åˆ›å»ºä»»åŠ¡é”™è¯¯ç‚¹
1. **ç©ºè¾“å…¥å¼ºåˆ¶åˆ›å»º**: è¾“å…¥ä¸ºç©ºæ—¶å¼ºåˆ¶åˆ›å»ºTodoListå¯èƒ½ä¸åˆç†
2. **ä»»åŠ¡è§£æé€»è¾‘ç¼ºé™·**:
   ```typescript
   // ä½ç½®: function-tools.service.ts:2484
   if (params.task && !actualTitle) {
     actualTitle = this.extractTitleFromTask(taskDescription);
     // é—®é¢˜: extractTitleFromTaskæ–¹æ³•å¯èƒ½è¿”å›ä¸å‡†ç¡®çš„æ ‡é¢˜
   }
   ```

3. **ä¾èµ–å…³ç³»å¤„ç†ä¸å®Œå–„**: ä»»åŠ¡ä¾èµ–å…³ç³»çš„å¾ªç¯æ£€æµ‹ç¼ºå¤±

### 2. æ­¥éª¤æ‰§è¡Œæœºåˆ¶

#### âœ… å·¥ä½œæµæ”¯æŒ
```typescript
// ä½ç½®: server/src/services/ai-operator/smart-workflow.service.ts:127
const currentStep = workflow.steps[workflow.currentStepIndex];
const dependenciesMet = this.checkDependencies(currentStep, workflow.steps);
if (!dependenciesMet) {
  currentStep.status = 'skipped';
  currentStep.error = 'ä¾èµ–æ¡ä»¶æœªæ»¡è¶³';
}
```

#### âš ï¸ æ­¥éª¤æ‰§è¡Œé”™è¯¯ç‚¹
1. **ä¾èµ–æ£€æŸ¥é€»è¾‘ç®€å•**: åªæ£€æŸ¥ä¾èµ–æ˜¯å¦å­˜åœ¨ï¼Œä¸æ£€æŸ¥ä¾èµ–çš„æ‰§è¡ŒçŠ¶æ€
2. **é”™è¯¯æ¢å¤æœºåˆ¶ä¸è¶³**:
   ```typescript
   // ä½ç½®: smart-workflow.service.ts:148
   try {
     stepResult = await this.executeStep(currentStep, workflow);
   } catch (error) {
     // é—®é¢˜: æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œæ²¡æœ‰å›æ»šæœºåˆ¶
   }
   ```

3. **å¹¶å‘æ‰§è¡Œæ§åˆ¶ç¼ºå¤±**: å¤šä¸ªæ­¥éª¤å¯èƒ½åŒæ—¶æ‰§è¡Œï¼Œç¼ºå°‘å¹¶å‘æ§åˆ¶

---

## ğŸš¨ å…³é”®ä¸šåŠ¡é€»è¾‘é”™è¯¯ç‚¹

### 1. æƒé™æ§åˆ¶é”™è¯¯

#### ğŸ”´ ä¸¥é‡é—®é¢˜
```typescript
// ä½ç½®: AIAssistant.vue:2446
userRole: userStore.userInfo?.role || 'ADMIN'
// é—®é¢˜: å½“ç”¨æˆ·è§’è‰²ä¸ºç©ºæ—¶ï¼Œé»˜è®¤ç»™äºˆADMINæƒé™ï¼Œå­˜åœ¨å®‰å…¨é£é™©
```

#### ğŸ”´ æƒé™æ£€æŸ¥ä¸ä¸€è‡´
```typescript
// å‰ç«¯æ£€æŸ¥
const canAutoExecute = computed(() => userStore.isAdmin)

// åç«¯æ£€æŸ¥
enableTools: allowTools && userRole?.toLowerCase() === 'admin'
// é—®é¢˜: å‰åç«¯æƒé™æ£€æŸ¥é€»è¾‘ä¸ä¸€è‡´
```

### 2. çŠ¶æ€åŒæ­¥é”™è¯¯

#### ğŸ”´ ä¼šè¯çŠ¶æ€ä¸åŒæ­¥
```typescript
// ä½ç½®: AIAssistant.vue:477
async function ensureConversation() {
  if (conversationId.value) return conversationId.value
  // é—®é¢˜: å¯èƒ½åˆ›å»ºå¤šä¸ªä¼šè¯ï¼Œå¯¼è‡´çŠ¶æ€æ··ä¹±
}
```

#### ğŸ”´ å·¥å…·æ‰§è¡ŒçŠ¶æ€ä¸¢å¤±
```typescript
// é—®é¢˜: å·¥å…·æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé¡µé¢åˆ·æ–°ï¼Œæ‰§è¡ŒçŠ¶æ€ä¼šä¸¢å¤±
// ç¼ºå°‘æŒä¹…åŒ–æœºåˆ¶
```

### 3. é”™è¯¯å¤„ç†ä¸å®Œå–„

#### ğŸ”´ ç½‘ç»œé”™è¯¯å¤„ç†
```typescript
// ä½ç½®: unified-intelligence.service.ts:4174
catch (searchError) {
  // è¿”å›æ¨¡æ‹Ÿæ•°æ®è€Œä¸æ˜¯çœŸå®é”™è¯¯
  return {
    success: true,
    data: { source: 'mock_fallback' }
  };
}
// é—®é¢˜: éšè—äº†çœŸå®çš„ç½‘ç»œé”™è¯¯ï¼Œç”¨æˆ·æ— æ³•çŸ¥é“æœç´¢å¤±è´¥
```

#### ğŸ”´ è¶…æ—¶å¤„ç†ç¼ºå¤±
```typescript
// å¤§éƒ¨åˆ†APIè°ƒç”¨ç¼ºå°‘è¶…æ—¶è®¾ç½®
// å¯èƒ½å¯¼è‡´è¯·æ±‚æ— é™ç­‰å¾…
```

---

## ğŸ”§ ä¿®å¤å»ºè®®

### 1. æƒé™æ§åˆ¶ä¿®å¤
```typescript
// å»ºè®®ä¿®æ”¹
userRole: userStore.userInfo?.role || 'USER' // é»˜è®¤ä¸ºæ™®é€šç”¨æˆ·
const canAutoExecute = computed(() => 
  userStore.isAdmin || userStore.hasPermission('AI_AGENT_USE')
)
```

### 2. é”™è¯¯å¤„ç†å¢å¼º
```typescript
// å»ºè®®æ·»åŠ 
const executeWithRetry = async (fn, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * Math.pow(2, i)); // æŒ‡æ•°é€€é¿
    }
  }
};
```

### 3. çŠ¶æ€æŒä¹…åŒ–
```typescript
// å»ºè®®æ·»åŠ 
const persistExecutionState = (state) => {
  localStorage.setItem('ai_execution_state', JSON.stringify(state));
};
```

---

## ğŸ“Š æ£€æµ‹ç»“æœæ€»ç»“

### âœ… åŠŸèƒ½æ”¯æŒæƒ…å†µ
- **æ™ºèƒ½ä»£ç†è§¦å‘**: âœ… æ”¯æŒ
- **ä¸‰çº§åˆ†çº§æ£€ç´¢**: âœ… æ”¯æŒ
- **å¤šå·¥å…·è°ƒç”¨**: âœ… æ”¯æŒ
- **TodoListåˆ›å»º**: âœ… æ”¯æŒ
- **æ­¥éª¤æ‰§è¡Œ**: âœ… æ”¯æŒ
- **å·¥ä½œæµç®¡ç†**: âœ… æ”¯æŒ

### âš ï¸ ä¸»è¦é£é™©ç‚¹
1. **æƒé™æ§åˆ¶**: ğŸ”´ é«˜é£é™© - é»˜è®¤ADMINæƒé™
2. **é”™è¯¯å¤„ç†**: ğŸŸ¡ ä¸­é£é™© - é”™è¯¯ä¿¡æ¯ä¸å®Œæ•´
3. **çŠ¶æ€åŒæ­¥**: ğŸŸ¡ ä¸­é£é™© - å¯èƒ½å‡ºç°çŠ¶æ€ä¸ä¸€è‡´
4. **æ€§èƒ½ä¼˜åŒ–**: ğŸŸ¡ ä¸­é£é™© - ç¼ºå°‘è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

### ğŸ¯ ä¼˜å…ˆä¿®å¤é¡¹
1. ä¿®å¤é»˜è®¤æƒé™ä¸ºADMINçš„å®‰å…¨æ¼æ´
2. å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆæœºåˆ¶
3. æ·»åŠ æ‰§è¡ŒçŠ¶æ€æŒä¹…åŒ–
4. å¢å¼ºå·¥å…·è°ƒç”¨çš„é‡è¯•å’Œå›æ»šæœºåˆ¶
5. ä¼˜åŒ–å¤æ‚åº¦è¯„ä¼°ç®—æ³•çš„å‡†ç¡®æ€§

---

## ğŸ” æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. æµ‹è¯•éç®¡ç†å‘˜ç”¨æˆ·å‹¾é€‰æ™ºèƒ½ä»£ç†çš„è¡Œä¸º
2. æµ‹è¯•ç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹çš„å·¥å…·è°ƒç”¨
3. æµ‹è¯•å¤æ‚ä»»åŠ¡çš„TodoListåˆ›å»ºå’Œæ‰§è¡Œ
4. æµ‹è¯•å¹¶å‘å·¥å…·è°ƒç”¨çš„ç¨³å®šæ€§

### å‹åŠ›æµ‹è¯•
1. å¤§é‡å¹¶å‘æ™ºèƒ½ä»£ç†è¯·æ±‚
2. é•¿æ—¶é—´è¿è¡Œçš„å¤æ‚å·¥ä½œæµ
3. ç½‘ç»œä¸ç¨³å®šç¯å¢ƒä¸‹çš„åŠŸèƒ½è¡¨ç°

---

## ğŸ§ª è¯¦ç»†æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹1: æ™ºèƒ½ä»£ç†æƒé™éªŒè¯
```javascript
// æµ‹è¯•åœºæ™¯: éç®¡ç†å‘˜ç”¨æˆ·å°è¯•ä½¿ç”¨æ™ºèƒ½ä»£ç†
describe('æ™ºèƒ½ä»£ç†æƒé™æµ‹è¯•', () => {
  test('éç®¡ç†å‘˜ç”¨æˆ·åº”è¯¥çœ‹åˆ°æƒé™è­¦å‘Š', async () => {
    // æ¨¡æ‹Ÿéç®¡ç†å‘˜ç”¨æˆ·
    userStore.isAdmin = false;

    // ç‚¹å‡»æ™ºèƒ½ä»£ç†æŒ‰é’®
    await wrapper.find('.smart-agent-btn').trigger('click');

    // éªŒè¯è­¦å‘Šæ¶ˆæ¯
    expect(ElMessage.warning).toHaveBeenCalledWith(
      'æ‚¨æ²¡æœ‰ä½¿ç”¨æ™ºèƒ½ä»£ç†çš„æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
    );
  });
});
```

### æµ‹è¯•ç”¨ä¾‹2: å¤æ‚ä»»åŠ¡åˆ›å»ºæµç¨‹
```javascript
// æµ‹è¯•åœºæ™¯: åˆ›å»ºå¤æ‚çš„å…­ä¸€å„¿ç«¥èŠ‚æ´»åŠ¨ä»»åŠ¡
describe('å¤æ‚ä»»åŠ¡åˆ›å»ºæµ‹è¯•', () => {
  test('åº”è¯¥æ­£ç¡®åˆ›å»ºå¤šæ­¥éª¤ä»»åŠ¡æ¸…å•', async () => {
    const taskInput = "ç­–åˆ’å…­ä¸€å„¿ç«¥èŠ‚äº²å­æ´»åŠ¨ï¼ŒåŒ…æ‹¬åœºåœ°å¸ƒç½®ã€èŠ‚ç›®å®‰æ’ã€å®‰å…¨ä¿éšœ";

    // å‘é€æ¶ˆæ¯
    await sendMessage(taskInput, { autoExecute: true });

    // éªŒè¯ä»»åŠ¡åˆ›å»º
    expect(response.data.todoList).toBeDefined();
    expect(response.data.todoList.tasks.length).toBeGreaterThan(3);
    expect(response.data.toolExecutions).toContain('create_todo_list');
  });
});
```

### æµ‹è¯•ç”¨ä¾‹3: å·¥å…·è°ƒç”¨å¤±è´¥æ¢å¤
```javascript
// æµ‹è¯•åœºæ™¯: å·¥å…·è°ƒç”¨å¤±è´¥æ—¶çš„æ¢å¤æœºåˆ¶
describe('å·¥å…·è°ƒç”¨å¤±è´¥æ¢å¤æµ‹è¯•', () => {
  test('å·¥å…·è°ƒç”¨å¤±è´¥åº”è¯¥æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†', async () => {
    // æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨å¤±è´¥
    jest.spyOn(FunctionToolsService, 'executeFunctionCall')
        .mockRejectedValue(new Error('ç½‘ç»œè¿æ¥å¤±è´¥'));

    const result = await processWithTieredRetrieval(userRequest);

    // éªŒè¯é”™è¯¯å¤„ç†
    expect(result.success).toBe(false);
    expect(result.error).toContain('Functionå·¥å…·è°ƒç”¨å¤±è´¥');
  });
});
```

---

## ğŸ”§ å…·ä½“ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æƒé™æ§åˆ¶å¢å¼º
```typescript
// æ–‡ä»¶: client/src/stores/user.ts
interface UserPermissions {
  AI_AGENT_USE: boolean;
  AI_TOOL_ADVANCED: boolean;
  AI_WORKFLOW_CREATE: boolean;
}

// æ–‡ä»¶: client/src/components/ai-assistant/AIAssistant.vue
const canAutoExecute = computed(() => {
  return userStore.hasPermission('AI_AGENT_USE') &&
         (userStore.isAdmin || userStore.hasPermission('AI_TOOL_ADVANCED'));
});

// é»˜è®¤è§’è‰²ä¿®å¤
const getDefaultUserRole = () => {
  if (!userStore.userInfo?.role) {
    console.warn('ç”¨æˆ·è§’è‰²ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è§’è‰²USER');
    return 'USER';
  }
  return userStore.userInfo.role;
};
```

### æ–¹æ¡ˆ2: é”™è¯¯å¤„ç†å¢å¼º
```typescript
// æ–‡ä»¶: server/src/utils/errorHandler.ts
export class AIExecutionError extends Error {
  constructor(
    message: string,
    public code: string,
    public details?: any,
    public recoverable: boolean = true
  ) {
    super(message);
    this.name = 'AIExecutionError';
  }
}

// æ–‡ä»¶: server/src/services/ai-operator/unified-intelligence.service.ts
private async executeWithErrorHandling(toolName: string, args: any): Promise<any> {
  const maxRetries = 3;
  let lastError: Error;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(`ğŸ”„ [${toolName}] å°è¯•æ‰§è¡Œ ${attempt}/${maxRetries}`);

      const result = await FunctionToolsService.executeFunctionCall({
        name: toolName,
        arguments: args
      });

      console.log(`âœ… [${toolName}] æ‰§è¡ŒæˆåŠŸ`);
      return result;

    } catch (error) {
      lastError = error as Error;
      console.error(`âŒ [${toolName}] æ‰§è¡Œå¤±è´¥ (${attempt}/${maxRetries}):`, error);

      // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼ŒæŠ›å‡ºé”™è¯¯
      if (attempt === maxRetries) {
        throw new AIExecutionError(
          `å·¥å…· ${toolName} æ‰§è¡Œå¤±è´¥`,
          'TOOL_EXECUTION_FAILED',
          { originalError: error, attempts: maxRetries },
          false
        );
      }

      // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
      const delay = Math.pow(2, attempt - 1) * 1000;
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

### æ–¹æ¡ˆ3: çŠ¶æ€æŒä¹…åŒ–
```typescript
// æ–‡ä»¶: client/src/utils/executionStateManager.ts
export class ExecutionStateManager {
  private static readonly STORAGE_KEY = 'ai_execution_state';

  static saveState(state: ExecutionState): void {
    try {
      const stateData = {
        ...state,
        timestamp: Date.now(),
        version: '1.0'
      };
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(stateData));
    } catch (error) {
      console.error('ä¿å­˜æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
    }
  }

  static loadState(): ExecutionState | null {
    try {
      const data = localStorage.getItem(this.STORAGE_KEY);
      if (!data) return null;

      const state = JSON.parse(data);

      // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
      if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {
        this.clearState();
        return null;
      }

      return state;
    } catch (error) {
      console.error('åŠ è½½æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
      return null;
    }
  }

  static clearState(): void {
    localStorage.removeItem(this.STORAGE_KEY);
  }
}
```

### æ–¹æ¡ˆ4: å¤æ‚åº¦è¯„ä¼°ä¼˜åŒ–
```typescript
// æ–‡ä»¶: server/src/services/ai/complexity-analyzer.service.ts
export class ComplexityAnalyzer {
  private static readonly COMPLEXITY_INDICATORS = {
    // åŠ¨ä½œè¯æ±‡
    ACTION_WORDS: ['åˆ›å»º', 'ç”Ÿæˆ', 'åˆ¶ä½œ', 'è®¾è®¡', 'ç­–åˆ’', 'æ‰§è¡Œ', 'å®æ–½'],
    // æ—¶é—´åºåˆ—è¯æ±‡
    TIME_SEQUENCE: ['é¦–å…ˆ', 'ç„¶å', 'æ¥ä¸‹æ¥', 'æœ€å', 'æ­¥éª¤', 'é˜¶æ®µ'],
    // å¤šç›®æ ‡è¯æ±‡
    MULTI_TARGET: ['å’Œ', 'ä»¥åŠ', 'åŒæ—¶', 'å¹¶ä¸”', 'è¿˜è¦', 'å¦å¤–'],
    // å¤æ‚åº¦å…³é”®è¯
    COMPLEX_KEYWORDS: ['å·¥ä½œæµ', 'æµç¨‹', 'æ–¹æ¡ˆ', 'è®¡åˆ’', 'ç­–ç•¥', 'ç³»ç»Ÿ']
  };

  static analyzeComplexity(input: string): ComplexityAnalysis {
    const indicators = this.calculateIndicators(input);
    const score = this.calculateScore(indicators);
    const level = this.getComplexityLevel(score);

    return {
      level,
      score,
      indicators,
      needsTodoList: score >= 4,
      recommendation: this.getRecommendation(level, indicators),
      confidence: this.calculateConfidence(indicators)
    };
  }

  private static calculateIndicators(input: string): ComplexityIndicators {
    const text = input.toLowerCase();

    return {
      actionWords: this.countMatches(text, this.COMPLEXITY_INDICATORS.ACTION_WORDS),
      timeSequence: this.countMatches(text, this.COMPLEXITY_INDICATORS.TIME_SEQUENCE),
      multiTarget: this.countMatches(text, this.COMPLEXITY_INDICATORS.MULTI_TARGET),
      complexKeywords: this.countMatches(text, this.COMPLEXITY_INDICATORS.COMPLEX_KEYWORDS),
      length: input.length,
      sentenceCount: input.split(/[ã€‚ï¼ï¼Ÿ.!?]/).length,
      hasNumbers: /\d+/.test(input),
      hasTimeReferences: /\d+[å¤©å°æ—¶åˆ†é’Ÿæœˆå¹´]/.test(input)
    };
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å·¥å…·è°ƒç”¨ä¼˜åŒ–
```typescript
// å¹¶è¡Œå·¥å…·è°ƒç”¨
const executeToolsInParallel = async (tools: ToolCall[]): Promise<ToolResult[]> => {
  const promises = tools.map(async (tool) => {
    try {
      return await executeWithTimeout(
        () => FunctionToolsService.executeFunctionCall(tool),
        30000 // 30ç§’è¶…æ—¶
      );
    } catch (error) {
      return { success: false, error: error.message, toolName: tool.name };
    }
  });

  return Promise.allSettled(promises);
};
```

### 2. ç¼“å­˜æœºåˆ¶
```typescript
// å·¥å…·ç»“æœç¼“å­˜
const toolResultCache = new Map<string, { result: any, timestamp: number }>();

const getCachedResult = (toolName: string, params: any): any | null => {
  const key = `${toolName}_${JSON.stringify(params)}`;
  const cached = toolResultCache.get(key);

  if (cached && Date.now() - cached.timestamp < 5 * 60 * 1000) { // 5åˆ†é’Ÿç¼“å­˜
    return cached.result;
  }

  return null;
};
```

---

## ğŸ¯ ç›‘æ§å’Œå‘Šè­¦

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§
```typescript
// æ€§èƒ½æŒ‡æ ‡æ”¶é›†
interface PerformanceMetrics {
  toolExecutionTime: number;
  complexityAnalysisTime: number;
  totalResponseTime: number;
  errorRate: number;
  retryCount: number;
}

const collectMetrics = (metrics: PerformanceMetrics): void => {
  // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  if (metrics.totalResponseTime > 30000) {
    console.warn('âš ï¸ AIå“åº”æ—¶é—´è¿‡é•¿:', metrics);
  }

  if (metrics.errorRate > 0.1) {
    console.error('ğŸš¨ é”™è¯¯ç‡è¿‡é«˜:', metrics);
  }
};
```

### 2. å¼‚å¸¸å‘Šè­¦
```typescript
// å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦
const detectAnomalies = (executionData: ExecutionData): void => {
  // æ£€æµ‹å¼‚å¸¸æ¨¡å¼
  if (executionData.consecutiveFailures > 3) {
    sendAlert('è¿ç»­æ‰§è¡Œå¤±è´¥', executionData);
  }

  if (executionData.memoryUsage > 500 * 1024 * 1024) { // 500MB
    sendAlert('å†…å­˜ä½¿ç”¨è¿‡é«˜', executionData);
  }
};
```

è¿™ä»½å®Œæ•´çš„æ£€æµ‹æŠ¥å‘Šæä¾›äº†æ™ºèƒ½ä»£ç†åŠŸèƒ½çš„å…¨é¢åˆ†æï¼ŒåŒ…æ‹¬é—®é¢˜è¯†åˆ«ã€ä¿®å¤æ–¹æ¡ˆå’Œä¼˜åŒ–å»ºè®®ï¼Œä¸ºç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§æä¾›äº†é‡è¦ä¿éšœã€‚
