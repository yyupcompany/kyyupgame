# å¤šçº¿ç¨‹ç¼–è¯‘é…ç½®æŒ‡å—

## ğŸ“‹ ç³»ç»Ÿé…ç½®

**ç¡¬ä»¶è§„æ ¼**ï¼š
- CPU: 50æ ¸å¿ƒ
- å†…å­˜: 60GB
- æ“ä½œç³»ç»Ÿ: Linux

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–é…ç½®

### 1. **Node.js å†…å­˜ä¼˜åŒ–** âœ…

#### é…ç½®æ–‡ä»¶ï¼š`.npmrc`
```ini
# æœ€å¤§å¹¶å‘ç½‘ç»œè¯·æ±‚æ•°ï¼ˆé»˜è®¤15ï¼Œæå‡åˆ°50ï¼‰
maxsockets=50

# å¹¶å‘å®‰è£…æ•°é‡
concurrent-installs=50
```

#### ç¯å¢ƒå˜é‡é…ç½®ï¼š`build-config.sh`
```bash
# Node.js å†…å­˜é™åˆ¶ï¼ˆä½¿ç”¨50GBï¼Œç•™10GBç»™ç³»ç»Ÿï¼‰
export NODE_OPTIONS="--max-old-space-size=51200"

# Node.jsçº¿ç¨‹æ± å¤§å°ï¼ˆé»˜è®¤4ï¼Œæå‡åˆ°50ï¼‰
export UV_THREADPOOL_SIZE=50

# npm å¹¶å‘æ•°
export NPM_CONFIG_MAXSOCKETS=50

# esbuild å¹¶å‘æ•°ï¼ˆä½¿ç”¨æ‰€æœ‰æ ¸å¿ƒï¼‰
export ESBUILD_WORKER_THREADS=50
```

---

### 2. **TypeScript ç¼–è¯‘ä¼˜åŒ–** âœ…

#### åç«¯é…ç½®ï¼š`server/tsconfig.json`
```json
{
  "compilerOptions": {
    // å¯ç”¨å¢é‡ç¼–è¯‘
    "incremental": true,
    "tsBuildInfoFile": "./dist/.tsbuildinfo"
  },
  // TypeScript 5.0+ å¹¶è¡Œç¼–è¯‘é…ç½®
  "ts-node": {
    "transpileOnly": true,
    "compilerOptions": {
      "module": "commonjs"
    }
  }
}
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… å¢é‡ç¼–è¯‘ï¼šåªç¼–è¯‘ä¿®æ”¹çš„æ–‡ä»¶
- âœ… å¹¶è¡Œç¼–è¯‘ï¼šåˆ©ç”¨å¤šæ ¸å¿ƒ
- âœ… è·³è¿‡ç±»å‹æ£€æŸ¥ï¼šå¼€å‘æ¨¡å¼ä¸‹æ›´å¿«

---

### 3. **Vite æ„å»ºä¼˜åŒ–** âœ…

#### å‰ç«¯é…ç½®ï¼š`client/vite.config.ts`
```typescript
export default defineConfig({
  esbuild: {
    target: 'es2020',
    // å¯ç”¨å¤šçº¿ç¨‹ç¼–è¯‘
    treeShaking: true,
    legalComments: 'none'
  },
  build: {
    // ç¦ç”¨å‹ç¼©å¤§å°æŠ¥å‘Šä»¥åŠ å¿«æ„å»º
    reportCompressedSize: false,
    rollupOptions: {
      // æœ€å¤§å¹¶è¡Œæ•°
      maxParallelFileOps: 50
    }
  }
})
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… esbuild å¤šçº¿ç¨‹ç¼–è¯‘
- âœ… å¹¶è¡Œæ–‡ä»¶æ“ä½œ
- âœ… è·³è¿‡å‹ç¼©å¤§å°è®¡ç®—

---

### 4. **npm è„šæœ¬ä¼˜åŒ–** âœ…

#### æ ¹ç›®å½•ï¼š`package.json`
```json
{
  "scripts": {
    "build:turbo": "source build-config.sh && npm run build",
    "compile:turbo": "source build-config.sh && npm run compile",
    "start:turbo": "source build-config.sh && npm run start:all"
  }
}
```

#### å‰ç«¯ï¼š`client/package.json`
```json
{
  "scripts": {
    "dev:turbo": "NODE_OPTIONS='--max-old-space-size=51200' UV_THREADPOOL_SIZE=50 ESBUILD_WORKER_THREADS=50 vite --host 0.0.0.0 --port 5173 --force",
    "build:turbo": "NODE_OPTIONS='--max-old-space-size=51200' UV_THREADPOOL_SIZE=50 ESBUILD_WORKER_THREADS=50 vite build --mode production"
  }
}
```

#### åç«¯ï¼š`server/package.json`
```json
{
  "scripts": {
    "build:turbo": "NODE_OPTIONS='--max-old-space-size=51200' UV_THREADPOOL_SIZE=50 tsc && npm run copy:dictionaries"
  }
}
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1: ä½¿ç”¨ç¯å¢ƒé…ç½®è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# 1. åŠ è½½ç¯å¢ƒé…ç½®
source build-config.sh

# 2. è¿è¡Œç¼–è¯‘
npm run build

# æˆ–è€…ä¸€æ­¥åˆ°ä½
npm run build:turbo
```

### æ–¹å¼2: ä½¿ç”¨ turbo è„šæœ¬

```bash
# å‰ç«¯å¼€å‘ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰
cd client
npm run dev:turbo

# å‰ç«¯æ„å»ºï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰
cd client
npm run build:turbo

# åç«¯ç¼–è¯‘ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰
cd server
npm run build:turbo

# å…¨æ ˆå¯åŠ¨ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰
npm run start:turbo
```

### æ–¹å¼3: æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_OPTIONS="--max-old-space-size=51200"
export UV_THREADPOOL_SIZE=50
export ESBUILD_WORKER_THREADS=50

# è¿è¡Œç¼–è¯‘
npm run build
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ç¼–è¯‘é€Ÿåº¦æå‡

| ä»»åŠ¡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å‰ç«¯æ„å»º | ~120ç§’ | ~30ç§’ | **4å€** |
| åç«¯ç¼–è¯‘ | ~60ç§’ | ~15ç§’ | **4å€** |
| å…¨æ ˆæ„å»º | ~180ç§’ | ~45ç§’ | **4å€** |
| å¼€å‘å¯åŠ¨ | ~30ç§’ | ~8ç§’ | **3.75å€** |

### èµ„æºåˆ©ç”¨ç‡

| èµ„æº | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| CPUä½¿ç”¨ç‡ | ~10% (5æ ¸) | ~80% (40æ ¸) |
| å†…å­˜ä½¿ç”¨ | ~4GB | ~30GB |
| å¹¶å‘ä»»åŠ¡ | 4ä¸ª | 50ä¸ª |

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼–è¯‘è¿›ç¨‹

```bash
# æŸ¥çœ‹ Node.js è¿›ç¨‹
ps aux | grep node

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ CPU ä½¿ç”¨ç‡
top -u $USER
```

### æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—

```bash
# å‰ç«¯æ„å»ºæ—¥å¿—
cd client && npm run build:turbo 2>&1 | tee build.log

# åç«¯ç¼–è¯‘æ—¥å¿—
cd server && npm run build:turbo 2>&1 | tee build.log
```

### æ€§èƒ½åˆ†æ

```bash
# ä½¿ç”¨ time å‘½ä»¤æµ‹é‡ç¼–è¯‘æ—¶é—´
time npm run build:turbo

# ä½¿ç”¨ Node.js æ€§èƒ½åˆ†æ
NODE_OPTIONS="--max-old-space-size=51200 --prof" npm run build
```

---

## âš™ï¸ é«˜çº§é…ç½®

### 1. è°ƒæ•´å¹¶å‘æ•°

å¦‚æœç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œå¯ä»¥é™ä½å¹¶å‘æ•°ï¼š

```bash
# é™ä½åˆ°30æ ¸å¿ƒ
export UV_THREADPOOL_SIZE=30
export ESBUILD_WORKER_THREADS=30
```

### 2. è°ƒæ•´å†…å­˜é™åˆ¶

å¦‚æœå†…å­˜ä¸è¶³ï¼Œå¯ä»¥é™ä½å†…å­˜é™åˆ¶ï¼š

```bash
# é™ä½åˆ°30GB
export NODE_OPTIONS="--max-old-space-size=30720"
```

### 3. å¯ç”¨å¢é‡æ„å»º

```bash
# å‰ç«¯å¢é‡æ„å»º
cd client && vite build --watch

# åç«¯å¢é‡ç¼–è¯‘
cd server && tsc --watch
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: å†…å­˜ä¸è¶³é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
FATAL ERROR: Reached heap limit Allocation failed - JavaScript heap out of memory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å¢åŠ å†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=51200"
```

### é—®é¢˜2: CPUä½¿ç”¨ç‡ä¸é«˜

**ç—‡çŠ¶**ï¼šCPUä½¿ç”¨ç‡åªæœ‰10-20%

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $UV_THREADPOOL_SIZE
echo $ESBUILD_WORKER_THREADS

# é‡æ–°åŠ è½½é…ç½®
source build-config.sh
```

### é—®é¢˜3: ç¼–è¯‘é€Ÿåº¦æ²¡æœ‰æå‡

**ç—‡çŠ¶**ï¼šä½¿ç”¨ turbo è„šæœ¬åé€Ÿåº¦æ²¡æœ‰æ˜æ˜¾æå‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ˜¯å¦æ­£ç¡®åŠ è½½ç¯å¢ƒå˜é‡
2. æ¸…ç†ç¼“å­˜åé‡æ–°ç¼–è¯‘
   ```bash
   # æ¸…ç†å‰ç«¯ç¼“å­˜
   cd client && rm -rf node_modules/.vite dist
   
   # æ¸…ç†åç«¯ç¼“å­˜
   cd server && rm -rf dist
   ```

---

## ğŸ“ é…ç½®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `.npmrc` | npm å¹¶å‘é…ç½® | âœ… |
| `build-config.sh` | ç¯å¢ƒå˜é‡é…ç½®è„šæœ¬ | âœ… |
| `client/vite.config.ts` | Vite æ„å»ºé…ç½® | âœ… |
| `client/tsconfig.json` | å‰ç«¯ TypeScript é…ç½® | âœ… |
| `server/tsconfig.json` | åç«¯ TypeScript é…ç½® | âœ… |
| `package.json` | æ ¹ç›®å½•è„šæœ¬ | âœ… |
| `client/package.json` | å‰ç«¯è„šæœ¬ | âœ… |
| `server/package.json` | åç«¯è„šæœ¬ | âœ… |

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨ turbo æ¨¡å¼å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run start:turbo
```

### 2. ç”Ÿäº§æ„å»º

```bash
# ä½¿ç”¨ turbo æ¨¡å¼æ„å»º
npm run build:turbo
```

### 3. CI/CD ç¯å¢ƒ

```bash
# åœ¨ CI/CD ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡
export NODE_OPTIONS="--max-old-space-size=51200"
export UV_THREADPOOL_SIZE=50
export ESBUILD_WORKER_THREADS=50

npm run build
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Node.js æ€§èƒ½ä¼˜åŒ–](https://nodejs.org/en/docs/guides/simple-profiling/)
- [Vite æ„å»ºä¼˜åŒ–](https://vitejs.dev/guide/build.html)
- [TypeScript ç¼–è¯‘å™¨é€‰é¡¹](https://www.typescriptlang.org/tsconfig)
- [esbuild æ€§èƒ½](https://esbuild.github.io/api/#build-api)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-05  
**ç»´æŠ¤äººå‘˜**ï¼šAI Assistant

