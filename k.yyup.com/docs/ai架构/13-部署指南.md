# AIåŠ©æ‰‹ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

**ç‰ˆæœ¬**: 2.0.0  
**æœ€åæ›´æ–°**: 2025-10-08  
**éƒ¨ç½²ç¯å¢ƒ**: Docker + Kubernetes

---

## ğŸ“‹ ç›®å½•

- [éƒ¨ç½²æ¦‚è¿°](#éƒ¨ç½²æ¦‚è¿°)
- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [Dockeréƒ¨ç½²](#dockeréƒ¨ç½²)
- [Kuberneteséƒ¨ç½²](#kuberneteséƒ¨ç½²)
- [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
- [å¥åº·æ£€æŸ¥](#å¥åº·æ£€æŸ¥)

---

## ğŸ¯ éƒ¨ç½²æ¦‚è¿°

### éƒ¨ç½²æ¶æ„

```
ç”Ÿäº§ç¯å¢ƒæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è´Ÿè½½å‡è¡¡å™¨ (Nginx)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯æœåŠ¡å™¨1    â”‚  â”‚   å‰ç«¯æœåŠ¡å™¨2    â”‚
â”‚   (é™æ€èµ„æº)     â”‚  â”‚   (é™æ€èµ„æº)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APIç½‘å…³ (Express)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯æœåŠ¡å™¨1    â”‚  â”‚   åç«¯æœåŠ¡å™¨2    â”‚
â”‚   (AIæœåŠ¡)      â”‚  â”‚   (AIæœåŠ¡)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“é›†ç¾¤                    â”‚
â”‚  - MySQLä¸»ä»                              â”‚
â”‚  - Redisé›†ç¾¤                              â”‚
â”‚  - å‘é‡æ•°æ®åº“                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éƒ¨ç½²ç­–ç•¥

1. **è“ç»¿éƒ¨ç½²** - é›¶åœæœºæ—¶é—´éƒ¨ç½²
2. **æ»šåŠ¨æ›´æ–°** - æ¸è¿›å¼æœåŠ¡æ›´æ–°
3. **é‡‘ä¸é›€å‘å¸ƒ** - å°æµé‡éªŒè¯æ–°ç‰ˆæœ¬
4. **å›æ»šæœºåˆ¶** - å¿«é€Ÿå›æ»šåˆ°ç¨³å®šç‰ˆæœ¬

---

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

**æœ€ä½é…ç½®**:
- CPU: 4æ ¸å¿ƒ
- å†…å­˜: 8GB
- ç£ç›˜: 100GB SSD
- ç½‘ç»œ: 100Mbps

**æ¨èé…ç½®**:
- CPU: 8æ ¸å¿ƒ
- å†…å­˜: 16GB
- ç£ç›˜: 500GB SSD
- ç½‘ç»œ: 1Gbps

### è½¯ä»¶ä¾èµ–

```bash
# åŸºç¡€è½¯ä»¶
- Docker 20.10+
- Docker Compose 2.0+
- Kubernetes 1.24+
- Helm 3.8+

# æ•°æ®åº“
- MySQL 8.0+
- Redis 7.0+

# ç›‘æ§å·¥å…·
- Prometheus
- Grafana
- ELK Stack
```

### ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `.env.production`

```bash
# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000
API_PREFIX=/api

# æ•°æ®åº“é…ç½®
DB_HOST=mysql-cluster.internal
DB_PORT=3306
DB_NAME=kindergarten_prod
DB_USER=app_user
DB_PASSWORD=${DB_PASSWORD}

# Redisé…ç½®
REDIS_HOST=redis-cluster.internal
REDIS_PORT=6379
REDIS_PASSWORD=${REDIS_PASSWORD}

# AIæ¨¡å‹é…ç½®
DOUBAO_API_KEY=${DOUBAO_API_KEY}
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3

# å®‰å…¨é…ç½®
JWT_SECRET=${JWT_SECRET}
ENCRYPTION_KEY=${ENCRYPTION_KEY}

# ç›‘æ§é…ç½®
PROMETHEUS_ENDPOINT=http://prometheus:9090
GRAFANA_ENDPOINT=http://grafana:3000

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FORMAT=json
```

---

## ğŸ³ Dockeréƒ¨ç½²

### Dockerfileé…ç½®

**å‰ç«¯Dockerfile**: `client/Dockerfile`

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**åç«¯Dockerfile**: `server/Dockerfile`

```dockerfile
FROM node:18-alpine

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    python3 \
    make \
    g++

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

USER nodejs

EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/api/health || exit 1

CMD ["npm", "start"]
```

### Docker Composeé…ç½®

**æ–‡ä»¶**: `docker-compose.prod.yml`

```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

  # åç«¯æœåŠ¡
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    networks:
      - app-network
    volumes:
      - ./logs:/app/logs

  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: kindergarten_prod
      MYSQL_USER: app_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped
    networks:
      - app-network

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - app-network

  # Nginxè´Ÿè½½å‡è¡¡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    networks:
      - app-network

volumes:
  mysql_data:
  redis_data:

networks:
  app-network:
    driver: bridge
```

### éƒ¨ç½²è„šæœ¬

**æ–‡ä»¶**: `scripts/deploy.sh`

```bash
#!/bin/bash

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIåŠ©æ‰‹ç³»ç»Ÿ..."

# æ£€æŸ¥ç¯å¢ƒ
echo "ğŸ“‹ æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
if ! command -v docker &> /dev/null; then
    echo "âŒ Dockeræœªå®‰è£…"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Composeæœªå®‰è£…"
    exit 1
fi

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin main

# æ„å»ºé•œåƒ
echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
docker-compose -f docker-compose.prod.yml build --no-cache

# åœæ­¢æ—§æœåŠ¡
echo "â¹ï¸ åœæ­¢æ—§æœåŠ¡..."
docker-compose -f docker-compose.prod.yml down

# å¯åŠ¨æ–°æœåŠ¡
echo "â–¶ï¸ å¯åŠ¨æ–°æœåŠ¡..."
docker-compose -f docker-compose.prod.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# å¥åº·æ£€æŸ¥
echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
if curl -f http://localhost:3000/api/health; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
else
    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
    docker-compose -f docker-compose.prod.yml down
    docker-compose -f docker-compose.prod.yml up -d --scale backend=0
    exit 1
fi

# æ¸…ç†æ—§é•œåƒ
echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
docker image prune -f

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
```

---

## â˜¸ï¸ Kuberneteséƒ¨ç½²

### Namespaceé…ç½®

**æ–‡ä»¶**: `k8s/namespace.yaml`

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ai-assistant
  labels:
    name: ai-assistant
```

### ConfigMapé…ç½®

**æ–‡ä»¶**: `k8s/configmap.yaml`

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ai-assistant-config
  namespace: ai-assistant
data:
  NODE_ENV: "production"
  PORT: "3000"
  API_PREFIX: "/api"
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"
```

### Secreté…ç½®

**æ–‡ä»¶**: `k8s/secret.yaml`

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ai-assistant-secrets
  namespace: ai-assistant
type: Opaque
data:
  DB_PASSWORD: <base64-encoded-password>
  REDIS_PASSWORD: <base64-encoded-password>
  JWT_SECRET: <base64-encoded-secret>
  DOUBAO_API_KEY: <base64-encoded-key>
```

### Deploymenté…ç½®

**æ–‡ä»¶**: `k8s/backend-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-assistant-backend
  namespace: ai-assistant
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ai-assistant-backend
  template:
    metadata:
      labels:
        app: ai-assistant-backend
    spec:
      containers:
      - name: backend
        image: ai-assistant/backend:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              name: ai-assistant-config
              key: NODE_ENV
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ai-assistant-secrets
              key: DB_PASSWORD
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/ready
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
```

### Serviceé…ç½®

**æ–‡ä»¶**: `k8s/service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ai-assistant-backend-service
  namespace: ai-assistant
spec:
  selector:
    app: ai-assistant-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: ClusterIP
```

### Ingressé…ç½®

**æ–‡ä»¶**: `k8s/ingress.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-assistant-ingress
  namespace: ai-assistant
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
spec:
  tls:
  - hosts:
    - api.localhost:5173
    secretName: ai-assistant-tls
  rules:
  - host: api.localhost:5173
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ai-assistant-backend-service
            port:
              number: 80
```

### HPAé…ç½®

**æ–‡ä»¶**: `k8s/hpa.yaml`

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ai-assistant-backend-hpa
  namespace: ai-assistant
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ai-assistant-backend
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®åˆ†ç¦»

**å¼€å‘ç¯å¢ƒ**: `.env.development`
**æµ‹è¯•ç¯å¢ƒ**: `.env.testing`
**ç”Ÿäº§ç¯å¢ƒ**: `.env.production`

### é…ç½®éªŒè¯

**æ–‡ä»¶**: `server/src/config/validation.ts`

```typescript
import Joi from 'joi';

const configSchema = Joi.object({
  NODE_ENV: Joi.string().valid('development', 'testing', 'production').required(),
  PORT: Joi.number().port().default(3000),
  DB_HOST: Joi.string().required(),
  DB_PORT: Joi.number().port().default(3306),
  DB_NAME: Joi.string().required(),
  DB_USER: Joi.string().required(),
  DB_PASSWORD: Joi.string().required(),
  REDIS_HOST: Joi.string().required(),
  REDIS_PORT: Joi.number().port().default(6379),
  JWT_SECRET: Joi.string().min(32).required(),
  DOUBAO_API_KEY: Joi.string().required()
});

export function validateConfig(config: any) {
  const { error, value } = configSchema.validate(config, {
    allowUnknown: true,
    stripUnknown: true
  });
  
  if (error) {
    throw new Error(`é…ç½®éªŒè¯å¤±è´¥: ${error.message}`);
  }
  
  return value;
}
```

---

## ğŸ¥ å¥åº·æ£€æŸ¥

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

**æ–‡ä»¶**: `server/src/routes/health.ts`

```typescript
import { Router } from 'express';
import { sequelize } from '../config/database';
import { redis } from '../config/redis';

const router = Router();

// åŸºç¡€å¥åº·æ£€æŸ¥
router.get('/health', async (req, res) => {
  try {
    const health = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version,
      checks: {
        database: await checkDatabase(),
        redis: await checkRedis(),
        memory: checkMemory(),
        disk: await checkDisk()
      }
    };
    
    const allHealthy = Object.values(health.checks).every(check => check.status === 'healthy');
    
    res.status(allHealthy ? 200 : 503).json(health);
  } catch (error) {
    res.status(503).json({
      status: 'unhealthy',
      error: error.message
    });
  }
});

// å°±ç»ªæ£€æŸ¥
router.get('/ready', async (req, res) => {
  try {
    // æ£€æŸ¥å…³é”®ä¾èµ–æ˜¯å¦å°±ç»ª
    await sequelize.authenticate();
    await redis.ping();
    
    res.status(200).json({
      status: 'ready',
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    res.status(503).json({
      status: 'not ready',
      error: error.message
    });
  }
});

async function checkDatabase() {
  try {
    await sequelize.authenticate();
    return { status: 'healthy', responseTime: Date.now() };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}

async function checkRedis() {
  try {
    const start = Date.now();
    await redis.ping();
    return { status: 'healthy', responseTime: Date.now() - start };
  } catch (error) {
    return { status: 'unhealthy', error: error.message };
  }
}

function checkMemory() {
  const usage = process.memoryUsage();
  const threshold = 1024 * 1024 * 1024; // 1GB
  
  return {
    status: usage.heapUsed < threshold ? 'healthy' : 'warning',
    heapUsed: usage.heapUsed,
    heapTotal: usage.heapTotal,
    rss: usage.rss
  };
}

export default router;
```

### ç›‘æ§é›†æˆ

**æ–‡ä»¶**: `k8s/monitoring.yaml`

```yaml
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: ai-assistant-monitor
  namespace: ai-assistant
spec:
  selector:
    matchLabels:
      app: ai-assistant-backend
  endpoints:
  - port: http
    path: /api/metrics
    interval: 30s
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### è‡ªåŠ¨åŒ–éƒ¨ç½²

**æ–‡ä»¶**: `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd client && npm ci
        cd ../server && npm ci
        
    - name: Run tests
      run: |
        npm run test:ci
        
    - name: Build Docker images
      run: |
        docker build -t ai-assistant/frontend:${{ github.sha }} ./client
        docker build -t ai-assistant/backend:${{ github.sha }} ./server
        
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/ai-assistant-backend backend=ai-assistant/backend:${{ github.sha }}
        kubectl rollout status deployment/ai-assistant-backend
```

---

**æ–‡æ¡£ç»´æŠ¤**: AIåŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-08
