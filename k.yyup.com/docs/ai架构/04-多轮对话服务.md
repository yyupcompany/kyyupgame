# å¤šè½®å¯¹è¯æœåŠ¡ (MultiRoundChatService)

**æœåŠ¡åç§°**: MultiRoundChatService  
**ä»£ç ä½ç½®**: `server/src/services/ai-operator/core/multi-round-chat.service.ts`  
**ä»£ç é‡**: ~340è¡Œ  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ¯ æœåŠ¡æ¦‚è¿°

### èŒè´£

MultiRoundChatServiceè´Ÿè´£ç®¡ç†å¤šè½®å¯¹è¯çŠ¶æ€ã€åè°ƒå·¥å…·è°ƒç”¨ã€ç»“æœæ•´åˆï¼Œæ”¯æŒå¯¹è¯æŒä¹…åŒ–ã€æ¢å¤ã€å¯¼å‡ºç­‰é«˜çº§åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **å¤šè½®å¯¹è¯ç®¡ç†** - å®Œæ•´çš„å¯¹è¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. **çŠ¶æ€è·Ÿè¸ª** - æ¯è½®å¯¹è¯çŠ¶æ€ç²¾ç¡®è·Ÿè¸ª
3. **å·¥å…·é›†æˆ** - æ— ç¼é›†æˆå·¥å…·è°ƒç”¨ç»“æœ
4. **å¯¹è¯æŒä¹…åŒ–** - æ”¯æŒå¯¹è¯ä¿å­˜å’Œæ¢å¤
5. **è´¨é‡åˆ†æ** - å¯¹è¯è´¨é‡è¯„ä¼°å’Œä¼˜åŒ–å»ºè®®

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼** - å…¨å±€å”¯ä¸€å¯¹è¯ç®¡ç†å™¨
- **çŠ¶æ€æ¨¡å¼** - å¯¹è¯çŠ¶æ€è½¬æ¢ç®¡ç†
- **å‘½ä»¤æ¨¡å¼** - å¯¹è¯æ“ä½œå°è£…
- **è§‚å¯Ÿè€…æ¨¡å¼** - å¯¹è¯äº‹ä»¶ç›‘å¬

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. å¯¹è¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

**åŠŸèƒ½**: å®Œæ•´ç®¡ç†å¯¹è¯ä»åˆ›å»ºåˆ°ç»“æŸçš„å…¨è¿‡ç¨‹

**ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ**:
- **åˆ›å»º**: åˆå§‹åŒ–å¯¹è¯ä¸Šä¸‹æ–‡
- **è¿›è¡Œ**: ç®¡ç†å¤šè½®äº¤äº’
- **æš‚åœ**: æ”¯æŒå¯¹è¯æš‚åœå’Œæ¢å¤
- **ç»“æŸ**: å¯¹è¯å®Œæˆå’Œæ¸…ç†
- **å½’æ¡£**: å¯¹è¯æ•°æ®æŒä¹…åŒ–

### 2. è½®æ¬¡çŠ¶æ€ç®¡ç†

**åŠŸèƒ½**: ç²¾ç¡®è·Ÿè¸ªæ¯ä¸€è½®å¯¹è¯çš„çŠ¶æ€

**çŠ¶æ€ç±»å‹**:
- `pending` - ç­‰å¾…å¤„ç†
- `processing` - æ­£åœ¨å¤„ç†
- `complete` - å¤„ç†å®Œæˆ
- `error` - å¤„ç†é”™è¯¯

### 3. å·¥å…·è°ƒç”¨é›†æˆ

**åŠŸèƒ½**: åœ¨å¯¹è¯ä¸­æ— ç¼é›†æˆå·¥å…·è°ƒç”¨

**é›†æˆç‰¹æ€§**:
- å·¥å…·ç»“æœå­˜å‚¨
- å·¥å…·é“¾æ‰§è¡Œè·Ÿè¸ª
- å·¥å…·é”™è¯¯å¤„ç†
- å·¥å…·æ€§èƒ½ç›‘æ§

### 4. å¯¹è¯åˆ†æ

**åŠŸèƒ½**: åˆ†æå¯¹è¯è´¨é‡å’Œç”¨æˆ·æ»¡æ„åº¦

**åˆ†æç»´åº¦**:
- è½®æ¬¡ç»Ÿè®¡
- å“åº”æ—¶é—´
- å·¥å…·ä½¿ç”¨ç‡
- é”™è¯¯ç‡åˆ†æ

---

## ğŸ“– APIæ–‡æ¡£

### createConversation

åˆ›å»ºæ–°å¯¹è¯

**ç­¾å**:
```typescript
createConversation(
  userId: string,
  options: ConversationOptions = {}
): string
```

**å‚æ•°**:
```typescript
interface ConversationOptions {
  maxRounds?: number;        // æœ€å¤§è½®æ•°ï¼Œé»˜è®¤10
  metadata?: Record<string, any>;  // å…ƒæ•°æ®
}
```

**è¿”å›å€¼**: å¯¹è¯ID (string)

**ç¤ºä¾‹**:
```typescript
const conversationId = multiRoundChatService.createConversation(
  'user123',
  {
    maxRounds: 15,
    metadata: { topic: 'å­¦ç”Ÿç®¡ç†' }
  }
);
```

### startRound

å¼€å§‹æ–°ä¸€è½®å¯¹è¯

**ç­¾å**:
```typescript
startRound(
  conversationId: string,
  userMessage: string
): ChatRound
```

**è¿”å›å€¼**:
```typescript
interface ChatRound {
  roundNumber: number;
  userMessage: string;
  aiResponse?: string;
  toolCalls?: any[];
  toolResults?: ToolExecutionResult[];
  timestamp: number;
  status: 'pending' | 'processing' | 'complete' | 'error';
  error?: Error;
}
```

### updateRoundStatus

æ›´æ–°è½®æ¬¡çŠ¶æ€

**ç­¾å**:
```typescript
updateRoundStatus(
  conversationId: string,
  status: RoundStatus,
  data?: any
): void
```

**çŠ¶æ€ç±»å‹**:
- `processing` - å¼€å§‹å¤„ç†
- `complete` - å¤„ç†å®Œæˆ
- `error` - å¤„ç†é”™è¯¯

### addToolResults

æ·»åŠ å·¥å…·æ‰§è¡Œç»“æœ

**ç­¾å**:
```typescript
addToolResults(
  conversationId: string,
  toolResults: ToolExecutionResult[]
): void
```

### shouldContinue

åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­å¯¹è¯

**ç­¾å**:
```typescript
shouldContinue(conversationId: string): boolean
```

**åˆ¤æ–­æ¡ä»¶**:
- æœªè¾¾åˆ°æœ€å¤§è½®æ•°
- å¯¹è¯æœªå®Œæˆ
- å­˜åœ¨å¾…å¤„ç†çš„å·¥å…·è°ƒç”¨

### saveConversation

ä¿å­˜å¯¹è¯åˆ°æŒä¹…åŒ–å­˜å‚¨

**ç­¾å**:
```typescript
async saveConversation(
  conversationId: string,
  filePath?: string
): Promise<void>
```

### loadConversation

ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½å¯¹è¯

**ç­¾å**:
```typescript
async loadConversation(
  conversationId: string,
  filePath?: string
): Promise<MultiRoundContext | null>
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€å¤šè½®å¯¹è¯

```typescript
import { multiRoundChatService } from './core/multi-round-chat.service';

async function handleMultiRoundChat() {
  // åˆ›å»ºå¯¹è¯
  const conversationId = multiRoundChatService.createConversation(
    'user123',
    { maxRounds: 5 }
  );
  
  // ç¬¬ä¸€è½®å¯¹è¯
  const round1 = multiRoundChatService.startRound(
    conversationId,
    'æŸ¥è¯¢å­¦ç”Ÿæ€»æ•°'
  );
  
  // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
  multiRoundChatService.updateRoundStatus(conversationId, 'processing');
  
  // æ¨¡æ‹ŸAIå“åº”
  multiRoundChatService.updateRoundStatus(
    conversationId,
    'complete',
    { aiResponse: 'å½“å‰å…±æœ‰150åå­¦ç”Ÿ' }
  );
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­
  if (multiRoundChatService.shouldContinue(conversationId)) {
    console.log('å¯ä»¥ç»§ç»­å¯¹è¯');
  }
  
  // è·å–å¯¹è¯å†å²
  const context = multiRoundChatService.getContext(conversationId);
  console.log(`å¯¹è¯è½®æ•°: ${context.currentRound}`);
}
```

### ç¤ºä¾‹2: å·¥å…·é›†æˆå¯¹è¯

```typescript
async function handleToolBasedChat() {
  const conversationId = multiRoundChatService.createConversation('teacher001');
  
  // å¼€å§‹å¯¹è¯
  const round = multiRoundChatService.startRound(
    conversationId,
    'å¸®æˆ‘ç”Ÿæˆç­çº§æˆç»©æŠ¥å‘Š'
  );
  
  multiRoundChatService.updateRoundStatus(conversationId, 'processing');
  
  // æ·»åŠ å·¥å…·è°ƒç”¨
  multiRoundChatService.addToolCalls(conversationId, [
    {
      name: 'get_student_grades',
      parameters: { classId: 'class_001' }
    }
  ]);
  
  // æ·»åŠ å·¥å…·ç»“æœ
  multiRoundChatService.addToolResults(conversationId, [
    {
      toolName: 'get_student_grades',
      success: true,
      result: { averageScore: 85.5, totalStudents: 30 },
      executionTime: 150
    }
  ]);
  
  // å®Œæˆè½®æ¬¡
  multiRoundChatService.updateRoundStatus(
    conversationId,
    'complete',
    { aiResponse: 'å·²ç”Ÿæˆç­çº§æˆç»©æŠ¥å‘Šï¼Œå¹³å‡åˆ†85.5åˆ†' }
  );
}
```

### ç¤ºä¾‹3: å¯¹è¯æŒä¹…åŒ–

```typescript
async function demonstratePersistence() {
  const conversationId = multiRoundChatService.createConversation('user123');
  
  // è¿›è¡Œå‡ è½®å¯¹è¯
  multiRoundChatService.startRound(conversationId, 'ç¬¬ä¸€ä¸ªé—®é¢˜');
  multiRoundChatService.updateRoundStatus(conversationId, 'complete', {
    aiResponse: 'ç¬¬ä¸€ä¸ªå›ç­”'
  });
  
  multiRoundChatService.startRound(conversationId, 'ç¬¬äºŒä¸ªé—®é¢˜');
  multiRoundChatService.updateRoundStatus(conversationId, 'complete', {
    aiResponse: 'ç¬¬äºŒä¸ªå›ç­”'
  });
  
  // ä¿å­˜å¯¹è¯
  await multiRoundChatService.saveConversation(conversationId);
  console.log('å¯¹è¯å·²ä¿å­˜');
  
  // æ¸…é™¤å†…å­˜ä¸­çš„å¯¹è¯
  multiRoundChatService.endConversation(conversationId);
  
  // é‡æ–°åŠ è½½å¯¹è¯
  const loaded = await multiRoundChatService.loadConversation(conversationId);
  if (loaded) {
    console.log(`é‡æ–°åŠ è½½å¯¹è¯ï¼Œå…±${loaded.rounds.length}è½®`);
  }
}
```

### ç¤ºä¾‹4: å¯¹è¯åˆ†æ

```typescript
async function analyzeConversation() {
  const conversationId = 'existing_conversation_id';
  
  // è·å–å¯¹è¯åˆ†æ
  const analysis = multiRoundChatService.analyzeConversation(conversationId);
  
  console.log('å¯¹è¯åˆ†æç»“æœ:');
  console.log(`- æ€»è½®æ•°: ${analysis.totalRounds}`);
  console.log(`- å¹³å‡å“åº”æ—¶é—´: ${analysis.avgResponseTime}ms`);
  console.log(`- å·¥å…·ä½¿ç”¨æ¬¡æ•°: ${analysis.toolUsageCount}`);
  console.log(`- é”™è¯¯æ¬¡æ•°: ${analysis.errorCount}`);
  console.log(`- å¯¹è¯è´¨é‡è¯„åˆ†: ${analysis.qualityScore}/10`);
  
  // è·å–ä¼˜åŒ–å»ºè®®
  if (analysis.suggestions.length > 0) {
    console.log('ä¼˜åŒ–å»ºè®®:');
    analysis.suggestions.forEach((suggestion, index) => {
      console.log(`${index + 1}. ${suggestion}`);
    });
  }
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```typescript
describe('MultiRoundChatService', () => {
  let service: MultiRoundChatService;

  beforeEach(() => {
    service = MultiRoundChatService.getInstance();
  });

  afterEach(() => {
    service.clearAllContexts();
  });

  describe('å¯¹è¯ç®¡ç†', () => {
    it('åº”è¯¥åˆ›å»ºæ–°å¯¹è¯', () => {
      const conversationId = service.createConversation('user123');
      
      expect(conversationId).toBeDefined();
      expect(typeof conversationId).toBe('string');
      
      const context = service.getContext(conversationId);
      expect(context.userId).toBe('user123');
      expect(context.currentRound).toBe(0);
    });

    it('åº”è¯¥å¼€å§‹æ–°è½®æ¬¡', () => {
      const conversationId = service.createConversation('user123');
      
      const round = service.startRound(conversationId, 'æµ‹è¯•æ¶ˆæ¯');
      
      expect(round.roundNumber).toBe(1);
      expect(round.userMessage).toBe('æµ‹è¯•æ¶ˆæ¯');
      expect(round.status).toBe('pending');
    });

    it('åº”è¯¥æ›´æ–°è½®æ¬¡çŠ¶æ€', () => {
      const conversationId = service.createConversation('user123');
      service.startRound(conversationId, 'æµ‹è¯•');
      
      service.updateRoundStatus(conversationId, 'processing');
      
      const context = service.getContext(conversationId);
      const lastRound = context.rounds[context.rounds.length - 1];
      expect(lastRound.status).toBe('processing');
    });

    it('åº”è¯¥æ£€æŸ¥ç»§ç»­æ¡ä»¶', () => {
      const conversationId = service.createConversation('user123', {
        maxRounds: 2
      });
      
      // ç¬¬ä¸€è½®
      service.startRound(conversationId, 'ç¬¬ä¸€è½®');
      expect(service.shouldContinue(conversationId)).toBe(true);
      
      // ç¬¬äºŒè½®
      service.startRound(conversationId, 'ç¬¬äºŒè½®');
      expect(service.shouldContinue(conversationId)).toBe(false);
    });
  });

  describe('å·¥å…·é›†æˆ', () => {
    it('åº”è¯¥æ·»åŠ å·¥å…·è°ƒç”¨', () => {
      const conversationId = service.createConversation('user123');
      service.startRound(conversationId, 'æµ‹è¯•');
      
      const toolCalls = [{ name: 'test_tool', parameters: {} }];
      service.addToolCalls(conversationId, toolCalls);
      
      const context = service.getContext(conversationId);
      const lastRound = context.rounds[context.rounds.length - 1];
      expect(lastRound.toolCalls).toEqual(toolCalls);
    });

    it('åº”è¯¥æ·»åŠ å·¥å…·ç»“æœ', () => {
      const conversationId = service.createConversation('user123');
      service.startRound(conversationId, 'æµ‹è¯•');
      
      const toolResults = [{
        toolName: 'test_tool',
        success: true,
        result: { data: 'test' },
        executionTime: 100
      }];
      
      service.addToolResults(conversationId, toolResults);
      
      const context = service.getContext(conversationId);
      const lastRound = context.rounds[context.rounds.length - 1];
      expect(lastRound.toolResults).toEqual(toolResults);
    });
  });

  describe('å¯¹è¯åˆ†æ', () => {
    it('åº”è¯¥åˆ†æå¯¹è¯è´¨é‡', () => {
      const conversationId = service.createConversation('user123');
      
      // æ·»åŠ å‡ è½®å¯¹è¯
      service.startRound(conversationId, 'é—®é¢˜1');
      service.updateRoundStatus(conversationId, 'complete', {
        aiResponse: 'å›ç­”1'
      });
      
      service.startRound(conversationId, 'é—®é¢˜2');
      service.updateRoundStatus(conversationId, 'complete', {
        aiResponse: 'å›ç­”2'
      });
      
      const analysis = service.analyzeConversation(conversationId);
      
      expect(analysis.totalRounds).toBe(2);
      expect(analysis.qualityScore).toBeGreaterThan(0);
    });
  });
});
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| å¹¶å‘å¯¹è¯æ•° | >1000 | ~1200 | âœ… |
| è½®æ¬¡åˆ‡æ¢æ—¶é—´ | <10ms | ~5ms | âœ… |
| å†…å­˜ä½¿ç”¨ | <50MB | ~40MB | âœ… |
| æŒä¹…åŒ–æ—¶é—´ | <100ms | ~80ms | âœ… |

### æ€§èƒ½ä¼˜åŒ–

1. **å†…å­˜ç®¡ç†** - åŠæ—¶æ¸…ç†å®Œæˆçš„å¯¹è¯
2. **çŠ¶æ€ç¼“å­˜** - çƒ­ç‚¹å¯¹è¯çŠ¶æ€ç¼“å­˜
3. **æ‰¹é‡æ“ä½œ** - æ‰¹é‡ä¿å­˜å’ŒåŠ è½½
4. **å¼‚æ­¥å¤„ç†** - éé˜»å¡çŠ¶æ€æ›´æ–°

---

**æ–‡æ¡£ç»´æŠ¤**: AIåŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-08
