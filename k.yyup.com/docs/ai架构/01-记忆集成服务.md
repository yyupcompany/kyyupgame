# è®°å¿†é›†æˆæœåŠ¡ (MemoryIntegrationService)

**æœåŠ¡åç§°**: MemoryIntegrationService  
**ä»£ç ä½ç½®**: `server/src/services/ai-operator/core/memory-integration.service.ts`  
**ä»£ç é‡**: ~494è¡Œ  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ¯ æœåŠ¡æ¦‚è¿°

### èŒè´£

MemoryIntegrationServiceè´Ÿè´£é›†æˆå…­ç»´è®°å¿†ç³»ç»Ÿï¼Œæä¾›è®°å¿†æ£€ç´¢ã€å­˜å‚¨å’Œæ ¼å¼åŒ–åŠŸèƒ½ï¼Œä¸ºAIå†³ç­–æä¾›å†å²ä¸Šä¸‹æ–‡æ”¯æŒã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **å…­ç»´è®°å¿†æ¨¡å‹** - æ”¯æŒ6ç§è®°å¿†ç»´åº¦
2. **å‘é‡æ£€ç´¢** - åŸºäºç›¸ä¼¼åº¦çš„æ™ºèƒ½æ£€ç´¢
3. **ç¼“å­˜ä¼˜åŒ–** - 5åˆ†é’ŸTTLç¼“å­˜
4. **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ‰¹é‡æ£€ç´¢å’Œå­˜å‚¨
5. **æ ¼å¼åŒ–è¾“å‡º** - è‡ªåŠ¨æ ¼å¼åŒ–ä¸ºAIå¯è¯»æ ¼å¼

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼** - å…¨å±€å”¯ä¸€å®ä¾‹
- **ç¼“å­˜æ¨¡å¼** - LRUç¼“å­˜ç­–ç•¥
- **é€‚é…å™¨æ¨¡å¼** - é€‚é…ä¸åŒè®°å¿†ç³»ç»Ÿ

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. è®°å¿†æ£€ç´¢

**åŠŸèƒ½**: æ ¹æ®æŸ¥è¯¢å†…å®¹æ£€ç´¢ç›¸å…³è®°å¿†

**æ”¯æŒçš„ç»´åº¦**:
- `episodic` - æƒ…æ™¯è®°å¿†ï¼ˆå…·ä½“äº‹ä»¶ï¼‰
- `semantic` - è¯­ä¹‰è®°å¿†ï¼ˆçŸ¥è¯†æ¦‚å¿µï¼‰
- `procedural` - ç¨‹åºè®°å¿†ï¼ˆæ“ä½œæ­¥éª¤ï¼‰
- `emotional` - æƒ…æ„Ÿè®°å¿†ï¼ˆæƒ…æ„Ÿä½“éªŒï¼‰
- `working` - å·¥ä½œè®°å¿†ï¼ˆä¸´æ—¶ä¿¡æ¯ï¼‰
- `meta` - å…ƒè®°å¿†ï¼ˆå…³äºè®°å¿†çš„è®°å¿†ï¼‰

**æ£€ç´¢ç­–ç•¥**:
- å‘é‡ç›¸ä¼¼åº¦æœç´¢
- æ—¶é—´è¡°å‡æƒé‡
- é‡è¦æ€§è¯„åˆ†
- å¤šç»´åº¦èåˆ

### 2. è®°å¿†å­˜å‚¨

**åŠŸèƒ½**: å­˜å‚¨æ–°çš„è®°å¿†æ¡ç›®

**å­˜å‚¨æµç¨‹**:
1. å†…å®¹å‘é‡åŒ–
2. ç»´åº¦åˆ†ç±»
3. é‡è¦æ€§è¯„åˆ†
4. æŒä¹…åŒ–å­˜å‚¨
5. ç¼“å­˜æ›´æ–°

### 3. è®°å¿†æ ¼å¼åŒ–

**åŠŸèƒ½**: å°†è®°å¿†æ ¼å¼åŒ–ä¸ºAIå¯è¯»æ ¼å¼

**æ ¼å¼åŒ–è§„åˆ™**:
- Markdownæ ¼å¼
- æŒ‰ç»´åº¦åˆ†ç»„
- æ—¶é—´æ’åº
- ç›¸å…³æ€§æ ‡æ³¨

---

## ğŸ“– APIæ–‡æ¡£

### retrieveMemoryContext

æ£€ç´¢è®°å¿†ä¸Šä¸‹æ–‡

**ç­¾å**:
```typescript
async retrieveMemoryContext(
  query: string,
  userId: string,
  options?: {
    dimensions?: MemoryDimension[];
    limit?: number;
    minRelevance?: number;
    timeRange?: { start: Date; end: Date };
    useCache?: boolean;
  }
): Promise<MemoryContext>
```

**å‚æ•°**:
- `query` - æŸ¥è¯¢å†…å®¹
- `userId` - ç”¨æˆ·ID
- `options.dimensions` - æŒ‡å®šæ£€ç´¢çš„è®°å¿†ç»´åº¦ï¼ˆé»˜è®¤å…¨éƒ¨ï¼‰
- `options.limit` - è¿”å›è®°å¿†æ•°é‡ï¼ˆé»˜è®¤10ï¼‰
- `options.minRelevance` - æœ€å°ç›¸å…³åº¦é˜ˆå€¼ï¼ˆé»˜è®¤0.6ï¼‰
- `options.timeRange` - æ—¶é—´èŒƒå›´è¿‡æ»¤
- `options.useCache` - æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼ˆé»˜è®¤trueï¼‰

**è¿”å›å€¼**:
```typescript
interface MemoryContext {
  items: MemoryItem[];
  dimensions: MemoryDimension[];
  totalCount: number;
  relevanceScore: number;
}
```

**ç¤ºä¾‹**:
```typescript
const context = await memoryIntegrationService.retrieveMemoryContext(
  'å­¦ç”Ÿæˆç»©',
  'user123',
  {
    dimensions: ['episodic', 'semantic'],
    limit: 5,
    minRelevance: 0.7
  }
);
```

### storeMemory

å­˜å‚¨æ–°è®°å¿†

**ç­¾å**:
```typescript
async storeMemory(
  content: string,
  userId: string,
  dimension: MemoryDimension,
  metadata?: Record<string, any>
): Promise<MemoryItem>
```

**å‚æ•°**:
- `content` - è®°å¿†å†…å®¹
- `userId` - ç”¨æˆ·ID
- `dimension` - è®°å¿†ç»´åº¦
- `metadata` - é™„åŠ å…ƒæ•°æ®

**è¿”å›å€¼**:
```typescript
interface MemoryItem {
  id: string;
  content: string;
  dimension: MemoryDimension;
  relevance: number;
  timestamp: Date;
  metadata?: Record<string, any>;
}
```

**ç¤ºä¾‹**:
```typescript
const memory = await memoryIntegrationService.storeMemory(
  'å¼ ä¸‰åœ¨æ•°å­¦è€ƒè¯•ä¸­è·å¾—95åˆ†',
  'user123',
  'episodic',
  { subject: 'math', score: 95 }
);
```

### formatMemoryContext

æ ¼å¼åŒ–è®°å¿†ä¸Šä¸‹æ–‡

**ç­¾å**:
```typescript
formatMemoryContext(context: MemoryContext): string
```

**å‚æ•°**:
- `context` - è®°å¿†ä¸Šä¸‹æ–‡å¯¹è±¡

**è¿”å›å€¼**: Markdownæ ¼å¼çš„è®°å¿†æ–‡æœ¬

**ç¤ºä¾‹**:
```typescript
const formatted = memoryIntegrationService.formatMemoryContext(context);
console.log(formatted);
// è¾“å‡º:
// ## ğŸ“š ç›¸å…³è®°å¿† (5æ¡)
// 
// ### æƒ…æ™¯è®°å¿† (Episodic)
// - å¼ ä¸‰åœ¨æ•°å­¦è€ƒè¯•ä¸­è·å¾—95åˆ† (ç›¸å…³åº¦: 0.92)
// ...
```

### batchRetrieveMemories

æ‰¹é‡æ£€ç´¢è®°å¿†

**ç­¾å**:
```typescript
async batchRetrieveMemories(
  queries: string[],
  userId: string,
  options?: RetrieveOptions
): Promise<MemoryContext[]>
```

**å‚æ•°**:
- `queries` - æŸ¥è¯¢å†…å®¹æ•°ç»„
- `userId` - ç”¨æˆ·ID
- `options` - æ£€ç´¢é€‰é¡¹

**è¿”å›å€¼**: è®°å¿†ä¸Šä¸‹æ–‡æ•°ç»„

**ç¤ºä¾‹**:
```typescript
const contexts = await memoryIntegrationService.batchRetrieveMemories(
  ['å­¦ç”Ÿæˆç»©', 'æ•™å¸ˆè¯„ä»·', 'å®¶é•¿åé¦ˆ'],
  'user123'
);
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€è®°å¿†æ£€ç´¢

```typescript
import { memoryIntegrationService } from './core/memory-integration.service';

async function retrieveStudentMemories() {
  // æ£€ç´¢å­¦ç”Ÿç›¸å…³è®°å¿†
  const context = await memoryIntegrationService.retrieveMemoryContext(
    'å¼ ä¸‰çš„å­¦ä¹ æƒ…å†µ',
    'teacher001',
    {
      dimensions: ['episodic', 'semantic'],
      limit: 10,
      minRelevance: 0.6
    }
  );

  console.log('æ£€ç´¢åˆ°è®°å¿†:', context.items.length);
  console.log('å¹³å‡ç›¸å…³åº¦:', context.relevanceScore);

  // æ ¼å¼åŒ–è¾“å‡º
  const formatted = memoryIntegrationService.formatMemoryContext(context);
  console.log(formatted);
}
```

### ç¤ºä¾‹2: å­˜å‚¨æ–°è®°å¿†

```typescript
async function storeActivityMemory() {
  // å­˜å‚¨æ´»åŠ¨è®°å¿†
  const memory = await memoryIntegrationService.storeMemory(
    'å…­ä¸€å„¿ç«¥èŠ‚æ´»åŠ¨åœ†æ»¡æˆåŠŸï¼Œå…±æœ‰150åå­¦ç”Ÿå‚åŠ ',
    'teacher001',
    'episodic',
    {
      activityType: 'èŠ‚æ—¥æ´»åŠ¨',
      participants: 150,
      date: '2025-06-01'
    }
  );

  console.log('è®°å¿†å·²å­˜å‚¨:', memory.id);
}
```

### ç¤ºä¾‹3: å¤šç»´åº¦è®°å¿†æ£€ç´¢

```typescript
async function retrieveMultiDimensionMemories() {
  // æ£€ç´¢å¤šä¸ªç»´åº¦çš„è®°å¿†
  const context = await memoryIntegrationService.retrieveMemoryContext(
    'å¦‚ä½•ç»„ç»‡å„¿ç«¥èŠ‚æ´»åŠ¨',
    'teacher001',
    {
      dimensions: ['episodic', 'procedural', 'semantic'],
      limit: 15
    }
  );

  // æŒ‰ç»´åº¦åˆ†ç»„
  const byDimension = context.items.reduce((acc, item) => {
    if (!acc[item.dimension]) acc[item.dimension] = [];
    acc[item.dimension].push(item);
    return acc;
  }, {} as Record<string, MemoryItem[]>);

  console.log('æƒ…æ™¯è®°å¿†:', byDimension.episodic?.length || 0);
  console.log('ç¨‹åºè®°å¿†:', byDimension.procedural?.length || 0);
  console.log('è¯­ä¹‰è®°å¿†:', byDimension.semantic?.length || 0);
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```typescript
describe('MemoryIntegrationService', () => {
  let service: MemoryIntegrationService;

  beforeEach(() => {
    service = MemoryIntegrationService.getInstance();
  });

  describe('retrieveMemoryContext', () => {
    it('åº”è¯¥æˆåŠŸæ£€ç´¢è®°å¿†', async () => {
      const context = await service.retrieveMemoryContext(
        'æµ‹è¯•æŸ¥è¯¢',
        'user123'
      );

      expect(context).toBeDefined();
      expect(context.items).toBeInstanceOf(Array);
      expect(context.totalCount).toBeGreaterThanOrEqual(0);
    });

    it('åº”è¯¥æ”¯æŒç»´åº¦è¿‡æ»¤', async () => {
      const context = await service.retrieveMemoryContext(
        'æµ‹è¯•æŸ¥è¯¢',
        'user123',
        { dimensions: ['episodic'] }
      );

      expect(context.dimensions).toContain('episodic');
      context.items.forEach(item => {
        expect(item.dimension).toBe('episodic');
      });
    });

    it('åº”è¯¥æ”¯æŒç›¸å…³åº¦è¿‡æ»¤', async () => {
      const context = await service.retrieveMemoryContext(
        'æµ‹è¯•æŸ¥è¯¢',
        'user123',
        { minRelevance: 0.8 }
      );

      context.items.forEach(item => {
        expect(item.relevance).toBeGreaterThanOrEqual(0.8);
      });
    });

    it('åº”è¯¥ä½¿ç”¨ç¼“å­˜', async () => {
      // ç¬¬ä¸€æ¬¡è°ƒç”¨
      const start1 = Date.now();
      await service.retrieveMemoryContext('æµ‹è¯•æŸ¥è¯¢', 'user123');
      const duration1 = Date.now() - start1;

      // ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆåº”è¯¥ä»ç¼“å­˜è¯»å–ï¼‰
      const start2 = Date.now();
      await service.retrieveMemoryContext('æµ‹è¯•æŸ¥è¯¢', 'user123');
      const duration2 = Date.now() - start2;

      expect(duration2).toBeLessThan(duration1);
    });
  });

  describe('storeMemory', () => {
    it('åº”è¯¥æˆåŠŸå­˜å‚¨è®°å¿†', async () => {
      const memory = await service.storeMemory(
        'æµ‹è¯•å†…å®¹',
        'user123',
        'episodic'
      );

      expect(memory).toBeDefined();
      expect(memory.id).toBeDefined();
      expect(memory.content).toBe('æµ‹è¯•å†…å®¹');
      expect(memory.dimension).toBe('episodic');
    });

    it('åº”è¯¥æ”¯æŒå…ƒæ•°æ®', async () => {
      const memory = await service.storeMemory(
        'æµ‹è¯•å†…å®¹',
        'user123',
        'episodic',
        { key: 'value' }
      );

      expect(memory.metadata).toEqual({ key: 'value' });
    });
  });

  describe('formatMemoryContext', () => {
    it('åº”è¯¥æ­£ç¡®æ ¼å¼åŒ–è®°å¿†', () => {
      const context: MemoryContext = {
        items: [
          {
            id: '1',
            content: 'æµ‹è¯•è®°å¿†1',
            dimension: 'episodic',
            relevance: 0.9,
            timestamp: new Date()
          }
        ],
        dimensions: ['episodic'],
        totalCount: 1,
        relevanceScore: 0.9
      };

      const formatted = service.formatMemoryContext(context);

      expect(formatted).toContain('ğŸ“š ç›¸å…³è®°å¿†');
      expect(formatted).toContain('æµ‹è¯•è®°å¿†1');
      expect(formatted).toContain('0.9');
    });
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
describe('MemoryIntegrationService Integration', () => {
  it('åº”è¯¥å®Œæˆå®Œæ•´çš„è®°å¿†æµç¨‹', async () => {
    const service = MemoryIntegrationService.getInstance();

    // 1. å­˜å‚¨è®°å¿†
    const memory = await service.storeMemory(
      'å¼ ä¸‰åœ¨æ•°å­¦è€ƒè¯•ä¸­è·å¾—95åˆ†',
      'teacher001',
      'episodic',
      { subject: 'math', score: 95 }
    );

    expect(memory.id).toBeDefined();

    // 2. æ£€ç´¢è®°å¿†
    const context = await service.retrieveMemoryContext(
      'å¼ ä¸‰çš„æ•°å­¦æˆç»©',
      'teacher001'
    );

    expect(context.items.length).toBeGreaterThan(0);

    // 3. æ ¼å¼åŒ–è®°å¿†
    const formatted = service.formatMemoryContext(context);

    expect(formatted).toContain('å¼ ä¸‰');
    expect(formatted).toContain('æ•°å­¦');
  });
});
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| æ£€ç´¢æ—¶é—´ | <500ms | ~300ms | âœ… |
| ç¼“å­˜å‘½ä¸­ç‡ | >80% | ~85% | âœ… |
| å­˜å‚¨æ—¶é—´ | <100ms | ~50ms | âœ… |
| å¹¶å‘æ”¯æŒ | >100 QPS | ~150 QPS | âœ… |

### æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥** - 5åˆ†é’ŸTTLï¼ŒLRUæ·˜æ±°
2. **æ‰¹é‡æ“ä½œ** - æ”¯æŒæ‰¹é‡æ£€ç´¢å’Œå­˜å‚¨
3. **å¼‚æ­¥å¤„ç†** - éé˜»å¡I/O
4. **è¿æ¥æ± ** - æ•°æ®åº“è¿æ¥å¤ç”¨

---

**æ–‡æ¡£ç»´æŠ¤**: AIåŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-05

