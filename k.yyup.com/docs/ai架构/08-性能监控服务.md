# æ€§èƒ½ç›‘æ§æœåŠ¡ (PerformanceMonitorService)

**æœåŠ¡åç§°**: PerformanceMonitorService  
**ä»£ç ä½ç½®**: `server/src/services/ai-operator/monitoring/performance-monitor.service.ts`  
**ä»£ç é‡**: ~340è¡Œ  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ¯ æœåŠ¡æ¦‚è¿°

### èŒè´£

PerformanceMonitorServiceè´Ÿè´£æ”¶é›†ã€åˆ†æå’ŒæŠ¥å‘Šç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œæä¾›å®æ—¶ç›‘æ§ã€æ€§èƒ½åˆ†æã€å¥åº·æ£€æŸ¥ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **å®æ—¶ç›‘æ§** - å®æ—¶æ”¶é›†ç³»ç»Ÿæ€§èƒ½æ•°æ®
2. **æŒ‡æ ‡èšåˆ** - å¤šç»´åº¦æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
3. **å¥åº·æ£€æŸ¥** - ç³»ç»Ÿå¥åº·çŠ¶æ€è¯„ä¼°
4. **å‘Šè­¦æœºåˆ¶** - æ€§èƒ½å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦
5. **æŠ¥å‘Šç”Ÿæˆ** - å®šæœŸæ€§èƒ½æŠ¥å‘Šç”Ÿæˆ

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼** - å…¨å±€å”¯ä¸€ç›‘æ§æœåŠ¡
- **è§‚å¯Ÿè€…æ¨¡å¼** - æ€§èƒ½äº‹ä»¶ç›‘å¬
- **ç­–ç•¥æ¨¡å¼** - å¤šç§ç›‘æ§ç­–ç•¥
- **è£…é¥°å™¨æ¨¡å¼** - æ€§èƒ½ç›‘æ§è£…é¥°

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æ€§èƒ½æŒ‡æ ‡æ”¶é›†

**åŠŸèƒ½**: æ”¶é›†å„ç±»ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

**ç›‘æ§æŒ‡æ ‡**:
- **å“åº”æ—¶é—´**: APIå“åº”æ—¶é—´ç»Ÿè®¡
- **ååé‡**: è¯·æ±‚å¤„ç†é‡ç»Ÿè®¡
- **é”™è¯¯ç‡**: é”™è¯¯è¯·æ±‚æ¯”ä¾‹
- **èµ„æºä½¿ç”¨**: CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
- **å¹¶å‘æ•°**: åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°

### 2. å®æ—¶ç›‘æ§

**åŠŸèƒ½**: å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

**ç›‘æ§ç»´åº¦**:
- æœåŠ¡çº§ç›‘æ§: å„ä¸ªæœåŠ¡çš„æ€§èƒ½çŠ¶æ€
- æ¥å£çº§ç›‘æ§: å…·ä½“APIæ¥å£æ€§èƒ½
- ç”¨æˆ·çº§ç›‘æ§: ç”¨æˆ·è¯·æ±‚æ€§èƒ½åˆ†æ
- æ—¶é—´çº§ç›‘æ§: ä¸åŒæ—¶é—´æ®µæ€§èƒ½å¯¹æ¯”

### 3. å¥åº·æ£€æŸ¥

**åŠŸèƒ½**: è¯„ä¼°ç³»ç»Ÿæ•´ä½“å¥åº·çŠ¶æ€

**æ£€æŸ¥é¡¹ç›®**:
- æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
- æ•°æ®åº“è¿æ¥æ£€æŸ¥
- ç¼“å­˜æœåŠ¡æ£€æŸ¥
- å¤–éƒ¨ä¾èµ–æ£€æŸ¥
- èµ„æºä½¿ç”¨ç‡æ£€æŸ¥

### 4. æ€§èƒ½åˆ†æ

**åŠŸèƒ½**: æ·±åº¦åˆ†ææ€§èƒ½æ•°æ®

**åˆ†æç»´åº¦**:
- è¶‹åŠ¿åˆ†æ: æ€§èƒ½å˜åŒ–è¶‹åŠ¿
- ç“¶é¢ˆåˆ†æ: æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
- å¯¹æ¯”åˆ†æ: ä¸åŒæ—¶æœŸæ€§èƒ½å¯¹æ¯”
- å¼‚å¸¸åˆ†æ: æ€§èƒ½å¼‚å¸¸æ£€æµ‹

---

## ğŸ“– APIæ–‡æ¡£

### recordMetric

è®°å½•æ€§èƒ½æŒ‡æ ‡

**ç­¾å**:
```typescript
recordMetric(
  metricName: string,
  value: number,
  tags?: Record<string, string>
): void
```

**å‚æ•°**:
- `metricName` - æŒ‡æ ‡åç§°
- `value` - æŒ‡æ ‡å€¼
- `tags` - æ ‡ç­¾ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

**ç¤ºä¾‹**:
```typescript
performanceMonitor.recordMetric('api_response_time', 150, {
  endpoint: '/api/students',
  method: 'GET',
  status: '200'
});
```

### startTimer

å¼€å§‹è®¡æ—¶å™¨

**ç­¾å**:
```typescript
startTimer(timerName: string): string
```

**è¿”å›å€¼**: è®¡æ—¶å™¨ID

**ç¤ºä¾‹**:
```typescript
const timerId = performanceMonitor.startTimer('database_query');
// æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
performanceMonitor.endTimer(timerId);
```

### endTimer

ç»“æŸè®¡æ—¶å™¨

**ç­¾å**:
```typescript
endTimer(timerId: string): number
```

**è¿”å›å€¼**: æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

### getMetrics

è·å–æ€§èƒ½æŒ‡æ ‡

**ç­¾å**:
```typescript
getMetrics(
  metricName?: string,
  timeRange?: TimeRange
): PerformanceMetrics
```

**å‚æ•°**:
```typescript
interface TimeRange {
  start: Date;
  end: Date;
}

interface PerformanceMetrics {
  metricName: string;
  count: number;
  average: number;
  min: number;
  max: number;
  p95: number;
  p99: number;
}
```

### checkHealth

å¥åº·æ£€æŸ¥

**ç­¾å**:
```typescript
async checkHealth(): Promise<HealthStatus>
```

**è¿”å›å€¼**:
```typescript
interface HealthStatus {
  status: 'healthy' | 'degraded' | 'unhealthy';
  checks: HealthCheck[];
  overall: {
    score: number;
    message: string;
  };
}

interface HealthCheck {
  name: string;
  status: 'pass' | 'warn' | 'fail';
  responseTime: number;
  message?: string;
}
```

### generateReport

ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

**ç­¾å**:
```typescript
generateReport(
  timeRange: TimeRange,
  options?: ReportOptions
): PerformanceReport
```

**å‚æ•°**:
```typescript
interface ReportOptions {
  includeCharts?: boolean;
  format?: 'json' | 'html' | 'pdf';
  metrics?: string[];
}

interface PerformanceReport {
  period: TimeRange;
  summary: {
    totalRequests: number;
    averageResponseTime: number;
    errorRate: number;
    uptime: number;
  };
  metrics: PerformanceMetrics[];
  recommendations: string[];
}
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€æ€§èƒ½ç›‘æ§

```typescript
import { performanceMonitor } from './monitoring/performance-monitor.service';

// ç›‘æ§APIå“åº”æ—¶é—´
async function monitorAPIPerformance() {
  const timerId = performanceMonitor.startTimer('api_request');
  
  try {
    // æ‰§è¡ŒAPIè¯·æ±‚
    const result = await processAPIRequest();
    
    // è®°å½•æˆåŠŸæŒ‡æ ‡
    const responseTime = performanceMonitor.endTimer(timerId);
    performanceMonitor.recordMetric('api_success_rate', 1, {
      endpoint: '/api/students',
      status: 'success'
    });
    
    console.log(`APIè¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${responseTime}ms`);
    return result;
    
  } catch (error) {
    // è®°å½•é”™è¯¯æŒ‡æ ‡
    performanceMonitor.endTimer(timerId);
    performanceMonitor.recordMetric('api_error_rate', 1, {
      endpoint: '/api/students',
      status: 'error',
      errorType: error.name
    });
    
    throw error;
  }
}
```

### ç¤ºä¾‹2: æ•°æ®åº“æ€§èƒ½ç›‘æ§

```typescript
async function monitorDatabasePerformance() {
  // ç›‘æ§æ•°æ®åº“æŸ¥è¯¢
  const queryTimer = performanceMonitor.startTimer('db_query');
  
  try {
    const students = await Student.findAll();
    const queryTime = performanceMonitor.endTimer(queryTimer);
    
    // è®°å½•æŸ¥è¯¢æŒ‡æ ‡
    performanceMonitor.recordMetric('db_query_time', queryTime, {
      table: 'students',
      operation: 'select',
      recordCount: students.length.toString()
    });
    
    // è®°å½•è¿æ¥æ± çŠ¶æ€
    const poolStats = await getConnectionPoolStats();
    performanceMonitor.recordMetric('db_pool_active', poolStats.active);
    performanceMonitor.recordMetric('db_pool_idle', poolStats.idle);
    
    return students;
    
  } catch (error) {
    performanceMonitor.endTimer(queryTimer);
    performanceMonitor.recordMetric('db_error_count', 1, {
      table: 'students',
      errorType: error.name
    });
    throw error;
  }
}
```

### ç¤ºä¾‹3: ç³»ç»Ÿå¥åº·æ£€æŸ¥

```typescript
async function performSystemHealthCheck() {
  console.log('å¼€å§‹ç³»ç»Ÿå¥åº·æ£€æŸ¥...');
  
  const healthStatus = await performanceMonitor.checkHealth();
  
  console.log(`ç³»ç»ŸçŠ¶æ€: ${healthStatus.status}`);
  console.log(`å¥åº·è¯„åˆ†: ${healthStatus.overall.score}/100`);
  console.log(`æ€»ä½“è¯„ä»·: ${healthStatus.overall.message}`);
  
  console.log('\nè¯¦ç»†æ£€æŸ¥ç»“æœ:');
  healthStatus.checks.forEach(check => {
    const statusIcon = check.status === 'pass' ? 'âœ…' : 
                      check.status === 'warn' ? 'âš ï¸' : 'âŒ';
    
    console.log(`${statusIcon} ${check.name}: ${check.status} (${check.responseTime}ms)`);
    if (check.message) {
      console.log(`   ${check.message}`);
    }
  });
  
  // å¦‚æœç³»ç»Ÿä¸å¥åº·ï¼Œå‘é€å‘Šè­¦
  if (healthStatus.status === 'unhealthy') {
    await sendHealthAlert(healthStatus);
  }
  
  return healthStatus;
}
```

### ç¤ºä¾‹4: æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ

```typescript
async function generateDailyReport() {
  const today = new Date();
  const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
  
  const report = performanceMonitor.generateReport(
    { start: yesterday, end: today },
    {
      includeCharts: true,
      format: 'json',
      metrics: ['api_response_time', 'db_query_time', 'error_rate']
    }
  );
  
  console.log('ğŸ“Š æ¯æ—¥æ€§èƒ½æŠ¥å‘Š');
  console.log('='.repeat(50));
  console.log(`æŠ¥å‘Šæ—¶é—´: ${yesterday.toLocaleDateString()} - ${today.toLocaleDateString()}`);
  console.log(`æ€»è¯·æ±‚æ•°: ${report.summary.totalRequests}`);
  console.log(`å¹³å‡å“åº”æ—¶é—´: ${report.summary.averageResponseTime}ms`);
  console.log(`é”™è¯¯ç‡: ${(report.summary.errorRate * 100).toFixed(2)}%`);
  console.log(`ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´: ${(report.summary.uptime * 100).toFixed(2)}%`);
  
  console.log('\nğŸ“ˆ å…³é”®æŒ‡æ ‡:');
  report.metrics.forEach(metric => {
    console.log(`${metric.metricName}:`);
    console.log(`  å¹³å‡å€¼: ${metric.average.toFixed(2)}`);
    console.log(`  æœ€å°å€¼: ${metric.min}`);
    console.log(`  æœ€å¤§å€¼: ${metric.max}`);
    console.log(`  P95: ${metric.p95}`);
    console.log(`  P99: ${metric.p99}`);
  });
  
  if (report.recommendations.length > 0) {
    console.log('\nğŸ’¡ ä¼˜åŒ–å»ºè®®:');
    report.recommendations.forEach((rec, index) => {
      console.log(`${index + 1}. ${rec}`);
    });
  }
  
  return report;
}
```

### ç¤ºä¾‹5: å®æ—¶æ€§èƒ½ç›‘æ§

```typescript
function startRealTimeMonitoring() {
  console.log('ğŸš€ å¯åŠ¨å®æ—¶æ€§èƒ½ç›‘æ§...');
  
  // æ¯5ç§’æ”¶é›†ä¸€æ¬¡ç³»ç»ŸæŒ‡æ ‡
  setInterval(() => {
    const memoryUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();
    
    // è®°å½•å†…å­˜ä½¿ç”¨
    performanceMonitor.recordMetric('memory_heap_used', memoryUsage.heapUsed);
    performanceMonitor.recordMetric('memory_heap_total', memoryUsage.heapTotal);
    performanceMonitor.recordMetric('memory_rss', memoryUsage.rss);
    
    // è®°å½•CPUä½¿ç”¨
    performanceMonitor.recordMetric('cpu_user', cpuUsage.user);
    performanceMonitor.recordMetric('cpu_system', cpuUsage.system);
    
  }, 5000);
  
  // æ¯åˆ†é’Ÿæ£€æŸ¥æ€§èƒ½é˜ˆå€¼
  setInterval(() => {
    const recentMetrics = performanceMonitor.getMetrics('api_response_time', {
      start: new Date(Date.now() - 60000), // æœ€è¿‘1åˆ†é’Ÿ
      end: new Date()
    });
    
    // æ£€æŸ¥å“åº”æ—¶é—´æ˜¯å¦è¶…è¿‡é˜ˆå€¼
    if (recentMetrics.average > 1000) {
      console.warn(`âš ï¸ å“åº”æ—¶é—´å‘Šè­¦: å¹³å‡å“åº”æ—¶é—´ ${recentMetrics.average}ms è¶…è¿‡é˜ˆå€¼`);
      
      // å‘é€å‘Šè­¦
      sendPerformanceAlert({
        type: 'high_response_time',
        value: recentMetrics.average,
        threshold: 1000
      });
    }
    
    // æ£€æŸ¥é”™è¯¯ç‡
    const errorMetrics = performanceMonitor.getMetrics('api_error_rate', {
      start: new Date(Date.now() - 60000),
      end: new Date()
    });
    
    if (errorMetrics.average > 0.05) { // é”™è¯¯ç‡è¶…è¿‡5%
      console.warn(`âš ï¸ é”™è¯¯ç‡å‘Šè­¦: é”™è¯¯ç‡ ${(errorMetrics.average * 100).toFixed(2)}% è¶…è¿‡é˜ˆå€¼`);
    }
    
  }, 60000);
}

// å‘Šè­¦å‘é€å‡½æ•°
async function sendPerformanceAlert(alert: any) {
  console.log(`ğŸš¨ æ€§èƒ½å‘Šè­¦: ${alert.type}`);
  // è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰å‘Šè­¦æ¸ é“
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```typescript
describe('PerformanceMonitorService', () => {
  let monitor: PerformanceMonitorService;

  beforeEach(() => {
    monitor = PerformanceMonitorService.getInstance();
    monitor.clearAllMetrics(); // æ¸…ç†å†å²æ•°æ®
  });

  describe('æŒ‡æ ‡è®°å½•', () => {
    it('åº”è¯¥è®°å½•æ€§èƒ½æŒ‡æ ‡', () => {
      monitor.recordMetric('test_metric', 100, { tag: 'test' });
      
      const metrics = monitor.getMetrics('test_metric');
      
      expect(metrics.count).toBe(1);
      expect(metrics.average).toBe(100);
    });

    it('åº”è¯¥è®¡ç®—ç»Ÿè®¡ä¿¡æ¯', () => {
      const values = [10, 20, 30, 40, 50];
      
      values.forEach(value => {
        monitor.recordMetric('test_metric', value);
      });
      
      const metrics = monitor.getMetrics('test_metric');
      
      expect(metrics.count).toBe(5);
      expect(metrics.average).toBe(30);
      expect(metrics.min).toBe(10);
      expect(metrics.max).toBe(50);
    });
  });

  describe('è®¡æ—¶å™¨', () => {
    it('åº”è¯¥æµ‹é‡æ‰§è¡Œæ—¶é—´', async () => {
      const timerId = monitor.startTimer('test_timer');
      
      // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const duration = monitor.endTimer(timerId);
      
      expect(duration).toBeGreaterThan(90);
      expect(duration).toBeLessThan(150);
    });

    it('åº”è¯¥å¤„ç†å¤šä¸ªå¹¶å‘è®¡æ—¶å™¨', () => {
      const timer1 = monitor.startTimer('timer1');
      const timer2 = monitor.startTimer('timer2');
      
      const duration1 = monitor.endTimer(timer1);
      const duration2 = monitor.endTimer(timer2);
      
      expect(duration1).toBeGreaterThan(0);
      expect(duration2).toBeGreaterThan(0);
    });
  });

  describe('å¥åº·æ£€æŸ¥', () => {
    it('åº”è¯¥æ‰§è¡Œå¥åº·æ£€æŸ¥', async () => {
      const health = await monitor.checkHealth();
      
      expect(health.status).toBeDefined();
      expect(health.checks).toBeInstanceOf(Array);
      expect(health.overall.score).toBeGreaterThanOrEqual(0);
      expect(health.overall.score).toBeLessThanOrEqual(100);
    });

    it('åº”è¯¥æ£€æŸ¥å„ä¸ªç»„ä»¶', async () => {
      const health = await monitor.checkHealth();
      
      const expectedChecks = [
        'database',
        'cache',
        'memory',
        'disk'
      ];
      
      expectedChecks.forEach(checkName => {
        const check = health.checks.find(c => c.name === checkName);
        expect(check).toBeDefined();
        expect(['pass', 'warn', 'fail']).toContain(check!.status);
      });
    });
  });

  describe('æŠ¥å‘Šç”Ÿæˆ', () => {
    it('åº”è¯¥ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š', () => {
      // æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
      for (let i = 0; i < 10; i++) {
        monitor.recordMetric('api_response_time', 100 + i * 10);
        monitor.recordMetric('api_error_rate', i % 3 === 0 ? 1 : 0);
      }
      
      const report = monitor.generateReport({
        start: new Date(Date.now() - 3600000), // 1å°æ—¶å‰
        end: new Date()
      });
      
      expect(report.summary).toBeDefined();
      expect(report.metrics).toBeInstanceOf(Array);
      expect(report.recommendations).toBeInstanceOf(Array);
    });
  });
});
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| æ•°æ®æ”¶é›†å»¶è¿Ÿ | <1ms | ~0.5ms | âœ… |
| å†…å­˜ä½¿ç”¨ | <50MB | ~40MB | âœ… |
| å¥åº·æ£€æŸ¥æ—¶é—´ | <500ms | ~300ms | âœ… |
| æŠ¥å‘Šç”Ÿæˆæ—¶é—´ | <2s | ~1.5s | âœ… |

### æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡å¤„ç†** - æ‰¹é‡å†™å…¥æ€§èƒ½æ•°æ®
2. **å†…å­˜ç®¡ç†** - å®šæœŸæ¸…ç†å†å²æ•°æ®
3. **å¼‚æ­¥å¤„ç†** - å¼‚æ­¥æ‰§è¡Œå¥åº·æ£€æŸ¥
4. **ç¼“å­˜æœºåˆ¶** - ç¼“å­˜è®¡ç®—ç»“æœ

---

**æ–‡æ¡£ç»´æŠ¤**: AIåŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-08
