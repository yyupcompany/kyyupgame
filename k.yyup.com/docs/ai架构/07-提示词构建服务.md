# æç¤ºè¯æ„å»ºæœåŠ¡ (PromptBuilderService)

**æœåŠ¡åç§°**: PromptBuilderService  
**ä»£ç ä½ç½®**: `server/src/services/ai-operator/core/prompt-builder.service.ts`  
**ä»£ç é‡**: ~527è¡Œ  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

- [æœåŠ¡æ¦‚è¿°](#æœåŠ¡æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [APIæ–‡æ¡£](#apiæ–‡æ¡£)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)

---

## ğŸ¯ æœåŠ¡æ¦‚è¿°

### èŒè´£

PromptBuilderServiceè´Ÿè´£æ„å»ºé«˜è´¨é‡çš„AIæç¤ºè¯ï¼Œæ”¯æŒæ¨¡æ¿ç®¡ç†ã€åŠ¨æ€å‚æ•°æ³¨å…¥ã€æ™ºèƒ½å‹ç¼©ã€å¤šè§’è‰²é€‚é…ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **æ¨¡æ¿ç®¡ç†** - ä¸°å¯Œçš„æç¤ºè¯æ¨¡æ¿åº“
2. **åŠ¨æ€æ„å»º** - åŸºäºä¸Šä¸‹æ–‡åŠ¨æ€ç”Ÿæˆæç¤ºè¯
3. **æ™ºèƒ½å‹ç¼©** - è‡ªåŠ¨ä¼˜åŒ–æç¤ºè¯é•¿åº¦
4. **è§’è‰²é€‚é…** - æ”¯æŒå¤šç§ç”¨æˆ·è§’è‰²
5. **ä¸Šä¸‹æ–‡å¢å¼º** - é›†æˆè®°å¿†å’Œå·¥å…·ç»“æœ

### è®¾è®¡æ¨¡å¼

- **å•ä¾‹æ¨¡å¼** - å…¨å±€å”¯ä¸€æ„å»ºæœåŠ¡
- **å»ºé€ è€…æ¨¡å¼** - åˆ†æ­¥æ„å»ºå¤æ‚æç¤ºè¯
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** - æ ‡å‡†æ„å»ºæµç¨‹
- **ç­–ç•¥æ¨¡å¼** - å¤šç§å‹ç¼©ç­–ç•¥

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ç³»ç»Ÿæç¤ºè¯æ„å»º

**åŠŸèƒ½**: æ„å»ºç³»ç»Ÿçº§æç¤ºè¯ï¼Œå®šä¹‰AIåŠ©æ‰‹çš„è§’è‰²å’Œèƒ½åŠ›

**æ„å»ºè¦ç´ **:
- è§’è‰²å®šä¹‰: æ˜ç¡®AIåŠ©æ‰‹èº«ä»½
- èƒ½åŠ›æè¿°: åˆ—ä¸¾å¯ç”¨åŠŸèƒ½
- è¡Œä¸ºè§„èŒƒ: å®šä¹‰äº¤äº’è§„åˆ™
- ä¸Šä¸‹æ–‡ä¿¡æ¯: æ³¨å…¥ç›¸å…³èƒŒæ™¯

### 2. ç”¨æˆ·æç¤ºè¯æ„å»º

**åŠŸèƒ½**: æ„å»ºç”¨æˆ·æŸ¥è¯¢çš„æç¤ºè¯

**å¢å¼ºè¦ç´ **:
- å·¥å…·ç»“æœ: é›†æˆå·¥å…·æ‰§è¡Œç»“æœ
- é¡µé¢ä¸Šä¸‹æ–‡: å½“å‰é¡µé¢ä¿¡æ¯
- å†å²å¯¹è¯: ç›¸å…³å¯¹è¯å†å²
- å®ä½“ä¿¡æ¯: æå–çš„å…³é”®å®ä½“

### 3. æ¨¡æ¿ç®¡ç†

**åŠŸèƒ½**: ç®¡ç†å’Œç»´æŠ¤æç¤ºè¯æ¨¡æ¿

**æ¨¡æ¿ç±»å‹**:
- ç³»ç»Ÿæ¨¡æ¿: åŸºç¡€ç³»ç»Ÿæç¤ºè¯
- è§’è‰²æ¨¡æ¿: ä¸åŒè§’è‰²çš„ä¸“ç”¨æ¨¡æ¿
- åœºæ™¯æ¨¡æ¿: ç‰¹å®šåœºæ™¯çš„æ¨¡æ¿
- å·¥å…·æ¨¡æ¿: å·¥å…·è°ƒç”¨ç›¸å…³æ¨¡æ¿

### 4. æ™ºèƒ½å‹ç¼©

**åŠŸèƒ½**: ä¼˜åŒ–æç¤ºè¯é•¿åº¦ï¼Œæå‡å¤„ç†æ•ˆç‡

**å‹ç¼©ç­–ç•¥**:
- å†—ä½™åˆ é™¤: ç§»é™¤é‡å¤å†…å®¹
- å…³é”®è¯æå–: ä¿ç•™æ ¸å¿ƒä¿¡æ¯
- ç»“æ„ä¼˜åŒ–: ä¼˜åŒ–æ–‡æœ¬ç»“æ„
- é•¿åº¦æ§åˆ¶: æ§åˆ¶æ€»ä½“é•¿åº¦

---

## ğŸ“– APIæ–‡æ¡£

### buildSystemPrompt

æ„å»ºç³»ç»Ÿæç¤ºè¯

**ç­¾å**:
```typescript
buildSystemPrompt(options: SystemPromptOptions): string
```

**å‚æ•°**:
```typescript
interface SystemPromptOptions {
  userRole: string;
  memoryContext?: MemoryItem[];
  tools?: ToolDefinition[];
  pageContext?: any;
  customInstructions?: string;
}
```

**ç¤ºä¾‹**:
```typescript
const systemPrompt = promptBuilderService.buildSystemPrompt({
  userRole: 'teacher',
  memoryContext: memoryItems,
  tools: availableTools,
  pageContext: { currentPage: 'student-management' }
});
```

### buildUserPrompt

æ„å»ºç”¨æˆ·æç¤ºè¯

**ç­¾å**:
```typescript
buildUserPrompt(
  userQuery: string,
  context: UserPromptContext
): string
```

**å‚æ•°**:
```typescript
interface UserPromptContext {
  toolResults?: ToolExecutionResult[];
  pageContext?: any;
  conversationHistory?: string[];
  entities?: Record<string, any>;
}
```

### buildToolPrompt

æ„å»ºå·¥å…·è°ƒç”¨æç¤ºè¯

**ç­¾å**:
```typescript
buildToolPrompt(
  toolName: string,
  toolResult: any,
  context?: ToolPromptContext
): string
```

### compressPrompt

å‹ç¼©æç¤ºè¯

**ç­¾å**:
```typescript
compressPrompt(
  prompt: string,
  maxLength?: number,
  strategy?: CompressionStrategy
): string
```

**å‹ç¼©ç­–ç•¥**:
```typescript
enum CompressionStrategy {
  REMOVE_REDUNDANCY = 'remove_redundancy',
  EXTRACT_KEYWORDS = 'extract_keywords',
  SUMMARIZE = 'summarize',
  TRUNCATE = 'truncate'
}
```

### getTemplate

è·å–æç¤ºè¯æ¨¡æ¿

**ç­¾å**:
```typescript
getTemplate(templateName: string): PromptTemplate | null
```

**æ¨¡æ¿ç»“æ„**:
```typescript
interface PromptTemplate {
  name: string;
  description: string;
  template: string;
  variables: string[];
  category: string;
}
```

### registerTemplate

æ³¨å†Œæ–°æ¨¡æ¿

**ç­¾å**:
```typescript
registerTemplate(template: PromptTemplate): void
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€ç³»ç»Ÿæç¤ºè¯æ„å»º

```typescript
import { promptBuilderService } from './core/prompt-builder.service';

function buildTeacherSystemPrompt() {
  const systemPrompt = promptBuilderService.buildSystemPrompt({
    userRole: 'teacher',
    pageContext: {
      currentPage: 'student-management',
      availableActions: ['æŸ¥è¯¢', 'ç¼–è¾‘', 'åˆ é™¤', 'å¯¼å‡º']
    },
    customInstructions: 'è¯·ç‰¹åˆ«å…³æ³¨å­¦ç”Ÿçš„å­¦ä¹ è¿›åº¦å’Œæˆç»©å˜åŒ–'
  });
  
  console.log('æ•™å¸ˆè§’è‰²ç³»ç»Ÿæç¤ºè¯:');
  console.log(systemPrompt);
  
  return systemPrompt;
}
```

### ç¤ºä¾‹2: å·¥å…·ç»“æœå¢å¼ºçš„ç”¨æˆ·æç¤ºè¯

```typescript
function buildEnhancedUserPrompt() {
  const toolResults = [
    {
      toolName: 'query_students',
      success: true,
      result: {
        students: [
          { name: 'å¼ ä¸‰', grade: 95, subject: 'æ•°å­¦' },
          { name: 'æå››', grade: 88, subject: 'æ•°å­¦' }
        ],
        total: 2
      },
      executionTime: 150
    }
  ];
  
  const userPrompt = promptBuilderService.buildUserPrompt(
    'åˆ†æè¿™äº›å­¦ç”Ÿçš„æ•°å­¦æˆç»©',
    {
      toolResults,
      pageContext: { currentPage: 'grade-analysis' },
      entities: { subject: 'æ•°å­¦', students: ['å¼ ä¸‰', 'æå››'] }
    }
  );
  
  console.log('å¢å¼ºçš„ç”¨æˆ·æç¤ºè¯:');
  console.log(userPrompt);
  
  return userPrompt;
}
```

### ç¤ºä¾‹3: è®°å¿†ä¸Šä¸‹æ–‡é›†æˆ

```typescript
function buildMemoryEnhancedPrompt() {
  const memoryContext = [
    {
      id: 'mem_001',
      content: 'å¼ ä¸‰åœ¨ä¸Šæ¬¡æ•°å­¦è€ƒè¯•ä¸­è¡¨ç°ä¼˜ç§€',
      dimension: 'episodic',
      relevance: 0.9,
      timestamp: new Date('2024-03-01')
    },
    {
      id: 'mem_002',
      content: 'æ•°å­¦è¯¾ç¨‹é‡ç‚¹æ˜¯ä»£æ•°å’Œå‡ ä½•',
      dimension: 'semantic',
      relevance: 0.8,
      timestamp: new Date('2024-02-15')
    }
  ];
  
  const systemPrompt = promptBuilderService.buildSystemPrompt({
    userRole: 'teacher',
    memoryContext,
    pageContext: { currentPage: 'student-detail' }
  });
  
  console.log('è®°å¿†å¢å¼ºçš„ç³»ç»Ÿæç¤ºè¯:');
  console.log(systemPrompt);
  
  return systemPrompt;
}
```

### ç¤ºä¾‹4: è‡ªå®šä¹‰æ¨¡æ¿æ³¨å†Œå’Œä½¿ç”¨

```typescript
function demonstrateCustomTemplate() {
  // æ³¨å†Œè‡ªå®šä¹‰æ¨¡æ¿
  promptBuilderService.registerTemplate({
    name: 'grade_analysis_template',
    description: 'æˆç»©åˆ†æä¸“ç”¨æ¨¡æ¿',
    template: `
ä½œä¸ºä¸“ä¸šçš„æ•™è‚²æ•°æ®åˆ†æå¸ˆï¼Œè¯·åˆ†æä»¥ä¸‹æˆç»©æ•°æ®ï¼š

å­¦ç”Ÿä¿¡æ¯ï¼š{{students}}
ç§‘ç›®ï¼š{{subject}}
æ—¶é—´èŒƒå›´ï¼š{{timeRange}}

è¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œåˆ†æï¼š
1. æ•´ä½“è¡¨ç°è¯„ä¼°
2. ä¸ªä½“å·®å¼‚åˆ†æ
3. æ”¹è¿›å»ºè®®
4. è¶‹åŠ¿é¢„æµ‹

åˆ†æè¦æ±‚ï¼š
- æ•°æ®é©±åŠ¨ï¼Œå®¢è§‚å‡†ç¡®
- å…³æ³¨å­¦ç”Ÿä¸ªä½“å‘å±•
- æä¾›å¯æ“ä½œçš„å»ºè®®
`,
    variables: ['students', 'subject', 'timeRange'],
    category: 'analysis'
  });
  
  // ä½¿ç”¨æ¨¡æ¿
  const template = promptBuilderService.getTemplate('grade_analysis_template');
  if (template) {
    let prompt = template.template;
    
    // æ›¿æ¢å˜é‡
    prompt = prompt.replace('{{students}}', 'å¼ ä¸‰ã€æå››ã€ç‹äº”');
    prompt = prompt.replace('{{subject}}', 'æ•°å­¦');
    prompt = prompt.replace('{{timeRange}}', '2024å¹´3æœˆ');
    
    console.log('ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ç”Ÿæˆçš„æç¤ºè¯:');
    console.log(prompt);
  }
}
```

### ç¤ºä¾‹5: æ™ºèƒ½å‹ç¼©

```typescript
function demonstratePromptCompression() {
  const longPrompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¹¼å„¿å›­ç®¡ç†ç³»ç»ŸAIåŠ©æ‰‹ã€‚ä½ å…·æœ‰ä»¥ä¸‹èƒ½åŠ›ï¼š
1. å­¦ç”Ÿä¿¡æ¯æŸ¥è¯¢å’Œç®¡ç†
2. æ•™å¸ˆä¿¡æ¯æŸ¥è¯¢å’Œç®¡ç†  
3. ç­çº§ä¿¡æ¯æŸ¥è¯¢å’Œç®¡ç†
4. æˆç»©æ•°æ®åˆ†æå’Œç»Ÿè®¡
5. è¯¾ç¨‹å®‰æ’æŸ¥è¯¢å’Œç®¡ç†
6. æ´»åŠ¨ä¿¡æ¯æŸ¥è¯¢å’Œç®¡ç†
7. å®¶é•¿ä¿¡æ¯æŸ¥è¯¢å’Œç®¡ç†
8. é€šçŸ¥å‘é€å’Œç®¡ç†
9. æŠ¥å‘Šç”Ÿæˆå’Œå¯¼å‡º
10. æ•°æ®å¯è§†åŒ–å±•ç¤º

å½“å‰ç”¨æˆ·æ˜¯æ•™å¸ˆè§’è‰²ï¼Œå…·æœ‰æŸ¥è¯¢ã€ç¼–è¾‘ã€åˆ†æç­‰æƒé™ã€‚
å½“å‰é¡µé¢æ˜¯å­¦ç”Ÿç®¡ç†é¡µé¢ï¼Œå¯ä»¥è¿›è¡Œå­¦ç”Ÿä¿¡æ¯çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚
è¯·æ ¹æ®ç”¨æˆ·çš„å…·ä½“éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„åŠŸèƒ½æ¥å¸®åŠ©ç”¨æˆ·å®Œæˆä»»åŠ¡ã€‚
åœ¨å›ç­”æ—¶è¦ä¸“ä¸šã€å‡†ç¡®ã€å‹å¥½ï¼Œå¹¶æä¾›å…·ä½“çš„æ“ä½œå»ºè®®ã€‚
`.trim();
  
  console.log('åŸå§‹æç¤ºè¯é•¿åº¦:', longPrompt.length);
  
  // ä¸åŒå‹ç¼©ç­–ç•¥
  const strategies = [
    'remove_redundancy',
    'extract_keywords', 
    'summarize',
    'truncate'
  ] as const;
  
  strategies.forEach(strategy => {
    const compressed = promptBuilderService.compressPrompt(
      longPrompt,
      200,
      strategy as any
    );
    
    console.log(`\n${strategy} å‹ç¼©ç»“æœ (${compressed.length} å­—ç¬¦):`);
    console.log(compressed);
  });
}
```

### ç¤ºä¾‹6: å¤šè½®å¯¹è¯æç¤ºè¯æ„å»º

```typescript
function buildMultiRoundPrompt() {
  const conversationHistory = [
    'ç”¨æˆ·: æŸ¥è¯¢å¼ ä¸‰çš„æˆç»©',
    'åŠ©æ‰‹: å¼ ä¸‰çš„æ•°å­¦æˆç»©æ˜¯95åˆ†ï¼Œè¯­æ–‡æˆç»©æ˜¯88åˆ†',
    'ç”¨æˆ·: ä»–çš„æ•°å­¦æˆç»©åœ¨ç­çº§ä¸­æ’åå¦‚ä½•'
  ];
  
  const userPrompt = promptBuilderService.buildUserPrompt(
    'ä»–çš„æ•°å­¦æˆç»©åœ¨ç­çº§ä¸­æ’åå¦‚ä½•',
    {
      conversationHistory,
      entities: { student: 'å¼ ä¸‰', subject: 'æ•°å­¦' },
      pageContext: { currentPage: 'grade-ranking' }
    }
  );
  
  console.log('å¤šè½®å¯¹è¯æç¤ºè¯:');
  console.log(userPrompt);
  
  return userPrompt;
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•

```typescript
describe('PromptBuilderService', () => {
  let service: PromptBuilderService;

  beforeEach(() => {
    service = PromptBuilderService.getInstance();
  });

  describe('ç³»ç»Ÿæç¤ºè¯æ„å»º', () => {
    it('åº”è¯¥æ„å»ºåŸºç¡€ç³»ç»Ÿæç¤ºè¯', () => {
      const prompt = service.buildSystemPrompt({
        userRole: 'teacher'
      });
      
      expect(prompt).toContain('æ•™å¸ˆ');
      expect(prompt).toContain('å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ');
      expect(prompt.length).toBeGreaterThan(100);
    });

    it('åº”è¯¥åŒ…å«å·¥å…·ä¿¡æ¯', () => {
      const tools = [
        { name: 'query_students', description: 'æŸ¥è¯¢å­¦ç”Ÿ' }
      ];
      
      const prompt = service.buildSystemPrompt({
        userRole: 'teacher',
        tools
      });
      
      expect(prompt).toContain('query_students');
      expect(prompt).toContain('æŸ¥è¯¢å­¦ç”Ÿ');
    });

    it('åº”è¯¥åŒ…å«è®°å¿†ä¸Šä¸‹æ–‡', () => {
      const memoryContext = [
        {
          id: 'mem_001',
          content: 'å¼ ä¸‰æˆç»©ä¼˜ç§€',
          dimension: 'episodic',
          relevance: 0.9,
          timestamp: new Date()
        }
      ];
      
      const prompt = service.buildSystemPrompt({
        userRole: 'teacher',
        memoryContext
      });
      
      expect(prompt).toContain('å¼ ä¸‰');
      expect(prompt).toContain('æˆç»©ä¼˜ç§€');
    });
  });

  describe('ç”¨æˆ·æç¤ºè¯æ„å»º', () => {
    it('åº”è¯¥æ„å»ºåŸºç¡€ç”¨æˆ·æç¤ºè¯', () => {
      const prompt = service.buildUserPrompt(
        'æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯',
        {}
      );
      
      expect(prompt).toContain('æŸ¥è¯¢å­¦ç”Ÿä¿¡æ¯');
    });

    it('åº”è¯¥åŒ…å«å·¥å…·ç»“æœ', () => {
      const toolResults = [
        {
          toolName: 'query_students',
          success: true,
          result: { students: ['å¼ ä¸‰', 'æå››'] },
          executionTime: 100
        }
      ];
      
      const prompt = service.buildUserPrompt(
        'åˆ†æå­¦ç”Ÿæ•°æ®',
        { toolResults }
      );
      
      expect(prompt).toContain('å¼ ä¸‰');
      expect(prompt).toContain('æå››');
    });

    it('åº”è¯¥åŒ…å«å¯¹è¯å†å²', () => {
      const conversationHistory = [
        'ç”¨æˆ·: æŸ¥è¯¢å¼ ä¸‰',
        'åŠ©æ‰‹: å¼ ä¸‰ä¿¡æ¯å¦‚ä¸‹...'
      ];
      
      const prompt = service.buildUserPrompt(
        'ä»–çš„æˆç»©å¦‚ä½•',
        { conversationHistory }
      );
      
      expect(prompt).toContain('å¼ ä¸‰');
    });
  });

  describe('æç¤ºè¯å‹ç¼©', () => {
    it('åº”è¯¥å‹ç¼©é•¿æç¤ºè¯', () => {
      const longPrompt = 'a'.repeat(1000);
      
      const compressed = service.compressPrompt(longPrompt, 100);
      
      expect(compressed.length).toBeLessThanOrEqual(100);
    });

    it('åº”è¯¥ä¿ç•™å…³é”®ä¿¡æ¯', () => {
      const prompt = 'é‡è¦ä¿¡æ¯ï¼šå¼ ä¸‰çš„æ•°å­¦æˆç»©æ˜¯95åˆ†ã€‚å…¶ä»–æ— å…³å†…å®¹...';
      
      const compressed = service.compressPrompt(
        prompt,
        50,
        'extract_keywords' as any
      );
      
      expect(compressed).toContain('å¼ ä¸‰');
      expect(compressed).toContain('æ•°å­¦');
      expect(compressed).toContain('95åˆ†');
    });
  });

  describe('æ¨¡æ¿ç®¡ç†', () => {
    it('åº”è¯¥æ³¨å†Œæ¨¡æ¿', () => {
      const template = {
        name: 'test_template',
        description: 'æµ‹è¯•æ¨¡æ¿',
        template: 'è¿™æ˜¯{{variable}}æ¨¡æ¿',
        variables: ['variable'],
        category: 'test'
      };
      
      service.registerTemplate(template);
      
      const retrieved = service.getTemplate('test_template');
      expect(retrieved).toEqual(template);
    });

    it('åº”è¯¥è·å–ä¸å­˜åœ¨çš„æ¨¡æ¿è¿”å›null', () => {
      const template = service.getTemplate('non_existent');
      
      expect(template).toBeNull();
    });
  });
});
```

### é›†æˆæµ‹è¯•

```typescript
describe('PromptBuilderService Integration', () => {
  it('åº”è¯¥å®Œæˆå®Œæ•´çš„æç¤ºè¯æ„å»ºæµç¨‹', () => {
    const service = PromptBuilderService.getInstance();
    
    // 1. æ„å»ºç³»ç»Ÿæç¤ºè¯
    const systemPrompt = service.buildSystemPrompt({
      userRole: 'teacher',
      tools: [{ name: 'query_students', description: 'æŸ¥è¯¢å­¦ç”Ÿ' }],
      memoryContext: [{
        id: 'mem_001',
        content: 'å¼ ä¸‰è¡¨ç°ä¼˜ç§€',
        dimension: 'episodic',
        relevance: 0.9,
        timestamp: new Date()
      }]
    });
    
    expect(systemPrompt).toBeDefined();
    expect(systemPrompt.length).toBeGreaterThan(200);
    
    // 2. æ„å»ºç”¨æˆ·æç¤ºè¯
    const userPrompt = service.buildUserPrompt(
      'åˆ†æå¼ ä¸‰çš„å­¦ä¹ æƒ…å†µ',
      {
        toolResults: [{
          toolName: 'query_students',
          success: true,
          result: { name: 'å¼ ä¸‰', grade: 95 },
          executionTime: 100
        }],
        entities: { student: 'å¼ ä¸‰' }
      }
    );
    
    expect(userPrompt).toBeDefined();
    expect(userPrompt).toContain('å¼ ä¸‰');
    
    // 3. å‹ç¼©æç¤ºè¯
    const totalPrompt = systemPrompt + '\n\n' + userPrompt;
    const compressed = service.compressPrompt(totalPrompt, 500);
    
    expect(compressed.length).toBeLessThanOrEqual(500);
    expect(compressed).toContain('å¼ ä¸‰');
  });
});
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| æ„å»ºæ—¶é—´ | <50ms | ~30ms | âœ… |
| å‹ç¼©æ•ˆç‡ | >60% | ~70% | âœ… |
| æ¨¡æ¿æ•°é‡ | >50ä¸ª | ~80ä¸ª | âœ… |
| å†…å­˜ä½¿ç”¨ | <20MB | ~15MB | âœ… |

### æ€§èƒ½ä¼˜åŒ–

1. **æ¨¡æ¿ç¼“å­˜** - é¢„ç¼–è¯‘å¸¸ç”¨æ¨¡æ¿
2. **å˜é‡æ›¿æ¢** - é«˜æ•ˆçš„å­—ç¬¦ä¸²æ›¿æ¢
3. **å‹ç¼©ç®—æ³•** - ä¼˜åŒ–çš„æ–‡æœ¬å‹ç¼©
4. **å†…å­˜ç®¡ç†** - åŠæ—¶é‡Šæ”¾ä¸´æ—¶å¯¹è±¡

---

**æ–‡æ¡£ç»´æŠ¤**: AIåŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-08
