# æ´»åŠ¨åˆ†äº«3çº§å±‚çº§åŠŸèƒ½å®ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-06  
**çŠ¶æ€**: âœ… åŠŸèƒ½å®ç°å®Œæˆï¼Œå¾…åç«¯æœåŠ¡ä¿®å¤åæµ‹è¯•  
**ä¼˜å…ˆçº§**: P0 - æ ¸å¿ƒåŠŸèƒ½

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### åŸå§‹éœ€æ±‚
æ´»åŠ¨åˆ†äº«ä¸éœ€è¦æƒé™é™åˆ¶ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥åˆ†äº«ï¼Œåªéœ€è¦è®°å½•åˆ†äº«å±‚çº§å…³ç³»å³å¯ï¼Œæ”¯æŒ3çº§åˆ†äº«å±‚çº§æŸ¥è¯¢ï¼Œæ–¹ä¾¿ä»¥ååšå¥–åŠ±ä½¿ç”¨ã€‚

### æ ¸å¿ƒè¦æ±‚
1. âœ… ç§»é™¤åˆ†äº«æƒé™é™åˆ¶ - æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥åˆ†äº«
2. âœ… è®°å½•åˆ†äº«å±‚çº§å…³ç³» - æ”¯æŒ3çº§åˆ†äº«é“¾è·¯è¿½è¸ª
3. âœ… æä¾›å±‚çº§æŸ¥è¯¢API - æ–¹ä¾¿æŸ¥è¯¢åˆ†äº«æ ‘ç»“æ„
4. âœ… ä¸ºæœªæ¥å¥–åŠ±ç³»ç»Ÿåšå‡†å¤‡

---

## âœ¨ åŠŸèƒ½å®ç°

### 1. ç§»é™¤æƒé™é™åˆ¶

**ä¿®æ”¹æ–‡ä»¶**: `server/src/routes/activities.routes.ts`

**ä¿®æ”¹å‰**:
```typescript
// åˆ†äº«æ´»åŠ¨
router.post('/:id/share',
  verifyToken,
  checkPermission('ACTIVITY_VIEW'),  // âŒ éœ€è¦æƒé™
  activityController.share
);
```

**ä¿®æ”¹å**:
```typescript
// åˆ†äº«æ´»åŠ¨ - æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥åˆ†äº«ï¼Œæ— éœ€ç‰¹æ®Šæƒé™
router.post('/:id/share',
  verifyToken,  // âœ… åªéœ€è¦ç™»å½•
  activityController.share
);
```

**å½±å“**:
- âœ… æ•™å¸ˆå¯ä»¥åˆ†äº«æ´»åŠ¨
- âœ… å®¶é•¿å¯ä»¥åˆ†äº«æ´»åŠ¨
- âœ… æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥åˆ†äº«

---

### 2. æ•°æ®åº“ç»“æ„å˜æ›´

**æ–°å¢å­—æ®µ**:

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|--------|
| `parent_sharer_id` | INT | ä¸Šçº§åˆ†äº«è€…ID | NULL |
| `share_level` | INT | åˆ†äº«å±‚çº§ï¼ˆ1/2/3ï¼‰ | 1 |

**ç´¢å¼•ä¼˜åŒ–**:
- `idx_activity_shares_parent_sharer_id` - ä¸Šçº§åˆ†äº«è€…ç´¢å¼•
- `idx_activity_shares_sharer_level` - åˆ†äº«è€…+å±‚çº§å¤åˆç´¢å¼•
- `idx_activity_shares_activity_level` - æ´»åŠ¨+å±‚çº§å¤åˆç´¢å¼•

**å¤–é”®çº¦æŸ**:
```sql
FOREIGN KEY (parent_sharer_id) 
REFERENCES users(id) 
ON DELETE SET NULL 
ON UPDATE CASCADE
```

**è¿ç§»æ–‡ä»¶**:
- `server/src/migrations/20251006223600-add-parent-sharer-to-activity-shares.js`
- `server/scripts/add-share-hierarchy-fields.js` (æ‰§è¡Œè„šæœ¬)

**æ‰§è¡Œç»“æœ**: âœ… æˆåŠŸ

---

### 3. åˆ†äº«å±‚çº§é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**: `server/src/controllers/activity.controller.ts`

**æ ¸å¿ƒé€»è¾‘**:
```typescript
// è®¡ç®—åˆ†äº«å±‚çº§
let shareLevel = 1;
let actualParentSharerId = parentSharerId;

if (parentSharerId) {
  // æŸ¥è¯¢ä¸Šçº§åˆ†äº«è€…çš„åˆ†äº«è®°å½•ï¼Œè·å–å…¶åˆ†äº«å±‚çº§
  const parentShare = await activityService.getLatestShareByUser(
    activity.id,
    parentSharerId
  );
  
  if (parentShare) {
    shareLevel = Math.min(parentShare.shareLevel + 1, 3); // æœ€å¤š3çº§
    
    // å¦‚æœä¸Šçº§å·²ç»æ˜¯3çº§ï¼Œåˆ™ä¸è®°å½•ä¸Šçº§å…³ç³»ï¼ˆä¸å†ç»§ç»­åˆ†äº«é“¾ï¼‰
    if (parentShare.shareLevel >= 3) {
      actualParentSharerId = undefined;
      shareLevel = 1; // é‡æ–°å¼€å§‹è®¡ç®—
    }
  }
}
```

**åˆ†äº«å±‚çº§è§„åˆ™**:
1. **ä¸€çº§åˆ†äº«**: ç›´æ¥åˆ†äº«æ´»åŠ¨ï¼Œ`shareLevel = 1`ï¼Œ`parentSharerId = null`
2. **äºŒçº§åˆ†äº«**: é€šè¿‡ä¸€çº§åˆ†äº«è€…çš„é“¾æ¥åˆ†äº«ï¼Œ`shareLevel = 2`ï¼Œ`parentSharerId = ä¸€çº§åˆ†äº«è€…ID`
3. **ä¸‰çº§åˆ†äº«**: é€šè¿‡äºŒçº§åˆ†äº«è€…çš„é“¾æ¥åˆ†äº«ï¼Œ`shareLevel = 3`ï¼Œ`parentSharerId = äºŒçº§åˆ†äº«è€…ID`
4. **è¶…è¿‡ä¸‰çº§**: é‡æ–°å¼€å§‹è®¡ç®—ï¼Œ`shareLevel = 1`ï¼Œ`parentSharerId = null`

---

### 4. åˆ†äº«å±‚çº§æŸ¥è¯¢API

**æ–°å¢API**: `GET /api/activities/:id/share-hierarchy`

**è¯·æ±‚å‚æ•°**:
- `id` (è·¯å¾„å‚æ•°): æ´»åŠ¨ID
- `userId` (æŸ¥è¯¢å‚æ•°, å¯é€‰): æŸ¥è¯¢çš„ç”¨æˆ·IDï¼Œé»˜è®¤ä¸ºå½“å‰ç™»å½•ç”¨æˆ·

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 121,
      "username": "admin",
      "realName": "æ²ˆç‡•",
      "shareLevel": 1,
      "shareTime": "2025-10-06T14:30:00.000Z"
    },
    "shareLevel": 1,
    "totalShares": 5,
    "level1Shares": [
      {
        "id": 1,
        "sharerId": 130,
        "username": "teacher01",
        "realName": "æµ‹è¯•æ•™å¸ˆ",
        "phone": "13800138000",
        "shareChannel": "wechat",
        "shareTime": "2025-10-06T14:35:00.000Z",
        "shareLevel": 2
      }
    ],
    "level2Shares": [
      {
        "id": 2,
        "sharerId": 150,
        "username": "parent01",
        "realName": "å®¶é•¿A",
        "phone": "13900139000",
        "parentSharerId": 130,
        "parentSharerName": "æµ‹è¯•æ•™å¸ˆ",
        "shareChannel": "link",
        "shareTime": "2025-10-06T14:40:00.000Z",
        "shareLevel": 3
      }
    ],
    "level3Shares": []
  }
}
```

**åŠŸèƒ½ç‰¹ç‚¹**:
- âœ… æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„åˆ†äº«æ ‘
- âœ… åŒ…å«ä¸‹çº§1-3çº§åˆ†äº«è€…ä¿¡æ¯
- âœ… æ˜¾ç¤ºåˆ†äº«æ¸ é“å’Œæ—¶é—´
- âœ… æ˜¾ç¤ºä¸Šçº§åˆ†äº«è€…ä¿¡æ¯
- âœ… ç»Ÿè®¡æ€»åˆ†äº«æ•°

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### åç«¯æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `server/src/routes/activities.routes.ts` | ä¿®æ”¹ | ç§»é™¤åˆ†äº«æƒé™æ£€æŸ¥ï¼Œæ–°å¢å±‚çº§æŸ¥è¯¢è·¯ç”± |
| `server/src/controllers/activity.controller.ts` | ä¿®æ”¹ | å®ç°åˆ†äº«å±‚çº§é€»è¾‘ï¼Œæ–°å¢å±‚çº§æŸ¥è¯¢æ–¹æ³• |
| `server/src/services/activity/activity.service.ts` | ä¿®æ”¹ | æ–°å¢å±‚çº§æŸ¥è¯¢æœåŠ¡æ–¹æ³• |
| `server/src/models/activity-share.model.ts` | ä¿®æ”¹ | æ–°å¢å±‚çº§å­—æ®µå’Œå…³è” |
| `server/src/migrations/20251006223600-add-parent-sharer-to-activity-shares.js` | æ–°å¢ | æ•°æ®åº“è¿ç§»æ–‡ä»¶ |
| `server/scripts/add-share-hierarchy-fields.js` | æ–°å¢ | æ•°æ®åº“å­—æ®µæ·»åŠ è„šæœ¬ |

### æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|---------|---------|------|
| `scripts/test-teacher-share.js` | å·²å­˜åœ¨ | æ•™å¸ˆåˆ†äº«æµ‹è¯•è„šæœ¬ |
| `scripts/test-admin-share.js` | å·²å­˜åœ¨ | ç®¡ç†å‘˜åˆ†äº«æµ‹è¯•è„šæœ¬ |

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1: ä¸€çº§åˆ†äº«
**æ“ä½œ**: ç”¨æˆ·Aç›´æ¥åˆ†äº«æ´»åŠ¨156
**é¢„æœŸç»“æœ**:
- âœ… åˆ†äº«æˆåŠŸ
- âœ… `shareLevel = 1`
- âœ… `parentSharerId = null`
- âœ… åˆ†äº«é“¾æ¥: `https://localhost:5173/activity/register/156?sharerId=A`

#### åœºæ™¯2: äºŒçº§åˆ†äº«
**æ“ä½œ**: ç”¨æˆ·Bé€šè¿‡ç”¨æˆ·Açš„åˆ†äº«é“¾æ¥è®¿é—®å¹¶åˆ†äº«
**é¢„æœŸç»“æœ**:
- âœ… åˆ†äº«æˆåŠŸ
- âœ… `shareLevel = 2`
- âœ… `parentSharerId = A`
- âœ… åˆ†äº«é“¾æ¥: `https://localhost:5173/activity/register/156?sharerId=B`

#### åœºæ™¯3: ä¸‰çº§åˆ†äº«
**æ“ä½œ**: ç”¨æˆ·Cé€šè¿‡ç”¨æˆ·Bçš„åˆ†äº«é“¾æ¥è®¿é—®å¹¶åˆ†äº«
**é¢„æœŸç»“æœ**:
- âœ… åˆ†äº«æˆåŠŸ
- âœ… `shareLevel = 3`
- âœ… `parentSharerId = B`
- âœ… åˆ†äº«é“¾æ¥: `https://localhost:5173/activity/register/156?sharerId=C`

#### åœºæ™¯4: è¶…è¿‡ä¸‰çº§
**æ“ä½œ**: ç”¨æˆ·Dé€šè¿‡ç”¨æˆ·Cçš„åˆ†äº«é“¾æ¥è®¿é—®å¹¶åˆ†äº«
**é¢„æœŸç»“æœ**:
- âœ… åˆ†äº«æˆåŠŸ
- âœ… `shareLevel = 1` (é‡æ–°å¼€å§‹)
- âœ… `parentSharerId = null`
- âœ… åˆ†äº«é“¾æ¥: `https://localhost:5173/activity/register/156?sharerId=D`

#### åœºæ™¯5: å±‚çº§æŸ¥è¯¢
**æ“ä½œ**: æŸ¥è¯¢ç”¨æˆ·Açš„åˆ†äº«æ ‘
**é¢„æœŸç»“æœ**:
- âœ… è¿”å›ç”¨æˆ·Açš„åˆ†äº«ä¿¡æ¯
- âœ… è¿”å›ä¸€çº§ä¸‹çº§ï¼ˆç”¨æˆ·Bï¼‰
- âœ… è¿”å›äºŒçº§ä¸‹çº§ï¼ˆç”¨æˆ·Cï¼‰
- âœ… è¿”å›ä¸‰çº§ä¸‹çº§ï¼ˆå¦‚æœæœ‰ï¼‰
- âœ… ç»Ÿè®¡æ€»åˆ†äº«æ•°

---

## ğŸš¨ å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
1. âœ… ç§»é™¤åˆ†äº«æƒé™é™åˆ¶
2. âœ… æ•°æ®åº“ç»“æ„å˜æ›´
3. âœ… åˆ†äº«å±‚çº§é€»è¾‘å®ç°
4. âœ… å±‚çº§æŸ¥è¯¢APIå®ç°
5. âœ… æ•°æ®åº“è¿ç§»æ‰§è¡Œ
6. âœ… ä»£ç æäº¤å’Œæ¨é€

### âš ï¸ å¾…è§£å†³
1. âš ï¸ **åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥** - `sop-stage.model.ts` åˆå§‹åŒ–é”™è¯¯
   - é”™è¯¯ä¿¡æ¯: `Error: No Sequelize instance passed`
   - å½±å“: æ— æ³•å¯åŠ¨åç«¯æœåŠ¡è¿›è¡Œæµ‹è¯•
   - ä¼˜å…ˆçº§: P0 - é˜»å¡æµ‹è¯•
   - è§£å†³æ–¹æ¡ˆ: ä¿®å¤ `sop-stage.model.ts` æ¨¡å‹åˆå§‹åŒ–é—®é¢˜

2. â¸ï¸ **åŠŸèƒ½æµ‹è¯•** - ç­‰å¾…åç«¯æœåŠ¡ä¿®å¤åè¿›è¡Œ
   - æµ‹è¯•æ•™å¸ˆåˆ†äº«åŠŸèƒ½
   - æµ‹è¯•å®¶é•¿åˆ†äº«åŠŸèƒ½
   - æµ‹è¯•åˆ†äº«å±‚çº§è®¡ç®—
   - æµ‹è¯•å±‚çº§æŸ¥è¯¢API

---

## ğŸ“Š APIæ–‡æ¡£

### POST /api/activities/:id/share

**æè¿°**: åˆ†äº«æ´»åŠ¨

**æƒé™**: éœ€è¦ç™»å½•ï¼ˆæ— ç‰¹æ®Šæƒé™è¦æ±‚ï¼‰

**è¯·æ±‚å‚æ•°**:
```json
{
  "shareChannel": "wechat",  // å¿…å¡«: wechat|weibo|qq|link|qrcode
  "shareContent": "å¿«æ¥å‚åŠ è¿™ä¸ªæ´»åŠ¨å§ï¼",  // å¯é€‰: è‡ªå®šä¹‰åˆ†äº«æ–‡æ¡ˆ
  "posterId": 1,  // å¯é€‰: åˆ†äº«çš„æµ·æŠ¥ID
  "parentSharerId": 121  // å¯é€‰: ä¸Šçº§åˆ†äº«è€…IDï¼ˆç”¨äºè®¡ç®—å±‚çº§ï¼‰
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "åˆ†äº«æˆåŠŸ",
  "data": {
    "shareUrl": "https://localhost:5173/activity/register/156?sharerId=130",
    "shareContent": "å¿«æ¥å‚åŠ è¿™ä¸ªæ´»åŠ¨å§ï¼",
    "qrcodeUrl": null,
    "shareId": 1,
    "shareLevel": 2,
    "parentSharerId": 121,
    "shareCount": 10
  }
}
```

### GET /api/activities/:id/share-hierarchy

**æè¿°**: æŸ¥è¯¢åˆ†äº«å±‚çº§å…³ç³»

**æƒé™**: éœ€è¦ç™»å½•

**è¯·æ±‚å‚æ•°**:
- `userId` (æŸ¥è¯¢å‚æ•°, å¯é€‰): æŸ¥è¯¢çš„ç”¨æˆ·IDï¼Œé»˜è®¤ä¸ºå½“å‰ç™»å½•ç”¨æˆ·

**å“åº”**: è§ä¸Šæ–‡"åˆ†äº«å±‚çº§æŸ¥è¯¢API"éƒ¨åˆ†

---

## ğŸ’¡ æœªæ¥æ‰©å±•

### å¥–åŠ±ç³»ç»Ÿé›†æˆ
åŸºäºåˆ†äº«å±‚çº§æ•°æ®ï¼Œå¯ä»¥å®ç°ä»¥ä¸‹å¥–åŠ±åŠŸèƒ½ï¼š

1. **ä¸€çº§åˆ†äº«å¥–åŠ±**: ç›´æ¥åˆ†äº«æ´»åŠ¨çš„ç”¨æˆ·è·å¾—åŸºç¡€å¥–åŠ±
2. **äºŒçº§åˆ†äº«å¥–åŠ±**: é€šè¿‡ä¸€çº§åˆ†äº«è€…é“¾æ¥åˆ†äº«çš„ç”¨æˆ·è·å¾—é¢å¤–å¥–åŠ±
3. **ä¸‰çº§åˆ†äº«å¥–åŠ±**: é€šè¿‡äºŒçº§åˆ†äº«è€…é“¾æ¥åˆ†äº«çš„ç”¨æˆ·è·å¾—æ›´å¤šå¥–åŠ±
4. **åˆ†äº«æ ‘å¥–åŠ±**: æ ¹æ®ä¸‹çº§åˆ†äº«æ•°é‡ç»™äºˆä¸Šçº§åˆ†äº«è€…å¥–åŠ±

### æ•°æ®åˆ†æ
- åˆ†äº«è½¬åŒ–ç‡åˆ†æ
- åˆ†äº«æ¸ é“æ•ˆæœåˆ†æ
- åˆ†äº«å±‚çº§åˆ†å¸ƒåˆ†æ
- ç”¨æˆ·åˆ†äº«è¡Œä¸ºåˆ†æ

---

## ğŸ“ Gitæäº¤è®°å½•

**æäº¤ä¿¡æ¯**:
```
âœ¨ å®ç°æ´»åŠ¨åˆ†äº«3çº§å±‚çº§åŠŸèƒ½

åŠŸèƒ½å®ç°:
1. ç§»é™¤åˆ†äº«æƒé™é™åˆ¶ - æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥åˆ†äº«æ´»åŠ¨
2. æ·»åŠ åˆ†äº«å±‚çº§æ”¯æŒ - æ”¯æŒ3çº§åˆ†äº«å±‚çº§è¿½è¸ª
3. æ•°æ®åº“å­—æ®µ:
   - parent_sharer_id: ä¸Šçº§åˆ†äº«è€…ID
   - share_level: åˆ†äº«å±‚çº§ï¼ˆ1/2/3ï¼‰
4. è‡ªåŠ¨è®¡ç®—åˆ†äº«å±‚çº§é€»è¾‘
5. æ–°å¢API: GET /api/activities/:id/share-hierarchy

æ•°æ®åº“å˜æ›´:
- æ·»åŠ  parent_sharer_id å­—æ®µ
- æ·»åŠ  share_level å­—æ®µ
- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- æ·»åŠ å¤–é”®çº¦æŸ

APIå˜æ›´:
- POST /api/activities/:id/share - ç§»é™¤æƒé™æ£€æŸ¥
- GET /api/activities/:id/share-hierarchy - æŸ¥è¯¢åˆ†äº«å±‚çº§å…³ç³»

æ–‡ä»¶ä¿®æ”¹:
- server/src/routes/activities.routes.ts (ç§»é™¤æƒé™æ£€æŸ¥)
- server/src/controllers/activity.controller.ts (åˆ†äº«å±‚çº§é€»è¾‘)
- server/src/services/activity/activity.service.ts (å±‚çº§æŸ¥è¯¢)
- server/src/models/activity-share.model.ts (æ–°å¢å­—æ®µ)
- server/src/migrations/20251006223600-add-parent-sharer-to-activity-shares.js (è¿ç§»)
- server/scripts/add-share-hierarchy-fields.js (æ•°æ®åº“è„šæœ¬)

ä¸‹ä¸€æ­¥: æµ‹è¯•åˆ†äº«å±‚çº§åŠŸèƒ½ï¼ŒéªŒè¯3çº§åˆ†äº«é“¾è·¯
```

**æäº¤å“ˆå¸Œ**: `4005d41`  
**åˆ†æ”¯**: `AIDEBUG1`  
**çŠ¶æ€**: âœ… å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2025-10-06 22:50  
**ä¸‹ä¸€æ­¥**: ä¿®å¤åç«¯æœåŠ¡å¯åŠ¨é—®é¢˜ï¼Œè¿›è¡ŒåŠŸèƒ½æµ‹è¯•

