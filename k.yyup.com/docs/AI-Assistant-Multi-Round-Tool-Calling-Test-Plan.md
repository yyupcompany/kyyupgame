# 前端AI助手多轮工具调用测试计划

**创建日期**: 2025-11-05  
**测试文件**: `tests/ai-assistant/05-multi-round-tool-calling.spec.ts`  
**状态**: ✅ 已完成

---

## 📋 测试目标

根据 Git 提交 `5a604bf` 的下一步计划，本测试套件旨在验证：

1. ✅ **多轮循环机制**：验证前端能否正确执行多轮工具调用
2. ✅ **对话历史维护**：验证对话历史是否正确保存和传递
3. ✅ **shouldContinue 判断逻辑**：验证工具调用的继续/停止判断
4. ✅ **工具结果传递**：验证工具调用结果能否正确传递给下一轮

---

## 🧪 测试用例列表

### 测试用例 5.1: 多轮工具调用 - 班级总数 → 学生总数 → 活动内容

**测试场景**: 核心测试场景，验证一个复杂请求能够触发多个工具调用

**测试步骤**:
1. 发送消息："请告诉我现在有多少个班级，多少个学生，以及今年有哪些活动"
2. 监听右侧边栏的工具调用记录
3. 等待AI最终响应
4. 验证至少有3个工具调用
5. 验证响应包含班级、学生、活动信息

**期望结果**:
- 至少执行 3 个工具调用
- 右侧边栏显示所有工具调用步骤
- AI响应包含所有请求的信息
- 所有工具调用状态为成功

---

### 测试用例 5.2: 多轮对话历史维护

**测试场景**: 验证多轮对话中的上下文理解

**测试步骤**:
1. 第1轮：发送 "现在有多少个班级？"
2. 第2轮：发送 "那学生总数呢？"（依赖上下文）
3. 第3轮：发送 "平均每个班级有多少学生？"（依赖前两轮结果）
4. 验证对话历史包含所有消息
5. 验证AI能理解上下文并给出正确答案

**期望结果**:
- 至少有 3 轮对话（6 条消息）
- AI能理解"那"、"平均"等上下文引用
- 第3轮响应包含计算结果（数字）
- 对话历史正确维护

---

### 测试用例 5.3: shouldContinue 判断逻辑验证

**测试场景**: 验证工具调用的继续/停止判断机制

**测试步骤**:
1. 监听控制台日志
2. 发送复杂分析请求："帮我分析一下幼儿园的整体运营情况，包括学生人数、班级数量、教师配比和最近的活动情况"
3. 等待多轮工具调用完成
4. 分析控制台中的 `shouldContinue` 判断日志
5. 验证工具调用在适当时机停止

**期望结果**:
- 执行至少 3 个工具调用
- 控制台有 `shouldContinue` 判断日志
- 最后一个工具调用状态为成功
- 工具调用正常结束（不是超时或错误）

---

### 测试用例 5.4: 工具调用循环机制 - 最大轮数限制

**测试场景**: 验证工具调用不会无限循环

**测试步骤**:
1. 发送可能触发多轮调用的复杂请求
2. 等待工具调用完成
3. 统计工具调用次数
4. 验证次数在合理范围内

**期望结果**:
- 工具调用次数 ≤ 10（最大轮数限制）
- 工具调用次数 ≥ 1（至少执行一次）
- 没有错误提示
- 系统正常结束

---

### 测试用例 5.5: 多轮工具调用 - 工具结果传递

**测试场景**: 验证前一个工具的结果能传递给后续工具

**测试步骤**:
1. 监听 API 调用
2. 发送需要工具结果传递的请求："统计一下今年总共举办了多少场活动，其中有多少学生参与了"
3. 分析 API 调用次数
4. 验证响应包含综合结果

**期望结果**:
- 至少有 2 次 API 调用
- AI 响应包含统计数字
- 响应同时包含"活动"和"学生"信息
- 结果是综合多个工具的输出

---

### 测试用例 5.6: 多轮工具调用 - 右侧面板状态更新

**测试场景**: 验证右侧工具调用面板实时更新

**测试步骤**:
1. 发送多步骤分析请求
2. 监控右侧面板状态变化
3. 记录每秒的工具调用数量和状态
4. 验证面板正确显示所有工具

**期望结果**:
- 右侧面板立即显示
- 工具调用状态实时更新
- 所有工具都有状态图标
- 面板显示完整的工具调用历史

---

### 测试用例 5.7: 多轮工具调用 - 错误处理和恢复

**测试场景**: 验证工具调用失败后系统能恢复

**测试步骤**:
1. 发送可能触发错误的请求
2. 等待处理完成
3. 检查错误指示器
4. 验证系统仍可继续使用

**期望结果**:
- 检测到错误指示器（如果有错误）
- AI 仍能响应
- 输入框仍可用
- 系统没有崩溃

---

### 测试用例 5.8: 多轮工具调用 - 并发工具执行

**测试场景**: 验证能否并发执行多个工具

**测试步骤**:
1. 发送可能触发并发执行的请求："同时查询学生总数、教师总数、班级总数和活动总数"
2. 记录工具调用出现的时间线
3. 分析是否有工具同时执行
4. 验证所有结果都包含在响应中

**期望结果**:
- 最多同时显示至少 3 个工具调用
- 执行至少 4 个工具
- 响应包含所有统计结果（学生、教师、班级、活动）
- 并发执行不会导致错误

---

## 🎯 核心验证点

### 1. 多轮循环机制

**验证内容**:
- ✅ 前端能否发起多轮工具调用
- ✅ 每轮工具调用结果能否传递给下一轮
- ✅ 循环是否正常结束

**验证方法**:
- 测试用例 5.1: 验证基本多轮流程
- 测试用例 5.4: 验证循环控制
- 测试用例 5.5: 验证结果传递

---

### 2. 对话历史维护

**验证内容**:
- ✅ 用户消息是否正确保存
- ✅ AI 响应是否正确保存
- ✅ 工具调用结果是否包含在历史中
- ✅ 上下文是否正确传递

**验证方法**:
- 测试用例 5.2: 验证上下文理解
- 测试用例 5.6: 验证历史显示

---

### 3. shouldContinue 判断逻辑

**验证内容**:
- ✅ 能否正确判断是否需要继续调用工具
- ✅ 判断逻辑是否合理
- ✅ 是否有相关日志输出

**验证方法**:
- 测试用例 5.3: 分析控制台日志
- 测试用例 5.4: 验证停止条件

---

### 4. 右侧面板展示

**验证内容**:
- ✅ 工具调用步骤是否正确显示
- ✅ 状态更新是否实时
- ✅ 历史工具调用是否保留

**验证方法**:
- 测试用例 5.1: 验证基本显示
- 测试用例 5.6: 验证状态更新

---

## 🔧 测试环境要求

### 前端要求
- ✅ AI 助手组件已集成
- ✅ 右侧工具调用面板已实现
- ✅ 多轮工具调用 composable 已实现
- ✅ 工具调用状态显示已实现

### 后端要求
- ✅ 统一智能中心 API 可用
- ✅ 工具注册系统正常
- ✅ 数据库查询工具可用
- ✅ 流式响应支持

### 数据要求
- ✅ 数据库有测试数据（班级、学生、活动）
- ✅ 至少 3 个班级
- ✅ 至少 10 个学生
- ✅ 至少 5 个活动记录

---

## 📊 测试执行

### 运行单个测试文件

```bash
# 运行所有多轮工具调用测试
npx playwright test tests/ai-assistant/05-multi-round-tool-calling.spec.ts

# 运行特定测试用例
npx playwright test tests/ai-assistant/05-multi-round-tool-calling.spec.ts -g "测试用例5.1"

# 带界面运行（便于调试）
npx playwright test tests/ai-assistant/05-multi-round-tool-calling.spec.ts --ui

# 调试模式
npx playwright test tests/ai-assistant/05-multi-round-tool-calling.spec.ts --debug
```

### 查看测试报告

```bash
# 生成 HTML 报告
npx playwright show-report

# 查看截图
ls test-results/task5-multi-round-*.png
```

---

## ✅ 验收标准

测试通过需满足以下条件：

### 必须通过的测试
- ✅ 测试用例 5.1: 多轮工具调用基本流程
- ✅ 测试用例 5.2: 对话历史维护
- ✅ 测试用例 5.3: shouldContinue 判断逻辑

### 建议通过的测试
- ✅ 测试用例 5.4: 最大轮数限制
- ✅ 测试用例 5.5: 工具结果传递
- ✅ 测试用例 5.6: 右侧面板状态更新

### 可选通过的测试
- ⭕ 测试用例 5.7: 错误处理（可能因测试数据而失败）
- ⭕ 测试用例 5.8: 并发工具执行（取决于后端实现）

---

## 🐛 已知问题和限制

### 1. 时间依赖问题
- 使用 `waitForTimeout` 可能在慢速环境下失败
- 建议：使用 `waitForSelector` 或事件监听

### 2. 测试数据依赖
- 测试依赖数据库中的实际数据
- 建议：添加测试数据初始化脚本

### 3. 异步状态检测
- 工具调用状态可能快速变化
- 建议：增加重试机制

### 4. 控制台日志监听
- 某些浏览器可能不输出完整日志
- 建议：使用其他方式验证内部逻辑

---

## 📝 后续改进计划

### 短期改进（1-2周）
1. ✅ 添加测试数据初始化脚本
2. ✅ 优化等待策略，减少 `waitForTimeout`
3. ✅ 添加更详细的错误信息输出
4. ✅ 增加测试覆盖率报告

### 中期改进（1个月）
1. ⭕ 添加性能测试（响应时间、工具调用延迟）
2. ⭕ 添加压力测试（连续多次调用）
3. ⭕ 添加并发测试（多个用户同时使用）
4. ⭕ 添加回归测试（自动化每日运行）

### 长期改进（3个月）
1. ⭕ 集成到 CI/CD 流程
2. ⭕ 添加测试覆盖率要求
3. ⭕ 建立测试质量门禁
4. ⭕ 自动生成测试报告

---

## 🔗 相关文档

- [AI助手多轮工具调用实施方案](./AI-Assistant-Multi-Round-Tool-Calling-Plan.md)
- [AI工具调用测试架构说明](../AI工具调用测试架构说明.md)
- [AI工具调用测试文档](./AI工具调用测试文档.md)
- [AI助手三栏布局补充测试用例](./AI助手三栏布局补充测试用例.md)

---

## 👥 测试负责人

**创建者**: AI Assistant  
**审核者**: 待定  
**执行者**: QA团队

---

## 📅 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| 1.0.0 | 2025-11-05 | 初始版本，创建8个测试用例 | AI Assistant |

---

**状态**: ✅ 测试文件已完成，等待执行


