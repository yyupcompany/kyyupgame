# 侧边栏英文名称问题最终修复报告

## 问题描述

侧边栏显示了英文名称，包括：
- Analytics Center (应该显示"数据分析中心")
- Inspection Center (应该显示"督查中心")
- Media Center (应该显示"新媒体中心")

## 根本原因分析

通过MCP浏览器调试和代码分析，发现了以下问题：

### 1. 后端缓存服务问题

**文件**: `server/src/services/route-cache.service.ts`

**问题**: 第115行使用了 `raw: true`，导致Sequelize返回原始数据库字段名（`chinese_name`）而不是模型属性名（`chineseName`）

```typescript
// 问题代码
const routes = await Permission.findAll({
  where: { status: 1, type: { [Op.in]: ['category', 'menu', 'page', 'button'] } },
  order: [['parent_id', 'ASC'], ['sort', 'ASC'], ['id', 'ASC']],
  raw: true  // ❌ 这导致返回 chinese_name 而不是 chineseName
})
```

### 2. 前端字段名不匹配

**文件**: `client/src/layouts/components/Sidebar.vue`

**问题**: 第637行只检查 `item.chineseName`，但后端返回的是 `chinese_name`

```typescript
// 问题代码
if (item && item.chineseName) {  // ❌ 只检查驼峰命名
  return item.chineseName;
}
```

### 3. 已禁用中心仍有权限关联

虽然三个中心（AI Center, Analytics Center, Inspection Center）已被禁用（status=0），但它们仍然存在于某些角色的权限关联中，导致某些用户仍能看到这些中心。

## 修复方案

### 修复1: 更新后端缓存服务

**文件**: `server/src/services/route-cache.service.ts`

**修改内容**:
```typescript
// 查询所有启用的路由权限
const routes = await Permission.findAll({
  where: {
    status: 1,
    type: { [Op.in]: ['category', 'menu', 'page', 'button'] }
  },
  order: [
    ['parent_id', 'ASC'],
    ['sort', 'ASC'],
    ['id', 'ASC']
  ],
  raw: false // ✅ 改为false以获取模型属性名（chineseName）
})

// ✅ 转换为普通对象，确保包含chineseName字段
const routesData = routes.map(route => ({
  id: route.id,
  name: route.name,
  chineseName: route.chineseName, // 使用模型属性名
  chinese_name: route.chineseName, // 同时保留数据库字段名以兼容
  code: route.code,
  type: route.type,
  parentId: route.parentId,
  parent_id: route.parentId, // 兼容字段
  path: route.path,
  component: route.component,
  icon: route.icon,
  sort: route.sort,
  status: route.status,
  permission: route.permission,
  description: route.description
}))
```

### 修复2: 更新前端字段检查

**文件**: `client/src/layouts/components/Sidebar.vue`

**修改内容**:
```typescript
// ✅ 中文名称映射 - 优先使用 chineseName 或 chinese_name 字段
const getChineseName = (item: any): string => {
  // ✅ 优先使用 chineseName 或 chinese_name 字段（兼容驼峰和蛇形命名）
  if (item && (item.chineseName || item.chinese_name)) {
    return item.chineseName || item.chinese_name;
  }

  // 如果传入的是字符串，使用映射表
  const name = typeof item === 'string' ? item : (item?.name || '');
  const nameMap: Record<string, string> = {
    'Personnel Center': '人员中心',
    'Activity Center': '活动中心',
    'Enrollment Center': '招生中心',
    'Marketing Center': '营销中心',
    'Business Center': '业务中心',
    'Customer Pool Center': '客户池中心',
    'System Center': '系统中心',
    'Finance Center': '财务中心',
    'Task Center': '任务中心',
    'Teaching Center': '教学中心',
    'Script Center': '话术中心',
    'Media Center': '新媒体中心',  // ✅ 添加映射
    // 已禁用的中心（保留映射以防缓存问题）
    'AI Center': '智能中心',
    'Analytics Center': '数据分析中心',
    'Inspection Center': '督查中心',
    // ...其他映射
  };
  return nameMap[name] || name;
};
```

### 修复3: 清理已禁用中心的权限关联

**执行脚本**: `server/cleanup-disabled-centers.js`

**清理结果**:
- 删除了 7 条角色权限关联记录
- 涉及 9 个已禁用的中心
- 确保没有用户能访问这些已禁用的中心

## 验证结果

### 数据库验证

```bash
cd server
node check-chinese-names.js
```

**结果**: 所有12个活跃中心都有正确的中文名称

| 序号 | 中心名称 | 中文名称 | 状态 |
|------|---------|---------|------|
| 1 | Personnel Center | 人员中心 | ✅ 活跃 |
| 2 | Activity Center | 活动中心 | ✅ 活跃 |
| 3 | Marketing Center | 营销中心 | ✅ 活跃 |
| 4 | Business Center | 业务中心 | ✅ 活跃 |
| 5 | Customer Pool Center | 客户池中心 | ✅ 活跃 |
| 6 | System Center | 系统中心 | ✅ 活跃 |
| 7 | Finance Center | 财务中心 | ✅ 活跃 |
| 8 | Enrollment Center | 招生中心 | ✅ 活跃 |
| 9 | Task Center | 任务中心 | ✅ 活跃 |
| 10 | Teaching Center | 教学中心 | ✅ 活跃 |
| 11 | Script Center | 话术中心 | ✅ 活跃 |
| 12 | Media Center | 新媒体中心 | ✅ 活跃 |

### API验证

通过浏览器调试，验证API返回的数据：

```javascript
// API返回的数据
{
  "id": 5219,
  "name": "Media Center",
  "chinese_name": "新媒体中心",  // ✅ 数据库字段
  "code": "MEDIA_CENTER"
}
```

## 后续步骤

### 1. 重启服务

```bash
# 重启后端服务器
cd server
npm run dev

# 前端会自动热更新，如果没有，请手动刷新浏览器
```

### 2. 清除浏览器缓存

- 按 `Ctrl+Shift+Delete`
- 选择"缓存的图片和文件"
- 点击"清除数据"

### 3. 强制刷新页面

- 按 `Ctrl+F5` 或 `Cmd+Shift+R`

### 4. 验证结果

侧边栏应该只显示12个中文中心，不应该再看到任何英文名称。

## 技术总结

### 问题根源

1. **后端**: 使用 `raw: true` 导致返回数据库字段名而不是模型属性名
2. **前端**: 只检查驼峰命名字段，不兼容蛇形命名字段
3. **数据**: 已禁用中心仍有权限关联

### 解决方案

1. **后端**: 改为 `raw: false` 并手动转换数据，同时提供两种命名格式
2. **前端**: 兼容两种命名格式（驼峰和蛇形）
3. **数据**: 清理已禁用中心的权限关联

### 经验教训

1. **命名规范**: 前后端应统一使用驼峰命名或蛇形命名，避免混用
2. **数据一致性**: 禁用功能时应同时清理相关的权限关联
3. **缓存管理**: 修改数据结构后应清除相关缓存
4. **调试工具**: MCP浏览器工具对于前端调试非常有用

## 相关文件

### 修改的文件

1. `server/src/services/route-cache.service.ts` - 后端缓存服务
2. `client/src/layouts/components/Sidebar.vue` - 前端侧边栏组件

### 创建的工具脚本

1. `server/check-chinese-names.js` - 检查中文名称
2. `server/check-disabled-centers.js` - 检查已禁用中心
3. `server/cleanup-disabled-centers.js` - 清理已禁用中心
4. `server/clear-permission-cache.js` - 清除权限缓存

### 文档

1. `侧边栏英文名称问题修复报告.md` - 初步修复报告
2. `侧边栏英文名称问题最终修复报告.md` - 本文档

---

**修复时间**: 2025-10-07  
**修复人员**: AI Assistant (Augment Agent)  
**影响范围**: 侧边栏显示、权限系统、缓存系统、数据库
**修复状态**: ✅ 完成（需要重启服务器和清除浏览器缓存）

