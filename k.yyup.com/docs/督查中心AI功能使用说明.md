# 督查中心AI功能使用说明

## 📋 功能概述

督查中心集成了AI智能分析功能,通过AIBridge服务统一调用大模型,提供智能化的检查计划分析和文档辅助功能。

**核心特点**:
- ✅ 使用AIBridge统一调用,无硬编码
- ✅ 从数据库动态选择AI模型
- ✅ 支持多种AI模型提供商
- ✅ 智能分析检查计划合理性
- ✅ AI辅助文档填写和审核

---

## 🎯 AI功能列表

### 1. AI智能分析 (检查计划分析)

**功能描述**: 分析年度检查计划的合理性,提供优化建议

**使用方法**:
1. 进入督查中心页面 (`http://localhost:5173/centers/inspection`)
2. 点击"AI智能分析"按钮
3. 等待AI分析完成(约15-30秒)
4. 查看分析报告对话框

**分析维度**:
- 📊 **时间分布合理性** - 检查计划在全年的分布是否均衡
- 🔄 **检查频率适当性** - 评估各类检查的频率是否合理
- 💼 **资源配置优化** - 分析人力和时间资源的配置
- ⚠️ **风险识别** - 识别可能的时间冲突和资源瓶颈
- 💡 **改进建议** - 提供具体的优化建议

**API端点**: `POST /api/inspection-ai/plan-analysis`

**请求参数**:
```json
{
  "year": 2025,
  "plans": [...]  // 检查计划数组
}
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "analysis": {
      "timeDistribution": { "score": 85, "description": "时间分布评分说明" },
      "frequency": { "score": 90, "description": "频率适当性评分说明" },
      "resourceAllocation": { "score": 80, "description": "资源配置评分说明" },
      "risks": ["风险1", "风险2"],
      "recommendations": ["建议1", "建议2"],
      "summary": "总体分析摘要"
    },
    "statistics": {...},
    "modelUsed": "豆包Flash-1.6（快速推理版）",
    "planCount": 49
  },
  "message": "AI分析完成"
}
```

---

### 2. AI辅助填写 (文档分析)

**功能描述**: 分析文档完整性和质量,提供填写建议

**使用方法**:
1. 在文档管理中心找到需要分析的文档
2. 点击文档行的"AI辅助"按钮
3. 等待AI分析完成(约10-20秒)
4. 查看分析结果对话框

**分析维度**:
- ✅ **完整性评分** - 文档内容的完整程度
- 📝 **质量评分** - 文档内容的质量水平
- 📋 **规范性评分** - 文档格式的规范程度
- 🔍 **缺失内容** - 识别未填写的必填项
- 💡 **填写建议** - 提供具体的填写指导
- ⚠️ **注意事项** - 提醒需要注意的问题

**API端点**: `POST /api/inspection-ai/document-analysis`

**请求参数**:
```json
{
  "documentId": "doc-123",
  "documentTitle": "年度安全检查表",
  "templateType": "安全检查",
  "currentContent": "..."
}
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "analysis": {
      "completeness": { "score": 75, "description": "完整性评分说明" },
      "quality": { "score": 80, "description": "质量评分说明" },
      "compliance": { "score": 85, "description": "规范性评分说明" },
      "missingContent": ["缺失项1", "缺失项2"],
      "suggestions": ["建议1", "建议2"],
      "warnings": ["警告1", "警告2"],
      "summary": "总体分析摘要"
    },
    "modelUsed": "豆包Flash-1.6（快速推理版）",
    "documentInfo": {...}
  },
  "message": "AI分析完成"
}
```

---

## 🔧 技术架构

### AI调用流程

```
前端请求 → 后端控制器 → ModelSelector选择模型 → AIBridge调用 → AI模型 → 返回结果
```

### 核心组件

1. **ModelSelectorService** (`server/src/services/ai/model-selector.service.ts`)
   - 从数据库智能选择AI模型
   - 支持多种选择策略(默认/优先级/成本优化/性能/负载均衡/故障转移)
   - 自动缓存模型配置

2. **AIBridgeService** (`server/src/services/ai/bridge/ai-bridge.service.ts`)
   - 统一的AI调用接口
   - 自动重试机制
   - 使用量统计
   - 流式响应支持
   - 错误处理

3. **InspectionAIController** (`server/src/controllers/inspection-ai.controller.ts`)
   - 检查计划AI分析
   - 文档AI分析
   - 数据预处理和后处理

### 数据库配置

所有AI模型配置存储在 `ai_model_config` 表中:

| 字段 | 说明 |
|------|------|
| name | 模型名称 |
| display_name | 显示名称 |
| provider | 提供商 |
| model_type | 模型类型(text/image/embedding) |
| endpoint_url | API端点URL |
| api_key | API密钥 |
| model_parameters | 模型参数(JSON) |
| status | 状态(active/inactive) |
| is_default | 是否默认模型 |

---

## 📊 测试结果

### 测试环境
- **前端**: http://localhost:5173 ✅ 运行中
- **后端**: http://localhost:3000 ✅ 运行中
- **测试时间**: 2025-10-13
- **测试数据**: 49个检查计划, 26个文档实例

### 测试结果总结

| 测试项 | 结果 | 详情 |
|--------|------|------|
| AI模型选择 | ✅ 通过 | 成功从数据库选择"豆包Flash-1.6"模型 |
| API调用 | ✅ 通过 | 后端成功调用AI API,耗时15-30秒 |
| 数据处理 | ✅ 通过 | 成功统计49个计划的状态/分类/月度分布 |
| 响应格式 | ✅ 通过 | 返回正确的JSON格式 |
| 前端显示 | ⚠️ 问题 | 对话框显示数据为空或0 |
| 使用量统计 | ⚠️ 警告 | 数据库缺少total_tokens字段,不影响功能 |

### 发现的问题

#### 1. 前端数据显示问题 ⚠️

**现象**: AI分析对话框中显示的数据都是0或空
- 使用模型: "undefined"
- 所有评分: "0"
- 优化建议: 空
- 风险提示: 空
- 总结: 空

**原因分析**:
- 后端返回的数据结构正确
- 前端数据转换逻辑可能有问题
- 需要检查前端代码中的数据提取路径

**后端日志**:
```
✅ [原生HTTP] 请求完成，状态码: 200
[AI调用-原生HTTP] 第 1 次调用成功，耗时: 15381ms
✅ AI分析完成
📝 POST /plan-analysis - 200 - 15779ms
```

**前端日志**:
```
🔍 AI分析响应: {success: true, data: Object, message: AI分析完成}
```

**建议修复**:
1. 添加更详细的console.log查看完整响应数据
2. 检查前端数据转换逻辑
3. 验证AI返回的JSON格式是否符合预期

#### 2. 数据库字段缺失 ⚠️

**现象**: `ai_model_usage` 表缺少 `total_tokens` 字段

**错误信息**:
```
[使用量统计] 记录失败: Error
Unknown column 'total_tokens' in 'field list'
```

**影响**: 不影响AI功能,只影响使用量统计

**建议修复**: 运行数据库迁移添加缺失字段

---

## 💡 使用建议

### 最佳实践

1. **定期分析检查计划**
   - 建议每季度使用AI分析功能检查年度计划
   - 根据AI建议优化检查时间分布
   - 及时调整资源配置

2. **文档填写前使用AI辅助**
   - 在开始填写文档前先使用AI分析
   - 根据AI建议准备相关材料
   - 提高文档填写质量和效率

3. **关注AI建议的风险提示**
   - 重点关注时间冲突风险
   - 提前规划资源分配
   - 避免检查计划过于集中

### 注意事项

1. **AI分析耗时**
   - 检查计划分析: 15-30秒
   - 文档分析: 10-20秒
   - 请耐心等待,不要重复点击

2. **网络要求**
   - 需要稳定的网络连接
   - 超时时间设置为60秒
   - 如果超时请重试

3. **数据准确性**
   - AI分析基于现有数据
   - 建议人工复核AI建议
   - 结合实际情况调整

---

## 🔍 故障排除

### 常见问题

**Q1: AI分析按钮点击后没有反应?**

A: 检查以下几点:
1. 确认后端服务正常运行(http://localhost:3000)
2. 检查浏览器控制台是否有错误
3. 确认网络连接正常
4. 尝试刷新页面后重试

**Q2: AI分析一直加载中?**

A: 可能原因:
1. AI模型响应较慢(正常15-30秒)
2. 网络连接不稳定
3. 后端服务异常

解决方法:
1. 等待60秒超时
2. 检查后端日志
3. 重新点击分析按钮

**Q3: 分析结果显示为空?**

A: 这是当前已知问题,正在修复中。后端数据正常,前端显示逻辑需要调整。

**Q4: 使用量统计失败?**

A: 这是数据库字段缺失导致的,不影响AI功能使用,只影响统计功能。

---

## 📞 技术支持

如有问题,请联系技术支持团队或查看:
- 后端日志: `server/logs/`
- 前端控制台: 浏览器开发者工具
- API文档: http://localhost:3000/api-docs

---

**文档版本**: v1.0  
**最后更新**: 2025-10-13  
**维护人员**: AI开发团队

