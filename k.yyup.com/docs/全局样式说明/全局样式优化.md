## 全局样式优化与统一规范（v1）

> 目标：消除硬编码色值/渐变/阴影与主题类选择器，统一接入 Element Plus 变量与设计令牌；实现浅/深色一致的视觉与一致的维护方式。

---

### 1. 统一原则
- 单一主题通道：仅使用 `html[data-theme]`（不再使用 `.dark` / `html.dark` / 自定义主题类）
- 变量优先：使用 Element Plus 的 `--el-*` 变量与项目级设计令牌；禁止硬编码色值/渐变/阴影
- 等价替换优先：先做“不会改变视觉”的安全替换，再处理彩色渐变/彩色阴影等视觉性较强的块
- 渐进式提交：每页/每块小步提交，便于回滚和定位问题

---

### 2. 基础变量体系（首选）
- 背景/容器：
  - `var(--el-bg-color-page)` 页面背景
  - `var(--el-bg-color)` 卡片/容器背景
  - `var(--el-fill-color)` 浅填充、`var(--el-fill-color-light)` 更浅填充
- 文本：
  - `var(--el-text-color-primary)` 主文本
  - `var(--el-text-color-regular)` 正常文本
  - `var(--el-text-color-secondary)` 次文本
- 边框/分割线：
  - `var(--el-border-color)`、`var(--el-border-color-light)`
- 阴影：
  - `var(--el-box-shadow-light)` 统一轻阴影
- 品牌/状态色：
  - `var(--el-color-primary)` 及 `-dark-2`/`-light-7` 等变体
  - 语义色：`--el-color-success|warning|danger|info`
- 项目级渐变（示例，若存在）：
  - `var(--gradient-primary)`、`var(--gradient-purple)` 等（不存在时请补充到全局样式）

> 禁止使用 `var(--el-*, <fallback>)` 的回退写法；统一只写变量名，由主题/令牌全局负责值来源。

---

### 3. 迁移模式（Before → After）
1) 线性渐变
- `background: linear-gradient(135deg, #667eea, #764ba2);`
- → `background: var(--gradient-purple);`

2) 纯色/灰阶背景
- `background: #ffffff;` / `rgba(248,250,252,.7)`
- → `background: var(--el-bg-color);` / `var(--el-fill-color-light);`

3) 文本色
- `color: #333;` / `rgba(255,255,255,.9)`
- → `color: var(--el-text-color-primary);`

4) 边框色
- `border: 1px solid #e5e7eb;` / `rgba(71,85,105,.3)`
- → `border: 1px solid var(--el-border-color);`

5) 阴影
- `box-shadow: 0 4px 16px rgba(0,0,0,.08/.3);`
- → `box-shadow: var(--el-box-shadow-light);`

6) 主题类选择器
- `:global(.theme-dark) { ... }` / `.dark { ... }` / `html.dark { ... }`
- → 删除块；将其中色值/阴影替换为 `--el-*` 变量，保持在同一规则内生效

7) 颜色半透明（强调/hover）
- `border-color: rgba(99,102,241,.4);`
- → `border-color: color-mix(in oklab, var(--el-color-primary) 30%, transparent);`

8) 变量回退写法
- `color: var(--el-text-color-primary, #333);`
- → `color: var(--el-text-color-primary);`

9) 滚动条/细节色块（深色）
- `background: rgba(71,85,105,.5);`
- → `background: var(--el-fill-color-light);`

10) 白色描边/分隔（图表叠加）
- JS 场景采用 CSS 变量读取：见“运行时颜色桥接”

---

### 4. 运行时颜色桥接（ECharts/Canvas 等）
在 JS 里直接写 `'#xxx'`/`'rgba(...)'` 会导致主题切换失效。统一使用 `utils/color-tokens.ts` 内的桥接函数读取 CSS 变量。

示例函数（摘）：
- `getCssVarValue(varName: string, fallback = '')`
- `getPrimaryColor()`、`getSuccessColor()`、`getInfoColor()`、`getWarningColor()`、`getDangerColor()`
- `primaryRgba(alpha: number)`、`makeGradientStops(start, end)`、`purpleGradientStops()`

ECharts 用法示例：
```ts
import { getSuccessColor, getInfoColor, primaryRgba, getCssVarValue } from '@/utils/color-tokens'

const option = {
  tooltip: {
    backgroundColor: getCssVarValue('--el-fill-color', 'rgba(50,50,50,0.9)')
  },
  series: [{
    itemStyle: { color: getSuccessColor(), borderColor: getCssVarValue('--el-fill-color-blank', '#fff') },
    areaStyle: { color: primaryRgba(0.2) }
  }]
}
```

---

### 5. 落地流程与提交策略
1) 审计（搜索与统计）
```bash
# 硬编码色值/渐变
rg -n "#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})|rgba\(|linear-gradient\(" client/src
# 主题类/回退写法
rg -n "html\\.dark|\\.dark\\s*\{|:global\(\.theme-dark\)|var\(--el-[^)]*," client/src
```

2) 修改顺序（建议）
- 容器背景/边框/阴影（等价、安全）→ 文本/细节 → 渐变/彩色阴影（谨慎）
- 先移除主题类块，将其内部色值等价改成变量

3) 提交策略
- 每个页面/逻辑块单独提交，提交信息描述“做了什么 + 到什么变量”
- 示例：`style: unify dark theme blocks in centers/TeachingCenter.vue to --el-* tokens`

4) 本地校验
```bash
npm run lint
npm run typecheck
# 可选：npm run start:frontend，手动验证浅/深色切换、hover/focus/active 状态
```

---

### 6. 规范与禁用项
- 禁止：硬编码 `#hex`、`rgba(...)`、`linear-gradient(...)`（应改用变量/令牌）
- 禁止：`:global(.theme-dark) / .dark / html.dark` 主题类块（统一变量驱动）
- 禁止：`var(--el-*, <fallback>)` 回退写法
- 禁止：过度使用 `!important`（保留极少数必要场景）
- 必须：优先使用 `--el-*` 与项目级 `--gradient-*` / 语义色函数
- 必须：JS 场景使用 `utils/color-tokens.ts` 桥接读取 CSS 变量

---

### 7. 视觉验证清单（最小走查）
- 浅/深色主题切换：卡片/标题/表格/分割线/背景是否一致
- 状态色（成功/信息/警告/危险）：卡片、标签、图表系列是否与语义色一致
- 交互态：按钮、卡片 hover/focus/active 的边框与阴影是否统一
- 图表：tooltip 背景、系列/面积/强调的颜色是否随主题变更

---

### 8. 常见问题与处理
- 边框不明显：使用 `var(--el-border-color)` 或 `color-mix(... var(--el-color-primary) 30% ...)` 加强
- 阴影过重：改为 `var(--el-box-shadow-light)`
- 图表白边/对比：用 `getCssVarValue('--el-fill-color-blank', '#fff')` 读取变量白色
- 细节深色滚动条：`background: var(--el-fill-color-light)` 替换 `rgba(71,85,105,*)`

---

### 9. 附：常用变量速查
- 背景：`--el-bg-color-page` / `--el-bg-color` / `--el-fill-color(-light)`
- 文本：`--el-text-color-primary|regular|secondary`
- 边框：`--el-border-color(-light)`
- 阴影：`--el-box-shadow-light`
- 品牌/语义：`--el-color-primary|success|warning|danger|info`
- 渐变（项目级）：`--gradient-primary|purple|success|warning|danger|info`
- JS 桥接：`getCssVarValue`, `getPrimaryColor`, `getSuccessColor`, `getInfoColor`, `getWarningColor`, `getDangerColor`, `primaryRgba`

---

### 10. 适用范围与例外
- 适用：在用页面与组件（中心页、管理页、业务页面等）
- 例外：已下线/不再使用的页面可跳过迁移（避免无效改动）

如需扩展本规范（例如新增渐变令牌、增加低/高对比主题），请在同目录补充“设计令牌扩展.md”，并在此文档顶部更新版本与变更记录。

