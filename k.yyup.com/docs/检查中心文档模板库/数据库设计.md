# æ£€æŸ¥ä¸­å¿ƒæ–‡æ¡£æ¨¡æ¿ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### 1. æ–‡æ¡£æ¨¡æ¿è¡¨ (document_templates)

å­˜å‚¨73ä¸ªæ–‡æ¡£æ¨¡æ¿çš„å…ƒæ•°æ®å’Œå†…å®¹ã€‚

```sql
CREATE TABLE document_templates (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- åŸºæœ¬ä¿¡æ¯
  code VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ¨¡æ¿ç¼–å·ï¼Œå¦‚ï¼š01-01',
  name VARCHAR(200) NOT NULL COMMENT 'æ¨¡æ¿åç§°',
  category VARCHAR(50) NOT NULL COMMENT 'ç±»åˆ«ï¼šannual/special/routineç­‰',
  sub_category VARCHAR(50) COMMENT 'å­ç±»åˆ«',
  
  -- æ¨¡æ¿å†…å®¹
  content_type ENUM('markdown', 'html', 'json') DEFAULT 'markdown',
  template_content LONGTEXT NOT NULL COMMENT 'æ¨¡æ¿å†…å®¹',
  
  -- å˜é‡é…ç½®
  variables JSON COMMENT 'å˜é‡å®šä¹‰ï¼Œå¦‚ï¼š["kindergarten_name", "inspection_date"]',
  default_values JSON COMMENT 'é»˜è®¤å€¼é…ç½®',
  
  -- ä½¿ç”¨é¢‘ç‡
  frequency ENUM('daily', 'weekly', 'monthly', 'quarterly', 'yearly', 'as_needed') COMMENT 'ä½¿ç”¨é¢‘ç‡',
  priority ENUM('required', 'recommended', 'optional') DEFAULT 'optional' COMMENT 'é‡è¦ç¨‹åº¦',
  
  -- å…³è”ä¿¡æ¯
  inspection_type_ids JSON COMMENT 'å…³è”çš„æ£€æŸ¥ç±»å‹IDæ•°ç»„',
  related_template_ids JSON COMMENT 'ç›¸å…³æ¨¡æ¿IDæ•°ç»„',
  
  -- æ–‡æ¡£å±æ€§
  is_detailed BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºè¯¦ç»†æ¨¡æ¿',
  line_count INT COMMENT 'æ¨¡æ¿è¡Œæ•°',
  estimated_fill_time INT COMMENT 'é¢„è®¡å¡«å†™æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰',
  
  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT TRUE,
  version VARCHAR(20) DEFAULT '1.0',
  
  -- ç»Ÿè®¡
  use_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
  last_used_at DATETIME COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
  
  -- å®¡è®¡å­—æ®µ
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_category (category),
  INDEX idx_frequency (frequency),
  INDEX idx_priority (priority),
  INDEX idx_code (code),
  FULLTEXT INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡æ¡£æ¨¡æ¿è¡¨';
```

### 2. æ–‡æ¡£å®ä¾‹è¡¨ (document_instances)

å­˜å‚¨åŸºäºæ¨¡æ¿åˆ›å»ºçš„å…·ä½“æ–‡æ¡£å®ä¾‹ã€‚

```sql
CREATE TABLE document_instances (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  template_id INT NOT NULL COMMENT 'æ¨¡æ¿ID',
  inspection_plan_id INT COMMENT 'å…³è”çš„æ£€æŸ¥è®¡åˆ’ID',
  kindergarten_id INT NOT NULL COMMENT 'å¹¼å„¿å›­ID',
  
  -- æ–‡æ¡£ä¿¡æ¯
  title VARCHAR(200) NOT NULL COMMENT 'æ–‡æ¡£æ ‡é¢˜',
  content LONGTEXT NOT NULL COMMENT 'æ–‡æ¡£å†…å®¹',
  filled_variables JSON COMMENT 'å·²å¡«å……çš„å˜é‡å€¼',
  
  -- çŠ¶æ€
  status ENUM('draft', 'filling', 'review', 'completed', 'archived') DEFAULT 'draft',
  progress INT DEFAULT 0 COMMENT 'å¡«å†™è¿›åº¦ï¼ˆ0-100ï¼‰',
  
  -- åä½œä¿¡æ¯
  owner_id INT NOT NULL COMMENT 'æ–‡æ¡£æ‰€æœ‰è€…',
  assigned_to INT COMMENT 'å½“å‰å¡«å†™äºº',
  reviewers JSON COMMENT 'å®¡æ ¸äººIDæ•°ç»„',
  
  -- ç‰ˆæœ¬æ§åˆ¶
  version INT DEFAULT 1,
  parent_version_id INT COMMENT 'çˆ¶ç‰ˆæœ¬ID',
  
  -- æ—¶é—´ä¿¡æ¯
  started_at DATETIME COMMENT 'å¼€å§‹å¡«å†™æ—¶é—´',
  submitted_at DATETIME COMMENT 'æäº¤æ—¶é—´',
  reviewed_at DATETIME COMMENT 'å®¡æ ¸æ—¶é—´',
  completed_at DATETIME COMMENT 'å®Œæˆæ—¶é—´',
  deadline DATETIME COMMENT 'æˆªæ­¢æ—¶é—´',
  
  -- æ–‡ä»¶ä¿¡æ¯
  file_path VARCHAR(500) COMMENT 'ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„',
  file_type VARCHAR(20) COMMENT 'æ–‡ä»¶ç±»å‹ï¼špdf/docx/xlsx',
  file_size INT COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  
  -- å®¡è®¡å­—æ®µ
  created_by INT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES document_templates(id),
  FOREIGN KEY (inspection_plan_id) REFERENCES inspection_plans(id),
  INDEX idx_status (status),
  INDEX idx_kindergarten (kindergarten_id),
  INDEX idx_owner (owner_id),
  INDEX idx_assigned (assigned_to)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡æ¡£å®ä¾‹è¡¨';
```

### 3. æ–‡æ¡£ç‰ˆæœ¬å†å²è¡¨ (document_versions)

å­˜å‚¨æ–‡æ¡£çš„å†å²ç‰ˆæœ¬ã€‚

```sql
CREATE TABLE document_versions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  document_instance_id INT NOT NULL,
  version INT NOT NULL,
  content LONGTEXT NOT NULL,
  filled_variables JSON,
  
  change_summary VARCHAR(500) COMMENT 'å˜æ›´è¯´æ˜',
  changed_by INT,
  changed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (document_instance_id) REFERENCES document_instances(id),
  INDEX idx_document (document_instance_id, version)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡æ¡£ç‰ˆæœ¬å†å²è¡¨';
```

### 4. ä»»åŠ¡æ¨¡æ¿è¡¨ (task_templates)

å­˜å‚¨æ£€æŸ¥ä»»åŠ¡çš„æ¨¡æ¿ã€‚

```sql
CREATE TABLE task_templates (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  name VARCHAR(200) NOT NULL COMMENT 'ä»»åŠ¡æ¨¡æ¿åç§°',
  inspection_type_id INT NOT NULL COMMENT 'æ£€æŸ¥ç±»å‹ID',
  description TEXT,
  
  -- ä»»åŠ¡é…ç½®
  tasks JSON NOT NULL COMMENT 'ä»»åŠ¡åˆ—è¡¨é…ç½®',
  
  is_active BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (inspection_type_id) REFERENCES inspection_types(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»»åŠ¡æ¨¡æ¿è¡¨';
```

### 5. æ–‡æ¡£ä»»åŠ¡è¡¨ (document_tasks)

å­˜å‚¨å…·ä½“çš„æ–‡æ¡£å¡«å†™ä»»åŠ¡ã€‚

```sql
CREATE TABLE document_tasks (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  document_instance_id INT NOT NULL,
  inspection_plan_id INT,
  parent_task_id INT COMMENT 'çˆ¶ä»»åŠ¡IDï¼Œç”¨äºä»»åŠ¡å±‚çº§',
  
  -- ä»»åŠ¡ä¿¡æ¯
  title VARCHAR(200) NOT NULL,
  description TEXT,
  task_type ENUM('fill', 'review', 'approve', 'submit') DEFAULT 'fill',
  
  -- åˆ†é…ä¿¡æ¯
  assigned_to INT NOT NULL COMMENT 'åˆ†é…ç»™è°',
  assigned_by INT COMMENT 'è°åˆ†é…çš„',
  assigned_at DATETIME,
  
  -- çŠ¶æ€
  status ENUM('pending', 'in_progress', 'review', 'completed', 'rejected') DEFAULT 'pending',
  progress INT DEFAULT 0,
  priority ENUM('high', 'medium', 'low') DEFAULT 'medium',
  
  -- æ—¶é—´
  start_date DATE,
  due_date DATE,
  completed_at DATETIME,
  
  -- ç»“æœ
  result TEXT COMMENT 'ä»»åŠ¡ç»“æœæˆ–å¤‡æ³¨',
  attachments JSON COMMENT 'é™„ä»¶åˆ—è¡¨',
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (document_instance_id) REFERENCES document_instances(id),
  FOREIGN KEY (assigned_to) REFERENCES users(id),
  INDEX idx_assigned (assigned_to, status),
  INDEX idx_due_date (due_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ–‡æ¡£ä»»åŠ¡è¡¨';
```

### 6. è¡¨å•æäº¤è¡¨ (form_submissions)

å­˜å‚¨è¡¨å•å¡«å†™çš„æäº¤æ•°æ®ã€‚

```sql
CREATE TABLE form_submissions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  template_id INT NOT NULL,
  document_instance_id INT,
  task_id INT,
  
  -- æäº¤ä¿¡æ¯
  submitted_by INT NOT NULL,
  submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- è¡¨å•æ•°æ®
  form_data JSON NOT NULL COMMENT 'è¡¨å•å¡«å†™æ•°æ®',
  
  -- çŠ¶æ€
  status ENUM('draft', 'submitted', 'approved', 'rejected') DEFAULT 'submitted',
  reviewed_by INT,
  reviewed_at DATETIME,
  review_comments TEXT,
  
  FOREIGN KEY (template_id) REFERENCES document_templates(id),
  FOREIGN KEY (submitted_by) REFERENCES users(id),
  INDEX idx_template (template_id),
  INDEX idx_submitted_by (submitted_by)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è¡¨å•æäº¤è¡¨';
```

### 7. æ•°æ®åˆ†æç»“æœè¡¨ (analysis_results)

å­˜å‚¨AIåˆ†æçš„ç»“æœã€‚

```sql
CREATE TABLE analysis_results (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  template_id INT NOT NULL,
  inspection_plan_id INT,
  
  -- åˆ†æé…ç½®
  analysis_type ENUM('merge', 'statistics', 'trend', 'anomaly', 'summary') NOT NULL,
  submission_ids JSON COMMENT 'å‚ä¸åˆ†æçš„æäº¤IDæ•°ç»„',
  
  -- åˆ†æç»“æœ
  raw_data JSON COMMENT 'åŸå§‹æ•°æ®',
  merged_data JSON COMMENT 'åˆå¹¶åçš„æ•°æ®',
  analysis_data JSON COMMENT 'AIåˆ†æç»“æœ',
  charts_data JSON COMMENT 'å›¾è¡¨æ•°æ®',
  summary TEXT COMMENT 'AIç”Ÿæˆçš„æ€»ç»“',
  
  -- æŠ¥å‘Š
  report_file_path VARCHAR(500),
  
  -- å®¡è®¡
  analyzed_by INT,
  analyzed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES document_templates(id),
  INDEX idx_template (template_id),
  INDEX idx_type (analysis_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ•°æ®åˆ†æç»“æœè¡¨';
```

### 8. æé†’é…ç½®è¡¨ (reminder_configs)

å­˜å‚¨æé†’é…ç½®ã€‚

```sql
CREATE TABLE reminder_configs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  user_id INT NOT NULL,
  template_id INT,
  inspection_type_id INT,
  
  -- æé†’ç±»å‹
  reminder_type ENUM('time', 'progress', 'collaboration') NOT NULL,
  
  -- æé†’é…ç½®
  config JSON NOT NULL COMMENT 'æé†’é…ç½®è¯¦æƒ…',
  
  -- æé†’æ¸ é“
  channels JSON COMMENT 'æé†’æ¸ é“ï¼š["inApp", "email", "sms", "wechat"]',
  
  is_active BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æé†’é…ç½®è¡¨';
```

### 9. æé†’è®°å½•è¡¨ (reminder_logs)

å­˜å‚¨å‘é€çš„æé†’è®°å½•ã€‚

```sql
CREATE TABLE reminder_logs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  -- å…³è”ä¿¡æ¯
  user_id INT NOT NULL,
  document_instance_id INT,
  task_id INT,
  
  -- æé†’ä¿¡æ¯
  reminder_type VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  
  -- å‘é€ä¿¡æ¯
  channel ENUM('inApp', 'email', 'sms', 'wechat') NOT NULL,
  sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  -- çŠ¶æ€
  is_read BOOLEAN DEFAULT FALSE,
  read_at DATETIME,
  
  -- æ“ä½œ
  action_url VARCHAR(500) COMMENT 'ç‚¹å‡»åè·³è½¬çš„URL',
  action_taken BOOLEAN DEFAULT FALSE,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  INDEX idx_user_read (user_id, is_read),
  INDEX idx_sent_at (sent_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æé†’è®°å½•è¡¨';
```

### 10. ç”¨æˆ·æ”¶è—è¡¨ (user_favorites)

å­˜å‚¨ç”¨æˆ·æ”¶è—çš„æ¨¡æ¿ã€‚

```sql
CREATE TABLE user_favorites (
  id INT PRIMARY KEY AUTO_INCREMENT,
  
  user_id INT NOT NULL,
  template_id INT NOT NULL,
  
  -- åˆ†ç»„
  folder_name VARCHAR(100) COMMENT 'æ”¶è—å¤¹åç§°',
  sort_order INT DEFAULT 0,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (template_id) REFERENCES document_templates(id),
  UNIQUE KEY uk_user_template (user_id, template_id),
  INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·æ”¶è—è¡¨';
```

---

## ğŸ“ˆ æ•°æ®å…³ç³»å›¾

```
document_templates (æ¨¡æ¿)
    â†“ 1:N
document_instances (æ–‡æ¡£å®ä¾‹)
    â†“ 1:N
    â”œâ”€â”€ document_versions (ç‰ˆæœ¬å†å²)
    â”œâ”€â”€ document_tasks (ä»»åŠ¡)
    â””â”€â”€ form_submissions (è¡¨å•æäº¤)
            â†“ N:1
        analysis_results (åˆ†æç»“æœ)

inspection_types (æ£€æŸ¥ç±»å‹)
    â†“ 1:N
    â”œâ”€â”€ task_templates (ä»»åŠ¡æ¨¡æ¿)
    â””â”€â”€ inspection_plans (æ£€æŸ¥è®¡åˆ’)
            â†“ 1:N
        document_instances (æ–‡æ¡£å®ä¾‹)

users (ç”¨æˆ·)
    â†“ 1:N
    â”œâ”€â”€ document_instances (åˆ›å»ºçš„æ–‡æ¡£)
    â”œâ”€â”€ document_tasks (åˆ†é…çš„ä»»åŠ¡)
    â”œâ”€â”€ reminder_configs (æé†’é…ç½®)
    â”œâ”€â”€ reminder_logs (æé†’è®°å½•)
    â””â”€â”€ user_favorites (æ”¶è—)
```

---

## ğŸ”§ ç´¢å¼•ä¼˜åŒ–å»ºè®®

### 1. å¸¸ç”¨æŸ¥è¯¢ç´¢å¼•
```sql
-- æŒ‰ç±»åˆ«å’Œé¢‘ç‡æŸ¥è¯¢æ¨¡æ¿
CREATE INDEX idx_template_category_frequency 
ON document_templates(category, frequency);

-- æŒ‰çŠ¶æ€å’Œæˆªæ­¢æ—¶é—´æŸ¥è¯¢æ–‡æ¡£
CREATE INDEX idx_document_status_deadline 
ON document_instances(status, deadline);

-- æŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢ä»»åŠ¡
CREATE INDEX idx_task_user_status 
ON document_tasks(assigned_to, status, due_date);
```

### 2. å…¨æ–‡æœç´¢ç´¢å¼•
```sql
-- æ¨¡æ¿åç§°å’Œå†…å®¹å…¨æ–‡æœç´¢
ALTER TABLE document_templates 
ADD FULLTEXT INDEX idx_fulltext_search (name, template_content);
```

---

## ğŸ“Š åˆå§‹æ•°æ®å¯¼å…¥

### å¯¼å…¥73ä¸ªæ¨¡æ¿

```sql
-- ç¤ºä¾‹ï¼šå¯¼å…¥å¹´æ£€è‡ªæŸ¥æŠ¥å‘Šæ¨¡æ¿
INSERT INTO document_templates (
  code, name, category, sub_category,
  content_type, template_content,
  variables, frequency, priority,
  is_detailed, line_count, estimated_fill_time
) VALUES (
  '01-01',
  'å¹¼å„¿å›­å¹´æ£€è‡ªæŸ¥æŠ¥å‘Š',
  'annual',
  'inspection',
  'markdown',
  '... æ¨¡æ¿å†…å®¹ ...',
  '["kindergarten_name", "inspection_date", "principal_name"]',
  'yearly',
  'required',
  TRUE,
  300,
  120
);

-- æ‰¹é‡å¯¼å…¥è„šæœ¬è§ï¼šscripts/import-templates.sql
```

---

**ä¸‹ä¸€æ­¥**: åˆ›å»ºAPIæ¥å£æ–‡æ¡£

