# 检查中心文档模板系统 - 完整开发计划 V2.0

## 🎯 核心设计理念

**基于基础信息完善度的渐进式服务**

1. **基础服务**（信息完整度 < 60%）
   - 查看模板列表
   - 手动填写文档
   - 基础打印功能

2. **标准服务**（信息完整度 60-89%）
   - ✅ 基础服务
   - ✅ 部分变量自动填充
   - ✅ 任务分配功能
   - ✅ 基础提醒功能

3. **高级服务**（信息完整度 ≥ 90%）
   - ✅ 标准服务
   - ✅ AI智能填充
   - ✅ 一键生成报告
   - ✅ 智能数据分析
   - ✅ 自动收回合并
   - ✅ 全方位智能提醒

---

## 📊 开发阶段规划

### 🔷 阶段0：基础信息扩展（1周）

**目标**: 扩展kindergarten表，建立信息完整度体系

#### Week 0.1: 数据库扩展（3天）

**任务清单**:
- [ ] 设计扩展字段（40+新字段）
- [ ] 编写数据库迁移脚本
- [ ] 更新Sequelize模型
- [ ] 更新TypeScript类型定义

**交付物**:
```sql
-- 迁移文件：server/src/migrations/YYYYMMDD-extend-kindergarten-for-inspection.js
ALTER TABLE kindergartens
ADD COLUMN license_number VARCHAR(100),
ADD COLUMN license_issue_date DATE,
-- ... 40+字段
ADD COLUMN info_completeness INT DEFAULT 0,
ADD COLUMN info_last_updated_at DATETIME;
```

```typescript
// 模型更新：server/src/models/kindergarten.model.ts
export interface KindergartenAttributes {
  // 原有字段...
  
  // 新增字段
  licenseNumber?: string;
  licenseIssueDate?: Date;
  // ... 40+字段
  infoCompleteness?: number;
  infoLastUpdatedAt?: Date;
}
```

#### Week 0.2: 完整度计算服务（2天）

**任务清单**:
- [ ] 实现完整度计算算法
- [ ] 定义必填/推荐/可选字段
- [ ] 实现字段分类和权重
- [ ] 编写单元测试

**交付物**:
```typescript
// server/src/services/kindergarten-completeness.service.ts
export class KindergartenCompletenessService {
  static calculateCompleteness(kindergarten: Kindergarten): CompletenessResult;
  static getMissingFieldsMessage(missingFields: string[]): string[];
  static canUseAdvancedFeatures(completeness: number): boolean;
}
```

#### Week 0.3: API接口开发（2天）

**任务清单**:
- [ ] 获取信息完整度API
- [ ] 批量更新基础信息API
- [ ] 获取缺失字段列表API
- [ ] 更新完整度触发器

**交付物**:
```typescript
// API端点
GET  /api/kindergarten/completeness
PUT  /api/kindergarten/base-info/batch
GET  /api/kindergarten/missing-fields
POST /api/kindergarten/calculate-completeness
```

---

### 🔷 阶段1：快速上线基础功能（2周）

**目标**: 2周内上线基础文档管理功能

#### Week 1: 模板导入和管理（5天）

**Day 1-2: 数据库和模型**
- [ ] 创建document_templates表
- [ ] 创建document_instances表
- [ ] 编写Sequelize模型
- [ ] 编写迁移脚本

**Day 3-4: 模板导入**
- [ ] 编写模板导入脚本
- [ ] 从73个MD文件提取变量
- [ ] 导入到数据库
- [ ] 验证数据完整性

**Day 5: API开发**
- [ ] 模板列表API
- [ ] 模板详情API
- [ ] 模板搜索API
- [ ] 模板分类API

**交付物**:
```bash
# 导入脚本
npm run import-templates

# API端点
GET /api/document-templates
GET /api/document-templates/:id
GET /api/document-templates/search
GET /api/document-templates/categories
```

#### Week 2: 前端基础界面（5天）

**Day 1-2: 检查中心主页**
- [ ] 信息完整度提示卡片
- [ ] 模板分类导航
- [ ] 模板列表展示
- [ ] 搜索和筛选功能

**Day 3-4: 模板详情和编辑**
- [ ] 模板详情页
- [ ] 基础Markdown编辑器
- [ ] 变量标记显示
- [ ] 保存草稿功能

**Day 5: 基础信息完善页面**
- [ ] 扩展字段表单
- [ ] 分步骤填写向导
- [ ] 实时完整度显示
- [ ] 缺失字段高亮

**交付物**:
```
client/src/pages/centers/InspectionCenter.vue
client/src/pages/centers/TemplateDetail.vue
client/src/pages/settings/BaseInfoComplete.vue
```

---

### 🔷 阶段2：核心功能开发（3周）

**目标**: 实现变量自动填充、任务分配、表单收集

#### Week 3: 变量自动填充（5天）

**Day 1-2: 变量系统**
- [ ] 变量定义和配置
- [ ] 变量数据源映射
- [ ] 自动填充算法
- [ ] 变量验证

**Day 3-4: 自动填充服务**
- [ ] 从数据库获取数据
- [ ] 变量替换引擎
- [ ] 部分填充支持
- [ ] 填充预览功能

**Day 5: 前端集成**
- [ ] 一键自动填充按钮
- [ ] 变量填充面板
- [ ] 填充进度显示
- [ ] 未填充变量提示

**交付物**:
```typescript
// API
POST /api/document-instances/:id/auto-fill
GET  /api/document-instances/:id/variables

// 服务
class VariableAutoFillService {
  async autoFill(templateId, kindergartenId): Promise<Variables>;
  async fillTemplate(content, variables): Promise<string>;
}
```

#### Week 4: 任务分配系统（5天）

**Day 1-2: 任务模板**
- [ ] 创建task_templates表
- [ ] 创建document_tasks表
- [ ] 预定义任务模板
- [ ] 任务依赖关系

**Day 3-4: 任务分配**
- [ ] 一键创建任务API
- [ ] 智能分配算法
- [ ] 任务通知服务
- [ ] 任务状态管理

**Day 5: 任务看板**
- [ ] 看板界面
- [ ] 拖拽更新状态
- [ ] 任务详情弹窗
- [ ] 进度统计

**交付物**:
```typescript
// API
POST /api/document-tasks/create-from-template
GET  /api/document-tasks/kanban
PUT  /api/document-tasks/:id

// 前端
client/src/pages/centers/TaskBoard.vue
```

#### Week 5: 表单分发收集（5天）

**Day 1-2: 表单分发**
- [ ] 创建form_distributions表
- [ ] 创建form_submissions表
- [ ] 批量分发API
- [ ] 提醒设置

**Day 3-4: 表单填写**
- [ ] 在线表单界面
- [ ] 自动保存
- [ ] 提交验证
- [ ] 提交统计

**Day 5: 收集管理**
- [ ] 提交列表
- [ ] 提交进度
- [ ] 催办功能
- [ ] 数据导出

**交付物**:
```typescript
// API
POST /api/form-distributions
POST /api/form-submissions
GET  /api/form-submissions/stats

// 前端
client/src/pages/centers/FormFilling.vue
client/src/pages/centers/FormCollection.vue
```

---

### 🔷 阶段3：高级功能开发（3周）

**目标**: AI分析、智能提醒、协同编辑

#### Week 6-7: AI数据分析（10天）

**Week 6: AI基础服务**
- [ ] AI服务配置
- [ ] OpenAI API集成
- [ ] 提示词模板
- [ ] AI调用封装

**Week 7: 数据分析功能**
- [ ] 数据清洗算法
- [ ] 智能合并算法
- [ ] 异常检测
- [ ] 趋势分析
- [ ] 报告生成

**交付物**:
```typescript
// API
POST /api/analysis/analyze-submissions
GET  /api/analysis/:id
GET  /api/analysis/:id/report

// 服务
class AIAnalysisService {
  async analyzeSubmissions(submissions, config): Promise<AnalysisResult>;
  async generateReport(analysisId): Promise<Report>;
}
```

#### Week 8: 智能提醒系统（5天）

**Day 1-2: 提醒配置**
- [ ] 创建reminder_configs表
- [ ] 创建reminder_logs表
- [ ] 提醒规则引擎
- [ ] 多渠道支持

**Day 3-4: 提醒服务**
- [ ] 定时任务调度
- [ ] 提醒生成逻辑
- [ ] 邮件发送
- [ ] 应用内通知

**Day 5: 前端集成**
- [ ] 提醒中心
- [ ] 消息列表
- [ ] 提醒设置
- [ ] 实时通知

**交付物**:
```typescript
// API
POST /api/reminders/config
GET  /api/reminders
PUT  /api/reminders/:id/read

// WebSocket
socket.on('reminder:new', callback);
```

---

### 🔷 阶段4：优化完善（2周）

**目标**: 性能优化、用户体验优化、测试

#### Week 9: 性能优化（5天）

**Day 1-2: 后端优化**
- [ ] 数据库索引优化
- [ ] 查询性能优化
- [ ] Redis缓存
- [ ] API响应优化

**Day 3-4: 前端优化**
- [ ] 组件懒加载
- [ ] 虚拟滚动
- [ ] 图片懒加载
- [ ] 打包优化

**Day 5: 监控和日志**
- [ ] 性能监控
- [ ] 错误日志
- [ ] 用户行为分析
- [ ] 性能报告

#### Week 10: 测试和上线（5天）

**Day 1-2: 全面测试**
- [ ] 单元测试
- [ ] 集成测试
- [ ] E2E测试
- [ ] 性能测试

**Day 3: Bug修复**
- [ ] 修复测试发现的问题
- [ ] 代码审查
- [ ] 安全检查

**Day 4: 文档和培训**
- [ ] 用户手册
- [ ] 视频教程
- [ ] 管理员培训
- [ ] 教师培训

**Day 5: 上线部署**
- [ ] 生产环境部署
- [ ] 数据迁移
- [ ] 灰度发布
- [ ] 监控告警

---

## 📋 关键里程碑

| 里程碑 | 时间 | 交付物 | 验收标准 |
|--------|------|--------|---------|
| **M0: 基础信息扩展** | Week 0 | 扩展字段、完整度计算 | 信息完整度正确计算 |
| **M1: 基础功能上线** | Week 2 | 模板管理、基础编辑 | 可查看和编辑模板 |
| **M2: 核心功能完成** | Week 5 | 自动填充、任务分配、表单收集 | 核心流程跑通 |
| **M3: 高级功能完成** | Week 8 | AI分析、智能提醒 | 高级功能可用 |
| **M4: 正式上线** | Week 10 | 完整系统 | 通过验收测试 |

---

## 🎯 功能优先级

### P0（必须有）- 阶段0-2
- ✅ 基础信息扩展和完整度计算
- ✅ 模板导入和管理
- ✅ 基础编辑功能
- ✅ 变量自动填充
- ✅ 任务分配
- ✅ 表单收集

### P1（应该有）- 阶段3
- ✅ AI数据分析
- ✅ 智能提醒
- ✅ 打印优化

### P2（可以有）- 后续迭代
- 协同编辑
- 版本控制
- 移动端适配
- 语音输入

---

## 💡 技术栈

### 后端
- Node.js + Express + TypeScript
- Sequelize ORM + MySQL 8.0
- Redis（缓存）
- OpenAI API（AI功能）
- Node-cron（定时任务）

### 前端
- Vue 3 + TypeScript
- Element Plus
- Quill Editor（富文本）
- ECharts（图表）
- Socket.io（实时通信）

---

## 📊 资源需求

### 人力
- 后端开发：1人
- 前端开发：1人
- 测试：0.5人
- 产品/设计：0.5人

### 时间
- 总计：10周（2.5个月）
- 每周工作：5天
- 总工作日：50天

---

## 🚀 快速启动指南

### 第一步：扩展基础信息（本周）
```bash
# 1. 运行数据库迁移
cd server
npx sequelize-cli db:migrate

# 2. 更新模型
npm run build

# 3. 测试完整度计算
npm run test:completeness
```

### 第二步：导入模板（下周）
```bash
# 导入73个模板到数据库
npm run import-templates

# 验证导入
npm run verify-templates
```

### 第三步：开发前端（第3周开始）
```bash
cd client
npm run dev

# 访问检查中心
# http://localhost:5173/inspection-center
```

---

**版本**: V2.0  
**更新日期**: 2025-10-09  
**状态**: 待评审和执行

