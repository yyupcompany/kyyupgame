# TC-015: 客户跟进测试

## 测试概述
**测试目标**: 验证移动端客户跟进功能，包括家长沟通、学生情况记录、跟进计划制定、沟通历史管理等
**测试类型**: 功能测试 + 数据验证测试 + 沟通流程测试
**优先级**: 高
**预计执行时间**: 20-25分钟

## 测试环境
- **设备**: 移动端设备 (iOS/Android)
- **浏览器**: Chrome Mobile/Safari Mobile
- **网络**: 4G/WiFi
- **用户角色**: 教师

## 前置条件
1. 用户已成功登录系统
2. 用户具有客户跟进权限
3. 系统中存在学生和家长数据
4. 移动端网络连接正常

## 测试用例详情

### TC-015-01: 家长沟通管理
**测试描述**: 验证与家长的沟通记录、消息发送和沟通历史管理功能

**测试步骤**:
1. 进入客户跟进页面
2. 选择要沟通的学生
3. 查看家长基本信息
4. 发送沟通消息
5. 记录沟通内容
6. 选择沟通方式（电话、微信、面谈）
7. 标记沟通结果
8. 查看沟通历史

**预期结果**:
- ✅ 学生和家长信息正确显示
- ✅ 沟通记录创建成功
- ✅ 消息发送功能正常
- ✅ 沟通方式可选择
- ✅ 结果标记功能可用
- ✅ 历史记录完整显示
- ✅ 数据实时同步更新

**严格验证要求**:
```javascript
// 验证家长沟通界面
const validateParentCommunicationInterface = () => {
  const communicationView = document.querySelector('.parent-communication-view');
  expect(communicationView).toBeTruthy();

  // 验证学生信息显示
  const studentInfo = communicationView.querySelector('.student-info-section');
  expect(studentInfo).toBeTruthy();

  const studentName = studentInfo.querySelector('.student-name');
  const studentClass = studentInfo.querySelector('.student-class');
  const parentId = studentInfo.querySelector('.parent-id');

  expect(studentName?.textContent).toBeTruthy();
  expect(studentClass?.textContent).toBeTruthy();
  expect(parentId?.textContent).toBeTruthy();

  // 验证家长信息
  const parentInfo = communicationView.querySelector('.parent-info-section');
  expect(parentInfo).toBeTruthy();

  const parentName = parentInfo.querySelector('.parent-name');
  const parentPhone = parentInfo.querySelector('.parent-phone');
  const parentEmail = parentInfo.querySelector('.parent-email');

  expect(parentName?.textContent).toBeTruthy();
  expect(parentPhone?.textContent).toBeTruthy();

  // 验证沟通记录表单
  const communicationForm = communicationView.querySelector('.communication-record-form');
  expect(communicationForm).toBeTruthy();

  const requiredFields = ['content', 'method', 'result', 'nextFollowUp'];
  requiredFields.forEach(field => {
    const fieldElement = communicationForm.querySelector(`[name="${field}"]`);
    expect(fieldElement).toBeTruthy();
    expect(fieldElement.hasAttribute('required')).toBe(true);
  });

  // 验证沟通方式选项
  const methodField = communicationForm.querySelector('[name="method"]');
  const methodOptions = methodField.querySelectorAll('option');
  const validMethods = ['phone', 'wechat', 'visit', 'message', 'email'];
  methodOptions.forEach(option => {
    expect(validMethods).toContain(option.value);
  });
};

// API响应验证
const validateCommunicationRecordResponse = (response) => {
  validateRequiredFields(response.data, [
    'id', 'studentId', 'parentId', 'teacherId', 'content', 'method',
    'result', 'duration', 'nextFollowUp', 'createdAt'
  ]);

  validateFieldTypes(response.data, {
    id: 'number',
    studentId: 'number',
    parentId: 'number',
    teacherId: 'number',
    content: 'string',
    method: 'string',
    result: 'string',
    duration: 'number',
    nextFollowUp: 'string',
    createdAt: 'string'
  });

  // 沟通方式枚举验证
  expect(['phone', 'wechat', 'visit', 'message', 'email']).toContain(response.data.method);

  // 沟通结果验证
  const validResults = ['successful', 'needs_followup', 'failed', 'postponed'];
  expect(validResults).toContain(response.data.result);

  // 时长验证（分钟）
  expect(response.data.duration).toBeGreaterThan(0);
  expect(response.data.duration).toBeLessThan(480); // 不超过8小时

  // 日期格式验证
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  expect(dateRegex.test(response.data.nextFollowUp)).toBe(true);

  const dateTimeRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?$/;
  expect(dateTimeRegex.test(response.data.createdAt)).toBe(true);
};

// 沟通历史验证
const validateCommunicationHistory = (response) => {
  validateRequiredFields(response.data, ['records', 'total', 'summary']);

  validateFieldTypes(response.data, {
    records: 'array',
    total: 'number',
    summary: 'object'
  });

  // 记录列表验证
  expect(response.data.total).toBe(response.data.records.length);

  response.data.records.forEach(record => {
    validateRequiredFields(record, [
      'id', 'method', 'content', 'result', 'teacherName', 'createdAt'
    ]);
    validateFieldTypes(record, {
      id: 'number',
      method: 'string',
      content: 'string',
      result: 'string',
      teacherName: 'string',
      createdAt: 'string'
    });
  });

  // 统计摘要验证
  validateRequiredFields(response.data.summary, [
    'totalCommunications', 'successfulRate', 'averageDuration',
    'methodDistribution', 'recentCommunications'
  ]);

  validateFieldTypes(response.data.summary, {
    totalCommunications: 'number',
    successfulRate: 'number',
    averageDuration: 'number',
    methodDistribution: 'object',
    recentCommunications: 'number'
  });

  // 成功率验证
  expect(response.data.summary.successfulRate).toBeBetween(0, 100);

  // 方式分布验证
  const methodTypes = ['phone', 'wechat', 'visit', 'message', 'email'];
  Object.keys(response.data.summary.methodDistribution).forEach(method => {
    expect(methodTypes).toContain(method);
    expect(typeof response.data.summary.methodDistribution[method]).toBe('number');
  });
};

// 沟通记录测试数据
const communicationTestData = {
  studentId: 101,
  parentId: 1001,
  content: '与家长沟通了孩子近期的学习情况，家长表示对孩子的进步很满意，同时希望加强家庭作业的监督。',
  method: 'phone',
  duration: 15,
  result: 'successful',
  nextFollowUp: '2024-01-22',
  attachments: [],
  tags: ['学习情况', '家长满意度'],
  actionItems: [
    { action: '增加家庭作业量', deadline: '2024-01-18', responsible: '张老师' },
    { action: '每周发送学习报告', deadline: '2024-01-19', responsible: '张老师' }
  ]
};
```

### TC-015-02: 学生情况记录
**测试描述**: 验证学生学习、行为、健康等各方面情况的记录和管理功能

**测试步骤**:
1. 选择要记录情况的学生
2. 选择记录类型（学习、行为、健康等）
3. 填写情况描述
4. 设置重要程度和紧急程度
5. 添加相关证据（照片、文档）
6. 选择需要通知的人员
7. 保存情况记录
8. 查看情况历史趋势

**预期结果**:
- ✅ 情况类型可选择
- ✅ 描述内容可详细记录
- ✅ 重要程度分级正确
- ✅ 证据附件可上传
- ✅ 通知机制正常工作
- ✅ 记录成功保存
- ✅ 历史趋势可分析

**严格验证要求**:
```javascript
// 验证学生情况记录界面
const validateStudentSituationInterface = () => {
  const situationForm = document.querySelector('.student-situation-form');
  expect(situationForm).toBeTruthy();

  // 验证情况类型
  const typeField = situationForm.querySelector('[name="type"]');
  const typeOptions = typeField.querySelectorAll('option');
  const validTypes = ['academic', 'behavior', 'health', 'social', 'family', 'other'];
  typeOptions.forEach(option => {
    expect(validTypes).toContain(option.value);
  });

  // 验证重要程度
  const importanceField = situationForm.querySelector('[name="importance"]');
  const importanceOptions = importanceField.querySelectorAll('option');
  const validImportance = ['low', 'medium', 'high', 'critical'];
  importanceOptions.forEach(option => {
    expect(validImportance).toContain(option.value);
  });

  // 验证紧急程度
  const urgencyField = situationForm.querySelector('[name="urgency"]');
  const urgencyOptions = urgencyField.querySelectorAll('option');
  const validUrgency = ['low', 'medium', 'high', 'urgent'];
  urgencyOptions.forEach(option => {
    expect(validUrgency).toContain(option.value);
  });

  // 验证文件上传
  const fileUpload = situationForm.querySelector('.file-upload-input');
  expect(fileUpload).toBeTruthy();

  // 验证通知设置
  const notificationSettings = situationForm.querySelector('.notification-settings');
  expect(notificationSettings).toBeTruthy();

  const notifyTeachers = notificationSettings.querySelector('[name="notifyTeachers"]');
  const notifyParents = notificationSettings.querySelector('[name="notifyParents"]');
  const notifyAdmin = notificationSettings.querySelector('[name="notifyAdmin"]');

  expect(notifyTeachers).toBeTruthy();
  expect(notifyParents).toBeTruthy();
  expect(notifyAdmin).toBeTruthy();
};

// 学生情况记录API验证
const validateStudentSituationResponse = (response) => {
  validateRequiredFields(response.data, [
    'id', 'studentId', 'teacherId', 'type', 'title', 'description',
    'importance', 'urgency', 'attachments', 'notifications', 'createdAt'
  ]);

  validateFieldTypes(response.data, {
    id: 'number',
    studentId: 'number',
    teacherId: 'number',
    type: 'string',
    title: 'string',
    description: 'string',
    importance: 'string',
    urgency: 'string',
    attachments: 'array',
    notifications: 'object',
    createdAt: 'string'
  });

  // 类型枚举验证
  expect(['academic', 'behavior', 'health', 'social', 'family', 'other'])
    .toContain(response.data.type);

  // 重要程度验证
  expect(['low', 'medium', 'high', 'critical']).toContain(response.data.importance);

  // 紧急程度验证
  expect(['low', 'medium', 'high', 'urgent']).toContain(response.data.urgency);

  // 附件验证
  expect(Array.isArray(response.data.attachments)).toBe(true);
  response.data.attachments.forEach(attachment => {
    validateRequiredFields(attachment, ['id', 'filename', 'url', 'size', 'type']);
    validateFieldTypes(attachment, {
      id: 'number',
      filename: 'string',
      url: 'string',
      size: 'number',
      type: 'string'
    });
  });

  // 通知设置验证
  validateRequiredFields(response.data.notifications, [
    'teachers', 'parents', 'admin', 'sentAt'
  ]);

  validateFieldTypes(response.data.notifications, {
    teachers: 'array',
    parents: 'array',
    admin: 'boolean',
    sentAt: 'string'
  });
};

// 学生情况统计验证
const validateStudentSituationStats = (response) => {
  validateRequiredFields(response.data, [
    'totalSituations', 'byType', 'byImportance', 'byUrgency', 'trendData', 'alertCount'
  ]);

  validateFieldTypes(response.data, {
    totalSituations: 'number',
    byType: 'object',
    byImportance: 'object',
    byUrgency: 'object',
    trendData: 'array',
    alertCount: 'number'
  });

  // 按类型统计验证
  const validTypes = ['academic', 'behavior', 'health', 'social', 'family', 'other'];
  Object.keys(response.data.byType).forEach(type => {
    expect(validTypes).toContain(type);
    expect(typeof response.data.byType[type]).toBe('number');
  });

  // 按重要程度统计验证
  const validImportance = ['low', 'medium', 'high', 'critical'];
  Object.keys(response.data.byImportance).forEach(importance => {
    expect(validImportance).toContain(importance);
    expect(typeof response.data.byImportance[importance]).toBe('number');
  });

  // 按紧急程度统计验证
  const validUrgency = ['low', 'medium', 'high', 'urgent'];
  Object.keys(response.data.byUrgency).forEach(urgency => {
    expect(validUrgency).toContain(urgency);
    expect(typeof response.data.byUrgency[urgency]).toBe('number');
  });

  // 趋势数据验证
  expect(Array.isArray(response.data.trendData)).toBe(true);
  response.data.trendData.forEach(trend => {
    validateRequiredFields(trend, ['date', 'count', 'byType']);
    validateFieldTypes(trend, {
      date: 'string',
      count: 'number',
      byType: 'object'
    });
  });
};

// 学生情况测试数据
const studentSituationTestData = {
  studentId: 102,
  type: 'academic',
  title: '数学学习困难',
  description: '学生在近期数学测试中表现不佳，特别是计算题部分需要加强练习。家长希望老师能够提供额外的辅导。',
  importance: 'medium',
  urgency: 'medium',
  attachments: [
    {
      filename: 'math_test_result.pdf',
      url: '/files/attachments/math_test_20240115.pdf',
      size: 2048576,
      type: 'application/pdf'
    }
  ],
  notifications: {
    teachers: [101, 103],
    parents: [1002],
    admin: false
  },
  actionPlan: [
    { action: '安排额外辅导', deadline: '2024-01-20', responsible: '张老师' },
    { action: '提供练习材料', deadline: '2024-01-18', responsible: '李老师' }
  ]
};
```

### TC-015-03: 跟进计划制定
**测试描述**: 验证客户跟进计划的制定、执行、跟踪和调整功能

**测试步骤**:
1. 查看当前需要跟进的客户列表
2. 选择要制定跟进计划的学生
3. 设置跟进目标和期望结果
4. 制定具体跟进步骤和时间安排
5. 分配责任人
6. 设置提醒和通知
7. 保存跟进计划
8. 跟踪计划执行情况

**预期结果**:
- ✅ 跟进客户列表准确显示
- ✅ 跟进目标可明确设置
- ✅ 执行步骤可详细规划
- ✅ 责任人分配正确
- ✅ 提醒通知设置成功
- ✅ 计划保存完整
- ✅ 执行情况可实时跟踪

**严格验证要求**:
```javascript
// 验证跟进计划界面
const validateFollowUpPlanInterface = () => {
  const followUpPlanForm = document.querySelector('.follow-up-plan-form');
  expect(followUpPlanForm).toBeTruthy();

  // 验证目标设置
  const goalsSection = followUpPlanForm.querySelector('.goals-section');
  expect(goalsSection).toBeTruthy();

  const goalInput = goalsSection.querySelector('[name="goals"]');
  const expectedOutcome = goalsSection.querySelector('[name="expectedOutcome"]');
  expect(goalInput.hasAttribute('required')).toBe(true);
  expect(expectedOutcome.hasAttribute('required')).toBe(true);

  // 验证步骤设置
  const stepsSection = followUpPlanForm.querySelector('.steps-section');
  expect(stepsSection).toBeTruthy();

  const addStepButton = stepsSection.querySelector('.add-step-btn');
  expect(addStepButton).toBeTruthy();

  // 验证责任人分配
  const assigneeSection = followUpPlanForm.querySelector('.assignee-section');
  expect(assigneeSection).toBeTruthy();

  const primaryAssignee = assigneeSection.querySelector('[name="primaryAssignee"]');
  const secondaryAssignees = assigneeSection.querySelector('[name="secondaryAssignees"]');
  expect(primaryAssignee.hasAttribute('required')).toBe(true);

  // 验证时间安排
  const scheduleSection = followUpPlanForm.querySelector('.schedule-section');
  expect(scheduleSection).toBeTruthy();

  const startDate = scheduleSection.querySelector('[name="startDate"]');
  const endDate = scheduleSection.querySelector('[name="endDate"]');
  expect(startDate.hasAttribute('required')).toBe(true);
  expect(endDate.hasAttribute('required')).toBe(true);

  // 验证提醒设置
  const reminderSection = followUpPlanForm.querySelector('.reminder-section');
  expect(reminderSection).toBeTruthy();

  const enableReminders = reminderSection.querySelector('[name="enableReminders"]');
  const reminderFrequency = reminderSection.querySelector('[name="reminderFrequency"]');
  expect(reminderFrequency).toBeTruthy();
};

// 跟进计划API验证
const validateFollowUpPlanResponse = (response) => {
  validateRequiredFields(response.data, [
    'id', 'studentId', 'creatorId', 'title', 'goals', 'expectedOutcome',
    'steps', 'assignees', 'schedule', 'status', 'createdAt'
  ]);

  validateFieldTypes(response.data, {
    id: 'number',
    studentId: 'number',
    creatorId: 'number',
    title: 'string',
    goals: 'array',
    expectedOutcome: 'string',
    steps: 'array',
    assignees: 'object',
    schedule: 'object',
    status: 'string',
    createdAt: 'string'
  });

  // 目标验证
  expect(Array.isArray(response.data.goals)).toBe(true);
  response.data.goals.forEach(goal => {
    validateRequiredFields(goal, ['id', 'description', 'priority', 'completed']);
    validateFieldTypes(goal, {
      id: 'number',
      description: 'string',
      priority: 'string',
      completed: 'boolean'
    });
    expect(['low', 'medium', 'high']).toContain(goal.priority);
  });

  // 步骤验证
  expect(Array.isArray(response.data.steps)).toBe(true);
  response.data.steps.forEach(step => {
    validateRequiredFields(step, ['id', 'title', 'description', 'dueDate', 'status']);
    validateFieldTypes(step, {
      id: 'number',
      title: 'string',
      description: 'string',
      dueDate: 'string',
      status: 'string'
    });
    expect(['pending', 'in_progress', 'completed', 'cancelled']).toContain(step.status);
  });

  // 责任人验证
  validateRequiredFields(response.data.assignees, ['primary', 'secondary']);
  validateFieldTypes(response.data.assignees, {
    primary: 'number',
    secondary: 'array'
  });

  // 时间安排验证
  validateRequiredFields(response.data.schedule, ['startDate', 'endDate', 'frequency']);
  validateFieldTypes(response.data.schedule, {
    startDate: 'string',
    endDate: 'string',
    frequency: 'string'
  });

  // 状态验证
  expect(['draft', 'active', 'completed', 'paused', 'cancelled']).toContain(response.data.status);
};

// 跟进计划执行跟踪验证
const validateFollowUpExecution = (response) => {
  validateRequiredFields(response.data, [
    'planId', 'executionId', 'executedBy', 'executedAt', 'stepUpdates',
    'progress', 'notes', 'nextAction'
  ]);

  validateFieldTypes(response.data, {
    planId: 'number',
    executionId: 'number',
    executedBy: 'number',
    executedAt: 'string',
    stepUpdates: 'array',
    progress: 'number',
    notes: 'string',
    nextAction: 'object'
  });

  // 进度验证
  expect(response.data.progress).toBeBetween(0, 100);

  // 步骤更新验证
  expect(Array.isArray(response.data.stepUpdates)).toBe(true);
  response.data.stepUpdates.forEach(update => {
    validateRequiredFields(update, ['stepId', 'oldStatus', 'newStatus', 'comment']);
    validateFieldTypes(update, {
      stepId: 'number',
      oldStatus: 'string',
      newStatus: 'string',
      comment: 'string'
    });
  });

  // 下一步行动验证
  if (response.data.nextAction) {
    validateRequiredFields(response.data.nextAction, ['action', 'dueDate', 'assignee']);
    validateFieldTypes(response.data.nextAction, {
      action: 'string',
      dueDate: 'string',
      assignee: 'number'
    });
  }
};

// 跟进计划测试数据
const followUpPlanTestData = {
  studentId: 103,
  title: '数学学习改善计划',
  goals: [
    { description: '提高计算能力', priority: 'high', completed: false },
    { description: '增强数学思维', priority: 'medium', completed: false },
    { description: '提升考试成绩', priority: 'high', completed: false }
  ],
  expectedOutcome: '学生在下个月数学测试中达到80分以上，计算准确率达到90%',
  steps: [
    {
      title: '评估当前水平',
      description: '进行数学能力测试，确定薄弱环节',
      dueDate: '2024-01-18',
      status: 'pending'
    },
    {
      title: '制定个性化练习',
      description: '根据测试结果制定针对性练习计划',
      dueDate: '2024-01-20',
      status: 'pending'
    },
    {
      title: '每周辅导',
      description: '每周安排2次额外辅导时间',
      dueDate: '2024-02-15',
      status: 'pending'
    }
  ],
  assignees: {
    primary: 201,
    secondary: [202, 203]
  },
  schedule: {
    startDate: '2024-01-15',
    endDate: '2024-02-15',
    frequency: 'weekly'
  }
};
```

### TC-015-04: 客户统计分析
**测试描述**: 验证客户跟进数据的统计分析和报告生成功能

**测试步骤**:
1. 查看客户跟进统计概览
2. 按不同维度分析数据（时间、类型、责任人）
3. 查看沟通效率分析
4. 分析问题分布和解决情况
5. 生成客户跟进报告
6. 导出统计数据
7. 查看改进建议

**预期结果**:
- ✅ 统计数据完整准确
- ✅ 多维度分析可用
- ✅ 沟通效率指标明确
- ✅ 问题分析到位
- ✅ 报告生成功能正常
- ✅ 数据导出格式正确
- ✅ 改进建议有价值

**严格验证要求**:
```javascript
// 客户跟进统计概览验证
const validateCustomerFollowUpStats = (response) => {
  validateRequiredFields(response.data, [
    'overview', 'communicationStats', 'followUpStats', 'problemStats',
    'efficiencyMetrics', 'trendAnalysis'
  ]);

  // 概览数据验证
  validateRequiredFields(response.data.overview, [
    'totalCustomers', 'activeFollowUps', 'completedFollowUps', 'avgFollowUpDuration',
    'satisfactionRate', 'responseRate'
  ]);

  validateFieldTypes(response.data.overview, {
    totalCustomers: 'number',
    activeFollowUps: 'number',
    completedFollowUps: 'number',
    avgFollowUpDuration: 'number',
    satisfactionRate: 'number',
    responseRate: 'number'
  });

  // 数值范围验证
  expect(response.data.overview.satisfactionRate).toBeBetween(0, 100);
  expect(response.data.overview.responseRate).toBeBetween(0, 100);
  expect(response.data.overview.avgFollowUpDuration).toBeGreaterThan(0);

  // 沟通统计验证
  validateRequiredFields(response.data.communicationStats, [
    'totalCommunications', 'byMethod', 'byResult', 'frequency', 'avgDuration'
  ]);

  validateFieldTypes(response.data.communicationStats, {
    totalCommunications: 'number',
    byMethod: 'object',
    byResult: 'object',
    frequency: 'object',
    avgDuration: 'number'
  });

  // 沟通方式分布验证
  const validMethods = ['phone', 'wechat', 'visit', 'message', 'email'];
  Object.keys(response.data.communicationStats.byMethod).forEach(method => {
    expect(validMethods).toContain(method);
    expect(typeof response.data.communicationStats.byMethod[method]).toBe('number');
  });

  // 跟进统计验证
  validateRequiredFields(response.data.followUpStats, [
    'totalPlans', 'completedPlans', 'activePlans', 'successRate',
    'avgCompletionTime', 'byType'
  ]);

  validateFieldTypes(response.data.followUpStats, {
    totalPlans: 'number',
    completedPlans: 'number',
    activePlans: 'number',
    successRate: 'number',
    avgCompletionTime: 'number',
    byType: 'object'
  });

  // 效率指标验证
  validateRequiredFields(response.data.efficiencyMetrics, [
    'responseTime', 'resolutionTime', 'followUpCompliance', 'communicationEffectiveness'
  ]);

  validateFieldTypes(response.data.efficiencyMetrics, {
    responseTime: 'number',
    resolutionTime: 'number',
    followUpCompliance: 'number',
    communicationEffectiveness: 'number'
  });

  // 趋势分析验证
  expect(Array.isArray(response.data.trendAnalysis)).toBe(true);
  response.data.trendAnalysis.forEach(trend => {
    validateRequiredFields(trend, ['period', 'metrics']);
    validateFieldTypes(trend, {
      period: 'string',
      metrics: 'object'
    });
  });
};

// 客户跟进报告验证
const validateCustomerFollowUpReport = (reportData) => {
  validateRequiredFields(reportData, [
    'title', 'period', 'generatedAt', 'executiveSummary', 'detailedAnalysis',
    'charts', 'recommendations', 'actionPlan'
  ]);

  validateFieldTypes(reportData, {
    title: 'string',
    period: 'string',
    generatedAt: 'string',
    executiveSummary: 'object',
    detailedAnalysis: 'object',
    charts: 'array',
    recommendations: 'array',
    actionPlan: 'array'
  });

  // 执行摘要验证
  validateRequiredFields(reportData.executiveSummary, [
    'keyMetrics', 'highlights', 'concerns', 'opportunities'
  ]);

  // 详细分析验证
  validateRequiredFields(reportData.detailedAnalysis, [
    'communicationAnalysis', 'followUpEffectiveness', 'problemResolution',
    'satisfactionTrends', 'performanceComparison'
  ]);

  // 图表数据验证
  reportData.charts.forEach(chart => {
    validateRequiredFields(chart, ['type', 'title', 'data', 'insights']);
    expect(['line', 'bar', 'pie', 'scatter', 'heatmap']).toContain(chart.type);
  });

  // 建议验证
  reportData.recommendations.forEach(recommendation => {
    validateRequiredFields(recommendation, ['category', 'description', 'priority', 'impact', 'effort']);
    validateFieldTypes(recommendation, {
      category: 'string',
      description: 'string',
      priority: 'string',
      impact: 'string',
      effort: 'string'
    });
    expect(['process', 'communication', 'training', 'tools']).toContain(recommendation.category);
    expect(['low', 'medium', 'high']).toContain(recommendation.priority);
  });

  // 行动计划验证
  reportData.actionPlan.forEach(action => {
    validateRequiredFields(action, ['action', 'responsible', 'deadline', 'resources', 'successCriteria']);
    validateFieldTypes(action, {
      action: 'string',
      responsible: 'string',
      deadline: 'string',
      resources: 'array',
      successCriteria: 'string'
    });
  });
};
```

### TC-015-05: 客户满意度管理
**测试描述**: 验证客户满意度调查、反馈收集和改进措施管理功能

**测试步骤**:
1. 发送满意度调查问卷
2. 收集家长反馈意见
3. 分析满意度数据
4. 识别改进机会
5. 制定改进措施
6. 跟踪改进效果
7. 生成满意度报告

**预期结果**:
- ✅ 调查问卷发送成功
- ✅ 反馈数据收集完整
- ✅ 满意度分析准确
- ✅ 改进机会识别到位
- ✅ 改进措施有效制定
- ✅ 效果跟踪机制完善
- ✅ 报告内容详实有用

**严格验证要求**:
```javascript
// 满意度调查界面验证
const validateSatisfactionSurveyInterface = () => {
  const surveyForm = document.querySelector('.satisfaction-survey-form');
  expect(surveyForm).toBeTruthy();

  // 验证问卷模板选择
  const templateField = surveyForm.querySelector('[name="template"]');
  const templateOptions = templateField.querySelectorAll('option');
  const validTemplates = ['academic', 'communication', 'service', 'comprehensive'];
  templateOptions.forEach(option => {
    expect(validTemplates).toContain(option.value);
  });

  // 验证发送对象选择
  const recipientsSection = surveyForm.querySelector('.recipients-section');
  expect(recipientsSection).toBeTruthy();

  const allParents = recipientsSection.querySelector('[name="allParents"]');
  const specificParents = recipientsSection.querySelector('[name="specificParents"]');
  expect(allParents || specificParents).toBeTruthy();

  // 验证问卷内容
  const questionsSection = surveyForm.querySelector('.questions-section');
  expect(questionsSection).toBeTruthy();

  const questions = questionsSection.querySelectorAll('.survey-question');
  expect(questions.length).toBeGreaterThan(0);

  questions.forEach(question => {
    const questionText = question.querySelector('.question-text');
    const questionType = question.querySelector('.question-type');
    const options = question.querySelectorAll('.question-option');

    expect(questionText?.textContent).toBeTruthy();
    expect(questionType).toBeTruthy();
    expect(options.length).toBeGreaterThan(0);
  });

  // 验证发送设置
  const sendSettings = surveyForm.querySelector('.send-settings');
  expect(sendSettings).toBeTruthy();

  const sendDate = sendSettings.querySelector('[name="sendDate"]');
  const reminderEnabled = sendSettings.querySelector('[name="reminderEnabled"]');
  expect(sendDate.hasAttribute('required')).toBe(true);
};

// 满意度数据API验证
const validateSatisfactionDataResponse = (response) => {
  validateRequiredFields(response.data, [
    'surveyId', 'totalResponses', 'responseRate', 'averageScore',
    'scoresByCategory', 'detailedResults', 'sentimentAnalysis'
  ]);

  validateFieldTypes(response.data, {
    surveyId: 'number',
    totalResponses: 'number',
    responseRate: 'number',
    averageScore: 'number',
    scoresByCategory: 'object',
    detailedResults: 'array',
    sentimentAnalysis: 'object'
  });

  // 响应率验证
  expect(response.data.responseRate).toBeBetween(0, 100);

  // 平均分验证
  expect(response.data.averageScore).toBeBetween(1, 5);

  // 分类得分验证
  const validCategories = ['academic', 'communication', 'service', 'environment', 'overall'];
  Object.keys(response.data.scoresByCategory).forEach(category => {
    expect(validCategories).toContain(category);
    const score = response.data.scoresByCategory[category];
    expect(typeof score).toBe('number');
    expect(score).toBeBetween(1, 5);
  });

  // 详细结果验证
  expect(Array.isArray(response.data.detailedResults)).toBe(true);
  response.data.detailedResults.forEach(result => {
    validateRequiredFields(result, [
      'respondentId', 'responses', 'overallScore', 'submittedAt', 'comments'
    ]);
    validateFieldTypes(result, {
      respondentId: 'number',
      responses: 'object',
      overallScore: 'number',
      submittedAt: 'string',
      comments: 'string'
    });

    // 问卷回答验证
    Object.keys(result.responses).forEach(questionId => {
      const answer = result.responses[questionId];
      expect(['number', 'string']).toContain(typeof answer);
      if (typeof answer === 'number') {
        expect(answer).toBeBetween(1, 5);
      }
    });
  });

  // 情感分析验证
  validateRequiredFields(response.data.sentimentAnalysis, [
    'overallSentiment', 'positiveRate', 'neutralRate', 'negativeRate',
    'keyThemes', 'concerns', 'suggestions'
  ]);

  validateFieldTypes(response.data.sentimentAnalysis, {
    overallSentiment: 'string',
    positiveRate: 'number',
    neutralRate: 'number',
    negativeRate: 'number',
    keyThemes: 'array',
    concerns: 'array',
    suggestions: 'array'
  });

  // 情感分类验证
  expect(['positive', 'neutral', 'negative']).toContain(response.data.sentimentAnalysis.overallSentiment);

  // 比率验证
  const totalRate = response.data.sentimentAnalysis.positiveRate +
                   response.data.sentimentAnalysis.neutralRate +
                   response.data.sentimentAnalysis.negativeRate;
  expect(Math.abs(totalRate - 100)).toBeLessThan(0.1);
};

// 满意度报告验证
const validateSatisfactionReport = (reportData) => {
  validateRequiredFields(reportData, [
    'title', 'period', 'generatedAt', 'executiveSummary', 'scoresAnalysis',
    'trendAnalysis', 'improvementAreas', 'actionItems', 'appendix'
  ]);

  validateFieldTypes(reportData, {
    title: 'string',
    period: 'string',
    generatedAt: 'string',
    executiveSummary: 'object',
    scoresAnalysis: 'object',
    trendAnalysis: 'array',
    improvementAreas: 'array',
    actionItems: 'array',
    appendix: 'object'
  });

  // 得分分析验证
  validateRequiredFields(reportData.scoresAnalysis, [
    'overallScore', 'categoryScores', 'scoreDistribution', 'benchmarkComparison'
  ]);

  // 趋势分析验证
  expect(Array.isArray(reportData.trendAnalysis)).toBe(true);
  reportData.trendAnalysis.forEach(trend => {
    validateRequiredFields(trend, ['date', 'overallScore', 'categoryScores', 'significantChanges']);
  });

  // 改进领域验证
  reportData.improvementAreas.forEach(area => {
    validateRequiredFields(area, ['category', 'currentScore', 'targetScore', 'priority', 'rootCauses']);
    validateFieldTypes(area, {
      category: 'string',
      currentScore: 'number',
      targetScore: 'number',
      priority: 'string',
      rootCauses: 'array'
    });
    expect(area.currentScore).toBeLessThan(area.targetScore);
    expect(['low', 'medium', 'high']).toContain(area.priority);
  });

  // 行动项验证
  reportData.actionItems.forEach(action => {
    validateRequiredFields(action, ['description', 'responsible', 'deadline', 'measurableOutcome']);
    validateFieldTypes(action, {
      description: 'string',
      responsible: 'string',
      deadline: 'string',
      measurableOutcome: 'string'
    });
  });
};
```

## API接口测试

### POST /api/customer-followup/communication-record
**请求体**:
```json
{
  "studentId": 101,
  "parentId": 1001,
  "content": "与家长沟通了孩子近期的学习情况",
  "method": "phone",
  "duration": 15,
  "result": "successful",
  "nextFollowUp": "2024-01-22",
  "attachments": [],
  "tags": ["学习情况", "家长满意度"]
}
```

**成功响应**:
```json
{
  "success": true,
  "data": {
    "id": 50123,
    "studentId": 101,
    "parentId": 1001,
    "teacherId": 201,
    "method": "phone",
    "result": "successful",
    "duration": 15,
    "createdAt": "2024-01-15T14:30:00Z"
  },
  "message": "沟通记录保存成功"
}
```

### POST /api/customer-followup/student-situation
**请求体**:
```json
{
  "studentId": 102,
  "type": "academic",
  "title": "数学学习困难",
  "description": "学生在近期数学测试中表现不佳",
  "importance": "medium",
  "urgency": "medium",
  "notifications": {
    "teachers": [101, 103],
    "parents": [1002],
    "admin": false
  }
}
```

### GET /api/customer-followup/statistics
**查询参数**: `?startDate=2024-01-01&endDate=2024-01-31&teacherId=201`

**成功响应**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalCustomers": 45,
      "activeFollowUps": 12,
      "completedFollowUps": 33,
      "avgFollowUpDuration": 25.5,
      "satisfactionRate": 87.5,
      "responseRate": 92.3
    },
    "communicationStats": {
      "totalCommunications": 156,
      "byMethod": {
        "phone": 68,
        "wechat": 45,
        "visit": 23,
        "message": 15,
        "email": 5
      },
      "avgDuration": 18.5
    }
  }
}
```

## 性能测试要求

### 数据加载性能
- **客户列表加载**: < 2秒
- **沟通历史加载**: < 1.5秒
- **统计数据生成**: < 3秒
- **报告生成时间**: < 8秒

**性能验证**:
```javascript
// 客户列表加载性能测试
const customerListLoadStart = performance.now();
await loadCustomerList({ teacherId: 201 });
const customerListLoadEnd = performance.now();
expect(customerListLoadEnd - customerListLoadStart).toBeLessThan(2000);

// 统计数据生成性能测试
const statsGenStart = performance.now();
await generateFollowUpStatistics({ period: 'month', teacherId: 201 });
const statsGenEnd = performance.now();
expect(statsGenEnd - statsGenStart).toBeLessThan(3000);
```

## 边界条件测试

### 数据量边界测试
- 大量客户同时管理（100+家长）
- 长时间跨度历史记录（2年数据）
- 复杂跟进计划（50+步骤）
- 多并发沟通记录

### 敏感信息测试
- 家长隐私数据保护
- 沟通记录加密存储
- 敏感信息访问控制

## 错误处理测试

### 数据完整性错误
- 重复沟通记录检测
- 客户信息一致性验证
- 跟进计划冲突处理

**错误处理验证**:
```javascript
// 重复记录检测测试
const duplicateCommunicationTest = async () => {
  const communicationData = {
    studentId: 101,
    method: 'phone',
    content: '测试重复记录',
    createdAt: '2024-01-15T14:30:00Z'
  };

  // 第一次记录成功
  const firstResponse = await recordCommunication(communicationData);
  expect(firstResponse.success).toBe(true);

  // 短时间内重复记录应该被检测
  const secondResponse = await recordCommunication(communicationData);
  expect(secondResponse.success).toBe(false);
  expect(secondResponse.message).toContain('重复记录');
};

// 跟进计划冲突测试
const planConflictTest = async () => {
  const plan1 = {
    studentId: 102,
    title: '计划A',
    schedule: { startDate: '2024-01-20', endDate: '2024-02-20' }
  };

  const plan2 = {
    studentId: 102,
    title: '计划B',
    schedule: { startDate: '2024-02-01', endDate: '2024-03-01' }
  };

  // 创建第一个计划
  await createFollowUpPlan(plan1);

  // 创建重叠计划应该有警告
  const response = await createFollowUpPlan(plan2);
  expect(response.data.warning).toBeTruthy();
  expect(response.data.warning).toContain('时间冲突');
};
```

## 回归测试检查点
1. 现有客户数据完整性
2. 沟通记录准确性
3. 统计分析方法一致性
4. 隐私保护措施有效性

## 测试通过标准
- 所有客户跟进操作100%功能正常
- 沟通记录准确完整
- 跟进计划有效执行
- 统计分析准确可靠
- 满意度管理完善
- 性能指标达到要求

## 相关文件
- 测试页面: `/mobile/centers/customer-pool-center/index.vue`
- API接口: `/api/customer-followup/*`
- 测试脚本: `/tests/mobile/teacher-center/TC-015.spec.js`
- 验证工具: `/tests/utils/validation-helpers.js`