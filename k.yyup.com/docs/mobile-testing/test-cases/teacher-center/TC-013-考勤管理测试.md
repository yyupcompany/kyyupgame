# TC-013: 考勤管理测试

## 测试概述
**测试目标**: 验证移动端考勤管理功能，包括学生考勤记录、异常处理、统计分析、健康监测等
**测试类型**: 功能测试 + 数据验证测试 + 异常处理测试
**优先级**: 高
**预计执行时间**: 20-25分钟

## 测试环境
- **设备**: 移动端设备 (iOS/Android)
- **浏览器**: Chrome Mobile/Safari Mobile
- **网络**: 4G/WiFi
- **用户角色**: 教师

## 前置条件
1. 用户已成功登录系统
2. 用户具有考勤管理权限
3. 系统中存在班级和学生数据
4. 移动端网络连接正常

## 测试用例详情

### TC-013-01: 日常考勤记录
**测试描述**: 验证学生日常考勤的记录、修改和查询功能

**测试步骤**:
1. 进入考勤中心页面
2. 选择当前日期和班级
3. 查看学生列表和考勤状态
4. 标记学生出勤状态（出勤、迟到、早退、请假、旷课）
5. 添加考勤备注
6. 保存考勤记录
7. 验证考勤统计更新

**预期结果**:
- ✅ 学生列表正确显示
- ✅ 考勤状态标记功能正常
- ✅ 批量操作可用
- ✅ 备注信息可添加
- ✅ 考勤数据成功保存
- ✅ 统计数据实时更新
- ✅ 历史记录可查询

**严格验证要求**:
```javascript
// 验证考勤记录界面
const validateAttendanceInterface = () => {
  const attendanceList = document.querySelector('.attendance-list');
  expect(attendanceList).toBeTruthy();

  // 验证学生列表
  const studentItems = attendanceList.querySelectorAll('.student-attendance-item');
  expect(studentItems.length).toBeGreaterThan(0);

  // 验证考勤状态按钮
  studentItems.forEach(item => {
    const statusButtons = item.querySelectorAll('.attendance-status-btn');
    expect(statusButtons.length).toBe(5); // 出勤、迟到、早退、请假、旷课

    // 验证状态值
    statusButtons.forEach(btn => {
      const status = btn.dataset.status;
      expect(['present', 'late', 'early_leave', 'leave', 'absent']).toContain(status);
    });
  });
};

// API响应验证
const validateAttendanceResponse = (response) => {
  validateRequiredFields(response.data, [
    'id', 'studentId', 'date', 'status', 'recordTime', 'recordedBy', 'notes'
  ]);

  validateFieldTypes(response.data, {
    id: 'number',
    studentId: 'number',
    date: 'string',
    status: 'string',
    recordTime: 'string',
    recordedBy: 'number',
    notes: 'string'
  });

  // 状态枚举验证
  const validStatuses = ['present', 'late', 'early_leave', 'leave', 'absent'];
  expect(validStatuses).toContain(response.data.status);

  // 日期格式验证
  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
  expect(dateRegex.test(response.data.date)).toBe(true);

  const dateTimeRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?Z?$/;
  expect(dateTimeRegex.test(response.data.recordTime)).toBe(true);
};

// 考勤统计数据验证
const validateAttendanceStats = (response) => {
  validateRequiredFields(response.data, [
    'totalStudents', 'presentCount', 'absentCount', 'lateCount', 'leaveCount',
    'attendanceRate', 'absentRate', 'lateRate'
  ]);

  validateFieldTypes(response.data, {
    totalStudents: 'number',
    presentCount: 'number',
    absentCount: 'number',
    lateCount: 'number',
    leaveCount: 'number',
    attendanceRate: 'number',
    absentRate: 'number',
    lateRate: 'number'
  });

  // 数值逻辑验证
  expect(response.data.totalStudents).toBeGreaterThan(0);
  expect(response.data.presentCount + response.data.absentCount + response.data.lateCount + response.data.leaveCount)
    .toBeLessThanOrEqual(response.data.totalStudents);

  // 百分比验证
  expect(response.data.attendanceRate).toBeBetween(0, 100);
  expect(response.data.absentRate).toBeBetween(0, 100);
  expect(response.data.lateRate).toBeBetween(0, 100);

  // 总和验证
  const totalRate = response.data.attendanceRate + response.data.absentRate + response.data.lateRate;
  expect(Math.abs(totalRate - 100)).toBeLessThan(0.1); // 允许小数点误差
};

// 考勤记录测试数据
const attendanceTestData = [
  {
    studentId: 101,
    date: '2024-01-15',
    status: 'present',
    notes: '正常到校'
  },
  {
    studentId: 102,
    date: '2024-01-15',
    status: 'late',
    notes: '迟到10分钟，交通堵塞'
  },
  {
    studentId: 103,
    date: '2024-01-15',
    status: 'leave',
    notes: '病假，已提供医院证明'
  },
  {
    studentId: 104,
    date: '2024-01-15',
    status: 'absent',
    notes: '无故缺勤，家长联系中'
  }
];
```

### TC-013-02: 异常考勤处理
**测试描述**: 验证考勤异常情况的处理流程和通知机制

**测试步骤**:
1. 标记学生异常考勤状态
2. 验证异常通知触发
3. 填写异常处理说明
4. 发送家长通知
5. 记录处理结果
6. 查看异常统计报告

**预期结果**:
- ✅ 异常状态自动识别
- ✅ 通知机制正常工作
- ✅ 处理流程可操作
- ✅ 家长通知成功发送
- ✅ 处理记录完整保存
- ✅ 异常统计准确计算

**严格验证要求**:
```javascript
// 异常考勤处理验证
const validateAbnormalAttendance = () => {
  const abnormalStatuses = ['late', 'early_leave', 'absent'];

  abnormalStatuses.forEach(status => {
    // 模拟异常状态
    const statusButton = document.querySelector(`[data-status="${status}"]`);
    statusButton.click();

    // 验证异常处理弹窗
    const abnormalDialog = document.querySelector('.abnormal-attendance-dialog');
    expect(abnormalDialog).toBeTruthy();

    // 验证必填字段
    const reasonField = abnormalDialog.querySelector('[name="reason"]');
    const actionField = abnormalDialog.querySelector('[name="action"]');
    expect(reasonField.hasAttribute('required')).toBe(true);
    expect(actionField.hasAttribute('required')).toBe(true);
  });
};

// 异常通知验证
const validateAbnormalNotification = (response) => {
  validateRequiredFields(response.data, [
    'notificationId', 'studentId', 'abnormalType', 'reason', 'sentAt',
    'parentNotified', 'followUpRequired'
  ]);

  validateFieldTypes(response.data, {
    notificationId: 'number',
    studentId: 'number',
    abnormalType: 'string',
    reason: 'string',
    sentAt: 'string',
    parentNotified: 'boolean',
    followUpRequired: 'boolean'
  });

  // 异常类型验证
  const validTypes = ['late', 'early_leave', 'absent', 'frequent_absence'];
  expect(validTypes).toContain(response.data.abnormalType);

  // 时间格式验证
  const timeRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$/;
  expect(timeRegex.test(response.data.sentAt)).toBe(true);
};

// 异常统计验证
const validateAbnormalStats = (response) => {
  validateRequiredFields(response.data, [
    'totalAbnormal', 'lateCount', 'absentCount', 'earlyLeaveCount',
    'frequentAbsentStudents', 'abnormalTrend'
  ]);

  validateFieldTypes(response.data, {
    totalAbnormal: 'number',
    lateCount: 'number',
    absentCount: 'number',
    earlyLeaveCount: 'number',
    frequentAbsentStudents: 'array',
    abnormalTrend: 'array'
  });

  // 频繁缺勤学生验证
  response.data.frequentAbsentStudents.forEach(student => {
    validateRequiredFields(student, ['studentId', 'name', 'absentCount', 'absentRate']);
    validateFieldTypes(student, {
      studentId: 'number',
      name: 'string',
      absentCount: 'number',
      absentRate: 'number'
    });
    expect(student.absentRate).toBeGreaterThan(20); // 频繁缺勤阈值
  });

  // 异常趋势验证
  response.data.abnormalTrend.forEach(trend => {
    validateRequiredFields(trend, ['date', 'abnormalCount', 'abnormalRate']);
    validateFieldTypes(trend, {
      date: 'string',
      abnormalCount: 'number',
      abnormalRate: 'number'
    });
  });
};
```

### TC-013-03: 考勤统计和报表
**测试描述**: 验证考勤数据的统计分析和报表生成功能

**测试步骤**:
1. 查看考勤统计概览
2. 按不同维度筛选数据（时间、班级、学生）
3. 查看考勤趋势图表
4. 生成考勤报表
5. 导出统计数据
6. 验证数据准确性

**预期结果**:
- ✅ 统计概览数据完整
- ✅ 筛选功能正常工作
- ✅ 趋势图表正确显示
- ✅ 报表格式符合要求
- ✅ 导出功能可用
- ✅ 数据统计准确无误

**严格验证要求**:
```javascript
// 考勤统计概览验证
const validateAttendanceOverview = (response) => {
  validateRequiredFields(response.data, [
    'todayStats', 'weekStats', 'monthStats', 'classStats', 'trendData'
  ]);

  // 今日统计验证
  validateRequiredFields(response.data.todayStats, [
    'attendanceRate', 'presentCount', 'absentCount', 'lateCount', 'leaveCount'
  ]);

  validateFieldTypes(response.data.todayStats, {
    attendanceRate: 'number',
    presentCount: 'number',
    absentCount: 'number',
    lateCount: 'number',
    leaveCount: 'number'
  });

  // 周统计验证
  validateRequiredFields(response.data.weekStats, [
    'totalDays', 'averageAttendanceRate', 'bestDay', 'worstDay'
  ]);

  validateFieldTypes(response.data.weekStats, {
    totalDays: 'number',
    averageAttendanceRate: 'number',
    bestDay: 'object',
    worstDay: 'object'
  });

  // 月统计验证
  validateRequiredFields(response.data.monthStats, [
    'totalDays', 'monthlyAttendanceRate', 'improvementRate', 'classRanking'
  ]);

  // 班级统计验证
  expect(Array.isArray(response.data.classStats)).toBe(true);
  response.data.classStats.forEach(classStat => {
    validateRequiredFields(classStat, [
      'classId', 'className', 'studentCount', 'attendanceRate', 'rank'
    ]);
    validateFieldTypes(classStat, {
      classId: 'number',
      className: 'string',
      studentCount: 'number',
      attendanceRate: 'number',
      rank: 'number'
    });
  });

  // 趋势数据验证
  expect(Array.isArray(response.data.trendData)).toBe(true);
  response.data.trendData.forEach(trend => {
    validateRequiredFields(trend, ['date', 'attendanceRate', 'abnormalRate']);
    validateFieldTypes(trend, {
      date: 'string',
      attendanceRate: 'number',
      abnormalRate: 'number'
    });
    expect(trend.attendanceRate).toBeBetween(0, 100);
    expect(trend.abnormalRate).toBeBetween(0, 100);
  });
};

// 报表生成验证
const validateAttendanceReport = (reportData) => {
  validateRequiredFields(reportData, [
    'title', 'period', 'generatedAt', 'statistics', 'charts', 'tables', 'summary'
  ]);

  validateFieldTypes(reportData, {
    title: 'string',
    period: 'string',
    generatedAt: 'string',
    statistics: 'object',
    charts: 'array',
    tables: 'array',
    summary: 'string'
  });

  // 统计数据验证
  validateRequiredFields(reportData.statistics, [
    'totalStudents', 'totalDays', 'averageAttendanceRate', 'totalAbsentDays',
    'mostAbsentStudent', 'bestAttendanceClass', 'worstAttendanceClass'
  ]);

  // 图表数据验证
  reportData.charts.forEach(chart => {
    validateRequiredFields(chart, ['type', 'title', 'data', 'options']);
    expect(['line', 'bar', 'pie', 'area']).toContain(chart.type);
  });

  // 表格数据验证
  reportData.tables.forEach(table => {
    validateRequiredFields(table, ['title', 'headers', 'rows']);
    expect(Array.isArray(table.headers)).toBe(true);
    expect(Array.isArray(table.rows)).toBe(true);
  });
};

// 数据导出验证
const validateAttendanceExport = (exportData, format) => {
  const expectedFormats = {
    'excel': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'csv': 'text/csv',
    'pdf': 'application/pdf'
  };

  expect(expectedFormats[format]).toBe(exportData.mimeType);
  expect(exportData.filename).toMatch(new RegExp(`\\.${format}$`));
  expect(exportData.size).toBeGreaterThan(0);
};
```

### TC-013-04: 健康监测集成
**测试描述**: 验证考勤与健康监测数据的集成功能

**测试步骤**:
1. 查看健康状态标签
2. 记录学生健康异常
3. 验证健康考勤关联
4. 查看健康统计报告
5. 生成健康预警
6. 处理健康异常情况

**预期结果**:
- ✅ 健康状态正确显示
- ✅ 健康异常可记录
- ✅ 考勤健康数据关联
- ✅ 健康统计准确
- ✅ 预警机制有效
- ✅ 异常处理流程完整

**严格验证要求**:
```javascript
// 健康监测界面验证
const validateHealthMonitoring = () => {
  const healthSection = document.querySelector('.health-monitoring-section');
  expect(healthSection).toBeTruthy();

  // 验证健康状态标签
  const healthStatuses = healthSection.querySelectorAll('.health-status');
  expect(healthStatuses.length).toBeGreaterThan(0);

  healthStatuses.forEach(status => {
    const statusType = status.dataset.type;
    expect(['healthy', 'sick', 'injured', 'under_observation']).toContain(statusType);

    const statusText = status.querySelector('.status-text');
    const statusColor = status.querySelector('.status-indicator');
    expect(statusText).toBeTruthy();
    expect(statusColor).toBeTruthy();
  });

  // 验证健康记录表单
  const healthForm = document.querySelector('.health-record-form');
  expect(healthForm).toBeTruthy();

  const healthFields = ['healthStatus', 'symptoms', 'temperature', 'medication'];
  healthFields.forEach(field => {
    const fieldElement = healthForm.querySelector(`[name="${field}"]`);
    expect(fieldElement).toBeTruthy();
  });
};

// 健康数据验证
const validateHealthData = (response) => {
  validateRequiredFields(response.data, [
    'studentId', 'date', 'healthStatus', 'symptoms', 'temperature', 'notes'
  ]);

  validateFieldTypes(response.data, {
    studentId: 'number',
    date: 'string',
    healthStatus: 'string',
    symptoms: 'array',
    temperature: 'number',
    notes: 'string'
  });

  // 健康状态枚举验证
  const validHealthStatuses = ['healthy', 'sick', 'injured', 'under_observation'];
  expect(validHealthStatuses).toContain(response.data.healthStatus);

  // 症状数据验证
  expect(Array.isArray(response.data.symptoms)).toBe(true);
  response.data.symptoms.forEach(symptom => {
    validateRequiredFields(symptom, ['name', 'severity', 'duration']);
    validateFieldTypes(symptom, {
      name: 'string',
      severity: 'string',
      duration: 'string'
    });
    expect(['mild', 'moderate', 'severe']).toContain(symptom.severity);
  });

  // 体温范围验证
  if (response.data.temperature) {
    expect(response.data.temperature).toBeBetween(35.0, 42.0);
  }
};

// 健康统计验证
const validateHealthStats = (response) => {
  validateRequiredFields(response.data, [
    'totalStudents', 'healthyCount', 'sickCount', 'injuredCount',
    'observationCount', 'averageTemperature', 'healthAlerts'
  ]);

  validateFieldTypes(response.data, {
    totalStudents: 'number',
    healthyCount: 'number',
    sickCount: 'number',
    injuredCount: 'number',
    observationCount: 'number',
    averageTemperature: 'number',
    healthAlerts: 'array'
  });

  // 数值逻辑验证
  const totalHealthStatus = response.data.healthyCount + response.data.sickCount +
                           response.data.injuredCount + response.data.observationCount;
  expect(totalHealthStatus).toBeLessThanOrEqual(response.data.totalStudents);

  // 体温验证
  expect(response.data.averageTemperature).toBeBetween(36.0, 38.0);

  // 健康预警验证
  response.data.healthAlerts.forEach(alert => {
    validateRequiredFields(alert, ['type', 'severity', 'message', 'affectedStudents']);
    validateFieldTypes(alert, {
      type: 'string',
      severity: 'string',
      message: 'string',
      affectedStudents: 'array'
    });
    expect(['temperature', 'contagious', 'injury', 'medication']).toContain(alert.type);
    expect(['low', 'medium', 'high', 'critical']).toContain(alert.severity);
  });
};
```

### TC-013-05: 批量考勤操作
**测试描述**: 验证批量考勤操作的功能和效率

**测试步骤**:
1. 选择多个学生
2. 批量设置考勤状态
3. 批量添加备注
4. 批量发送通知
5. 批量导出记录
6. 验证批量操作结果

**预期结果**:
- ✅ 多选功能正常工作
- ✅ 批量操作高效执行
- ✅ 操作结果准确记录
- ✅ 批量通知成功发送
- ✅ 批量导出格式正确
- ✅ 数据一致性保证

**严格验证要求**:
```javascript
// 批量操作界面验证
const validateBatchOperations = () => {
  const batchSection = document.querySelector('.batch-operations-section');
  expect(batchSection).toBeTruthy();

  // 验证全选功能
  const selectAllCheckbox = batchSection.querySelector('.select-all-checkbox');
  expect(selectAllCheckbox).toBeTruthy();

  // 验证批量操作按钮
  const batchButtons = batchSection.querySelectorAll('.batch-action-btn');
  expect(batchButtons.length).toBeGreaterThan(0);

  batchButtons.forEach(btn => {
    const action = btn.dataset.action;
    expect(['present', 'absent', 'leave', 'notify', 'export']).toContain(action);
  });
};

// 批量操作API验证
const validateBatchOperationResponse = (response) => {
  validateRequiredFields(response.data, [
    'operationId', 'operationType', 'affectedCount', 'successCount',
    'failedCount', 'results', 'executedAt'
  ]);

  validateFieldTypes(response.data, {
    operationId: 'number',
    operationType: 'string',
    affectedCount: 'number',
    successCount: 'number',
    failedCount: 'number',
    results: 'array',
    executedAt: 'string'
  });

  // 操作结果验证
  expect(response.data.successCount + response.data.failedCount)
    .toBe(response.data.affectedCount);

  // 结果详情验证
  response.data.results.forEach(result => {
    validateRequiredFields(result, ['studentId', 'success', 'message']);
    validateFieldTypes(result, {
      studentId: 'number',
      success: 'boolean',
      message: 'string'
    });
  });
};

// 批量导出验证
const validateBatchExport = (exportData) => {
  validateRequiredFields(exportData, [
    'filename', 'mimeType', 'size', 'recordsCount', 'exportTime'
  ]);

  validateFieldTypes(exportData, {
    filename: 'string',
    mimeType: 'string',
    size: 'number',
    recordsCount: 'number',
    exportTime: 'string'
  });

  expect(exportData.size).toBeGreaterThan(0);
  expect(exportData.recordsCount).toBeGreaterThan(0);
  expect(exportData.filename).toMatch(/\.(xlsx|csv|pdf)$/);
};
```

## API接口测试

### POST /api/attendance/record
**请求体**:
```json
{
  "date": "2024-01-15",
  "classId": 2,
  "records": [
    {
      "studentId": 101,
      "status": "present",
      "notes": "正常到校"
    },
    {
      "studentId": 102,
      "status": "late",
      "notes": "迟到10分钟"
    }
  ]
}
```

**成功响应**:
```json
{
  "success": true,
  "data": {
    "recordedCount": 2,
    "successCount": 2,
    "failedCount": 0,
    "stats": {
      "presentCount": 1,
      "lateCount": 1,
      "attendanceRate": 100
    }
  },
  "message": "考勤记录成功"
}
```

### GET /api/attendance/statistics
**查询参数**: `?classId=2&startDate=2024-01-01&endDate=2024-01-31`

**成功响应**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalDays": 22,
      "averageAttendanceRate": 95.5,
      "bestDay": { "date": "2024-01-10", "rate": 100 },
      "worstDay": { "date": "2024-01-15", "rate": 85 }
    },
    "classStats": [
      {
        "classId": 2,
        "className": "中班A班",
        "studentCount": 25,
        "attendanceRate": 95.5,
        "rank": 1
      }
    ],
    "trendData": [
      { "date": "2024-01-01", "attendanceRate": 100, "abnormalRate": 0 }
    ]
  }
}
```

### POST /api/attendance/health-record
**请求体**:
```json
{
  "studentId": 103,
  "date": "2024-01-15",
  "healthStatus": "sick",
  "symptoms": [
    { "name": "发烧", "severity": "moderate", "duration": "2天" },
    { "name": "咳嗽", "severity": "mild", "duration": "1天" }
  ],
  "temperature": 37.8,
  "notes": "家长已告知，请假休息"
}
```

## 性能测试要求

### 数据加载性能
- **考勤列表加载**: < 1.5秒
- **统计数据生成**: < 2秒
- **报表生成时间**: < 5秒
- **批量操作响应**: < 3秒

**性能验证**:
```javascript
// 考勤列表加载性能测试
const listLoadStart = performance.now();
await loadAttendanceList({ classId: 2, date: '2024-01-15' });
const listLoadEnd = performance.now();
expect(listLoadEnd - listLoadStart).toBeLessThan(1500);

// 批量操作性能测试
const batchStart = performance.now();
await batchUpdateAttendance({
  studentIds: [101, 102, 103, 104],
  status: 'present'
});
const batchEnd = performance.now();
expect(batchEnd - batchStart).toBeLessThan(3000);
```

## 边界条件测试

### 数据量边界测试
- 大量学生同时考勤（50+人）
- 长时间跨度统计数据（1年）
- 大批量导出数据（1000+记录）
- 并发考勤操作处理

### 时间边界测试
- 跨月考勤记录
- 历史数据迁移
- 时区转换处理
- 夏令时调整

## 错误处理测试

### 数据一致性错误
- 重复考勤记录检测
- 时间冲突处理
- 数据同步失败恢复
- 事务回滚验证

**错误处理验证**:
```javascript
// 重复记录检测测试
const duplicateRecordTest = async () => {
  const recordData = {
    studentId: 101,
    date: '2024-01-15',
    status: 'present'
  };

  // 第一次记录
  const firstResponse = await recordAttendance(recordData);
  expect(firstResponse.success).toBe(true);

  // 第二次记录同一天同一学生
  const secondResponse = await recordAttendance(recordData);
  expect(secondResponse.success).toBe(false);
  expect(secondResponse.message).toContain('已存在考勤记录');
};

// 数据同步失败测试
const syncFailureTest = async () => {
  // 模拟网络错误
  const originalFetch = window.fetch;
  window.fetch = () => Promise.reject(new Error('Network error'));

  const response = await recordAttendance({
    studentId: 102,
    date: '2024-01-15',
    status: 'present'
  });

  // 验证离线存储
  const offlineData = localStorage.getItem('attendanceOfflineData');
  expect(offlineData).toBeTruthy();

  // 恢复网络
  window.fetch = originalFetch;
};
```

## 回归测试检查点
1. 现有考勤数据完整性
2. 统计算法准确性
3. 报表格式兼容性
4. 性能指标稳定性

## 测试通过标准
- 所有考勤操作100%功能正常
- 数据统计准确无误
- 异常处理机制完善
- 批量操作高效稳定
- 健康监测集成正常
- 性能指标达到要求

## 相关文件
- 测试页面: `/mobile/centers/attendance-center/index.vue`
- API接口: `/api/attendance/*`
- 测试脚本: `/tests/mobile/teacher-center/TC-013.spec.js`
- 验证工具: `/tests/utils/validation-helpers.js`