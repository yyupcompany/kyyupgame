# 语音合成模型双向配置说明文档

## 📋 概述

本文档详细介绍了幼儿园管理系统中媒体中心视频制作功能的语音合成（配音）模块的双向配置方案，包括前端界面配置、后端服务配置和火山引擎TTS V3双向流式WebSocket服务的完整集成方案。

## 🎯 功能定位

语音合成功能是媒体中心视频制作模块的核心组成部分，为视频内容提供专业级配音服务，支持多种音色选择、语速调节和实时预览功能。

**访问路径**：园长中心 → 媒体中心 → AI文字转语音

## 🏗️ 系统架构

### 前端架构
```
媒体中心页面 (MediaCenter.vue)
└── AI文字转语音 (TextToSpeech.vue)
    ├── 配置面板
    │   ├── 文本输入区
    │   ├── 音色选择器
    │   ├── 语速调节器
    │   └── 格式选择器
    ├── 预览面板
    │   ├── 音频播放器
    │   ├── 下载功能
    │   └── 重新生成
    └── 快速模板
        └── 预设场景模板
```

### 后端架构
```
语音合成服务
├── AI Bridge 统一接口 (/ai/text-to-speech)
├── TTS V3 双向流式服务
│   ├── WebSocket连接管理
│   ├── 协议帧构建与解析
│   └── 音频流处理
└── 模型配置管理
    └── 数据库配置存储
```

## 🔧 配置方案

### 1. 前端配置

#### 1.1 基础配置
```typescript
// 表单数据结构
interface TTSFormData {
  text: string;              // 文本内容（最多4096字符）
  voice: string;             // 音色ID
  speed: number;             // 语速（0.25x - 4.0x）
  format: string;            // 输出格式（mp3/opus/aac/flac）
}
```

#### 1.2 音色配置
系统提供6大类音色选择，每类包含多个专业音色：

| 音色类别 | 音色示例 | 适用场景 | 特点描述 |
|---------|---------|---------|---------|
| 🎓 教育场景 | Tina老师、少儿故事、天才童声 | 教学视频、儿童内容 | 专业教育音色，亲和力强 |
| 👶 儿童音色 | 佩奇猪、熊二、樱桃丸子 | 卡通内容、儿童故事 | 活泼可爱，符合角色特征 |
| 🎭 通用场景 | 灿灿、淳厚、清新 | 通用配音、宣传视频 | 自然流畅，适用性广 |
| 📢 播报解说 | 磁性解说、悬疑解说、广告解说 | 纪录片、广告宣传 | 专业磁性，感染力强 |
| 🎨 特色音色 | 顾姐、四郎、俏皮女声 | 特色内容、个性化配音 | 独特风格，记忆点强 |
| 🌟 经典音色 | 女声-温柔、男声-沉稳 | 传统配音、标准播报 | 经典稳定，兼容性好 |

#### 1.3 快速模板配置
```typescript
const quickTemplates = [
  {
    id: 1,
    title: '招生宣传语音',
    description: '幼儿园招生宣传语音',
    data: {
      text: '亲爱的家长朋友们，我们幼儿园春季招生火热进行中！...',
      voice: 'zh_female_cancan_mars_bigtts',
      speed: 1.0,
      format: 'mp3'
    }
  },
  // ... 更多模板
];
```

### 2. 后端配置

#### 2.1 AI Bridge 统一接口
```typescript
// API端点配置
POST /ai/text-to-speech

// 请求参数
interface TTSRequest {
  text: string;
  voice?: string;
  speed?: number;
  format?: string;
}

// 响应格式
// 直接返回音频文件流 (Content-Type: audio/mp3)
```

#### 2.2 TTS V3 双向流式服务配置

**核心配置参数**：
```typescript
interface TTSV3BidirectionConfig {
  appKey: string;           // 应用密钥
  accessKey: string;        // 访问密钥
  resourceId?: string;      // 资源ID
  wsUrl?: string;          // WebSocket端点
}

// 默认配置
const defaultConfig = {
  appKey: '7563592522',
  accessKey: 'jq3vA4Ep5EsN-FU4mKizV6ePioXR3Ol3',
  resourceId: 'volc.service_type.10029',
  wsUrl: 'wss://openspeech.bytedance.com/api/v3/tts/bidirection'
};
```

**数据库配置**：
```sql
-- TTS模型配置
INSERT INTO ai_models (
  name, display_name, model_type, provider, 
  endpoint, config, description, is_active
) VALUES (
  'volcengine-tts-v3-bidirection',
  '火山引擎TTS V3双向流式',
  'tts',
  'Volcengine',
  'wss://openspeech.bytedance.com/api/v3/tts/bidirection',
  '{"appKey":"7563592522","accessKey":"jq3vA4Ep5EsN-FU4mKizV6ePioXR3Ol3","resourceId":"volc.service_type.10029","speaker":"zh_female_cancan_mars_bigtts","format":"mp3","sampleRate":24000}',
  '火山引擎TTS V3双向流式WebSocket服务，支持实时流式传输和在线语音交互',
  1
);
```

## 🔄 双向流式协议

### 1. 连接建立流程
```
客户端                    火山引擎服务
   │                           │
   ├─ START_CONNECTION ───────►│
   │◄── CONNECTION_STARTED ────┤
   │                           │
   ├─ START_SESSION ──────────►│
   │◄── SESSION_STARTED ───────┤
   │                           │
   ├─ TASK_REQUEST ───────────►│
   │◄── TTS_SENTENCE_START ────┤
   │◄── TTS_RESPONSE (音频) ───►│
   │◄── TTS_SENTENCE_END ──────┤
   │                           │
   ├─ FINISH_SESSION ─────────►│
   │◄── SESSION_FINISHED ──────┤
   │                           │
   ├─ FINISH_CONNECTION ─────►│
   │◄── CONNECTION_FINISHED ───┤
   │                           │
```

### 2. 协议帧结构
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│   Header    │ Event Num   │ Payload Size│   Payload   │
│   (4字节)   │   (4字节)   │   (4字节)   │ (变长)      │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

**Header字段说明**：
- Bit 7-4: 协议版本 (0001)
- Bit 3-0: Header大小 (0001 = 4字节)
- Bit 7-4: 消息类型 (0001 = 完整消息)
- Bit 3-0: 标志位 (0100 = 包含事件号)
- Bit 7-4: 序列化方式 (0001 = JSON)
- Bit 3-0: 压缩方式 (0000 = 无压缩)

### 3. 事件类型定义
```typescript
enum Event {
  // 连接管理
  START_CONNECTION = 1,
  FINISH_CONNECTION = 2,
  CONNECTION_STARTED = 50,
  CONNECTION_FAILED = 51,
  CONNECTION_FINISHED = 52,
  
  // 会话管理
  START_SESSION = 100,
  FINISH_SESSION = 102,
  SESSION_STARTED = 150,
  SESSION_FINISHED = 152,
  SESSION_FAILED = 153,
  
  // 任务处理
  TASK_REQUEST = 200,
  
  // TTS事件
  TTS_SENTENCE_START = 350,
  TTS_SENTENCE_END = 351,
  TTS_RESPONSE = 352
}
```

## 🎛️ 高级配置

### 1. 音频参数配置
```typescript
interface AudioParams {
  format: 'mp3' | 'pcm' | 'wav';     // 音频格式
  sampleRate: number;                 // 采样率（默认24000）
  speedRatio: number;                 // 语速比例（0.25-4.0）
  volumeRatio: number;                // 音量比例（0.0-2.0）
  emotion?: string;                   // 情感参数（可选）
}
```

### 2. 批量处理配置
```typescript
// 批量文本转语音
async batchTextToSpeech(
  texts: string[], 
  options?: Partial<TTSV3BidirectionRequest>
): Promise<TTSV3BidirectionResponse[]>

// 使用示例
const results = await volcengineTTSV3BidirectionService.batchTextToSpeech([
  '第一段文本',
  '第二段文本',
  '第三段文本'
], {
  speaker: 'zh_female_cancan_mars_bigtts',
  speedRatio: 1.2,
  format: 'mp3'
});
```

### 3. 实时预览配置
```typescript
// 音色预览功能
const previewVoice = async (voice: VoiceOption) => {
  try {
    previewingVoice.value = voice.value;
    
    // 限制预览文本长度（最多10秒）
    const previewText = voice.previewText?.substring(0, 100);
    
    const response = await request.post('/ai/text-to-speech', {
      text: previewText,
      voice: voice.value,
      speed: 1.0,
      format: 'mp3'
    }, {
      responseType: 'blob'
    });
    
    // 创建临时音频并播放
    const audio = new Audio(URL.createObjectURL(response));
    await audio.play();
    
    // 10秒后自动停止
    setTimeout(() => audio.pause(), 10000);
    
  } catch (error) {
    console.error('预览失败:', error);
  }
};
```

## 🛠️ 部署配置

### 1. 环境变量配置
```bash
# .env 文件配置
VOLCENGINE_TTS_APP_KEY=7563592522
VOLCENGINE_TTS_ACCESS_KEY=jq3vA4Ep5EsN-FU4mKizV6ePioXR3Ol3
VOLCENGINE_TTS_RESOURCE_ID=volc.service_type.10029
VOLCENGINE_TTS_WS_URL=wss://openspeech.bytedance.com/api/v3/tts/bidirection
```

### 2. 服务启动配置
```json
// package.json 脚本配置
{
  "scripts": {
    "dev:backend": "npm run compile && npm run start:old",
    "start:backend": "cross-env NODE_ENV=development npm run start:old",
    "dev:all": "concurrently \"npm run start:backend\" \"npm run start:frontend\""
  }
}
```

### 3. 依赖包配置
```json
// 服务端依赖
{
  "dependencies": {
    "ws": "^8.18.2",
    "crypto": "^1.0.1",
    "uuid": "^11.1.0"
  }
}

// 前端依赖
{
  "dependencies": {
    "element-plus": "^2.2.16",
    "@element-plus/icons-vue": "^2.1.0"
  }
}
```

## 🔍 监控与调试

### 1. 日志配置
```typescript
// 详细日志输出
console.log(`🔊 [TTS V3 Bidirection] 开始合成: ${text.substring(0, 50)}...`);
console.log(`🔗 [TTS V3 Bidirection] WebSocket连接成功`);
console.log(`📦 [TTS V3 Bidirection] 收到音频数据: ${audioData.length} bytes`);
console.log(`✅ [TTS V3 Bidirection] 合成成功: ${audioBuffer.length} bytes`);
```

### 2. 错误处理
```typescript
// 超时处理
const timeout = setTimeout(() => {
  if (!hasError) {
    hasError = true;
    ws.close();
    reject(new Error('TTS请求超时（30秒）'));
  }
}, 30000);

// 连接错误处理
ws.on('error', (error: any) => {
  hasError = true;
  clearTimeout(timeout);
  console.error(`❌ [TTS V3 Bidirection] WebSocket错误:`, error.message);
  reject(new Error(`WebSocket错误: ${error.message}`));
});
```

### 3. 性能监控
```typescript
// 批量处理性能监控
console.time('batchTTS');
const results = await batchTextToSpeech(texts, options);
console.timeEnd('batchTTS');
console.log(`📊 批量处理完成: ${results.length} 条，平均耗时: ${totalTime / results.length}ms/条`);
```

## 📋 配置检查清单

### ✅ 前端配置检查
- [ ] TextToSpeech.vue 组件正确配置
- [ ] 音色列表完整加载
- [ ] 表单验证规则正确
- [ ] 音频播放器功能正常
- [ ] 下载功能正常工作
- [ ] 预览功能正常

### ✅ 后端配置检查
- [ ] AI Bridge 接口正常响应
- [ ] TTS V3 双向服务正常启动
- [ ] WebSocket连接建立成功
- [ ] 数据库配置正确加载
- [ ] 错误处理机制完善

### ✅ 火山引擎配置检查
- [ ] AppKey 和 AccessKey 有效
- [ ] 资源ID权限正确
- [ ] WebSocket端点可达
- [ ] 协议帧构建正确
- [ ] 音频数据接收正常

## 🚀 使用指南

### 1. 基础使用流程
1. 访问：园长中心 → 媒体中心 → AI文字转语音
2. 输入要转换的文本内容（最多4096字符）
3. 选择合适的音色（支持试听预览）
4. 调节语速（0.25x - 4.0x）
5. 选择输出格式（推荐MP3）
6. 点击"生成语音"按钮
7. 预览生成的音频并下载

### 2. 高级功能使用
- **快速模板**：选择预设模板快速生成
- **批量处理**：支持多段文本批量转换
- **实时预览**：音色试听功能，选择最适合的音色
- **格式选择**：根据需要选择不同的音频格式

### 3. 故障排除
- **连接失败**：检查网络和火山引擎服务状态
- **音频质量**：调整音色和语速参数
- **格式兼容**：选择合适的音频格式
- **权限问题**：确认火山引擎账户权限

## 📈 性能优化

### 1. 前端优化
- 音频懒加载和缓存
- 组件按需加载
- 音频预览限制时长（10秒）
- 防抖处理用户输入

### 2. 后端优化
- WebSocket连接池管理
- 音频数据流式处理
- 批量请求并发控制
- 内存使用优化

### 3. 网络优化
- 音频压缩和格式优化
- CDN加速音频文件下载
- 连接复用和keep-alive
- 错误重试机制

---

## 📞 技术支持

如遇到配置问题或技术故障，请联系：
- 技术支持团队
- 查看系统日志：`/logs/tts-service.log`
- 参考官方文档：火山引擎TTS V3开发指南

**文档版本**：v1.0  
**更新日期**：2025年10月5日  
**维护人员**：iFlow CLI