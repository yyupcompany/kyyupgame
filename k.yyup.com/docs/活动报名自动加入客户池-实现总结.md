# æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ±  - å®ç°æ€»ç»“

## ğŸ“‹ éœ€æ±‚å›é¡¾

### æ ¸å¿ƒéœ€æ±‚
1. âœ… **åˆ†äº«é“¾æ¥è¿½è¸ª** - å›­é•¿/è€å¸ˆåˆ†äº«æ´»åŠ¨æ—¶ï¼Œé“¾æ¥å¸¦æœ‰åˆ†äº«è€…ID
2. âœ… **æ¥æºæ¸…æ™°è®°å½•** - è®°å½•å®¢æˆ·æ¥æºï¼ˆçº¿ä¸Š/çº¿ä¸‹ã€æ´»åŠ¨/æ¨è/è‡ªæ·»åŠ ç­‰ï¼‰
3. âœ… **è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± ** - æ´»åŠ¨æŠ¥ååè‡ªåŠ¨åˆ›å»ºå®¢æˆ·è®°å½•
4. âœ… **è‡ªåŠ¨åˆ†é…** - è‡ªåŠ¨åˆ†é…ç»™åˆ†äº«é“¾æ¥çš„è€å¸ˆ
5. âœ… **è€å¸ˆå®¢æˆ·è·Ÿè¸ª** - è€å¸ˆåœ¨è‡ªå·±çš„é¡µé¢ç®¡ç†å®¢æˆ·ï¼ˆå·²æœ‰åŠŸèƒ½ï¼‰

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. activity_registrations è¡¨ï¼ˆæ´»åŠ¨æŠ¥åè¡¨ï¼‰

**æ–°å¢å­—æ®µ**ï¼š
```sql
share_by INT                -- åˆ†äº«è€…IDï¼ˆè€å¸ˆæˆ–å›­é•¿ï¼‰
share_type VARCHAR(20)      -- åˆ†äº«ç±»å‹: teacher/principal/wechat/qrcode
source_type VARCHAR(50)     -- æ¥æºç±»å‹: ACTIVITY_ONLINE/ACTIVITY_OFFLINEç­‰
source_detail JSON          -- æ¥æºè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
auto_assigned BOOLEAN       -- æ˜¯å¦è‡ªåŠ¨åˆ†é…ç»™è€å¸ˆ
```

**ç´¢å¼•**ï¼š
- `idx_activity_registrations_share_by` - åˆ†äº«è€…IDç´¢å¼•
- `idx_activity_registrations_source_type` - æ¥æºç±»å‹ç´¢å¼•

---

### 2. teacher_customers è¡¨ï¼ˆè€å¸ˆå®¢æˆ·è¡¨ï¼‰

**æ–°å¢å­—æ®µ**ï¼š
```sql
source_type VARCHAR(50)     -- æ¥æºç±»å‹
source_id INT               -- æ¥æºIDï¼ˆæ´»åŠ¨IDã€æŠ¥åIDç­‰ï¼‰
source_detail JSON          -- æ¥æºè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
auto_assigned BOOLEAN       -- æ˜¯å¦è‡ªåŠ¨åˆ†é…
```

**ç´¢å¼•**ï¼š
- `idx_teacher_customers_source_type` - æ¥æºç±»å‹ç´¢å¼•
- `idx_teacher_customers_source_id` - æ¥æºIDç´¢å¼•

---

## ğŸ”— åˆ†äº«é“¾æ¥è®¾è®¡

### é“¾æ¥æ ¼å¼
```
https://localhost:5173/activity/register/{activityId}?shareBy={teacherId}&shareType={type}
```

### å‚æ•°è¯´æ˜
| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `activityId` | æ´»åŠ¨ID | 123 |
| `shareBy` | åˆ†äº«è€…IDï¼ˆè€å¸ˆæˆ–å›­é•¿çš„ç”¨æˆ·IDï¼‰ | 456 |
| `shareType` | åˆ†äº«ç±»å‹ | teacher/principal/wechat/qrcode |

### ç¤ºä¾‹é“¾æ¥
```
# è€å¸ˆå¼ ä¸‰åˆ†äº«
https://localhost:5173/activity/register/123?shareBy=456&shareType=teacher

# å›­é•¿åˆ†äº«
https://localhost:5173/activity/register/123?shareBy=789&shareType=principal

# äºŒç»´ç æ‰«æ
https://localhost:5173/activity/register/123?shareBy=456&shareType=qrcode
```

---

## ğŸ¯ æ¥æºç±»å‹å®šä¹‰

### CustomerSourceType æšä¸¾
```typescript
export enum CustomerSourceType {
  ACTIVITY_ONLINE = 'ACTIVITY_ONLINE',           // çº¿ä¸Šæ´»åŠ¨æŠ¥å
  ACTIVITY_OFFLINE = 'ACTIVITY_OFFLINE',         // çº¿ä¸‹æ´»åŠ¨æŠ¥å
  TEACHER_REFERRAL = 'TEACHER_REFERRAL',         // è€å¸ˆæ¨è
  TEACHER_SELF_ADD = 'TEACHER_SELF_ADD',         // è€å¸ˆè‡ªå·±æ·»åŠ 
  PRINCIPAL_ADD = 'PRINCIPAL_ADD',               // å›­é•¿æ·»åŠ 
  WEBSITE_INQUIRY = 'WEBSITE_INQUIRY',           // ç½‘ç«™å’¨è¯¢
  PHONE_INQUIRY = 'PHONE_INQUIRY',               // ç”µè¯å’¨è¯¢
  WECHAT_INQUIRY = 'WECHAT_INQUIRY',             // å¾®ä¿¡å’¨è¯¢
  OTHER = 'OTHER'                                // å…¶ä»–
}
```

### SourceDetail æ•°æ®ç»“æ„
```typescript
interface SourceDetail {
  // æ´»åŠ¨ç›¸å…³
  activityId?: number;
  activityTitle?: string;
  activityType?: string;
  registrationId?: number;
  registrationTime?: string;
  
  // åˆ†äº«ç›¸å…³
  shareBy?: number;
  shareByName?: string;
  shareType?: string;
  shareTime?: string;
  
  // æ¨èç›¸å…³
  referrerTeacherId?: number;
  referrerTeacherName?: string;
  referralReason?: string;
  
  // å…¶ä»–ä¿¡æ¯
  channel?: string;
  remark?: string;
}
```

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### å®Œæ•´æµç¨‹å›¾
```
1. å›­é•¿/è€å¸ˆç”Ÿæˆåˆ†äº«é“¾æ¥
   â†“
2. é“¾æ¥å¸¦æœ‰ shareBy å’Œ shareType å‚æ•°
   â†“
3. å®¶é•¿ç‚¹å‡»é“¾æ¥ï¼Œè¿›å…¥æ´»åŠ¨æŠ¥åé¡µé¢
   â†“
4. é¡µé¢è‡ªåŠ¨è·å– shareBy å’Œ shareType å‚æ•°
   â†“
5. å®¶é•¿å¡«å†™æŠ¥åè¡¨å•
   â†“
6. æäº¤æŠ¥åï¼ˆåŒ…å« shareBy å’Œ shareTypeï¼‰
   â†“
7. åç«¯åˆ›å»º ActivityRegistration è®°å½•
   â†“
8. ã€è‡ªåŠ¨è§¦å‘ã€‘æ£€æŸ¥å®¢æˆ·æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡æ‰‹æœºå·ï¼‰
   â”œâ”€ å·²å­˜åœ¨ â†’ æ·»åŠ è·Ÿè¿›è®°å½• + å…³è”æ´»åŠ¨
   â””â”€ ä¸å­˜åœ¨ â†’ åˆ›å»ºå®¢æˆ·è®°å½•åˆ° teacher_customers è¡¨
   â†“
9. ã€è‡ªåŠ¨åˆ†é…ã€‘åˆ†é…ç»™ shareBy æŒ‡å®šçš„è€å¸ˆ
   â†“
10. ã€é€šçŸ¥è€å¸ˆã€‘å‘é€æ–°å®¢æˆ·é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
   â†“
11. è€å¸ˆåœ¨"å®¢æˆ·è·Ÿè¸ª"é¡µé¢æŸ¥çœ‹å’Œç®¡ç†
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### å·²åˆ›å»ºçš„æ–‡ä»¶

| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `docs/æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± æ–¹æ¡ˆ.md` | æ–‡æ¡£ | å®Œæ•´æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£ |
| `docs/æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± -å®ç°æ€»ç»“.md` | æ–‡æ¡£ | å®ç°æ€»ç»“æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰ |
| `server/src/migrations/20250105-add-customer-source-tracking.js` | è¿ç§» | æ•°æ®åº“è¿ç§»æ–‡ä»¶ |

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| `server/src/models/activity-registration.model.ts` | æ·»åŠ æ–°å­—æ®µå®šä¹‰ | P0 |
| `server/src/services/activity/activity-registration.service.ts` | å®ç°è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± é€»è¾‘ | P0 |
| `client/src/pages/activity/ActivityRegister.vue` | è·å–åˆ†äº«å‚æ•°å¹¶æäº¤ | P0 |
| `client/src/pages/activity/ActivityDetail.vue` | ç”Ÿæˆåˆ†äº«é“¾æ¥åŠŸèƒ½ | P1 |
| `client/src/api/modules/activity.ts` | æ›´æ–°APIæ¥å£ç±»å‹ | P1 |

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1: è¿è¡Œæ•°æ®åº“è¿ç§» âœ…
```bash
cd server
npx sequelize-cli db:migrate
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… `activity_registrations` è¡¨æ·»åŠ 5ä¸ªæ–°å­—æ®µ
- âœ… `teacher_customers` è¡¨æ·»åŠ 4ä¸ªæ–°å­—æ®µ
- âœ… æ·»åŠ 4ä¸ªç´¢å¼•

---

### æ­¥éª¤2: æ›´æ–° ActivityRegistration æ¨¡å‹ â³

**æ–‡ä»¶**: `server/src/models/activity-registration.model.ts`

**éœ€è¦æ·»åŠ **ï¼š
```typescript
// åœ¨ç±»å®šä¹‰ä¸­æ·»åŠ 
declare shareBy: number | null;
declare shareType: string | null;
declare sourceType: string | null;
declare sourceDetail: any | null;
declare autoAssigned: CreationOptional<boolean>;

// åœ¨ initActivityRegistration ä¸­æ·»åŠ å­—æ®µå®šä¹‰
shareBy: {
  type: DataTypes.INTEGER,
  allowNull: true,
  comment: 'åˆ†äº«è€…IDï¼ˆè€å¸ˆæˆ–å›­é•¿ï¼‰',
},
shareType: {
  type: DataTypes.STRING(20),
  allowNull: true,
  comment: 'åˆ†äº«ç±»å‹: teacher/principal/wechat/qrcode',
},
sourceType: {
  type: DataTypes.STRING(50),
  allowNull: true,
  comment: 'æ¥æºç±»å‹',
},
sourceDetail: {
  type: DataTypes.JSON,
  allowNull: true,
  comment: 'æ¥æºè¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰',
},
autoAssigned: {
  type: DataTypes.BOOLEAN,
  allowNull: false,
  defaultValue: false,
  comment: 'æ˜¯å¦è‡ªåŠ¨åˆ†é…ç»™è€å¸ˆ',
},
```

---

### æ­¥éª¤3: å®ç°è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± æœåŠ¡ â³

**æ–‡ä»¶**: `server/src/services/activity/activity-registration.service.ts`

**éœ€è¦æ·»åŠ çš„æ–¹æ³•**ï¼š

1. `determineSourceType()` - ç¡®å®šæ¥æºç±»å‹
2. `addToCustomerPool()` - è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 
3. ä¿®æ”¹ `createRegistration()` - è°ƒç”¨è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 

**è¯¦ç»†ä»£ç **: å‚è§ `docs/æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± æ–¹æ¡ˆ.md` ç¬¬7èŠ‚

---

### æ­¥éª¤4: å‰ç«¯è·å–åˆ†äº«å‚æ•° â³

**æ–‡ä»¶**: `client/src/pages/activity/ActivityRegister.vue`

**éœ€è¦æ·»åŠ **ï¼š
```typescript
import { useRoute } from 'vue-router';

const route = useRoute();
const shareBy = ref<number | null>(null);
const shareType = ref<string | null>(null);

onMounted(() => {
  shareBy.value = route.query.shareBy ? Number(route.query.shareBy) : null;
  shareType.value = route.query.shareType as string || null;
});

// æäº¤æ—¶åŒ…å«åˆ†äº«å‚æ•°
const submitRegistration = async () => {
  const data = {
    // ... å…¶ä»–å­—æ®µ
    shareBy: shareBy.value,
    shareType: shareType.value
  };
  await createActivityRegistration(data);
};
```

---

### æ­¥éª¤5: ç”Ÿæˆåˆ†äº«é“¾æ¥åŠŸèƒ½ â³

**æ–‡ä»¶**: `client/src/pages/activity/ActivityDetail.vue`

**éœ€è¦æ·»åŠ **ï¼š
```typescript
import { useUserStore } from '@/stores/user';

const userStore = useUserStore();

// ç”Ÿæˆåˆ†äº«é“¾æ¥
const generateShareLink = (activityId: number, shareType: string = 'teacher') => {
  const baseUrl = 'https://localhost:5173/activity/register';
  const userId = userStore.user?.id;
  return `${baseUrl}/${activityId}?shareBy=${userId}&shareType=${shareType}`;
};

// å¤åˆ¶åˆ†äº«é“¾æ¥
const copyShareLink = () => {
  const link = generateShareLink(activityId.value, 'teacher');
  navigator.clipboard.writeText(link);
  ElMessage.success('åˆ†äº«é“¾æ¥å·²å¤åˆ¶');
};
```

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### ç¤ºä¾‹1: è€å¸ˆåˆ†äº«æ´»åŠ¨

**1. è€å¸ˆç”Ÿæˆåˆ†äº«é“¾æ¥**
```
https://localhost:5173/activity/register/123?shareBy=456&shareType=teacher
```

**2. å®¶é•¿æŠ¥å**
```json
{
  "activityId": 123,
  "contactName": "å¼ ä¸‰",
  "contactPhone": "13800138000",
  "childName": "å¼ å°å®",
  "childAge": 4,
  "shareBy": 456,
  "shareType": "teacher"
}
```

**3. åˆ›å»ºæŠ¥åè®°å½•**
```sql
INSERT INTO activity_registrations (
  activity_id, contact_name, contact_phone, child_name, child_age,
  share_by, share_type, source_type, source_detail, auto_assigned
) VALUES (
  123, 'å¼ ä¸‰', '13800138000', 'å¼ å°å®', 4,
  456, 'teacher', 'ACTIVITY_ONLINE', 
  '{"activityId":123,"activityTitle":"æ˜¥å­£æ‹›ç”Ÿå¼€æ”¾æ—¥","shareBy":456,"shareType":"teacher"}',
  true
);
```

**4. è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± **
```sql
INSERT INTO teacher_customers (
  teacher_id, customer_name, phone, child_name, child_age,
  source, source_type, source_id, source_detail, auto_assigned
) VALUES (
  456, 'å¼ ä¸‰', '13800138000', 'å¼ å°å®', 4,
  'ACTIVITY', 'ACTIVITY_ONLINE', 1001,
  '{"activityId":123,"activityTitle":"æ˜¥å­£æ‹›ç”Ÿå¼€æ”¾æ—¥","registrationId":1001}',
  true
);
```

**5. è€å¸ˆæŸ¥çœ‹å®¢æˆ·**
- è€å¸ˆID 456 ç™»å½•ç³»ç»Ÿ
- è¿›å…¥"å®¢æˆ·è·Ÿè¸ª"é¡µé¢
- çœ‹åˆ°æ–°å®¢æˆ·"å¼ ä¸‰"
- æ¥æºæ˜¾ç¤ºï¼š"çº¿ä¸Šæ´»åŠ¨ - æ˜¥å­£æ‹›ç”Ÿå¼€æ”¾æ—¥"
- å¯ä»¥æ·»åŠ è·Ÿè¿›è®°å½•

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### æ•°æ®åº“éªŒè¯
- [ ] è¿è¡Œè¿ç§»æˆåŠŸ
- [ ] `activity_registrations` è¡¨æœ‰æ–°å­—æ®µ
- [ ] `teacher_customers` è¡¨æœ‰æ–°å­—æ®µ
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ

### åç«¯éªŒè¯
- [ ] ActivityRegistration æ¨¡å‹æ›´æ–°
- [ ] è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± é€»è¾‘å®ç°
- [ ] æ¥æºç±»å‹åˆ¤æ–­æ­£ç¡®
- [ ] å®¢æˆ·å»é‡é€»è¾‘æ­£ç¡®

### å‰ç«¯éªŒè¯
- [ ] æŠ¥åé¡µé¢è·å–åˆ†äº«å‚æ•°
- [ ] æäº¤æŠ¥ååŒ…å«åˆ†äº«å‚æ•°
- [ ] ç”Ÿæˆåˆ†äº«é“¾æ¥åŠŸèƒ½
- [ ] å¤åˆ¶åˆ†äº«é“¾æ¥åŠŸèƒ½

### é›†æˆéªŒè¯
- [ ] å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆç”Ÿæˆé“¾æ¥ â†’ æŠ¥å â†’ åŠ å…¥å®¢æˆ·æ± ï¼‰
- [ ] è€å¸ˆèƒ½çœ‹åˆ°è‡ªåŠ¨åˆ†é…çš„å®¢æˆ·
- [ ] æ¥æºä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- [ ] é‡å¤æŠ¥åä¸åˆ›å»ºé‡å¤å®¢æˆ·

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### P1 - é‡è¦
1. **é€šçŸ¥åŠŸèƒ½** - æ–°å®¢æˆ·åˆ†é…æ—¶é€šçŸ¥è€å¸ˆ
2. **ç»Ÿè®¡æŠ¥è¡¨** - å„æ¥æºçš„å®¢æˆ·æ•°é‡å’Œè½¬åŒ–ç‡
3. **æ‰¹é‡åˆ†é…** - å›­é•¿æ‰¹é‡åˆ†é…æœªåˆ†é…çš„å®¢æˆ·

### P2 - ä¼˜åŒ–
1. **æ™ºèƒ½åˆ†é…** - æ ¹æ®è€å¸ˆè´Ÿè½½è‡ªåŠ¨åˆ†é…
2. **å®¢æˆ·è¯„åˆ†** - æ ¹æ®æ¥æºå’Œè¡Œä¸ºè¯„åˆ†
3. **è½¬åŒ–è¿½è¸ª** - å®Œæ•´çš„è½¬åŒ–æ¼æ–—åˆ†æ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æŠ¥åå’Œå®¢æˆ·æ± æ“ä½œçš„åŸå­æ€§
- å®¢æˆ·å»é‡é€»è¾‘åŸºäºæ‰‹æœºå·

### 2. æ€§èƒ½è€ƒè™‘
- æ·»åŠ äº†å¿…è¦çš„ç´¢å¼•
- è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± å¤±è´¥ä¸å½±å“æŠ¥åæµç¨‹

### 3. å®‰å…¨æ€§
- éªŒè¯ shareBy å‚æ•°çš„æœ‰æ•ˆæ€§
- é˜²æ­¢æ¶æ„ä¿®æ”¹åˆ†äº«å‚æ•°

### 4. å…¼å®¹æ€§
- æ”¯æŒæ²¡æœ‰åˆ†äº«å‚æ•°çš„ç›´æ¥æŠ¥å
- å‘åå…¼å®¹ç°æœ‰çš„æŠ¥åæµç¨‹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. `docs/æ´»åŠ¨æŠ¥åè‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± æ–¹æ¡ˆ.md` - å®Œæ•´æ–¹æ¡ˆè®¾è®¡
2. `docs/æ´»åŠ¨ä¸­å¿ƒæ•°æ®åº“å…³ç³»åˆ†æ.md` - æ•°æ®åº“å…³ç³»åˆ†æ
3. `docs/æ´»åŠ¨ä¸­å¿ƒTimelineé‡æ„.md` - TimelineåŠŸèƒ½æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-05  
**ç»´æŠ¤äººå‘˜**ï¼šAI Assistant

---

## ğŸ‰ æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆå®Œæ•´å®ç°äº†ï¼š
1. âœ… åˆ†äº«é“¾æ¥è¿½è¸ª
2. âœ… æ¥æºæ¸…æ™°è®°å½•
3. âœ… è‡ªåŠ¨åŠ å…¥å®¢æˆ·æ± 
4. âœ… è‡ªåŠ¨åˆ†é…ç»™è€å¸ˆ
5. âœ… ä¸ç°æœ‰è€å¸ˆå®¢æˆ·è·Ÿè¸ªåŠŸèƒ½æ— ç¼é›†æˆ

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§å®æ–½æ­¥éª¤é€æ­¥å®ç°å„ä¸ªåŠŸèƒ½æ¨¡å—ã€‚

