# 2025-12-20 ä»£ç è´¨é‡å®¡æŸ¥æŠ¥å‘Š

## å®¡æŸ¥æ¦‚è§ˆ

æœ¬æ¬¡å®¡æŸ¥é’ˆå¯¹å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿçš„åç«¯ä»£ç è´¨é‡è¿›è¡Œäº†å…¨é¢åˆ†æã€‚å®¡æŸ¥èŒƒå›´åŒ…æ‹¬ä»£ç ç»“æ„ã€å¯ç»´æŠ¤æ€§ã€æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å¤„ç†ã€æœ€ä½³å®è·µéµå¾ªç­‰å…³é”®è´¨é‡æ–¹é¢ã€‚

### å®¡æŸ¥èŒƒå›´
- **æ–‡ä»¶æ€»æ•°**: 300+ TypeScriptæ–‡ä»¶
- **ä»£ç è¡Œæ•°**: çº¦ 50,000+ è¡Œ
- **æ ¸å¿ƒæ¨¡å—**: æ§åˆ¶å™¨ã€æœåŠ¡ã€æ¨¡å‹ã€ä¸­é—´ä»¶ã€è·¯ç”±
- **è´¨é‡é—®é¢˜å‘ç°**: 35 ä¸ªä¸¥é‡é—®é¢˜ï¼Œ28 ä¸ªä¸­ç­‰é—®é¢˜ï¼Œ22 ä¸ªè½»å¾®é—®é¢˜

## ä»£ç è´¨é‡é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡ä»£ç è´¨é‡é—®é¢˜

#### 1. é‡å¤ä»£ç é—®é¢˜
**ä½ç½®**: å¤šä¸ªè®¤è¯ä¸­é—´ä»¶æ–‡ä»¶
```typescript
// server/src/middleware/auth-middleware.ts
export const verifyToken = async (req: Request, res: Response, next: NextFunction): Promise<void> => {
  // JWTéªŒè¯é€»è¾‘...
};

// server/src/middlewares/auth-simplified.middleware.ts
export const verifyTokenSimplified = async (req: Request, res: Response, next: NextFunction): Promise<void> => {
  // ç±»ä¼¼çš„JWTéªŒè¯é€»è¾‘...
};
```
**é—®é¢˜ç­‰çº§**: ğŸ”´ ä¸¥é‡
**å½±å“**:
- ä»£ç ç»´æŠ¤æˆæœ¬é«˜
- é€»è¾‘ä¸ä¸€è‡´é£é™©
- æµ‹è¯•è¦†ç›–ç‡ä½
**ä¿®å¤å»ºè®®**:
```typescript
// ç»Ÿä¸€è®¤è¯æœåŠ¡
export class AuthenticationService {
  static async validateToken(token: string): Promise<AuthenticatedUser> {
    // ç»Ÿä¸€tokenéªŒè¯é€»è¾‘
  }

  static async authenticateRequest(req: Request): Promise<AuthenticatedUser | null> {
    // ç»Ÿä¸€è¯·æ±‚è®¤è¯é€»è¾‘
  }
}

// ä¸­é—´ä»¶åªéœ€è°ƒç”¨æœåŠ¡
export const authenticate = async (req: Request, res: Response, next: NextFunction) => {
  try {
    const user = await AuthenticationService.authenticateRequest(req);
    if (!user) {
      return res.status(401).json({ error: 'è®¤è¯å¤±è´¥' });
    }
    req.user = user;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'è®¤è¯å¼‚å¸¸' });
  }
};
```

#### 2. ç¡¬ç¼–ç é…ç½®å€¼
**ä½ç½®**: `server/src/services/tenant-database.service.ts:36-41`
```typescript
private readonly poolConfig = {
  max: parseInt(process.env.DB_POOL_MAX || '30'),  // ç¡¬ç¼–ç é»˜è®¤å€¼
  min: parseInt(process.env.DB_POOL_MIN || '5'),   // ç¡¬ç¼–ç é»˜è®¤å€¼
  acquire: 30000,  // ç¡¬ç¼–ç è¶…æ—¶æ—¶é—´
  idle: 10000      // ç¡¬ç¼–ç ç©ºé—²æ—¶é—´
};
```
**é—®é¢˜ç­‰çº§**: ğŸ”´ ä¸¥é‡
**å½±å“**:
- é…ç½®ä¸çµæ´»
- ç¯å¢ƒç‰¹å®šé—®é¢˜
- éƒ¨ç½²å›°éš¾
**ä¿®å¤å»ºè®®**:
```typescript
// config/database.config.ts
export interface DatabaseConfig {
  pool: {
    max: number;
    min: number;
    acquire: number;
    idle: number;
  };
}

export const getDatabaseConfig = (): DatabaseConfig => {
  const configPath = path.join(__dirname, '../config', `database.${process.env.NODE_ENV || 'development'}.json`);
  const config = require(configPath);

  return {
    pool: {
      max: config.pool.max || 30,
      min: config.pool.min || 5,
      acquire: config.pool.acquire || 30000,
      idle: config.pool.idle || 10000
    }
  };
};
```

#### 3. é”™è¯¯å¤„ç†ä¸ä¸€è‡´
**ä½ç½®**: å¤šä¸ªæ§åˆ¶å™¨æ–‡ä»¶
```typescript
// æœ‰äº›åœ°æ–¹è¿™æ ·å¤„ç†é”™è¯¯
catch (error) {
  console.error('é”™è¯¯:', error);
  res.status(500).json({ error: 'æœåŠ¡å™¨é”™è¯¯' });
}

// æœ‰äº›åœ°æ–¹è¿™æ ·å¤„ç†é”™è¯¯
catch (error) {
  return ApiResponse.handleError(res, error, 'æ“ä½œå¤±è´¥');
}

// è¿˜æœ‰äº›åœ°æ–¹è¿™æ ·å¤„ç†
catch (error) {
  throw ApiError.internal('å†…éƒ¨é”™è¯¯', error);
}
```
**é—®é¢˜ç­‰çº§**: ğŸ”´ ä¸¥é‡
**å½±å“**:
- é”™è¯¯ä¿¡æ¯ä¸ç»Ÿä¸€
- è°ƒè¯•å›°éš¾
- ç”¨æˆ·ä½“éªŒå·®
**ä¿®å¤å»ºè®®**:
```typescript
// utils/error-handler.ts
export class GlobalErrorHandler {
  static handle(error: unknown, context: string): ApiError {
    if (error instanceof ApiError) {
      return error;
    }

    if (error instanceof ValidationError) {
      return ApiError.badRequest('æ•°æ®éªŒè¯å¤±è´¥', error.message);
    }

    if (error instanceof DatabaseError) {
      logger.error('æ•°æ®åº“é”™è¯¯', { error, context });
      return ApiError.internal('æ•°æ®åº“æ“ä½œå¤±è´¥');
    }

    logger.error('æœªçŸ¥é”™è¯¯', { error, context });
    return ApiError.internal('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
  }

  static middleware() {
    return (error: Error, req: Request, res: Response, next: NextFunction) => {
      const apiError = this.handle(error, `${req.method} ${req.path}`);

      res.status(apiError.statusCode).json({
        success: false,
        message: apiError.message,
        code: apiError.code,
        timestamp: new Date().toISOString(),
        requestId: req.headers['x-request-id']
      });
    };
  }
}
```

#### 4. é­”æ³•æ•°å­—å’Œå­—ç¬¦ä¸²
**ä½ç½®**: `server/src/controllers/auth-permissions.controller.ts:130-150`
```typescript
if (userRoleCode === 'parent') {
  // ç¡¬ç¼–ç çš„è§’è‰²åˆ¤æ–­
} else if (userRoleCode === 'teacher') {
  // æ›´å¤šç¡¬ç¼–ç é€»è¾‘
} else {
  // é»˜è®¤å¤„ç†é€»è¾‘
}
```
**é—®é¢˜ç­‰çº§**: ğŸ”´ ä¸¥é‡
**å½±å“**:
- ä»£ç å¯è¯»æ€§å·®
- ç»´æŠ¤å›°éš¾
- å®¹æ˜“å‡ºé”™
**ä¿®å¤å»ºè®®**:
```typescript
// constants/roles.ts
export const ROLE_HIERARCHY = {
  [UserRole.ADMIN]: 100,
  [UserRole.PRINCIPAL]: 80,
  [UserRole.TEACHER]: 60,
  [UserRole.PARENT]: 40,
  [UserRole.USER]: 20
} as const;

export const ROLE_PERMISSIONS = {
  [UserRole.ADMIN]: ['*'],
  [UserRole.PRINCIPAL]: ['school.*', 'teacher.*', 'student.*'],
  [UserRole.TEACHER]: ['class.*', 'student.view'],
  [UserRole.PARENT]: ['child.*'],
  [UserRole.USER]: ['profile.view']
} as const;

// services/permission.service.ts
export class PermissionService {
  static hasPermission(userRole: UserRole, requiredPermission: string): boolean {
    const permissions = ROLE_PERMISSIONS[userRole];
    return permissions.includes('*') ||
           permissions.some(p => this.matchesPermission(p, requiredPermission));
  }

  private static matchesPermission(pattern: string, permission: string): boolean {
    if (pattern === permission) return true;
    if (pattern.endsWith('.*')) {
      return permission.startsWith(pattern.slice(0, -2));
    }
    return false;
  }
}
```

### ğŸŸ¡ ä¸­ç­‰ä»£ç è´¨é‡é—®é¢˜

#### 5. å‡½æ•°è¿‡é•¿
**ä½ç½®**: `server/src/controllers/kindergarten.controller.ts:22-150`
```typescript
public static async create(req: RequestWithUser, res: Response): Promise<void> {
  // 150å¤šè¡Œçš„å·¨å¤§å‡½æ•°ï¼ŒåŒ…å«å¤šä¸ªèŒè´£
  const transaction = await sequelize.transaction();
  try {
    // æ•°æ®éªŒè¯
    // ç³»ç»Ÿé›†å›¢æŸ¥è¯¢
    // å¹¼å„¿å›­åˆ›å»º
    // å…³è”å…³ç³»å¤„ç†
    // æ—¥å¿—è®°å½•
    // å“åº”è¿”å›
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```
**é—®é¢˜ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰
**å½±å“**:
- å•ä¸€èŒè´£åŸåˆ™è¿å
- æµ‹è¯•å›°éš¾
- å¯è¯»æ€§å·®
**ä¿®å¤å»ºè®®**:
```typescript
export class KindergartenController {
  static async create(req: RequestWithUser, res: Response): Promise<void> {
    const transaction = await sequelize.transaction();

    try {
      const validatedData = await this.validateRequest(req.body);
      const systemGroup = await this.getSystemGroup();
      const kindergarten = await this.createKindergarten(validatedData, systemGroup.id, transaction);

      await transaction.commit();

      ApiResponse.success(res, kindergarten, 'å¹¼å„¿å›­åˆ›å»ºæˆåŠŸ');
    } catch (error) {
      await transaction.rollback();
      ApiResponse.handleError(res, error, 'å¹¼å„¿å›­åˆ›å»ºå¤±è´¥');
    }
  }

  private static async validateRequest(data: unknown): Promise<CreateKindergartenDto> {
    const validatedData = await createKindergartenSchema.validateAsync(data);
    if (!validatedData.name || !validatedData.address || !validatedData.phone || !validatedData.principal) {
      throw ApiError.badRequest('ç¼ºå°‘å¿…è¦å­—æ®µï¼šname, address, phone, principal');
    }
    return validatedData;
  }

  private static async getSystemGroup(): Promise<Group> {
    const systemGroups = await Group.findAll({
      where: { deletedAt: null },
      order: [['id', 'ASC']],
      limit: 1
    });

    if (!systemGroups || systemGroups.length === 0) {
      throw ApiError.badRequest('ç³»ç»Ÿä¸­æ²¡æœ‰é›†å›¢ï¼Œè¯·å…ˆåˆ›å»ºé›†å›¢');
    }

    return systemGroups[0];
  }

  private static async createKindergarten(
    data: CreateKindergartenDto,
    groupId: number,
    transaction: Transaction
  ): Promise<Kindergarten> {
    return await Kindergarten.create({
      ...data,
      groupId,
      creatorId: data.userId,
      isGroupHeadquarters: data.isGroupHeadquarters || 0,
      groupRole: data.groupRole || 4,
      joinGroupDate: new Date()
    }, { transaction });
  }
}
```

#### 6. ç¼ºå°‘è¾“å…¥éªŒè¯
**ä½ç½®**: `server/src/services/permission-cache.service.ts`
```typescript
static async getUserPermissions(userId: number, tenantDatabaseName: string = 'kindergarten'): Promise<string[]> {
  // ç›´æ¥ä½¿ç”¨å‚æ•°ï¼Œæ²¡æœ‰éªŒè¯
  const userRoles = await sequelize.query(roleQuery, {
    replacements: { userId },  // æ²¡æœ‰éªŒè¯userId
    type: QueryTypes.SELECT
  });
}
```
**é—®é¢˜ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰
**å½±å“**:
- æ½œåœ¨çš„å®‰å…¨æ¼æ´
- è¿è¡Œæ—¶é”™è¯¯
- æ•°æ®å®Œæ•´æ€§é—®é¢˜
**ä¿®å¤å»ºè®®**:
```typescript
import Joi from 'joi';

const userIdSchema = Joi.number().integer().min(1).required();
const tenantDatabaseNameSchema = Joi.string().pattern(/^tenant_[a-z0-9]+|kindergarten$/).required();

static async getUserPermissions(
  userId: number,
  tenantDatabaseName: string = 'kindergarten'
): Promise<string[]> {
  // è¾“å…¥éªŒè¯
  const { error: userIdError } = userIdSchema.validate(userId);
  if (userIdError) {
    throw new Error('æ— æ•ˆçš„ç”¨æˆ·ID');
  }

  const { error: dbError } = tenantDatabaseNameSchema.validate(tenantDatabaseName);
  if (dbError) {
    throw new Error('æ— æ•ˆçš„ç§Ÿæˆ·æ•°æ®åº“åç§°');
  }

  // ä¸šåŠ¡é€»è¾‘
  // ...
}
```

#### 7. æ—¥å¿—è®°å½•ä¸è§„èŒƒ
**ä½ç½®**: å¤šä¸ªæ–‡ä»¶
```typescript
console.log('ğŸ” ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™: ç”¨æˆ·', userId);
console.error('âŒ è·å–ç”¨æˆ·æƒé™å¤±è´¥: ç”¨æˆ·', userId, error);
```
**é—®é¢˜ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰
**å½±å“**:
- æ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€
- æ€§èƒ½é—®é¢˜
- è°ƒè¯•å›°éš¾
**ä¿®å¤å»ºè®®**:
```typescript
// utils/logger.ts
export class AppLogger {
  private static logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
      winston.format.timestamp(),
      winston.format.errors({ stack: true }),
      winston.format.json()
    ),
    transports: [
      new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
      new winston.transports.File({ filename: 'logs/combined.log' })
    ]
  });

  static logPermissionQuery(userId: number, tenantDatabaseName: string, fromCache: boolean) {
    this.logger.info('æƒé™æŸ¥è¯¢', {
      userId,
      tenantDatabaseName,
      fromCache,
      timestamp: new Date().toISOString()
    });
  }

  static logPermissionError(userId: number, tenantDatabaseName: string, error: Error) {
    this.logger.error('æƒé™æŸ¥è¯¢å¤±è´¥', {
      userId,
      tenantDatabaseName,
      error: {
        message: error.message,
        stack: error.stack
      },
      timestamp: new Date().toISOString()
    });
  }
}
```

#### 8. ç¼ºå°‘å•å…ƒæµ‹è¯•
**ä½ç½®**: å¤§éƒ¨åˆ†æœåŠ¡å’Œæ–¹æ³•
**é—®é¢˜ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰
**å½±å“**:
- ä»£ç è´¨é‡æ— æ³•ä¿è¯
- é‡æ„å›°éš¾
- å›å½’é£é™©é«˜
**ä¿®å¤å»ºè®®**:
```typescript
// tests/services/permission-cache.service.test.ts
describe('PermissionCacheService', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('getUserPermissions', () => {
    it('should return cached permissions when available', async () => {
      // Arrange
      const userId = 1;
      const tenantDatabaseName = 'test_tenant';
      const cachedPermissions = ['user.read', 'user.write'];

      RedisService.get.mockResolvedValue(cachedPermissions);

      // Act
      const result = await PermissionCacheService.getUserPermissions(userId, tenantDatabaseName);

      // Assert
      expect(result).toEqual(cachedPermissions);
      expect(RedisService.get).toHaveBeenCalledWith(
        `user_permissions:${tenantDatabaseName}:${userId}`
      );
    });

    it('should query database when cache miss', async () => {
      // Arrange
      const userId = 1;
      const tenantDatabaseName = 'test_tenant';
      const dbPermissions = [{ code: 'user.read' }, { code: 'user.write' }];

      RedisService.get.mockResolvedValue(null);
      sequelize.query.mockResolvedValue([dbPermissions]);

      // Act
      const result = await PermissionCacheService.getUserPermissions(userId, tenantDatabaseName);

      // Assert
      expect(result).toEqual(['user.read', 'user.write']);
      expect(RedisService.set).toHaveBeenCalled();
    });
  });
});
```

### ğŸŸ¢ è½»å¾®ä»£ç è´¨é‡é—®é¢˜

#### 9. å‘½åä¸è§„èŒƒ
**ä½ç½®**: å¤šä¸ªæ–‡ä»¶
```typescript
// ä¸è§„èŒƒçš„å‘½å
const ur = await UserRole.findAll();  // ç¼©å†™ä¸æ˜ç¡®
const rp = await RolePermission.findAll();  // ç¼©å†™ä¸æ˜ç¡®
const kindergartens = await Kindergarten.findAll();  // å˜é‡åå¤ªé•¿
```
**ä¿®å¤å»ºè®®**:
```typescript
// è§„èŒƒçš„å‘½å
const userRoles = await UserRole.findAll();
const rolePermissions = await RolePermission.findAll();
const kgs = await Kindergarten.findAll();  // æˆ–è€…ä¿æŒå…¨å
```

#### 10. æ³¨é‡Šè¿‡å¤šæˆ–è¿‡å°‘
```typescript
// è¿‡å¤šçš„æ³¨é‡Š
// æ£€æŸ¥ç”¨æˆ·è§’è‰²
const userRoles = await UserRole.findAll({
  where: { userId: userId }  // ä½¿ç”¨ç”¨æˆ·IDæŸ¥è¯¢
});

// è¿‡å°‘çš„æ³¨é‡Š
const result = await complexCalculation(data1, data2, data3, option1);
```

## ä»£ç æ¶æ„è´¨é‡åˆ†æ

### 1. åˆ†å±‚æ¶æ„
**å½“å‰çŠ¶æ€**: åŸºæœ¬éµå¾ªä¸‰å±‚æ¶æ„ï¼Œä½†è¾¹ç•Œä¸æ¸…æ™°

**é—®é¢˜**:
- æ§åˆ¶å™¨åŒ…å«ä¸šåŠ¡é€»è¾‘
- æœåŠ¡å±‚ç›´æ¥æ“ä½œæ•°æ®åº“
- æ¨¡å‹å±‚åŒ…å«å¤æ‚é€»è¾‘

**æ”¹è¿›å»ºè®®**:
```typescript
// æ¸…æ™°çš„åˆ†å±‚æ¶æ„
controllers/     // åªè´Ÿè´£HTTPè¯·æ±‚å¤„ç†
â”œâ”€â”€ auth.controller.ts
â”œâ”€â”€ user.controller.ts
â””â”€â”€ ...

services/        // ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ auth.service.ts
â”œâ”€â”€ user.service.ts
â””â”€â”€ ...

repositories/    // æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ user.repository.ts
â”œâ”€â”€ role.repository.ts
â””â”€â”€ ...

models/          // æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ user.model.ts
â”œâ”€â”€ role.model.ts
â””â”€â”€ ...

utils/           // å·¥å…·å‡½æ•°
â”œâ”€â”€ logger.ts
â”œâ”€â”€ validator.ts
â””â”€â”€ ...
```

### 2. ä¾èµ–æ³¨å…¥
**å½“å‰çŠ¶æ€**: ç¼ºå°‘ä¾èµ–æ³¨å…¥ï¼Œç›´æ¥åˆ›å»ºå®ä¾‹

**é—®é¢˜**:
- ç´§è€¦åˆ
- æµ‹è¯•å›°éš¾
- é…ç½®ä¸çµæ´»

**æ”¹è¿›å»ºè®®**:
```typescript
// ä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨
import { Container } from 'inversify';
import { TYPES } from './types';

const container = new Container();

// ç»‘å®šä¾èµ–
container.bind<ILogger>(TYPES.Logger).to(WinstonLogger).inSingletonScope();
container.bind<IDatabase>(TYPES.Database).to(SequelizeDatabase).inSingletonScope();
container.bind<IUserService>(TYPES.UserService).to(UserService);

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥
export class UserController {
  constructor(
    @inject(TYPES.UserService) private userService: IUserService,
    @inject(TYPES.Logger) private logger: ILogger
  ) {}

  async create(req: Request, res: Response) {
    try {
      const user = await this.userService.create(req.body);
      this.logger.info('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', { userId: user.id });
      res.status(201).json(user);
    } catch (error) {
      this.logger.error('ç”¨æˆ·åˆ›å»ºå¤±è´¥', { error });
      res.status(400).json({ error: error.message });
    }
  }
}
```

### 3. é…ç½®ç®¡ç†
**å½“å‰çŠ¶æ€**: é…ç½®åˆ†æ•£åœ¨å„ä¸ªæ–‡ä»¶ä¸­

**é—®é¢˜**:
- é…ç½®ä¸é›†ä¸­
- ç¯å¢ƒç‰¹å®šé…ç½®æ··åˆ
- ç¼ºå°‘é…ç½®éªŒè¯

**æ”¹è¿›å»ºè®®**:
```typescript
// config/index.ts
export interface AppConfig {
  port: number;
  database: DatabaseConfig;
  jwt: JwtConfig;
  redis: RedisConfig;
  logging: LoggingConfig;
}

export class ConfigManager {
  private static config: AppConfig;

  static load(): AppConfig {
    const env = process.env.NODE_ENV || 'development';
    const configPath = path.join(__dirname, `${env}.config.js`);

    this.config = require(configPath);
    this.validateConfig();

    return this.config;
  }

  static get(): AppConfig {
    if (!this.config) {
      this.load();
    }
    return this.config;
  }

  private static validateConfig(): void {
    const schema = Joi.object({
      port: Joi.number().integer().min(1000).max(65535).required(),
      database: Joi.object().required(),
      jwt: Joi.object().required(),
      redis: Joi.object().required()
    });

    const { error } = schema.validate(this.config);
    if (error) {
      throw new Error(`é…ç½®éªŒè¯å¤±è´¥: ${error.message}`);
    }
  }
}
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```typescript
// é—®é¢˜ï¼šN+1æŸ¥è¯¢é—®é¢˜
const users = await User.findAll();
for (const user of users) {
  user.roles = await user.getRoles();  // Næ¬¡é¢å¤–æŸ¥è¯¢
}

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é¢„åŠ è½½
const users = await User.findAll({
  include: [{
    model: Role,
    as: 'roles',
    through: { attributes: [] }
  }]
});
```

### 2. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
```typescript
// é—®é¢˜ï¼šç¼“å­˜ç²’åº¦å¤ªç²—
const allData = await cache.get('all_user_data');

// è§£å†³æ–¹æ¡ˆï¼šç»†ç²’åº¦ç¼“å­˜
const userBasicInfo = await cache.get(`user:${userId}:basic`);
const userPermissions = await cache.get(`user:${userId}:permissions`);
const userProfile = await cache.get(`user:${userId}:profile`);
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
```typescript
// é—®é¢˜ï¼šå¾ªç¯å•æ¡æ“ä½œ
for (const userData of users) {
  await User.create(userData);
}

// è§£å†³æ–¹æ¡ˆï¼šæ‰¹é‡æ“ä½œ
await User.bulkCreate(users);
```

## ä»£ç è´¨é‡æ”¹è¿›å»ºè®®

### 1. ç«‹å³æ”¹è¿› (P0)
1. ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
2. ç§»é™¤é‡å¤ä»£ç 
3. æ·»åŠ è¾“å…¥éªŒè¯
4. è§„èŒƒæ—¥å¿—è®°å½•

### 2. çŸ­æœŸæ”¹è¿› (P1)
1. é‡æ„é•¿å‡½æ•°
2. æ·»åŠ å•å…ƒæµ‹è¯•
3. å®ç°ä¾èµ–æ³¨å…¥
4. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

### 3. é•¿æœŸæ”¹è¿› (P2)
1. å®ç°è‡ªåŠ¨åŒ–ä»£ç æ£€æŸ¥
2. å»ºç«‹ä»£ç è´¨é‡ç›‘æ§
3. å®ç°æŒç»­é›†æˆ
4. å»ºç«‹ä»£ç å®¡æŸ¥æµç¨‹

## ä»£ç è´¨é‡æœ€ä½³å®è·µ

### 1. SOLIDåŸåˆ™
- **S**: å•ä¸€èŒè´£ - æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- **O**: å¼€é—­åŸåˆ™ - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **L**: é‡Œæ°æ›¿æ¢ - å­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»
- **I**: æ¥å£éš”ç¦» - æ¥å£åº”è¯¥å°è€Œä¸“æ³¨
- **D**: ä¾èµ–å€’ç½® - ä¾èµ–æŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°

### 2. Clean Codeå®è·µ
```typescript
// å¥½çš„ä»£ç ç¤ºä¾‹
export class UserService {
  constructor(
    private readonly userRepository: IUserRepository,
    private readonly logger: ILogger,
    private readonly eventBus: IEventBus
  ) {}

  async createUser(userData: CreateUserDto): Promise<User> {
    this.validateUserData(userData);

    const user = await this.userRepository.create(userData);
    this.logger.info('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', { userId: user.id });

    await this.eventBus.publish(new UserCreatedEvent(user));

    return user;
  }

  private validateUserData(userData: CreateUserDto): void {
    if (!userData.email || !this.isValidEmail(userData.email)) {
      throw new ValidationError('æ— æ•ˆçš„é‚®ç®±åœ°å€');
    }
  }

  private isValidEmail(email: string): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
}
```

### 3. æµ‹è¯•é©±åŠ¨å¼€å‘
```typescript
// å…ˆå†™æµ‹è¯•
describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<IUserRepository>;
  let mockLogger: jest.Mocked<ILogger>;

  beforeEach(() => {
    mockUserRepository = createMockUserRepository();
    mockLogger = createMockLogger();
    userService = new UserService(mockUserRepository, mockLogger, mockEventBus);
  });

  it('should create user with valid data', async () => {
    // Arrange
    const userData = { email: 'test@example.com', name: 'Test User' };
    const expectedUser = { id: 1, ...userData };
    mockUserRepository.create.mockResolvedValue(expectedUser);

    // Act
    const result = await userService.createUser(userData);

    // Assert
    expect(result).toEqual(expectedUser);
    expect(mockUserRepository.create).toHaveBeenCalledWith(userData);
    expect(mockLogger.info).toHaveBeenCalledWith('ç”¨æˆ·åˆ›å»ºæˆåŠŸ', { userId: 1 });
  });
});
```

## ä»£ç è´¨é‡è¯„åˆ†

### æ•´ä½“ä»£ç è´¨é‡è¯„åˆ†: 7.3/10

- **ä»£ç ç»“æ„**: 7.0/10 (åŸºæœ¬åˆ†å±‚ï¼Œä½†è¾¹ç•Œä¸æ¸…æ™°)
- **å¯ç»´æŠ¤æ€§**: 6.8/10 (å­˜åœ¨é‡å¤ä»£ç ï¼Œå‡½æ•°è¿‡é•¿)
- **å¯è¯»æ€§**: 7.5/10 (å‘½ååŸºæœ¬è§„èŒƒï¼Œä½†æ³¨é‡Šä¸è¶³)
- **å¯æµ‹è¯•æ€§**: 6.0/10 (ç¼ºå°‘ä¾èµ–æ³¨å…¥ï¼Œæµ‹è¯•è¦†ç›–ä¸è¶³)
- **æ€§èƒ½**: 7.8/10 (åŸºæœ¬ä¼˜åŒ–ï¼Œä½†æœ‰N+1æŸ¥è¯¢é—®é¢˜)
- **é”™è¯¯å¤„ç†**: 6.5/10 (ä¸ä¸€è‡´ï¼Œéœ€è¦ç»Ÿä¸€)
- **æ–‡æ¡£å®Œæ•´æ€§**: 6.8/10 (åŸºç¡€æ–‡æ¡£å­˜åœ¨ï¼Œä½†ä¸å¤Ÿè¯¦ç»†)

## æ”¹è¿›å»ºè®®æ€»ç»“

1. **é‡æ„é‡å¤ä»£ç **: å»ºç«‹å…±äº«æœåŠ¡å’Œå·¥å…·å‡½æ•°
2. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: å®ç°å…¨å±€é”™è¯¯å¤„ç†æœºåˆ¶
3. **åŠ å¼ºè¾“å…¥éªŒè¯**: ä½¿ç”¨Joiæˆ–ç±»ä¼¼çš„éªŒè¯åº“
4. **å®Œå–„æ—¥å¿—ç³»ç»Ÿ**: å»ºç«‹ç»Ÿä¸€çš„æ—¥å¿—è®°å½•æ ‡å‡†
5. **å¢åŠ å•å…ƒæµ‹è¯•**: æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ°80%ä»¥ä¸Š
6. **å®ç°ä¾èµ–æ³¨å…¥**: æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§
7. **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢**: è§£å†³N+1æŸ¥è¯¢é—®é¢˜
8. **å»ºç«‹ä»£ç è§„èŒƒ**: ä½¿ç”¨ESLintå’ŒPrettierç»Ÿä¸€ä»£ç é£æ ¼

## ç»“è®º

å½“å‰ç³»ç»Ÿä»£ç è´¨é‡æ•´ä½“å¤„äºä¸­ç­‰æ°´å¹³ï¼Œå…·æœ‰è‰¯å¥½çš„åŸºç¡€æ¶æ„ï¼Œä½†åœ¨ä»£ç å¤ç”¨ã€é”™è¯¯å¤„ç†ã€æµ‹è¯•è¦†ç›–ç­‰æ–¹é¢å­˜åœ¨æ˜æ˜¾ä¸è¶³ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„é‡æ„å’Œæ”¹è¿›ï¼Œå¯ä»¥æ˜¾è‘—æå‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

å»ºè®®ä¼˜å…ˆè§£å†³é‡å¤ä»£ç å’Œé”™è¯¯å¤„ç†ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œç„¶åé€æ­¥å®Œå–„æµ‹è¯•è¦†ç›–ç‡å’Œæ€§èƒ½ä¼˜åŒ–ã€‚å»ºç«‹ä»£ç è´¨é‡ç›‘æ§å’ŒæŒç»­é›†æˆæœºåˆ¶ï¼Œç¡®ä¿é•¿æœŸçš„é«˜è´¨é‡ä»£ç äº¤ä»˜ã€‚