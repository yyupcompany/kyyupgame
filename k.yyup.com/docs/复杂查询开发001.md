# å¤æ‚æŸ¥è¯¢å¼€å‘æ–‡æ¡£ 001

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-01-06
- **æœ€åæ›´æ–°**: 2025-01-06
- **è´Ÿè´£äºº**: AIå¼€å‘å›¢é˜Ÿ
- **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

å®ç°ä¸€ä¸ª**æ™ºèƒ½ä¸‰çº§åˆ†çº§æŸ¥è¯¢ç³»ç»Ÿ**,ç»“åˆ**å¤šå…³é”®è¯å¹¶è¡Œå¿«é€ŸæŸ¥è¯¢**å’Œ**æƒé™é©±åŠ¨å·¥å…·ç”Ÿæˆ**,å®ç°:

1. âœ… **æé€Ÿå“åº”**: å¤šå…³é”®è¯æŸ¥è¯¢ 100-200ms è¿”å›ç»“æœ
2. âœ… **æ™ºèƒ½åˆ†çº§**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¤„ç†æ–¹å¼,é™ä½ 70-80% Token æ¶ˆè€—
3. âœ… **æƒé™å®‰å…¨**: ç³»ç»Ÿè‡ªåŠ¨è¿‡æ»¤æƒé™,AI ä¸éœ€è¦åˆ¤æ–­
4. âœ… **æ˜“äºæ‰©å±•**: æ–°å¢åŠŸèƒ½åªéœ€æ›´æ–°æ˜ å°„è¡¨
5. âœ… **AI æ™ºèƒ½å›å¤**: å¿«é€ŸæŸ¥è¯¢ç»“æœç”± AI æ ¼å¼åŒ–ä¸ºå‹å¥½å›å¤

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
ç”¨æˆ·æŸ¥è¯¢: "æŸ¥è¯¢å¸ˆèµ„ã€æ´»åŠ¨ã€æ‹›ç”Ÿæƒ…å†µ"
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸€çº§: å¤šå…³é”®è¯å¹¶è¡Œå¿«é€ŸæŸ¥è¯¢ - <200ms                  â”‚
â”‚  - æ£€æµ‹ä¸šåŠ¡å…³é”®è¯ (å¸ˆèµ„ã€æ´»åŠ¨ã€æ‹›ç”Ÿç­‰)                  â”‚
â”‚  - å¹¶è¡Œæ‰§è¡Œå¿«é€ŸæŸ¥è¯¢ (89ä¸ªç›´æ¥åŒ¹é…è§„åˆ™)                  â”‚
â”‚  - è¿”å›ç»“æ„åŒ–æ•°æ®                                        â”‚
â”‚  - AI æ ¼å¼åŒ–ä¸ºå‹å¥½å›å¤ âœ¨                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ (å¦‚æœåŒ¹é…æˆåŠŸ)
   è¿”å› AI æ ¼å¼åŒ–ç»“æœ â†’ å±•ç¤ºç»™ç”¨æˆ·
   
   â†“ (å¦‚æœæœªåŒ¹é…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒçº§: æƒé™é©±åŠ¨å·¥å…·ç”Ÿæˆ - <1s                         â”‚
â”‚  - æ ¹æ®ç”¨æˆ·æƒé™è‡ªåŠ¨ç”Ÿæˆå¯ç”¨å·¥å…·åˆ—è¡¨                      â”‚
â”‚  - æ ¹æ®å½“å‰é¡µé¢æ³¨å…¥ä¸Šä¸‹æ–‡æç¤ºè¯                          â”‚
â”‚  - AI é€‰æ‹©åˆé€‚çš„å·¥å…·è°ƒç”¨ API                             â”‚
â”‚  - è¿”å›ç»“æœå¹¶ç”± AI åˆ†æ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ (å¦‚æœå·¥å…·è°ƒç”¨æˆåŠŸ)
   è¿”å› AI åˆ†æç»“æœ â†’ å±•ç¤ºç»™ç”¨æˆ·
   
   â†“ (å¦‚æœå·¥å…·è°ƒç”¨å¤±è´¥æˆ–éœ€è¦å¤æ‚åˆ†æ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰çº§: å¤æ‚æ¨¡å‹æŸ¥è¯¢ - <5s                             â”‚
â”‚  - AI ç”Ÿæˆå¤æ‚ SQL æŸ¥è¯¢                                  â”‚
â”‚  - å®‰å…¨æ£€æŸ¥å’Œæƒé™æ³¨å…¥                                    â”‚
â”‚  - æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. å¤šå…³é”®è¯å¹¶è¡Œå¿«é€ŸæŸ¥è¯¢

#### 1.1 ä¸šåŠ¡å…³é”®è¯æ˜ å°„

```typescript
// ä¸šåŠ¡å…³é”®è¯åˆ°å¿«é€ŸæŸ¥è¯¢çš„æ˜ å°„
const businessKeywords = {
  'å¸ˆèµ„': ['æ•™å¸ˆæ€»æ•°', 'æ•™å¸ˆåˆ—è¡¨', 'æ•™å¸ˆç»Ÿè®¡'],
  'æ´»åŠ¨': ['ä»Šæ—¥æ´»åŠ¨', 'æ´»åŠ¨åˆ—è¡¨', 'æœ¬å‘¨æ´»åŠ¨å®‰æ’', 'æ´»åŠ¨ç»Ÿè®¡'],
  'æ‹›ç”Ÿ': ['æ‹›ç”Ÿç»Ÿè®¡', 'æœ¬æœˆæ‹›ç”Ÿäººæ•°', 'æ‹›ç”Ÿç”³è¯·æ•°é‡', 'æ‹›ç”Ÿè½¬åŒ–ç‡'],
  'å­¦ç”Ÿ': ['å­¦ç”Ÿæ€»æ•°', 'å­¦ç”Ÿåˆ—è¡¨', 'å„ç­çº§å­¦ç”Ÿäººæ•°åˆ†å¸ƒ'],
  'ç­çº§': ['ç­çº§æ€»æ•°', 'ç­çº§åˆ—è¡¨', 'ç­çº§å®¹é‡'],
  'è´¢åŠ¡': ['è´¹ç”¨ç»Ÿè®¡', 'æœ¬æœˆæ”¶å…¥', 'ç¼´è´¹ç‡'],
  'å®¶é•¿': ['å®¶é•¿æ€»æ•°', 'å®¶é•¿åé¦ˆç»Ÿè®¡']
};
```

#### 1.2 å¹¶è¡ŒæŸ¥è¯¢æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢: "æŸ¥è¯¢å¸ˆèµ„ã€æ´»åŠ¨ã€æ‹›ç”Ÿæƒ…å†µ"
   â†“
æ£€æµ‹å…³é”®è¯: ['å¸ˆèµ„', 'æ´»åŠ¨', 'æ‹›ç”Ÿ']
   â†“
å¹¶è¡Œæ‰§è¡Œ (Promise.all):
   â”œâ”€â”€ å¸ˆèµ„æŸ¥è¯¢ (3ä¸ªå­æŸ¥è¯¢å¹¶è¡Œ)
   â”‚   â”œâ”€â”€ æ•™å¸ˆæ€»æ•°: 80äºº
   â”‚   â”œâ”€â”€ æ•™å¸ˆåˆ—è¡¨: [...]
   â”‚   â””â”€â”€ æ•™å¸ˆç»Ÿè®¡: {...}
   â”œâ”€â”€ æ´»åŠ¨æŸ¥è¯¢ (4ä¸ªå­æŸ¥è¯¢å¹¶è¡Œ)
   â”‚   â”œâ”€â”€ ä»Šæ—¥æ´»åŠ¨: 3åœº
   â”‚   â”œâ”€â”€ æ´»åŠ¨åˆ—è¡¨: [...]
   â”‚   â”œâ”€â”€ æœ¬å‘¨æ´»åŠ¨: 12åœº
   â”‚   â””â”€â”€ æ´»åŠ¨ç»Ÿè®¡: {...}
   â””â”€â”€ æ‹›ç”ŸæŸ¥è¯¢ (4ä¸ªå­æŸ¥è¯¢å¹¶è¡Œ)
       â”œâ”€â”€ æ‹›ç”Ÿç»Ÿè®¡: {...}
       â”œâ”€â”€ æœ¬æœˆæ‹›ç”Ÿ: 45äºº
       â”œâ”€â”€ æ‹›ç”Ÿç”³è¯·: 120ä»½
       â””â”€â”€ æ‹›ç”Ÿè½¬åŒ–ç‡: 37.5%
   â†“
æ±‡æ€»ç»“æœ (100-200ms)
   â†“
AI æ ¼å¼åŒ–ä¸ºå‹å¥½å›å¤ (500ms)
   â†“
è¿”å›ç»™ç”¨æˆ· (æ€»è€—æ—¶: 600-700ms)
```

#### 1.3 AI æ ¼å¼åŒ–å›å¤

**ç³»ç»Ÿæç¤ºè¯**:
```
ä½ æ˜¯YY-AIæ™ºèƒ½åŠ©æ‰‹ã€‚ç”¨æˆ·æŸ¥è¯¢äº†å¤šä¸ªä¸šåŠ¡æ•°æ®ï¼Œç³»ç»Ÿå·²ç»å¿«é€ŸæŸ¥è¯¢å¹¶è¿”å›äº†ç»“æœã€‚

ä½ çš„ä»»åŠ¡æ˜¯:
1. åˆ†æè¿™äº›æ•°æ®
2. æå–å…³é”®ä¿¡æ¯
3. ç”¨å‹å¥½çš„è‡ªç„¶è¯­è¨€æ€»ç»“
4. å¦‚æœå‘ç°å¼‚å¸¸æˆ–è¶‹åŠ¿ï¼Œç»™å‡ºå»ºè®®

**ç”¨æˆ·æŸ¥è¯¢**: {userQuery}

**å¿«é€ŸæŸ¥è¯¢ç»“æœ**:
{quickQueryResults}

è¯·ç”¨ç®€æ´ã€ä¸“ä¸šã€å‹å¥½çš„è¯­è¨€å›å¤ç”¨æˆ·ã€‚
```

**AI å›å¤ç¤ºä¾‹**:
```
æ‚¨å¥½ï¼ä»¥ä¸‹æ˜¯å½“å‰çš„å¸ˆèµ„ã€æ´»åŠ¨å’Œæ‹›ç”Ÿæƒ…å†µï¼š

**å¸ˆèµ„æƒ…å†µ**ï¼š
- æ•™å¸ˆæ€»æ•°ï¼š80äºº
- åœ¨èŒæ•™å¸ˆï¼š75äºº
- è¯·å‡æ•™å¸ˆï¼š5äºº

**æ´»åŠ¨æƒ…å†µ**ï¼š
- ä»Šæ—¥æ´»åŠ¨ï¼š3åœº
- æœ¬å‘¨æ´»åŠ¨ï¼š12åœº
- å¹³å‡å‚ä¸ç‡ï¼š85%

**æ‹›ç”Ÿæƒ…å†µ**ï¼š
- æœ¬æœˆæ‹›ç”Ÿï¼š45äºº
- æ‹›ç”Ÿç”³è¯·ï¼š120ä»½
- è½¬åŒ–ç‡ï¼š37.5%

æ•´ä½“è¿è¥çŠ¶å†µè‰¯å¥½ï¼Œæ‹›ç”Ÿè½¬åŒ–ç‡ç•¥ä½äºè¡Œä¸šå¹³å‡æ°´å¹³(40%)ï¼Œ
å»ºè®®åŠ å¼ºæ‹›ç”Ÿæ´»åŠ¨çš„å®£ä¼ å’Œè·Ÿè¿›ã€‚
```

---

### 2. æƒé™é©±åŠ¨å·¥å…·ç”Ÿæˆ

#### 2.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

**è®©ç³»ç»Ÿè‡ªåŠ¨å®Œæˆæ˜ å°„ï¼ŒAI åªéœ€è¦æ‰§è¡Œï¼Œä¸éœ€è¦åˆ¤æ–­ï¼**

- ç”¨æˆ·ç™»å½•åï¼Œæ ¹æ®è§’è‰²å’Œæƒé™è‡ªåŠ¨ç”Ÿæˆå¯ç”¨å·¥å…·åˆ—è¡¨
- æ ¹æ®å½“å‰é¡µé¢è‡ªåŠ¨æ³¨å…¥ç›¸å…³ä¸Šä¸‹æ–‡
- AI ä¸éœ€è¦ç†è§£æƒé™é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨æä¾›çš„å·¥å…·

#### 2.2 æ•°æ®åº“è®¾è®¡

**æ–°å»ºè¡¨**: `permission_api_mappings`

```sql
CREATE TABLE permission_api_mappings (
  id INT AUTO_INCREMENT PRIMARY KEY,
  permission_code VARCHAR(100) NOT NULL COMMENT 'æƒé™ä»£ç ',
  permission_path VARCHAR(255) NOT NULL COMMENT 'æƒé™è·¯å¾„',
  api_endpoint VARCHAR(255) NOT NULL COMMENT 'APIç«¯ç‚¹',
  api_method ENUM('GET', 'POST', 'PUT', 'DELETE') NOT NULL COMMENT 'HTTPæ–¹æ³•',
  tool_name VARCHAR(100) NOT NULL COMMENT 'å·¥å…·åç§°',
  tool_description TEXT NOT NULL COMMENT 'å·¥å…·æè¿°',
  tool_parameters JSON COMMENT 'å·¥å…·å‚æ•°å®šä¹‰',
  related_tables JSON COMMENT 'ç›¸å…³æ•°æ®åº“è¡¨',
  query_type ENUM('list', 'detail', 'statistics', 'analysis') NOT NULL COMMENT 'æŸ¥è¯¢ç±»å‹',
  is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_permission_code (permission_code),
  INDEX idx_tool_name (tool_name),
  INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æƒé™-API-å·¥å…·æ˜ å°„è¡¨';
```

#### 2.3 æ˜ å°„æ•°æ®ç¤ºä¾‹

```sql
-- æ´»åŠ¨ä¸­å¿ƒç›¸å…³æ˜ å°„
INSERT INTO permission_api_mappings VALUES
(NULL, 'ACTIVITY_CENTER_VIEW', '/centers/activity', '/api/activities', 'GET', 
 'query_activities', 'æŸ¥è¯¢æ´»åŠ¨åˆ—è¡¨ï¼Œæ”¯æŒç­›é€‰å’Œåˆ†é¡µ', 
 '{"type":"object","properties":{"filters":{"type":"object"},"pagination":{"type":"object"}}}',
 '["activities", "activity_registrations"]', 'list', TRUE, NOW(), NOW()),

(NULL, 'ACTIVITY_CENTER_VIEW', '/centers/activity', '/api/activities/statistics', 'GET',
 'get_activity_statistics', 'è·å–æ´»åŠ¨ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬æ€»æ•°ã€å‚ä¸ç‡ç­‰',
 '{"type":"object","properties":{"timeRange":{"type":"string"}}}',
 '["activities", "activity_registrations", "activity_evaluations"]', 'statistics', TRUE, NOW(), NOW());

-- æ‹›ç”Ÿä¸­å¿ƒç›¸å…³æ˜ å°„
INSERT INTO permission_api_mappings VALUES
(NULL, 'ENROLLMENT_CENTER_VIEW', '/centers/enrollment', '/api/enrollment-applications', 'GET',
 'query_enrollment_applications', 'æŸ¥è¯¢æ‹›ç”Ÿç”³è¯·åˆ—è¡¨',
 '{"type":"object","properties":{"filters":{"type":"object"}}}',
 '["enrollment_applications", "students"]', 'list', TRUE, NOW(), NOW());
```

#### 2.4 è‡ªåŠ¨å·¥å…·ç”Ÿæˆæµç¨‹

```
ç”¨æˆ·ç™»å½• (userId=121, role=admin)
   â†“
æŸ¥è¯¢ç”¨æˆ·æƒé™:
  user_roles â†’ role_permissions â†’ permissions
   â†“
è·å–æƒé™ä»£ç :
  ['ACTIVITY_CENTER_VIEW', 'ENROLLMENT_CENTER_VIEW', ...]
   â†“
æŸ¥è¯¢ permission_api_mappings:
  WHERE permission_code IN (...)
   â†“
ç”Ÿæˆ AI å·¥å…·åˆ—è¡¨:
  [
    {name: 'query_activities', description: '...', parameters: {...}},
    {name: 'get_activity_statistics', description: '...', parameters: {...}},
    ...
  ]
   â†“
å¦‚æœæœ‰å½“å‰é¡µé¢ (/centers/activity):
  æŸ¥è¯¢ page_guides â†’ ç­›é€‰ç›¸å…³å·¥å…· (relatedTables åŒ¹é…)
   â†“
ç”Ÿæˆé¡µé¢ä¸Šä¸‹æ–‡æç¤ºè¯:
  "å½“å‰é¡µé¢: æ´»åŠ¨ä¸­å¿ƒ
   é¡µé¢åŠŸèƒ½: æ´»åŠ¨ç®¡ç†ã€æŠ¥åç®¡ç†ã€è¯„ä»·ç®¡ç†
   ç›¸å…³æ•°æ®è¡¨: activities, activity_registrations"
   â†“
å‘é€ç»™ AI:
  - å·¥å…·åˆ—è¡¨ (å·²è¿‡æ»¤æƒé™)
  - é¡µé¢ä¸Šä¸‹æ–‡
  - ç”¨æˆ·æŸ¥è¯¢
   â†“
AI é€‰æ‹©å·¥å…·å¹¶è°ƒç”¨
   â†“
è¿”å›ç»“æœ
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŸ¥è¯¢ç±»å‹ | ä¼ ç»Ÿæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ€§èƒ½æå‡ |
|---------|---------|--------|---------|
| å•å…³é”®è¯æŸ¥è¯¢ | 50-100ms | 50-100ms | æŒå¹³ |
| å¤šå…³é”®è¯æŸ¥è¯¢(3ä¸ª) | 3-5ç§’ (AIç”ŸæˆSQL) | 600-700ms (å¹¶è¡Œ+AI) | **5-8å€** |
| å¤æ‚åˆ†æ | 5-10ç§’ | 1-2ç§’ (å·¥å…·è°ƒç”¨) | **5-10å€** |
| Tokenæ¶ˆè€— | 100% | 20-30% | **é™ä½70-80%** |

---

## ğŸ› ï¸ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: å¤šå…³é”®è¯å¹¶è¡Œå¿«é€ŸæŸ¥è¯¢ (2-3å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `MultiKeywordQuickQueryService` æœåŠ¡
- [ ] å®šä¹‰ä¸šåŠ¡å…³é”®è¯æ˜ å°„è¡¨
- [ ] å®ç°å…³é”®è¯æ£€æµ‹é€»è¾‘
- [ ] å®ç°å¹¶è¡ŒæŸ¥è¯¢é€»è¾‘
- [ ] å®ç°ç»“æœæ ¼å¼åŒ–
- [ ] å®ç° AI æ ¼å¼åŒ–å›å¤
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**æ–‡ä»¶æ¸…å•**:
- `server/src/services/ai/multi-keyword-quick-query.service.ts` (æ–°å»º)
- `server/src/services/ai-operator/unified-intelligence.service.ts` (ä¿®æ”¹)

---

### é˜¶æ®µ2: æƒé™é©±åŠ¨å·¥å…·ç”Ÿæˆ (2-3å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `permission_api_mappings` æ•°æ®åº“è¡¨
- [ ] æ’å…¥åˆå§‹æ˜ å°„æ•°æ® (æ´»åŠ¨ã€æ‹›ç”Ÿã€å­¦ç”Ÿã€æ•™å¸ˆç­‰)
- [ ] åˆ›å»º `AutoToolGeneratorService` æœåŠ¡
- [ ] å®ç°ç”¨æˆ·æƒé™æŸ¥è¯¢
- [ ] å®ç°å·¥å…·åˆ—è¡¨ç”Ÿæˆ
- [ ] å®ç°é¡µé¢ä¸Šä¸‹æ–‡æ³¨å…¥
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**æ–‡ä»¶æ¸…å•**:
- `server/src/migrations/YYYYMMDDHHMMSS-create-permission-api-mappings.js` (æ–°å»º)
- `server/src/services/ai/tools/auto-tool-generator.service.ts` (æ–°å»º)

---

### é˜¶æ®µ3: APIå·¥å…·æ‰§è¡Œå™¨ (1-2å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `ApiToolExecutorService` æœåŠ¡
- [ ] å®ç°å·¥å…·æ˜ å°„æŸ¥è¯¢
- [ ] å®ç° API è°ƒç”¨é€»è¾‘
- [ ] å®ç°ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’
- [ ] å®ç°é”™è¯¯å¤„ç†
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**æ–‡ä»¶æ¸…å•**:
- `server/src/services/ai/tools/api-tool-executor.service.ts` (æ–°å»º)

---

### é˜¶æ®µ4: é›†æˆåˆ°ç»Ÿä¸€æ™ºèƒ½æœåŠ¡ (1-2å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] ä¿®æ”¹ `UnifiedIntelligenceService`
- [ ] é›†æˆå¤šå…³é”®è¯å¿«é€ŸæŸ¥è¯¢
- [ ] é›†æˆæƒé™é©±åŠ¨å·¥å…·ç”Ÿæˆ
- [ ] é›†æˆ API å·¥å…·æ‰§è¡Œå™¨
- [ ] å®ç°ä¸‰çº§åˆ†çº§é€»è¾‘
- [ ] ç¼–å†™é›†æˆæµ‹è¯•

**æ–‡ä»¶æ¸…å•**:
- `server/src/services/ai-operator/unified-intelligence.service.ts` (ä¿®æ”¹)
- `server/src/routes/ai/unified-intelligence.routes.ts` (ä¿®æ”¹)

---

### é˜¶æ®µ5: æµ‹è¯•å’Œä¼˜åŒ– (2-3å¤©)

**ä»»åŠ¡æ¸…å•**:
- [ ] æµ‹è¯•å¤šå…³é”®è¯æŸ¥è¯¢
- [ ] æµ‹è¯•ä¸åŒè§’è‰²çš„æƒé™è¿‡æ»¤
- [ ] æµ‹è¯•ä¸åŒé¡µé¢çš„ä¸Šä¸‹æ–‡æ³¨å…¥
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] ç¼–å†™å®Œæ•´æµ‹è¯•æ–‡æ¡£

---

## ğŸ“ API æ¥å£è®¾è®¡

### 1. ç»Ÿä¸€æ™ºèƒ½æŸ¥è¯¢æ¥å£

**ç«¯ç‚¹**: `POST /api/ai/unified-intelligence/query`

**è¯·æ±‚å‚æ•°**:
```typescript
{
  content: string;              // ç”¨æˆ·æŸ¥è¯¢å†…å®¹
  userId: number;               // ç”¨æˆ·ID
  userRole: string;             // ç”¨æˆ·è§’è‰²
  kindergartenId: number;       // å¹¼å„¿å›­ID
  context?: {
    currentPagePath?: string;   // å½“å‰é¡µé¢è·¯å¾„
    levelOverride?: string;     // å¼ºåˆ¶æŒ‡å®šçº§åˆ«
    enableWebSearch?: boolean;  // æ˜¯å¦å¯ç”¨ç½‘é¡µæœç´¢
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: boolean;
  content: string;              // AI å›å¤å†…å®¹
  metadata: {
    executionTime: number;      // æ‰§è¡Œæ—¶é—´(ms)
    level: string;              // ä½¿ç”¨çš„çº§åˆ«
    approach: string;           // å¤„ç†æ–¹å¼
    keywordsDetected?: string[]; // æ£€æµ‹åˆ°çš„å…³é”®è¯
    queriesExecuted?: number;   // æ‰§è¡Œçš„æŸ¥è¯¢æ•°é‡
    toolsUsed?: string[];       // ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨
  };
}
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•ç”¨ä¾‹1: å¤šå…³é”®è¯æŸ¥è¯¢

**è¾“å…¥**: "æŸ¥è¯¢å¸ˆèµ„ã€æ´»åŠ¨ã€æ‹›ç”Ÿæƒ…å†µ"

**é¢„æœŸç»“æœ**:
- æ£€æµ‹åˆ°å…³é”®è¯: ['å¸ˆèµ„', 'æ´»åŠ¨', 'æ‹›ç”Ÿ']
- æ‰§è¡Œæ—¶é—´: < 700ms
- è¿”å› AI æ ¼å¼åŒ–çš„å‹å¥½å›å¤
- metadata.level = 'level-1-multi-keyword'

---

### æµ‹è¯•ç”¨ä¾‹2: å•å…³é”®è¯æŸ¥è¯¢

**è¾“å…¥**: "å­¦ç”Ÿæ€»æ•°"

**é¢„æœŸç»“æœ**:
- ç›´æ¥åŒ¹é…æˆåŠŸ
- æ‰§è¡Œæ—¶é—´: < 100ms
- è¿”å›: "å½“å‰åœ¨æ ¡å­¦ç”Ÿæ€»æ•°ä¸º 1200 äºº"
- metadata.level = 'level-1'

---

### æµ‹è¯•ç”¨ä¾‹3: æƒé™è¿‡æ»¤

**åœºæ™¯**: æ•™å¸ˆè§’è‰²æŸ¥è¯¢å­¦ç”Ÿæ•°æ®

**è¾“å…¥**: "æŸ¥è¯¢å­¦ç”Ÿåˆ—è¡¨"

**é¢„æœŸç»“æœ**:
- ç”Ÿæˆçš„å·¥å…·åˆ—è¡¨åªåŒ…å«æ•™å¸ˆæœ‰æƒé™çš„å·¥å…·
- æŸ¥è¯¢ç»“æœåªåŒ…å«è¯¥æ•™å¸ˆç­çº§çš„å­¦ç”Ÿ
- ä¸ä¼šè¿”å›å…¶ä»–ç­çº§çš„å­¦ç”Ÿæ•°æ®

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

1. **å“åº”é€Ÿåº¦æå‡**: å¤šå…³é”®è¯æŸ¥è¯¢ä» 3-5ç§’ é™ä½åˆ° 600-700ms
2. **Token æ¶ˆè€—é™ä½**: 70-80% çš„æŸ¥è¯¢ä½¿ç”¨å¿«é€ŸæŸ¥è¯¢ï¼Œå¤§å¹…é™ä½æˆæœ¬
3. **ç”¨æˆ·ä½“éªŒæå‡**: AI æ ¼å¼åŒ–å›å¤æ›´å‹å¥½ã€æ›´ä¸“ä¸š
4. **å®‰å…¨æ€§æå‡**: æƒé™åœ¨ç³»ç»Ÿå±‚é¢è‡ªåŠ¨è¿‡æ»¤ï¼Œä¸ä¾èµ– AI åˆ¤æ–­
5. **å¯ç»´æŠ¤æ€§æå‡**: æ–°å¢åŠŸèƒ½åªéœ€æ›´æ–°æ˜ å°„è¡¨ï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç 

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸‰çº§åˆ†çº§æŸ¥è¯¢ç³»ç»Ÿè¯¦è§£.md](./ä¸‰çº§åˆ†çº§æŸ¥è¯¢ç³»ç»Ÿè¯¦è§£.md)
- [æç¤ºè¯åˆ†çº§.md](./æç¤ºè¯åˆ†çº§.md)
- [AIæ¶æ„/00-ç³»ç»Ÿæ¶æ„æ€»è§ˆ.md](./aiæ¶æ„/00-ç³»ç»Ÿæ¶æ„æ€»è§ˆ.md)
- [AIæ¶æ„/11-é›†æˆæµ‹è¯•æŒ‡å—.md](./aiæ¶æ„/11-é›†æˆæµ‹è¯•æŒ‡å—.md)

---

## ğŸ”„ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | è´Ÿè´£äºº |
|------|------|---------|--------|
| v1.0.0 | 2025-01-06 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆæ¶æ„è®¾è®¡ | AIå¼€å‘å›¢é˜Ÿ |

---

## ğŸ’» è¯¦ç»†ä»£ç å®ç°

### 1. MultiKeywordQuickQueryService å®Œæ•´å®ç°

**æ–‡ä»¶**: `server/src/services/ai/multi-keyword-quick-query.service.ts`

```typescript
import { QueryRouterService } from './query-router.service';
import { QuickQueryGroupsService } from './quick-query-groups.service';
import { DirectResponseService } from './direct-response.service';
import { logger } from '../../utils/logger';

/**
 * å¤šå…³é”®è¯å¹¶è¡Œå¿«é€ŸæŸ¥è¯¢æœåŠ¡
 */
export class MultiKeywordQuickQueryService {

  private static instance: MultiKeywordQuickQueryService;
  private queryRouter: QueryRouterService;
  private quickQueryGroups: QuickQueryGroupsService;
  private directResponseService: DirectResponseService;

  // ä¸šåŠ¡å…³é”®è¯æ˜ å°„
  private businessKeywords: Record<string, string[]> = {
    'å¸ˆèµ„': ['æ•™å¸ˆæ€»æ•°', 'æ•™å¸ˆåˆ—è¡¨', 'æ•™å¸ˆç»Ÿè®¡'],
    'æ•™å¸ˆ': ['æ•™å¸ˆæ€»æ•°', 'æ•™å¸ˆåˆ—è¡¨', 'æ•™å¸ˆç»Ÿè®¡'],
    'è€å¸ˆ': ['æ•™å¸ˆæ€»æ•°', 'æ•™å¸ˆåˆ—è¡¨', 'æ•™å¸ˆç»Ÿè®¡'],
    'æ´»åŠ¨': ['ä»Šæ—¥æ´»åŠ¨', 'æ´»åŠ¨åˆ—è¡¨', 'æœ¬å‘¨æ´»åŠ¨å®‰æ’', 'æ´»åŠ¨ç»Ÿè®¡'],
    'æ‹›ç”Ÿ': ['æ‹›ç”Ÿç»Ÿè®¡', 'æœ¬æœˆæ‹›ç”Ÿäººæ•°', 'æ‹›ç”Ÿç”³è¯·æ•°é‡', 'æ‹›ç”Ÿè½¬åŒ–ç‡'],
    'å­¦ç”Ÿ': ['å­¦ç”Ÿæ€»æ•°', 'å­¦ç”Ÿåˆ—è¡¨', 'å„ç­çº§å­¦ç”Ÿäººæ•°åˆ†å¸ƒ'],
    'ç­çº§': ['ç­çº§æ€»æ•°', 'ç­çº§åˆ—è¡¨', 'ç­çº§å®¹é‡'],
    'è´¢åŠ¡': ['è´¹ç”¨ç»Ÿè®¡', 'æœ¬æœˆæ”¶å…¥', 'ç¼´è´¹ç‡'],
    'å®¶é•¿': ['å®¶é•¿æ€»æ•°', 'å®¶é•¿åé¦ˆç»Ÿè®¡'],
    'è¯¾ç¨‹': ['ä»Šæ—¥è¯¾ç¨‹', 'æœ¬å‘¨è¯¾ç¨‹', 'è¯¾ç¨‹è¡¨'],
    'è€ƒå‹¤': ['ä»Šæ—¥è€ƒå‹¤', 'è€ƒå‹¤ç»Ÿè®¡', 'ç¼ºå‹¤ç»Ÿè®¡']
  };

  private constructor() {
    this.queryRouter = QueryRouterService.getInstance();
    this.quickQueryGroups = QuickQueryGroupsService.getInstance();
    this.directResponseService = DirectResponseService.getInstance();
  }

  public static getInstance(): MultiKeywordQuickQueryService {
    if (!MultiKeywordQuickQueryService.instance) {
      MultiKeywordQuickQueryService.instance = new MultiKeywordQuickQueryService();
    }
    return MultiKeywordQuickQueryService.instance;
  }

  /**
   * æ£€æµ‹æŸ¥è¯¢æ˜¯å¦åŒ…å«å¤šä¸ªä¸šåŠ¡å…³é”®è¯
   */
  detectMultipleKeywords(query: string): string[] {
    const detectedKeywords: string[] = [];
    const queryLower = query.toLowerCase();

    for (const keyword of Object.keys(this.businessKeywords)) {
      if (queryLower.includes(keyword)) {
        detectedKeywords.push(keyword);
      }
    }

    logger.info(`[MultiKeywordQuickQuery] æ£€æµ‹åˆ°å…³é”®è¯: ${detectedKeywords.join(', ')}`);
    return detectedKeywords;
  }

  /**
   * å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¿«é€ŸæŸ¥è¯¢
   */
  async executeParallelQuickQueries(
    keywords: string[],
    userContext: {
      userId: number;
      role: string;
      kindergartenId: number;
    }
  ): Promise<{
    success: boolean;
    results: Array<{
      keyword: string;
      queries: Array<{
        queryName: string;
        result: any;
        executionTime: number;
        success: boolean;
      }>;
    }>;
    totalExecutionTime: number;
  }> {

    const startTime = Date.now();
    logger.info(`[MultiKeywordQuickQuery] å¼€å§‹å¹¶è¡ŒæŸ¥è¯¢: ${keywords.join(', ')}`);

    // ä¸ºæ¯ä¸ªå…³é”®è¯è·å–ç›¸å…³çš„å¿«é€ŸæŸ¥è¯¢
    const queryTasks = keywords.map(async (keyword) => {
      const relatedQueries = this.businessKeywords[keyword] || [];

      // å¹¶è¡Œæ‰§è¡Œè¯¥å…³é”®è¯ä¸‹çš„æ‰€æœ‰æŸ¥è¯¢
      const queryResults = await Promise.all(
        relatedQueries.map(async (queryName) => {
          const queryStartTime = Date.now();

          try {
            // è°ƒç”¨å¿«é€ŸæŸ¥è¯¢
            const result = await this.executeQuickQuery(queryName, userContext);

            return {
              queryName,
              result,
              executionTime: Date.now() - queryStartTime,
              success: true
            };
          } catch (error) {
            logger.error(`[MultiKeywordQuickQuery] æŸ¥è¯¢å¤±è´¥: ${queryName}`, error);
            return {
              queryName,
              result: null,
              executionTime: Date.now() - queryStartTime,
              success: false,
              error: (error as Error).message
            };
          }
        })
      );

      return {
        keyword,
        queries: queryResults
      };
    });

    // ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
    const results = await Promise.all(queryTasks);
    const totalExecutionTime = Date.now() - startTime;

    logger.info(`[MultiKeywordQuickQuery] å¹¶è¡ŒæŸ¥è¯¢å®Œæˆ, è€—æ—¶: ${totalExecutionTime}ms`);

    return {
      success: true,
      results,
      totalExecutionTime
    };
  }

  /**
   * æ‰§è¡Œå•ä¸ªå¿«é€ŸæŸ¥è¯¢
   */
  private async executeQuickQuery(
    queryName: string,
    userContext: {
      userId: number;
      role: string;
      kindergartenId: number;
    }
  ): Promise<any> {

    // 1. æ£€æŸ¥ç›´æ¥åŒ¹é…
    const directMatch = this.queryRouter.checkDirectMatch(queryName);

    if (!directMatch) {
      throw new Error(`æœªæ‰¾åˆ°æŸ¥è¯¢: ${queryName}`);
    }

    // 2. æ ¹æ®actionæ‰§è¡Œç›¸åº”çš„æŸ¥è¯¢
    const action = directMatch.action;

    if (!action) {
      return { message: directMatch.response };
    }

    // 3. è°ƒç”¨DirectResponseServiceæ‰§è¡ŒæŸ¥è¯¢
    const result = await this.directResponseService.executeAction(
      action,
      userContext
    );

    return result;
  }

  /**
   * æ ¼å¼åŒ–ç»“æœä¾›AIä½¿ç”¨
   */
  formatResultsForAI(results: any): string {
    let formattedText = '## å¿«é€ŸæŸ¥è¯¢ç»“æœ\n\n';

    results.results.forEach((keywordResult: any) => {
      formattedText += `### ${keywordResult.keyword}\n\n`;

      keywordResult.queries.forEach((query: any) => {
        if (query.success) {
          formattedText += `**${query.queryName}**: `;

          if (typeof query.result === 'object') {
            // æ ¼å¼åŒ–å¯¹è±¡æ•°æ®
            if (query.result.count !== undefined) {
              formattedText += `${query.result.count}`;
            } else if (query.result.data) {
              formattedText += JSON.stringify(query.result.data, null, 2);
            } else {
              formattedText += JSON.stringify(query.result, null, 2);
            }
          } else {
            formattedText += query.result;
          }

          formattedText += `\n`;
        } else {
          formattedText += `**${query.queryName}**: æŸ¥è¯¢å¤±è´¥\n`;
        }
      });

      formattedText += `\n`;
    });

    formattedText += `\n**æ€»æ‰§è¡Œæ—¶é—´**: ${results.totalExecutionTime}ms\n`;

    return formattedText;
  }
}
```

---

### 2. AutoToolGeneratorService å®Œæ•´å®ç°

**æ–‡ä»¶**: `server/src/services/ai/tools/auto-tool-generator.service.ts`

```typescript
import { Permission } from '../../../models/permission.model';
import { RolePermission } from '../../../models/role-permission.model';
import { UserRole } from '../../../models/user-role.model';
import { PageGuide } from '../../../models/page-guide.model';
import { logger } from '../../../utils/logger';

/**
 * æƒé™é©±åŠ¨çš„è‡ªåŠ¨å·¥å…·ç”ŸæˆæœåŠ¡
 */
export class AutoToolGeneratorService {

  /**
   * ä¸ºç”¨æˆ·ç”Ÿæˆå¯ç”¨çš„å·¥å…·åˆ—è¡¨
   */
  static async generateToolsForUser(
    userId: number,
    currentPagePath?: string
  ): Promise<any[]> {

    logger.info(`[AutoToolGenerator] ä¸ºç”¨æˆ· ${userId} ç”Ÿæˆå·¥å…·åˆ—è¡¨`);

    // 1. è·å–ç”¨æˆ·æƒé™
    const permissionCodes = await this.getUserPermissions(userId);
    logger.info(`[AutoToolGenerator] ç”¨æˆ·æƒé™: ${permissionCodes.join(', ')}`);

    // 2. æ ¹æ®æƒé™è·å–APIæ˜ å°„
    const apiMappings = await this.getApiMappingsByPermissions(permissionCodes);
    logger.info(`[AutoToolGenerator] æ‰¾åˆ° ${apiMappings.length} ä¸ªAPIæ˜ å°„`);

    // 3. å¦‚æœæœ‰å½“å‰é¡µé¢ï¼Œç­›é€‰ç›¸å…³å·¥å…·
    let filteredMappings = apiMappings;
    if (currentPagePath) {
      filteredMappings = await this.getPageRelatedTools(currentPagePath, apiMappings);
      logger.info(`[AutoToolGenerator] é¡µé¢ç›¸å…³å·¥å…·: ${filteredMappings.length} ä¸ª`);
    }

    // 4. è½¬æ¢ä¸ºAIå·¥å…·æ ¼å¼
    const tools = filteredMappings.map(mapping => this.convertToAITool(mapping));

    return tools;
  }

  /**
   * è·å–ç”¨æˆ·æƒé™ä»£ç åˆ—è¡¨
   */
  private static async getUserPermissions(userId: number): Promise<string[]> {

    // æŸ¥è¯¢: user_roles â†’ role_permissions â†’ permissions
    const userRoles = await UserRole.findAll({
      where: { userId },
      include: [{
        model: RolePermission,
        as: 'rolePermissions',
        include: [{
          model: Permission,
          as: 'permission'
        }]
      }]
    });

    const permissionCodes: string[] = [];

    userRoles.forEach((userRole: any) => {
      userRole.rolePermissions?.forEach((rolePermission: any) => {
        if (rolePermission.permission?.code) {
          permissionCodes.push(rolePermission.permission.code);
        }
      });
    });

    return [...new Set(permissionCodes)]; // å»é‡
  }

  /**
   * æ ¹æ®æƒé™è·å–APIæ˜ å°„
   */
  private static async getApiMappingsByPermissions(
    permissionCodes: string[]
  ): Promise<any[]> {

    // æŸ¥è¯¢ permission_api_mappings è¡¨
    const { sequelize } = await import('../../../config/database');

    const [results] = await sequelize.query(`
      SELECT * FROM permission_api_mappings
      WHERE permission_code IN (:permissionCodes)
        AND is_active = TRUE
      ORDER BY tool_name
    `, {
      replacements: { permissionCodes }
    });

    return results as any[];
  }

  /**
   * è·å–é¡µé¢ç›¸å…³çš„å·¥å…·
   */
  private static async getPageRelatedTools(
    pagePath: string,
    allMappings: any[]
  ): Promise<any[]> {

    // æŸ¥è¯¢é¡µé¢æ„ŸçŸ¥æ•°æ®
    const pageGuide = await PageGuide.findOne({
      where: { pagePath }
    });

    if (!pageGuide || !pageGuide.relatedTables) {
      return allMappings;
    }

    const relatedTables = JSON.parse(pageGuide.relatedTables as string);

    // ç­›é€‰ç›¸å…³å·¥å…·
    const filteredMappings = allMappings.filter(mapping => {
      if (!mapping.related_tables) return false;

      const mappingTables = JSON.parse(mapping.related_tables);

      // æ£€æŸ¥æ˜¯å¦æœ‰äº¤é›†
      return mappingTables.some((table: string) => relatedTables.includes(table));
    });

    return filteredMappings;
  }

  /**
   * è½¬æ¢ä¸ºAIå·¥å…·æ ¼å¼
   */
  private static convertToAITool(mapping: any): any {
    return {
      type: 'function',
      function: {
        name: mapping.tool_name,
        description: mapping.tool_description,
        parameters: mapping.tool_parameters ? JSON.parse(mapping.tool_parameters) : {
          type: 'object',
          properties: {}
        }
      }
    };
  }

  /**
   * ç”Ÿæˆé¡µé¢ä¸Šä¸‹æ–‡æç¤ºè¯
   */
  static async generatePageContextPrompt(
    pagePath: string,
    userRole: string
  ): Promise<string> {

    const pageGuide = await PageGuide.findOne({
      where: { pagePath }
    });

    if (!pageGuide) {
      return '';
    }

    let prompt = `## å½“å‰é¡µé¢ä¸Šä¸‹æ–‡\n\n`;
    prompt += `**é¡µé¢**: ${pageGuide.pageName}\n`;
    prompt += `**æè¿°**: ${pageGuide.pageDescription}\n`;

    if (pageGuide.contextPrompt) {
      prompt += `\n${pageGuide.contextPrompt}\n`;
    }

    if (pageGuide.relatedTables) {
      const tables = JSON.parse(pageGuide.relatedTables as string);
      prompt += `\n**ç›¸å…³æ•°æ®è¡¨**: ${tables.join(', ')}\n`;
    }

    return prompt;
  }
}
```

---

**æ–‡æ¡£ç»“æŸ**

