# AIåŠ©æ‰‹è§’è‰²æƒé™é…ç½®æ›´æ–°è¯´æ˜

## ğŸ“‹ æ›´æ–°å†…å®¹

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œå¯¹è§’è‰²æƒé™é…ç½®è¿›è¡Œäº†ä»¥ä¸‹æ›´æ–°ï¼š

### 1. æ–°å¢ç³»ç»Ÿç®¡ç†å‘˜è§’è‰² (super_admin)

**æƒé™èŒƒå›´**: æ‹¥æœ‰æ‰€æœ‰è¡¨çš„è®¿é—®æƒé™ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé…ç½®

**å…è®¸è®¿é—®çš„è¡¨ï¼ˆ17å¼ ï¼‰**:

#### ç”¨æˆ·æƒé™ç³»ç»Ÿï¼ˆ5å¼ ï¼‰
- `users` - ç”¨æˆ·è¡¨
- `roles` - è§’è‰²è¡¨
- `permissions` - æƒé™è¡¨
- `user_roles` - ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
- `role_permissions` - è§’è‰²æƒé™å…³ç³»è¡¨

#### ç³»ç»Ÿé…ç½®ï¼ˆ3å¼ ï¼‰
- `system_configs` - ç³»ç»Ÿé…ç½®è¡¨
- `system_logs` - ç³»ç»Ÿæ—¥å¿—è¡¨
- `ai_model_configs` - AIæ¨¡å‹é…ç½®è¡¨

#### ä¸šåŠ¡æ•°æ®ï¼ˆ9å¼ ï¼‰
- `teachers` - æ•™å¸ˆè¡¨
- `students` - å­¦ç”Ÿè¡¨
- `classes` - ç­çº§è¡¨
- `class_teachers` - ç­çº§æ•™å¸ˆå…³ç³»è¡¨
- `parents` - å®¶é•¿è¡¨
- `activities` - æ´»åŠ¨è¡¨
- `activity_registrations` - æ´»åŠ¨æŠ¥åè¡¨
- `enrollment_applications` - æ‹›ç”Ÿç”³è¯·è¡¨
- `marketing_campaigns` - è¥é”€æ´»åŠ¨è¡¨

**ç¦æ­¢è®¿é—®çš„è¡¨**: æ— 

**æ•°æ®èŒƒå›´é™åˆ¶**: æ— 

---

### 2. æ–°å¢å›­é•¿è§’è‰² (principal)

**æƒé™èŒƒå›´**: æ‹¥æœ‰å¹¼å„¿å›­ä¸šåŠ¡æ•°æ®çš„å®Œæ•´è®¿é—®æƒé™ï¼Œä½†ä¸èƒ½è®¿é—®ç³»ç»Ÿé…ç½®

**å…è®¸è®¿é—®çš„è¡¨ï¼ˆ10å¼ ï¼‰**:
- `users` - ç”¨æˆ·è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ç”¨æˆ·ï¼‰
- `teachers` - æ•™å¸ˆè¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `students` - å­¦ç”Ÿè¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `classes` - ç­çº§è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `class_teachers` - ç­çº§æ•™å¸ˆå…³ç³»è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `parents` - å®¶é•¿è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­å­¦ç”Ÿçš„å®¶é•¿ï¼‰
- `activities` - æ´»åŠ¨è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `activity_registrations` - æ´»åŠ¨æŠ¥åè¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `enrollment_applications` - æ‹›ç”Ÿç”³è¯·è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰
- `marketing_campaigns` - è¥é”€æ´»åŠ¨è¡¨ï¼ˆä»…é™æœ¬å¹¼å„¿å›­ï¼‰

**ç¦æ­¢è®¿é—®çš„è¡¨ï¼ˆ9å¼ ï¼‰**:
- `roles` - è§’è‰²è¡¨
- `permissions` - æƒé™è¡¨
- `user_roles` - ç”¨æˆ·è§’è‰²å…³ç³»
- `role_permissions` - è§’è‰²æƒé™å…³ç³»
- `system_configs` - ç³»ç»Ÿé…ç½®
- `system_logs` - ç³»ç»Ÿæ—¥å¿—
- `ai_model_configs` - AIæ¨¡å‹é…ç½®
- `ai_conversations` - AIå¯¹è¯è®°å½•
- `ai_memories` - AIè®°å¿†

**æ•°æ®èŒƒå›´é™åˆ¶**: æ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»æ·»åŠ  `kindergarten_id = {current_kindergarten_id}` æ¡ä»¶

---

### 3. ç®¡ç†å‘˜è§’è‰² (admin) æ˜ å°„åˆ°å›­é•¿

**è¯´æ˜**: ä¸ºäº†å‘åå…¼å®¹ï¼Œ`admin` è§’è‰²ç°åœ¨ç­‰åŒäº `principal` è§’è‰²

**å®ç°æ–¹å¼**:
```typescript
// adminè§’è‰²é…ç½®ä¸ºç©ºï¼Œè¿è¡Œæ—¶è‡ªåŠ¨ä½¿ç”¨principalçš„é…ç½®
'admin': {
  roleName: 'admin',
  description: 'ç®¡ç†å‘˜ - ç­‰åŒäºå›­é•¿è§’è‰²',
  allowedTables: [],  // å°†ä½¿ç”¨principalçš„é…ç½®
  forbiddenTables: []
}
```

**æƒé™æ£€æŸ¥å‡½æ•°è‡ªåŠ¨æ˜ å°„**:
```typescript
// checkTablePermission() å‡½æ•°
if (role.toLowerCase() === 'admin' && rolePermissions.allowedTables.length === 0) {
  rolePermissions = ROLE_TABLE_PERMISSIONS['principal'];
  console.log(`[æƒé™æ£€æŸ¥] adminè§’è‰²ä½¿ç”¨principalé…ç½®`);
}
```

---

## ğŸ“Š è§’è‰²æƒé™å¯¹æ¯”è¡¨

| åŠŸèƒ½/è¡¨ | super_admin | principal/admin | teacher | parent |
|---------|-------------|-----------------|---------|--------|
| **ç”¨æˆ·æƒé™ç³»ç»Ÿ** | | | | |
| users | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âŒ | âŒ |
| roles | âœ… | âŒ | âŒ | âŒ |
| permissions | âœ… | âŒ | âŒ | âŒ |
| user_roles | âœ… | âŒ | âŒ | âŒ |
| role_permissions | âœ… | âŒ | âŒ | âŒ |
| **ç³»ç»Ÿé…ç½®** | | | | |
| system_configs | âœ… | âŒ | âŒ | âŒ |
| system_logs | âœ… | âŒ | âŒ | âŒ |
| ai_model_configs | âœ… | âŒ | âŒ | âŒ |
| **ä¸šåŠ¡æ•°æ®** | | | | |
| teachers | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âŒ | âŒ |
| students | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬ç­ | âœ… è‡ªå·±å­©å­ |
| classes | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬ç­ | âœ… å­©å­ç­çº§ |
| class_teachers | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬äºº | âŒ |
| parents | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âŒ | âŒ |
| activities | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬å›­ | âœ… æœ¬å›­ |
| activity_registrations | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬ç­å­¦ç”Ÿ | âœ… è‡ªå·±å­©å­ |
| activity_evaluations | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âœ… æœ¬äººåˆ›å»º | âŒ |
| enrollment_applications | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âŒ | âŒ |
| marketing_campaigns | âœ… å…¨éƒ¨ | âœ… æœ¬å›­ | âŒ | âŒ |

---

## ğŸ”’ å®‰å…¨ä¿éšœ

### ç³»ç»Ÿç®¡ç†å‘˜ (super_admin)
- âœ… å¯ä»¥è®¿é—®æ‰€æœ‰è¡¨
- âœ… å¯ä»¥æŸ¥è¯¢ç”¨æˆ·ã€è§’è‰²ã€æƒé™é…ç½®
- âœ… å¯ä»¥æŸ¥è¯¢ç³»ç»Ÿé…ç½®å’Œæ—¥å¿—
- âœ… å¯ä»¥æŸ¥è¯¢AIæ¨¡å‹é…ç½®
- âœ… æ— æ•°æ®èŒƒå›´é™åˆ¶

### å›­é•¿/ç®¡ç†å‘˜ (principal/admin)
- âœ… å¯ä»¥è®¿é—®æœ¬å¹¼å„¿å›­çš„æ‰€æœ‰ä¸šåŠ¡æ•°æ®
- âŒ ä¸èƒ½è®¿é—®ç”¨æˆ·è§’è‰²æƒé™é…ç½®
- âŒ ä¸èƒ½è®¿é—®ç³»ç»Ÿé…ç½®å’Œæ—¥å¿—
- âŒ ä¸èƒ½è®¿é—®AIæ¨¡å‹é…ç½®
- ğŸ”’ æ‰€æœ‰æŸ¥è¯¢å¿…é¡»é™åˆ¶åœ¨æœ¬å¹¼å„¿å›­èŒƒå›´å†…

### æ•™å¸ˆ (teacher)
- âœ… åªèƒ½è®¿é—®è‡ªå·±è´Ÿè´£çš„ç­çº§å’Œå­¦ç”Ÿ
- âŒ ä¸èƒ½è®¿é—®å…¶ä»–æ•™å¸ˆä¿¡æ¯
- âŒ ä¸èƒ½è®¿é—®å®¶é•¿ä¿¡æ¯
- âŒ ä¸èƒ½è®¿é—®æ‹›ç”Ÿå’Œè¥é”€æ•°æ®
- ğŸ”’ æ‰€æœ‰æŸ¥è¯¢å¿…é¡»é™åˆ¶åœ¨è‡ªå·±ç­çº§èŒƒå›´å†…

### å®¶é•¿ (parent)
- âœ… åªèƒ½è®¿é—®è‡ªå·±å­©å­çš„ä¿¡æ¯
- âŒ ä¸èƒ½è®¿é—®å…¶ä»–å­¦ç”Ÿä¿¡æ¯
- âŒ ä¸èƒ½è®¿é—®æ•™å¸ˆä¿¡æ¯
- âŒ ä¸èƒ½è®¿é—®ç­çº§ç®¡ç†æ•°æ®
- ğŸ”’ æ‰€æœ‰æŸ¥è¯¢å¿…é¡»é™åˆ¶åœ¨è‡ªå·±å­©å­èŒƒå›´å†…

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. server/src/config/role-table-permissions.ts

**æ–°å¢å†…å®¹**:
- `super_admin` è§’è‰²é…ç½®ï¼ˆ17å¼ è¡¨ï¼‰
- `principal` è§’è‰²é…ç½®ï¼ˆ10å¼ è¡¨ï¼Œ9å¼ ç¦æ­¢è¡¨ï¼‰
- `admin` è§’è‰²é…ç½®ï¼ˆæ˜ å°„åˆ°principalï¼‰

**ä¿®æ”¹å‡½æ•°**:
- `checkTablePermission()` - æ·»åŠ adminåˆ°principalçš„æ˜ å°„é€»è¾‘
- `getTablePermission()` - æ·»åŠ adminåˆ°principalçš„æ˜ å°„é€»è¾‘

### 2. server/src/utils/database-schema.ts

**ä¿®æ”¹å‡½æ•°**:
- `getDatabaseSchemaForRole()` - æ·»åŠ adminåˆ°principalçš„æ˜ å°„é€»è¾‘

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç³»ç»Ÿç®¡ç†å‘˜æŸ¥è¯¢ç”¨æˆ·è§’è‰²é…ç½®
```typescript
// ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æŸ¥è¯¢è§’è‰²è¡¨
const result = await anyQuery({
  userQuery: 'æŸ¥è¯¢æ‰€æœ‰è§’è‰²åŠå…¶æƒé™æ•°é‡',
  userRole: 'super_admin'
});

// ç”Ÿæˆçš„SQLï¼ˆå…è®¸ï¼‰:
// SELECT r.name, r.code, COUNT(rp.permission_id) as permission_count
// FROM roles r
// LEFT JOIN role_permissions rp ON r.id = rp.role_id
// GROUP BY r.id
// LIMIT 100
```

### å›­é•¿æŸ¥è¯¢æœ¬å›­æ•™å¸ˆ
```typescript
// å›­é•¿å¯ä»¥æŸ¥è¯¢æœ¬å¹¼å„¿å›­çš„æ•™å¸ˆ
const result = await anyQuery({
  userQuery: 'æŸ¥è¯¢æœ¬å›­æ‰€æœ‰æ•™å¸ˆ',
  userRole: 'principal'
});

// ç”Ÿæˆçš„SQLï¼ˆå…è®¸ï¼Œè‡ªåŠ¨æ·»åŠ èŒƒå›´é™åˆ¶ï¼‰:
// SELECT * FROM teachers
// WHERE teachers.kindergarten_id = {current_kindergarten_id}
// LIMIT 100
```

### å›­é•¿å°è¯•æŸ¥è¯¢ç³»ç»Ÿé…ç½®
```typescript
// å›­é•¿å°è¯•æŸ¥è¯¢ç³»ç»Ÿé…ç½®
const result = await anyQuery({
  userQuery: 'æŸ¥è¯¢ç³»ç»Ÿé…ç½®',
  userRole: 'principal'
});

// ç»“æœï¼šâŒ è¢«æ‹’ç»
// é”™è¯¯ï¼šè§’è‰² principal æ— æƒè®¿é—®è¡¨ system_configs
```

### æ•™å¸ˆå°è¯•æŸ¥è¯¢å…¶ä»–æ•™å¸ˆ
```typescript
// æ•™å¸ˆå°è¯•æŸ¥è¯¢å…¶ä»–æ•™å¸ˆ
const result = await anyQuery({
  userQuery: 'æŸ¥è¯¢æ‰€æœ‰æ•™å¸ˆ',
  userRole: 'teacher'
});

// ç»“æœï¼šâŒ è¢«æ‹’ç»
// é”™è¯¯ï¼šè§’è‰² teacher æ— æƒè®¿é—®è¡¨ teachers
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1: ç³»ç»Ÿç®¡ç†å‘˜è®¿é—®ç³»ç»Ÿé…ç½®
```sql
SELECT * FROM system_configs WHERE status = 'active'
```
- **è§’è‰²**: super_admin
- **ç»“æœ**: âœ… å…è®¸

### æµ‹è¯•ç”¨ä¾‹2: å›­é•¿è®¿é—®ç³»ç»Ÿé…ç½®
```sql
SELECT * FROM system_configs WHERE status = 'active'
```
- **è§’è‰²**: principal
- **ç»“æœ**: âŒ è¢«æ‹’ç»ï¼ˆsystem_configsåœ¨ç¦æ­¢åˆ—è¡¨ä¸­ï¼‰

### æµ‹è¯•ç”¨ä¾‹3: å›­é•¿æŸ¥è¯¢æœ¬å›­å­¦ç”Ÿ
```sql
SELECT * FROM students WHERE kindergarten_id = 1
```
- **è§’è‰²**: principal
- **ç»“æœ**: âœ… å…è®¸ï¼ˆç¬¦åˆæ•°æ®èŒƒå›´é™åˆ¶ï¼‰

### æµ‹è¯•ç”¨ä¾‹4: adminè§’è‰²æŸ¥è¯¢æ•™å¸ˆ
```sql
SELECT * FROM teachers WHERE kindergarten_id = 1
```
- **è§’è‰²**: admin
- **ç»“æœ**: âœ… å…è®¸ï¼ˆä½¿ç”¨principalé…ç½®ï¼‰

---

## ğŸ”„ å‘åå…¼å®¹æ€§

### adminè§’è‰²å…¼å®¹æ€§
- âœ… ç°æœ‰ä½¿ç”¨ `admin` è§’è‰²çš„ä»£ç æ— éœ€ä¿®æ”¹
- âœ… `admin` è‡ªåŠ¨æ˜ å°„åˆ° `principal` é…ç½®
- âœ… æƒé™èŒƒå›´ä¸å›­é•¿å®Œå…¨ä¸€è‡´
- âœ… æ•°æ®èŒƒå›´é™åˆ¶ä¸å›­é•¿å®Œå…¨ä¸€è‡´

### å‡çº§å»ºè®®
1. å¦‚æœéœ€è¦ç³»ç»Ÿçº§æƒé™ï¼Œè¯·ä½¿ç”¨ `super_admin` è§’è‰²
2. å¦‚æœåªéœ€è¦å¹¼å„¿å›­ä¸šåŠ¡æƒé™ï¼Œç»§ç»­ä½¿ç”¨ `admin` æˆ– `principal` è§’è‰²
3. å»ºè®®é€æ­¥å°† `admin` è§’è‰²è¿ç§»åˆ° `principal` è§’è‰²ï¼ˆæ›´è¯­ä¹‰åŒ–ï¼‰

---

## ğŸ“‹ æ€»ç»“

### è§’è‰²å±‚æ¬¡
```
super_admin (ç³»ç»Ÿç®¡ç†å‘˜)
    â†“
principal/admin (å›­é•¿/ç®¡ç†å‘˜)
    â†“
teacher (æ•™å¸ˆ)
    â†“
parent (å®¶é•¿)
```

### æƒé™èŒƒå›´
- **super_admin**: å…¨ç³»ç»Ÿ
- **principal/admin**: å•ä¸ªå¹¼å„¿å›­
- **teacher**: è‡ªå·±è´Ÿè´£çš„ç­çº§
- **parent**: è‡ªå·±çš„å­©å­

### å®‰å…¨ä¿éšœ
- âœ… å››çº§è§’è‰²æƒé™ä½“ç³»
- âœ… ç™½åå•+é»‘åå•åŒé‡ä¿æŠ¤
- âœ… å­—æ®µçº§è®¿é—®æ§åˆ¶
- âœ… å¼ºåˆ¶æ•°æ®èŒƒå›´é™åˆ¶
- âœ… ä¸‰å±‚å®‰å…¨æ£€æŸ¥æœºåˆ¶
- âœ… é›¶æ¸—æ¼é£é™©

---

**æ›´æ–°æ—¶é—´**: 2025-10-07  
**æ›´æ–°äººå‘˜**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¾…ç”¨æˆ·éªŒè¯

