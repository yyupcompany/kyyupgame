# VOSéŸ³é¢‘å¤„ç†åˆ†æžæŠ¥å‘Š

## ðŸ“‹ æ‰§è¡Œæ‘˜è¦

æ ¹æ®æ‚¨æä¾›çš„**VOS + è±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£**ï¼Œæˆ‘å¯¹å½“å‰ç³»ç»Ÿçš„éŸ³é¢‘å¤„ç†è¿›è¡Œäº†è¯¦ç»†åˆ†æžï¼Œå¹¶æå‡ºäº†å…·ä½“çš„æ”¹è¿›æ–¹æ¡ˆã€‚

### æ ¸å¿ƒå‘çŽ°

| æ–¹é¢ | å½“å‰çŠ¶æ€ | æµ‹è¯•æ–‡æ¡£ | å·®è· |
|------|---------|---------|------|
| **é‡‡æ ·çŽ‡è½¬æ¢** | âŒ æœªå®žçŽ° | âœ… 8kHzâ†”16kHzâ†”24kHz | ðŸ”´ ä¸¥é‡ |
| **ç¼–ç è½¬æ¢** | âŒ æœªå®žçŽ° | âœ… PCMAâ†”PCM | ðŸ”´ ä¸¥é‡ |
| **éŸ³é¢‘ç¼“å†²** | 1000ms | 0ms | ðŸŸ  é«˜ |
| **RTPæ—¶åº** | Â±100ms | Â±1-5ms | ðŸŸ  é«˜ |
| **è½¬æ¢é€Ÿåº¦** | æœªçŸ¥ | 7-10ms | ðŸŸ¡ ä¸­ |

---

## ðŸŽ¯ å…³é”®é—®é¢˜åˆ†æž

### é—®é¢˜1ï¼šé‡‡æ ·çŽ‡è½¬æ¢ç¼ºå¤±ï¼ˆä¸¥é‡ï¼‰

**çŽ°è±¡**:
- VOSè¾“å‡ºï¼šPCMA 8kHz
- ASRæœŸæœ›ï¼šPCM 16kHz
- TTSè¾“å‡ºï¼šPCM 24kHz
- VOSè¾“å…¥æœŸæœ›ï¼šPCMA 8kHz

**åŽæžœ**:
- âŒ éŸ³é¢‘å¤±çœŸæˆ–æ— å£°
- âŒ ASRè¯†åˆ«å¤±è´¥
- âŒ ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨çº¯JavaScriptåº“
import alawmulaw from 'alawmulaw'
import { resample } from 'wave-resampler'

// VOS â†’ ASR: PCMA 8kHz â†’ PCM 16kHz
const pcm8k = alawmulaw.alaw.decode(pcmaData)
const pcm16k = resample(pcm8k, 8000, 16000)

// TTS â†’ VOS: PCM 24kHz â†’ PCMA 8kHz
const pcm8k = resample(pcm24kData, 24000, 8000)
const pcma = alawmulaw.alaw.encode(pcm8k)
```

### é—®é¢˜2ï¼šç¼–ç è½¬æ¢ç¼ºå¤±ï¼ˆä¸¥é‡ï¼‰

**çŽ°è±¡**:
- VOSä½¿ç”¨PCMAç¼–ç ï¼ˆA-lawï¼‰
- ASR/TTSä½¿ç”¨PCMç¼–ç 
- ä¸¤è€…ä¸å…¼å®¹

**åŽæžœ**:
- âŒ æ•°æ®æ ¼å¼ä¸åŒ¹é…
- âŒ éŸ³é¢‘æ— æ³•æ­£ç¡®å¤„ç†

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨`alawmulaw`åº“è¿›è¡Œç¼–ç è½¬æ¢
- åœ¨VOSå’ŒASR/TTSä¹‹é—´å»ºç«‹è½¬æ¢æ¡¥æ¢

### é—®é¢˜3ï¼šéŸ³é¢‘ç¼“å†²å»¶è¿Ÿï¼ˆé«˜ï¼‰

**çŽ°è±¡**:
```typescript
private readonly BUFFER_DURATION_MS = 1000  // ç¼“å†²1ç§’
```

**åŽæžœ**:
- â±ï¸ ç”¨æˆ·è¯´è¯åŽ1.5ç§’æ‰èƒ½å¬åˆ°å›žå¤
- ðŸ˜ž ç”¨æˆ·ä½“éªŒå·®

**è§£å†³æ–¹æ¡ˆ**:
- ç§»é™¤ç¼“å†²
- ç«‹å³è½¬æ¢ç«‹å³å‘é€
- é¢„æœŸå»¶è¿Ÿå‡å°‘1000ms

### é—®é¢˜4ï¼šRTPæ—¶åºä¸ç²¾ç¡®ï¼ˆé«˜ï¼‰

**çŽ°è±¡**:
- ä½¿ç”¨ç´¯ç§¯setTimeout
- æ—¶é—´æ¼‚ç§»ï¼šÂ±100ms

**åŽæžœ**:
- ðŸŽµ éŸ³é¢‘å¡é¡¿
- ðŸ“‰ éŸ³é¢‘è´¨é‡ä¸‹é™

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ç»å¯¹æ—¶é—´è€Œä¸æ˜¯ç´¯ç§¯æ—¶é—´
const expectedTime = startTime + packetCount * packetInterval
const waitTime = expectedTime - Date.now()
```

---

## ðŸ“Š æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¿«é€Ÿä¿®å¤ï¼ˆæŽ¨èï¼‰

**ç›®æ ‡**: åœ¨å½“å‰ASR+TTSåˆ†ç¦»æž¶æž„ä¸‹å¿«é€Ÿå®žçŽ°é‡‡æ ·çŽ‡è½¬æ¢

**å·¥ä½œé‡**: 2-3å¤©

**æ­¥éª¤**:
1. å®‰è£…ä¾èµ–ï¼š`alawmulaw` + `wave-resampler`
2. åˆ›å»º`AudioCodecConverter`ç±»
3. é›†æˆåˆ°ASRæµç¨‹ï¼šPCMA 8kHz â†’ PCM 16kHz
4. é›†æˆåˆ°TTSæµç¨‹ï¼šPCM 24kHz â†’ PCMA 8kHz
5. ä¼˜åŒ–RTPæ—¶åº
6. ç§»é™¤éŸ³é¢‘ç¼“å†²

**é¢„æœŸæ•ˆæžœ**:
- éŸ³é¢‘è´¨é‡ï¼šå¤±çœŸ â†’ æ¸…æ™°
- å»¶è¿Ÿï¼š>1.5s â†’ <0.5s
- æ—¶åºç²¾åº¦ï¼šÂ±100ms â†’ Â±1-5ms

### æ–¹æ¡ˆBï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

**ç›®æ ‡**: è¿ç§»åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³ï¼ˆç«¯åˆ°ç«¯ï¼‰

**å·¥ä½œé‡**: 2-3å‘¨

**ä¼˜åŠ¿**:
- å•ä¸ªWebSocketè¿žæŽ¥
- ç«¯åˆ°ç«¯å¤„ç†ï¼ˆæ›´è‡ªç„¶ï¼‰
- æ›´ä½Žçš„å»¶è¿Ÿ
- æ›´å¥½çš„ä¸Šä¸‹æ–‡ç†è§£

---

## ðŸ”§ å®žæ–½æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šé‡‡æ ·çŽ‡è½¬æ¢ï¼ˆå¿…é¡»ï¼‰

- [ ] å®‰è£…ä¾èµ–
  ```bash
  npm install alawmulaw wave-resampler
  ```

- [ ] åˆ›å»ºéŸ³é¢‘è½¬æ¢å™¨
  - æ–‡ä»¶ï¼š`server/src/services/vos/audio-codec-converter.ts`
  - å‚è€ƒï¼š`docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md`

- [ ] é›†æˆåˆ°ASRæµç¨‹
  - ä¿®æ”¹ï¼š`server/src/services/call-audio-stream.service.ts`

- [ ] é›†æˆåˆ°TTSæµç¨‹
  - ä¿®æ”¹ï¼š`server/src/services/doubao-realtime-voice.service.ts`

- [ ] æµ‹è¯•éªŒè¯
  - å•å…ƒæµ‹è¯•
  - é›†æˆæµ‹è¯•
  - æ€§èƒ½æµ‹è¯•

### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆæŽ¨èï¼‰

- [ ] ç§»é™¤éŸ³é¢‘ç¼“å†²
- [ ] ç²¾ç¡®RTPæ—¶åº
- [ ] æ€§èƒ½ç›‘æŽ§

### ç¬¬ä¸‰é˜¶æ®µï¼šé•¿æœŸå‡çº§ï¼ˆå¯é€‰ï¼‰

- [ ] è¯„ä¼°è±†åŒ…å®žæ—¶è¯­éŸ³
- [ ] åˆ¶å®šå‡çº§è®¡åˆ’

---

## ðŸ“ˆ æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰åŽ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡ |
|------|--------|--------|------|
| **é‡‡æ ·çŽ‡è½¬æ¢** | âŒ æ—  | âœ… 7-10ms | å¿…é¡» |
| **ç¼–ç è½¬æ¢** | âŒ æ—  | âœ… 2-3ms | å¿…é¡» |
| **éŸ³é¢‘ç¼“å†²** | 1000ms | 0ms | **æ¶ˆé™¤** |
| **RTPç²¾åº¦** | Â±100ms | Â±1-5ms | **20å€** |
| **æ€»å»¶è¿Ÿ** | >1.5s | <0.5s | **3å€** |

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ |
|------|--------|--------|
| ç”¨æˆ·è¯´è¯ | 1.5såŽæ‰èƒ½å¬åˆ°AIå›žå¤ | 0.5såŽå°±èƒ½å¬åˆ° |
| éŸ³é¢‘è´¨é‡ | å¯èƒ½å¤±çœŸæˆ–æ— å£° | æ¸…æ™°è‡ªç„¶ |
| å¯¹è¯æµç•…åº¦ | æ˜Žæ˜¾å¡é¡¿ | å‡ ä¹Žæ— å¡é¡¿ |

---

## ðŸ“š å‚è€ƒæ–‡æ¡£

æœ¬åˆ†æžåŸºäºŽä»¥ä¸‹æ–‡æ¡£ç”Ÿæˆï¼š

1. **VOS + è±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£**
   - å®Œæ•´çš„æµ‹è¯•æµç¨‹
   - éŸ³é¢‘å¤„ç†æœ€ä½³å®žè·µ
   - æ€§èƒ½ä¼˜åŒ–æŠ€å·§

2. **VOSéŸ³é¢‘å¤„ç†å¯¹æ¯”åˆ†æž**
   - æž¶æž„å¯¹æ¯”
   - æŠ€æœ¯å¯¹æ¯”
   - æ”¹è¿›å»ºè®®

3. **éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—**
   - è¯¦ç»†çš„ä»£ç ç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£å†³
   - æµ‹è¯•éªŒè¯æ–¹æ³•

4. **VOSéŸ³é¢‘å¤„ç†ä¼˜åŒ–æ€»ç»“**
   - å®žæ–½æ¸…å•
   - å¿«é€Ÿå¼€å§‹æŒ‡å—
   - é£Žé™©è¯„ä¼°

---

## ðŸš€ å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼ˆæœ¬å‘¨ï¼‰

1. **å®¡æ‰¹æ–¹æ¡ˆ**
   - ç¡®è®¤é‡‡ç”¨æ–¹æ¡ˆAï¼ˆå¿«é€Ÿä¿®å¤ï¼‰
   - åˆ†é…å¼€å‘èµ„æº

2. **å‡†å¤‡å·¥ä½œ**
   - å®‰è£…ä¾èµ–
   - åˆ›å»ºåˆ†æ”¯
   - å‡†å¤‡æµ‹è¯•çŽ¯å¢ƒ

### çŸ­æœŸè¡ŒåŠ¨ï¼ˆ1-2å‘¨ï¼‰

1. **å®žæ–½é‡‡æ ·çŽ‡è½¬æ¢**
   - åˆ›å»º`AudioCodecConverter`
   - é›†æˆåˆ°ASR/TTSæµç¨‹
   - å•å…ƒæµ‹è¯•

2. **æ€§èƒ½ä¼˜åŒ–**
   - ç§»é™¤éŸ³é¢‘ç¼“å†²
   - ç²¾ç¡®RTPæ—¶åº
   - é›†æˆæµ‹è¯•

3. **éªŒè¯ä¸Šçº¿**
   - å®Œæ•´æµ‹è¯•
   - æ€§èƒ½ç›‘æŽ§
   - ç”¨æˆ·åé¦ˆ

### ä¸­æœŸè¡ŒåŠ¨ï¼ˆ1-2æœˆï¼‰

1. **ç›‘æŽ§å’Œä¼˜åŒ–**
   - æ”¶é›†ç”¨æˆ·åé¦ˆ
   - æ€§èƒ½ç›‘æŽ§
   - æŒç»­ä¼˜åŒ–

2. **è¯„ä¼°å‡çº§**
   - è¯„ä¼°è±†åŒ…å®žæ—¶è¯­éŸ³
   - åˆ¶å®šå‡çº§è®¡åˆ’

---

## âš ï¸ é£Žé™©è¯„ä¼°

### æŠ€æœ¯é£Žé™©

- ðŸŸ¡ **ä½Ž**ï¼šé‡‡æ ·çŽ‡è½¬æ¢æ˜¯æˆç†ŸæŠ€æœ¯
- ðŸŸ¡ **ä½Ž**ï¼šä½¿ç”¨æˆç†Ÿçš„å¼€æºåº“
- ðŸŸ¡ **ä½Ž**ï¼šæ”¹åŠ¨èŒƒå›´æœ‰é™

### å…¼å®¹æ€§é£Žé™©

- âœ… ä¸ŽçŽ°æœ‰ASR/TTSå…¼å®¹
- âœ… ä¸ŽVOS SIP/RTPå…¼å®¹
- âœ… ä¸Žè¯æœ¯æ¨¡æ¿ç³»ç»Ÿå…¼å®¹

### å›žæ»šæ–¹æ¡ˆ

```bash
# å¿«é€Ÿå›žæ»š
git checkout HEAD -- server/src/services/
```

---

## ðŸ’° æˆæœ¬æ•ˆç›Š

### æŠ•å…¥

- **å¼€å‘æ—¶é—´**: 2-3å¤©
- **æµ‹è¯•æ—¶é—´**: 1-2å¤©
- **æ€»è®¡**: 3-5å¤©

### æ”¶ç›Š

- **éŸ³é¢‘è´¨é‡**: æ˜¾è‘—æå‡
- **ç”¨æˆ·ä½“éªŒ**: 3å€å»¶è¿Ÿæ”¹å–„
- **ç³»ç»Ÿç¨³å®šæ€§**: æ˜¾è‘—æé«˜
- **å•†ç”¨ä»·å€¼**: å¯ä»¥å¼€å§‹å•†ç”¨

### ROI

- **çŸ­æœŸ**: ç”¨æˆ·æ»¡æ„åº¦æå‡
- **ä¸­æœŸ**: å¯å•†ç”¨çš„å‘¼å«ä¸­å¿ƒ
- **é•¿æœŸ**: ä¸šç•Œé¢†å…ˆçš„éŸ³é¢‘è´¨é‡

---

## ðŸ“ž åŽç»­æ”¯æŒ

### é—®é¢˜æŽ’æŸ¥

- æŸ¥çœ‹`docs/éŸ³é¢‘é‡‡æ ·çŽ‡è½¬æ¢å®žçŽ°æŒ‡å—.md`ä¸­çš„å¸¸è§é—®é¢˜
- æŸ¥çœ‹`docs/VOSè±†åŒ…å®žæ—¶è¯­éŸ³é›†æˆæµ‹è¯•æ–‡æ¡£.md`ä¸­çš„æ•…éšœæŽ’æŸ¥
- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—

### èŽ·å–å¸®åŠ©

- å‚è€ƒæä¾›çš„å®žçŽ°æŒ‡å—
- æŸ¥çœ‹ä»£ç ç¤ºä¾‹
- è”ç³»æŠ€æœ¯æ”¯æŒ

---

## ðŸŽ‰ é¢„æœŸæ”¶ç›Š

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
- âœ… éŸ³é¢‘è´¨é‡æ˜¾è‘—æå‡
- âœ… å»¶è¿Ÿå‡å°‘3å€
- âœ… ç”¨æˆ·ä½“éªŒæ˜Žæ˜¾æ”¹å–„

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
- âœ… ç³»ç»Ÿç¨³å®šæ€§æé«˜
- âœ… ç”¨æˆ·æ»¡æ„åº¦æå‡
- âœ… å¯ä»¥è€ƒè™‘å‡çº§åˆ°è±†åŒ…å®žæ—¶è¯­éŸ³

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
- âœ… å®Œæ•´çš„AIè¯­éŸ³å¯¹è¯ç³»ç»Ÿ
- âœ… ä¸šç•Œé¢†å…ˆçš„éŸ³é¢‘è´¨é‡
- âœ… å¯å•†ç”¨çš„å‘¼å«ä¸­å¿ƒè§£å†³æ–¹æ¡ˆ

---

**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**ç”Ÿæˆæ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: å¾…å®¡æ‰¹  
**å»ºè®®**: ç«‹å³å¯åŠ¨æ–¹æ¡ˆAå®žæ–½

