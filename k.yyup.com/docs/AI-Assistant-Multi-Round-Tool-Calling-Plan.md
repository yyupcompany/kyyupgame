# å‰ç«¯AIåŠ©æ‰‹å¤šè½®å·¥å…·è°ƒç”¨å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: å‰ç«¯AIåŠ©æ‰‹å¤šè½®å·¥å…·è°ƒç”¨ä¼˜åŒ–  
**å®æ–½æ—¥æœŸ**: 2025-10-05  
**åˆ†æ”¯**: AIupgrade  
**çŠ¶æ€**: è§„åˆ’ä¸­

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

### æ ¸å¿ƒé—®é¢˜

1. **æ¥å£ä½¿ç”¨æ··ä¹±**
   - âŒ ç›´æ¥èŠå¤©æ¥å£å’Œå·¥å…·è°ƒç”¨æ¥å£ä½¿ç”¨åœºæ™¯ä¸æ˜ç¡®
   - âŒ ä¸¤ä¸ªæ¥å£çš„è§¦å‘æ¡ä»¶ä¸æ¸…æ™°

2. **å·¥å…·è°ƒç”¨ä¸å®Œæ•´**
   - âŒ å‰ç«¯æ²¡æœ‰loopæœºåˆ¶ï¼Œåªè°ƒç”¨ä¸€æ¬¡å°±ç»“æŸ
   - âŒ å·¥å…·è°ƒç”¨ç»“æœæ— æ³•ä¼ é€’ç»™åç«¯ç»§ç»­å¤„ç†
   - âŒ æ— æ³•å®Œæˆéœ€è¦å¤šæ­¥éª¤çš„å¤æ‚ä»»åŠ¡

3. **ç»„ä»¶æ¸²æŸ“å¤±æ•ˆ**
   - âŒ `render_component` å·¥å…·è¢«è°ƒç”¨ï¼Œä½†å‰ç«¯æ²¡æœ‰æ¸²æŸ“
   - âŒ æ•°æ®è¡¨æ ¼ã€å›¾è¡¨ã€å¾…åŠäº‹é¡¹ç­‰ç»„ä»¶æ— æ³•æ˜¾ç¤º

4. **çŠ¶æ€åé¦ˆä¸è¶³**
   - âŒ ç”¨æˆ·ä¸çŸ¥é“å½“å‰æ‰§è¡Œåˆ°ç¬¬å‡ è½®
   - âŒ å·¥å…·è°ƒç”¨è¿‡ç¨‹ä¸é€æ˜
   - âŒ ç¼ºå°‘è¿›åº¦æŒ‡ç¤º

### è§£å†³æ–¹æ¡ˆ

1. âœ… **æ˜ç¡®æ¥å£ä½¿ç”¨åœºæ™¯**
   - ç›´æ¥èŠå¤©ï¼š`autoExecute=false` æ—¶ä½¿ç”¨
   - å·¥å…·è°ƒç”¨ï¼š`autoExecute=true` æ—¶ä½¿ç”¨

2. âœ… **å®ç°å‰ç«¯Loopæœºåˆ¶**
   - ç»´æŠ¤å¯¹è¯å†å²
   - æŒç»­å‘é€å·¥å…·è°ƒç”¨ç»“æœ
   - ç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¾¾åˆ°æœ€å¤§è½®æ•°

3. âœ… **ä¿®å¤ç»„ä»¶æ¸²æŸ“**
   - ç›‘å¬ `tool_call_complete` äº‹ä»¶
   - è§£æ `render_component` å·¥å…·ç»“æœ
   - åŠ¨æ€æ¸²æŸ“ç»„ä»¶

4. âœ… **ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º**
   - æ˜¾ç¤ºå½“å‰è½®æ•°
   - æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
   - æ˜¾ç¤ºè¿›åº¦æ¡

---

## ğŸ“Š å½“å‰æ¶æ„åˆ†æ

### å‰ç«¯æ¥å£

| æ¥å£åç§° | ç”¨é€” | è§¦å‘æ¡ä»¶ | å½“å‰é—®é¢˜ |
|---------|------|----------|----------|
| `callDirectChatSSE` | ç›´æ¥èŠå¤© | `autoExecute=false` | âœ… æ­£å¸¸å·¥ä½œ |
| `callUnifiedIntelligenceStream` | å·¥å…·è°ƒç”¨ | `autoExecute=true` | âŒ åªè°ƒç”¨ä¸€æ¬¡ |

### åç«¯æ¥å£

| æ¥å£è·¯å¾„ | åŠŸèƒ½ | æ”¯æŒå¤šè½® |
|---------|------|----------|
| `/api/ai/direct-chat-sse` | ç›´æ¥èŠå¤© | âŒ å•è½® |
| `/api/ai/unified/stream-chat` | ç»Ÿä¸€æ™ºèƒ½ä¸­å¿ƒ | âœ… å¤šè½® |

### å½“å‰æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯è°ƒç”¨ callUnifiedIntelligenceStream
         â†“
      åç«¯å¤„ç†ï¼ˆæœ€å¤š20è½®ï¼‰
         â†“
      è¿”å›æœ€ç»ˆç»“æœ
         â†“
      å‰ç«¯æ˜¾ç¤ºç»“æœ âœ…
         â†“
      ç»“æŸ âŒ (åº”è¯¥ç»§ç»­å¾ªç¯)
```

### æœŸæœ›æµç¨‹

```
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯è°ƒç”¨ callUnifiedIntelligenceStream (è½®æ¬¡1)
         â†“
      åç«¯å¤„ç†å¹¶è¿”å›å·¥å…·è°ƒç”¨ç»“æœ
         â†“
      å‰ç«¯æ¥æ”¶ç»“æœ â†’ ç»§ç»­è°ƒç”¨ callUnifiedIntelligenceStream (è½®æ¬¡2)
         â†“
      åç«¯ç»§ç»­å¤„ç†
         â†“
      ... å¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–è¾¾åˆ°20è½®
         â†“
      å‰ç«¯æ˜¾ç¤ºæœ€ç»ˆç»“æœ âœ…
```

---

## ğŸ”§ å®æ–½ä»»åŠ¡

### ä»»åŠ¡1: åŒºåˆ†ä¸¤ä¸ªæ¥å£çš„ä½¿ç”¨åœºæ™¯ âœ…

**ç›®æ ‡**: æ˜ç¡®ä¸¤ä¸ªæ¥å£çš„ä½¿ç”¨åœºæ™¯å’Œè§¦å‘æ¡ä»¶

**å®æ–½æ­¥éª¤**:
1. åœ¨ `AIAssistant.vue` ä¸­æ·»åŠ æ¥å£é€‰æ‹©é€»è¾‘
2. æ ¹æ® `autoExecute` çŠ¶æ€é€‰æ‹©æ¥å£
3. æ·»åŠ æ—¥å¿—è®°å½•æ¥å£é€‰æ‹©åŸå› 

**ä»£ç ä½ç½®**:
- `client/src/components/ai-assistant/AIAssistant.vue`
- `sendMessage()` æ–¹æ³•

**é¢„æœŸæ•ˆæœ**:
```typescript
if (autoExecute.value) {
  // ä½¿ç”¨å·¥å…·è°ƒç”¨æ¥å£
  await callUnifiedIntelligenceStream(...)
} else {
  // ä½¿ç”¨ç›´æ¥èŠå¤©æ¥å£
  await callDirectChatSSE(...)
}
```

---

### ä»»åŠ¡2: å®ç°å‰ç«¯Loopæœºåˆ¶ ğŸ”„

**ç›®æ ‡**: å®ç°å¤šè½®äº¤äº’å¾ªç¯æœºåˆ¶

**æ ¸å¿ƒé€»è¾‘**:
```typescript
// ä¼ªä»£ç 
let currentRound = 0;
const maxRounds = 20;
let conversationHistory = [];

while (currentRound < maxRounds) {
  currentRound++;
  
  // è°ƒç”¨åç«¯
  const result = await callUnifiedIntelligenceStream({
    message: userMessage,
    conversationHistory: conversationHistory
  });
  
  // æ›´æ–°å¯¹è¯å†å²
  conversationHistory.push({
    role: 'assistant',
    content: result.content,
    toolCalls: result.toolCalls
  });
  
  // æ£€æŸ¥æ˜¯å¦å®Œæˆ
  if (result.isComplete) {
    break;
  }
  
  // å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œç»§ç»­ä¸‹ä¸€è½®
  if (result.toolCalls && result.toolCalls.length > 0) {
    // å°†å·¥å…·è°ƒç”¨ç»“æœä½œä¸ºä¸‹ä¸€è½®çš„è¾“å…¥
    userMessage = formatToolCallResults(result.toolCalls);
    continue;
  }
  
  break;
}
```

**å®æ–½æ­¥éª¤**:
1. åˆ›å»º `useMultiRoundToolCalling` composable
2. å®ç°å¾ªç¯é€»è¾‘
3. ç»´æŠ¤å¯¹è¯å†å²
4. å¤„ç†å·¥å…·è°ƒç”¨ç»“æœ
5. é›†æˆåˆ° `AIAssistant.vue`

**ä»£ç ä½ç½®**:
- æ–°å»º: `client/src/composables/useMultiRoundToolCalling.ts`
- ä¿®æ”¹: `client/src/components/ai-assistant/AIAssistant.vue`

---

### ä»»åŠ¡3: ä¿®å¤ç»„ä»¶æ¸²æŸ“è°ƒç”¨é—®é¢˜ ğŸ¨

**ç›®æ ‡**: ç¡®ä¿ `render_component` å·¥å…·è¢«æ­£ç¡®æ¸²æŸ“

**é—®é¢˜åˆ†æ**:
- åç«¯è¿”å› `render_component` å·¥å…·è°ƒç”¨
- å‰ç«¯æ¥æ”¶åˆ° `tool_call_complete` äº‹ä»¶
- ä½†æ²¡æœ‰è§£æå’Œæ¸²æŸ“ç»„ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ç›‘å¬å·¥å…·è°ƒç”¨å®Œæˆäº‹ä»¶
onProgress: (event) => {
  if (event.type === 'tool_call_complete') {
    const toolName = event.data?.name;
    const toolResult = event.data?.result;
    
    if (toolName === 'render_component') {
      // æ¸²æŸ“ç»„ä»¶
      renderDynamicComponent(toolResult);
    }
  }
}

// æ¸²æŸ“åŠ¨æ€ç»„ä»¶
function renderDynamicComponent(componentData: any) {
  const { component_type, title, data, config } = componentData;
  
  switch (component_type) {
    case 'data-table':
      // æ¸²æŸ“æ•°æ®è¡¨æ ¼
      break;
    case 'chart':
      // æ¸²æŸ“å›¾è¡¨
      break;
    case 'todo-list':
      // æ¸²æŸ“å¾…åŠäº‹é¡¹
      break;
    case 'stat-card':
      // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
      break;
  }
}
```

**å®æ–½æ­¥éª¤**:
1. åœ¨ `AIAssistant.vue` ä¸­æ·»åŠ ç»„ä»¶æ¸²æŸ“é€»è¾‘
2. åˆ›å»ºåŠ¨æ€ç»„ä»¶å®¹å™¨
3. è§£æå·¥å…·è°ƒç”¨ç»“æœ
4. æ¸²æŸ“å¯¹åº”ç»„ä»¶

**ä»£ç ä½ç½®**:
- ä¿®æ”¹: `client/src/components/ai-assistant/AIAssistant.vue`
- æ–°å»º: `client/src/components/ai-assistant/DynamicComponentRenderer.vue`

---

### ä»»åŠ¡4: ä¼˜åŒ–å·¥å…·è°ƒç”¨çŠ¶æ€æ˜¾ç¤º ğŸ“Š

**ç›®æ ‡**: æ”¹è¿›å·¥å…·è°ƒç”¨è¿‡ç¨‹çš„å¯è§†åŒ–åé¦ˆ

**æ˜¾ç¤ºå†…å®¹**:
1. **å½“å‰è½®æ•°**: `ç¬¬ 3/20 è½®`
2. **å·¥å…·è°ƒç”¨çŠ¶æ€**: `ğŸ”§ æ­£åœ¨è°ƒç”¨å·¥å…·: query_past_activities`
3. **è¿›åº¦æ¡**: æ˜¾ç¤ºæ•´ä½“è¿›åº¦
4. **å·¥å…·è°ƒç”¨å†å²**: æ˜¾ç¤ºå·²è°ƒç”¨çš„å·¥å…·åˆ—è¡¨

**UIè®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– AIåŠ©æ‰‹ - æ™ºèƒ½ä»£ç†æ¨¡å¼           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰è½®æ•°: ç¬¬ 3/20 è½®                â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”§ æ­£åœ¨è°ƒç”¨å·¥å…·: query_past_activities â”‚
â”‚ ğŸ“ æŸ¥è¯¢å†å²æ´»åŠ¨æ•°æ®...              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·²è°ƒç”¨å·¥å…·:                         â”‚
â”‚ âœ… navigate_to_page                 â”‚
â”‚ âœ… capture_screen                   â”‚
â”‚ ğŸ”„ query_past_activities (è¿›è¡Œä¸­)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ–½æ­¥éª¤**:
1. åˆ›å»ºçŠ¶æ€æ˜¾ç¤ºç»„ä»¶
2. ç›‘å¬å·¥å…·è°ƒç”¨äº‹ä»¶
3. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
4. æ·»åŠ è¿›åº¦æ¡

**ä»£ç ä½ç½®**:
- æ–°å»º: `client/src/components/ai-assistant/ToolCallingStatus.vue`
- ä¿®æ”¹: `client/src/components/ai-assistant/AIAssistant.vue`

---

### ä»»åŠ¡5: æµ‹è¯•éªŒè¯ âœ…

**æµ‹è¯•åœºæ™¯**:

1. **ç®€å•æŸ¥è¯¢** (é¢„æœŸ3-5è½®)
   - è¾“å…¥: "æŸ¥è¯¢æœ€è¿‘çš„æ´»åŠ¨"
   - é¢„æœŸ: è°ƒç”¨ `query_past_activities` â†’ è¿”å›ç»“æœ

2. **å¤æ‚ä»»åŠ¡** (é¢„æœŸ10-15è½®)
   - è¾“å…¥: "å¸®æˆ‘åˆ†ææ‹›ç”Ÿæ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š"
   - é¢„æœŸ: 
     - è°ƒç”¨ `query_enrollment_history`
     - è°ƒç”¨ `analyze_business_trends`
     - è°ƒç”¨ `render_component` (å›¾è¡¨)
     - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š

3. **å¤šæ­¥éª¤å·¥ä½œæµ** (é¢„æœŸ15-20è½®)
   - è¾“å…¥: "åˆ›å»ºä¸€ä¸ªæ´»åŠ¨æ–¹æ¡ˆ"
   - é¢„æœŸ:
     - è°ƒç”¨ `generate_complete_activity_plan`
     - è°ƒç”¨ `execute_activity_workflow`
     - å¤šæ¬¡è°ƒç”¨ `render_component`
     - å®Œæˆæ•´ä¸ªå·¥ä½œæµ

4. **ç»„ä»¶æ¸²æŸ“æµ‹è¯•**
   - è¾“å…¥: "æ˜¾ç¤ºå­¦ç”Ÿæ•°æ®è¡¨æ ¼"
   - é¢„æœŸ: è°ƒç”¨ `render_component` â†’ å‰ç«¯æ¸²æŸ“è¡¨æ ¼

5. **è¾¾åˆ°æœ€å¤§è½®æ•°æµ‹è¯•**
   - è¾“å…¥: å¤æ‚ä»»åŠ¡
   - é¢„æœŸ: è¾¾åˆ°20è½®ååœæ­¢ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯

**éªŒè¯æ ‡å‡†**:
- âœ… å·¥å…·å¯ä»¥æŒç»­è°ƒç”¨
- âœ… å¯¹è¯å†å²æ­£ç¡®ç»´æŠ¤
- âœ… ç»„ä»¶æ­£ç¡®æ¸²æŸ“
- âœ… çŠ¶æ€æ˜¾ç¤ºå‡†ç¡®
- âœ… è¾¾åˆ°æœ€å¤§è½®æ•°æ—¶æ­£ç¡®åœæ­¢

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ–°å»ºæ–‡ä»¶

1. `client/src/composables/useMultiRoundToolCalling.ts`
   - å¤šè½®å·¥å…·è°ƒç”¨é€»è¾‘

2. `client/src/components/ai-assistant/DynamicComponentRenderer.vue`
   - åŠ¨æ€ç»„ä»¶æ¸²æŸ“å™¨

3. `client/src/components/ai-assistant/ToolCallingStatus.vue`
   - å·¥å…·è°ƒç”¨çŠ¶æ€æ˜¾ç¤º

4. `docs/AI-Assistant-Multi-Round-Tool-Calling-Plan.md`
   - å®æ–½æ–¹æ¡ˆæ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶

1. `server/.env`
   - `AI_MAX_ITERATIONS=20` (æµ‹è¯•æœŸé—´)

2. `client/src/components/ai-assistant/AIAssistant.vue`
   - æ·»åŠ æ¥å£é€‰æ‹©é€»è¾‘
   - é›†æˆå¤šè½®è°ƒç”¨æœºåˆ¶
   - æ·»åŠ ç»„ä»¶æ¸²æŸ“é€»è¾‘
   - æ·»åŠ çŠ¶æ€æ˜¾ç¤º

3. `client/src/api/endpoints/function-tools.ts`
   - ä¼˜åŒ– `callUnifiedIntelligenceStream` æ¥å£
   - æ·»åŠ å¯¹è¯å†å²æ”¯æŒ

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ (å¿…é¡»å®Œæˆ)
1. âœ… ä¿®æ”¹ç¯å¢ƒå˜é‡ `AI_MAX_ITERATIONS=20`
2. ğŸ”„ å®ç°å‰ç«¯Loopæœºåˆ¶
3. ğŸ”„ ä¿®å¤ç»„ä»¶æ¸²æŸ“

### P1 - é‡è¦åŠŸèƒ½ (åº”è¯¥å®Œæˆ)
4. ğŸ”„ ä¼˜åŒ–çŠ¶æ€æ˜¾ç¤º
5. ğŸ”„ åŒºåˆ†æ¥å£ä½¿ç”¨åœºæ™¯

### P2 - å¢å¼ºåŠŸèƒ½ (å¯ä»¥å®Œæˆ)
6. â³ æµ‹è¯•éªŒè¯
7. â³ æ–‡æ¡£å®Œå–„

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘
- æ¯è½®è°ƒç”¨éƒ½ä¼šæ¶ˆè€—APIé¢åº¦
- å»ºè®®æ·»åŠ å–æ¶ˆæœºåˆ¶
- é¿å…æ— é™å¾ªç¯

### 2. ç”¨æˆ·ä½“éªŒ
- æ˜¾ç¤ºæ¸…æ™°çš„è¿›åº¦æŒ‡ç¤º
- å…è®¸ç”¨æˆ·ä¸­æ–­æ‰§è¡Œ
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### 3. é”™è¯¯å¤„ç†
- å·¥å…·è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥
- ç½‘ç»œé”™è¯¯æ—¶çš„é‡è¯•æœºåˆ¶
- è¶…æ—¶å¤„ç†

### 4. å…¼å®¹æ€§
- ä¿æŒå‘åå…¼å®¹
- ä¸å½±å“ç°æœ‰çš„ç›´æ¥èŠå¤©åŠŸèƒ½
- æ¸è¿›å¼å¢å¼º

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

1. **å·¥å…·ç»Ÿä¸€åŒ–æŠ¥å‘Š**: `docs/Tool-Unification-Complete-Report.md`
2. **å·¥å…·è°ƒç”¨è½®æ•°é…ç½®**: `docs/AI-Max-Iterations-Configuration.md`
3. **AIåŠ©æ‰‹è°ƒç”¨é“¾è·¯**: `docs/AI-Assistant-Call-Chain-Analysis.md`

---

## âœ… æˆåŠŸæ ‡å‡†

1. âœ… å·¥å…·å¯ä»¥æŒç»­è°ƒç”¨ç›´åˆ°ä»»åŠ¡å®Œæˆ
2. âœ… å¯¹è¯å†å²æ­£ç¡®ç»´æŠ¤å’Œä¼ é€’
3. âœ… ç»„ä»¶æ­£ç¡®æ¸²æŸ“å’Œæ˜¾ç¤º
4. âœ… çŠ¶æ€æ˜¾ç¤ºæ¸…æ™°å‡†ç¡®
5. âœ… ç”¨æˆ·ä½“éªŒæµç•…
6. âœ… é”™è¯¯å¤„ç†å®Œå–„
7. âœ… æ€§èƒ½è¡¨ç°è‰¯å¥½

---

**é¡¹ç›®è´Ÿè´£äºº**: AI Team  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-05  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: è§„åˆ’ä¸­ â†’ å®æ–½ä¸­

