/**
 * 安全漏洞模型
 * 用于存储系统发现的安全漏洞信息
 */

import { DataTypes, Model, Optional } from 'sequelize';
import { sequelize } from '../init';

export interface SecurityVulnerabilityAttributes {
  id: number;
  cveId?: string;
  title: string;
  description: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  status: 'open' | 'confirmed' | 'fixed' | 'ignored' | 'false_positive';
  category: string;
  affectedComponent: string;
  discoveryMethod: string;
  cvssScore?: number;
  exploitability: 'none' | 'low' | 'medium' | 'high';
  impact: 'none' | 'low' | 'medium' | 'high';
  solution?: string;
  references?: string; // JSON格式的参考链接
  discoveredBy?: number;
  assignedTo?: number;
  fixedBy?: number;
  fixedAt?: Date;
  verifiedAt?: Date;
  metadata?: string; // JSON格式的额外信息
  createdAt: Date;
  updatedAt: Date;
}

export interface SecurityVulnerabilityCreationAttributes 
  extends Optional<SecurityVulnerabilityAttributes, 'id' | 'cveId' | 'cvssScore' | 'solution' | 'references' | 'discoveredBy' | 'assignedTo' | 'fixedBy' | 'fixedAt' | 'verifiedAt' | 'metadata' | 'createdAt' | 'updatedAt'> {}

export class SecurityVulnerability extends Model<SecurityVulnerabilityAttributes, SecurityVulnerabilityCreationAttributes>
  implements SecurityVulnerabilityAttributes {
  
  public id!: number;
  public cveId?: string;
  public title!: string;
  public description!: string;
  public severity!: 'low' | 'medium' | 'high' | 'critical';
  public status!: 'open' | 'confirmed' | 'fixed' | 'ignored' | 'false_positive';
  public category!: string;
  public affectedComponent!: string;
  public discoveryMethod!: string;
  public cvssScore?: number;
  public exploitability!: 'none' | 'low' | 'medium' | 'high';
  public impact!: 'none' | 'low' | 'medium' | 'high';
  public solution?: string;
  public references?: string;
  public discoveredBy?: number;
  public assignedTo?: number;
  public fixedBy?: number;
  public fixedAt?: Date;
  public verifiedAt?: Date;
  public metadata?: string;
  public readonly createdAt!: Date;
  public readonly updatedAt!: Date;
}

SecurityVulnerability.init({
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true
  },
  cveId: {
    type: DataTypes.STRING(20),
    allowNull: true,
    unique: true,
    comment: 'CVE编号'
  },
  title: {
    type: DataTypes.STRING(255),
    allowNull: false,
    comment: '漏洞标题'
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: false,
    comment: '漏洞详细描述'
  },
  severity: {
    type: DataTypes.ENUM('low', 'medium', 'high', 'critical'),
    allowNull: false,
    defaultValue: 'medium',
    comment: '漏洞严重程度'
  },
  status: {
    type: DataTypes.ENUM('open', 'confirmed', 'fixed', 'ignored', 'false_positive'),
    allowNull: false,
    defaultValue: 'open',
    comment: '漏洞状态'
  },
  category: {
    type: DataTypes.STRING(100),
    allowNull: false,
    comment: '漏洞分类：如注入、认证、授权等'
  },
  affectedComponent: {
    type: DataTypes.STRING(255),
    allowNull: false,
    comment: '受影响的组件或模块'
  },
  discoveryMethod: {
    type: DataTypes.STRING(100),
    allowNull: false,
    comment: '发现方法：如自动扫描、代码审计、渗透测试等'
  },
  cvssScore: {
    type: DataTypes.DECIMAL(3, 1),
    allowNull: true,
    validate: {
      min: 0.0,
      max: 10.0
    },
    comment: 'CVSS评分 (0.0-10.0)'
  },
  exploitability: {
    type: DataTypes.ENUM('none', 'low', 'medium', 'high'),
    allowNull: false,
    defaultValue: 'medium',
    comment: '可利用性'
  },
  impact: {
    type: DataTypes.ENUM('none', 'low', 'medium', 'high'),
    allowNull: false,
    defaultValue: 'medium',
    comment: '影响程度'
  },
  solution: {
    type: DataTypes.TEXT,
    allowNull: true,
    comment: '解决方案'
  },
  references: {
    type: DataTypes.TEXT,
    allowNull: true,
    comment: '参考链接（JSON格式）'
  },
  discoveredBy: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: '发现人员ID'
  },
  assignedTo: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: '分配给的人员ID'
  },
  fixedBy: {
    type: DataTypes.INTEGER,
    allowNull: true,
    comment: '修复人员ID'
  },
  fixedAt: {
    type: DataTypes.DATE,
    allowNull: true,
    comment: '修复时间'
  },
  verifiedAt: {
    type: DataTypes.DATE,
    allowNull: true,
    comment: '验证时间'
  },
  metadata: {
    type: DataTypes.TEXT,
    allowNull: true,
    comment: '额外元数据（JSON格式）'
  },
  createdAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW
  },
  updatedAt: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW
  }
}, {
  sequelize,
  tableName: 'security_vulnerabilities',
  timestamps: true,
  indexes: [
    {
      fields: ['status']
    },
    {
      fields: ['severity']
    },
    {
      fields: ['category']
    },
    {
      fields: ['affectedComponent']
    },
    {
      fields: ['cveId']
    },
    {
      fields: ['createdAt']
    }
  ],
  comment: '安全漏洞表'
});

export default SecurityVulnerability;
