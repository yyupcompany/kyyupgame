# 模型关联别名映射文档

本文档记录了系统中所有模型之间的关联关系及其别名，以便开发团队成员理解和维护代码。当需要通过关联查询数据时，请参考此文档了解正确的关联别名。

## 模型关联概述

系统中的模型关联主要分为以下几类：
1. 用户权限相关关联
2. 幼儿园基础信息相关关联
3. 招生管理相关关联
4. 活动管理相关关联

## 一、权限模块关联别名

### 用户与角色关联 (User & Role)
- 关联类型：**多对多关联**
- 中间表：`UserRole`
- 相关别名：
  - 无特殊别名，使用默认关联名

### 角色与权限关联 (Role & Permission)
- 关联类型：**多对多关联**
- 中间表：`RolePermission`
- 相关别名：
  - 无特殊别名，使用默认关联名

### 权限自关联 (Permission 自身层级关系)
- 关联类型：**自关联**（一对多）
- 相关别名：
  - `parentPermission`：当前权限的父权限（从子到父）
  - `childrenPermissions`：当前权限的所有子权限（从父到子）
- 注意事项：
  - 避免使用`parent`作为别名，因为该名称与`Parent`模型冲突
  - 查询示例：`Permission.findAll({ include: [{ model: Permission, as: 'parentPermission' }] })`

## 二、幼儿园基础信息关联别名

### 幼儿园与班级关联 (Kindergarten & Class)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`kindergartenId`

### 幼儿园与教师关联 (Kindergarten & Teacher)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`kindergartenId`

### 幼儿园与学生关联 (Kindergarten & Student)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`kindergartenId`

### 班级与学生关联 (Class & Student)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`classId`

### 用户与教师关联 (User & Teacher)
- 关联类型：**一对一关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`userId`

### 用户与家长关联 (User & Parent)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`userId`
- 说明：一个用户可以是多个孩子的家长

### 学生与家长关联 (Student & Parent)
- 关联类型：**一对多关联**
- 相关别名：
  - 无特殊别名，使用默认关联名
- 外键：`studentId`
- 说明：一个学生可以有多个家长（如父亲、母亲）

## 三、招生管理相关关联别名

### 幼儿园与招生计划关联 (Kindergarten & EnrollmentPlan)
- 关联类型：**一对多关联**
- 相关别名：
  - `enrollmentPlans`：幼儿园拥有的招生计划（从幼儿园到计划）
  - `kindergarten`：招生计划所属的幼儿园（从计划到幼儿园）
- 外键：`kindergartenId`

### 招生计划与招生任务关联 (EnrollmentPlan & EnrollmentTask)
- 关联类型：**一对多关联**
- 相关别名：
  - `tasks`：招生计划包含的任务（从计划到任务）
  - `plan`：招生任务所属的计划（从任务到计划）
- 外键：`planId`

### 教师与招生任务关联 (Teacher & EnrollmentTask)
- 关联类型：**一对多关联**
- 相关别名：
  - `enrollmentTasks`：教师负责的招生任务（从教师到任务）
  - `teacher`：招生任务负责的教师（从任务到教师）
- 外键：`teacherId`

### 录取结果与相关模型关联 (AdmissionResult)
- 关联类型：**多对一关联**
- **AdmissionResult -> EnrollmentApplication**
  - 外键: `applicationId`
  - 别名: `application`
- **AdmissionResult -> Student**
  - 外键: `studentId`
  - 别名: `student`
- **AdmissionResult -> Kindergarten**
  - 外键: `kindergartenId`
  - 别名: `kindergarten`
- **AdmissionResult -> Class**
  - 外键: `classId`
  - 别名: `class`
- **AdmissionResult -> User (创建人)**
  - 外键: `createdBy`
  - 别名: `creator`
- **AdmissionResult -> User (更新人)**
  - 外键: `updatedBy`
  - 别名: `updater`
- **AdmissionResult -> EnrollmentPlan**
  - 外键: `planId`
  - 别名: `plan`
- **AdmissionResult -> ParentStudentRelation**
  - 外键: `parentId`
  - 别名: `parent`

### 录取通知与相关模型关联 (AdmissionNotification)
- 关联类型：**多对一关联**
- **AdmissionNotification -> User (创建人)**
  - 外键: `createdBy`
  - 别名: `creator`
- **AdmissionNotification -> User (更新人)**
  - 外键: `updatedBy`
  - 别名: `updater`
- **AdmissionNotification -> AdmissionResult**
  - 外键: `admissionId`
  - 别名: `admissionResult`
- **AdmissionNotification -> ParentStudentRelation**
  - 外键: `parentId`
  - 别名: `parentRelation`
- **AdmissionNotification -> MessageTemplate**
  - 外键: `templateId`
  - 别名: `template`

### 招生计划与班级关联 (EnrollmentPlan & Class)
- 关联类型：**多对多关联**
- 中间表：`EnrollmentPlanClass`
- 相关别名：
  - `planClasses`：招生计划关联的班级（从计划到班级）
  - `enrollmentPlans`：班级参与的招生计划（从班级到计划）

### 招生申请与录取结果关联 (EnrollmentApplication & AdmissionResult)
- 关联类型：**一对一关联**
- 相关别名：
  - `admissionResult`：招生申请的录取结果（从申请到结果）
  - `application`：录取结果对应的申请（从结果到申请）
- 外键：`applicationId`

### 录取结果与录取通知关联 (AdmissionResult & AdmissionNotification)
- 关联类型：**一对多关联**
- 相关别名：
  - `notifications`：录取结果的通知记录（从结果到通知）
  - `admissionResult`：通知对应的录取结果（从通知到结果）
- 外键：`admissionId`

## 四、活动管理相关关联别名

### 幼儿园与活动关联 (Kindergarten & Activity)
- 关联类型：**一对多关联**
- 相关别名：
  - `activities`：幼儿园组织的活动（从幼儿园到活动）
  - `kindergarten`：活动所属的幼儿园（从活动到幼儿园）
- 外键：`kindergartenId`

### 招生计划与活动关联 (EnrollmentPlan & Activity)
- 关联类型：**一对多关联**
- 相关别名：
  - `activities`：招生计划包含的活动（从计划到活动）
  - `plan`：活动所属的招生计划（从活动到计划）
- 外键：`planId`

### 活动与活动报名关联 (Activity & ActivityRegistration)
- 关联类型：**一对多关联**
- 相关别名：
  - `registrations`：活动的报名记录（从活动到报名）
  - `activity`：报名所属的活动（从报名到活动）
- 外键：`activityId`

### 家长与活动报名关联 (Parent & ActivityRegistration)
- 关联类型：**一对多关联**
- 相关别名：
  - `activityRegistrations`：家长的活动报名记录（从家长到报名）
  - `parent`：报名的家长（从报名到家长）
- 外键：`parentId`

### 学生与活动报名关联 (Student & ActivityRegistration)
- 关联类型：**一对多关联**
- 相关别名：
  - `activityRegistrations`：学生的活动报名记录（从学生到报名）
  - `student`：报名的学生（从报名到学生）
- 外键：`studentId`

### 活动与活动评价关联 (Activity & ActivityEvaluation)
- 关联类型：**一对多关联**
- 相关别名：
  - `evaluations`：活动的评价记录（从活动到评价）
  - `activity`：评价所属的活动（从评价到活动）
- 外键：`activityId`

### 活动报名与活动评价关联 (ActivityRegistration & ActivityEvaluation)
- 关联类型：**一对多关联**
- 相关别名：
  - `evaluations`：报名记录关联的评价（从报名到评价）
  - `registration`：评价关联的报名记录（从评价到报名）
- 外键：`registrationId`

### 家长与活动评价关联 (Parent & ActivityEvaluation)
- 关联类型：**一对多关联**
- 相关别名：
  - `activityEvaluations`：家长提交的活动评价（从家长到评价）
  - `parent`：评价提交的家长（从评价到家长）
- 外键：`parentId`

### 教师与活动评价关联 (Teacher & ActivityEvaluation)
- 关联类型：**一对多关联**
- 相关别名：
  - `activityEvaluations`：教师提交的活动评价（从教师到评价）
  - `teacher`：评价提交的教师（从评价到教师）
- 外键：`teacherId`

## 五、营销组件相关关联别名

### 幼儿园与优惠券关联 (Kindergarten & Coupon)
- 关联类型：**一对多关联**
- 相关别名：
  - `coupons`：幼儿园发布的优惠券（从幼儿园到优惠券）
  - `kindergarten`：优惠券所属的幼儿园（从优惠券到幼儿园）
- 外键：`kindergartenId`

### 幼儿园与营销活动关联 (Kindergarten & MarketingCampaign)
- 关联类型：**一对多关联**
- 相关别名：
  - `marketingCampaigns`：幼儿园组织的营销活动（从幼儿园到营销活动）
  - `kindergarten`：营销活动所属的幼儿园（从营销活动到幼儿园）
- 外键：`kindergartenId`

### 幼儿园与渠道跟踪关联 (Kindergarten & ChannelTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `channelTrackings`：幼儿园的渠道跟踪记录（从幼儿园到渠道跟踪）
  - `kindergarten`：渠道跟踪记录所属的幼儿园（从渠道跟踪到幼儿园）
- 外键：`kindergartenId`

### 幼儿园与广告投放关联 (Kindergarten & Advertisement)
- 关联类型：**一对多关联**
- 相关别名：
  - `advertisements`：幼儿园的广告投放记录（从幼儿园到广告投放）
  - `kindergarten`：广告投放记录所属的幼儿园（从广告投放到幼儿园）
- 外键：`kindergartenId`

### 营销活动与广告投放关联 (MarketingCampaign & Advertisement)
- 关联类型：**一对多关联**
- 相关别名：
  - `advertisements`：营销活动包含的广告投放（从营销活动到广告投放）
  - `campaign`：广告投放所属的营销活动（从广告投放到营销活动）
- 外键：`campaignId`

### 幼儿园与转化跟踪关联 (Kindergarten & ConversionTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `conversionTrackings`：幼儿园的转化跟踪记录（从幼儿园到转化跟踪）
  - `kindergarten`：转化跟踪记录所属的幼儿园（从转化跟踪到幼儿园）
- 外键：`kindergartenId`

### 家长与转化跟踪关联 (Parent & ConversionTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `conversionTrackings`：家长的转化跟踪记录（从家长到转化跟踪）
  - `parent`：转化跟踪记录关联的家长（从转化跟踪到家长）
- 外键：`parentId`

### 营销活动与转化跟踪关联 (MarketingCampaign & ConversionTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `conversionTrackings`：营销活动产生的转化跟踪记录（从营销活动到转化跟踪）
  - `campaign`：转化跟踪记录关联的营销活动（从转化跟踪到营销活动）
- 外键：`campaignId`

### 渠道跟踪与转化跟踪关联 (ChannelTracking & ConversionTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `conversionTrackings`：渠道产生的转化跟踪记录（从渠道跟踪到转化跟踪）
  - `channel`：转化跟踪记录关联的渠道（从转化跟踪到渠道跟踪）
- 外键：`channelId`

### 广告投放与转化跟踪关联 (Advertisement & ConversionTracking)
- 关联类型：**一对多关联**
- 相关别名：
  - `conversionTrackings`：广告产生的转化跟踪记录（从广告投放到转化跟踪）
  - `advertisement`：转化跟踪记录关联的广告（从转化跟踪到广告投放）
- 外键：`advertisementId`

## 六、查询示例

### 1. 查询用户及其角色
```typescript
const userWithRoles = await User.findOne({
  where: { id: userId },
  include: [{ model: Role }]
});
```

### 2. 查询权限及其子权限
```typescript
const permissionWithChildren = await Permission.findOne({
  where: { id: permissionId },
  include: [{ model: Permission, as: 'childrenPermissions' }]
});
```

### 3. 查询班级包含的学生
```typescript
const classWithStudents = await Class.findOne({
  where: { id: classId },
  include: [{ model: Student }]
});
```

### 4. 查询学生及其家长
```typescript
const studentWithParents = await Student.findOne({
  where: { id: studentId },
  include: [{ model: Parent }]
});
```

### 5. 查询幼儿园的招生计划
```typescript
const kindergartenWithPlans = await Kindergarten.findOne({
  where: { id: kindergartenId },
  include: [{ model: EnrollmentPlan, as: 'enrollmentPlans' }]
});
```

### 6. 查询招生计划的任务和活动
```typescript
const planWithTasksAndActivities = await EnrollmentPlan.findOne({
  where: { id: planId },
  include: [
    { model: EnrollmentTask, as: 'tasks' },
    { model: Activity, as: 'activities' }
  ]
});
```

### 7. 查询活动的报名和评价
```typescript
const activityWithRegistrationsAndEvaluations = await Activity.findOne({
  where: { id: activityId },
  include: [
    { model: ActivityRegistration, as: 'registrations' },
    { model: ActivityEvaluation, as: 'evaluations' }
  ]
});
```

### 8. 查询教师负责的招生任务
```typescript
const teacherWithEnrollmentTasks = await Teacher.findOne({
  where: { id: teacherId },
  include: [{ model: EnrollmentTask, as: 'enrollmentTasks' }]
});
```

### 9. 查询招生计划的完成进度
```typescript
const plan = await EnrollmentPlan.findOne({
  where: { id: planId }
});
const progressPercentage = plan.getProgressPercentage();
```

### 10. 查询活动及其报名情况
```typescript
const activityWithRegistrations = await Activity.findOne({
  where: { id: activityId },
  include: [
    { 
      model: ActivityRegistration, 
      as: 'registrations',
      include: [
        { model: Parent, as: 'parent' },
        { model: Student, as: 'student' }
      ] 
    }
  ]
});
const registrationRate = activityWithRegistrations.getRegistrationRate();
```

### 11. 查询活动评价及其相关数据
```typescript
const evaluationsWithDetails = await ActivityEvaluation.findAll({
  where: { activityId },
  include: [
    { model: Activity, as: 'activity' },
    { model: ActivityRegistration, as: 'registration' },
    { model: Parent, as: 'parent' },
    { model: Teacher, as: 'teacher' }
  ]
});
```

### 12. 查询招生任务的完成情况
```typescript
const taskWithDetails = await EnrollmentTask.findOne({
  where: { id: taskId },
  include: [
    { model: EnrollmentPlan, as: 'plan' },
    { model: Teacher, as: 'teacher' }
  ]
});
const taskProgress = taskWithDetails.getProgressPercentage();
```

### 13. 查询幼儿园的营销活动和优惠券
```typescript
const kindergartenWithMarketingInfo = await Kindergarten.findOne({
  where: { id: kindergartenId },
  include: [
    { model: MarketingCampaign, as: 'marketingCampaigns' },
    { model: Coupon, as: 'coupons' }
  ]
});
```

### 14. 查询营销活动的广告投放和转化记录
```typescript
const campaignWithStats = await MarketingCampaign.findOne({
  where: { id: campaignId },
  include: [
    { model: Advertisement, as: 'advertisements' },
    { model: ConversionTracking, as: 'conversionTrackings' }
  ]
});
```

### 15. 查询渠道的转化记录和效果统计
```typescript
const channelWithConversions = await ChannelTracking.findOne({
  where: { id: channelId },
  include: [
    { model: ConversionTracking, as: 'conversionTrackings' }
  ]
});
const conversionRate = channelWithConversions.conversionRate;
const roi = channelWithConversions.roi;
```

### 16. 查询家长的转化记录
```typescript
const parentWithConversions = await Parent.findOne({
  where: { id: parentId },
  include: [
    { model: ConversionTracking, as: 'conversionTrackings' }
  ]
});
```

### 17. 查询录取结果及其相关信息
```typescript
const admissionResultWithDetails = await AdmissionResult.findOne({
  where: { id: admissionResultId },
  include: [
    { model: EnrollmentApplication, as: 'application' },
    { model: Student, as: 'student' },
    { model: Kindergarten, as: 'kindergarten' },
    { model: Class, as: 'class' },
    { model: EnrollmentPlan, as: 'plan' },
    { model: ParentStudentRelation, as: 'parent' },
    { model: User, as: 'creator' },
    { model: User, as: 'updater' }
  ]
});
```

### 18. 查询录取通知及其相关信息
```typescript
const notificationWithDetails = await AdmissionNotification.findOne({
  where: { id: notificationId },
  include: [
    { model: AdmissionResult, as: 'admissionResult' },
    { model: ParentStudentRelation, as: 'parentRelation' },
    { model: MessageTemplate, as: 'template' },
    { model: User, as: 'creator' },
    { model: User, as: 'updater' }
  ]
});
```

### 19. 查询招生申请的录取结果和通知
```typescript
const applicationWithAdmission = await EnrollmentApplication.findOne({
  where: { id: applicationId },
  include: [
    { 
      model: AdmissionResult, 
      as: 'admissionResult',
      include: [
        { model: AdmissionNotification, as: 'notifications' }
      ]
    }
  ]
});
```

## 六、注意事项

1. **避免重复别名**：不同关联中不应使用相同的别名，这会导致Sequelize抛出错误。

2. **别名命名规范**：
   - 使用有意义的名称，表明关联的性质
   - 多个单词使用驼峰命名法
   - 父子关系使用parent/children前缀

3. **添加新关联**：
   - 添加新的关联时，请更新此文档
   - 检查是否与现有别名冲突
   - 在index.ts的initModelAssociations函数中添加关联定义

4. **关联查询优化**：
   - 使用适当的include选项，避免过度加载
   - 必要时使用separate: true分离查询以提高性能
   - 对于深层嵌套关联，考虑使用多次查询代替一次复杂查询 

# 模型别名映射记录

## 当前别名冲突警告

根据启动日志发现以下别名冲突：

### 用户相关
- `user` 别名在以下关联中重复使用:
  - UserRole -> User
  - UserProfile -> User
  - Teacher -> User
  - Parent -> User

### 角色相关
- `role` 别名在以下关联中重复使用:
  - UserRole -> Role
  - RolePermission -> Role

### 幼儿园相关
- `kindergarten` 别名在以下关联中重复使用:
  - Class -> Kindergarten
  - Teacher -> Kindergarten
  - Student -> Kindergarten
  - EnrollmentPlan -> Kindergarten

### 班级相关
- `class` 别名与 `Class` 模型名冲突
- `classes` 别名在以下关联中重复使用:
  - Kindergarten -> Class
  - Teacher -> Class

### 学生相关
- `student` 别名与 `Student` 模型名冲突
- `students` 别名在以下关联中重复使用:
  - Kindergarten -> Student
  - Class -> Student

### 家长相关
- `parent` 别名在以下关联中重复使用:
  - Permission -> Permission
  - EnrollmentApplication -> Parent
- `parents` 别名在以下关联中重复使用:
  - User -> Parent
  - Student -> Parent

### 教师相关
- `teacher` 别名在以下关联中重复使用:
  - User -> Teacher
  - EnrollmentTask -> Teacher
- `teachers` 别名在以下关联中重复使用:
  - Kindergarten -> Teacher
  - Class -> Teacher

### 招生相关
- `plan` 别名在以下关联中重复使用:
  - EnrollmentTask -> EnrollmentPlan
  - EnrollmentApplication -> EnrollmentPlan
- `applications` 别名在以下关联中重复使用:
  - Parent -> EnrollmentApplication
  - EnrollmentPlan -> EnrollmentApplication

### 共用别名
- `creator` 别名在以下关联中重复使用:
  - EnrollmentApplication -> User
  - EnrollmentApplicationMaterial -> User
  - AdmissionResult -> User
  - AdmissionNotification -> User
- `updater` 别名在以下关联中重复使用:
  - EnrollmentApplication -> User
  - EnrollmentApplicationMaterial -> User
  - AdmissionResult -> User
  - AdmissionNotification -> User
- `grantor` 别名在以下关联中重复使用:
  - UserRole -> User
  - RolePermission -> User

## 当前错误分析

启动服务器时出现的错误：
```
TypeError: Cannot read properties of undefined (reading 'name')
    at createAssociation (/home/devbox/project/server/dist/models/associations.js:69:60)
```

这个错误出现在 `createAssociation` 函数中，尝试访问 `targetModel.name` 时出现问题。问题根源在于 `AdmissionResult` 模型未能正确加载或初始化，导致在创建关联时出现空引用。

## 解决方案

### 录取结果模型 (AdmissionResult)

创建了录取结果模型的JavaScript版本，解决了外键兼容性问题。主要修改包括：

1. 将TypeScript代码转换为JavaScript
2. 移除了外键引用定义中可能导致问题的部分（特别是对enrollment_applications表的外键引用）
3. 保留了所有关联定义
4. 确保字段名称使用下划线命名法，与数据库列名匹配

相关关联:
- AdmissionResult belongsTo EnrollmentApplication (application_id)
- AdmissionResult belongsTo Parent (parent_id)
- AdmissionResult belongsTo EnrollmentPlan (plan_id)
- AdmissionResult belongsTo Class (class_id)
- AdmissionResult belongsTo User (interviewer_id, decision_maker_id, created_by, updated_by)
- EnrollmentApplication hasOne AdmissionResult
- AdmissionNotification belongsTo AdmissionResult
- AdmissionResult hasMany AdmissionNotification

### 解决JavaScript模型中的错误

JavaScript模型中的require语句可能导致linter错误，但不影响运行时功能。对于CommonJS环境中的模型文件，使用require是标准做法。

### 最新更新记录 (2025-01-10)

#### 新增录取管理模块关联
1. **AdmissionResult 模型关联**：
   - 添加了与 EnrollmentApplication、Student、Kindergarten、Class、EnrollmentPlan、ParentStudentRelation 的关联
   - 使用别名：`application`, `student`, `kindergarten`, `class`, `plan`, `parent`
   - 创建人和更新人关联：`creator`, `updater`

2. **AdmissionNotification 模型关联**：
   - 添加了与 AdmissionResult、ParentStudentRelation、MessageTemplate 的关联
   - 使用别名：`admissionResult`, `parentRelation`, `template`
   - 创建人和更新人关联：`creator`, `updater`

3. **反向关联**：
   - EnrollmentApplication hasOne AdmissionResult (别名: `admissionResult`)
   - AdmissionResult hasMany AdmissionNotification (别名: `notifications`)

#### 别名冲突更新
- `creator` 和 `updater` 别名现在在更多模型中使用，包括新的录取管理模块
- 这些别名的重复使用是合理的，因为它们都指向 User 模型的创建人和更新人关系

### 可能的进一步优化

1. 修改别名命名规则，避免使用与模型名相同的别名，例如将 `class` 改为 `assignedClass`
2. 使用更具体的别名，例如将 `user` 改为具体角色，如 `ownerUser`, `parentUser` 等
3. 在关联中使用命名空间避免冲突，例如 `parentUser`, `teacherUser` 等
4. 对于多次使用的别名，考虑添加前缀，如 `enrollment_plan`, `activity_plan`

### 下一步行动

1. 确保修复后的JavaScript模型被正确加载
2. 观察启动时的关联日志，验证所有关联是否正确建立
3. 考虑对其他存在外键问题的模型采用类似的修复方法
4. 长期来看，修改别名系统，增强对别名重复使用的支持，或重构为更明确的命名规则 