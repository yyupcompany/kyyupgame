/**
 * SIPé…ç½®æœåŠ¡
 * 
 * è´Ÿè´£ä»æ•°æ®åº“åŠ è½½å’Œç®¡ç†SIPæœåŠ¡å™¨é…ç½®
 */

import { getSequelize } from '../config/database';

export interface SIPConfig {
  id: number;
  user_id: number;
  server_host: string;
  server_port: number;
  username: string;
  password: string;
  protocol: 'UDP' | 'TCP';
  is_active: boolean;
  last_register_time?: Date;
  register_interval: number;
  created_at: Date;
  updated_at: Date;
}

export class SIPConfigService {
  private static instance: SIPConfigService;
  private config: SIPConfig | null = null;
  private isLoaded: boolean = false;

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): SIPConfigService {
    if (!SIPConfigService.instance) {
      SIPConfigService.instance = new SIPConfigService();
    }
    return SIPConfigService.instance;
  }

  /**
   * ä»æ•°æ®åº“åŠ è½½SIPé…ç½®
   */
  async loadConfig(): Promise<void> {
    try {
      console.log('ğŸ“ æ­£åœ¨åŠ è½½SIPé…ç½®...');
      
      const sequelize = getSequelize();
      const [results] = await sequelize.query(`
        SELECT * FROM sip_configs WHERE is_active = 1 LIMIT 1
      `);
      
      if (results && results.length > 0) {
        this.config = results[0] as SIPConfig;
        this.isLoaded = true;
        
        console.log('âœ… SIPé…ç½®åŠ è½½æˆåŠŸ');
        console.log(`   æœåŠ¡å™¨: ${this.config.server_host}:${this.config.server_port}`);
        console.log(`   ç”¨æˆ·å: ${this.config.username}`);
        console.log(`   åè®®: ${this.config.protocol}`);
        console.log(`   æ³¨å†Œé—´éš”: ${this.config.register_interval}ç§’`);
      } else {
        console.warn('âš ï¸  æœªæ‰¾åˆ°æ¿€æ´»çš„SIPé…ç½®');
        console.log('ğŸ’¡ æç¤º: è¯·åœ¨æ•°æ®åº“ä¸­æ·»åŠ SIPé…ç½®');
        console.log('   INSERT INTO sip_configs (user_id, server_host, server_port, username, password, protocol, is_active)');
        console.log('   VALUES (1, \'47.94.82.59\', 5060, \'kanderadmin\', \'Szblade3944\', \'UDP\', TRUE);');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½SIPé…ç½®å¤±è´¥:', error);
      
      // æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
      try {
        const sequelize = getSequelize();
        await sequelize.query('SHOW TABLES LIKE "sip_configs"');
      } catch (tableError) {
        console.error('âŒ sip_configsè¡¨ä¸å­˜åœ¨ï¼Œè¯·è¿è¡Œæ•°æ®åº“è¿ç§»:');
        console.log('   cd server && npx sequelize-cli db:migrate');
      }
    }
  }

  /**
   * é‡æ–°åŠ è½½é…ç½®
   */
  async reloadConfig(): Promise<void> {
    this.config = null;
    this.isLoaded = false;
    await this.loadConfig();
  }

  /**
   * è·å–å½“å‰é…ç½®
   */
  getConfig(): SIPConfig | null {
    return this.config;
  }

  /**
   * æ£€æŸ¥é…ç½®æ˜¯å¦å·²åŠ è½½
   */
  isConfigLoaded(): boolean {
    return this.isLoaded && this.config !== null;
  }

  /**
   * è·å–SIPæœåŠ¡å™¨åœ°å€
   */
  getServerAddress(): string | null {
    if (!this.config) return null;
    return `${this.config.server_host}:${this.config.server_port}`;
  }

  /**
   * è·å–SIPè®¤è¯ä¿¡æ¯
   */
  getAuthInfo(): { username: string; password: string } | null {
    if (!this.config) return null;
    return {
      username: this.config.username,
      password: this.config.password
    };
  }

  /**
   * æ›´æ–°æœ€åæ³¨å†Œæ—¶é—´
   */
  async updateLastRegisterTime(): Promise<void> {
    if (!this.config) return;

    try {
      const sequelize = getSequelize();
      await sequelize.query(`
        UPDATE sip_configs
        SET last_register_time = NOW()
        WHERE id = ?
      `, {
        replacements: [this.config.id]
      });

      console.log('âœ… SIPæ³¨å†Œæ—¶é—´å·²æ›´æ–°');
    } catch (error) {
      console.error('âŒ æ›´æ–°SIPæ³¨å†Œæ—¶é—´å¤±è´¥:', error);
    }
  }

  /**
   * è·å–æ‰€æœ‰SIPé…ç½®ï¼ˆç”¨äºç®¡ç†ç•Œé¢ï¼‰
   */
  async getAllConfigs(): Promise<SIPConfig[]> {
    try {
      const sequelize = getSequelize();
      const [results] = await sequelize.query(`
        SELECT * FROM sip_configs ORDER BY is_active DESC, created_at DESC
      `);

      return results as SIPConfig[];
    } catch (error) {
      console.error('âŒ è·å–SIPé…ç½®åˆ—è¡¨å¤±è´¥:', error);
      return [];
    }
  }

  /**
   * åˆ›å»ºæ–°çš„SIPé…ç½®
   */
  async createConfig(config: Omit<SIPConfig, 'id' | 'created_at' | 'updated_at'>): Promise<SIPConfig | null> {
    try {
      const sequelize = getSequelize();
      const [result] = await sequelize.query(`
        INSERT INTO sip_configs (
          user_id, server_host, server_port, username, password,
          protocol, is_active, register_interval
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `, {
        replacements: [
          config.user_id,
          config.server_host,
          config.server_port,
          config.username,
          config.password,
          config.protocol,
          config.is_active,
          config.register_interval
        ]
      });

      console.log('âœ… SIPé…ç½®åˆ›å»ºæˆåŠŸ');

      // å¦‚æœæ˜¯æ¿€æ´»çš„é…ç½®ï¼Œé‡æ–°åŠ è½½
      if (config.is_active) {
        await this.reloadConfig();
      }

      return this.config;
    } catch (error) {
      console.error('âŒ åˆ›å»ºSIPé…ç½®å¤±è´¥:', error);
      return null;
    }
  }

  /**
   * æ›´æ–°SIPé…ç½®
   */
  async updateConfig(id: number, updates: Partial<SIPConfig>): Promise<boolean> {
    try {
      const fields: string[] = [];
      const values: any[] = [];

      if (updates.server_host !== undefined) {
        fields.push('server_host = ?');
        values.push(updates.server_host);
      }
      if (updates.server_port !== undefined) {
        fields.push('server_port = ?');
        values.push(updates.server_port);
      }
      if (updates.username !== undefined) {
        fields.push('username = ?');
        values.push(updates.username);
      }
      if (updates.password !== undefined) {
        fields.push('password = ?');
        values.push(updates.password);
      }
      if (updates.protocol !== undefined) {
        fields.push('protocol = ?');
        values.push(updates.protocol);
      }
      if (updates.is_active !== undefined) {
        fields.push('is_active = ?');
        values.push(updates.is_active);
      }
      if (updates.register_interval !== undefined) {
        fields.push('register_interval = ?');
        values.push(updates.register_interval);
      }

      if (fields.length === 0) {
        console.warn('âš ï¸  æ²¡æœ‰éœ€è¦æ›´æ–°çš„å­—æ®µ');
        return false;
      }

      values.push(id);

      const sequelize = getSequelize();
      await sequelize.query(`
        UPDATE sip_configs
        SET ${fields.join(', ')}, updated_at = NOW()
        WHERE id = ?
      `, {
        replacements: values
      });

      console.log('âœ… SIPé…ç½®æ›´æ–°æˆåŠŸ');

      // å¦‚æœæ›´æ–°çš„æ˜¯å½“å‰æ¿€æ´»çš„é…ç½®ï¼Œé‡æ–°åŠ è½½
      if (this.config && this.config.id === id) {
        await this.reloadConfig();
      }

      return true;
    } catch (error) {
      console.error('âŒ æ›´æ–°SIPé…ç½®å¤±è´¥:', error);
      return false;
    }
  }

  /**
   * åˆ é™¤SIPé…ç½®
   */
  async deleteConfig(id: number): Promise<boolean> {
    try {
      const sequelize = getSequelize();
      await sequelize.query(`
        DELETE FROM sip_configs WHERE id = ?
      `, {
        replacements: [id]
      });

      console.log('âœ… SIPé…ç½®åˆ é™¤æˆåŠŸ');

      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é…ç½®ï¼Œé‡æ–°åŠ è½½
      if (this.config && this.config.id === id) {
        await this.reloadConfig();
      }

      return true;
    } catch (error) {
      console.error('âŒ åˆ é™¤SIPé…ç½®å¤±è´¥:', error);
      return false;
    }
  }
}

// å¯¼å‡ºå•ä¾‹
export const sipConfigService = SIPConfigService.getInstance();

