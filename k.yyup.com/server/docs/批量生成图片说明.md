# 测评题目批量生成图片说明

## 速率限制

**限制**：每分钟最多 10 张图片  
**间隔**：每张图片间隔 6 秒  
**原因**：避免超过 API 速率限制

## 文件命名规则

**格式**：`q{题目ID}_{维度}_{年龄段}_{时间戳}.png`

**示例**：
- `q1_attention_24-36_1761854406287.png` - 第1题，专注力，2-3岁
- `q25_memory_36-48_1761854412345.png` - 第25题，记忆力，3-4岁
- `q89_logic_60-72_1761854418901.png` - 第89题，逻辑思维，5-6岁

## 六个维度的配色方案

| 维度 | 背景颜色 | 主题色 |
|------|---------|--------|
| 🔵 专注力 (attention) | 浅蓝色渐变 #E3F2FD→#BBDEFB | 蓝色系 |
| 🟣 记忆力 (memory) | 浅紫色渐变 #F3E5F5→#E1BEE7 | 紫色系 |
| 🟠 逻辑思维 (logic) | 浅橙色渐变 #FFF3E0→#FFE0B2 | 橙色系 |
| 🟢 语言能力 (language) | 浅绿色渐变 #E8F5E9→#C8E6C9 | 绿色系 |
| 🟡 精细动作 (motor) | 浅黄色渐变 #FFF9C4→#FFF59D | 黄色系 |
| 🩷 社交能力 (social) | 浅粉色渐变 #FCE4EC→#F8BBD0 | 粉色系 |

## 统一画面风格

- **风格**：扁平化卡通插画
- **线条**：圆润流畅，无尖锐边角
- **光线**：柔和均匀的自然光
- **构图**：居中对称，主体突出
- **氛围**：温馨友好、安全可靠、充满童趣

## 使用方法

### 1. 批量生成所有图片（推荐）

```bash
cd /home/zhgue/localhost:5173/server
npx ts-node src/scripts/generate-assessment-images.ts
```

**特点**：
- 自动跳过已有图片的题目
- 智能识别需要图片的题目
- 显示实时进度和预计时间
- 每分钟生成10张（速率限制）

### 2. 测试单张图片

```bash
cd /home/zhgue/localhost:5173/server
npx ts-node src/scripts/test-generate-one-image.ts
```

**特点**：
- 生成1张测试图片
- 验证提示词效果
- 检查风格和质量

### 3. Admin 界面手动生成

1. 登录管理后台
2. 进入"测评中心" → "题目管理"
3. 点击"编辑"按钮
4. 在"题目配图"区域点击"AI生成图片"
5. 保存题目

## 预计时间

根据需要生成图片的题目数量：

| 题目数 | 预计时间 | 说明 |
|--------|---------|------|
| 30题 | 3分钟 | 约25%的题目需要图片 |
| 60题 | 6分钟 | 约50%的题目需要图片 |
| 120题 | 12分钟 | 所有题目都需要图片 |

## 脚本功能

### 自动识别需要图片的题目

脚本会检查题目内容是否包含以下关键词：
- "图片"
- "观察"
- "看"
- "展示"

如果包含，则自动生成配图。

### 智能生成提示词

根据题目信息自动生成：
- 年龄段（2-3岁、3-4岁、4-5岁、5-6岁）
- 维度场景（专注力、记忆力等）
- 具体内容（动物、水果、公园等）
- 背景颜色（按维度区分）
- 画面风格（统一卡通风格）

### 用量统计

所有图片生成都会记录到 `ai_model_usage` 表：
- 用户ID：系统管理员（ID=1）
- 模型：doubao-seedream-3-0-t2i-250415
- 类型：image
- 提示词长度：记录在 tokens_input
- 生成张数：记录在 tokens_output
- 耗时：记录在 duration_ms

## 存储位置

- **物理路径**：`/home/zhgue/localhost:5173/uploads/assessment-images/`
- **访问路径**：`/uploads/assessment-images/`
- **URL示例**：`http://localhost:3000/uploads/assessment-images/q1_attention_24-36_1761854406287.png`

## 注意事项

1. **速率限制**：严格遵守每分钟10张的限制
2. **失败重试**：脚本会跳过失败的题目，可重新运行
3. **已有图片**：脚本会自动跳过已有图片的题目
4. **磁盘空间**：每张图片约150-200KB，120张约20MB

## 中断和恢复

如果生成过程中中断：
1. 脚本会自动保存已生成的图片
2. 重新运行脚本会跳过已有图片的题目
3. 只会生成缺失的图片

## 图片管理

### 查看已生成的图片

```bash
ls -lh /home/zhgue/localhost:5173/uploads/assessment-images/
```

### 按维度查看

```bash
ls /home/zhgue/localhost:5173/uploads/assessment-images/q*_attention_*.png  # 专注力
ls /home/zhgue/localhost:5173/uploads/assessment-images/q*_memory_*.png     # 记忆力
ls /home/zhgue/localhost:5173/uploads/assessment-images/q*_logic_*.png      # 逻辑思维
```

### 清空所有图片（谨慎使用）

```bash
# 删除所有图片文件
rm -f /home/zhgue/localhost:5173/uploads/assessment-images/*.png

# 清空数据库记录
UPDATE assessment_questions SET imageUrl = NULL, imagePrompt = NULL;
```

## 常见问题

### Q1: 生成的图片风格不一致怎么办？

A: 提示词中已经包含详细的风格描述，包括背景颜色、画面风格、光线构图等。如果仍不满意，可以：
1. 修改 `generateImagePrompt` 函数
2. 调整背景颜色或风格描述
3. 重新生成

### Q2: 如何只生成某个维度的图片？

A: 修改脚本中的查询条件：

```typescript
const questions = await AssessmentQuestion.findAll({
  where: {
    status: 'active',
    dimension: 'attention' // 只生成专注力题目的图片
  },
  order: [['id', 'ASC']]
});
```

### Q3: 如何重新生成已有图片的题目？

A: 先清空该题目的 imageUrl：

```sql
UPDATE assessment_questions SET imageUrl = NULL, imagePrompt = NULL WHERE id = 题目ID;
```

然后重新运行脚本。

## 总结

批量生成脚本已优化：
- ✅ 速率限制（每分钟10张）
- ✅ 正式文件命名
- ✅ 六个维度独立配色
- ✅ 统一画面风格
- ✅ AIBridge 统一接口
- ✅ 用量自动统计

现在可以安全地批量生成所有题目的配图了！





