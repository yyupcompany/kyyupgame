# API Testing Suite - å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿ

## æ¦‚è¿°
æœ¬æµ‹è¯•å¥—ä»¶ä¸ºå¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿæä¾›äº†å…¨é¢çš„APIæµ‹è¯•è¦†ç›–ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚æµ‹è¯•æ¡†æ¶é‡‡ç”¨Jest + TypeScriptæ„å»ºï¼Œæä¾›äº†å®Œæ•´çš„APIç«¯ç‚¹æµ‹è¯•ã€æ•°æ®åº“é›†æˆæµ‹è¯•å’Œç³»ç»Ÿå·¥ä½œæµéªŒè¯ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
server/APItest/
â”œâ”€â”€ unit/                      # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ auth.test.ts          # è®¤è¯APIæµ‹è¯•
â”‚   â”œâ”€â”€ users.test.ts         # ç”¨æˆ·ç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ students.test.ts      # å­¦ç”Ÿç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ teachers.test.ts      # æ•™å¸ˆç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ classes.test.ts       # ç­çº§ç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ activities.test.ts    # æ´»åŠ¨ç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ enrollment.test.ts    # æ‹›ç”Ÿç®¡ç†APIæµ‹è¯•
â”‚   â”œâ”€â”€ ai.test.ts           # AIæœåŠ¡APIæµ‹è¯•
â”‚   â”œâ”€â”€ services.test.ts     # æœåŠ¡å±‚æµ‹è¯•
â”‚   â”œâ”€â”€ controllers.test.ts  # æ§åˆ¶å™¨å±‚æµ‹è¯•
â”‚   â””â”€â”€ middleware.test.ts   # ä¸­é—´ä»¶æµ‹è¯•
â”œâ”€â”€ integration/              # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ database.test.ts     # æ•°æ®åº“æ“ä½œæµ‹è¯•
â”‚   â”œâ”€â”€ models.test.ts       # æ¨¡å‹å…³ç³»æµ‹è¯•
â”‚   â””â”€â”€ system.test.ts       # ç³»ç»Ÿé›†æˆæµ‹è¯•
â”œâ”€â”€ e2e/                     # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â””â”€â”€ swagger-validation.test.ts  # OpenAPIæ–‡æ¡£éªŒè¯
â”œâ”€â”€ fixtures/                # æµ‹è¯•æ•°æ®
â”‚   â””â”€â”€ testData.ts          # æµ‹è¯•æ•°æ®å·¥å‚
â”œâ”€â”€ helpers/                 # æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ setup.ts             # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â”‚   â”œâ”€â”€ testUtils.ts         # æµ‹è¯•å·¥å…·ç±»
â”‚   â”œâ”€â”€ swaggerValidator.ts  # OpenAPIéªŒè¯å·¥å…·
â”‚   â”œâ”€â”€ globalSetup.ts       # å…¨å±€æµ‹è¯•è®¾ç½®
â”‚   â””â”€â”€ globalTeardown.ts    # å…¨å±€æµ‹è¯•æ¸…ç†
â”œâ”€â”€ reports/                 # æµ‹è¯•æŠ¥å‘Š
â”‚   â”œâ”€â”€ coverage/            # è¦†ç›–ç‡æŠ¥å‘Š
â”‚   â””â”€â”€ swagger-validation-report.md  # APIæ–‡æ¡£éªŒè¯æŠ¥å‘Š
â”œâ”€â”€ jest.config.js           # Jesté…ç½®
â”œâ”€â”€ package.json             # ä¾èµ–å’Œè„šæœ¬
â””â”€â”€ README.md               # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–
```bash
cd /home/devbox/project/server/APItest
npm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
npm test
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
```bash
# å•å…ƒæµ‹è¯•
npm run test:unit

# é›†æˆæµ‹è¯•
npm run test:integration

# ç«¯åˆ°ç«¯æµ‹è¯•
npm run test:e2e

# å¸¦è¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage
```

### è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
```bash
# è®¤è¯ç›¸å…³æµ‹è¯•
npm run test:auth

# ç”¨æˆ·ç®¡ç†æµ‹è¯•
npm run test:users

# å­¦ç”Ÿç®¡ç†æµ‹è¯•
npm run test:students

# æ•™å¸ˆç®¡ç†æµ‹è¯•
npm run test:teachers

# ç­çº§ç®¡ç†æµ‹è¯•
npm run test:classes

# æ´»åŠ¨ç®¡ç†æµ‹è¯•
npm run test:activities

# æ‹›ç”Ÿç®¡ç†æµ‹è¯•
npm run test:enrollment

# AIæœåŠ¡æµ‹è¯•
npm run test:ai

# æœåŠ¡å±‚æµ‹è¯•
npm run test:services

# æ§åˆ¶å™¨å±‚æµ‹è¯•
npm run test:controllers

# ä¸­é—´ä»¶æµ‹è¯•
npm run test:middleware

# æ•°æ®åº“æµ‹è¯•
npm run test:database

# æ¨¡å‹æµ‹è¯•
npm run test:models

# ç³»ç»Ÿé›†æˆæµ‹è¯•
npm run test:system
```

### å¼€å‘æ¨¡å¼
```bash
# ç›‘è§†æ¨¡å¼ï¼ˆæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨è¿è¡Œï¼‰
npm run test:watch

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
npm run test:verbose

# é™é»˜æ¨¡å¼
npm run test:silent
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

æœ¬æµ‹è¯•å¥—ä»¶ç»´æŒä»¥ä¸‹æœ€ä½è¦†ç›–ç‡è¦æ±‚ï¼š
- **åˆ†æ”¯è¦†ç›–ç‡**: 70%
- **å‡½æ•°è¦†ç›–ç‡**: 70%
- **è¡Œè¦†ç›–ç‡**: 70%
- **è¯­å¥è¦†ç›–ç‡**: 70%

è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆåœ¨ `reports/coverage/` ç›®å½•ä¸‹ï¼ŒåŒ…å«HTMLå’ŒJSONæ ¼å¼ã€‚

## ğŸ§ª æµ‹è¯•ç±»å‹

### 1. å•å…ƒæµ‹è¯• (Unit Tests)
æµ‹è¯•ç‹¬ç«‹çš„APIç«¯ç‚¹åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

#### è®¤è¯ç³»ç»Ÿ
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- TokenéªŒè¯
- æƒé™æ£€æŸ¥
- å¯†ç é‡ç½®

#### ç”¨æˆ·ç®¡ç†
- ç”¨æˆ·CRUDæ“ä½œ
- è§’è‰²ç®¡ç†
- æƒé™åˆ†é…
- ç”¨æˆ·çŠ¶æ€ç®¡ç†

#### å­¦ç”Ÿç®¡ç†
- å­¦ç”Ÿæ¡£æ¡ˆç®¡ç†
- ç­çº§åˆ†é…
- å­¦ç”Ÿè½¬ç­
- æˆç»©è®°å½•

#### æ•™å¸ˆç®¡ç†
- æ•™å¸ˆä¿¡æ¯ç®¡ç†
- è¯¾ç¨‹å®‰æ’
- ç»©æ•ˆè¯„ä¼°
- ä¸“ä¸šå‘å±•

#### ç­çº§ç®¡ç†
- ç­çº§åˆ›å»ºå’Œç®¡ç†
- å­¦ç”Ÿåˆ†é…
- è¯¾ç¨‹å®‰æ’
- ç­çº§ç»Ÿè®¡

#### æ´»åŠ¨ç®¡ç†
- æ´»åŠ¨åˆ›å»ºå’Œç®¡ç†
- æ´»åŠ¨æŠ¥å
- ç­¾åˆ°ç®¡ç†
- æ´»åŠ¨è¯„ä¼°

#### æ‹›ç”Ÿç®¡ç†
- æ‹›ç”Ÿè®¡åˆ’ç®¡ç†
- ç”³è¯·å¤„ç†
- é¢è¯•å®‰æ’
- å½•å–ç®¡ç†

#### AIæœåŠ¡
- AIå¯¹è¯ç®¡ç†
- è®°å¿†å­˜å‚¨
- æ¨¡å‹ä½¿ç”¨è·Ÿè¸ª
- æ™ºèƒ½æ¨è

### 2. é›†æˆæµ‹è¯• (Integration Tests)
æµ‹è¯•ç»„ä»¶é—´çš„äº¤äº’å’Œæ•°æ®æµï¼š

#### æ•°æ®åº“é›†æˆ
- æ•°æ®æ¨¡å‹å…³ç³»
- äº‹åŠ¡å¤„ç†
- æ•°æ®å®Œæ•´æ€§
- æŸ¥è¯¢æ€§èƒ½

#### ç³»ç»Ÿå·¥ä½œæµ
- å®Œæ•´æ‹›ç”Ÿæµç¨‹
- æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸ
- AIè¾…åŠ©æ•™å­¦æµç¨‹
- ç”¨æˆ·æƒé™æµç¨‹

### 3. ç«¯åˆ°ç«¯æµ‹è¯• (E2E Tests)
æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·åœºæ™¯ï¼š

#### APIæ–‡æ¡£éªŒè¯
- OpenAPI 3.0è§„èŒƒéªŒè¯
- å“åº”æ ¼å¼éªŒè¯
- é”™è¯¯å¤„ç†éªŒè¯
- APIç‰ˆæœ¬å…¼å®¹æ€§

## ğŸ› ï¸ æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

### æ ¸å¿ƒæ¡†æ¶
- **Jest**: æµ‹è¯•æ¡†æ¶å’Œæ–­è¨€åº“
- **TypeScript**: ç±»å‹å®‰å…¨çš„æµ‹è¯•ä»£ç 
- **Supertest**: HTTP APIæµ‹è¯•
- **Sequelize**: æ•°æ®åº“ORMæµ‹è¯•

### æµ‹è¯•å·¥å…·
- **TestHelper**: APIæµ‹è¯•è¾…åŠ©ç±»
- **TestDataFactory**: æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨
- **ResponseValidators**: å“åº”æ ¼å¼éªŒè¯å™¨
- **DatabaseCleaner**: æ•°æ®åº“æ¸…ç†å·¥å…·
- **SwaggerValidator**: OpenAPIæ–‡æ¡£éªŒè¯å™¨

### è‡ªå®šä¹‰MockæœåŠ¡
- **MockAuthMiddleware**: è®¤è¯ä¸­é—´ä»¶æ¨¡æ‹Ÿ
- **MockValidationMiddleware**: éªŒè¯ä¸­é—´ä»¶æ¨¡æ‹Ÿ
- **MockRateLimitMiddleware**: é™æµä¸­é—´ä»¶æ¨¡æ‹Ÿ
- **MockSecurityMiddleware**: å®‰å…¨ä¸­é—´ä»¶æ¨¡æ‹Ÿ
- **MockLoggingMiddleware**: æ—¥å¿—ä¸­é—´ä»¶æ¨¡æ‹Ÿ

## ğŸ“‹ æµ‹è¯•ç”¨ä¾‹è¦†ç›–

### APIç«¯ç‚¹æµ‹è¯• (155+ ç«¯ç‚¹)
- âœ… è®¤è¯ç›¸å…³ (10+ ç«¯ç‚¹)
- âœ… ç”¨æˆ·ç®¡ç† (15+ ç«¯ç‚¹)
- âœ… å­¦ç”Ÿç®¡ç† (20+ ç«¯ç‚¹)
- âœ… æ•™å¸ˆç®¡ç† (15+ ç«¯ç‚¹)
- âœ… ç­çº§ç®¡ç† (12+ ç«¯ç‚¹)
- âœ… æ´»åŠ¨ç®¡ç† (25+ ç«¯ç‚¹)
- âœ… æ‹›ç”Ÿç®¡ç† (20+ ç«¯ç‚¹)
- âœ… AIæœåŠ¡ (15+ ç«¯ç‚¹)
- âœ… ç³»ç»Ÿç®¡ç† (10+ ç«¯ç‚¹)
- âœ… æ–‡ä»¶ç®¡ç† (8+ ç«¯ç‚¹)
- âœ… é€šçŸ¥ç®¡ç† (5+ ç«¯ç‚¹)

### æ•°æ®åº“æ¨¡å‹æµ‹è¯• (73+ æ¨¡å‹)
- âœ… ç”¨æˆ·ç›¸å…³æ¨¡å‹
- âœ… æ•™è‚²ç›¸å…³æ¨¡å‹
- âœ… æ‹›ç”Ÿç›¸å…³æ¨¡å‹
- âœ… æ´»åŠ¨ç›¸å…³æ¨¡å‹
- âœ… AIç³»ç»Ÿæ¨¡å‹
- âœ… ç³»ç»Ÿé…ç½®æ¨¡å‹

### ä¸šåŠ¡é€»è¾‘æµ‹è¯•
- âœ… æœåŠ¡å±‚é€»è¾‘
- âœ… æ§åˆ¶å™¨é€»è¾‘
- âœ… ä¸­é—´ä»¶é€»è¾‘
- âœ… å·¥ä½œæµé›†æˆ

## ğŸ”§ é…ç½®è¯´æ˜

### Jesté…ç½® (jest.config.js)
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>'],
  testMatch: [
    '**/unit/**/*.test.ts',
    '**/integration/**/*.test.ts',
    '**/e2e/**/*.test.ts'
  ],
  collectCoverageFrom: [
    'unit/**/*.ts',
    'integration/**/*.ts',
    'helpers/**/*.ts',
    '!**/*.d.ts',
    '!**/node_modules/**'
  ],
  coverageDirectory: 'reports/coverage',
  coverageReporters: ['html', 'json', 'text-summary'],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  },
  setupFilesAfterEnv: ['<rootDir>/helpers/setup.ts'],
  globalSetup: '<rootDir>/helpers/globalSetup.ts',
  globalTeardown: '<rootDir>/helpers/globalTeardown.ts',
  moduleNameMapper: {
    '^@test/(.*)$': '<rootDir>/$1'
  },
  testTimeout: 30000,
  verbose: true
};
```

### ç¯å¢ƒå˜é‡
æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“é…ç½®ï¼š
```bash
TEST_DB_NAME=kindergarten_test
TEST_DB_USER=root
TEST_DB_PASSWORD=
TEST_DB_HOST=localhost
TEST_DB_PORT=3306
NODE_ENV=test
```

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

### è¦†ç›–ç‡æŠ¥å‘Š
- **HTMLæŠ¥å‘Š**: `reports/coverage/index.html`
- **JSONæŠ¥å‘Š**: `reports/coverage/coverage-final.json`
- **æ–‡æœ¬æ‘˜è¦**: æ§åˆ¶å°è¾“å‡º

### APIæ–‡æ¡£éªŒè¯æŠ¥å‘Š
- **è¯¦ç»†æŠ¥å‘Š**: `reports/swagger-validation-report.md`
- **éªŒè¯ç»“æœ**: åŒ…å«æ‰€æœ‰APIç«¯ç‚¹çš„æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥

## ğŸ› è°ƒè¯•å’Œæ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“é…ç½®
cat .env

# ç¡®ä¿MySQLæœåŠ¡è¿è¡Œ
sudo service mysql start

# æ£€æŸ¥æµ‹è¯•æ•°æ®åº“æ˜¯å¦å­˜åœ¨
mysql -u root -p -e "SHOW DATABASES;"
```

#### 2. æµ‹è¯•è¶…æ—¶
```bash
# å¢åŠ è¶…æ—¶æ—¶é—´
npm test -- --testTimeout=60000

# æˆ–è¿è¡Œç‰¹å®šæµ‹è¯•
npm run test:auth
```

#### 3. å†…å­˜ä¸è¶³
```bash
# å¢åŠ Node.jså†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=4096"
npm test
```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
DEBUG=* npm test

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶è¿›è¡Œè°ƒè¯•
npm test -- unit/auth.test.ts --verbose
```

## ğŸ”„ æŒç»­é›†æˆ

### CI/CDè„šæœ¬
```bash
# CIç¯å¢ƒè¿è¡Œæµ‹è¯•
npm run test:ci

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
npm run test:coverage

# æ¸…ç†æµ‹è¯•ç¯å¢ƒ
npm run clean
```

### æµ‹è¯•æµæ°´çº¿
1. **ç¯å¢ƒå‡†å¤‡**: å®‰è£…ä¾èµ–ï¼Œè®¾ç½®æµ‹è¯•æ•°æ®åº“
2. **å•å…ƒæµ‹è¯•**: è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
3. **é›†æˆæµ‹è¯•**: è¿è¡Œæ•°æ®åº“å’Œç³»ç»Ÿé›†æˆæµ‹è¯•
4. **E2Eæµ‹è¯•**: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
5. **è¦†ç›–ç‡æ£€æŸ¥**: éªŒè¯è¦†ç›–ç‡è¾¾æ ‡
6. **æŠ¥å‘Šç”Ÿæˆ**: ç”Ÿæˆæµ‹è¯•å’Œè¦†ç›–ç‡æŠ¥å‘Š

## ğŸ“š æœ€ä½³å®è·µ

### æµ‹è¯•ç¼–å†™æŒ‡å—
1. **æµ‹è¯•å‘½å**: ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
2. **æµ‹è¯•éš”ç¦»**: æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
3. **æ•°æ®æ¸…ç†**: ä½¿ç”¨beforeEachæ¸…ç†æµ‹è¯•æ•°æ®
4. **æ–­è¨€æ¸…æ™°**: ä½¿ç”¨æ˜ç¡®çš„æ–­è¨€æ¶ˆæ¯
5. **Mocké€‚åº¦**: åªMockå¿…è¦çš„å¤–éƒ¨ä¾èµ–

### æµ‹è¯•ç»´æŠ¤
1. **å®šæœŸæ›´æ–°**: éšAPIå˜æ›´æ›´æ–°æµ‹è¯•
2. **è¦†ç›–ç‡ç›‘æ§**: ä¿æŒè¦†ç›–ç‡è¾¾æ ‡
3. **æ€§èƒ½ç›‘æ§**: å…³æ³¨æµ‹è¯•æ‰§è¡Œæ—¶é—´
4. **æ–‡æ¡£åŒæ­¥**: ä¿æŒæµ‹è¯•æ–‡æ¡£æ›´æ–°

## ğŸ¤ è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æµ‹è¯•
1. åœ¨ç›¸åº”ç›®å½•åˆ›å»ºæµ‹è¯•æ–‡ä»¶
2. éµå¾ªç°æœ‰å‘½åå’Œç»“æ„è§„èŒƒ
3. æ·»åŠ é€‚å½“çš„æµ‹è¯•ç”¨ä¾‹
4. ç¡®ä¿è¦†ç›–ç‡è¾¾æ ‡
5. æ›´æ–°ç›¸å…³æ–‡æ¡£

### æäº¤è§„èŒƒ
```bash
# æäº¤å‰è¿è¡Œå®Œæ•´æµ‹è¯•
npm run test:coverage

# ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
npm run test:ci
```

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚é‡åˆ°æµ‹è¯•ç›¸å…³é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥æµ‹è¯•æ—¥å¿—è¾“å‡º
3. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒ

---

**æ›´æ–°æ—¶é—´**: 2024å¹´7æœˆ13æ—¥  
**ç‰ˆæœ¬**: 1.0.0  
**ç»´æŠ¤è€…**: å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ