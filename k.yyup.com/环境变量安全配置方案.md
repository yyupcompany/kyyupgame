# 环境变量安全配置方案

## 🚨 当前问题
- 所有`.env`文件都包含真实敏感信息
- `.gitignore`没有完全忽略环境变量文件
- 存在密钥泄露风险

## 🛡️ 安全解决方案

### 1. **环境变量存储位置**

#### 开发环境：
```bash
# 本地开发（不提交到git）
.env.local  # 个人开发环境
.env.development  # 团队共享开发环境（无敏感信息）
```

#### 生产环境：
```bash
# 服务器环境变量
export DB_HOST=xxx
export DB_PASSWORD=xxx

# 或使用密钥管理服务
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault
- Google Secret Manager
```

#### Docker部署：
```bash
# 使用Docker secrets
docker run -e DB_PASSWORD_FILE=/run/secrets/db_password app

# 或使用Docker Compose
version: '3.8'
services:
  app:
    env_file:
      - ./production.env
    secrets:
      - db_password
```

### 2. **环境变量分离策略**

#### 公开配置（可提交）：
```bash
# .env.example - 模板文件
.env.template - 配置模板
.env.sample - 示例配置
```

#### 私有配置（不提交）：
```bash
# .env.local - 个人开发
.env.production - 生产环境
.env.staging - 测试环境
```

### 3. **密钥管理最佳实践**

#### 生成强密钥：
```bash
# JWT密钥（至少32位）
openssl rand -base64 32

# 数据库密码
openssl rand -base64 16

# 会话密钥
openssl rand -hex 32
```

#### 密钥轮换：
```bash
# 定期更换密钥
- JWT密钥：每3个月
- 数据库密码：每6个月
- API密钥：每年或泄露时
```

### 4. **部署环境配置**

#### 云服务器：
```bash
# 1. 设置系统环境变量
echo "export DB_PASSWORD='xxx'" >> ~/.bashrc

# 2. 使用systemd服务文件
Environment=DB_PASSWORD=xxx
EnvironmentFile=/opt/app/.env

# 3. 使用密钥文件
chmod 600 /opt/app/.env
chown app:app /opt/app/.env
```

#### Kubernetes：
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
data:
  db-password: <base64-encoded-password>
  jwt-secret: <base64-encoded-secret>
```

### 5. **安全检查清单**

- [ ] 所有`.env`文件已添加到`.gitignore`
- [ ] 移除代码中的硬编码密钥
- [ ] 使用强密码和随机密钥
- [ ] 定期轮换密钥
- [ ] 生产环境使用密钥管理服务
- [ ] 限制环境变量文件权限（600）
- [ ] 审查日志输出，避免泄露敏感信息

### 6. **紧急处理措施**

如果怀疑密钥已泄露：
1. 立即更换所有密钥
2. 检查访问日志
3. 撤销相关API密钥
4. 通知相关人员
5. 审施更严格的安全措施

## 🔄 迁移步骤

1. **备份现有配置**
2. **创建.env.example模板**
3. **更新.gitignore**
4. **移除仓库中的敏感文件**
5. **配置生产环境变量**
6. **测试部署**