# 用量中心快速启动指南

## 🚀 快速开始

### 步骤1: 执行权限配置脚本

```bash
cd server
npx ts-node src/scripts/add-usage-center-permission.ts
```

**预期输出**:
```
🚀 开始添加用量中心权限配置...

✅ 系统管理分类已存在，ID: 123

📊 创建用量中心权限...
✅ 用量中心权限创建成功，ID: 456

📋 找到 2 个角色需要分配权限

✅ 为角色 admin 分配系统管理分类权限
✅ 为角色 admin 分配用量中心权限
✅ 为角色 principal 分配系统管理分类权限
✅ 为角色 principal 分配用量中心权限

🎉 用量中心权限配置完成！

📊 权限配置摘要:
   - 系统管理分类 ID: 123
   - 用量中心权限 ID: 456
   - 已分配角色: admin, principal

✅ 管理员和园长现在可以在侧边栏看到"用量中心"菜单项

✅ 脚本执行成功
```

### 步骤2: 重启服务（如果需要）

```bash
# 如果后端正在运行，重启后端
cd server
npm run dev

# 如果前端正在运行，重启前端
cd client
npm run dev
```

### 步骤3: 访问用量中心

#### 管理员/园长访问

1. 使用管理员或园长账号登录系统
2. 在左侧侧边栏找到"系统管理"分类
3. 点击"用量中心"菜单项
4. 进入用量中心页面

#### 教师访问个人用量

1. 使用教师账号登录系统
2. 点击右上角头像
3. 在下拉菜单中点击"个人中心"
4. 查看个人用量统计（待集成到个人中心页面）

## 📊 功能说明

### 用量中心页面功能

#### 1. 概览统计
- **总调用次数**: 显示所有用户的AI调用总次数
- **总费用**: 显示所有用户的AI使用总费用
- **活跃用户**: 显示有AI使用记录的用户数量
- **平均费用**: 显示每个用户的平均费用

#### 2. 按类型统计
- **文本**: 文本生成、对话等
- **图片**: 图片生成、识别等
- **语音**: 语音识别、合成等
- **视频**: 视频生成、分析等
- **向量**: 向量嵌入等

#### 3. 用户用量排行
- 显示所有用户的用量统计
- 支持按用户名或邮箱搜索
- 支持分页浏览
- 点击"查看详情"可查看用户详细用量

#### 4. 用户详情
- **按类型统计**: 该用户各类型的使用情况
- **按模型统计**: 该用户各模型的使用情况
- **最近使用记录**: 该用户最近10条使用记录

#### 5. 日期范围筛选
- 默认显示最近30天的数据
- 可自定义日期范围
- 支持实时刷新

## 🎯 使用场景

### 场景1: 查看整体用量
1. 进入用量中心
2. 查看概览统计卡片
3. 了解总体使用情况

### 场景2: 查看某个用户的详细用量
1. 进入用量中心
2. 在用户用量排行表格中找到目标用户
3. 点击"查看详情"按钮
4. 查看该用户的详细用量统计

### 场景3: 查看特定时间段的用量
1. 进入用量中心
2. 点击日期范围选择器
3. 选择开始日期和结束日期
4. 系统自动刷新数据

### 场景4: 搜索特定用户
1. 进入用量中心
2. 在搜索框中输入用户名或邮箱
3. 查看搜索结果

## 📋 数据说明

### 费用计算
- 费用基于AIBridge统一流量计算
- 不同类型的AI服务有不同的计费规则
- 费用精确到小数点后6位

### 数据来源
- `ai_model_usage` 表：AI使用记录
- `users` 表：用户信息
- `ai_model_config` 表：模型配置
- `ai_model_billing` 表：计费规则

### 统计维度
- **按用户**: 每个用户的总用量
- **按类型**: 文本、图片、语音、视频、向量
- **按模型**: 不同AI模型的用量
- **按时间**: 指定日期范围的用量

## 🔍 常见问题

### Q1: 为什么看不到用量中心菜单？
**A**: 请确保：
1. 已执行权限配置脚本
2. 使用管理员或园长账号登录
3. 已重启前端服务
4. 清除浏览器缓存

### Q2: 数据为什么是0？
**A**: 可能原因：
1. 系统还没有AI使用记录
2. 选择的日期范围内没有数据
3. 数据库连接问题

### Q3: 如何导出数据？
**A**: 导出功能待开发，目前可以：
1. 直接查看页面数据
2. 使用浏览器截图
3. 手动复制数据

### Q4: 教师如何查看个人用量？
**A**: 教师可以：
1. 点击右上角头像
2. 选择"个人中心"
3. 查看个人用量统计（待集成）

或者调用API：
```bash
GET /api/usage-center/my-usage
```

## 🛠️ 故障排除

### 问题1: 权限脚本执行失败
```bash
# 检查数据库连接
cd server
npm run db:test

# 检查数据库表是否存在
mysql -u root -p
USE kindergarten_db;
SHOW TABLES LIKE 'permissions';
SHOW TABLES LIKE 'roles';
SHOW TABLES LIKE 'role_permissions';
```

### 问题2: 页面加载失败
```bash
# 检查前端控制台错误
# 检查网络请求是否成功
# 检查API响应数据

# 重启前端服务
cd client
npm run dev
```

### 问题3: API调用失败
```bash
# 检查后端日志
cd server
npm run dev

# 检查JWT token是否有效
# 检查用户权限是否正确
```

## 📞 技术支持

如果遇到问题，请：
1. 查看控制台错误日志
2. 查看后端日志
3. 检查数据库数据
4. 联系技术支持

## 🎉 总结

用量中心功能已完全开发完成，包括：
- ✅ 后端API（4个端点）
- ✅ 前端页面（完整UI）
- ✅ 权限配置（管理员、园长）
- ✅ 侧边栏集成
- ✅ 数据统计（多维度）

**立即执行权限脚本，开始使用用量中心！** 🚀

