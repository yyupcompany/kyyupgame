FROM node:18-alpine

# 安装必要的工具
RUN apk add --no-cache \
    bash \
    git \
    curl \
    vim \
    postgresql-client \
    python3 \
    py3-pip \
    && npm install -g pm2 nodemon

# 创建工作目录
WORKDIR /workspace

# 复制package.json文件（如果存在）
COPY package*.json ./
COPY server/package*.json ./server/
COPY client/package*.json ./client/

# 安装依赖
RUN npm install || true
RUN cd server && npm install || true
RUN cd client && npm install || true

# 复制所有项目文件
COPY . .

# 设置环境变量
ENV NODE_ENV=development
ENV PORT=3001
ENV VITE_PORT=5173
ENV HOST=0.0.0.0

# 暴露端口
EXPOSE 3001 5173 5174

# 创建启动脚本
RUN echo '#!/bin/bash\n\
echo "Starting development environment..."\n\
\n\
# 启动后端服务\n\
cd /workspace/server\n\
npm run dev &\n\
\n\
# 启动前端服务\n\
cd /workspace/client\n\
npm run dev -- --host 0.0.0.0 --port 5173 &\n\
\n\
# 保持容器运行\n\
wait\n\
' > /start-dev.sh && chmod +x /start-dev.sh

# 默认启动bash
CMD ["/bin/bash"]