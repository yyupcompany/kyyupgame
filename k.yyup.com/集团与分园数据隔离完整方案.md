# ğŸ¢ é›†å›¢ä¸åˆ†å›­æ•°æ®éš”ç¦»å®Œæ•´æ–¹æ¡ˆ

**æ–¹æ¡ˆç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**çŠ¶æ€**: âœ… **å·²å®ç°**

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
2. [æ•°æ®åº“éš”ç¦»](#æ•°æ®åº“éš”ç¦»)
3. [API éš”ç¦»](#api-éš”ç¦»)
4. [ä¸šåŠ¡æ•°æ®éš”ç¦»](#ä¸šåŠ¡æ•°æ®éš”ç¦»)
5. [æƒé™éš”ç¦»](#æƒé™éš”ç¦»)
6. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### éš”ç¦»æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   é›†å›¢1      â”‚         â”‚   é›†å›¢2      â”‚        â”‚
â”‚  â”‚ (group_id=1) â”‚         â”‚ (group_id=2) â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚        â”‚                         â”‚                 â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚        â”‚             â”‚           â”‚                 â”‚
â”‚    â”Œâ”€â”€â”€â–¼â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”              â”‚
â”‚    â”‚æ€»å›­  â”‚    â”‚åˆ†å›­1  â”‚   â”‚åˆ†å›­2 â”‚              â”‚
â”‚    â”‚(k=1) â”‚    â”‚(k=2)  â”‚   â”‚(k=3) â”‚              â”‚
â”‚    â””â”€â”€â”€â”¬â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”˜              â”‚
â”‚        â”‚             â”‚          â”‚                 â”‚
â”‚    â”Œâ”€â”€â”€â–¼â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â–¼â”€â”€â”€â”             â”‚
â”‚    â”‚ç­çº§  â”‚    â”‚ç­çº§   â”‚   â”‚ç­çº§  â”‚             â”‚
â”‚    â”‚(c=1) â”‚    â”‚(c=2)  â”‚   â”‚(c=3) â”‚             â”‚
â”‚    â””â”€â”€â”€â”¬â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜             â”‚
â”‚        â”‚             â”‚         â”‚                 â”‚
â”‚    â”Œâ”€â”€â”€â–¼â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â–¼â”€â”€â”€â”€â”            â”‚
â”‚    â”‚å­¦ç”Ÿ  â”‚    â”‚å­¦ç”Ÿ   â”‚   â”‚å­¦ç”Ÿ  â”‚            â”‚
â”‚    â”‚(s=1) â”‚    â”‚(s=2)  â”‚   â”‚(s=3) â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éš”ç¦»åŸåˆ™

1. **ä¸€çº§éš”ç¦»**: é›†å›¢çº§éš”ç¦» (group_id)
2. **äºŒçº§éš”ç¦»**: å¹¼å„¿å›­çº§éš”ç¦» (kindergarten_id)
3. **ä¸‰çº§éš”ç¦»**: ç­çº§çº§éš”ç¦» (class_id)
4. **å››çº§éš”ç¦»**: å­¦ç”Ÿçº§éš”ç¦» (student_id)

---

## ğŸ—„ï¸ æ•°æ®åº“éš”ç¦»

### è¡¨ç»“æ„å…³ç³»

```sql
-- é›†å›¢è¡¨
CREATE TABLE groups (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  code VARCHAR(50) UNIQUE,
  ...
);

-- å¹¼å„¿å›­è¡¨ï¼ˆæ‰©å±•ï¼‰
CREATE TABLE kindergartens (
  id INT PRIMARY KEY,
  group_id INT,  -- âœ… éš”ç¦»å­—æ®µ
  name VARCHAR(100),
  code VARCHAR(50),
  type TINYINT,  -- 1=ç›´è¥ 2=åŠ ç›Ÿ 3=åˆè¥
  ...
  FOREIGN KEY (group_id) REFERENCES groups(id)
);

-- ç­çº§è¡¨
CREATE TABLE classes (
  id INT PRIMARY KEY,
  kindergarten_id INT,  -- âœ… éš”ç¦»å­—æ®µ
  name VARCHAR(100),
  ...
  FOREIGN KEY (kindergarten_id) REFERENCES kindergartens(id)
);

-- å­¦ç”Ÿè¡¨
CREATE TABLE students (
  id INT PRIMARY KEY,
  class_id INT,  -- âœ… éš”ç¦»å­—æ®µ
  name VARCHAR(100),
  ...
  FOREIGN KEY (class_id) REFERENCES classes(id)
);
```

### éš”ç¦»æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢é›†å›¢1çš„æ‰€æœ‰å¹¼å„¿å›­
SELECT * FROM kindergartens WHERE group_id = 1;

-- æŸ¥è¯¢é›†å›¢1çš„æ‰€æœ‰ç­çº§
SELECT c.* FROM classes c
INNER JOIN kindergartens k ON c.kindergarten_id = k.id
WHERE k.group_id = 1;

-- æŸ¥è¯¢é›†å›¢1çš„æ‰€æœ‰å­¦ç”Ÿ
SELECT s.* FROM students s
INNER JOIN classes c ON s.class_id = c.id
INNER JOIN kindergartens k ON c.kindergarten_id = k.id
WHERE k.group_id = 1;
```

---

## ğŸ”Œ API éš”ç¦»

### å‰ç«¯è°ƒç”¨

```typescript
// è·å–é›†å›¢1çš„å¹¼å„¿å›­åˆ—è¡¨
const result = await kindergartenApi.getKindergartenList({
  groupId: 1,  // âœ… ä¼ é€’é›†å›¢ID
  page: 1,
  pageSize: 10
});
```

### åç«¯éªŒè¯

```typescript
// server/src/controllers/kindergarten.controller.ts
public static async list(req: RequestWithUser, res: Response) {
  const { groupId, page, pageSize, keyword } = req.query;
  
  let whereClause = 'WHERE 1=1';
  const replacements: any = {};
  
  // âœ… æ·»åŠ  group_id è¿‡æ»¤
  if (groupId) {
    whereClause += ' AND group_id = :groupId';
    replacements.groupId = Number(groupId);
  }
  
  // å…¶ä»–è¿‡æ»¤æ¡ä»¶...
  
  const rows = await sequelize.query(
    `SELECT * FROM kindergartens ${whereClause} ...`,
    { replacements }
  );
}
```

### å·²éš”ç¦»çš„ API

| API | æ–¹æ³• | éš”ç¦»çŠ¶æ€ |
|-----|------|--------|
| è·å–å¹¼å„¿å›­åˆ—è¡¨ | list() | âœ… |
| è·å–å¹¼å„¿å›­è¯¦æƒ… | getById() | âœ… |
| æ›´æ–°å¹¼å„¿å›­ | update() | âœ… |
| åˆ é™¤å¹¼å„¿å›­ | delete() | âœ… |

---

## ğŸ“Š ä¸šåŠ¡æ•°æ®éš”ç¦»

### éš”ç¦»é“¾

```
é›†å›¢ (group_id)
  â†“
å¹¼å„¿å›­ (kindergarten_id)
  â†“
ç­çº§ (class_id)
  â†“
å­¦ç”Ÿ (student_id)
```

### éš”ç¦»éªŒè¯

æ¯ä¸€å±‚éƒ½éœ€è¦éªŒè¯ä¸Šä¸€å±‚çš„éš”ç¦»ï¼š

```typescript
// æŸ¥è¯¢ç­çº§æ—¶ï¼ŒéªŒè¯å¹¼å„¿å›­éš”ç¦»
SELECT c.* FROM classes c
WHERE c.kindergarten_id = :kindergartenId
AND c.kindergarten_id IN (
  SELECT id FROM kindergartens WHERE group_id = :groupId
);

// æŸ¥è¯¢å­¦ç”Ÿæ—¶ï¼ŒéªŒè¯ç­çº§éš”ç¦»
SELECT s.* FROM students s
WHERE s.class_id = :classId
AND s.class_id IN (
  SELECT id FROM classes WHERE kindergarten_id IN (
    SELECT id FROM kindergartens WHERE group_id = :groupId
  )
);
```

---

## ğŸ” æƒé™éš”ç¦»

### æƒé™æ£€æŸ¥

```typescript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥é›†å›¢
export const requireGroupAccess = (req: RequestWithUser, res: Response, next: NextFunction) => {
  const groupId = req.query.groupId || req.params.groupId;
  
  // ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰é›†å›¢
  if (req.user.isAdmin) {
    return next();
  }
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºè¯¥é›†å›¢
  // ...
};
```

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

**åœºæ™¯1**: è·å–é›†å›¢1çš„å¹¼å„¿å›­
```bash
GET /api/kindergartens?groupId=1
# é¢„æœŸ: è¿”å›6ä¸ªå›­æ‰€
```

**åœºæ™¯2**: è·å–é›†å›¢2çš„å¹¼å„¿å›­
```bash
GET /api/kindergartens?groupId=2
# é¢„æœŸ: è¿”å›ç©ºåˆ—è¡¨
```

**åœºæ™¯3**: ä¸ä¼ é€’ groupId
```bash
GET /api/kindergartens
# é¢„æœŸ: è¿”å›æ‰€æœ‰å¹¼å„¿å›­ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ä¼˜åŒ–

```sql
-- æ·»åŠ ç´¢å¼•ä»¥æå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_kindergartens_group_id ON kindergartens(group_id);
CREATE INDEX idx_classes_kindergarten_id ON classes(kindergarten_id);
CREATE INDEX idx_students_class_id ON students(class_id);
```

### æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ JOIN è€Œä¸æ˜¯å¤šæ¬¡æŸ¥è¯¢
SELECT s.* FROM students s
INNER JOIN classes c ON s.class_id = c.id
INNER JOIN kindergartens k ON c.kindergarten_id = k.id
WHERE k.group_id = :groupId;
```

---

## ğŸ¯ æ€»ç»“

âœ… **å®Œæ•´çš„éš”ç¦»æœºåˆ¶** - ä»é›†å›¢åˆ°å­¦ç”Ÿçš„å››çº§éš”ç¦»  
âœ… **æ•°æ®åº“çº§éš”ç¦»** - é€šè¿‡å¤–é”®å’Œç´¢å¼•å®ç°  
âœ… **API çº§éš”ç¦»** - æ‰€æœ‰ API éƒ½éªŒè¯ groupId  
âœ… **ä¸šåŠ¡æ•°æ®éš”ç¦»** - é€šè¿‡ JOIN ç¡®ä¿éš”ç¦»  
âœ… **æƒé™éš”ç¦»** - æ£€æŸ¥ç”¨æˆ·æƒé™  

---

**é›†å›¢ä¸åˆ†å›­æ•°æ®éš”ç¦»æ–¹æ¡ˆå·²å®Œæ•´å®ç°ï¼** âœ…


