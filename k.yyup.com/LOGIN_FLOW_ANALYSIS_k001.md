# ç™»å½•é“¾è·¯å®Œæ•´åˆ†æï¼šk001.yyup.cc åŸŸå

## ğŸ“‹ æ¦‚è§ˆ
å½“ç”¨æˆ·åœ¨åŸŸå `k001.yyup.cc` ä¸Šè¾“å…¥å‡­è¯å¹¶ç‚¹å‡»ç™»å½•æ—¶ï¼Œç³»ç»Ÿå°†æ‰§è¡Œä»¥ä¸‹å®Œæ•´é“¾è·¯ã€‚

---

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹é“¾è·¯

### ç¬¬ä¸€é˜¶æ®µï¼šå‰ç«¯äº¤äº’

#### 1. **ç”¨æˆ·è¾“å…¥å’Œè¡¨å•æäº¤**
- **ä½ç½®**: `client/src/pages/Login/index.vue`ï¼ˆè¡Œ 628-684ï¼‰
- **è§¦å‘**: ç”¨æˆ·ç‚¹å‡»"ç™»å½•"æŒ‰é’®
- **å¤„ç†**:
  ```
  handleLogin() {
    â”œâ”€ éªŒè¯è¡¨å• (validateForm)
    â”œâ”€ è®¾ç½®å…¨å±€ loading = true
    â””â”€ æ ¹æ®ç™»å½•æ¨¡å¼é€‰æ‹©è·¯å¾„:
       â”œâ”€ Mode 0: ç”¨æˆ·åç™»å½• â†’ login() API
       â””â”€ Mode 1: æ‰‹æœºå·ç™»å½• â†’ authStore.flexibleLogin()
  ```

#### 2. **å‰ç«¯ç™»å½•APIè°ƒç”¨**
- **å¯¹äºæ‰‹æœºå·ç™»å½•** (Mode 1)ï¼š
  - **è°ƒç”¨**: `authStore.flexibleLogin(phone, password, tenantCode)`
  - **æ¥æº**: `client/src/store/modules/auth.ts`ï¼ˆè¡Œ 140-196ï¼‰
  - **æµç¨‹**:
    ```javascript
    unifiedLogin({
      phone: "13800138000",
      password: "xxx",
      tenantCode: undefined  // æœªæŒ‡å®šç§Ÿæˆ·
    })
    ```
  - **APIç«¯ç‚¹**: ç”± `authApi.unifiedLogin()` å‘é€
  - **åŸºç¡€URL**: `client/src/utils/request.ts`
    - å¼€å‘ç¯å¢ƒ: `/api`ï¼ˆViteä»£ç†ï¼‰
    - ç”Ÿäº§ç¯å¢ƒ: ä» `env.apiBaseUrl` æˆ– `window.location.origin`

#### 3. **å‰ç«¯è¯·æ±‚é…ç½®**
- **è¯·æ±‚æ„å»ºä½ç½®**: `client/src/api/auth.ts`ï¼ˆè¡Œ 179-217ï¼‰
- **ç«¯ç‚¹**: `AUTH_ENDPOINTS.LOGIN` â†’ `/api/auth/unified-login`
- **è¯·æ±‚å¤´**:
  ```
  Content-Type: application/json
  Authorization: Bearer [token] (å¦‚æœæœ‰çš„è¯)
  ```
- **è¯·æ±‚ä½“**:
  ```json
  {
    "phone": "13800138000",
    "password": "å¯†ç ",
    "tenantCode": null  // å› ä¸ºç”¨æˆ·æ²¡æœ‰è¾“å…¥ç§Ÿæˆ·ä»£ç 
  }
```

---

### ç¬¬äºŒé˜¶æ®µï¼šç½‘ç»œä¼ è¾“

#### 4. **HTTPè¯·æ±‚åˆ°åç«¯**
- **è¯·æ±‚ç›®æ ‡**: `POST https://k001.yyup.cc/api/auth/unified-login`
- **Host å¤´**: `k001.yyup.cc`
- **è¯·æ±‚æ–¹å¼**: CORS POST
- **è¶…æ—¶**: é€šå¸¸ 10000msï¼ˆæ¥è‡ª `env.apiTimeout`ï¼‰

---

### ç¬¬ä¸‰é˜¶æ®µï¼šåç«¯å¤„ç†

#### 5. **ç§Ÿæˆ·è¯†åˆ«ä¸­é—´ä»¶ (tenantResolverMiddleware)**
- **ä½ç½®**: `server/src/middlewares/tenant-resolver.middleware.ts`ï¼ˆè¡Œ 30-119ï¼‰
- **åŠŸèƒ½**: ä» `Host` å¤´è§£æç§Ÿæˆ·ä¿¡æ¯
- **æ‰§è¡Œé€»è¾‘**:
  ```
  domain = "k001.yyup.cc"
  â”œâ”€ extractTenantCode(domain)
  â”‚  â”œâ”€ ç§»é™¤ç«¯å£å·: "k001.yyup.cc"
  â”‚  â”œâ”€ æ­£åˆ™åŒ¹é…: /^(k\d+)\.yyup\.cc$/
  â”‚  â””â”€ âœ… è¿”å›: "k001" (ç§Ÿæˆ·ä»£ç )
  â”‚
  â”œâ”€ validateTenant("k001")
  â”‚  â””â”€ âœ… éªŒè¯ç§Ÿæˆ·å­˜åœ¨ä¸”å·²æ¿€æ´»
  â”‚
  â””â”€ è®¾ç½®åˆ°è¯·æ±‚å¯¹è±¡:
     req.tenant = {
       code: "k001",
       domain: "k001.yyup.cc",
       databaseName: "tenant_k001"
     }
     req.tenantDb = è·å–å…±äº«æ•°æ®åº“è¿æ¥
  ```

#### 6. **ç§Ÿæˆ·å®‰å…¨ä¸­é—´ä»¶ (tenantSecurityMiddleware)**
- **ä½ç½®**: `server/src/middlewares/tenant-security.middleware.ts`ï¼ˆè¡Œ 27-147ï¼‰
- **éªŒè¯**:
  ```
  â”œâ”€ éªŒè¯ req.tenant ä¸ä¸ºç©º
  â”œâ”€ è·å–åŸå§‹ Host: "k001.yyup.cc"
  â”œâ”€ æ£€éªŒ isValidTenantDomain("k001.yyup.cc", "k001")
  â”‚  â””â”€ âœ… éªŒè¯é€šè¿‡ï¼ˆåŸŸåä¸ç§Ÿæˆ·ä»£ç åŒ¹é…ï¼‰
  â”‚
  â”œâ”€ å¦‚æœæœ‰ x-tenant-token å¤´ï¼Œè¿›è¡Œ MD5 ç§Ÿæˆ·ä»¤ç‰ŒéªŒè¯
  â””â”€ è®¾ç½® req.tenantSecurity
  ```

#### 7. **ç»Ÿä¸€è®¤è¯ç™»å½•ä¸­é—´ä»¶ (authenticateWithUnifiedAuth)**
- **ä½ç½®**: `server/src/middlewares/auth.middleware.ts`ï¼ˆè¡Œ 1089-1378ï¼‰
- **å…³é”®åˆ¤æ–­**:
  ```javascript
  domain = "k001.yyup.cc"
  
  // æ­¥éª¤ 1: åˆ¤æ–­æ˜¯å¦ä¸º Demo ç³»ç»Ÿ
  isDemoSystem(domain) {
    const cleanDomain = "k001.yyup.cc"
    
    // æ£€æŸ¥åˆ—è¡¨:
    if (cleanDomain === "localhost") return true      // âœ— å¦
    if (cleanDomain === "127.0.0.1") return true      // âœ— å¦
    if (cleanDomain === "k.yyup.cc") return true      // âœ— å¦ (DemoåŸŸå)
    if (cleanDomain === "k.yyup.com") return true     // âœ— å¦ (DemoåŸŸå)
    
    return false  // âœ… k001.yyup.cc ä¸æ˜¯ Demo ç³»ç»Ÿï¼
  }
  
  // ç”±äºä¸æ˜¯ Demo ç³»ç»Ÿï¼Œè¿›å…¥"ç§Ÿæˆ·ç³»ç»Ÿç»Ÿä¸€è®¤è¯"æµç¨‹
  ```

#### 8. **æ‰‹æœºå·éªŒè¯**
- **ä»£ç **: `auth.middleware.ts` è¡Œ 1117-1124
- **æ£€æŸ¥**:
  ```javascript
  if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
    // è¿”å›é”™è¯¯: "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®"
    // error: "INVALID_PHONE"
  }
  ```
- **ç»“æœ**: âœ… é€šè¿‡éªŒè¯

#### 9. **è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ**
- **ä»£ç **: `auth.middleware.ts` è¡Œ 1148-1149
- **è°ƒç”¨**: `adminIntegrationService.authenticateUser(phone, password, 'web')`
- **è¿™ä¸ªæœåŠ¡**:
  ```
  ä½ç½®: auth.middleware.ts è¡Œ 63-185
  
  authenticateUser(phone, password, source) {
    â”œâ”€ è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ API
    â”‚  â””â”€ è¯·æ±‚ç›®æ ‡: UNIFIED_TENANT_API_URL (é€šå¸¸ http://localhost:4001)
    â”‚     POST /api/auth/unified-login
    â”‚     Body: { phone, password }
    â”‚
    â”œâ”€ å¦‚æœè®¤è¯æˆåŠŸï¼Œè¿”å›:
    â”‚  {
    â”‚    success: true,
    â”‚    data: {
    â”‚      user: { id, phone, realName, ... },
    â”‚      token: "ç»Ÿä¸€è®¤è¯token"
    â”‚    }
    â”‚  }
    â”‚
    â””â”€ å¦‚æœè®¤è¯å¤±è´¥ï¼Œè¿”å›:
       {
         success: false,
         message: "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯"
       }
  }
  ```

#### 10. **ç§Ÿæˆ·æ•°æ®åº“æŸ¥è¯¢**
- **ä»£ç **: `auth.middleware.ts` è¡Œ 1168-1179
- **æµç¨‹**:
  ```sql
  -- æŸ¥è¯¢æ¡ä»¶:
  SELECT u.id, u.username, u.email, u.real_name, u.phone, u.status, 
         u.global_user_id, u.auth_source, u.role
  FROM tenant_k001.users u
  WHERE u.global_user_id = ? AND u.status = 'active'
  LIMIT 1
  
  -- å…¶ä¸­:
  -- globalUser.id æ¥è‡ªç»Ÿä¸€è®¤è¯ä¸­å¿ƒè¿”å›çš„ç”¨æˆ·ID
  -- tenant_k001 æ˜¯ç§Ÿæˆ·æ•°æ®åº“å
  ```

#### 11. **ä¸¤ç§æƒ…å†µå¤„ç†**

**æƒ…å†µ A: ç”¨æˆ·å·²ç»‘å®šç§Ÿæˆ·**ï¼ˆæ•°æ®åº“æŸ¥è¯¢æœ‰ç»“æœï¼‰
- **ä»£ç **: `auth.middleware.ts` è¡Œ 1201-1280
- **å“åº”**:
  ```json
  {
    "success": true,
    "message": "ç™»å½•æˆåŠŸ",
    "data": {
      "token": "æ–°çš„JWT token",
      "user": {
        "id": 123,
        "username": "ç”¨æˆ·å",
        "email": "email@example.com",
        "realName": "çœŸå®å§“å",
        "phone": "13800138000",
        "role": "teacher",  // æˆ– principal/parent/admin
        "status": "active"
      },
      "tenantInfo": {
        "tenantCode": "k001",
        "tenantName": "æŸæŸå¹¼å„¿å›­"
      },
      "isDemo": false,
      "isUnifiedAuth": true
    }
  }
  ```

**æƒ…å†µ B: ç”¨æˆ·æœªç»‘å®šç§Ÿæˆ·ï¼ˆneedsRegistrationï¼‰**
- **ä»£ç **: `auth.middleware.ts` è¡Œ 1181-1200
- **è§¦å‘**: ç”¨æˆ·åœ¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæœ‰è´¦å·ï¼Œä½†æœªåœ¨æ­¤ç§Ÿæˆ·æ³¨å†Œ
- **å“åº”**:
  ```json
  {
    "success": true,
    "message": "æ‚¨å°šæœªåœ¨æœ¬å›­æ‰€æ³¨å†Œï¼Œè¯·é€‰æ‹©è§’è‰²å®Œæˆæ³¨å†Œ",
    "data": {
      "needsRegistration": true,
      "globalUserId": "user-id-from-unified",
      "phone": "13800138000",
      "realName": "çœŸå®å§“å",
      "tenantCode": "k001",
      "tenantName": "å›­æ‰€k001",
      "availableRoles": ["principal", "teacher", "parent"],
      "token": "ä¸´æ—¶tokenç”¨äºåç»­ç»‘å®š"
    }
  }
  ```

---

### ç¬¬å››é˜¶æ®µï¼šå‰ç«¯å“åº”å¤„ç†

#### 12. **ç™»å½•å“åº”å¤„ç†**
- **ä½ç½®**: `client/src/pages/Login/index.vue`ï¼ˆè¡Œ 674-684ï¼‰
- **å¤„ç†æµç¨‹**:
  ```
  try {
    response = await authStore.flexibleLogin(...)
    
    if (response.success && response.data) {
      await processUnifiedLoginSuccess(response)  // æ­£å¸¸ç™»å½•
      // æˆ–è€…å¦‚æœ needsRegistration:
      // æ˜¾ç¤ºè§’è‰²é€‰æ‹©å¯¹è¯æ¡†
    }
  } catch (error) {
    handleLoginError(error)
  }
  ```

#### 13a. **æ­£å¸¸ç™»å½•æˆåŠŸå¤„ç†**
- **ä½ç½®**: `client/src/pages/Login/index.vue`ï¼ˆè¡Œ 775-917ï¼‰
- **å¤„ç†**:
  ```javascript
  processUnifiedLoginSuccess(response) {
    â”œâ”€ ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° authStore
    â”‚  â”œâ”€ token: response.data.token
    â”‚  â”œâ”€ user: response.data.user
    â”‚  â”œâ”€ isAuthenticated: true
    â”‚  â””â”€ isUnifiedAuth: true
    â”‚
    â”œâ”€ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:
    â”‚  â”œâ”€ localStorage.setItem('kindergarten_token', token)
    â”‚  â”œâ”€ localStorage.setItem('unified_auth_mode', 'true')
    â”‚  â”œâ”€ localStorage.setItem('global_user_id', globalUserId)
    â”‚  â””â”€ localStorage.setItem('current_tenant', tenantInfo)
    â”‚
    â”œâ”€ è·å–é‡å®šå‘URL (getLoginRedirectPath)
    â”‚  â”œâ”€ å¦‚æœ role = 'teacher'   â†’ '/teacher-center/dashboard'
    â”‚  â”œâ”€ å¦‚æœ role = 'parent'    â†’ '/parent-center/dashboard'
    â”‚  â””â”€ å¦‚æœ role = 'admin'/'principal' â†’ '/'
    â”‚
    â”œâ”€ æ˜¾ç¤ºç³»ç»Ÿå…¥åœºåŠ¨ç”»
    â”‚  â”œâ”€ showEntranceAnimation = true
    â”‚  â”œâ”€ ç­‰å¾… 100ms
    â”‚  â””â”€ éšè—åŠ¨ç”»
    â”‚
    â””â”€ æ‰§è¡Œè·¯ç”±è·³è½¬
       router.replace(redirectUrl)
  ```

#### 13b. **éœ€è¦æ³¨å†Œçš„å¤„ç†**
- **ä½ç½®**: `client/src/pages/Login/index.vue` ä¸­çš„çŠ¶æ€ç®¡ç†
- **å¤„ç†**:
  ```
  if (response.data.needsRegistration) {
    â”œâ”€ æ˜¾ç¤ºè§’è‰²é€‰æ‹©å¯¹è¯æ¡†
    â”œâ”€ ç”¨æˆ·é€‰æ‹©è§’è‰²ï¼ˆprincipal/teacher/parentï¼‰
    â”‚
    â”œâ”€ è°ƒç”¨è§’è‰²ç»‘å®š API
    â”‚  â””â”€ POST /api/auth/bind-tenant
    â”‚     Body: {
    â”‚       globalUserId,
    â”‚       tenantCode,
    â”‚       role: selectedRole,
    â”‚       ...å…¶ä»–ä¿¡æ¯
    â”‚     }
    â”‚
    â”œâ”€ ç»‘å®šæˆåŠŸåï¼Œé‡æ–°å¤„ç†ç™»å½•å“åº”
    â””â”€ è·³è½¬åˆ°ç›¸åº”çš„ä»ªè¡¨æ¿
  ```

#### 14. **é¡µé¢å±•ç¤º**
- **æœ€ç»ˆè·³è½¬**:
  ```
  å¦‚æœæ˜¯æ•™å¸ˆ: /teacher-center/dashboard
    â”œâ”€ æ˜¾ç¤ºæ•™å¸ˆä¸“ç”¨èœå•
    â”œâ”€ æ˜¾ç¤ºç­çº§ä¿¡æ¯
    â””â”€ æ˜¾ç¤ºæ•™å­¦å·¥å…·
  
  å¦‚æœæ˜¯å®¶é•¿: /parent-center/dashboard
    â”œâ”€ æ˜¾ç¤ºå­©å­ä¿¡æ¯
    â”œâ”€ æ˜¾ç¤ºæˆé•¿æŠ¥å‘Š
    â””â”€ æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥
  
  å¦‚æœæ˜¯å›­é•¿/ç®¡ç†å‘˜: /
    â”œâ”€ æ˜¾ç¤ºç®¡ç†åå°
    â”œâ”€ æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
    â””â”€ æ˜¾ç¤ºç³»ç»Ÿç®¡ç†å·¥å…·
  ```

---

## ğŸ”‘ å…³é”®å†³ç­–ç‚¹

### å†³ç­– 1ï¼šæ˜¯å¦ä¸º Demo ç³»ç»Ÿ
```
isDemoSystem("k001.yyup.cc")
â”‚
â”œâ”€ ç»“æœ: false (âœ— ä¸æ˜¯ Demo ç³»ç»Ÿ)
â”‚
â””â”€ è·¯ç”±åˆ°: ç»Ÿä¸€è®¤è¯è·¯å¾„
   â””â”€ è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ API
```

### å†³ç­– 2ï¼šç”¨æˆ·ç»‘å®šçŠ¶æ€
```
æ˜¯å¦å­˜åœ¨äº tenant_k001.users ä¸­?
â”‚
â”œâ”€ YES: æ­£å¸¸ç™»å½• â†’ è¿”å› token + user ä¿¡æ¯
â”‚
â””â”€ NO: needsRegistration â†’ å¼•å¯¼ç”¨æˆ·é€‰æ‹©è§’è‰²
   â””â”€ ç»‘å®šåé‡æ–°ç™»å½•
```

### å†³ç­– 3ï¼šç”¨æˆ·è§’è‰²
```
è·å– user.role
â”‚
â”œâ”€ teacher    â†’ /teacher-center/dashboard
â”œâ”€ parent     â†’ /parent-center/dashboard
â””â”€ admin/principal â†’ /
```

---

## ğŸ” å®‰å…¨æ£€æŸ¥ç‚¹

| æ£€æŸ¥ç‚¹ | ä½ç½® | éªŒè¯é¡¹ | å¤±è´¥å“åº” |
|------|------|--------|--------|
| **1. åŸŸåè¯†åˆ«** | tenantResolverMiddleware | ç§Ÿæˆ·ä»£ç æå– | æ— æ³•è¯†åˆ«ç§Ÿæˆ· |
| **2. ç§Ÿæˆ·éªŒè¯** | tenantResolverMiddleware | ç§Ÿæˆ·æ˜¯å¦å­˜åœ¨ | ç§Ÿæˆ·ä¸å­˜åœ¨æˆ–æœªæ¿€æ´» |
| **3. åŸŸåå®‰å…¨** | tenantSecurityMiddleware | åŸŸåä¸ç§Ÿæˆ·ä»£ç åŒ¹é… | åŸŸåç§Ÿæˆ·ä»£ç ä¸åŒ¹é… |
| **4. æ‰‹æœºå·éªŒè¯** | authenticateWithUnifiedAuth | æ ¼å¼æ£€æŸ¥ `^1[3-9]\d{9}$` | æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡® |
| **5. ç»Ÿä¸€è®¤è¯** | adminIntegrationService | ä¸­å¿ƒè®¤è¯ | æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯ |
| **6. Token éªŒè¯** | verifyToken middleware | JWT æœ‰æ•ˆæ€§ | è®¤è¯ä»¤ç‰Œæ— æ•ˆ |
| **7. ç”¨æˆ·çŠ¶æ€** | æ•°æ®åº“æŸ¥è¯¢ | status = 'active' | ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨ |

---

## ğŸ“Š æ•°æ®æµæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµè§ˆå™¨ (k001.yyup.cc)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·è¾“å…¥ â†’ handleLogin() â†’ flexibleLogin(phone, pwd)       â”‚
â”‚                                    â†“                         â”‚
â”‚           POST /api/auth/unified-login                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP è¯·æ±‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç«¯ API Server (k001.yyup.cc)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ç§Ÿæˆ·è¯†åˆ«: k001.yyup.cc â†’ tenant_k001                    â”‚
â”‚ 2. ç§Ÿæˆ·å®‰å…¨æ£€æŸ¥                                            â”‚
â”‚ 3. è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯æ‰‹æœºå·+å¯†ç                          â”‚
â”‚ 4. åœ¨ tenant_k001.users æŸ¥è¯¢ç”¨æˆ·                           â”‚
â”‚ 5. ç”Ÿæˆç™»å½•å“åº” (token + user + tenantInfo)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ JSON å“åº”
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯å“åº”å¤„ç† & é¡µé¢é‡å®šå‘                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä¿å­˜ token åˆ° localStorage                              â”‚
â”‚ 2. æ›´æ–° authStore çŠ¶æ€                                     â”‚
â”‚ 3. æ ¹æ®ç”¨æˆ·è§’è‰²ç¡®å®šé‡å®šå‘ URL                              â”‚
â”‚ 4. æ˜¾ç¤ºå…¥åœºåŠ¨ç”»                                           â”‚
â”‚ 5. router.replace(redirectUrl)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ è·¯ç”±åˆ‡æ¢
                           â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ä»ªè¡¨æ¿é¡µé¢ (Dashboard)          â”‚
            â”‚   - æ ¹æ®è§’è‰²å±•ç¤ºä¸åŒå†…å®¹         â”‚
            â”‚   - åŠ è½½ç”¨æˆ·æƒé™å’Œèœå•           â”‚
            â”‚   - æ˜¾ç¤ºä¸šåŠ¡æ•°æ®                 â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é”™è¯¯åœºæ™¯å¤„ç†

### åœºæ™¯ 1: æ‰‹æœºå·æ ¼å¼é”™è¯¯
```
âŒ è¾“å…¥: "18800138000" (ä»¥ 1 å¼€å¤´ä½†ä¸ºéæ³•æ ¼å¼)
   â†“
âŒ æ­£åˆ™éªŒè¯å¤±è´¥: !/^1[3-9]\d{9}$/.test(phone)
   â†“
âŒ è¿”å›: { success: false, message: "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®" }
```

### åœºæ™¯ 2: ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè¿”å› false
```
âœ“ æ‰‹æœºå·æ ¼å¼æ­£ç¡®
   â†“
âŒ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯å¤±è´¥
   â†“
âŒ è¿”å›: { success: false, message: "æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯" }
```

### åœºæ™¯ 3: ç”¨æˆ·åœ¨ç»Ÿä¸€è®¤è¯ä½†æœªç»‘å®šç§Ÿæˆ·
```
âœ“ ç»Ÿä¸€è®¤è¯æˆåŠŸï¼Œè·å¾— globalUserId
   â†“
âŒ tenant_k001.users æŸ¥è¯¢æ— ç»“æœ
   â†“
âœ“ è¿”å›: { needsRegistration: true, availableRoles: [...] }
   â†“
å‰ç«¯æ˜¾ç¤ºè§’è‰²é€‰æ‹©å¯¹è¯æ¡†ï¼Œç”¨æˆ·é€‰æ‹©è§’è‰²åç»‘å®šç§Ÿæˆ·
```

### åœºæ™¯ 4: Token å¤±æ•ˆæˆ–è¢«ç¯¡æ”¹
```
âŒ åœ¨éªŒè¯ token æ—¶è§£æå¤±è´¥
   â†“
âŒ è¿”å›: { success: false, message: "è®¤è¯ä»¤ç‰Œæ— æ•ˆ" }
   â†“
å‰ç«¯æ¸…é™¤æœ¬åœ° tokenï¼Œè·³è½¬å›ç™»å½•é¡µ
```

---

## ğŸš€ ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ æ—¥å¿—
```
å»ºè®®æ·»åŠ ï¼š
- ç§Ÿæˆ·è¯†åˆ«æ—¥å¿—ï¼ˆdomain â†’ tenantCodeï¼‰
- ç»Ÿä¸€è®¤è¯è°ƒç”¨æ—¥å¿—ï¼ˆæ‰‹æœºå·æ©ç  + å“åº”çŠ¶æ€ï¼‰
- æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—ï¼ˆglobalUserId æŸ¥è¯¢ç»“æœï¼‰
- è·¯ç”±è·³è½¬æ—¥å¿—ï¼ˆç”¨æˆ·è§’è‰² + ç›®æ ‡ URLï¼‰
```

### 2. ç¼“å­˜ä¼˜åŒ–
```
- ç¼“å­˜ç§Ÿæˆ·é…ç½®ä¿¡æ¯ï¼ˆ30minï¼‰
- ç¼“å­˜ç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼ˆ1hï¼‰
- ç¼“å­˜æƒé™åˆ—è¡¨ï¼ˆ1hï¼‰
```

### 3. æ€§èƒ½ç›‘æ§
```
- è®°å½•ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå“åº”æ—¶é—´
- è®°å½•æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- è®°å½•å‰ç«¯è·¯ç”±åˆ‡æ¢æ—¶é—´
```

---

## ğŸ¯ æ€»ç»“

å½“ç”¨æˆ·åœ¨ `k001.yyup.cc` è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ç‚¹å‡»ç™»å½•æ—¶ï¼š

1. **å‰ç«¯** æå–æ‰‹æœºå·ã€å¯†ç ï¼Œè°ƒç”¨ `flexibleLogin()`
2. **ç½‘ç»œ** å‘é€ POST è¯·æ±‚åˆ° `/api/auth/unified-login`
3. **åç«¯ä¸­é—´ä»¶é“¾**:
   - è¯†åˆ«ç§Ÿæˆ·ä»£ç : `k001.yyup.cc` â†’ `k001` â†’ `tenant_k001`
   - éªŒè¯ç§Ÿæˆ·å®‰å…¨
4. **è®¤è¯ä¸­å¿ƒ** éªŒè¯æ‰‹æœºå·+å¯†ç ï¼Œè¿”å› globalUserId
5. **ç§Ÿæˆ·æ•°æ®åº“** æŸ¥è¯¢ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»‘å®š
6. **æ¡ä»¶åˆ†æ”¯**:
   - å·²ç»‘å®š â†’ è¿”å› token + userï¼Œå‰ç«¯è·³è½¬åˆ°ä»ªè¡¨æ¿
   - æœªç»‘å®š â†’ è¿”å› needsRegistrationï¼Œå‰ç«¯æ˜¾ç¤ºè§’è‰²é€‰æ‹©
7. **å‰ç«¯** ä¿å­˜ tokenï¼Œæ›´æ–°çŠ¶æ€ï¼Œæ‰§è¡Œè·¯ç”±è·³è½¬
8. **å±•ç¤º** æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºç›¸åº”é¡µé¢

è¿™æ˜¯ä¸€ä¸ª**ç§Ÿæˆ·éš”ç¦» + ç»Ÿä¸€è®¤è¯ + åŠ¨æ€è·¯ç”±**çš„å®Œæ•´é“¾è·¯ã€‚

