# ğŸ“Š é›†å›¢ä¸åˆ†å›­æ•°æ®éš”ç¦»åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2025-10-28  
**åˆ†æèŒƒå›´**: æ•°æ®åº“ç»“æ„ã€API éš”ç¦»ã€ä¸šåŠ¡æ•°æ®éš”ç¦»  
**éš”ç¦»çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†å®ç°ï¼Œéœ€è¦å®Œå–„**

---

## ğŸ” å½“å‰éš”ç¦»æœºåˆ¶

### 1ï¸âƒ£ æ•°æ®åº“å±‚é¢éš”ç¦» âœ…

**è¡¨ç»“æ„å…³ç³»**ï¼š
```
groups (é›†å›¢è¡¨)
  â”œâ”€â”€ id (ä¸»é”®)
  â”œâ”€â”€ name (é›†å›¢åç§°)
  â””â”€â”€ ...

kindergartens (å¹¼å„¿å›­è¡¨)
  â”œâ”€â”€ id (ä¸»é”®)
  â”œâ”€â”€ group_id (å¤–é”® â†’ groups.id) âœ… éš”ç¦»å­—æ®µ
  â”œâ”€â”€ name (å›­æ‰€åç§°)
  â””â”€â”€ ...

classes (ç­çº§è¡¨)
  â”œâ”€â”€ id (ä¸»é”®)
  â”œâ”€â”€ kindergarten_id (å¤–é”® â†’ kindergartens.id) âœ… éš”ç¦»å­—æ®µ
  â””â”€â”€ ...

students (å­¦ç”Ÿè¡¨)
  â”œâ”€â”€ id (ä¸»é”®)
  â”œâ”€â”€ class_id (å¤–é”® â†’ classes.id) âœ… éš”ç¦»å­—æ®µ
  â””â”€â”€ ...
```

**éš”ç¦»é“¾**ï¼š
```
é›†å›¢ (group_id)
  â†“ (1å¯¹å¤š)
å¹¼å„¿å›­ (kindergarten_id)
  â†“ (1å¯¹å¤š)
ç­çº§ (class_id)
  â†“ (1å¯¹å¤š)
å­¦ç”Ÿ (student_id)
```

### 2ï¸âƒ£ å‰ç«¯ API è°ƒç”¨ âœ…

**å‰ç«¯å·²æ­£ç¡®ä¼ é€’å‚æ•°**ï¼š
```typescript
// client/src/pages/group/group-list.vue
const result = await kindergartenApi.getKindergartenList({
  page: pagination.page,
  pageSize: pagination.pageSize,
  keyword: searchForm.keyword || undefined,
  type: searchForm.type,
  status: searchForm.status,
  groupId: 1, // âœ… å·²ä¼ é€’é›†å›¢ID
});
```

### 3ï¸âƒ£ åç«¯ API éš”ç¦» âŒ **å­˜åœ¨é—®é¢˜**

**å½“å‰é—®é¢˜**ï¼š
```typescript
// server/src/controllers/kindergarten.controller.ts
public static async list(req: RequestWithUser, res: Response) {
  const { page = 1, pageSize = 10, keyword } = req.query;
  
  let whereClause = '';
  if (keyword) {
    whereClause = `WHERE name LIKE :keyword OR code LIKE :keyword`;
  }
  
  // âŒ é—®é¢˜ï¼šæ²¡æœ‰è¿‡æ»¤ group_id
  const rows = await sequelize.query(
    `SELECT * FROM kindergartens 
     ${whereClause} 
     ORDER BY created_at DESC 
     LIMIT :limit OFFSET :offset`,
    { replacements: { ...replacements, limit, offset } }
  );
}
```

**é—®é¢˜åˆ†æ**ï¼š
- âŒ æ²¡æœ‰æ¥æ”¶ `groupId` å‚æ•°
- âŒ æ²¡æœ‰åœ¨ WHERE å­å¥ä¸­æ·»åŠ  `group_id` è¿‡æ»¤
- âŒ è¿”å›æ‰€æœ‰å¹¼å„¿å›­ï¼Œè€Œä¸æ˜¯ç‰¹å®šé›†å›¢çš„å¹¼å„¿å›­
- âŒ è¿™æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„æ•°æ®éš”ç¦»æ¼æ´**

---

## ğŸš¨ éš”ç¦»é—®é¢˜æ¸…å•

### é—®é¢˜1ï¼šå¹¼å„¿å›­åˆ—è¡¨ API æ²¡æœ‰éš”ç¦» âŒ

**å½“å‰è¡Œä¸º**ï¼š
- è¿”å›æ•°æ®åº“ä¸­æ‰€æœ‰å¹¼å„¿å›­
- å¿½ç•¥ `groupId` å‚æ•°

**åº”è¯¥è¡Œä¸º**ï¼š
- åªè¿”å›æŒ‡å®šé›†å›¢ä¸‹çš„å¹¼å„¿å›­
- æ ¹æ® `groupId` è¿‡æ»¤æ•°æ®

### é—®é¢˜2ï¼šå…¶ä»–ä¸šåŠ¡æ•°æ®å¯èƒ½ä¹Ÿæ²¡æœ‰éš”ç¦» âŒ

**éœ€è¦æ£€æŸ¥çš„ API**ï¼š
- [ ] ç­çº§åˆ—è¡¨ API - æ˜¯å¦è¿‡æ»¤äº† kindergarten_id
- [ ] å­¦ç”Ÿåˆ—è¡¨ API - æ˜¯å¦è¿‡æ»¤äº† class_id
- [ ] æ•™å¸ˆåˆ—è¡¨ API - æ˜¯å¦è¿‡æ»¤äº† kindergarten_id
- [ ] æ´»åŠ¨åˆ—è¡¨ API - æ˜¯å¦è¿‡æ»¤äº† kindergarten_id
- [ ] å…¶ä»–ä¸šåŠ¡ API - æ˜¯å¦éƒ½æœ‰éš”ç¦»

### é—®é¢˜3ï¼šæƒé™éš”ç¦» âŒ

**å½“å‰çŠ¶æ€**ï¼š
- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥é›†å›¢
- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥å¹¼å„¿å›­
- ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ä»»ä½•æ•°æ®

---

## âœ… å®Œæ•´çš„éš”ç¦»æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šAPI å±‚éš”ç¦»

**ä¿®æ”¹ kindergarten.controller.ts**ï¼š
```typescript
public static async list(req: RequestWithUser, res: Response) {
  const { page = 1, pageSize = 10, keyword, groupId } = req.query;
  
  let whereClause = 'WHERE 1=1';
  const replacements: any = {};
  
  // âœ… æ·»åŠ  group_id è¿‡æ»¤
  if (groupId) {
    whereClause += ' AND group_id = :groupId';
    replacements.groupId = Number(groupId);
  }
  
  // æ·»åŠ å…³é”®è¯è¿‡æ»¤
  if (keyword) {
    whereClause += ' AND (name LIKE :keyword OR code LIKE :keyword)';
    replacements.keyword = `%${String(keyword)}%`;
  }
  
  const rows = await sequelize.query(
    `SELECT * FROM kindergartens 
     ${whereClause} 
     ORDER BY created_at DESC 
     LIMIT :limit OFFSET :offset`,
    { replacements: { ...replacements, limit, offset } }
  );
}
```

### æ–¹æ¡ˆ2ï¼šæƒé™å±‚éš”ç¦»

**æ·»åŠ æƒé™æ£€æŸ¥ä¸­é—´ä»¶**ï¼š
```typescript
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥é›†å›¢
export const requireGroupAccess = (req: RequestWithUser, res: Response, next: NextFunction) => {
  const groupId = req.query.groupId || req.params.groupId;
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯è¯¥é›†å›¢çš„ç®¡ç†å‘˜
  // æˆ–è€…æ˜¯ç³»ç»Ÿç®¡ç†å‘˜
  if (req.user.isAdmin) {
    return next();
  }
  
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºè¯¥é›†å›¢
  // ...
};
```

### æ–¹æ¡ˆ3ï¼šä¸šåŠ¡æ•°æ®éš”ç¦»

**å¯¹äºç­çº§ã€å­¦ç”Ÿç­‰ä¸šåŠ¡æ•°æ®**ï¼š
```typescript
// æŸ¥è¯¢ç­çº§æ—¶ï¼Œéœ€è¦ç¡®ä¿ç­çº§å±äºæŒ‡å®šçš„å¹¼å„¿å›­
SELECT c.* FROM classes c
INNER JOIN kindergartens k ON c.kindergarten_id = k.id
WHERE k.group_id = :groupId AND c.kindergarten_id = :kindergartenId

// æŸ¥è¯¢å­¦ç”Ÿæ—¶ï¼Œéœ€è¦ç¡®ä¿å­¦ç”Ÿå±äºæŒ‡å®šçš„ç­çº§
SELECT s.* FROM students s
INNER JOIN classes c ON s.class_id = c.id
INNER JOIN kindergartens k ON c.kindergarten_id = k.id
WHERE k.group_id = :groupId AND c.kindergarten_id = :kindergartenId
```

---

## ğŸ“‹ ä¿®å¤æ¸…å•

### ç«‹å³éœ€è¦ä¿®å¤ (ä¼˜å…ˆçº§ï¼šğŸ”´ é«˜)

- [ ] ä¿®æ”¹ kindergarten.controller.ts çš„ list() æ–¹æ³•ï¼Œæ·»åŠ  groupId è¿‡æ»¤
- [ ] ä¿®æ”¹ kindergarten.controller.ts çš„ detail() æ–¹æ³•ï¼ŒéªŒè¯ groupId
- [ ] ä¿®æ”¹ kindergarten.controller.ts çš„ create() æ–¹æ³•ï¼Œè®¾ç½® groupId
- [ ] ä¿®æ”¹ kindergarten.controller.ts çš„ update() æ–¹æ³•ï¼ŒéªŒè¯ groupId
- [ ] ä¿®æ”¹ kindergarten.controller.ts çš„ delete() æ–¹æ³•ï¼ŒéªŒè¯ groupId

### éœ€è¦æ£€æŸ¥çš„ API (ä¼˜å…ˆçº§ï¼šğŸŸ¡ ä¸­)

- [ ] class.controller.ts - ç­çº§åˆ—è¡¨æ˜¯å¦éš”ç¦»
- [ ] student.controller.ts - å­¦ç”Ÿåˆ—è¡¨æ˜¯å¦éš”ç¦»
- [ ] teacher.controller.ts - æ•™å¸ˆåˆ—è¡¨æ˜¯å¦éš”ç¦»
- [ ] activity.controller.ts - æ´»åŠ¨åˆ—è¡¨æ˜¯å¦éš”ç¦»
- [ ] å…¶ä»–ä¸šåŠ¡ controller - æ˜¯å¦éƒ½æœ‰éš”ç¦»

### éœ€è¦æ·»åŠ çš„åŠŸèƒ½ (ä¼˜å…ˆçº§ï¼šğŸŸ¢ ä½)

- [ ] æ·»åŠ æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- [ ] æ·»åŠ é›†å›¢è®¿é—®æƒé™éªŒè¯
- [ ] æ·»åŠ å®¡è®¡æ—¥å¿—è®°å½•
- [ ] æ·»åŠ æ•°æ®éš”ç¦»æµ‹è¯•ç”¨ä¾‹

---

## ğŸ¯ å»ºè®®

### çŸ­æœŸ (1-2å¤©)
1. ä¿®å¤ kindergarten.controller.ts çš„æ•°æ®éš”ç¦»é—®é¢˜
2. æµ‹è¯•å¹¼å„¿å›­åˆ—è¡¨ API æ˜¯å¦æ­£ç¡®éš”ç¦»
3. æ£€æŸ¥å…¶ä»–å…³é”® API çš„éš”ç¦»æƒ…å†µ

### ä¸­æœŸ (3-5å¤©)
1. ä¸ºæ‰€æœ‰ API æ·»åŠ  groupId è¿‡æ»¤
2. æ·»åŠ æƒé™æ£€æŸ¥ä¸­é—´ä»¶
3. ç¼–å†™éš”ç¦»æµ‹è¯•ç”¨ä¾‹

### é•¿æœŸ (1-2å‘¨)
1. å®ç°å®Œæ•´çš„æƒé™ç³»ç»Ÿ
2. æ·»åŠ å®¡è®¡æ—¥å¿—
3. æ€§èƒ½ä¼˜åŒ–ï¼ˆæ·»åŠ ç´¢å¼•ç­‰ï¼‰

---

**è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç«‹å³ä¿®å¤ï¼** ğŸš¨


