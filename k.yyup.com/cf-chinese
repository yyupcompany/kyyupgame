#!/bin/bash

# Claude Flow ä¸­æ–‡æ±‰åŒ–ç‰ˆå…¨å±€è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: cf [å‘½ä»¤] [å‚æ•°...]

# æ£€æµ‹å‡½æ•°æ¥æŸ¥æ‰¾claude-flow
find_claude_flow() {
    # å°è¯•å…¨å±€npmå®‰è£…
    if command -v claude-flow >/dev/null 2>&1; then
        echo "claude-flow"
        return 0
    fi
    
    # å°è¯•npx (æ¨èè·å–æœ€æ–°ç‰ˆæœ¬)
    if command -v npx >/dev/null 2>&1; then
        echo "npx claude-flow"
        return 0
    fi
    
    # å°è¯•æœ¬åœ°å¼€å‘ç‰ˆæœ¬(å¦‚æœå¯ç”¨)
    local dev_path="/home/devbox/project/v2ray-install/claude-code-flow"
    if [ -d "$dev_path" ] && [ -f "$dev_path/cli.js" ]; then
        echo "cd '$dev_path' && node cli.js"
        return 0
    fi
    
    echo "é”™è¯¯: æ‰¾ä¸åˆ°Claude Flowã€‚è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…: npm install -g claude-flow"
    exit 1
}

# è·å–è¿è¡Œclaude-flowçš„å‘½ä»¤
CLAUDE_FLOW_CMD=$(find_claude_flow)

# ä¸­æ–‡ç¿»è¯‘å‡½æ•°
translate_output() {
    sed -e 's/Claude-Flow System Status:/Claude-Flow ç³»ç»ŸçŠ¶æ€:/g' \
        -e 's/Status: Partially Running/çŠ¶æ€: éƒ¨åˆ†è¿è¡Œ/g' \
        -e 's/Status: Running/çŠ¶æ€: è¿è¡Œä¸­/g' \
        -e 's/Status: Stopped/çŠ¶æ€: å·²åœæ­¢/g' \
        -e 's/Agents: \([0-9]*\) active/ä»£ç†: \1 ä¸ªæ´»è·ƒ/g' \
        -e 's/Tasks: \([0-9]*\) in queue/ä»»åŠ¡: \1 ä¸ªæ’é˜Ÿä¸­/g' \
        -e 's/Memory: \([0-9]*\) entries/å†…å­˜: \1 ä¸ªæ¡ç›®/g' \
        -e 's/Terminal Pool: Stopped/ç»ˆç«¯æ± : å·²åœæ­¢/g' \
        -e 's/Terminal Pool: Running/ç»ˆç«¯æ± : è¿è¡Œä¸­/g' \
        -e 's/MCP Server: Stopped/MCPæœåŠ¡å™¨: å·²åœæ­¢/g' \
        -e 's/MCP Server: Running/MCPæœåŠ¡å™¨: è¿è¡Œä¸­/g' \
        -e 's/Launching SPARC orchestrator mode.../å¯åŠ¨SPARCç¼–æ’å™¨æ¨¡å¼.../g' \
        -e 's/Task:/ä»»åŠ¡:/g' \
        -e 's/Mode:/æ¨¡å¼:/g' \
        -e 's/Timeout: \([0-9]*\) minutes/è¶…æ—¶æ—¶é—´: \1 åˆ†é’Ÿ/g' \
        -e 's/Starting Claude Code.../æ­£åœ¨å¯åŠ¨Claude Code.../g' \
        -e 's/No entries found/æœªæ‰¾åˆ°ä»»ä½•æ¡ç›®/g' \
        -e 's/Initializing Advanced Memory Manager/æ­£åœ¨åˆå§‹åŒ–é«˜çº§å†…å­˜ç®¡ç†å™¨/g' \
        -e 's/Memory Manager initialized successfully/å†…å­˜ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ/g' \
        -e 's/Shutting down Advanced Memory Manager/æ­£åœ¨å…³é—­é«˜çº§å†…å­˜ç®¡ç†å™¨/g' \
        -e 's/SPARC Development Modes - Complete Collection/SPARCå¼€å‘æ¨¡å¼ - å®Œæ•´é›†åˆ/g' \
        -e 's/Core Orchestration/æ ¸å¿ƒç¼–æ’/g' \
        -e 's/Development Modes/å¼€å‘æ¨¡å¼/g' \
        -e 's/Analysis & Research/åˆ†æä¸ç ”ç©¶/g' \
        -e 's/Creative & Support/åˆ›æ„ä¸æ”¯æŒ/g' \
        -e 's/Testing & Quality/æµ‹è¯•ä¸è´¨é‡/g' \
        -e 's/Usage Examples:/ä½¿ç”¨ç¤ºä¾‹:/g' \
        -e 's/Advanced Features:/é«˜çº§åŠŸèƒ½:/g' \
        -e 's/Detailed Information:/è¯¦ç»†ä¿¡æ¯:/g' \
        -e 's/orchestrator - Multi-agent task orchestration/ç¼–æ’å™¨ - å¤šä»£ç†ä»»åŠ¡ç¼–æ’/g' \
        -e 's/coder - Autonomous code generation/ç¼–ç å™¨ - è‡ªä¸»ä»£ç ç”Ÿæˆ/g' \
        -e 's/researcher - Deep research with parallel/ç ”ç©¶å‘˜ - å¹¶è¡Œæ·±åº¦ç ”ç©¶/g' \
        -e 's/architect - System design with Memory/æ¶æ„å¸ˆ - åŸºäºå†…å­˜çš„ç³»ç»Ÿè®¾è®¡/g' \
        -e 's/reviewer - Code review using batch/å®¡æŸ¥å‘˜ - æ‰¹é‡ä»£ç å®¡æŸ¥/g' \
        -e 's/tdd - Test-driven development/TDD - æµ‹è¯•é©±åŠ¨å¼€å‘/g' \
        -e 's/analyzer - Code and data analysis/åˆ†æå¸ˆ - ä»£ç å’Œæ•°æ®åˆ†æ/g' \
        -e 's/optimizer - Performance optimization/ä¼˜åŒ–å™¨ - æ€§èƒ½ä¼˜åŒ–/g' \
        -e 's/designer - UI\/UX design/è®¾è®¡å¸ˆ - UI\/UXè®¾è®¡/g' \
        -e 's/innovator - Creative problem solving/åˆ›æ–°è€… - åˆ›æ„é—®é¢˜è§£å†³/g' \
        -e 's/documenter - Documentation with batch/æ–‡æ¡£å‘˜ - æ‰¹é‡æ–‡æ¡£ç¼–å†™/g' \
        -e 's/debugger - Systematic debugging/è°ƒè¯•å™¨ - ç³»ç»ŸåŒ–è°ƒè¯•/g' \
        -e 's/tester - Comprehensive testing/æµ‹è¯•å‘˜ - ç»¼åˆæµ‹è¯•/g' \
        -e 's/memory-manager - Knowledge management/å†…å­˜ç®¡ç†å™¨ - çŸ¥è¯†ç®¡ç†/g' \
        -e 's/swarm-coordinator - Advanced swarm management/ç¾¤ä½“åè°ƒå™¨ - é«˜çº§ç¾¤ä½“ç®¡ç†/g' \
        -e 's/workflow-manager - Process automation/å·¥ä½œæµç®¡ç†å™¨ - æµç¨‹è‡ªåŠ¨åŒ–/g' \
        -e 's/batch-executor - Parallel task execution/æ‰¹å¤„ç†æ‰§è¡Œå™¨ - å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ/g' \
        -e 's/Enable parallel agent execution/å¯ç”¨å¹¶è¡Œä»£ç†æ‰§è¡Œ/g' \
        -e 's/Use batch operations for file handling/ä½¿ç”¨æ‰¹é‡æ“ä½œå¤„ç†æ–‡ä»¶/g' \
        -e 's/Store results in specific memory key/å°†ç»“æœå­˜å‚¨åˆ°æŒ‡å®šå†…å­˜é”®/g' \
        -e 's/Enable real-time monitoring/å¯ç”¨å®æ—¶ç›‘æ§/g' \
        -e 's/Set execution timeout/è®¾ç½®æ‰§è¡Œè¶…æ—¶æ—¶é—´/g' \
        -e 's/Show full descriptions/æ˜¾ç¤ºå®Œæ•´æè¿°/g' \
        -e 's/View mode documentation/æŸ¥çœ‹æ¨¡å¼æ–‡æ¡£/g'
}

# è‡ªåŠ¨å¢å¼ºå‘½ä»¤çš„å‡½æ•°ï¼Œå¢åŠ ä¸­æ–‡è¾“å‡º
enhance_command() {
    local args=("$@")
    
    # å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºå¸®åŠ©
    if [ ${#args[@]} -eq 0 ]; then
        echo "ğŸ‡¨ğŸ‡³ Claude Flow ä¸­æ–‡æ±‰åŒ–ç‰ˆ - é«˜çº§AIä»£ç†ç¼–æ’ç³»ç»Ÿ"
        echo ""
        echo "ğŸ“‹ å¸¸ç”¨å‘½ä»¤:"
        echo "  cf çŠ¶æ€                    # æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€"
        echo "  cf sparc æ¨¡å¼              # åˆ—å‡ºæ‰€æœ‰SPARCå¼€å‘æ¨¡å¼"
        echo "  cf å†…å­˜ åˆ—è¡¨               # æŸ¥çœ‹å†…å­˜ä¸­çš„æ•°æ®"
        echo "  cf \"æ£€æŸ¥æˆ‘çš„ä»£ç è´¨é‡\"     # è‡ªåŠ¨å¯ç”¨å¤šä»£ç†æ¨¡å¼æ£€æŸ¥ä»£ç "
        echo "  cf \"ä¼˜åŒ–é¡¹ç›®æ€§èƒ½\"         # è‡ªåŠ¨å¯ç”¨å¤šä»£ç†æ¨¡å¼ä¼˜åŒ–æ€§èƒ½"
        echo ""
        echo "ğŸ’¡ æç¤º: ç›´æ¥è¾“å…¥ä»»åŠ¡æè¿°ä¼šè‡ªåŠ¨å¯ç”¨SPARCå¤šä»£ç†æ¨¡å¼"
        echo ""
        eval $CLAUDE_FLOW_CMD --help | translate_output
        return 0
    fi
    
    # ä¸­æ–‡å‘½ä»¤æ˜ å°„
    case "${args[0]}" in
        "çŠ¶æ€"|"ç³»ç»ŸçŠ¶æ€")
            args[0]="status"
            ;;
        "å†…å­˜")
            args[0]="memory"
            if [ "${args[1]}" == "åˆ—è¡¨" ]; then
                args[1]="list"
            elif [ "${args[1]}" == "å­˜å‚¨" ]; then
                args[1]="store"
            elif [ "${args[1]}" == "è·å–" ]; then
                args[1]="get"
            elif [ "${args[1]}" == "ç»Ÿè®¡" ]; then
                args[1]="stats"
            fi
            ;;
        "sparc")
            if [ "${args[1]}" == "æ¨¡å¼" ]; then
                args[1]="modes"
            elif [ "${args[1]}" == "è¿è¡Œ" ]; then
                args[1]="run"
            fi
            ;;
        "ä»£ç†")
            args[0]="agent"
            if [ "${args[1]}" == "åˆ—è¡¨" ]; then
                args[1]="list"
            elif [ "${args[1]}" == "ç”Ÿæˆ" ]; then
                args[1]="spawn"
            fi
            ;;
        "å¸®åŠ©")
            args[0]="help"
            ;;
        "å¼€å§‹"|"å¯åŠ¨")
            args[0]="start"
            ;;
        "é…ç½®")
            args[0]="config"
            ;;
        "ç›‘æ§")
            args[0]="monitor"
            ;;
        "ç¾¤ä½“"|"èœ‚ç¾¤")
            args[0]="swarm"
            ;;
    esac
    
    # å·²çŸ¥å‘½ä»¤åˆ—è¡¨
    local known_commands=("start" "agent" "config" "memory" "swarm" "sparc" "repl" "help" "status" "monitor" "ui" "mcp" "session" "workflow" "init" "spawn" "claude" "project" "deploy" "cloud" "security" "analytics")
    
    # æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºå·²çŸ¥å‘½ä»¤æˆ–ä»¥--å¼€å¤´
    local is_known_command=false
    for cmd in "${known_commands[@]}"; do
        if [[ "${args[0]}" == "$cmd" ]]; then
            is_known_command=true
            break
        fi
    done
    
    # å¦‚æœä»¥--å¼€å¤´ä¹Ÿæ˜¯å·²çŸ¥é€‰é¡¹
    if [[ "${args[0]}" == "--"* ]]; then
        is_known_command=true
    fi
    
    # å¦‚æœä¸æ˜¯å·²çŸ¥å‘½ä»¤ï¼Œä½œä¸ºSPARCä»»åŠ¡æè¿°å¤„ç†
    if [[ "$is_known_command" == false ]]; then
        # è‡ªåŠ¨ä½¿ç”¨SPARCæ¨¡å¼å¤„ç†ä»»åŠ¡æè¿°
        echo "ğŸš€ è‡ªåŠ¨å¯ç”¨SPARCå¤šä»£ç†æ¨¡å¼..."
        echo "ğŸ“ ä»»åŠ¡æè¿°: ${args[*]}"
        echo "ğŸ¯ æ­£åœ¨åˆ†æä»»åŠ¡å¹¶åˆ†é…ç»™æœ€é€‚åˆçš„ä»£ç†..."
        echo ""
        eval $CLAUDE_FLOW_CMD sparc "\"${args[*]}\"" 2>&1 | translate_output
    else
        # ä¼ é€’å…¶ä»–å‘½ä»¤å¹¶ç¿»è¯‘è¾“å‡º
        eval $CLAUDE_FLOW_CMD "${args[@]}" 2>&1 | translate_output
    fi
}

# è®¾ç½®æœ€ä½³è‡ªåŠ¨åŒ–ç¯å¢ƒå˜é‡
export CLAUDE_FLOW_NON_INTERACTIVE=true
export CLAUDE_FLOW_AUTO_CONFIRM=true
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯
if [ "$1" != "status" ] && [ "$1" != "help" ] && [ "$1" != "çŠ¶æ€" ] && [ "$1" != "å¸®åŠ©" ]; then
    echo "ğŸ‡¨ğŸ‡³ Claude Flow ä¸­æ–‡ç‰ˆå¯åŠ¨ä¸­..."
fi

# è¿è¡Œå¢å¼ºå‘½ä»¤
enhance_command "$@"