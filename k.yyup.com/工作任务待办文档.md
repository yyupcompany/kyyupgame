## 工作任务待办文档（AI 助手与前端回归）

更新时间：2025-10-02
负责人：—

---

### 一、背景
围绕 AI 助手在 MCP 浏览器场景下的“工具预说明与工具调用过程展示”体验，以及一次提问结束后内容保留策略，进行了多轮修复与回归。同时处理了构建期因 LOGO 资源缺失引发的前端报错，并统一了登录/注册/侧边栏等页面的 LOGO 资源。

---

### 二、已完成（Done）
- [x] AI 助手“完成后内容消失”问题修复
  - 取消 complete 阶段自动隐藏当前执行卡片逻辑（完成后不再 setTimeout 隐藏）。
  - refreshMessagesFromServer() 在后端返回空数组时不覆盖本地显示，避免清空。
- [x] 工具展示结构与中文映射
  - SSE 顺序确认：先显示“预说明（tool_call_description）”，再显示“调用某某工具（中文映射名）”。
  - 中文映射表与 UI 呈现已生效。
- [x] 修复 AIAssistant.vue SFC 语法错误
  - 补齐缺失的 </style> 闭合标签，解除 Vite HMR 报错。
- [x] 统一 LOGO 资源并修复构建错误
  - 下载并落地：client/src/assets/logo.png（来自 https://www.yyup.cc/assets/logo-D01437kG.png）。
  - 替换引用：
    - Register.vue → logo.png
    - Login/index.vue → logo.png（含样式与兜底）
    - pages/mobile/Login.vue → logo.png
    - layouts/components/Sidebar.vue → logo.png
    - parent/ChildrenList.vue → 默认头像改为 logo.png（先前修复）
- [x] 前端构建通过（vite build）
  - 无 logo.svg ENOENT 错误；产物包含 dist/png/logo-*.png。

- [x] 全仓排查 logo.svg 残留（防御性）
  - client/src 下未发现 logo.svg 引用；无需替换
  - Playwright 报告资源 playwright-logo.svg 与业务无关，忽略

- [x] MCP 浏览器"多工具调用"真实场景回归测试（2025-10-02）
  - 测试环境：localhost:5173 + localhost:3000
  - 测试用例 1：多工具调用与内容保留
    - 发送需求："查询最近一个月的活动统计，并截图保存"
    - ✅ 成功调用 4 个工具：任务复杂度分析、任务清单创建、活动统计获取、截图操作
    - ✅ 展示顺序正确：预说明 → 中文工具名 → 工具完成 → 最终答案
    - ✅ 完成后内容完整保留（用户消息、执行过程、最终答案）
    - ✅ Console 日志验证：`refreshMessagesFromServer: 后端返回空消息，跳过覆盖以保留本地显示`
  - 测试用例 2：下一次提问时清空执行过程
    - 发送第二个需求："帮我查看招生数据"
    - ✅ 第一轮对话保留在列表中
    - ✅ 第一轮执行过程已清空
    - ✅ 第二轮工具调用正常显示（2 个工具：任务复杂度分析、招生历史查询）
    - ✅ 最终答案正确显示
  - 截图归档：
    - mcp-regression-test-1-completed.png（第一轮完成状态）
    - mcp-regression-test-2-completed.png（第二轮完成状态）
  - **结论：所有验证点通过，"完成后内容消失"问题已完全修复**

---

### 三、正在解决/需验证（In Progress / To Verify）
- [ ] MCP 浏览器“多工具调用”真实场景回归
  - 目标：发送消息后，执行过程完整保留；仅在“下一次提问开始时”清空当前执行区域。
  - 验证点：
    - 先显示“预说明”一行
    - 再显示“调用某某工具（中文名）”
    - 工具完成后：输入+过程+最终答案 均保留
    - 发起下一条消息时：开始前清空当前执行过程区域
- [ ] 是否需要“将工具步骤（aiEnhanced.toolResults）持久化进历史消息”
  - 现状：前端已避免被空响应覆盖，但历史回放是否需要完整步骤需确定产品预期。
  - 方案：在 SSE complete 时将 currentAIResponse 的步骤打包落库，历史消息可回放。

---

### 四、后续待办（Todo）
- [ ] 最终回归：使用 MCP 浏览器完成以下用例并截图归档
  1. 页面操作类：打开页面 + 截图
  2. 数据查询类：查询统计/报表
  3. 业务操作类：发起业务流程/表单
  - 对每个用例核对：预说明顺序、中文名展示、完成后内容保留、下一次开始清空。
- [ ] 决策：是否开启“执行过程持久化至历史”（跨会话可回放）
  - 开启则实现保存接口与 UI 回放折叠视图，并做回归。


---

### 五、技术债与优化建议（Backlog）
- [ ] Sass @import 弃用警告
  - 建议逐步迁移至 @use/@forward，减少后续 Sass 3.0 兼容风险。
- [ ] CSS 压缩警告与超大 chunk
  - 若影响加载性能，考虑拆分样式与按需加载，优化 rollup manualChunks。
- [ ] 类型检查告警（前述约 40+）
  - 分模块推进修复，降低潜在运行期风险。

---

### 六、回归测试计划（MCP 浏览器）
- 登录管理员账号 → 打开“AI助手/搜索” → 输入提示（触发多工具调用）。
- 观察：
  - 预说明 → 调用工具（中文名）→ 工具完成 → 最终答案
  - 完成后内容是否保留；发送下一条消息时是否在开始前清空当前执行过程。
- 记录：关键流程截图 + 失败时的 console/SSE 日志片段。

---

### 七、相关文件与变更（Traceability）
- AI 助手
  - client/src/components/ai-assistant/AIAssistant.vue
    - 取消完成后自动隐藏
    - refreshMessagesFromServer 空响应保护
    - 修复 </style> 缺失
- LOGO 统一
  - client/src/assets/logo.png（新增）
  - client/src/pages/Register.vue
  - client/src/pages/Login/index.vue
  - client/src/pages/mobile/Login.vue
  - client/src/layouts/components/Sidebar.vue
  - client/src/pages/parent/ChildrenList.vue

---

### 八、风险与注意
- k.yyup.com 项目约定：每次修改后需使用 MCP 浏览器进行回归测试，确保功能正常。
- 如开启“执行过程持久化”，需评估历史数据体量与前端回放性能。

