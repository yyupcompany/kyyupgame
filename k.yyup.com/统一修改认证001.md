# ç»Ÿä¸€è®¤è¯ç³»ç»Ÿæ”¹é€ æ–¹æ¡ˆ - æ–‡æ¡£001

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ç›®æ ‡
å°†ç°æœ‰çš„ k.yyup.com å¹¼å„¿å›­ç®¡ç†ç³»ç»Ÿæ”¹é€ ä¸ºæ”¯æŒç»Ÿä¸€è®¤è¯çš„å¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œå®ç°ï¼š
- ç»Ÿä¸€èº«ä»½è®¤è¯ï¼ˆæ‰‹æœºå·+å¯†ç ï¼‰
- å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- æœ€å°åŒ–ç°æœ‰ç³»ç»Ÿæ”¹åŠ¨
- ä¿æŒç°æœ‰ä¸šåŠ¡é€»è¾‘ä¸å˜

### æ”¹é€ èŒƒå›´
- **ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ**: admin.yyup.cc
- **ç§Ÿæˆ·ç³»ç»Ÿ**: k.yyup.com
- **æ•°æ®åº“**: ç»Ÿä¸€è®¤è¯æ•°æ®åº“ + å„ç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### è®¤è¯æµç¨‹å›¾
```
ç”¨æˆ·ç™»å½• â†’ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯ â†’ ç§Ÿæˆ·æ•°æ®åº“æŸ¥æ‰¾/åˆ›å»ºç”¨æˆ· â†’ ç”Ÿæˆç§Ÿæˆ·Token â†’ ç™»å½•æˆåŠŸ
```

### æ•°æ®éš”ç¦»ç­–ç•¥
```
ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (admin.yyup.cc)
â”œâ”€â”€ global_users (å…¨å±€ç”¨æˆ·è¡¨)
â”œâ”€â”€ user_tenant_relations (ç”¨æˆ·ç§Ÿæˆ·å…³è”è¡¨)

ç§Ÿæˆ·æ•°æ®åº“ (æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹)
â”œâ”€â”€ users (ç§Ÿæˆ·å†…ç”¨æˆ·è¡¨ï¼Œæ–°å¢global_user_idå­—æ®µ)
â”œâ”€â”€ roles (ç§Ÿæˆ·å†…è§’è‰²è¡¨)
â”œâ”€â”€ permissions (ç§Ÿæˆ·å†…æƒé™è¡¨)
â””â”€â”€ ... (å…¶ä»–ä¸šåŠ¡è¡¨ï¼Œä¿æŒä¸å˜)
```

## ğŸ“ è¯¦ç»†æ”¹é€ è®¡åˆ’

### é˜¶æ®µ1: ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå¼€å‘ (admin.yyup.cc)

#### 1.1 æ•°æ®åº“è®¾è®¡

**å…¨å±€ç”¨æˆ·è¡¨**
```sql
CREATE TABLE global_users (
  id VARCHAR(100) PRIMARY KEY COMMENT 'å…¨å±€ç”¨æˆ·ID',
  phone VARCHAR(20) UNIQUE NOT NULL COMMENT 'æ‰‹æœºå·',
  password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
  real_name VARCHAR(50) COMMENT 'çœŸå®å§“å',
  email VARCHAR(100) COMMENT 'é‚®ç®±',
  status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
  login_count INT DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',

  INDEX idx_phone (phone),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å…¨å±€ç”¨æˆ·è¡¨';
```

**ç”¨æˆ·ç§Ÿæˆ·å…³è”è¡¨**
```sql
CREATE TABLE user_tenant_relations (
  id INT AUTO_INCREMENT PRIMARY KEY,
  global_user_id VARCHAR(100) NOT NULL COMMENT 'å…¨å±€ç”¨æˆ·ID',
  tenant_code VARCHAR(20) NOT NULL COMMENT 'ç§Ÿæˆ·ä»£ç ',
  role_in_tenant VARCHAR(50) COMMENT 'åœ¨ç§Ÿæˆ·ä¸­çš„è§’è‰²',
  tenant_user_id VARCHAR(100) COMMENT 'ç§Ÿæˆ·å†…ç”¨æˆ·ID',
  first_login_at TIMESTAMP NULL COMMENT 'é¦–æ¬¡ç™»å½•æ—¶é—´',
  last_login_at TIMESTAMP NULL COMMENT 'ç§Ÿæˆ·å†…æœ€åç™»å½•æ—¶é—´',
  login_count INT DEFAULT 0 COMMENT 'ç§Ÿæˆ·å†…ç™»å½•æ¬¡æ•°',
  status ENUM('active', 'inactive') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY unique_user_tenant (global_user_id, tenant_code),
  INDEX idx_global_user (global_user_id),
  INDEX idx_tenant_code (tenant_code),
  INDEX idx_tenant_user_id (tenant_user_id),

  FOREIGN KEY (global_user_id) REFERENCES global_users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ç§Ÿæˆ·å…³è”è¡¨';
```

#### 1.2 APIæ¥å£è®¾è®¡

**æ ¸å¿ƒè®¤è¯æ¥å£**
```typescript
// POST /api/unified-auth/authenticate
interface AuthenticateRequest {
  phone: string;
  password: string;
  registrationSource?: string; // 'web', 'mobile', 'admin'
}

interface AuthenticateResponse {
  success: boolean;
  message: string;
  data?: {
    globalUserId: string;
    phone: string;
    realName?: string;
    isNewUser: boolean;
    token?: string; // å¯é€‰ï¼šå…¨å±€è®¤è¯token
  };
}
```

**æŸ¥æ‰¾ç”¨æˆ·ç§Ÿæˆ·æ¥å£**
```typescript
// GET /api/unified-auth/user-tenants/{globalUserId}
interface UserTenantsResponse {
  success: boolean;
  message: string;
  data?: {
    phone: string;
    tenants: Array<{
      tenantCode: string;
      tenantName: string;
      domain: string;
      hasAccount: boolean;
      role?: string;
      lastLoginAt?: string;
      loginCount?: number;
      status: 'active' | 'suspended' | 'deleted';
    }>;
  };
}
```

**ç§Ÿæˆ·ç”¨æˆ·åˆ›å»ºæ¥å£**
```typescript
// POST /api/unified-auth/bind-tenant
interface BindTenantRequest {
  globalUserId: string;
  tenantCode: string;
  role?: string;
  userInfo?: {
    realName?: string;
    email?: string;
  };
}

interface BindTenantResponse {
  success: boolean;
  message: string;
  data?: {
    tenantUserId: string;
    globalUserId: string;
    tenantCode: string;
    role: string;
  };
}
```

#### 1.3 æœåŠ¡ç±»è®¾è®¡

**ç»Ÿä¸€è®¤è¯æœåŠ¡ç±»**
```typescript
// server/src/services/unified-auth.service.ts
export class UnifiedAuthService {

  /**
   * ç”¨æˆ·è®¤è¯
   */
  async authenticate(phone: string, password: string): Promise<AuthenticateResponse> {
    // 1. æŸ¥æ‰¾å…¨å±€ç”¨æˆ·
    // 2. éªŒè¯å¯†ç 
    // 3. æ›´æ–°ç™»å½•ä¿¡æ¯
    // 4. è¿”å›è®¤è¯ç»“æœ
  }

  /**
   * ç”¨æˆ·æ³¨å†Œ
   */
  async register(userInfo: {
    phone: string;
    password: string;
    realName?: string;
    email?: string;
  }): Promise<RegisterResponse> {
    // 1. éªŒè¯æ‰‹æœºå·å”¯ä¸€æ€§
    // 2. åˆ›å»ºå…¨å±€ç”¨æˆ·
    // 3. è¿”å›æ³¨å†Œç»“æœ
  }

  /**
   * æŸ¥æ‰¾ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·
   */
  async findUserTenants(globalUserId: string): Promise<UserTenantsResponse> {
    // 1. æŸ¥è¯¢ç”¨æˆ·ç§Ÿæˆ·å…³è”
    // 2. è·å–ç§Ÿæˆ·è¯¦ç»†ä¿¡æ¯
    // 3. è¿”å›ç§Ÿæˆ·åˆ—è¡¨
  }

  /**
   * ç»‘å®šç”¨æˆ·åˆ°ç§Ÿæˆ·
   */
  async bindUserToTenant(request: BindTenantRequest): Promise<BindTenantResponse> {
    // 1. éªŒè¯ç”¨æˆ·å’Œç§Ÿæˆ·å­˜åœ¨
    // 2. åˆ›å»ºå…³è”å…³ç³»
    // 3. è¿”å›ç»‘å®šç»“æœ
  }
}
```

### é˜¶æ®µ2: ç§Ÿæˆ·ç³»ç»Ÿæ”¹é€  (k.yyup.com)

#### 2.1 æ•°æ®åº“æ”¹é€ 

**ç§Ÿæˆ·æ•°æ®åº“è¡¨ç»“æ„ä¿®æ”¹**
```sql
-- åœ¨æ¯ä¸ªç§Ÿæˆ·æ•°æ®åº“çš„usersè¡¨ä¸­æ·»åŠ å­—æ®µ
ALTER TABLE users
ADD COLUMN global_user_id VARCHAR(100) NULL COMMENT 'å…¨å±€ç”¨æˆ·ID',
ADD COLUMN auth_source ENUM('local', 'unified') DEFAULT 'local' COMMENT 'è®¤è¯æ¥æº',
ADD COLUMN unified_auth_at TIMESTAMP NULL COMMENT 'ç»Ÿä¸€è®¤è¯æ—¶é—´',
ADD COLUMN INDEX idx_global_user_id (global_user_id),
ADD COLUMN INDEX idx_auth_source (auth_source);
```

**æ•°æ®åº“è¿ç§»è„šæœ¬**
```typescript
// server/src/migrations/add-unified-auth-fields.js
module.exports = {
  up: async (queryInterface, Sequelize) => {
    // æ·»åŠ å­—æ®µ
    await queryInterface.addColumn('users', 'global_user_id', {
      type: Sequelize.STRING(100),
      allowNull: true,
      comment: 'å…¨å±€ç”¨æˆ·ID'
    });

    await queryInterface.addColumn('users', 'auth_source', {
      type: Sequelize.ENUM('local', 'unified'),
      defaultValue: 'local',
      comment: 'è®¤è¯æ¥æº'
    });

    // æ·»åŠ ç´¢å¼•
    await queryInterface.addIndex('users', ['global_user_id']);
    await queryInterface.addIndex('users', ['auth_source']);
  },

  down: async (queryInterface, Sequelize) => {
    // å›æ»šæ“ä½œ
    await queryInterface.removeColumn('users', 'global_user_id');
    await queryInterface.removeColumn('users', 'auth_source');
  }
};
```

#### 2.2 è®¤è¯ä¸­é—´ä»¶æ”¹é€ 

**å‡çº§è®¤è¯ä¸­é—´ä»¶**
```typescript
// server/src/middleware/auth.ts
export class AuthMiddleware {

  /**
   * ç»Ÿä¸€è®¤è¯ç™»å½•
   */
  async authenticateWithUnifiedAuth(req, res, next) {
    const { phone, password, tenantCode } = req.body;

    try {
      // 1. ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯
      const authResult = await adminIntegrationService.authenticateUser(phone, password);
      if (!authResult.success) {
        return res.status(401).json({
          success: false,
          message: 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯'
        });
      }

      // 2. åˆ‡æ¢åˆ°ç§Ÿæˆ·æ•°æ®åº“
      await databaseSwitchService.switchToTenantDatabase(tenantCode);

      // 3. åœ¨ç§Ÿæˆ·ä¸­æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
      let tenantUser = await this.findTenantUserByGlobalId(authResult.globalUserId);

      if (!tenantUser) {
        // è‡ªåŠ¨åˆ›å»ºç§Ÿæˆ·å†…ç”¨æˆ·
        tenantUser = await this.createTenantUser(authResult.globalUserId, phone);
      }

      // 4. ç”Ÿæˆç§Ÿæˆ·å†…JWT
      const token = this.generateTenantToken(tenantUser);

      // 5. æ›´æ–°ç”¨æˆ·ç§Ÿæˆ·å…³è”
      await adminIntegrationService.updateUserTenantRelation({
        globalUserId: authResult.globalUserId,
        tenantCode,
        tenantUserId: tenantUser.id
      });

      res.json({
        success: true,
        message: 'ç™»å½•æˆåŠŸ',
        data: {
          token,
          user: this.formatUserResponse(tenantUser),
          tenantInfo: await this.getTenantInfo(tenantCode)
        }
      });

    } catch (error) {
      logger.error('ç»Ÿä¸€è®¤è¯ç™»å½•å¤±è´¥', { error: error.message });
      res.status(500).json({
        success: false,
        message: 'ç™»å½•å¤±è´¥'
      });
    }
  }

  /**
   * æŸ¥æ‰¾ç§Ÿæˆ·å†…ç”¨æˆ·
   */
  private async findTenantUserByGlobalId(globalUserId: string) {
    return await User.findOne({
      where: { global_user_id: globalUserId }
    });
  }

  /**
   * åˆ›å»ºç§Ÿæˆ·å†…ç”¨æˆ·
   */
  private async createTenantUser(globalUserId: string, phone: string) {
    return await User.create({
      global_user_id: globalUserId,
      username: phone,
      phone,
      auth_source: 'unified',
      status: 'active',
      role: 'parent', // é»˜è®¤è§’è‰²ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´
      created_at: new Date()
    });
  }
}
```

#### 2.3 APIæ¥å£æ”¹é€ 

**ç™»å½•æ¥å£æ”¹é€ **
```typescript
// server/src/controllers/auth.controller.ts
export class AuthController {

  /**
   * æ”¯æŒå¤šç§ç™»å½•æ–¹å¼
   */
  async login(req, res, next) {
    const { username, password, phone, tenantCode } = req.body;

    try {
      if (phone && tenantCode) {
        // ç»Ÿä¸€è®¤è¯ç™»å½•
        return await this.unifiedAuthLogin(req, res);
      } else if (username && password) {
        // ä¼ ç»Ÿç”¨æˆ·åå¯†ç ç™»å½•ï¼ˆå‘åå…¼å®¹ï¼‰
        return await this.traditionalLogin(req, res);
      } else {
        return res.status(400).json({
          success: false,
          message: 'è¯·æä¾›å®Œæ•´çš„ç™»å½•ä¿¡æ¯'
        });
      }
    } catch (error) {
      next(error);
    }
  }

  /**
   * è·å–ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·åˆ—è¡¨
   */
  async getUserTenants(req, res, next) {
    const { phone, password } = req.body;

    try {
      // 1. ç»Ÿä¸€è®¤è¯éªŒè¯
      const authResult = await adminIntegrationService.authenticateUser(phone, password);
      if (!authResult.success) {
        return res.status(401).json({
          success: false,
          message: 'æ‰‹æœºå·æˆ–å¯†ç é”™è¯¯'
        });
      }

      // 2. è·å–ç”¨æˆ·å…³è”ç§Ÿæˆ·
      const tenantsResult = await adminIntegrationService.findUserTenants(authResult.globalUserId);

      res.json({
        success: true,
        data: {
          globalUserId: authResult.globalUserId,
          phone,
          tenants: tenantsResult.data?.tenants || []
        }
      });

    } catch (error) {
      next(error);
    }
  }
}
```

#### 2.4 æœåŠ¡å±‚æ”¹é€ 

**Adminé›†æˆæœåŠ¡æ‰©å±•**
```typescript
// server/src/services/admin-integration.service.ts
export class AdminIntegrationService {

  /**
   * ç»Ÿä¸€è®¤è¯ç”¨æˆ·éªŒè¯
   */
  async authenticateUser(phone: string, password: string): Promise<{
    success: boolean;
    globalUserId?: string;
    message: string;
  }> {
    try {
      const response = await this.makeHttpPostRequest(
        `${this.adminBaseUrl}/api/unified-auth/authenticate`,
        { phone, password }
      );

      if (response.data.success) {
        return {
          success: true,
          globalUserId: response.data.data.globalUserId,
          message: response.data.message
        };
      }

      return {
        success: false,
        message: response.data.message
      };
    } catch (error) {
      return {
        success: false,
        message: 'ç»Ÿä¸€è®¤è¯æœåŠ¡å¼‚å¸¸'
      };
    }
  }

  /**
   * æŸ¥æ‰¾ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·
   */
  async findUserTenants(globalUserId: string): Promise<any> {
    try {
      const response = await this.makeHttpRequest(
        `${this.adminBaseUrl}/api/unified-auth/user-tenants/${globalUserId}`
      );
      return response.data;
    } catch (error) {
      logger.error('æŸ¥æ‰¾ç”¨æˆ·ç§Ÿæˆ·å¤±è´¥', { globalUserId, error: error.message });
      throw error;
    }
  }

  /**
   * æ›´æ–°ç”¨æˆ·ç§Ÿæˆ·å…³è”
   */
  async updateUserTenantRelation(relation: {
    globalUserId: string;
    tenantCode: string;
    tenantUserId: string;
    role?: string;
  }): Promise<void> {
    try {
      await this.makeHttpPostRequest(
        `${this.adminBaseUrl}/api/unified-auth/bind-tenant`,
        relation
      );
    } catch (error) {
      logger.error('æ›´æ–°ç”¨æˆ·ç§Ÿæˆ·å…³è”å¤±è´¥', { relation, error: error.message });
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸é™çº§å¤„ç†
    }
  }
}
```

### é˜¶æ®µ3: å‰ç«¯æ”¹é€ 

#### 3.1 è®¤è¯çŠ¶æ€ç®¡ç†æ”¹é€ 

**æ‰©å±•Auth Store**
```typescript
// client/src/store/modules/auth.ts
export const useAuthStore = defineStore('auth', {
  state: (): AuthState => ({
    user: null,
    token: localStorage.getItem('kindergarten_token'),
    globalUserId: localStorage.getItem('global_user_id'),
    authMode: 'local', // 'local' | 'unified'
    availableTenants: [], // ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·åˆ—è¡¨
    isAuthenticated: !!localStorage.getItem('kindergarten_token'),
    loading: false,
    error: null
  }),

  actions: {
    /**
     * ç»Ÿä¸€è®¤è¯ç™»å½•
     */
    async loginWithPhone(phone: string, password: string, tenantCode?: string) {
      this.loading = true;
      this.error = null;

      try {
        if (tenantCode) {
          // ç›´æ¥ç™»å½•æŒ‡å®šç§Ÿæˆ·
          const response = await authApi.unifiedLogin({ phone, password, tenantCode });
          this.handleLoginSuccess(response, 'unified');
        } else {
          // æŸ¥æ‰¾ç”¨æˆ·ç§Ÿæˆ·
          const response = await authApi.getUserTenants({ phone, password });
          this.availableTenants = response.data.tenants;
          this.globalUserId = response.data.globalUserId;
          return { requiresTenantSelection: true, tenants: response.data.tenants };
        }
      } catch (error) {
        this.error = error.message;
        throw error;
      } finally {
        this.loading = false;
      }
    },

    /**
     * ä¼ ç»Ÿç™»å½•ï¼ˆå‘åå…¼å®¹ï¼‰
     */
    async login(username: string, password: string) {
      this.loading = true;
      this.error = null;

      try {
        const response = await authApi.login({ username, password });
        this.handleLoginSuccess(response, 'local');
      } catch (error) {
        this.error = error.message;
        throw error;
      } finally {
        this.loading = false;
      }
    }
  }
});
```

#### 3.2 APIæœåŠ¡æ”¹é€ 

**æ‰©å±•è®¤è¯API**
```typescript
// client/src/api/auth.ts
export interface UnifiedLoginRequest {
  phone: string;
  password: string;
  tenantCode: string;
}

export interface GetUserTenantsRequest {
  phone: string;
  password: string;
}

export const authApi = {
  // ç°æœ‰ç™»å½•æ–¹æ³•ä¿æŒä¸å˜...

  /**
   * ç»Ÿä¸€è®¤è¯ç™»å½•
   */
  async unifiedLogin(data: UnifiedLoginRequest): Promise<LoginResponse> {
    try {
      const response = await service.post('/api/auth/unified-login', data);
      return response.data;
    } catch (error: any) {
      throw new Error(error.response?.data?.message || 'ç™»å½•å¤±è´¥');
    }
  },

  /**
   * è·å–ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·
   */
  async getUserTenants(data: GetUserTenantsRequest): Promise<any> {
    try {
      const response = await service.post('/api/auth/user-tenants', data);
      return response.data;
    } catch (error: any) {
      throw new Error(error.response?.data?.message || 'è·å–ç§Ÿæˆ·åˆ—è¡¨å¤±è´¥');
    }
  }
};
```

#### 3.3 ç™»å½•ç»„ä»¶æ”¹é€ 

**ç™»å½•é¡µé¢æ”¹é€ **
```vue
<!-- client/src/pages/Login/index.vue -->
<template>
  <div class="login-container">
    <el-tabs v-model="loginMode" @tab-click="handleTabChange">
      <!-- ä¼ ç»Ÿç™»å½• -->
      <el-tab-pane label="è´¦å·ç™»å½•" name="traditional">
        <el-form ref="traditionalForm" :model="traditionalForm">
          <el-form-item prop="username">
            <el-input v-model="traditionalForm.username" placeholder="ç”¨æˆ·å" />
          </el-form-item>
          <el-form-item prop="password">
            <el-input v-model="traditionalForm.password" type="password" placeholder="å¯†ç " />
          </el-form-item>
        </el-form>
      </el-tab-pane>

      <!-- ç»Ÿä¸€è®¤è¯ç™»å½• -->
      <el-tab-pane label="æ‰‹æœºå·ç™»å½•" name="unified">
        <el-form ref="unifiedForm" :model="unifiedForm">
          <el-form-item prop="phone">
            <el-input v-model="unifiedForm.phone" placeholder="æ‰‹æœºå·" />
          </el-form-item>
          <el-form-item prop="password">
            <el-input v-model="unifiedForm.password" type="password" placeholder="å¯†ç " />
          </el-form-item>
          <el-form-item prop="tenantCode" v-if="!showTenantSelection">
            <el-input v-model="unifiedForm.tenantCode" placeholder="ç§Ÿæˆ·ä»£ç ï¼ˆå¯é€‰ï¼‰" />
          </el-form-item>
        </el-form>

        <!-- ç§Ÿæˆ·é€‰æ‹© -->
        <div v-if="showTenantSelection" class="tenant-selection">
          <h3>è¯·é€‰æ‹©è¦ç™»å½•çš„ç§Ÿæˆ·ï¼š</h3>
          <el-radio-group v-model="selectedTenant">
            <el-radio
              v-for="tenant in availableTenants"
              :key="tenant.tenantCode"
              :label="tenant.tenantCode"
            >
              {{ tenant.tenantName }} ({{ tenant.tenantCode }})
            </el-radio>
          </el-radio-group>
        </div>
      </el-tab-pane>
    </el-tabs>

    <el-button type="primary" @click="handleLogin" :loading="loading">
      ç™»å½•
    </el-button>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { useAuthStore } from '@/store/modules/auth';

const authStore = useAuthStore();

const loginMode = ref('traditional');
const showTenantSelection = ref(false);
const selectedTenant = ref('');

const traditionalForm = reactive({
  username: '',
  password: ''
});

const unifiedForm = reactive({
  phone: '',
  password: '',
  tenantCode: ''
});

const handleLogin = async () => {
  try {
    if (loginMode.value === 'traditional') {
      await authStore.login(traditionalForm.username, traditionalForm.password);
    } else {
      const result = await authStore.loginWithPhone(
        unifiedForm.phone,
        unifiedForm.password,
        unifiedForm.tenantCode || selectedTenant.value
      );

      if (result.requiresTenantSelection) {
        showTenantSelection.value = true;
        return; // ä¸è·³è½¬ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©ç§Ÿæˆ·
      }
    }

    // ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
    router.push('/dashboard');
  } catch (error) {
    ElMessage.error(error.message);
  }
};
</script>
```

### é˜¶æ®µ4: é…ç½®å’Œç¯å¢ƒå‡†å¤‡

#### 4.1 ç¯å¢ƒå˜é‡é…ç½®

**ç»Ÿä¸€è®¤è¯ä¸­å¿ƒé…ç½®**
```bash
# admin.yyup.cc ç¯å¢ƒå˜é‡
UNIFIED_AUTH_SECRET=your-unified-auth-secret
UNIFIED_AUTH_TOKEN_EXPIRES=24h
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=unified_auth
DB_USERNAME=root
DB_PASSWORD=password
```

**ç§Ÿæˆ·ç³»ç»Ÿé…ç½®**
```bash
# k.yyup.com ç¯å¢ƒå˜é‡
ADMIN_YYUP_BASE_URL=https://admin.yyup.cc
ADMIN_YYUP_API_KEY=your-api-key
UNIFIED_AUTH_ENABLED=true
```

#### 4.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**ç»Ÿä¸€è®¤è¯ä¸­å¿ƒåˆå§‹åŒ–**
```sql
-- init-unified-auth.sql
-- åˆ›å»ºç»Ÿä¸€è®¤è¯æ•°æ®åº“
CREATE DATABASE IF NOT EXISTS unified_auth
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE unified_auth;

-- åˆ›å»ºå…¨å±€ç”¨æˆ·è¡¨å’Œå…³è”è¡¨
-- (ä½¿ç”¨é˜¶æ®µ1ä¸­å®šä¹‰çš„SQL)

-- åˆ›å»ºç®¡ç†å‘˜è´¦å·
INSERT INTO global_users (id, phone, password_hash, real_name, status)
VALUES (
  'admin_001',
  '15800000000',
  '$2b$10$...', -- åŠ å¯†åçš„å¯†ç 
  'ç³»ç»Ÿç®¡ç†å‘˜',
  'active'
);
```

**ç§Ÿæˆ·æ•°æ®åº“å‡çº§è„šæœ¬**
```javascript
// upgrade-tenant-databases.js
const mysql = require('mysql2/promise');

async function upgradeTenantDatabase(tenantCode) {
  const connection = await mysql.createConnection({
    host: process.env.DB_HOST,
    port: process.env.DB_PORT,
    user: process.env.DB_USERNAME,
    password: process.env.DB_PASSWORD,
    database: `tenant_${tenantCode}`
  });

  try {
    // æ‰§è¡Œè¡¨ç»“æ„å‡çº§
    await connection.execute(`
      ALTER TABLE users
      ADD COLUMN global_user_id VARCHAR(100) NULL COMMENT 'å…¨å±€ç”¨æˆ·ID',
      ADD COLUMN auth_source ENUM('local', 'unified') DEFAULT 'local' COMMENT 'è®¤è¯æ¥æº',
      ADD COLUMN unified_auth_at TIMESTAMP NULL COMMENT 'ç»Ÿä¸€è®¤è¯æ—¶é—´'
    `);

    console.log(`ç§Ÿæˆ· ${tenantCode} æ•°æ®åº“å‡çº§æˆåŠŸ`);
  } catch (error) {
    if (error.code !== 'ER_DUP_FIELDNAME') {
      console.error(`ç§Ÿæˆ· ${tenantCode} æ•°æ®åº“å‡çº§å¤±è´¥:`, error);
      throw error;
    }
  } finally {
    await connection.end();
  }
}

// æ‰¹é‡å‡çº§æ‰€æœ‰ç§Ÿæˆ·æ•°æ®åº“
const tenantCodes = ['k001', 'k002', 'k003']; // ä»ç§Ÿæˆ·è¡¨è·å–

Promise.all(tenantCodes.map(upgradeTenantDatabase))
  .then(() => console.log('æ‰€æœ‰ç§Ÿæˆ·æ•°æ®åº“å‡çº§å®Œæˆ'))
  .catch(error => console.error('æ‰¹é‡å‡çº§å¤±è´¥:', error));
```

## ğŸ“‹ å®æ–½æ­¥éª¤å’Œæ—¶é—´è®¡åˆ’

### ç¬¬ä¸€å‘¨ï¼šç»Ÿä¸€è®¤è¯ä¸­å¿ƒå¼€å‘
- [ ] æ•°æ®åº“è®¾è®¡å’Œåˆ›å»º
- [ ] æ ¸å¿ƒè®¤è¯æ¥å£å¼€å‘
- [ ] ç”¨æˆ·ç§Ÿæˆ·å…³è”åŠŸèƒ½
- [ ] åŸºç¡€æµ‹è¯•å’ŒéªŒè¯

### ç¬¬äºŒå‘¨ï¼šç§Ÿæˆ·ç³»ç»Ÿåç«¯æ”¹é€ 
- [ ] æ•°æ®åº“è¡¨ç»“æ„å‡çº§
- [ ] è®¤è¯ä¸­é—´ä»¶æ”¹é€ 
- [ ] APIæ¥å£é€‚é…
- [ ] Adminé›†æˆæœåŠ¡æ‰©å±•

### ç¬¬ä¸‰å‘¨ï¼šå‰ç«¯ç³»ç»Ÿæ”¹é€ 
- [ ] è®¤è¯çŠ¶æ€ç®¡ç†å‡çº§
- [ ] ç™»å½•ç»„ä»¶æ”¹é€ 
- [ ] APIæœåŠ¡æ‰©å±•
- [ ] ç”¨æˆ·ç•Œé¢ä¼˜åŒ–

### ç¬¬å››å‘¨ï¼šé›†æˆæµ‹è¯•å’Œä¸Šçº¿
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ğŸ” æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ¥å£æµ‹è¯•
- [ ] ç§Ÿæˆ·ç³»ç»Ÿè®¤è¯æµç¨‹æµ‹è¯•
- [ ] æ•°æ®åº“æ“ä½œæµ‹è¯•

### é›†æˆæµ‹è¯•
- [ ] è·¨ç§Ÿæˆ·ç™»å½•æµç¨‹æµ‹è¯•
- [ ] ç”¨æˆ·ç§Ÿæˆ·å…³è”æµ‹è¯•
- [ ] æ•°æ®éš”ç¦»éªŒè¯æµ‹è¯•

### ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•
- [ ] å¤šç§Ÿæˆ·åˆ‡æ¢æµ‹è¯•
- [ ] ä¸šåŠ¡åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•

## âš ï¸ é£é™©è¯„ä¼°å’Œç¼“è§£æªæ–½

### é«˜é£é™©é¡¹ç›®
1. **æ•°æ®å®‰å…¨é£é™©**
   - ç¼“è§£ï¼šåŠ å¯†å­˜å‚¨ï¼Œè®¿é—®æ§åˆ¶ï¼Œå®¡è®¡æ—¥å¿—

2. **ç³»ç»Ÿå…¼å®¹æ€§é£é™©**
   - ç¼“è§£ï¼šä¿æŒå‘åå…¼å®¹ï¼Œæ¸è¿›å¼è¿ç§»ï¼Œå›æ»šæœºåˆ¶

3. **æ€§èƒ½å½±å“é£é™©**
   - ç¼“è§£ï¼šç¼“å­˜ä¼˜åŒ–ï¼Œè¿æ¥æ± ç®¡ç†ï¼Œæ€§èƒ½ç›‘æ§

### åº”æ€¥é¢„æ¡ˆ
- [ ] æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] å¿«é€Ÿå›æ»šæ–¹æ¡ˆ
- [ ] ç›‘æ§å‘Šè­¦æœºåˆ¶
- [ ] ç”¨æˆ·é€šçŸ¥æœºåˆ¶

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] ç»Ÿä¸€è®¤è¯æˆåŠŸç‡ > 99.5%
- [ ] ç™»å½•å“åº”æ—¶é—´ < 2ç§’
- [ ] ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%
- [ ] æ•°æ®éš”ç¦»éªŒè¯ 100%

### ä¸šåŠ¡æŒ‡æ ‡
- [ ] ç”¨æˆ·ä½“éªŒæ»¡æ„åº¦ > 90%
- [ ] ç°æœ‰åŠŸèƒ½ä¿æŒç‡ 100%
- [ ] å¤šç§Ÿæˆ·ç™»å½•æˆåŠŸç‡ > 95%

## ğŸ“ åç»­ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆå†…ï¼‰
- [ ] ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ€§èƒ½ä¼˜åŒ–
- [ ] ç§Ÿæˆ·ç³»ç»Ÿç›‘æ§å®Œå–„
- [ ] ç”¨æˆ·ä½“éªŒç»†èŠ‚ä¼˜åŒ–

### ä¸­æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆå†…ï¼‰
- [ ] æ”¯æŒçŸ­ä¿¡éªŒè¯ç ç™»å½•
- [ ] æ”¯æŒç¬¬ä¸‰æ–¹è´¦å·ç»‘å®š
- [ ] ç§Ÿæˆ·é—´æ•°æ®åŒæ­¥æœºåˆ¶

### é•¿æœŸä¼˜åŒ–ï¼ˆ6ä¸ªæœˆå†…ï¼‰
- [ ] å¾®æœåŠ¡æ¶æ„æ¼”è¿›
- [ ] å®¹å™¨åŒ–éƒ¨ç½²æ”¯æŒ
- [ ] å¤šåœ°åŸŸéƒ¨ç½²æ”¯æŒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 001
**åˆ›å»ºæ—¶é—´**: 2024-11-25
**æœ€åæ›´æ–°**: 2024-11-25
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ
**å®¡æ ¸äºº**: æŠ€æœ¯è´Ÿè´£äºº