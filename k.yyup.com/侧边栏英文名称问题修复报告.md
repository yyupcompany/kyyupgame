# 侧边栏英文名称问题修复报告

## 问题描述

用户反馈侧边栏显示了英文名称，包括：
- Analytics Center
- Inspection Center  
- Media Center

这些中心应该显示中文名称，但实际显示为英文。

## 问题分析

### 根本原因

1. **数据库状态不一致**
   - 这三个中心（AI Center, Analytics Center, Inspection Center）已经被设置为 `status=0`（禁用状态）
   - 但是它们仍然存在于某些角色的权限关联中
   - 导致某些用户仍然能看到这些已禁用的中心

2. **前端映射不完整**
   - 前端的 `getChineseName` 函数缺少这三个中心的中英文映射
   - 当后端返回英文名称时，前端无法正确转换为中文

3. **缓存问题**
   - 虽然数据库已禁用，但可能存在缓存导致仍然显示

## 修复方案

### 1. 更新前端映射表

**文件**: `client/src/layouts/components/Sidebar.vue`

**修改内容**:
```typescript
const nameMap: Record<string, string> = {
  // 活跃的中心
  'Personnel Center': '人员中心',
  'Activity Center': '活动中心',
  'Enrollment Center': '招生中心',
  'Marketing Center': '营销中心',
  'Business Center': '业务中心',
  'Customer Pool Center': '客户池中心',
  'System Center': '系统中心',
  'Finance Center': '财务中心',
  'Task Center': '任务中心',
  'Teaching Center': '教学中心',
  'Script Center': '话术中心',
  'Media Center': '新媒体中心',
  
  // 已禁用的中心（保留映射以防缓存问题）
  'AI Center': '智能中心',
  'Analytics Center': '数据分析中心',
  'Inspection Center': '督查中心',
  
  // 其他变体...
};
```

### 2. 清理角色权限关联

**执行脚本**: `server/cleanup-disabled-centers.js`

**清理结果**:
- 删除了 7 条角色权限关联记录
- 涉及 9 个已禁用的中心
- 确保没有用户能访问这些已禁用的中心

**清理的中心**:
1. 其他功能 (ID: 1085)
2. 园长工作台 (ID: 1202)
3. 统计报表 (ID: 1213)
4. 海报管理 (ID: 1268)
5. 智能中心 (ID: 3006) ⭐
6. 数据分析中心 (ID: 3073) ⭐
7. 督查中心 (ID: 5001) ⭐
8. 活动中心 (ID: 5233)
9. 教学中心 (ID: 5239)

### 3. 清除缓存

**执行脚本**: `server/clear-permission-cache.js`

**清除内容**:
- Redis权限缓存
- 路由缓存
- 菜单缓存

## 验证步骤

### 1. 数据库验证

```bash
cd server
node check-center-names.js
```

**预期结果**: 只显示12个活跃的中心，全部为中文名称

### 2. 权限关联验证

```bash
cd server
node check-disabled-centers.js
```

**预期结果**: 已禁用的中心没有角色权限关联

### 3. 前端验证

1. 重启后端服务器
2. 清除浏览器缓存（Ctrl+Shift+Delete）
3. 刷新页面（Ctrl+F5）
4. 检查侧边栏是否只显示12个中文中心

## 最终状态

### 活跃的12个中心

| 序号 | 中心名称 | 英文名称 | 状态 |
|------|---------|---------|------|
| 1 | 人员中心 | Personnel Center | ✅ 活跃 |
| 2 | 活动中心 | Activity Center | ✅ 活跃 |
| 3 | 营销中心 | Marketing Center | ✅ 活跃 |
| 4 | 业务中心 | Business Center | ✅ 活跃 |
| 5 | 客户池中心 | Customer Pool Center | ✅ 活跃 |
| 6 | 系统中心 | System Center | ✅ 活跃 |
| 7 | 财务中心 | Finance Center | ✅ 活跃 |
| 8 | 招生中心 | Enrollment Center | ✅ 活跃 |
| 9 | 任务中心 | Task Center | ✅ 活跃 |
| 10 | 教学中心 | Teaching Center | ✅ 活跃 |
| 11 | 话术中心 | Script Center | ✅ 活跃 |
| 12 | 新媒体中心 | Media Center | ✅ 活跃 |

### 已禁用的中心

| 中心名称 | 英文名称 | 状态 | 权限关联 |
|---------|---------|------|---------|
| 智能中心 | AI Center | ❌ 已禁用 | ✅ 已清除 |
| 数据分析中心 | Analytics Center | ❌ 已禁用 | ✅ 已清除 |
| 督查中心 | Inspection Center | ❌ 已禁用 | ✅ 已清除 |

## 工具脚本

### 检查脚本

```bash
# 检查所有中心配置
cd server && node check-center-names.js

# 检查已禁用中心的状态
cd server && node check-disabled-centers.js
```

### 清理脚本

```bash
# 清理已禁用中心的权限关联
cd server && node cleanup-disabled-centers.js

# 清除Redis缓存
cd server && node clear-permission-cache.js
```

## 预防措施

### 1. 禁用中心的标准流程

```sql
-- 1. 设置中心为禁用状态
UPDATE permissions SET status = 0 WHERE code = 'CENTER_CODE';

-- 2. 删除角色权限关联
DELETE FROM role_permissions 
WHERE permission_id = (SELECT id FROM permissions WHERE code = 'CENTER_CODE');

-- 3. 清除缓存
-- 运行: node clear-permission-cache.js
```

### 2. 前端映射维护

每次添加或修改中心时，确保更新 `client/src/layouts/components/Sidebar.vue` 中的 `nameMap`：

```typescript
const nameMap: Record<string, string> = {
  'English Name': '中文名称',
  // ...
};
```

### 3. 定期检查

建议每周运行一次检查脚本，确保数据一致性：

```bash
cd server
node check-center-names.js
node check-disabled-centers.js
```

## 相关文档

- [侧边栏页面说明](./docs/侧边栏/侧边栏页面说明.md)
- [快速参考](./docs/侧边栏/快速参考.md)
- [中心名称修复报告](./中心名称修复报告.md)

## 技术细节

### 后端权限过滤

后端API已经正确实现了 `status=1` 的过滤：

```typescript
// server/src/controllers/permissions.controller.ts
const permissions = await sequelize.query(`
  SELECT * FROM permissions 
  WHERE status = 1 AND type = 'category'
  ORDER BY sort
`);
```

### 前端中文名称获取

前端优先使用数据库的 `chineseName` 字段：

```typescript
const getChineseName = (item: any): string => {
  // 优先使用 chineseName 字段
  if (item && item.chineseName) {
    return item.chineseName;
  }
  
  // 降级使用映射表
  return nameMap[item.name] || item.name;
};
```

## 总结

本次修复解决了侧边栏显示英文名称的问题，主要通过：

1. ✅ 更新前端中英文映射表
2. ✅ 清理已禁用中心的角色权限关联
3. ✅ 清除Redis缓存
4. ✅ 提供完整的检查和清理工具

现在侧边栏应该只显示12个活跃的中心，全部为中文名称。

---

**修复时间**: 2025-10-07  
**修复人员**: AI Assistant (Augment Agent)  
**影响范围**: 侧边栏显示、权限系统、缓存系统

