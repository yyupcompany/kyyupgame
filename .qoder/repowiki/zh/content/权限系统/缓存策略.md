# ç¼“å­˜ç­–ç•¥

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨æ–‡ä»¶**   
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts)
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts)
- [redis.config.ts](file://k.yyup.com/server/src/config/redis.config.ts)
- [cache-invalidation.middleware.ts](file://k.yyup.com/backup/permission-system/cache-invalidation.middleware.ts)
- [route-cache.service.ts](file://k.yyup.com/backup/permission-system/route-cache.service.ts)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [ç¼“å­˜æ¶æ„è®¾è®¡](#ç¼“å­˜æ¶æ„è®¾è®¡)
3. [ç¼“å­˜é”®å‘½åè§„èŒƒ](#ç¼“å­˜é”®å‘½åè§„èŒƒ)
4. [æ•°æ®ç»“æ„é€‰æ‹©](#æ•°æ®ç»“æ„é€‰æ‹©)
5. [è¿‡æœŸç­–ç•¥](#è¿‡æœŸç­–ç•¥)
6. [æƒé™ç¼“å­˜åŠ è½½æœºåˆ¶](#æƒé™ç¼“å­˜åŠ è½½æœºåˆ¶)
7. [ç¼“å­˜å¤±æ•ˆç­–ç•¥](#ç¼“å­˜å¤±æ•ˆç­–ç•¥)
8. [ç¼“å­˜é˜²æŠ¤æªæ–½](#ç¼“å­˜é˜²æŠ¤æªæ–½)
9. [æ€§èƒ½ç›‘æ§æŒ‡æ ‡](#æ€§èƒ½ç›‘æ§æŒ‡æ ‡)
10. [ä»£ç å®ç°ç¤ºä¾‹](#ä»£ç å®ç°ç¤ºä¾‹)
11. [ç»“è®º](#ç»“è®º)

## å¼•è¨€
æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æƒé™ç³»ç»Ÿçš„Redisç¼“å­˜ç­–ç•¥ï¼Œæ¶µç›–ç¼“å­˜æ¶æ„è®¾è®¡ã€æ•°æ®ç»“æ„é€‰æ‹©ã€è¿‡æœŸç­–ç•¥ã€åŠ è½½æœºåˆ¶ã€å¤±æ•ˆç­–ç•¥ã€é˜²æŠ¤æªæ–½å’Œæ€§èƒ½ç›‘æ§ç­‰æ–¹é¢ã€‚é€šè¿‡åˆ†æä»£ç åº“ä¸­çš„ç›¸å…³æ–‡ä»¶ï¼Œæä¾›äº†å…¨é¢çš„ç¼“å­˜ç­–ç•¥æ–‡æ¡£ã€‚

## ç¼“å­˜æ¶æ„è®¾è®¡
æƒé™ç³»ç»Ÿçš„ç¼“å­˜æ¶æ„è®¾è®¡æ—¨åœ¨æé«˜ç³»ç»Ÿæ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼Œé€šè¿‡Redisç¼“å­˜ç”¨æˆ·æƒé™ã€è§’è‰²æƒé™ã€åŠ¨æ€è·¯ç”±ç­‰æ•°æ®ã€‚ç¼“å­˜æœåŠ¡åœ¨ç”¨æˆ·ç™»å½•æ—¶é¢„åŠ è½½æƒé™æ•°æ®ï¼Œå¹¶åœ¨æƒé™æ›´æ–°æ—¶ä¸»åŠ¨å¤±æ•ˆç¼“å­˜ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®æ—¶æ€§ã€‚

```mermaid
graph TD
A[ç”¨æˆ·ç™»å½•] --> B[é¢„åŠ è½½æƒé™æ•°æ®]
B --> C[ç¼“å­˜åˆ°Redis]
D[æƒé™æ›´æ–°] --> E[ä¸»åŠ¨å¤±æ•ˆç¼“å­˜]
E --> F[é‡æ–°åŠ è½½æ•°æ®]
G[ç”¨æˆ·è¯·æ±‚] --> H[æ£€æŸ¥ç¼“å­˜]
H --> I{ç¼“å­˜å‘½ä¸­?}
I --> |æ˜¯| J[è¿”å›ç¼“å­˜æ•°æ®]
I --> |å¦| K[æŸ¥è¯¢æ•°æ®åº“]
K --> L[æ›´æ–°ç¼“å­˜]
L --> J
```

**Diagram sources**
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L50-L134)
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts#L233-L281)

## ç¼“å­˜é”®å‘½åè§„èŒƒ
ç¼“å­˜é”®çš„å‘½åéµå¾ªä¸€å®šçš„è§„èŒƒï¼Œä»¥ç¡®ä¿é”®çš„å”¯ä¸€æ€§å’Œå¯è¯»æ€§ã€‚ä¸»è¦å‰ç¼€åŒ…æ‹¬ç”¨æˆ·æƒé™ã€è§’è‰²æƒé™ã€åŠ¨æ€è·¯ç”±ç­‰ã€‚

**ç¼“å­˜é”®å‰ç¼€**
- `user:permissions:` - ç”¨æˆ·æƒé™
- `role:permissions:` - è§’è‰²æƒé™
- `user:routes:` - åŠ¨æ€è·¯ç”±
- `permission:check:` - æƒé™æ£€æŸ¥
- `permission:path:` - è·¯å¾„æƒé™
- `user:permission:info:` - ç”¨æˆ·æƒé™ä¿¡æ¯

**Section sources**
- [redis.config.ts](file://k.yyup.com/server/src/config/redis.config.ts#L262-L299)

## æ•°æ®ç»“æ„é€‰æ‹©
æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹å’Œè®¿é—®æ¨¡å¼ï¼Œé€‰æ‹©äº†åˆé€‚çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç¼“å­˜æ•°æ®ã€‚

**æ•°æ®ç»“æ„é€‰æ‹©**
- **Hash**: ç”¨äºå­˜å‚¨å¤æ‚çš„å¯¹è±¡æ•°æ®ï¼Œå¦‚ç”¨æˆ·æƒé™ä¿¡æ¯ã€‚
- **Set**: ç”¨äºå­˜å‚¨é›†åˆæ•°æ®ï¼Œå¦‚ç”¨æˆ·æƒé™åˆ—è¡¨ã€‚

```mermaid
classDiagram
class UserPermissionInfo {
+string[] permissions
+string[] roles
+boolean isAdmin
}
class PermissionData {
+number id
+string name
+string chinese_name
+string code
+string type
+number parent_id
+string path
+string component
+string file_path
+string permission
+string icon
+number sort
+number status
}
UserPermissionInfo --> PermissionData : "åŒ…å«"
```

**Diagram sources**
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L19-L43)
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts#L342-L423)

## è¿‡æœŸç­–ç•¥
ç¼“å­˜æ•°æ®è®¾ç½®äº†åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥å¹³è¡¡æ•°æ®ä¸€è‡´æ€§å’Œç¼“å­˜å‘½ä¸­ç‡ã€‚

**è¿‡æœŸæ—¶é—´é…ç½®**
- `USER_PERMISSIONS`: 30åˆ†é’Ÿ
- `ROLE_PERMISSIONS`: 30åˆ†é’Ÿ
- `DYNAMIC_ROUTES`: 30åˆ†é’Ÿ
- `PERMISSION_CHECK`: 15åˆ†é’Ÿ
- `PATH_PERMISSION`: 15åˆ†é’Ÿ
- `USER_PERMISSION_INFO`: 30åˆ†é’Ÿ

**Section sources**
- [redis.config.ts](file://k.yyup.com/server/src/config/redis.config.ts#L196-L257)

## æƒé™ç¼“å­˜åŠ è½½æœºåˆ¶
åœ¨ç”¨æˆ·ç™»å½•æ—¶ï¼Œç³»ç»Ÿä¼šé¢„åŠ è½½ç”¨æˆ·çš„æƒé™æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼Œä»¥æé«˜åç»­è¯·æ±‚çš„å“åº”é€Ÿåº¦ã€‚

**åŠ è½½æœºåˆ¶**
1. ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œè°ƒç”¨`getUserPermissions`æ–¹æ³•ã€‚
2. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ç”¨æˆ·æƒé™æ•°æ®ã€‚
3. å¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç¼“å­˜æ•°æ®ã€‚
4. å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œä»æ•°æ®åº“æŸ¥è¯¢æƒé™æ•°æ®ã€‚
5. å°†æŸ¥è¯¢ç»“æœå†™å…¥ç¼“å­˜ã€‚

```mermaid
sequenceDiagram
participant User as "ç”¨æˆ·"
participant AuthService as "è®¤è¯æœåŠ¡"
participant CacheService as "ç¼“å­˜æœåŠ¡"
participant DB as "æ•°æ®åº“"
User->>AuthService : ç™»å½•
AuthService->>CacheService : è·å–ç”¨æˆ·æƒé™
CacheService->>CacheService : æ£€æŸ¥ç¼“å­˜
alt ç¼“å­˜å‘½ä¸­
CacheService-->>AuthService : è¿”å›ç¼“å­˜æ•°æ®
else ç¼“å­˜æœªå‘½ä¸­
CacheService->>DB : æŸ¥è¯¢æƒé™æ•°æ®
DB-->>CacheService : è¿”å›æŸ¥è¯¢ç»“æœ
CacheService->>CacheService : å†™å…¥ç¼“å­˜
CacheService-->>AuthService : è¿”å›æŸ¥è¯¢ç»“æœ
end
AuthService-->>User : ç™»å½•æˆåŠŸ
```

**Diagram sources**
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L50-L134)
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts#L233-L281)

## ç¼“å­˜å¤±æ•ˆç­–ç•¥
ç¼“å­˜å¤±æ•ˆç­–ç•¥åŒ…æ‹¬ä¸»åŠ¨å¤±æ•ˆå’Œè¢«åŠ¨å¤±æ•ˆï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®æ—¶æ€§ã€‚

**ä¸»åŠ¨å¤±æ•ˆ**
- **æƒé™æ›´æ–°**: å½“æƒé™æ•°æ®æ›´æ–°æ—¶ï¼Œä¸»åŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜ã€‚
- **è§’è‰²æ›´æ–°**: å½“è§’è‰²æ•°æ®æ›´æ–°æ—¶ï¼Œä¸»åŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜ã€‚

**è¢«åŠ¨å¤±æ•ˆ**
- **è¿‡æœŸæ—¶é—´åˆ°è¾¾**: ç¼“å­˜æ•°æ®åœ¨è¿‡æœŸæ—¶é—´åˆ°è¾¾åè‡ªåŠ¨å¤±æ•ˆã€‚

```mermaid
flowchart TD
A[æƒé™æ›´æ–°] --> B[æ¸…é™¤ç”¨æˆ·ç¼“å­˜]
B --> C[æ¸…é™¤è§’è‰²ç¼“å­˜]
D[è§’è‰²æ›´æ–°] --> E[æ¸…é™¤è§’è‰²ç¼“å­˜]
E --> F[æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç¼“å­˜]
G[è¿‡æœŸæ—¶é—´åˆ°è¾¾] --> H[è‡ªåŠ¨å¤±æ•ˆ]
```

**Diagram sources**
- [cache-invalidation.middleware.ts](file://k.yyup.com/backup/permission-system/cache-invalidation.middleware.ts#L68-L147)
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L462-L522)

## ç¼“å­˜é˜²æŠ¤æªæ–½
ä¸ºäº†é˜²æ­¢ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜é›ªå´©ï¼Œé‡‡å–äº†ç›¸åº”çš„é˜²æŠ¤æªæ–½ã€‚

**ç¼“å­˜ç©¿é€**
- **å¸ƒéš†è¿‡æ»¤å™¨**: ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤æ— æ•ˆè¯·æ±‚ï¼Œé¿å…æŸ¥è¯¢æ•°æ®åº“ã€‚

**ç¼“å­˜å‡»ç©¿**
- **äº’æ–¥é”**: åœ¨ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä½¿ç”¨äº’æ–¥é”ç¡®ä¿åªæœ‰ä¸€ä¸ªè¯·æ±‚æŸ¥è¯¢æ•°æ®åº“ï¼Œå…¶ä»–è¯·æ±‚ç­‰å¾…ã€‚

**ç¼“å­˜é›ªå´©**
- **éšæœºè¿‡æœŸæ—¶é—´**: ä¸ºç¼“å­˜è®¾ç½®éšæœºçš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆã€‚

```mermaid
flowchart TD
A[è¯·æ±‚] --> B{å¸ƒéš†è¿‡æ»¤å™¨}
B --> |å­˜åœ¨| C[æŸ¥è¯¢ç¼“å­˜]
B --> |ä¸å­˜åœ¨| D[è¿”å›ç©º]
C --> E{ç¼“å­˜å‘½ä¸­?}
E --> |æ˜¯| F[è¿”å›ç¼“å­˜æ•°æ®]
E --> |å¦| G[è·å–äº’æ–¥é”]
G --> H[æŸ¥è¯¢æ•°æ®åº“]
H --> I[æ›´æ–°ç¼“å­˜]
I --> J[é‡Šæ”¾é”]
J --> K[è¿”å›æ•°æ®]
```

**Diagram sources**
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts#L536-L599)
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L50-L134)

## æ€§èƒ½ç›‘æ§æŒ‡æ ‡
ä¸ºäº†ç›‘æ§ç¼“å­˜çš„æ€§èƒ½ï¼Œå®šä¹‰äº†ä»¥ä¸‹æŒ‡æ ‡ã€‚

**æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
- **å‘½ä¸­ç‡**: ç¼“å­˜å‘½ä¸­çš„è¯·æ±‚å æ€»è¯·æ±‚çš„æ¯”ä¾‹ã€‚
- **å¹³å‡å“åº”æ—¶é—´**: ç¼“å­˜è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´ã€‚
- **ç¼“å­˜å¤§å°**: ç¼“å­˜ä¸­å­˜å‚¨çš„æ•°æ®é‡ã€‚
- **ç¼“å­˜å‘½ä¸­æ¬¡æ•°**: ç¼“å­˜å‘½ä¸­çš„æ€»æ¬¡æ•°ã€‚
- **ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°**: ç¼“å­˜æœªå‘½ä¸­çš„æ€»æ¬¡æ•°ã€‚

**Section sources**
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L527-L567)

## ä»£ç å®ç°ç¤ºä¾‹
ä»¥ä¸‹æ˜¯ç¼“å­˜è¯»å–ã€å†™å…¥å’Œå¤±æ•ˆæ“ä½œçš„ä»£ç ç¤ºä¾‹ã€‚

**ç¼“å­˜è¯»å–**
```typescript
static async getUserPermissions(userId: number): Promise<string[]> {
  const cacheKey = `${RedisKeyPrefix.USER_PERMISSIONS}${userId}`;
  
  try {
    const cached = await RedisService.get<string[]>(cacheKey);
    if (cached && Array.isArray(cached)) {
      console.log(`âœ… å‘½ä¸­æƒé™ç¼“å­˜: ç”¨æˆ·${userId}, ${cached.length}ä¸ªæƒé™`);
      return cached;
    }
    
    // ä»æ•°æ®åº“æŸ¥è¯¢
    const permissions = await this.queryPermissionsFromDB(userId);
    
    // å†™å…¥ç¼“å­˜
    if (permissions.length > 0) {
      await RedisService.set(cacheKey, permissions, RedisTTL.USER_PERMISSIONS);
      console.log(`ğŸ’¾ æƒé™å·²ç¼“å­˜: ç”¨æˆ·${userId}, TTL=${RedisTTL.USER_PERMISSIONS}ç§’`);
    }
    
    return permissions;
  } catch (error) {
    console.error(`âŒ è·å–ç”¨æˆ·æƒé™å¤±è´¥: ç”¨æˆ·${userId}`, error);
    return [];
  }
}
```

**ç¼“å­˜å†™å…¥**
```typescript
static async setPermissions(userId: number, permissions: string[]): Promise<void> {
  const cacheKey = `${RedisKeyPrefix.USER_PERMISSIONS}${userId}`;
  await RedisService.set(cacheKey, permissions, RedisTTL.USER_PERMISSIONS);
}
```

**ç¼“å­˜å¤±æ•ˆ**
```typescript
static async clearUserCache(userId: number): Promise<void> {
  const patterns = [
    `${RedisKeyPrefix.USER_PERMISSIONS}${userId}`,
    `${RedisKeyPrefix.DYNAMIC_ROUTES}${userId}`,
    `${RedisKeyPrefix.USER_PERMISSION_INFO}${userId}`,
    `${RedisKeyPrefix.PERMISSION_CHECK}${userId}:*`,
    `${RedisKeyPrefix.PATH_PERMISSION}${userId}:*`
  ];
  
  for (const pattern of patterns) {
    if (pattern.includes('*')) {
      await RedisService.delPattern(pattern);
    } else {
      await RedisService.del(pattern);
    }
  }
}
```

**Section sources**
- [permission-cache.service.ts](file://k.yyup.com/backup/permission-system/permission-cache.service.ts#L50-L134)
- [redis.service.ts](file://k.yyup.com/server/src/services/redis.service.ts#L233-L281)
- [cache-invalidation.middleware.ts](file://k.yyup.com/backup/permission-system/cache-invalidation.middleware.ts#L68-L147)

## ç»“è®º
æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æƒé™ç³»ç»Ÿçš„Redisç¼“å­˜ç­–ç•¥ï¼ŒåŒ…æ‹¬ç¼“å­˜æ¶æ„è®¾è®¡ã€æ•°æ®ç»“æ„é€‰æ‹©ã€è¿‡æœŸç­–ç•¥ã€åŠ è½½æœºåˆ¶ã€å¤±æ•ˆç­–ç•¥ã€é˜²æŠ¤æªæ–½å’Œæ€§èƒ½ç›‘æ§ã€‚é€šè¿‡åˆç†çš„ç¼“å­˜è®¾è®¡ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ç³»ç»Ÿçš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦ï¼ŒåŒæ—¶ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®æ—¶æ€§ã€‚