# 性能监控与分析

<cite>
**本文档引用的文件**   
- [ai-performance-monitor.controller.js](file://k.yyup.com/server/dist/controllers/ai/ai-performance-monitor.controller.js)
- [ai-performance.routes.js](file://k.yyup.com/server/dist/routes/ai-performance.routes.js)
- [aggregate-api-performance-test.js](file://k.yyup.com/client/aggregate-api-performance-test.js)
- [performance-test-runner.js](file://k.yyup.com/scripts/performance-test-runner.js)
- [login-stress-test.js](file://k.yyup.com/login-stress-test.js)
- [performance.config.js](file://k.yyup.com/client/performance.config.js)
- [load-test.yml](file://k.yyup.com/tests/performance/load-test.yml)
</cite>

## 目录
1. [性能监控体系](#性能监控体系)
2. [性能测试框架使用方法](#性能测试框架使用方法)
3. [实时监控系统实现](#实时监控系统实现)
4. [性能数据分析方法](#性能数据分析方法)
5. [APM工具集成与使用](#apm工具集成与使用)
6. [具体监控案例](#具体监控案例)
7. [性能监控最佳实践](#性能监控最佳实践)

## 性能监控体系

k.yyupgame项目构建了完整的性能监控体系，主要包含系统状态监控、AI模型性能监控、性能日志记录和性能警报管理四大核心功能。系统通过`AIPerformanceMonitorController`类实现了对系统资源使用情况的全面监控，包括CPU、内存、GPU等关键指标的实时采集和分析。

监控体系采用分层架构设计，底层通过系统监控服务采集硬件资源数据，中间层对AI服务性能进行监控，上层提供RESTful API接口供前端调用。系统能够实时监控多个AI服务的性能指标，包括响应时间、成功率、每分钟请求数、错误率等关键性能指标。

监控数据的可视化通过API接口提供，支持多种时间范围的性能数据查询，包括1小时、6小时、24小时、7天和30天。系统还实现了性能数据刷新机制，能够定时更新监控数据，确保监控信息的实时性。性能日志功能记录了系统运行过程中的关键事件，包括API调用成功、警告和错误信息，便于问题追溯和分析。

**Section sources**
- [ai-performance-monitor.controller.js](file://k.yyup.com/server/dist/controllers/ai/ai-performance-monitor.controller.js)

## 性能测试框架使用方法

### 编写性能测试用例

性能测试框架提供了多种测试用例编写方式。对于API性能测试，可以使用`aggregate-api-performance-test.js`文件中的测试框架，该框架基于Puppeteer实现，能够模拟真实用户行为进行性能测试。测试用例需要定义测试配置，包括测试页面列表、测试轮次、超时时间等参数。

对于登录页面的压力测试，`login-stress-test.js`文件提供了完整的压力测试框架，支持快捷登录和管理员登录的并发测试。测试配置中定义了不同用户角色的测试场景，包括园长、教师、家长和管理员的登录测试。

### 运行性能测试

性能测试可以通过`performance-test-runner.js`脚本统一执行。该脚本支持命令行参数配置，可以灵活控制测试行为。运行测试的基本命令如下：

```bash
node scripts/performance-test-runner.js --environment=test --baseUrl=http://localhost:5173 --apiBaseUrl=http://localhost:3000
```

测试执行器会自动检查服务状态，确保前端和API服务正常运行后才开始测试。测试过程包括等待服务启动、运行负载测试、执行Lighthouse性能测试、生成综合报告等步骤。

### 分析测试结果

测试结果以JSON和Markdown两种格式保存，便于不同场景下的使用。综合性能报告包含测试概览、整体评分、负载测试结果和Lighthouse测试结果等部分。报告中的整体评分通过加权计算得出，考虑了负载测试和Lighthouse测试的多个维度。

测试结论部分会根据测试结果自动生成优化建议，如"✅ 系统整体性能良好，满足生产环境要求"或"⚠️ 系统性能一般，建议进行优化"。详细的测试数据包括响应时间分布、每秒请求数、核心Web指标等，为性能优化提供数据支持。

**Section sources**
- [performance-test-runner.js](file://k.yyup.com/scripts/performance-test-runner.js)
- [aggregate-api-performance-test.js](file://k.yyup.com/client/aggregate-api-performance-test.js)
- [login-stress-test.js](file://k.yyup.com/login-stress-test.js)

## 实时监控系统实现

### Prometheus指标收集

虽然项目中未直接实现Prometheus指标收集，但通过`ai-performance.routes.js`定义的API接口，可以轻松集成Prometheus监控系统。这些API接口遵循OpenAPI规范，提供了标准化的性能数据输出格式，便于Prometheus的抓取和处理。

监控接口包括系统状态概览、AI模型性能数据、性能日志、性能警报等，这些数据都可以作为Prometheus的指标来源。通过配置Prometheus的scrape配置，可以定期从这些API接口获取性能数据，并存储在Prometheus时序数据库中。

### Grafana仪表板配置

基于Prometheus收集的性能指标，可以配置Grafana仪表板进行数据可视化。虽然项目中未提供具体的Grafana配置文件，但通过分析API接口返回的数据结构，可以设计出相应的仪表板。

仪表板可以包含多个面板，如系统资源使用率面板（CPU、内存、GPU使用率）、AI服务性能面板（响应时间、成功率、错误率）、请求量面板（每分钟请求数、请求成功率）等。通过Grafana的告警功能，还可以基于这些指标设置告警规则，实现异常情况的及时通知。

**Section sources**
- [ai-performance.routes.js](file://k.yyup.com/server/dist/routes/ai-performance.routes.js)

## 性能数据分析方法

### 识别性能瓶颈

性能数据分析首先需要识别系统中的性能瓶颈。通过分析`performance-test-runner.js`生成的测试报告，可以识别出响应时间较长的API接口。报告中的95百分位和99百分位响应时间是识别性能瓶颈的重要指标，如果这些值明显高于平均响应时间，说明存在少数请求响应时间过长的问题。

对于前端性能，Lighthouse测试结果中的核心Web指标（FCP、LCP、CLS、TBT、TTI）可以帮助识别前端性能瓶颈。例如，如果LCP（最大内容绘制）时间过长，可能需要优化关键资源的加载顺序或实现懒加载。

### 定位性能问题根源

定位性能问题根源需要结合多种数据进行分析。首先查看性能日志，通过日志中的错误信息和警告信息定位问题。然后分析API请求的响应时间分布，如果发现特定时间段内响应时间突然增加，可能是数据库查询性能下降或外部服务响应变慢导致。

对于数据库性能问题，可以通过分析SQL查询执行计划来定位慢查询。对于外部API调用问题，可以检查网络延迟和外部服务的响应时间。通过`login-stress-test.js`中的压力测试结果，还可以分析在高并发情况下的系统表现，识别出系统在压力下的性能退化情况。

**Section sources**
- [performance-test-runner.js](file://k.yyup.com/scripts/performance-test-runner.js)
- [login-stress-test.js](file://k.yyup.com/login-stress-test.js)

## APM工具集成与使用

项目中的性能监控体系本质上是一个自研的APM（应用性能管理）工具。通过`ai-performance-monitor.controller.js`实现的监控功能涵盖了APM的核心功能，包括应用性能监控、错误追踪、事务追踪等。

APM工具的使用主要通过API接口进行。前端应用可以通过调用`/api/ai/performance/system-status`接口获取系统状态，通过`/api/ai/performance/models`接口获取AI模型性能数据。这些接口需要JWT认证，确保只有授权用户才能访问性能数据。

APM工具还提供了性能数据导出功能，支持JSON、CSV、PDF等多种格式，便于性能数据的进一步分析和报告生成。通过`/api/ai/performance/export`接口，可以按指定时间范围导出性能报告，用于性能趋势分析和历史数据对比。

**Section sources**
- [ai-performance-monitor.controller.js](file://k.yyup.com/server/dist/controllers/ai/ai-performance-monitor.controller.js)
- [ai-performance.routes.js](file://k.yyup.com/server/dist/routes/ai-performance.routes.js)

## 具体监控案例

### 系统负载监控

系统负载监控通过`getSystemStatus`方法实现，该方法采集CPU使用率、内存使用率、GPU使用率等关键指标。系统根据这些指标计算整体状态，当CPU使用率超过80%、内存使用率超过85%或GPU使用率超过90%时，系统状态会标记为"warning"。

监控数据通过`/api/ai/performance/system-status`接口提供，前端可以定期调用该接口获取系统状态，并在仪表板上显示系统资源使用情况的实时图表。

### API响应时间监控

API响应时间监控是性能监控的核心内容之一。通过`getAIModelsPerformance`方法，系统监控多个AI服务的API响应时间。监控数据包括平均响应时间、响应时间分布（最小值、中位数、95百分位、99百分位、最大值）等。

`load-test.yml`配置文件定义了负载测试的场景，包括不同并发级别的用户行为模拟。通过Artillery工具执行这些测试，可以获取API在不同负载下的响应时间数据，用于评估系统的性能容量。

### 数据库性能监控

虽然项目中未直接实现数据库性能监控，但通过分析API响应时间和系统日志，可以间接监控数据库性能。当API响应时间突然增加时，很可能是数据库查询性能下降导致。

在`performance.config.js`中配置的性能预算也包含了数据库相关的优化建议，如为用户查询和权限检查创建适当的索引，优化数据库连接池配置等，这些措施有助于提升数据库性能。

**Section sources**
- [ai-performance-monitor.controller.js](file://k.yyup.com/server/dist/controllers/ai/ai-performance-monitor.controller.js)
- [load-test.yml](file://k.yyup.com/tests/performance/load-test.yml)
- [performance.config.js](file://k.yyup.com/client/performance.config.js)

## 性能监控最佳实践

### 关键性能指标设置

项目中通过`performanceBudget`对象定义了性能预算，这是设置关键性能指标的最佳实践。性能预算包括资源大小限制、性能指标限制和网络条件限制三个维度。

资源大小限制规定了JavaScript包、CSS文件和图片的大小上限，有助于控制页面加载时间。性能指标限制定义了首屏加载时间、最大内容绘制时间、首次输入延迟和累积布局偏移的目标值，这些是Google推荐的核心Web指标。

### 告警阈值配置

告警阈值的配置在`calculateSystemStatus`方法中体现。系统为CPU、内存和GPU使用率设置了不同的阈值，当资源使用率超过阈值时触发相应的告警。这种基于阈值的告警机制简单有效，能够及时发现系统资源使用异常。

对于AI服务性能监控，系统还实现了基于时间范围的动态阈值调整，能够根据历史数据自动调整告警阈值，减少误报和漏报。

### 性能趋势分析

性能趋势分析通过定期执行性能测试并保存历史数据来实现。`performance-test-runner.js`生成的测试报告包含时间戳，可以用于对比不同时间点的性能数据。

通过分析性能数据的历史趋势，可以识别出系统性能的长期变化规律，如随着用户量增加性能逐渐下降，或在特定时间段内性能出现周期性波动。这些趋势分析结果对于容量规划和性能优化具有重要指导意义。

**Section sources**
- [performance.config.js](file://k.yyup.com/client/performance.config.js)
- [ai-performance-monitor.controller.js](file://k.yyup.com/server/dist/controllers/ai/ai-performance-monitor.controller.js)
- [performance-test-runner.js](file://k.yyup.com/scripts/performance-test-runner.js)