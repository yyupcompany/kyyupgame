# 数据源管理

<cite>
**本文档引用的文件**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [database-initialization.ts](file://database-initialization.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档详细介绍了k.yyupgame项目中多租户数据源管理的实现机制，重点阐述了租户数据库连接池的设计与实现。文档涵盖了共享连接池服务的管理机制、租户数据库初始化流程、连接池性能优化策略以及高并发场景下的稳定性保障措施。通过本指南，开发者可以深入了解系统如何高效管理多个租户的数据库连接，并掌握最佳实践。

## 项目结构
项目采用模块化设计，将多租户数据源管理功能分散在多个核心文件中。主要组件包括共享连接池服务、租户解析中间件、数据库初始化脚本和租户创建工具。

```mermaid
graph TD
A[多租户数据源管理] --> B[tenant-database-shared-pool.service.ts]
A --> C[create-tenant-database.ts]
A --> D[tenant-resolver-shared-pool.middleware.ts]
A --> E[database-initialization.ts]
B --> F[共享连接池管理]
C --> G[租户数据库初始化]
D --> H[租户识别与路由]
E --> I[应用启动时初始化]
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L1-L177)
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts#L1-L165)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L1-L142)
- [database-initialization.ts](file://database-initialization.ts#L1-L89)

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L1-L177)
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts#L1-L165)

## 核心组件
系统的核心是`TenantDatabaseSharedPoolService`类，它实现了共享连接池模式，所有租户共享同一个数据库连接池。该服务通过完整的表名访问不同租户的数据库，避免了为每个租户维护独立连接池的资源开销。

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L9-L173)

## 架构概述
系统采用共享连接池架构，所有租户共用一个全局数据库连接池。当请求到达时，租户解析中间件根据域名识别租户，并将对应的数据库连接附加到请求对象上。这种设计既保证了租户间的数据隔离，又最大限度地利用了数据库连接资源。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Middleware as 租户解析中间件
participant Service as 共享池服务
participant DB as 数据库
Client->>Middleware : 发送请求(k001.yyup.cc)
Middleware->>Middleware : 提取租户代码k001
Middleware->>Service : 获取全局连接
Service->>Service : 初始化连接池(若未初始化)
Service-->>Middleware : 返回共享连接
Middleware->>Client : 设置租户信息并继续
Client->>Service : 执行数据库查询
Service->>Service : 修改SQL添加数据库前缀
Service->>DB : 执行查询(tenant_k001.users)
DB-->>Service : 返回结果
Service-->>Client : 返回查询结果
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L9-L173)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L26-L97)

## 详细组件分析

### 共享连接池服务分析
`TenantDatabaseSharedPoolService`实现了单例模式的全局连接池管理，提供连接的创建、复用和销毁功能。

#### 连接池管理机制
```mermaid
classDiagram
class TenantDatabaseSharedPoolService {
-globalConnection : Sequelize
+initializeGlobalConnection() : Promise~Sequelize~
+getGlobalConnection() : Sequelize
+queryTenantDatabase(tenantCode, sql, options) : Promise~any~
+getPoolStats() : Promise~any~
+healthCheck() : Promise~boolean~
+closeGlobalConnection() : Promise~void~
-prependTenantDatabase(sql, tenantCode) : string
}
TenantDatabaseSharedPoolService --> Sequelize : "使用"
TenantDatabaseSharedPoolService --> logger : "使用"
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L9-L173)

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L9-L173)

#### 租户数据库初始化流程
```mermaid
flowchart TD
Start([开始创建租户]) --> ValidateInput["验证输入参数"]
ValidateInput --> InputValid{"参数有效?"}
InputValid --> |否| ReturnError["返回错误"]
InputValid --> |是| CreateDatabase["创建数据库"]
CreateDatabase --> CopyStructure["复制模板结构"]
CopyStructure --> GetTables["获取模板表列表"]
GetTables --> CreateTable["创建租户表"]
CreateTable --> VerifySuccess{"创建成功?"}
VerifySuccess --> |否| HandleError["记录错误"]
VerifySuccess --> |是| NextTable["下一个表?"]
NextTable --> |是| CreateTable
NextTable --> |否| VerifyDatabase["验证数据库"]
VerifyDatabase --> Success["返回成功"]
ReturnError --> End([结束])
Success --> End
HandleError --> End
```

**Diagram sources**
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts#L27-L165)

**Section sources**
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts#L1-L165)

## 依赖分析
系统各组件之间存在明确的依赖关系，形成了清晰的调用链路。

```mermaid
graph LR
A[database-initialization.ts] --> B[tenant-database-shared-pool.service.ts]
C[tenant-resolver-shared-pool.middleware.ts] --> B
D[应用主程序] --> A
B --> E[Sequelize]
B --> F[logger]
C --> G[ApiResponse]
C --> F
style A fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#f96,stroke:#333
```

**Diagram sources**
- [database-initialization.ts](file://database-initialization.ts#L6-L89)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L6-L177)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L7-L142)

**Section sources**
- [database-initialization.ts](file://database-initialization.ts#L1-L89)

## 性能考虑
系统在设计时充分考虑了性能优化，通过多种机制确保连接池的高效运行。

### 连接池配置参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 最大连接数(DB_POOL_MAX) | 30 | 连接池中允许的最大连接数量 |
| 最小连接数(DB_POOL_MIN) | 5 | 连接池中保持的最小空闲连接数 |
| 获取连接超时(acquire) | 30000ms | 从池中获取连接的最大等待时间 |
| 空闲连接超时(idle) | 10000ms | 连接在池中保持空闲的最大时间 |

### 健康检查机制
系统定期执行健康检查，确保连接池的可用性。`healthCheck()`方法会尝试验证数据库连接，如果失败则记录错误日志，便于及时发现和解决问题。

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L141-L153)

## 故障排除指南
当遇到数据库连接相关问题时，可以按照以下步骤进行排查：

1. **检查环境变量配置**：确保`DB_HOST`、`DB_PORT`、`DB_USER`、`DB_PASSWORD`等环境变量正确设置
2. **验证连接池状态**：调用`getPoolStats()`方法检查连接池的活跃和空闲连接数
3. **执行健康检查**：调用`healthCheck()`方法验证数据库连接的可用性
4. **查看日志信息**：检查应用日志中是否有数据库连接相关的错误信息

```mermaid
graph TD
A[连接问题] --> B{检查环境变量}
B --> |配置正确| C{检查连接池状态}
B --> |配置错误| D[修正环境变量]
C --> |连接池正常| E{执行健康检查}
C --> |连接池异常| F[重启连接池]
E --> |健康检查通过| G[检查应用逻辑]
E --> |健康检查失败| H[检查数据库服务]
D --> I[重新初始化]
F --> I
H --> I
I --> J[问题解决]
```

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L141-L153)
- [database-initialization.ts](file://database-initialization.ts#L13-L41)

## 结论
本项目通过共享连接池机制实现了高效的多租户数据源管理。`TenantDatabaseSharedPoolService`提供了稳定的连接池管理功能，`create-tenant-database.ts`脚本简化了租户数据库的初始化过程，而`tenant-resolver-shared-pool.middleware.ts`则实现了无缝的租户识别和路由。这种架构设计在保证数据隔离的同时，最大限度地优化了数据库连接资源的使用，为系统的高并发处理能力提供了坚实的基础。