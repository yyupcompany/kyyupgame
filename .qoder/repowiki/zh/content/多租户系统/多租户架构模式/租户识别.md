# 租户识别

<cite>
**本文档引用的文件**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)
- [k.yyup.com/server/src/services/tenant-database.service.ts](file://k.yyup.com/server/src/services/tenant-database.service.ts)
- [k.yyup.com/server/src/services/tenant-token.service.ts](file://k.yyup.com/server/src/services/tenant-token.service.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [租户识别机制概述](#租户识别机制概述)
3. [租户解析中间件实现](#租户解析中间件实现)
4. [租户验证与数据库连接](#租户验证与数据库连接)
5. [租户安全验证机制](#租户安全验证机制)
6. [错误处理与HTTP状态码](#错误处理与http状态码)
7. [多租户环境下的请求路由](#多租户环境下的请求路由)
8. [租户识别中间件调用流程](#租户识别中间件调用流程)

## 项目结构

本项目采用多租户架构，核心租户识别相关文件位于项目根目录和k.yyup.com子目录中。主要包含租户解析中间件、数据库服务、安全验证等模块。

```mermaid
graph TD
A[租户识别系统] --> B[租户解析中间件]
A --> C[租户数据库服务]
A --> D[租户安全验证]
A --> E[租户令牌服务]
B --> F[tenant-resolver-shared-pool.middleware.ts]
B --> G[k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts]
C --> H[tenant-database-shared-pool.service.ts]
C --> I[k.yyup.com/server/src/services/tenant-database.service.ts]
D --> J[k.yyup.com/server/src/middlewares/tenant-security.middleware.ts]
E --> K[k.yyup.com/server/src/services/tenant-token.service.ts]
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)
- [k.yyup.com/server/src/services/tenant-database.service.ts](file://k.yyup.com/server/src/services/tenant-database.service.ts)
- [k.yyup.com/server/src/services/tenant-token.service.ts](file://k.yyup.com/server/src/services/tenant-token.service.ts)

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

## 租户识别机制概述

本项目采用基于域名的租户识别机制，通过共享连接池模式实现多租户数据隔离。系统根据HTTP请求的Host头或域名来识别租户，支持多种域名格式的租户代码提取。

租户识别流程包括：
1. 从HTTP请求头或域名中提取租户标识符
2. 验证租户的有效性并与数据库记录匹配
3. 设置租户上下文信息
4. 建立数据库连接
5. 执行安全验证

系统支持两种主要的域名格式：
- `k001.yyup.cc` → 租户代码：k001
- `tenant1.kindergarten.com` → 租户代码：tenant1

```mermaid
flowchart TD
Start([开始]) --> Extract["提取租户代码"]
Extract --> Validate["验证租户存在性"]
Validate --> Exists{"租户存在?"}
Exists --> |是| SetContext["设置租户上下文"]
Exists --> |否| ReturnError["返回错误"]
SetContext --> GetConnection["获取数据库连接"]
GetConnection --> Success["租户识别成功"]
ReturnError --> End([结束])
Success --> End
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L103-L119)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts#L120-L138)

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)

## 租户解析中间件实现

租户解析中间件负责从HTTP请求中提取租户标识符并进行初步验证。系统提供了两种实现方式：`tenant-resolver-shared-pool.middleware.ts`和`tenant-resolver.middleware.ts`，两者功能相似但位于不同位置。

### 租户代码提取逻辑

中间件通过正则表达式从域名中提取租户代码，支持以下格式：

```mermaid
flowchart TD
A[获取域名] --> B{移除端口号}
B --> C{匹配k001.yyup.cc格式?}
C --> |是| D[提取k001]
C --> |否| E{匹配tenant1.kindergarten.com格式?}
E --> |是| F[提取tenant1]
E --> |否| G[返回null]
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L103-L119)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts#L120-L138)

### 租户解析流程

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Middleware as "租户解析中间件"
participant Service as "租户数据库服务"
Client->>Middleware : HTTP请求(Host : k001.yyup.cc)
Middleware->>Middleware : 提取租户代码(k001)
alt 租户代码有效
Middleware->>Service : 验证租户存在性
Service-->>Middleware : 验证结果
alt 验证通过
Middleware->>Middleware : 设置租户上下文
Middleware->>Service : 获取共享数据库连接
Service-->>Middleware : 返回连接
Middleware->>Client : 继续处理请求
else 验证失败
Middleware->>Client : 返回404错误
end
else 租户代码无效
Middleware->>Client : 返回400错误
end
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L30-L96)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts#L25-L113)

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)

## 租户验证与数据库连接

### 租户验证机制

系统通过`validateTenant`函数验证租户的有效性。在生产环境中，该函数会调用统一租户中心API进行验证；在开发环境中，采用简化验证逻辑。

```mermaid
flowchart TD
A[开始验证] --> B{开发环境?}
B --> |是| C{租户代码为k001?}
C --> |是| D[验证通过]
C --> |否| E[调用统一租户API]
B --> |否| E
E --> F{API调用成功?}
F --> |是| G{租户状态为激活?}
G --> |是| H[验证通过]
G --> |否| I[验证失败]
F --> |否| J{开发环境且租户为k001?}
J --> |是| D
J --> |否| I
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L126-L137)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts#L144-L177)

### 数据库连接管理

系统采用共享连接池模式，所有租户共享一个全局数据库连接池。通过`tenantDatabaseSharedPoolService`服务管理连接。

```mermaid
classDiagram
class TenantDatabaseSharedPoolService {
-globalConnection : Sequelize
+initializeGlobalConnection() : Promise~Sequelize~
+getGlobalConnection() : Sequelize
+queryTenantDatabase(tenantCode, sql, options) : Promise~any~
+getPoolStats() : Promise~any~
+healthCheck() : Promise~boolean~
+closeGlobalConnection() : Promise~void~
}
class TenantDatabaseService {
-globalConnection : Sequelize
-isInitialized : boolean
-initPromise : Promise~Sequelize~
+initializeGlobalConnection() : Promise~Sequelize~
+getGlobalConnection() : Sequelize
+getTenantConnection(tenantCode) : Promise~Sequelize~
+getFullTableName(tenantCode, tableName) : string
+closeGlobalConnection() : Promise~void~
+getPoolStats() : Promise~PoolStats~
+healthCheck() : Promise~{healthy : boolean, details : any}~
}
TenantDatabaseSharedPoolService <|-- TenantDatabaseService : "继承"
```

**图示来源**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [k.yyup.com/server/src/services/tenant-database.service.ts](file://k.yyup.com/server/src/services/tenant-database.service.ts)

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/services/tenant-database.service.ts](file://k.yyup.com/server/src/services/tenant-database.service.ts)

## 租户安全验证机制

系统通过`tenant-security.middleware.ts`实现租户安全验证，防止数据泄露和越权访问。

### 安全验证流程

```mermaid
sequenceDiagram
participant Middleware as "租户安全中间件"
participant TokenService as "租户令牌服务"
participant Client as "客户端"
Client->>Middleware : HTTP请求
Middleware->>Middleware : 验证租户信息存在
alt 租户信息缺失
Middleware->>Client : 返回401错误
else 租户信息存在
Middleware->>Middleware : 验证域名与租户匹配
alt 域名不匹配
Middleware->>Client : 返回403错误
else 域名匹配
Middleware->>TokenService : 验证MD5租户令牌
alt 存在令牌
TokenService-->>Middleware : 验证结果
alt 验证失败
Middleware->>Client : 返回401错误
else 验证成功
Middleware->>Middleware : 记录安全信息
end
end
Middleware->>Middleware : 验证JWT令牌(可选)
Middleware->>Middleware : 记录审计日志
Middleware->>Client : 继续处理请求
end
end
```

**图示来源**
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)

### 租户数据访问控制

系统通过`tenantDataAccessMiddleware`确保用户只能访问自己租户的数据，防止越权访问。

```mermaid
flowchart TD
A[开始] --> B{存在租户安全信息?}
B --> |否| C[返回401错误]
B --> |是| D{URL中包含租户参数?}
D --> |否| E[继续处理]
D --> |是| F{参数与验证租户匹配?}
F --> |是| E
F --> |否| G[记录越权访问尝试]
G --> H[返回403错误]
```

**图示来源**
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts#L184-L222)

**本节来源**
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)

## 错误处理与HTTP状态码

系统定义了完整的错误处理机制，针对不同场景返回适当的HTTP状态码和错误信息。

### 错误类型与状态码

| 错误类型 | HTTP状态码 | 错误代码 | 错误信息 |
|---------|----------|---------|---------|
| 无法识别租户域名 | 400 | INVALID_TENANT_DOMAIN | 无法识别的租户域名 |
| 租户不存在或未激活 | 404 | TENANT_NOT_FOUND | 租户不存在或未激活 |
| 数据库连接失败 | 500 | DB_CONNECTION_FAILED | 数据库连接失败 |
| 租户验证失败 | 401 | TENANT_VALIDATION_FAILED | 租户验证失败 |
| 域名与租户不匹配 | 403 | DOMAIN_TENANT_MISMATCH | 域名与租户代码不匹配 |
| 租户令牌无效 | 401 | TENANT_TOKEN_INVALID | 租户令牌验证失败 |
| 数据访问被拒绝 | 403 | TENANT_DATA_ACCESS_DENIED | 无权访问此租户数据 |
| 租户解析失败 | 500 | TENANT_RESOLVER_ERROR | 租户解析失败 |

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)

## 多租户环境下的请求路由

系统通过中间件链实现多租户环境下的请求正确分发。

### 请求处理流程

```mermaid
flowchart TD
A[HTTP请求] --> B[租户解析中间件]
B --> C{成功识别租户?}
C --> |是| D[设置租户上下文]
C --> |否| E[返回错误响应]
D --> F[租户安全验证中间件]
F --> G{安全验证通过?}
G --> |是| H[租户数据访问控制]
G --> |否| E
H --> I{访问控制通过?}
I --> |是| J[业务逻辑处理]
I --> |否| E
J --> K[返回响应]
E --> K
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)

### 租户上下文传递

系统通过扩展Request对象实现租户上下文的传递：

```typescript
interface RequestWithTenant extends Request {
  tenant?: {
    code: string;
    domain: string;
    databaseName: string;
  };
  tenantDb?: any; // 共享的全局数据库连接
}
```

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L14-L21)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts#L18-L20)

## 租户识别中间件调用流程

### 中间件调用顺序

系统按照特定顺序调用租户识别相关中间件，确保请求处理的正确性和安全性。

```mermaid
sequenceDiagram
participant App as "应用入口"
participant Resolver as "租户解析中间件"
participant Security as "租户安全中间件"
participant DataAccess as "数据访问控制"
participant Controller as "业务控制器"
App->>Resolver : 调用tenantResolverMiddleware
Resolver->>Resolver : 提取租户代码
Resolver->>Resolver : 验证租户
Resolver->>Resolver : 设置租户上下文
alt 验证成功
Resolver->>Security : 调用tenantSecurityMiddleware
Security->>Security : 验证租户安全
Security->>Security : 验证令牌
Security->>DataAccess : 调用tenantDataAccessMiddleware
DataAccess->>DataAccess : 验证数据访问权限
DataAccess->>Controller : 调用业务控制器
Controller-->>App : 返回响应
else 验证失败
Resolver-->>App : 返回错误响应
end
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-security.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-security.middleware.ts)

### 不同场景下的租户识别

#### API调用场景

```mermaid
sequenceDiagram
participant Client as "API客户端"
participant Gateway as "API网关"
participant Resolver as "租户解析"
participant DB as "数据库"
Client->>Gateway : API请求(Host : k001.yyup.cc)
Gateway->>Resolver : 调用租户解析中间件
Resolver->>Resolver : 提取租户代码k001
Resolver->>Resolver : 验证租户存在性
Resolver->>DB : 获取共享数据库连接
DB-->>Resolver : 返回连接
Resolver->>Gateway : 设置租户上下文
Gateway->>DB : 执行SQL查询(tenant_k001.users)
DB-->>Gateway : 返回查询结果
Gateway-->>Client : 返回API响应
```

#### WebSocket连接场景

```mermaid
sequenceDiagram
participant Client as "WebSocket客户端"
participant Server as "WebSocket服务器"
participant Resolver as "租户解析"
participant DB as "数据库"
Client->>Server : WebSocket连接(ws : //k001.yyup.cc)
Server->>Resolver : 解析连接URL
Resolver->>Resolver : 提取租户代码k001
Resolver->>Resolver : 验证租户
Resolver->>DB : 获取数据库连接
DB-->>Resolver : 返回连接
Resolver->>Server : 设置租户上下文
Server->>Client : 连接建立成功
loop 消息通信
Client->>Server : 发送消息
Server->>DB : 根据租户上下文查询数据
DB-->>Server : 返回数据
Server-->>Client : 发送响应
end
```

**图示来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

**本节来源**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)