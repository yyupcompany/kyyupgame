# 配置管理

<cite>
**本文档引用文件**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/config/database.config.ts](file://k.yyup.com/server/src/config/database.config.ts)
- [k.yyup.com/server/src/services/tenant-base-data-init.service.ts](file://k.yyup.com/server/src/services/tenant-base-data-init.service.ts)
- [k.yyup.com/server/src/routes/tenant.routes.ts](file://k.yyup.com/server/src/routes/tenant.routes.ts)
- [k.yyup.com/server/src/controllers/config.controller.ts](file://k.yyup.com/server/src/controllers/config.controller.ts)
- [k.yyup.com/server/src/middleware/tenant-resolver.middleware.ts](file://k.yyup.com/server/src/middleware/tenant-resolver.middleware.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [租户配置存储机制](#租户配置存储机制)
3. [多租户数据隔离策略](#多租户数据隔离策略)
4. [租户上下文解析流程](#租户上下文解析流程)
5. [配置管理API设计](#配置管理api设计)
6. [配置缓存策略](#配置缓存策略)
7. [配置管理最佳实践](#配置管理最佳实践)

## 项目结构

本项目采用微服务架构，配置管理系统主要分布在服务器端的`src`目录下。核心配置管理功能集中在`config`、`services`、`controllers`和`middleware`等模块中。

```mermaid
graph TB
subgraph "配置管理核心"
A[tenant-resolver-shared-pool.middleware.ts] --> B[tenant-database-shared-pool.service.ts]
B --> C[database.config.ts]
A --> D[config.controller.ts]
D --> E[tenant-base-data-init.service.ts]
end
subgraph "API接口层"
F[tenant.routes.ts] --> D
G[config.routes.ts] --> D
end
subgraph "数据存储层"
H[(MySQL数据库)]
B --> H
end
A --> I[请求处理流程]
D --> J[配置CRUD操作]
```

**图示来源**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [k.yyup.com/server/src/config/database.config.ts](file://k.yyup.com/server/src/config/database.config.ts)

## 租户配置存储机制

### 配置数据存储结构

租户配置数据采用多租户共享连接池架构，所有租户共享一个全局数据库连接池，通过数据库前缀实现数据隔离。每个租户拥有独立的数据库实例，命名格式为`tenant_{租户代码}`。

```mermaid
classDiagram
class TenantDatabaseSharedPoolService {
-globalConnection : Sequelize
+initializeGlobalConnection() : Promise~Sequelize~
+getGlobalConnection() : Sequelize
+queryTenantDatabase(tenantCode, sql, options) : Promise~any~
+prependTenantDatabase(sql, tenantCode) : string
+getPoolStats() : Promise~any~
+healthCheck() : Promise~boolean~
+closeGlobalConnection() : Promise~void~
}
class TenantDatabaseConfig {
+host : string
+port : number
+username : string
+password : string
+database : string
+dialect : string
+pool : PoolConfig
}
class PoolConfig {
+max : number
+min : number
+acquire : number
+idle : number
}
TenantDatabaseSharedPoolService --> PoolConfig : "包含"
TenantDatabaseSharedPoolService --> TenantDatabaseConfig : "使用"
```

**图示来源**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L9-L177)

**本节来源**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L1-L177)

## 多租户数据隔离策略

### 数据隔离实现机制

系统采用数据库级隔离策略，每个租户拥有独立的数据库实例，确保数据完全隔离。通过`TenantDatabaseSharedPoolService`类实现共享连接池管理，所有租户共享同一个连接池资源，但访问各自的数据库。

#### SQL语句重写机制

在执行SQL查询时，系统会自动重写SQL语句，为表名添加租户数据库前缀：

```mermaid
flowchart TD
A[原始SQL] --> B{"识别表名"}
B --> C[users]
B --> D[roles]
B --> E[permissions]
B --> F[classes]
C --> G[替换为 tenant_k001.users]
D --> H[替换为 tenant_k001.roles]
E --> I[替换为 tenant_k001.permissions]
F --> J[替换为 tenant_k001.classes]
G --> K[执行修改后的SQL]
H --> K
I --> K
J --> K
K --> L[返回查询结果]
```

**图示来源**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L78-L123)

### 连接池配置

系统通过环境变量配置连接池参数，支持动态调整：

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 最大连接数 | DB_POOL_MAX | 30 | 连接池最大连接数量 |
| 最小连接数 | DB_POOL_MIN | 5 | 连接池最小连接数量 |
| 获取连接超时 | 无 | 30000ms | 获取连接的超时时间 |
| 空闲连接超时 | 无 | 10000ms | 空闲连接的超时时间 |

**本节来源**  
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts#L20-L36)

## 租户上下文解析流程

### 请求处理中的租户解析

`tenant-resolver-shared-pool.middleware.ts`中间件负责在请求处理过程中解析和注入租户上下文。该中间件在每个请求到达时执行，完成租户识别、验证和上下文设置。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Middleware as 租户解析中间件
participant Service as 数据库服务
participant Response as 响应
Client->>Middleware : 发送HTTP请求
Middleware->>Middleware : 获取Host头信息
Middleware->>Middleware : 提取租户代码
alt 租户代码有效
Middleware->>Middleware : 验证租户存在性
alt 租户存在
Middleware->>Service : 获取全局数据库连接
Service-->>Middleware : 返回连接实例
Middleware->>Middleware : 设置租户上下文
Middleware->>Response : 调用下一个中间件
else 租户不存在
Middleware->>Response : 返回404错误
end
else 租户代码无效
alt 生产环境
Middleware->>Response : 返回400错误
else 开发环境
Middleware->>Middleware : 使用默认租户配置
Middleware->>Response : 调用下一个中间件
end
end
```

**图示来源**  
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L26-L97)

### 租户代码提取规则

系统支持多种域名格式的租户代码提取：

```mermaid
flowchart TD
A[请求域名] --> B{"匹配格式"}
B --> C[k001.yyup.cc]
B --> D[kindergarten.kyyup.com]
B --> E[其他格式]
C --> F[提取k001]
D --> G[提取kindergarten]
E --> H[返回null]
F --> I[返回租户代码]
G --> I
H --> J[处理无效租户]
```

**本节来源**  
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts#L103-L120)

## 配置管理API设计

### 配置项CRUD操作

系统提供完整的配置项增删改查RESTful API接口，支持对租户配置进行全生命周期管理。

```mermaid
classDiagram
class ConfigController {
+createConfig(req, res) : Promise~void~
+getConfig(req, res) : Promise~void~
+updateConfig(req, res) : Promise~void~
+deleteConfig(req, res) : Promise~void~
+listConfigs(req, res) : Promise~void~
+batchUpdateConfigs(req, res) : Promise~void~
}
class ConfigService {
+create(tenantCode, configData) : Promise~Config~
+findByKey(tenantCode, key) : Promise~Config~
+update(tenantCode, key, configData) : Promise~Config~
+delete(tenantCode, key) : Promise~boolean~
+listAll(tenantCode) : Promise~Config[]~
+batchUpdate(tenantCode, configs) : Promise~Config[]~
}
class ConfigModel {
+id : string
+tenantCode : string
+key : string
+value : any
+type : string
+encrypted : boolean
+version : number
+createdAt : Date
+updatedAt : Date
}
ConfigController --> ConfigService : "调用"
ConfigService --> ConfigModel : "操作"
```

**图示来源**  
- [k.yyup.com/server/src/controllers/config.controller.ts](file://k.yyup.com/server/src/controllers/config.controller.ts)
- [k.yyup.com/server/src/services/config.service.ts](file://k.yyup.com/server/src/services/config.service.ts)

### 配置版本管理

系统实现配置版本控制机制，每次配置更新都会创建新版本，保留历史记录：

```mermaid
stateDiagram-v2
[*] --> 初始状态
初始状态 --> 创建配置 : createConfig()
创建配置 --> 活跃版本 : version=1
活跃版本 --> 更新配置 : updateConfig()
更新配置 --> 新版本 : version+1
新版本 --> 活跃版本
活跃版本 --> 删除配置 : deleteConfig()
删除配置 --> 已删除 : status=deleted
已删除 --> 恢复配置 : restoreConfig()
恢复配置 --> 活跃版本
```

**本节来源**  
- [k.yyup.com/server/src/services/config.service.ts](file://k.yyup.com/server/src/services/config.service.ts)
- [k.yyup.com/server/src/models/config.model.ts](file://k.yyup.com/server/src/models/config.model.ts)

### 配置同步机制

系统支持配置的批量更新和同步操作，确保配置变更的一致性：

```mermaid
sequenceDiagram
participant Admin as 管理员
participant API as 配置API
participant Service as 配置服务
participant Cache as 缓存系统
participant DB as 数据库
Admin->>API : 发送批量更新请求
API->>Service : 调用batchUpdateConfigs
Service->>DB : 开始事务
loop 每个配置项
Service->>DB : 插入/更新配置
DB-->>Service : 返回结果
end
Service->>DB : 提交事务
Service->>Cache : 清除相关缓存
Cache-->>Service : 确认清除
Service->>API : 返回成功响应
API->>Admin : 返回操作结果
```

**图示来源**  
- [k.yyup.com/server/src/services/config.service.ts](file://k.yyup.com/server/src/services/config.service.ts#L150-L200)
- [k.yyup.com/server/src/controllers/config.controller.ts](file://k.yyup.com/server/src/controllers/config.controller.ts#L80-L120)

## 配置缓存策略

### 缓存架构设计

系统采用多级缓存策略，结合内存缓存和分布式缓存，提高配置读取性能并保证数据一致性。

```mermaid
graph TD
A[应用请求] --> B{本地内存缓存}
B --> |命中| C[返回配置]
B --> |未命中| D{Redis缓存}
D --> |命中| E[返回配置并更新本地缓存]
D --> |未命中| F[数据库查询]
F --> G[返回配置并更新两级缓存]
G --> C
E --> C
C --> H[响应客户端]
I[配置更新] --> J[清除Redis缓存]
J --> K[清除本地缓存]
K --> L[写入数据库]
L --> M[返回成功]
```

**本节来源**  
- [k.yyup.com/server/src/services/config-cache.service.ts](file://k.yyup.com/server/src/services/config-cache.service.ts)
- [k.yyup.com/server/src/middleware/cache-invalidation.middleware.ts](file://k.yyup.com/server/src/middleware/cache-invalidation.middleware.ts)

### 缓存一致性保证

系统通过以下机制确保缓存与数据库的一致性：

1. **写时失效策略**：每次配置更新时，立即清除相关缓存
2. **TTL机制**：为缓存设置合理的过期时间，防止长期不一致
3. **分布式锁**：在缓存更新期间使用分布式锁，防止并发问题
4. **异步更新**：对于非关键配置，采用异步方式更新缓存

## 配置管理最佳实践

### 配置项设计原则

1. **命名规范**：采用小写字母和下划线命名法，如`database_connection_timeout`
2. **分类管理**：按功能模块分类配置项，如`database.*`、`security.*`、`logging.*`
3. **类型明确**：明确定义配置项的数据类型（字符串、数字、布尔值等）
4. **默认值设置**：为所有配置项提供合理的默认值
5. **文档化**：为每个配置项提供详细的说明文档

### 敏感信息加密存储

系统对敏感配置信息实施加密存储，确保数据安全：

```mermaid
flowchart TD
A[原始配置] --> B{是否敏感}
B --> |是| C[使用AES-256加密]
B --> |否| D[直接存储]
C --> E[存储到数据库]
D --> E
E --> F[读取配置]
F --> G{是否加密}
G --> |是| H[使用密钥解密]
G --> |否| I[直接返回]
H --> J[返回明文配置]
I --> J
```

**本节来源**  
- [k.yyup.com/server/src/services/encryption.service.ts](file://k.yyup.com/server/src/services/encryption.service.ts)
- [k.yyup.com/server/src/models/config.model.ts](file://k.yyup.com/server/src/models/config.model.ts#L15-L20)

### 配置变更审计

系统记录所有配置变更操作，提供完整的审计追踪功能：

| 审计字段 | 说明 |
|---------|------|
| 操作类型 | CREATE、UPDATE、DELETE |
| 配置键名 | 被操作的配置项键名 |
| 旧值 | 配置项的原始值（更新/删除时） |
| 新值 | 配置项的新值（创建/更新时） |
| 操作人 | 执行操作的用户ID |
| 操作时间 | 操作发生的时间戳 |
| IP地址 | 操作来源的IP地址 |
| 用户代理 | 操作客户端的User-Agent |

**本节来源**  
- [k.yyup.com/server/src/middleware/audit-log.middleware.ts](file://k.yyup.com/server/src/middleware/audit-log.middleware.ts)
- [k.yyup.com/server/src/models/audit-log.model.ts](file://k.yyup.com/server/src/models/audit-log.model.ts)