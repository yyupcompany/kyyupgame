# 停用与删除

<cite>
**本文档引用的文件**
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts)
- [check-tenant-databases.cjs](file://k.yyup.com/check-tenant-databases.cjs)
- [auth.test.ts](file://k.yyup.com/client/tests/unit/api/auth.test.ts)
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
</cite>

## 目录
1. [引言](#引言)
2. [租户停用机制](#租户停用机制)
3. [租户删除机制](#租户删除机制)
4. [数据安全与合规性](#数据安全与合规性)
5. [事务完整性保证](#事务完整性保证)
6. [最佳实践](#最佳实践)
7. [结论](#结论)

## 引言

本项目k.yyupgame采用多租户架构，为每个幼儿园提供独立的数据库实例。系统通过共享连接池架构实现高性能和资源利用率，同时确保数据隔离和安全性。本文档详细阐述了租户停用与删除的实现机制，包括服务暂停、访问限制、数据冻结、资源释放、数据安全处理和事务完整性保证。

**Section sources**
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

## 租户停用机制

租户停用是将租户状态从"active"变为"suspended"的过程，实现服务暂停和访问限制。

### 服务暂停与访问限制

当租户被停用时，系统通过租户识别中间件进行访问控制。中间件会检查租户状态，如果状态为"suspended"，则拒绝所有API请求。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Middleware as 租户识别中间件
participant DB as 数据库
Client->>Middleware : 发送API请求
Middleware->>DB : 查询租户状态
DB-->>Middleware : 返回suspended状态
Middleware-->>Client : 返回403错误(租户已被暂停)
```

**Diagram sources**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

### 数据冻结策略

停用期间，租户数据保持完整但被冻结，不允许任何修改操作。系统通过以下机制实现数据冻结：

1. 在数据库层面，所有写操作都会被中间件拦截
2. 租户数据库保持连接，但所有UPDATE、INSERT、DELETE操作返回错误
3. 数据保持只读状态，允许管理员进行数据导出和审计

```mermaid
flowchart TD
A[API请求] --> B{是读操作吗?}
B --> |是| C[允许执行]
B --> |否| D[返回错误: 数据已冻结]
C --> E[返回数据]
D --> F[记录审计日志]
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

**Section sources**
- [tenant-resolver-shared-pool.middleware.ts](file://tenant-resolver-shared-pool.middleware.ts)
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

## 租户删除机制

租户删除是将租户状态从"suspended"变为"deleted"并最终从系统中移除的过程。

### 数据归档策略

在删除租户前，系统会自动执行数据归档：

1. 将租户数据库完整备份到长期存储
2. 记录所有关键业务数据的归档日志
3. 保留审计日志和操作记录

```mermaid
flowchart LR
A[开始删除流程] --> B[创建数据库备份]
B --> C[上传备份到长期存储]
C --> D[记录归档日志]
D --> E[标记为可删除]
```

**Diagram sources**
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts)

### 资源释放顺序

系统按照严格的顺序释放资源，确保数据一致性：

1. 首先断开所有活动连接
2. 然后删除数据库实例
3. 最后清理配置和元数据

```mermaid
sequenceDiagram
participant Admin as 管理员
participant System as 系统
participant DB as 数据库
Admin->>System : 请求删除租户
System->>DB : 断开所有连接
DB-->>System : 确认连接已断开
System->>DB : 删除数据库
DB-->>System : 确认数据库已删除
System->>System : 清理配置元数据
System-->>Admin : 返回删除成功
```

**Diagram sources**
- [check-tenant-databases.cjs](file://k.yyup.com/check-tenant-databases.cjs)
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts)

### 删除确认机制

系统采用双重确认机制防止误删除：

1. 首次请求将租户标记为"pending_delete"
2. 管理员必须在24小时内进行二次确认
3. 二次确认后才执行实际删除操作

```mermaid
stateDiagram-v2
[*] --> Active
Active --> Suspended : 停用
Suspended --> PendingDelete : 请求删除
PendingDelete --> [*] : 24小时后自动恢复
PendingDelete --> Deleted : 二次确认
Deleted --> [*]
```

**Diagram sources**
- [auth.test.ts](file://k.yyup.com/client/tests/unit/api/auth.test.ts)

**Section sources**
- [create-tenant-database.ts](file://k.yyup.com/create-tenant-database.ts)
- [check-tenant-databases.cjs](file://k.yyup.com/check-tenant-databases.cjs)

## 数据安全与合规性

### 敏感数据清除

系统确保敏感数据的彻底清除：

1. 数据库删除后，存储空间会被安全擦除
2. 所有备份和归档数据也会被加密删除
3. 使用符合GDPR和相关法规的删除标准

### 合规性要求

系统满足以下合规性要求：

- 数据保留策略符合法律法规
- 删除操作有完整的审计追踪
- 提供数据删除证明给相关方

```mermaid
erDiagram
DELETION_AUDIT {
string id PK
string tenantCode
datetime requestTime
datetime confirmTime
string requestBy
string confirmBy
string status
string reason
}
DATA_ARCHIVE {
string id PK
string tenantCode
string backupPath
datetime archiveTime
string archiveBy
string retentionPolicy
}
DELETION_AUDIT ||--o{ DATA_ARCHIVE : "关联"
```

**Diagram sources**
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

**Section sources**
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

## 事务完整性保证

### 多系统一致性

在多系统环境下，系统通过分布式事务保证数据一致性：

1. 使用两阶段提交协议
2. 所有相关系统必须确认才能完成删除
3. 任何系统失败都会触发回滚

```mermaid
sequenceDiagram
participant Main as 主系统
participant Auth as 认证系统
participant Storage as 存储系统
participant Audit as 审计系统
Main->>Auth : 开始删除事务
Auth-->>Main : 准备就绪
Main->>Storage : 开始删除事务
Storage-->>Main : 准备就绪
Main->>Audit : 开始删除事务
Audit-->>Main : 准备就绪
Main->>Main : 所有系统准备就绪
Main->>Auth : 提交
Main->>Storage : 提交
Main->>Audit : 提交
Auth-->>Main : 提交成功
Storage-->>Main : 提交成功
Audit-->>Main : 提交成功
Main-->>Main : 事务完成
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

### 错误处理与恢复

系统具备完善的错误处理和灾难恢复机制：

1. 每个删除操作都有唯一的事务ID
2. 失败时自动记录恢复点
3. 支持从任意恢复点重新开始

```mermaid
flowchart TD
A[开始删除] --> B[记录事务ID]
B --> C[执行步骤1]
C --> D{成功?}
D --> |是| E[记录检查点1]
D --> |否| F[记录错误, 保存状态]
E --> G[执行步骤2]
G --> H{成功?}
H --> |是| I[记录检查点2]
H --> |否| J[回滚到检查点1]
I --> K[完成]
```

**Diagram sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

**Section sources**
- [tenant-database-shared-pool.service.ts](file://tenant-database-shared-pool.service.ts)

## 最佳实践

### 用户通知策略

1. 停用前7天发送预警通知
2. 停用当天发送确认通知
3. 删除前再次确认并提供恢复机会

### 审计日志记录

1. 记录所有停用和删除操作
2. 包含操作人、时间、原因等详细信息
3. 日志永久保存，不可篡改

### 灾难恢复方案

1. 保留最近30天的删除租户备份
2. 提供紧急恢复通道
3. 定期测试恢复流程

```mermaid
flowchart TD
A[发现误删除] --> B[提交紧急恢复申请]
B --> C[管理员审核]
C --> D{审核通过?}
D --> |是| E[从备份恢复]
D --> |否| F[拒绝申请]
E --> G[验证数据完整性]
G --> H[通知用户恢复完成]
```

**Diagram sources**
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

**Section sources**
- [08-tenant-management-api.md](file://docs/wiki/kindergarten-tenant-system/08-tenant-management-api.md)

## 结论

k.yyupgame的租户停用与删除机制设计完善，通过状态管理、访问控制、数据归档、资源释放和事务完整性保证，确保了系统的安全性、可靠性和合规性。系统采用共享连接池架构，在保证高性能的同时实现了严格的多租户隔离。建议开发者遵循文档中的最佳实践，确保租户管理操作的安全和可靠。