# 持久化策略

<cite>
**本文档引用的文件**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts)
- [user.ts](file://k.yyup.com/client/src/stores/user.ts)
- [app.ts](file://k.yyup.com/client/src/stores/app.ts)
- [mobile.ts](file://k.yyup.com/client/aimobile/stores/mobile.ts)
</cite>

## 目录
1. [引言](#引言)
2. [持久化状态选择原则](#持久化状态选择原则)
3. [核心状态持久化实现](#核心状态持久化实现)
4. [序列化与反序列化机制](#序列化与反序列化机制)
5. [最佳实践建议](#最佳实践建议)
6. [总结](#总结)

## 引言
本项目采用Pinia作为状态管理方案，并通过手动调用浏览器存储API（localStorage）实现关键状态的持久化。尽管未使用pinia-plugin-persistedstate插件，但通过在store的actions中显式调用localStorage.setItem和getItem方法，实现了对用户偏好、会话数据等关键状态的持久化存储。该策略确保了用户刷新页面或重新访问时，能够恢复之前的界面配置和操作状态。

**Section sources**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts#L1-L426)
- [user.ts](file://k.yyup.com/client/src/stores/user.ts#L1-L481)

## 持久化状态选择原则
在本项目中，持久化状态的选择遵循以下原则：
- **用户偏好设置**：如AI助手面板的显示状态、面板宽度、全屏状态等，这些设置直接影响用户体验，需要在用户会话间保持一致。
- **会话数据**：如用户认证令牌（token）、用户信息等，用于维持用户的登录状态。
- **界面配置**：如侧边栏的折叠状态，这类状态反映了用户的操作习惯。
- **缓存数据**：如AI助手的快捷操作缓存，避免重复请求，提升性能。

这些状态通常具有以下特征：变化频率较低、对用户体验影响较大、不包含敏感信息或已进行适当加密处理。

**Section sources**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts#L1-L426)
- [app.ts](file://k.yyup.com/client/src/stores/app.ts#L1-L33)

## 核心状态持久化实现
### mobile store中的界面配置
`useMobileStore` store管理移动端的设备信息、手势状态和PWA状态。虽然该store本身没有直接实现持久化，但其设计为持久化提供了基础。例如，`deviceInfo`和`pwaState`等状态可以通过监听器在变化时保存到localStorage，从而实现设备偏好和PWA安装状态的持久化。

**Section sources**
- [mobile.ts](file://k.yyup.com/client/aimobile/stores/mobile.ts#L1-L481)

### ai-assistant store中的对话历史
`useAIAssistantStore` store是持久化策略的核心实现之一。该store通过以下方式实现状态持久化：
- **面板显示状态**：在`togglePanel`、`showPanel`和`hidePanel`方法中，通过`localStorage.setItem('ai-panel-visible', String(panelVisible.value))`将面板的显示状态保存到localStorage。
- **面板宽度**：在`setPanelWidth`方法中，将用户调整的面板宽度保存到`ai-panel-width`键中。
- **全屏状态**：在`setFullscreen`方法中，将全屏状态保存到`ai-fullscreen`键中。
- **记忆功能开关**：在`toggleMemory`方法中，将记忆功能的启用状态保存到`ai-memory-enabled`键中。

此外，`initializeState`方法在store初始化时从localStorage恢复这些状态，确保用户下次访问时能恢复之前的配置。

**Section sources**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts#L1-L426)

### user store中的用户认证状态
`useUserStore` store负责管理用户认证状态。该store在`state`初始化时从localStorage恢复用户信息和认证令牌，并在`setUserInfo`和`clearUserInfo`方法中同步更新localStorage。具体实现包括：
- **认证令牌**：使用`kindergarten_token`键存储用户的认证令牌。
- **用户信息**：使用`kindergarten_user_info`键存储用户的基本信息和权限。
- **刷新令牌**：使用`kindergarten_refresh_token`键存储刷新令牌，用于在令牌过期时获取新的认证令牌。

这种设计确保了用户在关闭浏览器后重新打开时，仍能保持登录状态。

**Section sources**
- [user.ts](file://k.yyup.com/client/src/stores/user.ts#L1-L481)

### app store中的侧边栏状态
`useAppStore` store管理应用的全局状态，如侧边栏的折叠状态。该store通过`toggleSidebar`和`setSidebarCollapse`方法将侧边栏的折叠状态保存到`app-sidebar-collapsed`键中，并在`initAppState`方法中从localStorage恢复该状态。

**Section sources**
- [app.ts](file://k.yyup.com/client/src/stores/app.ts#L1-L33)

## 序列化与反序列化机制
本项目中的序列化和反序列化主要通过JSON.stringify和JSON.parse方法实现。例如，在`useUserStore`中，用户信息对象在存储前被序列化为JSON字符串，在读取时再反序列化为对象。对于简单的布尔值和数字，直接转换为字符串进行存储。这种机制简单有效，适用于大多数状态的持久化需求。

**Section sources**
- [user.ts](file://k.yyup.com/client/src/stores/user.ts#L1-L481)

## 最佳实践建议
1. **避免存储大量数据**：localStorage的存储空间有限（通常为5-10MB），应避免存储大量数据，如完整的对话历史或大型对象。
2. **合理设置存储有效期**：对于缓存数据，应设置合理的有效期，避免数据过期后仍被使用。例如，`ai-assistant.ts`中的`CACHE_DURATION`常量定义了快捷操作缓存的有效期为5分钟。
3. **处理存储空间不足的情况**：在存储数据前，应检查存储空间是否充足，或在存储失败时提供降级方案，如使用sessionStorage或内存缓存。
4. **敏感信息加密**：对于敏感信息，如认证令牌，应进行加密存储，避免被恶意脚本窃取。
5. **错误处理**：在读取和写入localStorage时，应使用try-catch语句捕获可能的异常，如用户禁用了localStorage。

**Section sources**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts#L1-L426)
- [user.ts](file://k.yyup.com/client/src/stores/user.ts#L1-L481)

## 总结
本项目的持久化策略通过手动调用浏览器存储API实现了对关键状态的有效管理。尽管未使用pinia-plugin-persistedstate插件，但通过在store的actions中显式处理存储逻辑，达到了相同的效果。该策略具有较高的灵活性和可控性，能够根据具体需求定制持久化逻辑。未来可考虑引入pinia-plugin-persistedstate插件以简化代码，提高可维护性。

**Section sources**
- [ai-assistant.ts](file://k.yyup.com/client/src/stores/ai-assistant.ts#L1-L426)
- [user.ts](file://k.yyup.com/client/src/stores/user.ts#L1-L481)
- [app.ts](file://k.yyup.com/client/src/stores/app.ts#L1-L33)
- [mobile.ts](file://k.yyup.com/client/aimobile/stores/mobile.ts#L1-L481)