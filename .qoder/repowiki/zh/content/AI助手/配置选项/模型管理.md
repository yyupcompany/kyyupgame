# 模型管理

<cite>
**本文档引用的文件**
- [ai-model-config.service.ts](file://k.yyup.com/server/src/services/ai/ai-model-config.service.ts)
- [add-doubao-model.js](file://k.yyup.com/add-doubao-model.js)
- [add-ai-assistant-permissions.sql](file://k.yyup.com/add-ai-assistant-permissions.sql)
- [add-optimized-models.sql](file://k.yyup.com/add-optimized-models.sql)
</cite>

## 目录
1. [简介](#简介)
2. [AI模型配置服务](#ai模型配置服务)
3. [添加和配置豆包模型](#添加和配置豆包模型)
4. [AI查询权限配置](#ai查询权限配置)
5. [模型性能与成本优化](#模型性能与成本优化)
6. [模型切换与业务需求](#模型切换与业务需求)
7. [结论](#结论)

## 简介
本文档深入介绍AI助手的模型管理功能，详细说明AI模型配置服务的实现，包括模型选择、参数设置、温度调节和最大token限制等配置项。同时，解释如何通过脚本添加和配置豆包（Doubao）等AI模型，描述AI查询权限的配置方法，确保模型访问的安全性。最后，提供配置示例，展示如何优化模型性能和成本，以及如何根据业务需求切换不同的AI模型。

## AI模型配置服务

AI模型配置服务是AI助手系统的核心组件，负责管理所有AI模型的配置和状态。该服务提供了创建、读取、更新和删除（CRUD）模型配置的功能，以及获取默认模型和验证API密钥的能力。

### 核心功能
- **获取所有模型**：`getAllModels` 方法返回所有模型配置，支持过滤激活状态。
- **获取模型详情**：`getModelById` 和 `getModelByNameAndProvider` 方法根据ID或名称和提供商获取模型详情。
- **创建模型**：`createModel` 方法创建新的模型配置，支持多种参数设置。
- **更新模型**：`updateModel` 方法更新现有模型的配置。
- **删除模型**：`deleteModel` 方法删除模型配置及其相关记录。
- **获取默认模型**：`getDefaultModel` 方法根据能力获取默认模型配置。
- **验证API密钥**：`validateModelApiKey` 方法验证模型的API密钥有效性。

### 配置项
- **模型选择**：通过 `modelName` 和 `provider` 字段选择模型。
- **参数设置**：通过 `modelParameters` 字段设置模型参数，如温度、最大token等。
- **温度调节**：通过 `temperature` 参数调节模型的随机性。
- **最大token限制**：通过 `maxTokens` 参数限制模型输出的最大token数。

**Section sources**
- [ai-model-config.service.ts](file://k.yyup.com/server/src/services/ai/ai-model-config.service.ts#L6-622)

## 添加和配置豆包模型

通过 `add-doubao-model.js` 脚本可以添加和配置豆包（Doubao）AI模型。该脚本连接到数据库，检查豆包模型是否已存在，如果存在则更新配置，否则添加新的模型配置。

### 脚本功能
- **数据库连接**：使用 Sequelize 连接到 MySQL 数据库。
- **检查现有模型**：查询现有模型列表，检查豆包模型是否已存在。
- **更新或添加模型**：如果豆包模型已存在，则更新其配置；否则，插入新的模型配置。
- **验证最终配置**：查询最终模型配置列表，验证豆包模型的配置是否正确。

### 配置详情
- **模型名称**：`doubao-seed-1.6-250615`
- **显示名称**：`豆包Seed-1.6（工具调用+多模态）`
- **提供商**：`ByteDance`
- **API端点**：`https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- **API密钥**：`99944eb3-b9bf-46f2-940e-3ee480b699a0`
- **模型参数**：
  - 温度：0.7
  - 最大token：4096
  - top_p：0.9
  - 支持工具调用：true
  - 支持多模态：true
  - 支持思考模式：true

**Section sources**
- [add-doubao-model.js](file://k.yyup.com/add-doubao-model.js#L1-182)

## AI查询权限配置

AI查询权限的配置通过 `add-ai-assistant-permissions.sql` 脚本实现。该脚本在数据库中插入权限记录，为不同角色分配相应的权限。

### 权限配置
- **AI助手主菜单权限**：`AI_ASSISTANT_USE`，允许访问AI助手主菜单。
- **AI对话权限**：`ai:chat:use`，允许进行AI对话。
- **AI查询权限**：`ai:query:execute`，允许执行AI查询。
- **AI模型配置权限**：`ai:model:config`，允许配置AI模型。
- **AI记忆管理权限**：`ai:memory:manage`，允许管理AI记忆。
- **高级功能权限**：包括AI专家咨询、AI服务使用、AI预测维护、AI数据分析、AI报告生成、AI活动策划、AI配额管理、AI反馈管理和AI分析统计。

### 角色权限分配
- **管理员**：分配所有AI助手权限。
- **园长**：分配核心权限，包括对话、查询、数据分析、报告生成和活动策划。
- **教师**：分配基础权限，包括对话和活动策划。
- **技术管理员**：分配完整权限。
- **数据分析师**：分配分析权限，包括对话、查询、数据分析和报告生成。

**Section sources**
- [add-ai-assistant-permissions.sql](file://k.yyup.com/add-ai-assistant-permissions.sql#L1-121)

## 模型性能与成本优化

通过 `add-optimized-models.sql` 脚本可以添加优化的豆包模型配置，用于AI查询系统的成本优化。

### 优化模型
- **豆包Lite 32K（经济版）**：最经济的文本模型，适用于意图分析、简单问答等任务。输入0.0003/1k tokens，输出0.0006/1k tokens。
- **豆包Pro 32K（平衡版）**：平衡性能和成本的文本模型，适用于SQL生成、复杂查询等任务。输入0.0008/1k tokens，输出0.002/1k tokens。
- **豆包Lite 32K 2024版**：2024年8月版本的经济模型，功能增强。输入0.0003/1k tokens，输出0.0006/1k tokens。
- **豆包Pro 32K 2024版**：2024年12月版本的Pro模型，精度更高。输入0.0008/1k tokens，输出0.002/1k tokens。

### 成本优化策略
- **更新原有128k模型**：将原有的128k模型设置为非默认，避免浪费。
- **设置默认模型**：将 `Doubao-lite-32k` 设置为默认模型，以降低成本。

**Section sources**
- [add-optimized-models.sql](file://k.yyup.com/add-optimized-models.sql#L1-92)

## 模型切换与业务需求

根据业务需求，可以灵活切换不同的AI模型。例如，在需要高精度的复杂任务处理时，可以选择 `doubao-seed-1.6-250615` 模型；在进行简单问答或意图分析时，可以选择 `Doubao-lite-32k` 模型以降低成本。

### 切换策略
- **性能优先**：选择支持工具调用、多模态和思考模式的高端模型。
- **成本优先**：选择经济版模型，适用于简单任务。
- **平衡选择**：选择平衡性能和成本的模型，适用于大多数场景。

### 配置示例
```sql
-- 设置豆包Seed-1.6为默认模型
UPDATE ai_model_config 
SET isDefault = 1 
WHERE modelName = 'doubao-seed-1.6-250615' 
LIMIT 1;

-- 设置豆包Lite 32K为默认模型
UPDATE ai_model_config 
SET isDefault = 1 
WHERE modelName = 'Doubao-lite-32k' 
LIMIT 1;
```

**Section sources**
- [add-optimized-models.sql](file://k.yyup.com/add-optimized-models.sql#L88-92)

## 结论
本文档详细介绍了AI助手的模型管理功能，包括AI模型配置服务的实现、添加和配置豆包模型的方法、AI查询权限的配置以及模型性能与成本优化的策略。通过这些配置，可以根据业务需求灵活切换不同的AI模型，确保系统的高效运行和成本控制。