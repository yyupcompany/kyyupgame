# 监控告警

<cite>
**本文档引用的文件**  
- [health-check.sh](file://k.yyup.com/docker/health-check.sh)
- [Dockerfile](file://k.yyup.com/Dockerfile)
- [ai-health.controller.ts](file://k.yyup.com/server/src/controllers/ai-health.controller.ts)
- [coverage-monitor.js](file://k.yyup.com/scripts/coverage-monitor.js)
- [enhanced-coverage-monitor.js](file://k.yyup.com/scripts/enhanced-coverage-monitor.js)
- [add-ai-performance-monitor-permission.sql](file://k.yyup.com/add-ai-performance-monitor-permission.sql)
- [docker-compose.yml](file://k.yyup.com/docker-compose.yml)
</cite>

## 目录
1. [引言](#引言)
2. [容器健康检查](#容器健康检查)
3. [系统监控指标收集](#系统监控指标收集)
4. [服务级别监控](#服务级别监控)
5. [告警规则配置](#告警规则配置)
6. [监控系统接入指南](#监控系统接入指南)
7. [故障排查流程](#故障排查流程)
8. [总结](#总结)

## 引言

k.yyupgame项目采用全面的可观测性方案，确保生产环境的稳定性和可靠性。本监控告警文档详细介绍了项目的监控体系，包括容器健康检查、系统资源监控、服务级别监控和告警机制。通过多层次的监控策略，我们能够及时发现并响应潜在问题，保障系统的高可用性。

**本文档引用的文件**  
- [health-check.sh](file://k.yyup.com/docker/health-check.sh)
- [Dockerfile](file://k.yyup.com/Dockerfile)
- [ai-health.controller.ts](file://k.yyup.com/server/src/controllers/ai-health.controller.ts)

## 容器健康检查

### 健康检查脚本逻辑

k.yyupgame项目通过Docker的HEALTHCHECK指令实现容器健康检查。健康检查脚本`health-check.sh`位于`docker/`目录下，其主要逻辑包括：

1. **Nginx服务检查**：使用`pgrep nginx`命令检查Nginx进程是否正在运行
2. **后端服务检查**：通过`curl`命令测试后端API端点`http://localhost:3000/api/health`的响应
3. **前端服务检查**：通过`curl`命令测试前端服务`http://localhost:80`的可访问性

当所有检查项都通过时，脚本返回成功状态码0；若任一检查失败，则返回失败状态码1，触发Docker的健康检查失败机制。

### 检查频率与失败处理

在`Dockerfile`中配置了详细的健康检查参数：

- **检查间隔**：每30秒执行一次健康检查
- **超时时间**：每次检查最多等待10秒
- **启动等待期**：容器启动后60秒开始健康检查
- **重试次数**：连续3次检查失败才判定为不健康

当容器被标记为不健康时，Docker会记录该状态，但不会自动重启容器。需要结合编排系统（如Kubernetes）或外部监控工具来实现自动恢复。

**本文档引用的文件**  
- [health-check.sh](file://k.yyup.com/docker/health-check.sh#L1-L25)
- [Dockerfile](file://k.yyup.com/Dockerfile#L72-L75)

## 系统监控指标收集

### CPU和内存使用情况

系统通过Docker容器化部署，可以利用Docker内置的资源监控功能收集CPU和内存使用情况。同时，项目中的`coverage-monitor.js`脚本也提供了资源使用监控能力，能够收集和分析测试过程中的系统资源消耗。

### 磁盘和网络监控

项目通过以下方式实现磁盘和网络监控：

1. **磁盘使用**：在`scripts`目录下的各种清理脚本（如`cleanup_cache_safe.sh`）中包含了磁盘使用情况的检查逻辑
2. **网络状况**：健康检查脚本中的`curl`命令不仅用于服务可用性检查，也能反映网络连通性状况

### 资源监控集成

`enhanced-coverage-monitor.js`脚本集成了更全面的监控功能，能够定期执行监控任务，收集系统指标，并生成详细的监控报告。该脚本配置了工作日上午9点执行的定时任务，确保在业务高峰期前完成系统健康检查。

**本文档引用的文件**  
- [coverage-monitor.js](file://k.yyup.com/scripts/coverage-monitor.js)
- [enhanced-coverage-monitor.js](file://k.yyup.com/scripts/enhanced-coverage-monitor.js)

## 服务级别监控

### API响应时间和错误率

服务级别监控主要通过`ai-health.controller.ts`文件中的健康检查接口实现。该控制器提供了两个关键的监控端点：

1. **基础健康检查**：`checkHealth`方法返回AI服务的基本状态，包括各模型服务的可用性
2. **详细服务状态**：`getServiceStatus`方法提供更详细的系统状态信息，包括：
   - 组件健康状况（数据库、缓存、AI模型等）
   - 性能指标（每分钟请求数、平均响应时间、错误率）
   - 最后更新时间戳

这些端点为外部监控系统提供了标准化的健康检查接口。

### 数据库连接监控

虽然项目中没有专门的数据库连接监控脚本，但通过以下方式间接实现了数据库连接监控：

1. **服务依赖检查**：健康检查脚本中对后端服务的检查隐含了数据库连接的验证
2. **组件状态检查**：`getServiceStatus`接口明确返回数据库组件的健康状态
3. **环境配置**：`docker-compose.yml`文件中配置了MySQL服务，确保数据库的可用性

### 其他关键指标

项目还通过`add-ai-performance-monitor-permission.sql`等权限管理脚本，为性能监控功能提供了必要的权限支持，确保监控系统能够访问所需的数据源。

**本文档引用的文件**  
- [ai-health.controller.ts](file://k.yyup.com/server/src/controllers/ai-health.controller.ts)
- [add-ai-performance-monitor-permission.sql](file://k.yyup.com/add-ai-performance-monitor-permission.sql)

## 告警规则配置

### 阈值设置

项目中的监控脚本配置了详细的阈值规则：

1. **覆盖率阈值**：`coverage-monitor.js`中设置了不同组件的覆盖率阈值
   - 全局：语句90%、分支85%、函数90%、行数90%
   - 客户端：语句85%、分支80%、函数85%、行数85%
   - 服务端：语句95%、分支90%、函数95%、行数95%

2. **告警级别**：`enhanced-coverage-monitor.js`中定义了多级告警
   - 临界：70%
   - 警告：85%
   - 目标：90%

### 通知渠道

监控系统支持多种通知渠道：

1. **控制台输出**：所有监控脚本都提供详细的控制台日志输出
2. **文件报告**：生成JSON、HTML和Markdown格式的详细报告
3. **自动化通知**：`enhanced-coverage-monitor.js`支持配置邮件、Webhook等通知方式

### 告警处理流程

当监控指标超过阈值时，系统会：

1. 生成详细的告警信息，包括类型、严重程度和具体数据
2. 将告警记录保存到`coverage-alerts.json`文件中
3. 根据配置发送通知
4. 在严重告警情况下，可自动触发测试用例生成等修复操作

**本文档引用的文件**  
- [coverage-monitor.js](file://k.yyup.com/scripts/coverage-monitor.js)
- [enhanced-coverage-monitor.js](file://k.yyup.com/scripts/enhanced-coverage-monitor.js)

## 监控系统接入指南

### 环境准备

1. 确保Docker和Docker Compose已正确安装
2. 克隆项目代码库到本地
3. 安装必要的Node.js依赖

### 配置监控

1. **健康检查配置**：确保`Dockerfile`中的HEALTHCHECK指令已正确配置
2. **监控脚本配置**：根据需要修改`coverage-config.json`中的监控参数
3. **告警通知配置**：在`enhanced-coverage-monitor.js`中配置通知渠道

### 启动监控

1. 使用`docker-compose up`启动服务
2. 监控系统将自动开始健康检查
3. 可通过`scripts/enhanced-coverage-monitor.js`手动触发监控任务

### 监控数据查看

监控数据和报告存储在以下位置：

- 覆盖率报告：`coverage-reports/`目录
- 历史记录：`coverage-history.json`
- 告警记录：`coverage-alerts.json`
- 实时状态：通过`/api/health`和`/api/service-status`接口获取

**本文档引用的文件**  
- [Dockerfile](file://k.yyup.com/Dockerfile)
- [docker-compose.yml](file://k.yyup.com/docker-compose.yml)
- [enhanced-coverage-monitor.js](file://k.yyup.com/scripts/enhanced-coverage-monitor.js)

## 故障排查流程

### 健康检查失败

当容器健康检查失败时，按以下步骤排查：

1. **检查Nginx服务**：确认Nginx进程是否正常运行
2. **检查后端服务**：验证`http://localhost:3000/api/health`是否可访问
3. **检查前端服务**：验证`http://localhost:80`是否可访问
4. **查看日志**：检查容器日志和应用日志

### 监控数据异常

当监控数据显示异常时：

1. **验证数据源**：确认监控脚本能够正确访问所有服务
2. **检查网络连接**：确保容器间网络通信正常
3. **验证权限**：确认监控系统有足够的权限访问所需资源
4. **重启监控**：必要时重启监控服务

### 告警处理

收到告警后的处理流程：

1. **确认告警**：查看告警详情，确认问题的严重程度
2. **分析原因**：根据告警信息分析根本原因
3. **采取措施**：执行相应的修复操作
4. **验证修复**：确认问题已解决，监控指标恢复正常
5. **记录总结**：记录故障处理过程，完善应急预案

**本文档引用的文件**  
- [health-check.sh](file://k.yyup.com/docker/health-check.sh)
- [ai-health.controller.ts](file://k.yyup.com/server/src/controllers/ai-health.controller.ts)

## 总结

k.yyupgame项目的监控告警系统通过容器健康检查、系统资源监控、服务级别监控和智能告警规则的有机结合，构建了全面的可观测性体系。该系统不仅能够及时发现和响应问题，还通过自动化监控和报告功能，大大降低了运维成本。通过持续优化监控策略和告警规则，我们能够确保生产环境的稳定运行，为用户提供可靠的服务。