# å¹¼å„¿å›­ç§Ÿæˆ·å®ä¾‹ç³»ç»Ÿç™»å½•å®ç°åˆ†æ

**åˆ†ææ—¥æœŸ**: 2025-11-29  
**ç³»ç»Ÿ**: k.yyup.com (å¹¼å„¿å›­ç§Ÿæˆ·å®ä¾‹ç³»ç»Ÿ)  
**ç»“è®º**: âœ… å·²æ­£ç¡®æ”¹ä¸ºç»Ÿä¸€è®¤è¯ç™»å½•

---

## ğŸ“Š æ ¸å¿ƒå‘ç°

### âœ… ç™»å½•å·²å®Œå…¨æ”¹ä¸ºç»Ÿä¸€è®¤è¯

å¹¼å„¿å›­ç§Ÿæˆ·å®ä¾‹ç³»ç»Ÿçš„ç™»å½•å·²ç»å®Œå…¨æ”¹ä¸ºè°ƒç”¨ç»Ÿä¸€è®¤è¯ç³»ç»Ÿï¼Œ**ä¸å†åœ¨ç§Ÿæˆ·ç³»ç»Ÿå†…éƒ¨è¿›è¡Œç™»å½•**ã€‚

---

## ğŸ” ä»£ç å®ç°åˆ†æ

### 1. è·¯ç”±å±‚ (auth.routes.ts)

<augment_code_snippet path="k.yyup.com/server/src/routes/auth.routes.ts" mode="EXCERPT">
````typescript
// ç¬¬41è¡Œï¼šç™»å½•è·¯ç”±ç›´æ¥è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
router.post('/login', authenticateWithUnifiedAuth);

// ç¬¬94è¡Œï¼šè·å–ç§Ÿæˆ·åˆ—è¡¨
router.post('/tenants', authController.getUserTenants);

// ç¬¬127è¡Œï¼šç»‘å®šç”¨æˆ·åˆ°ç§Ÿæˆ·
router.post('/bind-tenant', authController.bindUserToTenant);
````
</augment_code_snippet>

**å…³é”®ç‚¹**:
- âœ… `/auth/login` ç›´æ¥è°ƒç”¨ `authenticateWithUnifiedAuth` ä¸­é—´ä»¶
- âœ… ä¸å†ä½¿ç”¨æœ¬åœ°ç™»å½•é€»è¾‘
- âœ… æ³¨å†ŒåŠŸèƒ½å·²è¿ç§»åˆ°ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ

### 2. æ§åˆ¶å™¨å±‚ (auth.controller.ts)

<augment_code_snippet path="k.yyup.com/server/src/controllers/auth.controller.ts" mode="EXCERPT">
````typescript
// ç¬¬15-22è¡Œï¼šloginæ–¹æ³•
export const login = async (req: Request, res: Response, next: NextFunction): Promise<void> => {
  try {
    // è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
    await authenticateWithUnifiedAuth(req, res, next);
  } catch (error) {
    next(error);
  }
};
````
</augment_code_snippet>

**å…³é”®ç‚¹**:
- âœ… loginæ–¹æ³•åªæ˜¯ç®€å•åœ°è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
- âœ… æ²¡æœ‰æœ¬åœ°æ•°æ®åº“æŸ¥è¯¢
- âœ… æ²¡æœ‰æœ¬åœ°å¯†ç éªŒè¯

### 3. ä¸­é—´ä»¶å±‚ (auth.middleware.ts)

ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶ `authenticateWithUnifiedAuth` çš„å®ç°æµç¨‹ï¼š

```
1. æå–è¯·æ±‚ä¸­çš„ phone å’Œ password
   â†“
2. è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒAPIéªŒè¯
   POST /api/v1/auth/authenticate (rent.yyup.cc:4001)
   â†“
3. è·å–å…¨å±€ç”¨æˆ·ä¿¡æ¯å’ŒToken
   â†“
4. å¦‚æœæä¾›äº†tenantCodeï¼Œç›´æ¥ç™»å½•æŒ‡å®šç§Ÿæˆ·
   â”œâ”€ åˆ‡æ¢åˆ°ç§Ÿæˆ·æ•°æ®åº“
   â”œâ”€ æŸ¥æ‰¾æˆ–åˆ›å»ºç§Ÿæˆ·å†…ç”¨æˆ·
   â””â”€ è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
   â†“
5. å¦‚æœæ²¡æœ‰æä¾›tenantCodeï¼Œè¿”å›ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·åˆ—è¡¨
   â”œâ”€ è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè·å–ç§Ÿæˆ·åˆ—è¡¨
   â””â”€ è¿”å›ç§Ÿæˆ·åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
```

---

## ğŸ“‹ ç™»å½•æµç¨‹è¯¦è§£

### åœºæ™¯1ï¼šç›´æ¥ç™»å½•æŒ‡å®šç§Ÿæˆ·

```
å‰ç«¯è¯·æ±‚:
POST /auth/login
{
  "phone": "13800138000",
  "password": "password123",
  "tenantCode": "k001"
}

åç«¯å¤„ç†æµç¨‹:
1. ç§Ÿæˆ·ç³»ç»Ÿæ¥æ”¶è¯·æ±‚
2. è°ƒç”¨ authenticateWithUnifiedAuth ä¸­é—´ä»¶
3. ä¸­é—´ä»¶è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯
   POST http://rent.yyup.cc:4001/api/v1/auth/authenticate
   {
     "phone": "13800138000",
     "password": "password123",
     "platform": "web"
   }
4. ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè¿”å›
   {
     "success": true,
     "data": {
       "user": {
         "id": "global_user_123",
         "phone": "13800138000",
         "realName": "å¼ ä¸‰",
         "email": "zhangsan@example.com"
       },
       "token": "eyJhbGc..."
     }
   }
5. ç§Ÿæˆ·ç³»ç»Ÿåˆ‡æ¢åˆ°ç§Ÿæˆ·æ•°æ®åº“ (rent001)
6. åœ¨ç§Ÿæˆ·æ•°æ®åº“ä¸­æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
7. æ›´æ–°ç”¨æˆ·-ç§Ÿæˆ·å…³è”ä¿¡æ¯
8. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯

å‰ç«¯å“åº”:
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGc...",
    "user": {
      "id": "global_user_123",
      "phone": "13800138000",
      "realName": "å¼ ä¸‰",
      "email": "zhangsan@example.com"
    },
    "tenantCode": "k001"
  }
}
```

### åœºæ™¯2ï¼šç™»å½•åé€‰æ‹©ç§Ÿæˆ·

```
å‰ç«¯è¯·æ±‚:
POST /auth/login
{
  "phone": "13800138000",
  "password": "password123"
  // ä¸æä¾› tenantCode
}

åç«¯å¤„ç†æµç¨‹:
1. ç§Ÿæˆ·ç³»ç»Ÿæ¥æ”¶è¯·æ±‚
2. è°ƒç”¨ authenticateWithUnifiedAuth ä¸­é—´ä»¶
3. ä¸­é—´ä»¶è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯
4. ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè¿”å›å…¨å±€ç”¨æˆ·ä¿¡æ¯å’ŒToken
5. ç§Ÿæˆ·ç³»ç»Ÿè°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè·å–ç”¨æˆ·å…³è”çš„ç§Ÿæˆ·åˆ—è¡¨
   GET /api/v1/users/{globalUserId}/tenants
6. è¿”å›ç§Ÿæˆ·åˆ—è¡¨

å‰ç«¯å“åº”:
{
  "success": true,
  "message": "è®¤è¯æˆåŠŸï¼Œè¯·é€‰æ‹©è¦ç™»å½•çš„ç§Ÿæˆ·",
  "data": {
    "globalUserId": "global_user_123",
    "phone": "13800138000",
    "tenants": [
      {
        "tenantCode": "k001",
        "tenantName": "é˜³å…‰å¹¼å„¿å›­",
        "domain": "k001.yyup.cc"
      },
      {
        "tenantCode": "k002",
        "tenantName": "æ˜Ÿæ˜Ÿå¹¼å„¿å›­",
        "domain": "k002.yyup.cc"
      }
    ],
    "requiresTenantSelection": true
  }
}

å‰ç«¯é€‰æ‹©ç§Ÿæˆ·å:
POST /auth/bind-tenant
{
  "globalUserId": "global_user_123",
  "tenantCode": "k001"
}
```

---

## ğŸ” è®¤è¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç™»å½•è¯·æ±‚                              â”‚
â”‚              (phone + password + tenantCode?)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ç§Ÿæˆ·ç³»ç»Ÿ (k.yyup.cc)       â”‚
        â”‚  POST /auth/login          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  authenticateWithUnifiedAuth ä¸­é—´ä»¶    â”‚
        â”‚  1. æå– phone å’Œ password             â”‚
        â”‚  2. è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (rent.yyup.cc:4001)      â”‚
        â”‚  POST /api/v1/auth/authenticate        â”‚
        â”‚  éªŒè¯ phone + password                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚
        â†“                         â†“
   éªŒè¯æˆåŠŸ                   éªŒè¯å¤±è´¥
        â”‚                         â”‚
        â†“                         â†“
   è¿”å›Token              è¿”å›é”™è¯¯ä¿¡æ¯
   è¿”å›å…¨å±€ç”¨æˆ·ä¿¡æ¯        (401 Unauthorized)
        â”‚
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  æ£€æŸ¥æ˜¯å¦æä¾›äº† tenantCode           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚          â”‚
   â†“          â†“
 æœ‰           æ— 
   â”‚          â”‚
   â†“          â†“
åˆ‡æ¢åˆ°      è·å–ç”¨æˆ·
ç§Ÿæˆ·åº“      å…³è”çš„
   â”‚        ç§Ÿæˆ·åˆ—è¡¨
   â†“          â”‚
æŸ¥æ‰¾æˆ–        â†“
åˆ›å»ºç”¨æˆ·    è¿”å›ç§Ÿæˆ·åˆ—è¡¨
   â”‚        ä¾›ç”¨æˆ·é€‰æ‹©
   â†“
è¿”å›Token
å’Œç”¨æˆ·ä¿¡æ¯
```

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆæœ¬åœ°ç™»å½•ï¼‰âŒ

```
å‰ç«¯ â†’ ç§Ÿæˆ·ç³»ç»Ÿ â†’ æœ¬åœ°æ•°æ®åº“
                â”œâ”€ æŸ¥è¯¢usersè¡¨
                â”œâ”€ éªŒè¯å¯†ç 
                â””â”€ ç”ŸæˆToken
```

**é—®é¢˜**:
- âŒ æ¯ä¸ªç§Ÿæˆ·éƒ½è¦ç»´æŠ¤è‡ªå·±çš„ç”¨æˆ·è®¤è¯é€»è¾‘
- âŒ ç”¨æˆ·ä¿¡æ¯ä¸ç»Ÿä¸€
- âŒ æ— æ³•è·¨ç§Ÿæˆ·ç™»å½•
- âŒ å¯†ç ç®¡ç†åˆ†æ•£

### ä¿®æ”¹åï¼ˆç»Ÿä¸€è®¤è¯ï¼‰âœ…

```
å‰ç«¯ â†’ ç§Ÿæˆ·ç³»ç»Ÿ â†’ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ â†’ å…¨å±€æ•°æ®åº“
                              â”œâ”€ æŸ¥è¯¢global_usersè¡¨
                              â”œâ”€ éªŒè¯å¯†ç 
                              â””â”€ ç”ŸæˆToken
                â†“
            åˆ‡æ¢åˆ°ç§Ÿæˆ·åº“
            â”œâ”€ æŸ¥æ‰¾æˆ–åˆ›å»ºç§Ÿæˆ·å†…ç”¨æˆ·
            â””â”€ æ›´æ–°ç”¨æˆ·-ç§Ÿæˆ·å…³è”
```

**ä¼˜åŠ¿**:
- âœ… ç»Ÿä¸€çš„ç”¨æˆ·è®¤è¯
- âœ… ç”¨æˆ·ä¿¡æ¯é›†ä¸­ç®¡ç†
- âœ… æ”¯æŒè·¨ç§Ÿæˆ·ç™»å½•
- âœ… å¯†ç ç®¡ç†é›†ä¸­
- âœ… å®‰å…¨æ€§æ›´é«˜

---

## ğŸ”‘ å…³é”®ä»£ç ä½ç½®

| ç»„ä»¶ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| **è·¯ç”±** | `k.yyup.com/server/src/routes/auth.routes.ts` | ç™»å½•è·¯ç”±å®šä¹‰ |
| **æ§åˆ¶å™¨** | `k.yyup.com/server/src/controllers/auth.controller.ts` | loginæ–¹æ³•ï¼ˆç¬¬15-22è¡Œï¼‰ |
| **ä¸­é—´ä»¶** | `k.yyup.com/server/src/middlewares/auth.middleware.ts` | authenticateWithUnifiedAuthï¼ˆç¬¬862-1000è¡Œï¼‰ |
| **æœåŠ¡** | `k.yyup.com/server/src/services/admin-integration.service.ts` | ç»Ÿä¸€è®¤è¯ä¸­å¿ƒé›†æˆ |

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ³¨å†ŒåŠŸèƒ½å·²è¿ç§»

```
âŒ ä¸å†ä½¿ç”¨æœ¬åœ°æ³¨å†Œ
âœ… å·²è¿ç§»åˆ°ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ

å‰ç«¯åº”è°ƒç”¨:
POST http://rent.yyup.cc:4001/api/auth/register
```

### 2. éªŒè¯ç ç™»å½•å·²è¿ç§»

```
âŒ ä¸å†ä½¿ç”¨æœ¬åœ°éªŒè¯ç ç™»å½•
âœ… å·²è¿ç§»åˆ°ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ

å‰ç«¯åº”è°ƒç”¨:
POST http://rent.yyup.cc:4001/api/auth/send-code
POST http://rent.yyup.cc:4001/api/auth/login-with-code
```

### 3. åŸŸåæ£€æŸ¥å·²è¿ç§»

```
âŒ ä¸å†ä½¿ç”¨æœ¬åœ°åŸŸåæ£€æŸ¥
âœ… å·²è¿ç§»åˆ°ç»Ÿä¸€è®¤è¯ç³»ç»Ÿ

å‰ç«¯åº”è°ƒç”¨:
POST http://rent.yyup.cc:4001/api/auth/check-domain
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ç™»å½•è·¯ç”±è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­é—´ä»¶
- [x] ç™»å½•æ§åˆ¶å™¨ä¸åŒ…å«æœ¬åœ°è®¤è¯é€»è¾‘
- [x] ä¸­é—´ä»¶è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒAPI
- [x] æ”¯æŒç›´æ¥ç™»å½•æŒ‡å®šç§Ÿæˆ·
- [x] æ”¯æŒç™»å½•åé€‰æ‹©ç§Ÿæˆ·
- [x] æ”¯æŒç”¨æˆ·-ç§Ÿæˆ·ç»‘å®š
- [x] æ³¨å†ŒåŠŸèƒ½å·²è¿ç§»
- [x] éªŒè¯ç ç™»å½•å·²è¿ç§»
- [x] åŸŸåæ£€æŸ¥å·²è¿ç§»

---

## ğŸ¯ æ€»ç»“

**å¹¼å„¿å›­ç§Ÿæˆ·å®ä¾‹ç³»ç»Ÿçš„ç™»å½•å·²å®Œå…¨æ”¹ä¸ºç»Ÿä¸€è®¤è¯ç™»å½•**ï¼Œå®ç°äº†ï¼š

1. âœ… **ç»Ÿä¸€è®¤è¯** - æ‰€æœ‰ç”¨æˆ·é€šè¿‡ç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯
2. âœ… **è·¨ç§Ÿæˆ·æ”¯æŒ** - ç”¨æˆ·å¯ä»¥å±äºå¤šä¸ªç§Ÿæˆ·
3. âœ… **é›†ä¸­ç®¡ç†** - ç”¨æˆ·ä¿¡æ¯å’Œå¯†ç é›†ä¸­ç®¡ç†
4. âœ… **å®‰å…¨éš”ç¦»** - ç§Ÿæˆ·æ•°æ®å®Œå…¨éš”ç¦»
5. âœ… **çµæ´»ç™»å½•** - æ”¯æŒç›´æ¥ç™»å½•æˆ–é€‰æ‹©ç§Ÿæˆ·

**ä¸éœ€è¦åœ¨ç§Ÿæˆ·ç³»ç»Ÿå†…éƒ¨è¿›è¡Œç™»å½•å¤„ç†**ï¼Œæ‰€æœ‰è®¤è¯éƒ½ç”±ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå¤„ç†ã€‚


