# ç”¨æˆ·ç™»å½•å®Œæ•´é“¾è·¯åˆ†æ - k.yyup.cc

## ğŸ“‹ æ¦‚è¿°

ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥ `k.yyup.cc` åï¼Œé€šè¿‡ç™»å½•é¡µé¢è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ç™»å½•ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠå‰ç«¯ã€åç«¯ã€ç§Ÿæˆ·è¯†åˆ«ã€ç»Ÿä¸€è®¤è¯ä¸­å¿ƒç­‰å¤šä¸ªç³»ç»Ÿçš„åä½œã€‚

---

## ğŸ”„ å®Œæ•´é“¾è·¯åˆ†æ

### **ç¬¬1é˜¶æ®µï¼šå‰ç«¯åˆå§‹åŒ– (æµè§ˆå™¨)**

```
ç”¨æˆ·è®¿é—® k.yyup.cc
    â†“
æµè§ˆå™¨åŠ è½½ k.yyup.com/client å‰ç«¯åº”ç”¨
    â†“
Login/index.vue ç»„ä»¶åŠ è½½
    â†“
ç”¨æˆ·çœ‹åˆ°ç™»å½•è¡¨å•ï¼ˆæ‰‹æœºå· + å¯†ç ï¼‰
    â†“
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ï¼Œç‚¹å‡»ç™»å½•
```

**å…³é”®æ–‡ä»¶**: `k.yyup.com/client/src/pages/Login/index.vue`

---

### **ç¬¬2é˜¶æ®µï¼šå‰ç«¯å‘èµ·è¯·æ±‚**

```typescript
// ç”¨æˆ·ç‚¹å‡»ç™»å½•æŒ‰é’®è§¦å‘
const handleLogin = async () => {
  const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      phone: '13800138000',
      password: '123456'
    })
  });
  
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('kindergarten_token', data.data.token);
    router.push('/dashboard');
  }
};
```

**è¯·æ±‚ä¿¡æ¯**:
- æ–¹æ³•: `POST`
- è·¯å¾„: `/api/auth/login`
- åŸŸå: `k.yyup.cc`
- ç«¯å£: `3000` (åç«¯æœåŠ¡)

---

### **ç¬¬3é˜¶æ®µï¼šåç«¯ç§Ÿæˆ·è¯†åˆ« (tenantResolverMiddleware)**

```
HTTPè¯·æ±‚åˆ°è¾¾åç«¯ (k.yyup.cc:3000)
    â†“
tenantResolverMiddleware ä¸­é—´ä»¶æ‰§è¡Œ
    â†“
è·å–è¯·æ±‚ Host å¤´: "k.yyup.cc"
    â†“
æå–ç§Ÿæˆ·ä»£ç : extractTenantCode("k.yyup.cc")
    â†“
æ­£åˆ™åŒ¹é…: /^(k\d+)\.yyup\.cc$/
    â†“
æå–ç»“æœ: tenantCode = "k"
    â†“
éªŒè¯ç§Ÿæˆ·æ˜¯å¦å­˜åœ¨ (validateTenant("k"))
    â†“
âœ… ç§Ÿæˆ·å­˜åœ¨
    â†“
å»ºç«‹æ•°æ®åº“è¿æ¥: tenant_k
    â†“
è®¾ç½® req.tenant = {
  code: "k",
  domain: "k.yyup.cc",
  databaseName: "tenant_k"
}
    â†“
è®¾ç½® req.tenantDb = å…±äº«è¿æ¥æ± è¿æ¥
```

**å…³é”®æ–‡ä»¶**: `k.yyup.com/server/src/middlewares/tenant-resolver.middleware.ts`

**æ•°æ®åº“è¿æ¥**:
- æ•°æ®åº“: `tenant_k`
- è¿æ¥æ± : å…±äº«å…¨å±€è¿æ¥æ±  (30ä¸ªè¿æ¥)
- æ¨¡å¼: å…±äº«è¿æ¥æ± æ¶æ„

---

### **ç¬¬4é˜¶æ®µï¼šè®¤è¯ä¸­é—´ä»¶å¤„ç† (authenticateWithUnifiedAuth)**

```
è®¤è¯ä¸­é—´ä»¶æ‰§è¡Œ
    â†“
ä»è¯·æ±‚ä½“è·å–: phone, password
    â†“
è°ƒç”¨ adminIntegrationService.authenticateUser()
    â†“
å‘èµ· HTTP è¯·æ±‚åˆ°ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
```

**HTTP è¯·æ±‚è¯¦æƒ…**:
```
POST http://rent.yyup.cc:4001/api/auth/login
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "123456"
}
```

**é…ç½®æ¥æº**: `k.yyup.com/server/.env`
```env
UNIFIED_AUTH_CENTER_URL=http://rent.yyup.cc
UNIFIED_AUTH_CENTER_API_URL=http://localhost:4001
```

---

### **ç¬¬5é˜¶æ®µï¼šç»Ÿä¸€è®¤è¯ä¸­å¿ƒéªŒè¯ (rent.yyup.cc)**

```
ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ¥æ”¶è¯·æ±‚
    â†“
éªŒè¯æ‰‹æœºå·å’Œå¯†ç 
    â†“
æŸ¥è¯¢ admin_tenant_management æ•°æ®åº“
    â†“
éªŒè¯æˆåŠŸ
    â†“
è¿”å›å“åº”:
{
  "success": true,
  "data": {
    "user": {
      "id": 121,
      "phone": "13800138000",
      "realName": "ç®¡ç†å‘˜",
      "email": "admin@yyup.cc"
    },
    "token": "jwt_token_xxx"
  }
}
```

---

### **ç¬¬6é˜¶æ®µï¼šç§Ÿæˆ·æ•°æ®åº“ç”¨æˆ·åŒæ­¥**

```
åç«¯æ¥æ”¶ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå“åº”
    â†“
è·å– globalUser.id = 121
    â†“
åœ¨ç§Ÿæˆ·æ•°æ®åº“ (tenant_k) æŸ¥è¯¢ç”¨æˆ·:
SELECT * FROM users 
WHERE global_user_id = 121
    â†“
ç”¨æˆ·ä¸å­˜åœ¨?
    â†“
è‡ªåŠ¨åˆ›å»ºç§Ÿæˆ·ç”¨æˆ·:
INSERT INTO users (
  global_user_id, username, email, 
  real_name, phone, auth_source, 
  status, role, created_at, updated_at
) VALUES (121, 'ç®¡ç†å‘˜', 'admin@yyup.cc', ...)
    â†“
è·å–ç”¨æˆ·è§’è‰²å’Œæƒé™:
SELECT r.code, r.name FROM roles r
INNER JOIN user_roles ur ON ur.role_id = r.id
WHERE ur.user_id = ?
```

---

### **ç¬¬7é˜¶æ®µï¼šè¿”å›ç™»å½•å“åº”**

```typescript
// åç«¯è¿”å›å“åº”
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "jwt_token_xxx",
    "user": {
      "id": 1,
      "username": "ç®¡ç†å‘˜",
      "role": "admin",
      "email": "admin@yyup.cc",
      "realName": "ç®¡ç†å‘˜",
      "phone": "13800138000",
      "status": "active",
      "globalUserId": 121,
      "authSource": "unified",
      "tenantCode": "k",
      "tenantDatabaseName": "tenant_k"
    },
    "tenantInfo": {
      "tenantCode": "k",
      "tenantName": "ç§Ÿæˆ·k"
    }
  }
}
```

---

### **ç¬¬8é˜¶æ®µï¼šå‰ç«¯å¤„ç†å“åº”**

```typescript
// å‰ç«¯æ¥æ”¶å“åº”
if (data.success) {
  // ä¿å­˜ token
  localStorage.setItem('kindergarten_token', data.data.token);
  
  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
  localStorage.setItem('kindergarten_user_info', 
    JSON.stringify(data.data.user));
  
  // è·³è½¬åˆ°é¦–é¡µ
  router.push('/dashboard');
}
```

---

## ğŸ”‘ å…³é”®æ•°æ®æµ

| æ­¥éª¤ | æ•°æ® | æ¥æº | ç›®æ ‡ |
|------|------|------|------|
| 1 | æ‰‹æœºå· + å¯†ç  | ç”¨æˆ·è¾“å…¥ | å‰ç«¯ |
| 2 | HTTP è¯·æ±‚ | å‰ç«¯ | åç«¯ (k.yyup.cc:3000) |
| 3 | ç§Ÿæˆ·ä»£ç  | åŸŸåè§£æ | åç«¯ä¸­é—´ä»¶ |
| 4 | æ•°æ®åº“è¿æ¥ | ç§Ÿæˆ·è¯†åˆ« | åç«¯æœåŠ¡ |
| 5 | è®¤è¯è¯·æ±‚ | åç«¯ | ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (rent.yyup.cc:4001) |
| 6 | globalUser + token | ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ | åç«¯ |
| 7 | ç”¨æˆ·åŒæ­¥ | åç«¯ | ç§Ÿæˆ·æ•°æ®åº“ (tenant_k) |
| 8 | ç™»å½•å“åº” | åç«¯ | å‰ç«¯ |
| 9 | token + ç”¨æˆ·ä¿¡æ¯ | å‰ç«¯ | localStorage |

---

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

1. **åŸŸåéš”ç¦»**: ä¸åŒç§Ÿæˆ·ä¸åŒåŸŸå (k.yyup.cc)
2. **æ•°æ®åº“éš”ç¦»**: ä¸åŒç§Ÿæˆ·ä¸åŒæ•°æ®åº“ (tenant_k)
3. **è¿æ¥éš”ç¦»**: å…±äº«è¿æ¥æ± ä½†é€šè¿‡å®Œæ•´è¡¨åéš”ç¦»
4. **è®¤è¯éš”ç¦»**: ç»Ÿä¸€è®¤è¯ä¸­å¿ƒç­¾å‘å’ŒéªŒè¯ token
5. **ç”¨æˆ·éš”ç¦»**: ç”¨æˆ·ä¸ç§Ÿæˆ·ç»‘å®šå…³ç³»

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµè§ˆå™¨ (k.yyup.cc)                                  â”‚
â”‚ â”œâ”€ å‰ç«¯åº”ç”¨ (Vue 3)                                 â”‚
â”‚ â””â”€ ç™»å½•é¡µé¢                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP POST /api/auth/login
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯æœåŠ¡ (k.yyup.cc:3000)                           â”‚
â”‚ â”œâ”€ ç§Ÿæˆ·è¯†åˆ«ä¸­é—´ä»¶ (æå–ç§Ÿæˆ·ä»£ç : k)                 â”‚
â”‚ â”œâ”€ è®¤è¯ä¸­é—´ä»¶ (è°ƒç”¨ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ)                    â”‚
â”‚ â””â”€ ä¸šåŠ¡é€»è¾‘ (ç”¨æˆ·åŒæ­¥ã€æƒé™æŸ¥è¯¢)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP POST /api/auth/login
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ (rent.yyup.cc:4001)                    â”‚
â”‚ â”œâ”€ ç”¨æˆ·éªŒè¯                                         â”‚
â”‚ â”œâ”€ Token ç­¾å‘                                       â”‚
â”‚ â””â”€ è¿”å› globalUser                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ è¿”å› globalUser + token
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§Ÿæˆ·æ•°æ®åº“ (tenant_k)                               â”‚
â”‚ â”œâ”€ æŸ¥è¯¢ç”¨æˆ·                                         â”‚
â”‚ â”œâ”€ åˆ›å»ºç”¨æˆ· (å¦‚æœä¸å­˜åœ¨)                            â”‚
â”‚ â””â”€ æŸ¥è¯¢è§’è‰²å’Œæƒé™                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒè¯æ¸…å•

- [x] åŸŸåæ­£ç¡®: k.yyup.cc
- [x] ç§Ÿæˆ·ä»£ç æå–: k
- [x] æ•°æ®åº“è¿æ¥: tenant_k
- [x] ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ: rent.yyup.cc:4001
- [x] ç”¨æˆ·åŒæ­¥: è‡ªåŠ¨åˆ›å»º
- [x] Token è¿”å›: å‰ç«¯ä¿å­˜
- [x] æƒé™æŸ¥è¯¢: å®Œæ•´

